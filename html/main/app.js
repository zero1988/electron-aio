var $jscomp = $jscomp || {};
$jscomp.scope = {};
$jscomp.ASSUME_ES5 = !1;
$jscomp.ASSUME_NO_NATIVE_MAP = !1;
$jscomp.ASSUME_NO_NATIVE_SET = !1;
$jscomp.defineProperty = $jscomp.ASSUME_ES5 || typeof Object.defineProperties == 'function' ? Object.defineProperty : function (b, c, a) {
    a = a;
    if (b == Array.prototype || b == Object.prototype) {
        return
    }
    b[c] = a.value
};
$jscomp.getGlobal = function (a) {
    return typeof window != 'undefined' && window === a ? a : typeof global != 'undefined' && global != null ? global : a
};
$jscomp.global = $jscomp.getGlobal(this);
$jscomp.polyfill = function (i, f, j, k) {
    if (!f) {
        return
    }
    var a = $jscomp.global;
    var b = i.split('.');
    for (var e = 0; e < b.length - 1; e++) {
        var d = b[e];
        if (!(d in a)) {
            a[d] = {}
        }
        a = a[d]
    }
    var g = b[b.length - 1];
    var h = a[g];
    var c = f(h);
    if (c == h || c == null) {
        return
    }
    $jscomp.defineProperty(a, g, {
        configurable: !0,
        writable: !0,
        value: c
    })
};
$jscomp.polyfill('Array.prototype.copyWithin', function (a) {
    if (a) {
        return a
    }
    var b = function (d, c, b) {
        var e = this.length;
        d = Number(d);
        c = Number(c);
        b = Number(b != null ? b : e);
        if (d < c) {
            b = Math.min(b, e);
            while (c < b) {
                if (c in this) {
                    this[d++] = this[c++]
                } else {
                    delete this[d++];
                    c++
                }
            }
        } else {
            b = Math.min(b, e + c - d);
            d += b - c;
            while (b > c) {
                if (--b in this) {
                    this[--d] = this[b]
                } else {
                    delete this[d]
                }
            }
        }
        return this
    };
    return b
}, 'es6', 'es3');
$jscomp.SYMBOL_PREFIX = 'jscomp_symbol_';
$jscomp.initSymbol = function () {
    $jscomp.initSymbol = function () {};
    if (!$jscomp.global['Symbol']) {
        $jscomp.global['Symbol'] = $jscomp.Symbol
    }
};
$jscomp.Symbol = function () {
    var a = 0;

    function Symbol(b) {
        return $jscomp.SYMBOL_PREFIX + (b || '') + a++
    }
    return Symbol
}();
$jscomp.initSymbolIterator = function () {
    $jscomp.initSymbol();
    var a = $jscomp.global['Symbol'].iterator;
    if (!a) {
        a = $jscomp.global['Symbol'].iterator = $jscomp.global['Symbol']('iterator')
    }
    if (typeof Array.prototype[a] != 'function') {
        $jscomp.defineProperty(Array.prototype, a, {
            configurable: !0,
            writable: !0,
            value: function () {
                return $jscomp.arrayIterator(this)
            }
        })
    }
    $jscomp.initSymbolIterator = function () {}
};
$jscomp.arrayIterator = function (a) {
    var b = 0;
    return $jscomp.iteratorPrototype(function () {
        if (b < a.length) {
            return {
                done: !1,
                value: a[b++]
            }
        } else {
            return {
                done: !0
            }
        }
    })
};
$jscomp.iteratorPrototype = function (b) {
    $jscomp.initSymbolIterator();
    var a = {
        next: b
    };
    a[$jscomp.global['Symbol'].iterator] = function () {
        return this
    };
    return a
};
$jscomp.iteratorFromArray = function (a, d) {
    $jscomp.initSymbolIterator();
    if (a instanceof String) {
        a = a + ''
    }
    var c = 0;
    var b = {
        next: function () {
            if (c < a.length) {
                var e = c++;
                return {
                    value: d(e, a[e]),
                    done: !1
                }
            }
            b.next = function () {
                return {
                    done: !0,
                    value: void 0
                }
            };
            return b.next()
        }
    };
    $jscomp.initSymbol();
    $jscomp.initSymbolIterator();
    b[Symbol.iterator] = function () {
        return b
    };
    return b
};
$jscomp.polyfill('Array.prototype.entries', function (a) {
    if (a) {
        return a
    }
    var b = function () {
        return $jscomp.iteratorFromArray(this, function (b, c) {
            return [b, c]
        })
    };
    return b
}, 'es6', 'es3');
$jscomp.polyfill('Array.prototype.fill', function (a) {
    if (a) {
        return a
    }
    var b = function (f, c, b) {
        var d = this.length || 0;
        if (c < 0) {
            c = Math.max(0, d + c)
        }
        if (b == null || b > d) {
            b = d
        }
        b = Number(b);
        if (b < 0) {
            b = Math.max(0, d + b)
        }
        for (var e = Number(c || 0); e < b; e++) {
            this[e] = f
        }
        return this
    };
    return b
}, 'es6', 'es3');
$jscomp.findInternal = function (a, d, e) {
    if (a instanceof String) {
        a = String(a)
    }
    var f = a.length;
    for (var b = 0; b < f; b++) {
        var c = a[b];
        if (d.call(e, c, b, a)) {
            return {
                i: b,
                v: c
            }
        }
    }
    return {
        i: -1,
        v: void 0
    }
};
$jscomp.polyfill('Array.prototype.find', function (a) {
    if (a) {
        return a
    }
    var b = function (c, b) {
        return $jscomp.findInternal(this, c, b).v
    };
    return b
}, 'es6', 'es3');
$jscomp.polyfill('Array.prototype.findIndex', function (a) {
    if (a) {
        return a
    }
    var b = function (c, b) {
        return $jscomp.findInternal(this, c, b).i
    };
    return b
}, 'es6', 'es3');
$jscomp.polyfill('Array.from', function (a) {
    if (a) {
        return a
    }
    var b = function (b, c, g) {
        $jscomp.initSymbolIterator();
        c = c != null ? c : function (d) {
            return d
        };
        var e = [];
        $jscomp.initSymbol();
        $jscomp.initSymbolIterator();
        var f = b[Symbol.iterator];
        if (typeof f == 'function') {
            b = f.call(b);
            var h;
            var j = 0;
            while (!(h = b.next()).done) {
                e.push(c.call(g, h.value, j++))
            }
        } else {
            var i = b.length;
            for (var d = 0; d < i; d++) {
                e.push(c.call(g, b[d], d))
            }
        }
        return e
    };
    return b
}, 'es6', 'es3');
$jscomp.polyfill('Object.is', function (a) {
    if (a) {
        return a
    }
    var b = function (b, c) {
        if (b === c) {
            return b !== 0 || 1 / b === 1 / c
        } else {
            return b !== b && c !== c
        }
    };
    return b
}, 'es6', 'es3');
$jscomp.polyfill('Array.prototype.includes', function (a) {
    if (a) {
        return a
    }
    var b = function (d, g) {
        var c = this;
        if (c instanceof String) {
            c = String(c)
        }
        var f = c.length;
        var b = g || 0;
        if (b < 0) {
            b = Math.max(b + f, 0)
        }
        for (; b < f; b++) {
            var e = c[b];
            if (e === d || Object.is(e, d)) {
                return !0
            }
        }
        return !1
    };
    return b
}, 'es7', 'es3');
$jscomp.polyfill('Array.prototype.keys', function (a) {
    if (a) {
        return a
    }
    var b = function () {
        return $jscomp.iteratorFromArray(this, function (b) {
            return b
        })
    };
    return b
}, 'es6', 'es3');
$jscomp.polyfill('Array.of', function (a) {
    if (a) {
        return a
    }
    var b = function (b) {
        return Array.from(arguments)
    };
    return b
}, 'es6', 'es3');
$jscomp.polyfill('Array.prototype.values', function (a) {
    if (a) {
        return a
    }
    var b = function () {
        return $jscomp.iteratorFromArray(this, function (c, b) {
            return b
        })
    };
    return b
}, 'es8', 'es3');
$jscomp.makeIterator = function (a) {
    $jscomp.initSymbolIterator();
    $jscomp.initSymbol();
    $jscomp.initSymbolIterator();
    var b = a[Symbol.iterator];
    return b ? b.call(a) : $jscomp.arrayIterator(a)
};
$jscomp.FORCE_POLYFILL_PROMISE = !1;
$jscomp.polyfill('Promise', function (c) {
    if (c && !$jscomp.FORCE_POLYFILL_PROMISE) {
        return c
    }

    function AsyncExecutor() {
        this.batch_ = null
    }
    AsyncExecutor.prototype.asyncExecute = function (a) {
        if (this.batch_ == null) {
            this.batch_ = [];
            this.asyncExecuteBatch_()
        }
        this.batch_.push(a);
        return this
    };
    AsyncExecutor.prototype.asyncExecuteBatch_ = function () {
        var a = this;
        this.asyncExecuteFunction(function () {
            a.executeBatch_()
        })
    };
    var e = $jscomp.global['setTimeout'];
    AsyncExecutor.prototype.asyncExecuteFunction = function (a) {
        e(a, 0)
    };
    AsyncExecutor.prototype.executeBatch_ = function () {
        while (this.batch_ && this.batch_.length) {
            var b = this.batch_;
            this.batch_ = [];
            for (var a = 0; a < b.length; ++a) {
                var d = b[a];
                b[a] = null;
                try {
                    d()
                } catch (f) {
                    this.asyncThrow_(f)
                }
            }
        }
        this.batch_ = null
    };
    AsyncExecutor.prototype.asyncThrow_ = function (a) {
        this.asyncExecuteFunction(function () {
            throw a
        })
    };
    var b = {
        PENDING: 0,
        FULFILLED: 1,
        REJECTED: 2
    };
    var a = function (d) {
        this.state_ = b.PENDING;
        this.result_ = undefined;
        this.onSettledCallbacks_ = [];
        var a = this.createResolveAndReject_();
        try {
            d(a.resolve, a.reject)
        } catch (f) {
            a.reject(f)
        }
    };
    a.prototype.createResolveAndReject_ = function () {
        var b = this;
        var a = !1;

        function firstCallWins(d) {
            return function (e) {
                if (!a) {
                    a = !0;
                    d.call(b, e)
                }
            }
        }
        return {
            resolve: firstCallWins(this.resolveTo_),
            reject: firstCallWins(this.reject_)
        }
    };
    a.prototype.resolveTo_ = function (b) {
        if (b === this) {
            this.reject_(new TypeError('A Promise cannot resolve to itself'))
        } else {
            if (b instanceof a) {
                this.settleSameAsPromise_(b)
            } else {
                if (isObject(b)) {
                    this.resolveToNonPromiseObj_(b)
                } else {
                    this.fulfill_(b)
                }
            }
        }
    };
    a.prototype.resolveToNonPromiseObj_ = function (b) {
        var a = undefined;
        try {
            a = b.then
        } catch (f) {
            this.reject_(f);
            return
        }
        if (typeof a == 'function') {
            this.settleSameAsThenable_(a, b)
        } else {
            this.fulfill_(b)
        }
    };

    function isObject(a) {
        switch (typeof a) {
            case 'object':
                return a != null;
            case 'function':
                return !0;
            default:
                return !1;
        }
    }
    a.prototype.reject_ = function (a) {
        this.settle_(b.REJECTED, a)
    };
    a.prototype.fulfill_ = function (a) {
        this.settle_(b.FULFILLED, a)
    };
    a.prototype.settle_ = function (d, a) {
        if (this.state_ != b.PENDING) {
            throw new Error('Cannot settle(' + d + ', ' + a + '): Promise already settled in state' + this.state_)
        }
        this.state_ = d;
        this.result_ = a;
        this.executeOnSettledCallbacks_()
    };
    a.prototype.executeOnSettledCallbacks_ = function () {
        if (this.onSettledCallbacks_ != null) {
            for (var a = 0; a < this.onSettledCallbacks_.length; ++a) {
                d.asyncExecute(this.onSettledCallbacks_[a])
            }
            this.onSettledCallbacks_ = null
        }
    };
    var d = new AsyncExecutor();
    a.prototype.settleSameAsPromise_ = function (b) {
        var a = this.createResolveAndReject_();
        b.callWhenSettled_(a.resolve, a.reject)
    };
    a.prototype.settleSameAsThenable_ = function (b, d) {
        var a = this.createResolveAndReject_();
        try {
            b.call(d, a.resolve, a.reject)
        } catch (f) {
            a.reject(f)
        }
    };
    a.prototype.then = function (f, g) {
        var b;
        var d;
        var e = new a(function (a, e) {
            b = a;
            d = e
        });

        function createCallback(a, e) {
            if (typeof a == 'function') {
                return function (h) {
                    try {
                        b(a(h))
                    } catch (i) {
                        d(i)
                    }
                }
            } else {
                return e
            }
        }
        this.callWhenSettled_(createCallback(f, b), createCallback(g, d));
        return e
    };
    a.prototype['catch'] = function (a) {
        return this.then(undefined, a)
    };
    a.prototype.callWhenSettled_ = function (e, f) {
        var a = this;

        function callback() {
            switch (a.state_) {
                case b.FULFILLED:
                    e(a.result_);
                    break;
                case b.REJECTED:
                    f(a.result_);
                    break;
                default:
                    throw new Error('Unexpected state: ' + a.state_);
            }
        }
        if (this.onSettledCallbacks_ == null) {
            d.asyncExecute(callback)
        } else {
            this.onSettledCallbacks_.push(callback)
        }
    };

    function resolvingPromise(b) {
        if (b instanceof a) {
            return b
        } else {
            return new a(function (a, d) {
                a(b)
            })
        }
    }
    a['resolve'] = resolvingPromise;
    a['reject'] = function (b) {
        return new a(function (d, a) {
            a(b)
        })
    };
    a['race'] = function (b) {
        return new a(function (e, f) {
            var d = $jscomp.makeIterator(b);
            for (var a = d.next(); !a.done; a = d.next()) {
                resolvingPromise(a.value).callWhenSettled_(e, f)
            }
        })
    };
    a['all'] = function (e) {
        var d = $jscomp.makeIterator(e);
        var b = d.next();
        if (b.done) {
            return resolvingPromise([])
        } else {
            return new a(function (g, h) {
                var a = [];
                var f = 0;

                function onFulfilled(b) {
                    return function (d) {
                        a[b] = d;
                        f--;
                        if (f == 0) {
                            g(a)
                        }
                    }
                }
                do {
                    a.push(undefined);
                    f++;
                    resolvingPromise(b.value).callWhenSettled_(onFulfilled(a.length - 1), h);
                    b = d.next()
                } while (!b.done)
            })
        }
    };
    return a
}, 'es6', 'es3');
$jscomp.polyfill('Promise.prototype.finally', function (a) {
    if (a) {
        return a
    }
    var b = function (b) {
        return this.then(function (d) {
            var c = Promise.resolve(b());
            return c.then(function () {
                return d
            })
        }, function (d) {
            var c = Promise.resolve(b());
            return c.then(function () {
                throw d
            })
        })
    };
    return b
}, 'es9', 'es3');
$jscomp.underscoreProtoCanBeSet = function () {
    var b = {
        a: !0
    };
    var a = {};
    try {
        a.__proto__ = b;
        return a.a
    } catch (c) {}
    return !1
};
$jscomp.setPrototypeOf = typeof Object.setPrototypeOf == 'function' ? Object.setPrototypeOf : $jscomp.underscoreProtoCanBeSet() ? function (a, b) {
    a.__proto__ = b;
    if (a.__proto__ !== b) {
        throw new TypeError(a + ' is not extensible')
    }
    return a
} : null;
$jscomp.generator = {};
$jscomp.generator.ensureIteratorResultIsObject_ = function (a) {
    if (a instanceof Object) {
        return
    }
    throw new TypeError('Iterator result ' + a + ' is not an object')
};
$jscomp.generator.Context = function () {
    this.isRunning_ = !1;
    this.yieldAllIterator_ = null;
    this.yieldResult = undefined;
    this.nextAddress = 1;
    this.catchAddress_ = 0;
    this.finallyAddress_ = 0;
    this.abruptCompletion_ = null;
    this.finallyContexts_ = null
};
$jscomp.generator.Context.prototype.start_ = function () {
    if (this.isRunning_) {
        throw new TypeError('Generator is already running')
    }
    this.isRunning_ = !0
};
$jscomp.generator.Context.prototype.stop_ = function () {
    this.isRunning_ = !1
};
$jscomp.generator.Context.prototype.jumpToErrorHandler_ = function () {
    this.nextAddress = this.catchAddress_ || this.finallyAddress_
};
$jscomp.generator.Context.prototype.next_ = function (a) {
    this.yieldResult = a
};
$jscomp.generator.Context.prototype.throw_ = function (a) {
    this.abruptCompletion_ = {
        exception: a,
        isException: !0
    };
    this.jumpToErrorHandler_()
};
$jscomp.generator.Context.prototype['return'] = function (a) {
    this.abruptCompletion_ = {
        'return': a
    };
    this.nextAddress = this.finallyAddress_
};
$jscomp.generator.Context.prototype.jumpThroughFinallyBlocks = function (a) {
    this.abruptCompletion_ = {
        jumpTo: a
    };
    this.nextAddress = this.finallyAddress_
};
$jscomp.generator.Context.prototype.yield = function (b, a) {
    this.nextAddress = a;
    return {
        value: b
    }
};
$jscomp.generator.Context.prototype.yieldAll = function (d, b) {
    var c = $jscomp.makeIterator(d);
    var a = c.next();
    $jscomp.generator.ensureIteratorResultIsObject_(a);
    if (a.done) {
        this.yieldResult = a.value;
        this.nextAddress = b;
        return
    }
    this.yieldAllIterator_ = c;
    return this.yield(a.value, b)
};
$jscomp.generator.Context.prototype.jumpTo = function (a) {
    this.nextAddress = a
};
$jscomp.generator.Context.prototype.jumpToEnd = function () {
    this.nextAddress = 0
};
$jscomp.generator.Context.prototype.setCatchFinallyBlocks = function (b, a) {
    this.catchAddress_ = b;
    if (a != undefined) {
        this.finallyAddress_ = a
    }
};
$jscomp.generator.Context.prototype.setFinallyBlock = function (a) {
    this.catchAddress_ = 0;
    this.finallyAddress_ = a || 0
};
$jscomp.generator.Context.prototype.leaveTryBlock = function (b, a) {
    this.nextAddress = b;
    this.catchAddress_ = a || 0
};
$jscomp.generator.Context.prototype.enterCatchBlock = function (a) {
    this.catchAddress_ = a || 0;
    var b = this.abruptCompletion_.exception;
    this.abruptCompletion_ = null;
    return b
};
$jscomp.generator.Context.prototype.enterFinallyBlock = function (c, b, a) {
    if (!a) {
        this.finallyContexts_ = [this.abruptCompletion_]
    } else {
        this.finallyContexts_[a] = this.abruptCompletion_
    }
    this.catchAddress_ = c || 0;
    this.finallyAddress_ = b || 0
};
$jscomp.generator.Context.prototype.leaveFinallyBlock = function (d, c) {
    var b = this.finallyContexts_.splice(c || 0)[0];
    var a = this.abruptCompletion_ = this.abruptCompletion_ || b;
    if (a) {
        if (a.isException) {
            return this.jumpToErrorHandler_()
        }
        if (a.jumpTo != undefined && this.finallyAddress_ < a.jumpTo) {
            this.nextAddress = a.jumpTo;
            this.abruptCompletion_ = null
        } else {
            this.nextAddress = this.finallyAddress_
        }
    } else {
        this.nextAddress = d
    }
};
$jscomp.generator.Context.prototype.forIn = function (a) {
    return new $jscomp.generator.Context.PropertyIterator(a)
};
$jscomp.generator.Context.PropertyIterator = function (a) {
    this.object_ = a;
    this.properties_ = [];
    for (var b in a) {
        this.properties_.push(b)
    }
    this.properties_.reverse()
};
$jscomp.generator.Context.PropertyIterator.prototype.getNext = function () {
    while (this.properties_.length > 0) {
        var a = this.properties_.pop();
        if (a in this.object_) {
            return a
        }
    }
    return null
};
$jscomp.generator.Engine_ = function (a) {
    this.context_ = new $jscomp.generator.Context();
    this.program_ = a
};
$jscomp.generator.Engine_.prototype.next_ = function (a) {
    this.context_.start_();
    if (this.context_.yieldAllIterator_) {
        return this.yieldAllStep_(this.context_.yieldAllIterator_.next, a, this.context_.next_)
    }
    this.context_.next_(a);
    return this.nextStep_()
};
$jscomp.generator.Engine_.prototype.return_ = function (b) {
    this.context_.start_();
    var a = this.context_.yieldAllIterator_;
    if (a) {
        var c = 'return' in a ? a['return'] : function (a) {
            return {
                value: a,
                done: !0
            }
        };
        return this.yieldAllStep_(c, b, this.context_['return'])
    }
    this.context_['return'](b);
    return this.nextStep_()
};
$jscomp.generator.Engine_.prototype.throw_ = function (a) {
    this.context_.start_();
    if (this.context_.yieldAllIterator_) {
        return this.yieldAllStep_(this.context_.yieldAllIterator_['throw'], a, this.context_.next_)
    }
    this.context_.throw_(a);
    return this.nextStep_()
};
$jscomp.generator.Engine_.prototype.yieldAllStep_ = function (d, e, c) {
    try {
        var a = d.call(this.context_.yieldAllIterator_, e);
        $jscomp.generator.ensureIteratorResultIsObject_(a);
        if (!a.done) {
            this.context_.stop_();
            return a
        }
        var b = a.value
    } catch (f) {
        this.context_.yieldAllIterator_ = null;
        this.context_.throw_(f);
        return this.nextStep_()
    }
    this.context_.yieldAllIterator_ = null;
    c.call(this.context_, b);
    return this.nextStep_()
};
$jscomp.generator.Engine_.prototype.nextStep_ = function () {
    while (this.context_.nextAddress) {
        try {
            var b = this.program_(this.context_);
            if (b) {
                this.context_.stop_();
                return {
                    value: b.value,
                    done: !1
                }
            }
        } catch (c) {
            this.context_.yieldResult = undefined;
            this.context_.throw_(c)
        }
    }
    this.context_.stop_();
    if (this.context_.abruptCompletion_) {
        var a = this.context_.abruptCompletion_;
        this.context_.abruptCompletion_ = null;
        if (a.isException) {
            throw a.exception
        }
        return {
            value: a['return'],
            done: !0
        }
    }
    return {
        value: undefined,
        done: !0
    }
};
$jscomp.generator.Generator_ = function (a) {
    this.next = function (b) {
        return a.next_(b)
    };
    this['throw'] = function (b) {
        return a.throw_(b)
    };
    this['return'] = function (b) {
        return a.return_(b)
    };
    $jscomp.initSymbolIterator();
    $jscomp.initSymbol();
    $jscomp.initSymbolIterator();
    this[Symbol.iterator] = function () {
        return this
    }
};
$jscomp.generator.createGenerator = function (b, c) {
    var a = new $jscomp.generator.Generator_(new $jscomp.generator.Engine_(c));
    if ($jscomp.setPrototypeOf) {
        $jscomp.setPrototypeOf(a, b.prototype)
    }
    return a
};
$jscomp.asyncExecutePromiseGenerator = function (a) {
    function passValueToGenerator(b) {
        return a.next(b)
    }

    function passErrorToGenerator(b) {
        return a['throw'](b)
    }
    return new Promise(function (b, c) {
        function handleGeneratorRecord(d) {
            if (d.done) {
                b(d.value)
            } else {
                Promise.resolve(d.value).then(passValueToGenerator, passErrorToGenerator).then(handleGeneratorRecord, c)
            }
        }
        handleGeneratorRecord(a.next())
    })
};
$jscomp.asyncExecutePromiseGeneratorFunction = function (a) {
    return $jscomp.asyncExecutePromiseGenerator(a())
};
$jscomp.asyncExecutePromiseGeneratorProgram = function (a) {
    return $jscomp.asyncExecutePromiseGenerator(new $jscomp.generator.Generator_(new $jscomp.generator.Engine_(a)))
};
$jscomp.checkEs6ConformanceViaProxy = function () {
    try {
        var a = {};
        var b = Object.create(new $jscomp.global['Proxy'](a, {
            'get': function (d, e, c) {
                return d == a && e == 'q' && c == b
            }
        }));
        return b['q'] === !0
    } catch (c) {
        return !1
    }
};
$jscomp.USE_PROXY_FOR_ES6_CONFORMANCE_CHECKS = !1;
$jscomp.ES6_CONFORMANCE = $jscomp.USE_PROXY_FOR_ES6_CONFORMANCE_CHECKS && $jscomp.checkEs6ConformanceViaProxy();
$jscomp.owns = function (b, a) {
    return Object.prototype.hasOwnProperty.call(b, a)
};
$jscomp.polyfill('WeakMap', function (c) {
    function isConformant() {
        if (!c || !Object.seal) {
            return !1
        }
        try {
            var b = Object.seal({});
            var d = Object.seal({});
            var a = new c([
                [b, 2],
                [d, 3]
            ]);
            if (a.get(b) != 2 || a.get(d) != 3) {
                return !1
            }
            a['delete'](b);
            a.set(d, 4);
            return !a.has(b) && a.get(d) == 4
        } catch (e) {
            return !1
        }
    }
    if ($jscomp.USE_PROXY_FOR_ES6_CONFORMANCE_CHECKS) {
        if (c && $jscomp.ES6_CONFORMANCE) {
            return c
        }
    } else {
        if (isConformant()) {
            return c
        }
    }
    var a = '$jscomp_hidden_' + Math.random();

    function insert(b) {
        if (!$jscomp.owns(b, a)) {
            var d = {};
            $jscomp.defineProperty(b, a, {
                value: d
            })
        }
    }

    function patch(a) {
        var b = Object[a];
        if (b) {
            Object[a] = function (d) {
                insert(d);
                return b(d)
            }
        }
    }
    patch('freeze');
    patch('preventExtensions');
    patch('seal');
    var d = 0;
    var b = function (a) {
        this.id_ = (d += Math.random() + 1).toString();
        if (a) {
            $jscomp.initSymbol();
            $jscomp.initSymbolIterator();
            var f = $jscomp.makeIterator(a);
            var b;
            while (!(b = f.next()).done) {
                var e = b.value;
                this.set(e[0], e[1])
            }
        }
    };
    b.prototype.set = function (b, d) {
        insert(b);
        if (!$jscomp.owns(b, a)) {
            throw new Error('WeakMap key fail: ' + b)
        }
        b[a][this.id_] = d;
        return this
    };
    b.prototype.get = function (b) {
        return $jscomp.owns(b, a) ? b[a][this.id_] : undefined
    };
    b.prototype.has = function (b) {
        return $jscomp.owns(b, a) && $jscomp.owns(b[a], this.id_)
    };
    b.prototype['delete'] = function (b) {
        if (!$jscomp.owns(b, a) || !$jscomp.owns(b[a], this.id_)) {
            return !1
        }
        return delete b[a][this.id_]
    };
    return b
}, 'es6', 'es3');
$jscomp.MapEntry = function () {
    this.previous;
    this.next;
    this.head;
    this.key;
    this.value
};
$jscomp.polyfill('Map', function (b) {
    function isConformant() {
        if ($jscomp.ASSUME_NO_NATIVE_MAP || !b || typeof b != 'function' || !b.prototype.entries || typeof Object.seal != 'function') {
            return !1
        }
        try {
            b = b;
            var e = Object.seal({
                x: 4
            });
            var c = new b($jscomp.makeIterator([
                [e, 's']
            ]));
            if (c.get(e) != 's' || c.size != 1 || c.get({
                    x: 4
                }) || c.set({
                    x: 4
                }, 't') != c || c.size != 2) {
                return !1
            }
            var d = c.entries();
            var a = d.next();
            if (a.done || a.value[0] != e || a.value[1] != 's') {
                return !1
            }
            a = d.next();
            if (a.done || a.value[0].x != 4 || a.value[1] != 't' || !d.next().done) {
                return !1
            }
            return !0
        } catch (i) {
            return !1
        }
    }
    if ($jscomp.USE_PROXY_FOR_ES6_CONFORMANCE_CHECKS) {
        if (b && $jscomp.ES6_CONFORMANCE) {
            return b
        }
    } else {
        if (isConformant()) {
            return b
        }
    }
    $jscomp.initSymbol();
    $jscomp.initSymbolIterator();
    var e = new WeakMap();
    var a = function (a) {
        this.data_ = {};
        this.head_ = f();
        this.size = 0;
        if (a) {
            var e = $jscomp.makeIterator(a);
            var c;
            while (!(c = e.next()).done) {
                var d = c.value;
                this.set(d[0], d[1])
            }
        }
    };
    a.prototype.set = function (d, e) {
        d = d === 0 ? 0 : d;
        var a = c(this, d);
        if (!a.list) {
            a.list = this.data_[a.id] = []
        }
        if (!a.entry) {
            a.entry = {
                next: this.head_,
                previous: this.head_.previous,
                head: this.head_,
                key: d,
                value: e
            };
            a.list.push(a.entry);
            this.head_.previous.next = a.entry;
            this.head_.previous = a.entry;
            this.size++
        } else {
            a.entry.value = e
        }
        return this
    };
    a.prototype['delete'] = function (d) {
        var a = c(this, d);
        if (a.entry && a.list) {
            a.list.splice(a.index, 1);
            if (!a.list.length) {
                delete this.data_[a.id]
            }
            a.entry.previous.next = a.entry.next;
            a.entry.next.previous = a.entry.previous;
            a.entry.head = null;
            this.size--;
            return !0
        }
        return !1
    };
    a.prototype.clear = function () {
        this.data_ = {};
        this.head_ = this.head_.previous = f();
        this.size = 0
    };
    a.prototype.has = function (a) {
        return !!c(this, a).entry
    };
    a.prototype.get = function (d) {
        var a = c(this, d).entry;
        return a && a.value
    };
    a.prototype.entries = function () {
        return d(this, function (a) {
            return [a.key, a.value]
        })
    };
    a.prototype.keys = function () {
        return d(this, function (a) {
            return a.key
        })
    };
    a.prototype.values = function () {
        return d(this, function (a) {
            return a.value
        })
    };
    a.prototype.forEach = function (e, d) {
        var f = this.entries();
        var c;
        while (!(c = f.next()).done) {
            var a = c.value;
            e.call(d, a[1], a[0], this)
        }
    };
    $jscomp.initSymbol();
    $jscomp.initSymbolIterator();
    a.prototype[Symbol.iterator] = a.prototype.entries;
    var c = function (g, e) {
        var f = h(e);
        var a = g.data_[f];
        if (a && $jscomp.owns(g.data_, f)) {
            for (var d = 0; d < a.length; d++) {
                var c = a[d];
                if (e !== e && c.key !== c.key || e === c.key) {
                    return {
                        id: f,
                        list: a,
                        index: d,
                        entry: c
                    }
                }
            }
        }
        return {
            id: f,
            list: a,
            index: -1,
            entry: undefined
        }
    };
    var d = function (c, d) {
        var a = c.head_;
        return $jscomp.iteratorPrototype(function () {
            if (a) {
                while (a.head != c.head_) {
                    a = a.previous
                }
                while (a.next != a.head) {
                    a = a.next;
                    return {
                        done: !1,
                        value: d(a)
                    }
                }
                a = null
            }
            return {
                done: !0,
                value: void 0
            }
        })
    };
    var f = function () {
        var a = {};
        a.previous = a.next = a.head = a;
        return a
    };
    var g = 0;
    var h = function (a) {
        var c = a && typeof a;
        if (c == 'object' || c == 'function') {
            a = a;
            if (!e.has(a)) {
                var d = '' + ++g;
                e.set(a, d);
                return d
            }
            return e.get(a)
        }
        return 'p_' + a
    };
    return a
}, 'es6', 'es3');
$jscomp.polyfill('Math.acosh', function (a) {
    if (a) {
        return a
    }
    var b = function (b) {
        b = Number(b);
        return Math.log(b + Math.sqrt(b * b - 1))
    };
    return b
}, 'es6', 'es3');
$jscomp.polyfill('Math.asinh', function (a) {
    if (a) {
        return a
    }
    var b = function (b) {
        b = Number(b);
        if (b === 0) {
            return b
        }
        var c = Math.log(Math.abs(b) + Math.sqrt(b * b + 1));
        return b < 0 ? -c : c
    };
    return b
}, 'es6', 'es3');
$jscomp.polyfill('Math.log1p', function (a) {
    if (a) {
        return a
    }
    var b = function (b) {
        b = Number(b);
        if (b < 0.25 && b > -0.25) {
            var f = b;
            var g = 1;
            var c = b;
            var d = 0;
            var e = 1;
            while (d != c) {
                f *= b;
                e *= -1;
                c = (d = c) + e * f / ++g
            }
            return c
        }
        return Math.log(1 + b)
    };
    return b
}, 'es6', 'es3');
$jscomp.polyfill('Math.atanh', function (b) {
    if (b) {
        return b
    }
    var a = Math.log1p;
    var c = function (c) {
        c = Number(c);
        return (a(c) - a(-c)) / 2
    };
    return c
}, 'es6', 'es3');
$jscomp.polyfill('Math.cbrt', function (a) {
    if (a) {
        return a
    }
    var b = function (b) {
        if (b === 0) {
            return b
        }
        b = Number(b);
        var c = Math.pow(Math.abs(b), 1 / 3);
        return b < 0 ? -c : c
    };
    return b
}, 'es6', 'es3');
$jscomp.polyfill('Math.clz32', function (a) {
    if (a) {
        return a
    }
    var b = function (b) {
        b = Number(b) >>> 0;
        if (b === 0) {
            return 32
        }
        var c = 0;
        if ((b & 4.29490176E9) === 0) {
            b <<= 16;
            c += 16
        }
        if ((b & 4.27819008E9) === 0) {
            b <<= 8;
            c += 8
        }
        if ((b & 4.02653184E9) === 0) {
            b <<= 4;
            c += 4
        }
        if ((b & 3.221225472E9) === 0) {
            b <<= 2;
            c += 2
        }
        if ((b & 2.147483648E9) === 0) {
            c++
        }
        return c
    };
    return b
}, 'es6', 'es3');
$jscomp.polyfill('Math.cosh', function (a) {
    if (a) {
        return a
    }
    var b = Math.exp;
    var c = function (c) {
        c = Number(c);
        return (b(c) + b(-c)) / 2
    };
    return c
}, 'es6', 'es3');
$jscomp.polyfill('Math.expm1', function (a) {
    if (a) {
        return a
    }
    var b = function (b) {
        b = Number(b);
        if (b < 0.25 && b > -0.25) {
            var e = b;
            var f = 1;
            var c = b;
            var d = 0;
            while (d != c) {
                e *= b / ++f;
                c = (d = c) + e
            }
            return c
        }
        return Math.exp(b) - 1
    };
    return b
}, 'es6', 'es3');
$jscomp.polyfill('Math.hypot', function (a) {
    if (a) {
        return a
    }
    var b = function (d, e, h) {
        d = Number(d);
        e = Number(e);
        var b, g, f;
        var c = Math.max(Math.abs(d), Math.abs(e));
        for (b = 2; b < arguments.length; b++) {
            c = Math.max(c, Math.abs(arguments[b]))
        }
        if (c > 1.0E100 || c < 1.0E-100) {
            if (!c) {
                return c
            }
            d = d / c;
            e = e / c;
            f = d * d + e * e;
            for (b = 2; b < arguments.length; b++) {
                g = Number(arguments[b]) / c;
                f += g * g
            }
            return Math.sqrt(f) * c
        } else {
            f = d * d + e * e;
            for (b = 2; b < arguments.length; b++) {
                g = Number(arguments[b]);
                f += g * g
            }
            return Math.sqrt(f)
        }
    };
    return b
}, 'es6', 'es3');
$jscomp.polyfill('Math.imul', function (a) {
    if (a) {
        return a
    }
    var b = function (b, c) {
        b = Number(b);
        c = Number(c);
        var f = b >>> 16 & 65535;
        var d = b & 65535;
        var g = c >>> 16 & 65535;
        var e = c & 65535;
        var h = f * e + d * g << 16 >>> 0;
        return d * e + h | 0
    };
    return b
}, 'es6', 'es3');
$jscomp.polyfill('Math.log10', function (a) {
    if (a) {
        return a
    }
    var b = function (b) {
        return Math.log(b) / Math.LN10
    };
    return b
}, 'es6', 'es3');
$jscomp.polyfill('Math.log2', function (a) {
    if (a) {
        return a
    }
    var b = function (b) {
        return Math.log(b) / Math.LN2
    };
    return b
}, 'es6', 'es3');
$jscomp.polyfill('Math.sign', function (a) {
    if (a) {
        return a
    }
    var b = function (b) {
        b = Number(b);
        return b === 0 || isNaN(b) ? b : b > 0 ? 1 : -1
    };
    return b
}, 'es6', 'es3');
$jscomp.polyfill('Math.sinh', function (a) {
    if (a) {
        return a
    }
    var b = Math.exp;
    var c = function (c) {
        c = Number(c);
        if (c === 0) {
            return c
        }
        return (b(c) - b(-c)) / 2
    };
    return c
}, 'es6', 'es3');
$jscomp.polyfill('Math.tanh', function (a) {
    if (a) {
        return a
    }
    var b = function (b) {
        b = Number(b);
        if (b === 0) {
            return b
        }
        var c = Math.exp(-2 * Math.abs(b));
        var d = (1 - c) / (1 + c);
        return b < 0 ? -d : d
    };
    return b
}, 'es6', 'es3');
$jscomp.polyfill('Math.trunc', function (a) {
    if (a) {
        return a
    }
    var b = function (b) {
        b = Number(b);
        if (isNaN(b) || b === Infinity || b === -Infinity || b === 0) {
            return b
        }
        var c = Math.floor(Math.abs(b));
        return b < 0 ? -c : c
    };
    return b
}, 'es6', 'es3');
$jscomp.polyfill('Number.EPSILON', function (a) {
    return Math.pow(2, -52)
}, 'es6', 'es3');
$jscomp.polyfill('Number.MAX_SAFE_INTEGER', function () {
    return 9.007199254740991E15
}, 'es6', 'es3');
$jscomp.polyfill('Number.MIN_SAFE_INTEGER', function () {
    return -9.007199254740991E15
}, 'es6', 'es3');
$jscomp.polyfill('Number.isFinite', function (a) {
    if (a) {
        return a
    }
    var b = function (b) {
        if (typeof b !== 'number') {
            return !1
        }
        return !isNaN(b) && b !== Infinity && b !== -Infinity
    };
    return b
}, 'es6', 'es3');
$jscomp.polyfill('Number.isInteger', function (a) {
    if (a) {
        return a
    }
    var b = function (b) {
        if (!Number.isFinite(b)) {
            return !1
        }
        return b === Math.floor(b)
    };
    return b
}, 'es6', 'es3');
$jscomp.polyfill('Number.isNaN', function (a) {
    if (a) {
        return a
    }
    var b = function (b) {
        return typeof b === 'number' && isNaN(b)
    };
    return b
}, 'es6', 'es3');
$jscomp.polyfill('Number.isSafeInteger', function (a) {
    if (a) {
        return a
    }
    var b = function (b) {
        return Number.isInteger(b) && Math.abs(b) <= Number.MAX_SAFE_INTEGER
    };
    return b
}, 'es6', 'es3');
$jscomp.polyfill('Number.parseFloat', function (a) {
    return a || parseFloat
}, 'es6', 'es3');
$jscomp.polyfill('Number.parseInt', function (a) {
    return a || parseInt
}, 'es6', 'es3');
$jscomp.assign = typeof Object.assign == 'function' ? Object.assign : function (d, e) {
    for (var c = 1; c < arguments.length; c++) {
        var a = arguments[c];
        if (!a) {
            continue
        }
        for (var b in a) {
            if ($jscomp.owns(a, b)) {
                d[b] = a[b]
            }
        }
    }
    return d
};
$jscomp.polyfill('Object.assign', function (a) {
    return a || $jscomp.assign
}, 'es6', 'es3');
$jscomp.polyfill('Object.entries', function (a) {
    if (a) {
        return a
    }
    var b = function (c) {
        var d = [];
        for (var b in c) {
            if ($jscomp.owns(c, b)) {
                d.push([b, c[b]])
            }
        }
        return d
    };
    return b
}, 'es8', 'es3');
$jscomp.polyfill('Object.getOwnPropertySymbols', function (a) {
    if (a) {
        return a
    }
    return function () {
        return []
    }
}, 'es6', 'es5');
$jscomp.polyfill('Reflect.ownKeys', function (b) {
    if (b) {
        return b
    }
    var a = 'jscomp_symbol_';

    function isSymbol(c) {
        return c.substring(0, a.length) == a
    }
    var c = function (e) {
        var f = [];
        var c = Object.getOwnPropertyNames(e);
        var d = Object.getOwnPropertySymbols(e);
        for (var a = 0; a < c.length; a++) {
            (isSymbol(c[a]) ? d : f).push(c[a])
        }
        return f.concat(d)
    };
    return c
}, 'es6', 'es5');
$jscomp.polyfill('Object.getOwnPropertyDescriptors', function (a) {
    if (a) {
        return a
    }
    var b = function (e) {
        var d = {};
        var c = Reflect.ownKeys(e);
        for (var b = 0; b < c.length; b++) {
            d[c[b]] = Object.getOwnPropertyDescriptor(e, c[b])
        }
        return d
    };
    return b
}, 'es8', 'es5');
$jscomp.polyfill('Object.setPrototypeOf', function (a) {
    return a || $jscomp.setPrototypeOf
}, 'es6', 'es5');
$jscomp.polyfill('Object.values', function (a) {
    if (a) {
        return a
    }
    var b = function (b) {
        var c = [];
        for (var d in b) {
            if ($jscomp.owns(b, d)) {
                c.push(b[d])
            }
        }
        return c
    };
    return b
}, 'es8', 'es3');
$jscomp.polyfill('Reflect.apply', function (a) {
    if (a) {
        return a
    }
    var c = Function.prototype.apply;
    var b = function (e, d, b) {
        return c.call(e, d, b)
    };
    return b
}, 'es6', 'es3');
$jscomp.objectCreate = $jscomp.ASSUME_ES5 || typeof Object.create == 'function' ? Object.create : function (b) {
    var a = function () {};
    a.prototype = b;
    return new a()
};
$jscomp.construct = function () {
    function reflectConstructWorks() {
        function Base() {}

        function Derived() {}
        new Base();
        Reflect.construct(Base, [], Derived);
        return new Base() instanceof Base
    }
    if (typeof Reflect != 'undefined' && Reflect.construct) {
        if (reflectConstructWorks()) {
            return Reflect.construct
        }
        var b = Reflect.construct;
        var a = function (e, d, a) {
            var c = b(e, d);
            if (a) {
                Reflect.setPrototypeOf(c, a.prototype)
            }
            return c
        };
        return a
    }

    function construct(b, d, a) {
        if (a === undefined) {
            a = b
        }
        var f = a.prototype || Object.prototype;
        var c = $jscomp.objectCreate(f);
        var e = Function.prototype.apply;
        var g = e.call(b, c, d);
        return g || c
    }
    return construct
}();
$jscomp.polyfill('Reflect.construct', function (a) {
    return $jscomp.construct
}, 'es6', 'es3');
$jscomp.polyfill('Reflect.defineProperty', function (a) {
    if (a) {
        return a
    }
    var b = function (e, d, c) {
        try {
            Object.defineProperty(e, d, c);
            var b = Object.getOwnPropertyDescriptor(e, d);
            if (!b) {
                return !1
            }
            return b.configurable === (c.configurable || !1) && b.enumerable === (c.enumerable || !1) && ('value' in b ? b.value === c.value && b.writable === (c.writable || !1) : b.get === c.get && b.set === c.set)
        } catch (f) {
            return !1
        }
    };
    return b
}, 'es6', 'es5');
$jscomp.polyfill('Reflect.deleteProperty', function (a) {
    if (a) {
        return a
    }
    var b = function (c, b) {
        if (!$jscomp.owns(c, b)) {
            return !0
        }
        try {
            return delete c[b]
        } catch (d) {
            return !1
        }
    };
    return b
}, 'es6', 'es3');
$jscomp.polyfill('Reflect.getOwnPropertyDescriptor', function (a) {
    return a || Object.getOwnPropertyDescriptor
}, 'es6', 'es5');
$jscomp.polyfill('Reflect.getPrototypeOf', function (a) {
    return a || Object.getPrototypeOf
}, 'es6', 'es5');
$jscomp.findDescriptor = function (d, c) {
    var a = d;
    while (a) {
        var b = Reflect.getOwnPropertyDescriptor(a, c);
        if (b) {
            return b
        }
        a = Reflect.getPrototypeOf(a)
    }
    return undefined
};
$jscomp.polyfill('Reflect.get', function (a) {
    if (a) {
        return a
    }
    var b = function (d, c, e) {
        if (arguments.length <= 2) {
            return d[c]
        }
        var b = $jscomp.findDescriptor(d, c);
        if (b) {
            return b.get ? b.get.call(e) : b.value
        }
        return undefined
    };
    return b
}, 'es6', 'es5');
$jscomp.polyfill('Reflect.has', function (a) {
    if (a) {
        return a
    }
    var b = function (c, b) {
        return b in c
    };
    return b
}, 'es6', 'es3');
$jscomp.polyfill('Reflect.isExtensible', function (a) {
    if (a) {
        return a
    }
    if ($jscomp.ASSUME_ES5 || typeof Object.isExtensible == 'function') {
        return Object.isExtensible
    }
    return function () {
        return !0
    }
}, 'es6', 'es3');
$jscomp.polyfill('Reflect.preventExtensions', function (a) {
    if (a) {
        return a
    }
    if (!($jscomp.ASSUME_ES5 || typeof Object.preventExtensions == 'function')) {
        return function () {
            return !1
        }
    }
    var b = function (b) {
        Object.preventExtensions(b);
        return !Object.isExtensible(b)
    };
    return b
}, 'es6', 'es3');
$jscomp.polyfill('Reflect.set', function (a) {
    if (a) {
        return a
    }
    var b = function (b, d, e, f) {
        var c = $jscomp.findDescriptor(b, d);
        if (!c) {
            if (Reflect.isExtensible(b)) {
                b[d] = e;
                return !0
            }
            return !1
        }
        if (c.set) {
            c.set.call(arguments.length > 3 ? f : b, e);
            return !0
        } else {
            if (c.writable && !Object.isFrozen(b)) {
                b[d] = e;
                return !0
            }
        }
        return !1
    };
    return b
}, 'es6', 'es5');
$jscomp.polyfill('Reflect.setPrototypeOf', function (a) {
    if (a) {
        return a
    } else {
        if ($jscomp.setPrototypeOf) {
            var b = $jscomp.setPrototypeOf;
            var c = function (c, d) {
                try {
                    b(c, d);
                    return !0
                } catch (e) {
                    return !1
                }
            };
            return c
        } else {
            return null
        }
    }
}, 'es6', 'es5');
$jscomp.polyfill('Set', function (b) {
    function isConformant() {
        if ($jscomp.ASSUME_NO_NATIVE_SET || !b || typeof b != 'function' || !b.prototype.entries || typeof Object.seal != 'function') {
            return !1
        }
        try {
            b = b;
            var d = Object.seal({
                x: 4
            });
            var c = new b($jscomp.makeIterator([d]));
            if (!c.has(d) || c.size != 1 || c.add(d) != c || c.size != 1 || c.add({
                    x: 4
                }) != c || c.size != 2) {
                return !1
            }
            var e = c.entries();
            var a = e.next();
            if (a.done || a.value[0] != d || a.value[1] != d) {
                return !1
            }
            a = e.next();
            if (a.done || a.value[0] == d || a.value[0].x != 4 || a.value[1] != a.value[0]) {
                return !1
            }
            return e.next().done
        } catch (f) {
            return !1
        }
    }
    if ($jscomp.USE_PROXY_FOR_ES6_CONFORMANCE_CHECKS) {
        if (b && $jscomp.ES6_CONFORMANCE) {
            return b
        }
    } else {
        if (isConformant()) {
            return b
        }
    }
    $jscomp.initSymbol();
    $jscomp.initSymbolIterator();
    var a = function (a) {
        this.map_ = new Map();
        if (a) {
            var e = $jscomp.makeIterator(a);
            var c;
            while (!(c = e.next()).done) {
                var d = c.value;
                this.add(d)
            }
        }
        this.size = this.map_.size
    };
    a.prototype.add = function (a) {
        a = a === 0 ? 0 : a;
        this.map_.set(a, a);
        this.size = this.map_.size;
        return this
    };
    a.prototype['delete'] = function (c) {
        var a = this.map_['delete'](c);
        this.size = this.map_.size;
        return a
    };
    a.prototype.clear = function () {
        this.map_.clear();
        this.size = 0
    };
    a.prototype.has = function (a) {
        return this.map_.has(a)
    };
    a.prototype.entries = function () {
        return this.map_.entries()
    };
    a.prototype.values = function () {
        return this.map_.values()
    };
    a.prototype.keys = a.prototype.values;
    $jscomp.initSymbol();
    $jscomp.initSymbolIterator();
    a.prototype[Symbol.iterator] = a.prototype.values;
    a.prototype.forEach = function (c, a) {
        var d = this;
        this.map_.forEach(function (e) {
            return c.call(a, e, e, d)
        })
    };
    return a
}, 'es6', 'es3');
$jscomp.checkStringArgs = function (a, c, b) {
    if (a == null) {
        throw new TypeError("The 'this' value for String.prototype." + b + ' must not be null or undefined')
    }
    if (c instanceof RegExp) {
        throw new TypeError('First argument to String.prototype.' + b + ' must not be a regular expression')
    }
    return a + ''
};
$jscomp.polyfill('String.prototype.codePointAt', function (a) {
    if (a) {
        return a
    }
    var b = function (b) {
        var e = $jscomp.checkStringArgs(this, null, 'codePointAt');
        var f = e.length;
        b = Number(b) || 0;
        if (!(b >= 0 && b < f)) {
            return void 0
        }
        b = b | 0;
        var c = e.charCodeAt(b);
        if (c < 55296 || c > 56319 || b + 1 === f) {
            return c
        }
        var d = e.charCodeAt(b + 1);
        if (d < 56320 || d > 57343) {
            return c
        }
        return (c - 55296) * 1024 + d + 9216
    };
    return b
}, 'es6', 'es3');
$jscomp.polyfill('String.prototype.endsWith', function (a) {
    if (a) {
        return a
    }
    var b = function (b, c) {
        var d = $jscomp.checkStringArgs(this, b, 'endsWith');
        b = b + '';
        if (c === void 0) {
            c = d.length
        }
        var f = Math.max(0, Math.min(c | 0, d.length));
        var e = b.length;
        while (e > 0 && f > 0) {
            if (d[--f] != b[--e]) {
                return !1
            }
        }
        return e <= 0
    };
    return b
}, 'es6', 'es3');
$jscomp.polyfill('String.fromCodePoint', function (a) {
    if (a) {
        return a
    }
    var b = function (e) {
        var c = '';
        for (var d = 0; d < arguments.length; d++) {
            var b = Number(arguments[d]);
            if (b < 0 || b > 1114111 || b !== Math.floor(b)) {
                throw new RangeError('invalid_code_point ' + b)
            }
            if (b <= 65535) {
                c += String.fromCharCode(b)
            } else {
                b -= 65536;
                c += String.fromCharCode(b >>> 10 & 1023 | 55296);
                c += String.fromCharCode(b & 1023 | 56320)
            }
        }
        return c
    };
    return b
}, 'es6', 'es3');
$jscomp.polyfill('String.prototype.includes', function (a) {
    if (a) {
        return a
    }
    var b = function (b, c) {
        var d = $jscomp.checkStringArgs(this, b, 'includes');
        return d.indexOf(b, c || 0) !== -1
    };
    return b
}, 'es6', 'es3');
$jscomp.polyfill('String.prototype.repeat', function (a) {
    if (a) {
        return a
    }
    var b = function (b) {
        var c = $jscomp.checkStringArgs(this, null, 'repeat');
        if (b < 0 || b > 1342177279) {
            throw new RangeError('Invalid count value')
        }
        b = b | 0;
        var d = '';
        while (b) {
            if (b & 1) {
                d += c
            }
            if (b >>>= 1) {
                c += c
            }
        }
        return d
    };
    return b
}, 'es6', 'es3');
$jscomp.stringPadding = function (c, a) {
    var b = c !== undefined ? String(c) : ' ';
    if (!(a > 0) || !b) {
        return ''
    }
    var d = Math.ceil(a / b.length);
    return b.repeat(d).substring(0, a)
};
$jscomp.polyfill('String.prototype.padEnd', function (a) {
    if (a) {
        return a
    }
    var b = function (d, c) {
        var b = $jscomp.checkStringArgs(this, null, 'padStart');
        var e = d - b.length;
        return b + $jscomp.stringPadding(c, e)
    };
    return b
}, 'es8', 'es3');
$jscomp.polyfill('String.prototype.padStart', function (a) {
    if (a) {
        return a
    }
    var b = function (d, c) {
        var b = $jscomp.checkStringArgs(this, null, 'padStart');
        var e = d - b.length;
        return $jscomp.stringPadding(c, e) + b
    };
    return b
}, 'es8', 'es3');
$jscomp.polyfill('String.prototype.startsWith', function (a) {
    if (a) {
        return a
    }
    var b = function (b, g) {
        var c = $jscomp.checkStringArgs(this, b, 'startsWith');
        b = b + '';
        var h = c.length;
        var e = b.length;
        var f = Math.max(0, Math.min(g | 0, c.length));
        var d = 0;
        while (d < e && f < h) {
            if (c[f++] != b[d++]) {
                return !1
            }
        }
        return d >= e
    };
    return b
}, 'es6', 'es3');
$jscomp.arrayFromIterator = function (c) {
    var b;
    var a = [];
    while (!(b = c.next()).done) {
        a.push(b.value)
    }
    return a
};
$jscomp.arrayFromIterable = function (a) {
    if (a instanceof Array) {
        return a
    } else {
        return $jscomp.arrayFromIterator($jscomp.makeIterator(a))
    }
};
$jscomp.inherits = function (a, b) {
    a.prototype = $jscomp.objectCreate(b.prototype);
    a.prototype.constructor = a;
    if ($jscomp.setPrototypeOf) {
        var e = $jscomp.setPrototypeOf;
        e(a, b)
    } else {
        for (var c in b) {
            if (c == 'prototype') {
                continue
            }
            if (Object.defineProperties) {
                var d = Object.getOwnPropertyDescriptor(b, c);
                if (d) {
                    Object.defineProperty(a, c, d)
                }
            } else {
                a[c] = b[c]
            }
        }
    }
    a.superClass_ = b.prototype
};
$jscomp.polyfill('WeakSet', function (a) {
    function isConformant() {
        if (!a || !Object.seal) {
            return !1
        }
        try {
            var c = Object.seal({});
            var d = Object.seal({});
            var b = new a([c]);
            if (!b.has(c) || b.has(d)) {
                return !1
            }
            b['delete'](c);
            b.add(d);
            return !b.has(c) && b.has(d)
        } catch (e) {
            return !1
        }
    }
    if ($jscomp.USE_PROXY_FOR_ES6_CONFORMANCE_CHECKS) {
        if (a && $jscomp.ES6_CONFORMANCE) {
            return a
        }
    } else {
        if (isConformant()) {
            return a
        }
    }
    var b = function (b) {
        this.map_ = new WeakMap();
        if (b) {
            $jscomp.initSymbol();
            $jscomp.initSymbolIterator();
            var e = $jscomp.makeIterator(b);
            var c;
            while (!(c = e.next()).done) {
                var d = c.value;
                this.add(d)
            }
        }
    };
    b.prototype.add = function (b) {
        this.map_.set(b, !0);
        return this
    };
    b.prototype.has = function (b) {
        return this.map_.has(b)
    };
    b.prototype['delete'] = function (b) {
        return this.map_['delete'](b)
    };
    return b
}, 'es6', 'es3');
try {
    if (Array.prototype.values.toString().indexOf('[native code]') == -1) {
        delete Array.prototype.values
    }
} catch (a) {}
var AddDataUtil = AddDataUtil || {};
var AtUtil = AtUtil || {};
var AvatarMgr = AvatarMgr || {};
var AvatarUtil = AvatarUtil || {};
var ChatType = ChatType || {};
var ChatUtil = ChatUtil || {};
var ChatformSearch = ChatformSearch || {};
var Common = Common || {};
if (!Common.field) {
    Common.field = {}
}
if (!Common.field.comment) {
    Common.field.comment = {}
}
var ConfigMgr = ConfigMgr || {};
var DesktopChatUtil = DesktopChatUtil || {};
var DirMgr = DirMgr || {};
var DownFileMgr = DownFileMgr || {};
var DtPageCache = DtPageCache || {};
var Ext = Ext || {};
if (!Ext.locale) {
    Ext.locale = {}
}
if (!Ext.locale.zh_CN) {
    Ext.locale.zh_CN = {}
}
if (!Ext.locale.zh_CN.data) {
    Ext.locale.zh_CN.data = {}
}
if (!Ext.locale.zh_CN.data.validator) {
    Ext.locale.zh_CN.data.validator = {}
}
if (!Ext.locale.zh_CN.dataview) {
    Ext.locale.zh_CN.dataview = {}
}
if (!Ext.locale.zh_CN.field) {
    Ext.locale.zh_CN.field = {}
}
if (!Ext.locale.zh_CN.grid) {
    Ext.locale.zh_CN.grid = {}
}
if (!Ext.locale.zh_CN.grid.menu) {
    Ext.locale.zh_CN.grid.menu = {}
}
if (!Ext.locale.zh_CN.panel) {
    Ext.locale.zh_CN.panel = {}
}
if (!Ext.locale.zh_CN.picker) {
    Ext.locale.zh_CN.picker = {}
}
if (!Ext['package']) {
    Ext['package'] = {}
}
if (!Ext.theme) {
    Ext.theme = {}
}
if (!Ext.theme.neptune) {
    Ext.theme.neptune = {}
}
if (!Ext.theme.neptune.panel) {
    Ext.theme.neptune.panel = {}
}
var FSUtil = FSUtil || {};
var FileMgr = FileMgr || {};
var FileUtil = FileUtil || {};
var GroupNotice = GroupNotice || {};
var IMCommon = IMCommon || {};
if (!IMCommon.enumType) {
    IMCommon.enumType = {}
}
if (!IMCommon.local) {
    IMCommon.local = {}
}
if (!IMCommon.model) {
    IMCommon.model = {}
}
if (!IMCommon.model.desktop) {
    IMCommon.model.desktop = {}
}
if (!IMCommon.plugin) {
    IMCommon.plugin = {}
}
if (!IMCommon.utils) {
    IMCommon.utils = {}
}
if (!IMCommon.view) {
    IMCommon.view = {}
}
if (!IMCommon.view.desktop) {
    IMCommon.view.desktop = {}
}
if (!IMCommon.view.desktop.group) {
    IMCommon.view.desktop.group = {}
}
if (!IMCommon.view.desktop.input) {
    IMCommon.view.desktop.input = {}
}
if (!IMCommon.view.desktop.list) {
    IMCommon.view.desktop.list = {}
}
if (!IMCommon.view.desktop.msgMrd) {
    IMCommon.view.desktop.msgMrd = {}
}
if (!IMCommon.view.desktop.msgMrd.tab) {
    IMCommon.view.desktop.msgMrd.tab = {}
}
if (!IMCommon.view.desktop.reply) {
    IMCommon.view.desktop.reply = {}
}
if (!IMCommon.view.list) {
    IMCommon.view.list = {}
}
if (!IMCommon.view.menu) {
    IMCommon.view.menu = {}
}
if (!IMCommon.view.panel) {
    IMCommon.view.panel = {}
}
if (!IMCommon.view.search) {
    IMCommon.view.search = {}
}
var IMHelper = IMHelper || {};
var ImgMgr = ImgMgr || {};
var ImgUtil = ImgUtil || {};
var InitDb = InitDb || {};
var LaunchPicture = LaunchPicture || {};
var LocalDataMgr = LocalDataMgr || {};
var LocalSearchMgr = LocalSearchMgr || {};
var LogUtil = LogUtil || {};
var MX = MX || {};
if (!MX.fab) {
    MX.fab = {}
}
if (!MX.field) {
    MX.field = {}
}
if (!MX.mixin) {
    MX.mixin = {}
}
if (!MX.model) {
    MX.model = {}
}
if (!MX.plugin) {
    MX.plugin = {}
}
if (!MX.util) {
    MX.util = {}
}
if (!MX.utils) {
    MX.utils = {}
}
var MimeType = MimeType || {};
var MsgMgrSearch = MsgMgrSearch || {};
var MsgType = MsgType || {};
var MsgWrapperType = MsgWrapperType || {};
var NoticeType = NoticeType || {};
var ParseUtil = ParseUtil || {};
var PushIM = PushIM || {};
if (!PushIM.Webapp) {
    PushIM.Webapp = {}
}
if (!PushIM.Webapp.util) {
    PushIM.Webapp.util = {}
}
if (!PushIM.Webapp.view) {
    PushIM.Webapp.view = {}
}
if (!PushIM.Webapp.view.login) {
    PushIM.Webapp.view.login = {}
}
if (!PushIM.Webapp.view.luanchcarousel) {
    PushIM.Webapp.view.luanchcarousel = {}
}
if (!PushIM.Webapp.view.setting) {
    PushIM.Webapp.view.setting = {}
}
if (!PushIM.Webapp.view.viewport) {
    PushIM.Webapp.view.viewport = {}
}
var PushNotification = PushNotification || {};
var RM = RM || {};
var RouteList = RouteList || {};
var SearchType = SearchType || {};
var SendUtil = SendUtil || {};
var SocketEventType = SocketEventType || {};
var SocketEventUtil = SocketEventUtil || {};
var StaticChatID = StaticChatID || {};
var UX = UX || {};
if (!UX.event) {
    UX.event = {}
}
var UpFileMgr = UpFileMgr || {};
var UpImgMgr = UpImgMgr || {};
var User = User || {};
var Utils = Utils || {};
var VerControll = VerControll || {};
var WebSocketUtil = WebSocketUtil || {};
var Ext = Ext || {};
Ext.Boot = Ext.Boot || function (f) {
    var c = document,
        e = [],
        k = {
            disableCaching: /[?&](?:cache|disableCacheBuster)\b/i.test(location.search) || !/http[s]?:/i.test(location.href) || /(^|[ ;])ext-cache=1/.test(c.cookie) ? !1 : !0,
            disableCachingParam: '_dc',
            loadDelay: !1,
            preserveScripts: !0,
            charset: 'UTF-8'
        },
        m = {},
        n = /\.css(?:\?|$)/i,
        i = c.createElement('a'),
        j = typeof window !== 'undefined',
        d = {
            browser: j,
            node: !j && typeof require === 'function',
            phantom: window && (window._phantom || window.callPhantom) || /PhantomJS/.test(window.navigator.userAgent)
        },
        b = Ext.platformTags = {},
        g = function (b, a, c) {
            if (c) {
                g(b, c)
            }
            if (b && a && typeof a === 'object') {
                for (var d in a) {
                    b[d] = a[d]
                }
            }
            return b
        },
        l = function () {
            var d = !1,
                g = Array.prototype.shift.call(arguments),
                a, c, e, b;
            if (typeof arguments[arguments.length - 1] === 'boolean') {
                d = Array.prototype.pop.call(arguments)
            }
            e = arguments.length;
            for (a = 0; a < e; a++) {
                b = arguments[a];
                if (typeof b === 'object') {
                    for (c in b) {
                        g[d ? c.toLowerCase() : c] = b[c]
                    }
                }
            }
            return g
        },
        h = typeof Object.keys == 'function' ? function (a) {
            if (!a) {
                return []
            }
            return Object.keys(a)
        } : function (b) {
            var c = [],
                a;
            for (a in b) {
                if (b.hasOwnProperty(a)) {
                    c.push(a)
                }
            }
            return c
        },
        a = {
            loading: 0,
            loaded: 0,
            apply: g,
            env: d,
            config: k,
            assetConfig: m,
            scripts: {},
            currentFile: null,
            suspendedQueue: [],
            currentRequest: null,
            syncMode: !1,
            useElements: !0,
            listeners: [],
            Request: Request,
            Entry: Entry,
            allowMultipleBrowsers: !1,
            browserNames: {
                ie: 'IE',
                firefox: 'Firefox',
                safari: 'Safari',
                chrome: 'Chrome',
                opera: 'Opera',
                dolfin: 'Dolfin',
                edge: 'Edge',
                webosbrowser: 'webOSBrowser',
                chromeMobile: 'ChromeMobile',
                chromeiOS: 'ChromeiOS',
                silk: 'Silk',
                other: 'Other'
            },
            osNames: {
                ios: 'iOS',
                android: 'Android',
                windowsPhone: 'WindowsPhone',
                webos: 'webOS',
                blackberry: 'BlackBerry',
                rimTablet: 'RIMTablet',
                mac: 'MacOS',
                win: 'Windows',
                tizen: 'Tizen',
                linux: 'Linux',
                bada: 'Bada',
                chromeOS: 'ChromeOS',
                other: 'Other'
            },
            browserPrefixes: {
                ie: 'MSIE ',
                edge: 'Edge/',
                firefox: 'Firefox/',
                chrome: 'Chrome/',
                safari: 'Version/',
                opera: 'OPR/',
                dolfin: 'Dolfin/',
                webosbrowser: 'wOSBrowser/',
                chromeMobile: 'CrMo/',
                chromeiOS: 'CriOS/',
                silk: 'Silk/'
            },
            browserPriority: ['edge', 'opera', 'dolfin', 'webosbrowser', 'silk', 'chromeiOS', 'chromeMobile', 'ie', 'firefox', 'safari', 'chrome'],
            osPrefixes: {
                tizen: '(Tizen )',
                ios: 'i(?:Pad|Phone|Pod)(?:.*)CPU(?: iPhone)? OS ',
                android: '(Android |HTC_|Silk/)',
                windowsPhone: 'Windows Phone ',
                blackberry: '(?:BlackBerry|BB)(?:.*)Version/',
                rimTablet: 'RIM Tablet OS ',
                webos: '(?:webOS|hpwOS)/',
                bada: 'Bada/',
                chromeOS: 'CrOS '
            },
            fallbackOSPrefixes: {
                windows: 'win',
                mac: 'mac',
                linux: 'linux'
            },
            devicePrefixes: {
                iPhone: 'iPhone',
                iPod: 'iPod',
                iPad: 'iPad'
            },
            maxIEVersion: 12,
            detectPlatformTags: function () {
                var c = this,
                    e = navigator.userAgent,
                    i = /Mobile(\/|\s)/.test(e),
                    d = document.createElement('div'),
                    k = function (e, c) {
                        if (c === undefined) {
                            c = window
                        }
                        var a = 'on' + e.toLowerCase(),
                            b = a in d;
                        if (!b) {
                            if (d.setAttribute && d.removeAttribute) {
                                d.setAttribute(a, '');
                                b = typeof d[a] === 'function';
                                if (typeof d[a] !== 'undefined') {
                                    d[a] = undefined
                                }
                                d.removeAttribute(a)
                            }
                        }
                        return b
                    },
                    m = function () {
                        var d = {},
                            j, g, l, i, b, n, h, a, k;
                        n = c.browserPriority.length;
                        for (b = 0; b < n; b++) {
                            i = c.browserPriority[b];
                            if (!k) {
                                l = c.browserPrefixes[i];
                                h = e.match(new RegExp('(' + l + ')([\\w\\._]+)'));
                                a = h && h.length > 1 ? parseInt(h[2]) : 0;
                                if (a) {
                                    k = !0
                                }
                            } else {
                                a = 0
                            }
                            d[i] = a
                        }
                        if (d.ie) {
                            var m = document.documentMode;
                            if (m >= 8) {
                                d.ie = m
                            }
                        }
                        a = d.ie || !1;
                        j = Math.max(a, c.maxIEVersion);
                        for (b = 8; b <= j; ++b) {
                            g = 'ie' + b;
                            d[g + 'm'] = a ? a <= b : 0;
                            d[g] = a ? a === b : 0;
                            d[g + 'p'] = a ? a >= b : 0
                        }
                        return d
                    },
                    j = function () {
                        var j = {},
                            l, d, g, b, m, a, i, k, n;
                        g = h(c.osPrefixes);
                        m = g.length;
                        for (b = 0, n = 0; b < m; b++) {
                            d = g[b];
                            l = c.osPrefixes[d];
                            a = e.match(new RegExp('(' + l + ')([^\\s;]+)'));
                            i = a ? a[1] : null;
                            if (i && (i === 'HTC_' || i === 'Silk/')) {
                                k = 2.3
                            } else {
                                k = a && a.length > 1 ? parseFloat(a[a.length - 1]) : 0
                            }
                            if (k) {
                                n++
                            }
                            j[d] = k
                        }
                        g = h(c.fallbackOSPrefixes);
                        m = g.length;
                        for (b = 0; b < m; b++) {
                            d = g[b];
                            if (n === 0) {
                                l = c.fallbackOSPrefixes[d];
                                a = e.toLowerCase().match(new RegExp(l));
                                j[d] = a ? !0 : 0
                            } else {
                                j[d] = 0
                            }
                        }
                        return j
                    },
                    n = function () {
                        var g = {},
                            j, d, b, a, k, i;
                        b = h(c.devicePrefixes);
                        k = b.length;
                        for (a = 0; a < k; a++) {
                            d = b[a];
                            j = c.devicePrefixes[d];
                            i = e.match(new RegExp(j));
                            g[d] = i ? !0 : 0
                        }
                        return g
                    },
                    o = m(),
                    q = j(),
                    p = n(),
                    g = a.loadPlatformsParam();
                l(b, o, q, p, g, !0);
                b.phone = !!(b.iphone || b.ipod || !b.silk && (b.android && (b.android < 3 || i)) || b.blackberry && i || b.windowsphone);
                b.tablet = !!(!b.phone && (b.ipad || b.android || b.silk || b.rimtablet || b.ie10 && /; Touch/.test(e)));
                b.touch = k('touchend') || navigator.maxTouchPoints || navigator.msMaxTouchPoints;
                b.desktop = !b.phone && !b.tablet;
                b.cordova = b.phonegap = !!(window.PhoneGap || window.Cordova || window.cordova);
                b.webview = /(iPhone|iPod|iPad).*AppleWebKit(?!.*Safari)(?!.*FBAN)/i.test(e);
                b.androidstock = b.android <= 4.3 && (b.safari || b.silk);
                l(b, g, !0)
            },
            loadPlatformsParam: function () {
                var k = window.location.search.substr(1),
                    g = k.split('&'),
                    e = {},
                    a, h = {},
                    b, i, d, j, c;
                for (a = 0; a < g.length; a++) {
                    b = g[a].split('=');
                    e[b[0]] = b[1]
                }
                if (e.platformTags) {
                    b = e.platformTags.split(',');
                    for (i = b.length, a = 0; a < i; a++) {
                        d = b[a].split(':');
                        j = d[0];
                        c = !0;
                        if (d.length > 1) {
                            c = d[1];
                            if (c === 'false' || c === '0') {
                                c = !1
                            }
                        }
                        h[j] = c
                    }
                }
                return h
            },
            filterPlatform: function (g, d) {
                g = e.concat(g || e);
                d = e.concat(d || e);
                var j = g.length,
                    i = d.length,
                    c = !j && i,
                    a, h;
                for (a = 0; a < j && !c; a++) {
                    h = g[a];
                    c = !!b[h]
                }
                for (a = 0; a < i && c; a++) {
                    h = d[a];
                    c = !b[h]
                }
                return c
            },
            init: function () {
                var g = c.getElementsByTagName('script'),
                    b = g[0],
                    m = g.length,
                    n = /\/ext(\-[a-z\-]+)?\.js$/,
                    l, e, h, d, k, i, j;
                a.hasReadyState = 'readyState' in b;
                a.hasAsync = 'async' in b;
                a.hasDefer = 'defer' in b;
                a.hasOnLoad = 'onload' in b;
                a.isIE8 = a.hasReadyState && !a.hasAsync && a.hasDefer && !a.hasOnLoad;
                a.isIE9 = a.hasReadyState && !a.hasAsync && a.hasDefer && a.hasOnLoad;
                a.isIE10p = a.hasReadyState && a.hasAsync && a.hasDefer && a.hasOnLoad;
                if (a.isIE8) {
                    a.isIE10 = !1;
                    a.isIE10m = !0
                } else {
                    a.isIE10 = (new Function('/*@cc_on return @_jscript_version @*/'))() === 10;
                    a.isIE10m = a.isIE10 || a.isIE9 || a.isIE8
                }
                a.isIE11 = a.isIE10p && !a.isIE10;
                for (i = 0; i < m; i++) {
                    e = (b = g[i]).src;
                    if (!e) {
                        continue
                    }
                    h = b.readyState || null;
                    if (!d && n.test(e)) {
                        d = e
                    }
                    if (!a.scripts[k = a.canonicalUrl(e)]) {
                        l = new Entry({
                            key: k,
                            url: e,
                            done: h === null || h === 'loaded' || h === 'complete',
                            el: b,
                            prop: 'src'
                        })
                    }
                }
                if (!d) {
                    b = g[g.length - 1];
                    d = b.src
                }
                a.baseUrl = d.substring(0, d.lastIndexOf('/') + 1);
                j = window.location.origin || window.location.protocol + '//' + window.location.hostname + (window.location.port ? ':' + window.location.port : '');
                a.origin = j;
                a.detectPlatformTags();
                Ext.filterPlatform = a.filterPlatform
            },
            canonicalUrl: function (g) {
                i.href = g;
                var b = i.href,
                    e = k.disableCachingParam,
                    c = e ? b.indexOf(e + '=') : -1,
                    d, a;
                if (c > 0 && ((d = b.charAt(c - 1)) === '?' || d === '&')) {
                    a = b.indexOf('&', c);
                    a = a < 0 ? '' : b.substring(a);
                    if (a && d === '?') {
                        ++c;
                        a = a.substring(1)
                    }
                    b = b.substring(0, c - 1) + a
                }
                return b
            },
            getConfig: function (b) {
                return b ? a.config[b] : a.config
            },
            setConfig: function (b, d) {
                if (typeof b === 'string') {
                    a.config[b] = d
                } else {
                    for (var c in b) {
                        a.setConfig(c, b[c])
                    }
                }
                return a
            },
            getHead: function () {
                return a.docHead || (a.docHead = c.head || c.getElementsByTagName('head')[0])
            },
            create: function (e, c, d) {
                var b = d || {};
                b.url = e;
                b.key = c;
                return a.scripts[c] = new Entry(b)
            },
            getEntry: function (d, g, e) {
                var c, b;
                c = e ? d : a.canonicalUrl(d);
                b = a.scripts[c];
                if (!b) {
                    b = a.create(d, c, g);
                    if (e) {
                        b.canonicalPath = !0
                    }
                }
                return b
            },
            registerContent: function (e, c, b) {
                var d = {
                    content: b,
                    loaded: !0,
                    css: c === 'css'
                };
                return a.getEntry(e, d)
            },
            processRequest: function (a, b) {
                a.loadEntries(b)
            },
            load: function (b) {
                var b = new Request(b);
                if (b.sync || a.syncMode) {
                    return a.loadSync(b)
                }
                if (a.currentRequest) {
                    b.getEntries();
                    a.suspendedQueue.push(b)
                } else {
                    a.currentRequest = b;
                    a.processRequest(b, !1)
                }
                return a
            },
            loadSync: function (b) {
                var b = new Request(b);
                a.syncMode++;
                a.processRequest(b, !0);
                a.syncMode--;
                return a
            },
            loadBasePrefix: function (b) {
                b = new Request(b);
                b.prependBaseUrl = !0;
                return a.load(b)
            },
            loadSyncBasePrefix: function (b) {
                b = new Request(b);
                b.prependBaseUrl = !0;
                return a.loadSync(b)
            },
            requestComplete: function (c) {
                var b;
                if (a.currentRequest === c) {
                    a.currentRequest = null;
                    while (a.suspendedQueue.length > 0) {
                        b = a.suspendedQueue.shift();
                        if (!b.done) {
                            a.load(b);
                            break
                        }
                    }
                }
                if (!a.currentRequest && a.suspendedQueue.length == 0) {
                    a.fireListeners()
                }
            },
            isLoading: function () {
                return !a.currentRequest && a.suspendedQueue.length == 0
            },
            fireListeners: function () {
                var b;
                while (a.isLoading() && (b = a.listeners.shift())) {
                    b()
                }
            },
            onBootReady: function (b) {
                if (!a.isLoading()) {
                    b()
                } else {
                    a.listeners.push(b)
                }
            },
            getPathsFromIndexes: function (a, d) {
                if (!('length' in a)) {
                    var c = [],
                        b;
                    for (b in a) {
                        if (!isNaN(+b)) {
                            c[+b] = a[b]
                        }
                    }
                    a = c
                }
                return Request.prototype.getPathsFromIndexes(a, d)
            },
            createLoadOrderMap: function (a) {
                return Request.prototype.createLoadOrderMap(a)
            },
            fetch: function () {
                var a = this,
                    b = arguments;
                if (Ext.platformTags.cordova) {
                    document.addEventListener('deviceready', function () {
                        a._fetch.apply(a, b)
                    }, !1)
                } else {
                    a._fetch.apply(a, b)
                }
            },
            _fetch: function (k, e, j, b) {
                b = b === undefined ? !!e : b;
                var a = new XMLHttpRequest(),
                    c, i, h, g = !1,
                    d = function () {
                        if (a && a.readyState == 4) {
                            i = a.status === 1223 ? 204 : a.status === 0 && ((self.location || {}).protocol === 'file:' || (self.location || {}).protocol === 'ionp:') ? 200 : a.status;
                            h = a.responseText;
                            c = {
                                content: h,
                                status: i,
                                exception: g
                            };
                            if (e) {
                                e.call(j, c)
                            }
                            a.onreadystatechange = f;
                            a = null
                        }
                    };
                if (b) {
                    a.onreadystatechange = d
                }
                try {
                    a.open('GET', k, b);
                    a.send(null)
                } catch (o) {
                    g = o;
                    d();
                    return c
                }
                if (!b) {
                    d()
                }
                return c
            },
            notifyAll: function (a) {
                a.notifyRequests()
            }
        };

    function Request(b) {
        if (b.$isRequest) {
            return b
        }
        var b = b.url ? b : {
                url: b
            },
            c = b.url,
            e = c.charAt ? [c] : c,
            d = b.charset || a.config.charset;
        g(this, b);
        delete this.url;
        this.urls = e;
        this.charset = d
    }
    Request.prototype = {
        $isRequest: !0,
        createLoadOrderMap: function (d) {
            var e = d.length,
                c = {},
                a, b;
            for (a = 0; a < e; a++) {
                b = d[a];
                c[b.path] = b
            }
            return c
        },
        getLoadIndexes: function (b, e, o, m, n) {
            var g = [],
                k = [b],
                i = b.idx,
                k, j, d, c, h, l;
            if (e[i]) {
                return g
            }
            e[i] = g[i] = !0;
            while (b = k.shift()) {
                if (b.canonicalPath) {
                    j = a.getEntry(b.path, null, !0)
                } else {
                    j = a.getEntry(this.prepareUrl(b.path))
                }
                if (!(n && j.done)) {
                    if (m && b.uses && b.uses.length) {
                        d = b.requires.concat(b.uses)
                    } else {
                        d = b.requires
                    }
                    for (h = 0, l = d.length; h < l; h++) {
                        c = d[h];
                        if (!e[c]) {
                            e[c] = g[c] = !0;
                            k.push(o[c])
                        }
                    }
                }
            }
            return g
        },
        getPathsFromIndexes: function (b, e) {
            var c = [],
                a, d;
            for (a = 0, d = b.length; a < d; a++) {
                if (b[a]) {
                    c.push(e[a].path)
                }
            }
            return c
        },
        expandUrl: function (d, a, e, i, g, h) {
            var c, b;
            if (a) {
                c = e[d];
                if (c) {
                    b = this.getLoadIndexes(c, i, a, g, h);
                    if (b.length) {
                        return this.getPathsFromIndexes(b, a)
                    }
                }
            }
            return [d]
        },
        expandUrls: function (a, n) {
            var e = this,
                j = e.loadOrder,
                c = [],
                k = {},
                o = [],
                b, i, g, m, h, l, d;
            if (typeof a === 'string') {
                a = [a]
            }
            if (j) {
                b = e.loadOrderMap;
                if (!b) {
                    b = e.loadOrderMap = e.createLoadOrderMap(j)
                }
            }
            for (g = 0, m = a.length; g < m; g++) {
                i = this.expandUrl(a[g], j, b, o, n, !1);
                for (h = 0, l = i.length; h < l; h++) {
                    d = i[h];
                    if (!k[d]) {
                        k[d] = !0;
                        c.push(d)
                    }
                }
            }
            if (c.length === 0) {
                c = a
            }
            return c
        },
        expandLoadOrder: function () {
            var a = this,
                c = a.urls,
                b;
            if (!a.expanded) {
                b = this.expandUrls(c, !0);
                a.expanded = !0
            } else {
                b = c
            }
            a.urls = b;
            if (c.length != b.length) {
                a.sequential = !0
            }
            return a
        },
        getUrls: function () {
            this.expandLoadOrder();
            return this.urls
        },
        prepareUrl: function (b) {
            if (this.prependBaseUrl) {
                return a.baseUrl + b
            }
            return b
        },
        getEntries: function () {
            var b = this,
                c = b.entries,
                e, h, d, g, i, j;
            if (!c) {
                c = [];
                i = b.getUrls();
                if (b.loadOrder) {
                    e = b.loadOrderMap
                }
                for (d = 0; d < i.length; d++) {
                    j = b.prepareUrl(i[d]);
                    if (e) {
                        h = e[j]
                    }
                    g = a.getEntry(j, {
                        buster: b.buster,
                        charset: b.charset
                    }, h && h.canonicalPath);
                    g.requests.push(b);
                    c.push(g)
                }
                b.entries = c
            }
            return c
        },
        loadEntries: function (g) {
            var a = this,
                c = a.getEntries(),
                h = c.length,
                i = a.loadStart || 0,
                d, c, e, b;
            if (g !== undefined) {
                a.sync = g
            }
            a.loaded = a.loaded || 0;
            a.loading = a.loading || h;
            for (b = i; b < h; b++) {
                e = c[b];
                if (!e.loaded) {
                    d = c[b].load(a.sync)
                } else {
                    d = !0
                }
                if (!d) {
                    a.loadStart = b;
                    e.onDone(function () {
                        a.loadEntries(g)
                    });
                    break
                }
            }
            a.processLoadedEntries()
        },
        processLoadedEntries: function () {
            var a = this,
                d = a.getEntries(),
                g = d.length,
                e = a.startIndex || 0,
                c, b;
            if (!a.done) {
                for (c = e; c < g; c++) {
                    b = d[c];
                    if (!b.loaded) {
                        a.startIndex = c;
                        return
                    }
                    if (!b.evaluated) {
                        b.evaluate()
                    }
                    if (b.error) {
                        a.error = !0
                    }
                }
                a.notify()
            }
        },
        notify: function () {
            var b = this;
            if (!b.done) {
                var e = b.error,
                    d = b[e ? 'failure' : 'success'],
                    c = 'delay' in b ? b.delay : e ? 1 : a.config.chainDelay,
                    g = b.scope || b;
                b.done = !0;
                if (d) {
                    if (c === 0 || c > 0) {
                        setTimeout(function () {
                            d.call(g, b)
                        }, c)
                    } else {
                        d.call(g, b)
                    }
                }
                b.fireListeners();
                a.requestComplete(b)
            }
        },
        onDone: function (b) {
            var a = this,
                c = a.listeners || (a.listeners = []);
            if (a.done) {
                b(a)
            } else {
                c.push(b)
            }
        },
        fireListeners: function () {
            var a = this.listeners,
                b;
            if (a) {
                while (b = a.shift()) {
                    b(this)
                }
            }
        }
    };

    function Entry(c) {
        if (c.$isEntry) {
            return c
        }
        var j = c.charset || a.config.charset,
            i = Ext.manifest,
            e = i && i.loader,
            d = c.cache !== undefined ? c.cache : e && e.cache,
            b, h;
        if (a.config.disableCaching) {
            if (d === undefined) {
                d = !a.config.disableCaching
            }
            if (d === !1) {
                b = +new Date()
            } else {
                if (d !== !0) {
                    b = d
                }
            }
            if (b) {
                h = e && e.cacheParam || a.config.disableCachingParam;
                b = h + '=' + b
            }
        }
        g(this, c);
        this.charset = j;
        this.buster = b;
        this.requests = []
    }
    Entry.prototype = {
        $isEntry: !0,
        done: !1,
        evaluated: !1,
        loaded: !1,
        isCrossDomain: function () {
            var b = this;
            if (b.crossDomain === undefined) {
                b.crossDomain = b.getLoadUrl().indexOf(a.origin) !== 0
            }
            return b.crossDomain
        },
        isCss: function () {
            var b = this;
            if (b.css === undefined) {
                if (b.url) {
                    var c = a.assetConfig[b.url];
                    b.css = c ? c.type === 'css' : n.test(b.url)
                } else {
                    b.css = !1
                }
            }
            return this.css
        },
        getElement: function (e) {
            var d = this,
                b = d.el;
            if (!b) {
                if (d.isCss()) {
                    e = e || 'link';
                    b = c.createElement(e);
                    if (e == 'link') {
                        b.rel = 'stylesheet';
                        d.prop = 'href'
                    } else {
                        d.prop = 'textContent'
                    }
                    b.type = 'text/css'
                } else {
                    e = e || 'script';
                    b = c.createElement(e);
                    b.type = 'text/javascript';
                    d.prop = 'src';
                    if (d.charset) {
                        b.charset = d.charset
                    }
                    if (a.hasAsync) {
                        b.async = !1
                    }
                }
                d.el = b
            }
            return b
        },
        getLoadUrl: function () {
            var b = this,
                c;
            c = b.canonicalPath ? b.url : a.canonicalUrl(b.url);
            if (!b.loadUrl) {
                b.loadUrl = !!b.buster ? c + (c.indexOf('?') === -1 ? '?' : '&') + b.buster : c
            }
            return b.loadUrl
        },
        fetch: function (b) {
            var e = this.getLoadUrl(),
                d = !!b.async,
                c = b.complete;
            a.fetch(e, c, this, d)
        },
        onContentLoaded: function (c) {
            var a = this,
                b = c.status,
                e = c.content,
                g = c.exception,
                h = this.getLoadUrl();
            a.loaded = !0;
            if ((g || b === 0) && !d.phantom) {
                a.error = !0;
                a.evaluated = !0
            } else {
                if (b >= 200 && b < 300 || b === 304 || d.phantom || b === 0 && e.length > 0) {
                    a.content = e
                } else {
                    a.error = !0;
                    a.evaluated = !0
                }
            }
        },
        createLoadElement: function (b) {
            var c = this,
                d = c.getElement();
            c.preserve = !0;
            d.onerror = function () {
                c.error = !0;
                if (b) {
                    b();
                    b = null
                }
            };
            if (a.isIE10m) {
                d.onreadystatechange = function () {
                    if (this.readyState === 'loaded' || this.readyState === 'complete') {
                        if (b) {
                            b();
                            b = this.onreadystatechange = this.onerror = null
                        }
                    }
                }
            } else {
                d.onload = function () {
                    b();
                    b = this.onload = this.onerror = null
                }
            }
            d[c.prop] = c.getLoadUrl()
        },
        onLoadElementReady: function () {
            a.getHead().appendChild(this.getElement());
            this.evaluated = !0
        },
        inject: function (h, m) {
            var g = this,
                d = a.getHead(),
                l = g.url,
                i = g.key,
                b, e, k, j;
            if (g.isCss()) {
                g.preserve = !0;
                j = i.substring(0, i.lastIndexOf('/') + 1);
                b = c.createElement('base');
                b.href = j;
                if (d.firstChild) {
                    d.insertBefore(b, d.firstChild)
                } else {
                    d.appendChild(b)
                }
                b.href = b.href;
                if (l) {
                    h += '\n/*# sourceURL=' + i + ' */'
                }
                e = g.getElement('style');
                k = 'styleSheet' in e;
                d.appendChild(b);
                if (k) {
                    d.appendChild(e);
                    e.styleSheet.cssText = h
                } else {
                    e.textContent = h;
                    d.appendChild(e)
                }
                d.removeChild(b)
            } else {
                if (l) {
                    h += '\n//# sourceURL=' + i
                }
                Ext.globalEval(h)
            }
            return g
        },
        loadCrossDomain: function () {
            var a = this,
                b = function () {
                    a.el.onerror = a.el.onload = f;
                    a.el = null;
                    a.loaded = a.evaluated = a.done = !0;
                    a.notifyRequests()
                };
            a.createLoadElement(function () {
                b()
            });
            a.evaluateLoadElement();
            return !1
        },
        loadElement: function () {
            var a = this,
                b = function () {
                    a.el.onerror = a.el.onload = f;
                    a.el = null;
                    a.loaded = a.evaluated = a.done = !0;
                    a.notifyRequests()
                };
            a.createLoadElement(function () {
                b()
            });
            a.evaluateLoadElement();
            return !0
        },
        loadSync: function () {
            var a = this;
            a.fetch({
                async: !1,
                complete: function (b) {
                    a.onContentLoaded(b)
                }
            });
            a.evaluate();
            a.notifyRequests()
        },
        load: function (c) {
            var b = this;
            if (!b.loaded) {
                if (b.loading) {
                    return !1
                }
                b.loading = !0;
                if (!c) {
                    if (a.isIE10 || b.isCrossDomain()) {
                        return b.loadCrossDomain()
                    } else {
                        if (!b.isCss() && a.hasReadyState) {
                            b.createLoadElement(function () {
                                b.loaded = !0;
                                b.notifyRequests()
                            })
                        } else {
                            if (a.useElements && !(b.isCss() && d.phantom)) {
                                return b.loadElement()
                            } else {
                                b.fetch({
                                    async: !c,
                                    complete: function (a) {
                                        b.onContentLoaded(a);
                                        b.notifyRequests()
                                    }
                                })
                            }
                        }
                    }
                } else {
                    b.loadSync()
                }
            }
            return !0
        },
        evaluateContent: function () {
            this.inject(this.content);
            this.content = null
        },
        evaluateLoadElement: function () {
            a.getHead().appendChild(this.getElement())
        },
        evaluate: function () {
            var a = this;
            if (!a.evaluated) {
                if (a.evaluating) {
                    return
                }
                a.evaluating = !0;
                if (a.content !== undefined) {
                    a.evaluateContent()
                } else {
                    if (!a.error) {
                        a.evaluateLoadElement()
                    }
                }
                a.evaluated = a.done = !0;
                a.cleanup()
            }
        },
        cleanup: function () {
            var c = this,
                a = c.el,
                b;
            if (!a) {
                return
            }
            if (!c.preserve) {
                c.el = null;
                a.parentNode.removeChild(a);
                for (b in a) {
                    try {
                        if (b !== c.prop) {
                            a[b] = null
                        }
                        delete a[b]
                    } catch (o) {}
                }
            }
            a.onload = a.onerror = a.onreadystatechange = f
        },
        notifyRequests: function () {
            var b = this.requests,
                d = b.length,
                a, c;
            for (a = 0; a < d; a++) {
                c = b[a];
                c.processLoadedEntries()
            }
            if (this.done) {
                this.fireListeners()
            }
        },
        onDone: function (b) {
            var a = this,
                c = a.listeners || (a.listeners = []);
            if (a.done) {
                b(a)
            } else {
                c.push(b)
            }
        },
        fireListeners: function () {
            var a = this.listeners,
                b;
            if (a && a.length > 0) {
                while (b = a.shift()) {
                    b(this)
                }
            }
        }
    };
    Ext.disableCacheBuster = function (b, d) {
        var a = new Date();
        a.setTime(a.getTime() + (b ? 10 * 365 : -1) * 24 * 60 * 60 * 1000);
        a = a.toGMTString();
        c.cookie = 'ext-cache=1; expires=' + a + '; path=' + (d || '/')
    };
    a.init();
    return a
}(function () {});
Ext.globalEval = Ext.globalEval || (this.execScript ? function (a) {
    execScript(a)
} : function (a) {
    eval.call(window, a)
});
if (!Function.prototype.bind) {
    (function () {
        var a = Array.prototype.slice,
            b = function (d) {
                var b = a.call(arguments, 1),
                    c = this;
                if (b.length) {
                    return function () {
                        var e = arguments;
                        return c.apply(d, e.length ? b.concat(a.call(e)) : b)
                    }
                }
                b = null;
                return function () {
                    return c.apply(d, arguments)
                }
            };
        Function.prototype.bind = b;
        b.$extjs = !0
    })()
}
Ext.setResourcePath = function (b, d) {
    var a = Ext.manifest || (Ext.manifest = {}),
        c = a.resources || (a.resources = {});
    if (a) {
        if (typeof b !== 'string') {
            Ext.apply(c, b)
        } else {
            c[b] = d
        }
        a.resources = c
    }
};
Ext.getResourcePath = function (b, f, d) {
    if (typeof b !== 'string') {
        f = b.pool;
        d = b.packageName;
        b = b.path
    }
    var e = Ext.manifest,
        g = e && e.resources,
        a = g[f],
        c = [];
    if (a == null) {
        a = g.path;
        if (a == null) {
            a = 'resources'
        }
    }
    if (a) {
        c.push(a)
    }
    if (d) {
        c.push(d)
    }
    c.push(b);
    return c.join('/')
};
Ext.define('Ext.locale.zh_CN.Component', {
    override: 'Ext.Component'
});
Ext.define('Ext.locale.zh_CN.data.validator.Number', {
    override: 'Ext.data.validator.Number',
    config: {
        message: '不是一个有效数值'
    }
});
Ext.define('Ext.locale.zh_CN.Panel', {
    override: 'Ext.Panel',
    config: {
        standardButtons: {
            ok: {
                text: '确定'
            },
            abort: {
                text: '终止'
            },
            retry: {
                text: '重试'
            },
            ignore: {
                text: '忽略'
            },
            yes: {
                text: '是'
            },
            no: {
                text: '否'
            },
            cancel: {
                text: '取消'
            },
            apply: {
                text: '应用'
            },
            save: {
                text: '保存'
            },
            submit: {
                text: '提交'
            },
            help: {
                text: '帮助'
            },
            close: {
                text: '关闭'
            }
        },
        closeToolText: '关闭面板'
    }
});
Ext.define('Ext.locale.zh_CN.field.Field', {
    override: 'Ext.field.Field',
    config: {
        requiredMessage: '必填项',
        validationMessage: '格式错误'
    }
});
Ext.define('Ext.locale.zh_CN.field.Text', {
    override: 'Ext.field.Text',
    config: {
        requiredMessage: '必填项',
        validationMessage: '格式错误'
    },
    badFormatMessage: '值与所需的格式不符'
});
Ext.define('Ext.theme.neptune.Titlebar', {
    override: 'Ext.TitleBar',
    config: {
        defaultButtonUI: 'alt'
    }
});
Ext.define('Ext.locale.zh_CN.dataview.EmptyText', {
    override: 'Ext.dataview.EmptyText',
    config: {
        html: '没有数据'
    }
});
Ext.define('Ext.locale.zh_CN.dataview.Abstract', {
    override: 'Ext.dataview.Abstract',
    config: {
        loadingText: '加载中...'
    }
});
Ext.define('Ext.locale.zh_CN.dataview.List', {
    override: 'Ext.dataview.List',
    config: {
        loadingText: '加载中...'
    }
});
Ext.define('Ext.locale.zh_CN.picker.Picker', {
    override: 'Ext.picker.Picker',
    config: {
        doneButton: '完成',
        cancelButton: '关闭'
    }
});
Ext.define('Ext.locale.zh_CN.picker.Date', {
    override: 'Ext.picker.Date',
    config: {
        doneButton: '完成',
        monthText: '月',
        dayText: '日',
        yearText: '年',
        slotOrder: ['year', 'month', 'day']
    }
});
Ext.define('Ext.theme.neptune.panel.Date', {
    override: 'Ext.panel.Date',
    border: !0
});
Ext.define('Ext.locale.zh_CN.panel.Date', {
    override: 'Ext.panel.Date',
    config: {
        nextText: '下个月 (Ctrl + ->)',
        prevText: '上个月 (Ctrl + <-)',
        headerFormat: {
            $value: 'Y-m-d l',
            cached: !0
        }
    }
});
Ext.define('Ext.locale.zh_CN.field.Date', {
    override: 'Ext.field.Date',
    minDateMessage: '该输入项的日期必须在 {0} 之后',
    maxDateMessage: '该输入项的日期必须在 {0} 之前'
});
Ext.define('Ext.locale.zh_CN.field.Number', {
    override: 'Ext.field.Number',
    decimalsText: '最大小数位数为 {0}',
    minValueText: '该输入项的最小值是 {0}',
    maxValueText: '该输入项的最大值是 {0}',
    badFormatMessage: '不是一个有效的数值'
});
Ext.define('Ext.locale.zh_CN.grid.menu.Columns', {
    override: 'Ext.grid.menu.Columns',
    config: {
        text: '列'
    }
});
Ext.define('Ext.locale.zh_CN.grid.menu.GroupByThis', {
    override: 'Ext.grid.menu.GroupByThis',
    config: {
        text: '按该字段分组'
    }
});
Ext.define('Ext.locale.zh_CN.grid.menu.ShowInGroups', {
    override: 'Ext.grid.menu.ShowInGroups',
    config: {
        text: '以分组形式显示'
    }
});
Ext.define('Ext.locale.zh_CN.grid.menu.SortAsc', {
    override: 'Ext.grid.menu.SortAsc',
    config: {
        text: '正序'
    }
});
Ext.define('Ext.locale.zh_CN.grid.menu.SortDesc', {
    override: 'Ext.grid.menu.SortDesc',
    config: {
        text: '倒序'
    }
});
Ext.namespace('Ext.theme.is').Neptune = !0;
Ext.theme.name = 'Neptune';
Ext.theme.getDocCls = function () {
    return Ext.platformTags.desktop ? '' : 'x-big'
};
Ext.namespace('Ext.theme.is').Triton = !0;
Ext.theme.name = 'Triton';
Ext.theme.getDocCls = function () {
    return Ext.platformTags.phone ? 'x-big' : ''
};
Ext.define(null, {
    override: 'Ext.Dialog',
    config: {
        border: !1,
        maxHeight: '90vh',
        maxWidth: '90vw',
        buttonAlign: 'right',
        buttonToolbar: {
            ui: 'footer'
        },
        resizable: {
            edges: 'all'
        },
        showAnimation: null,
        hideAnimation: null
    }
});
Ext.define(null, {
    override: 'Ext.LoadMask',
    config: {
        message: ''
    }
});
Ext.define(null, {
    override: 'Ext.MessageBox',
    config: {
        buttonAlign: 'center'
    }
});
Ext.define(null, {
    override: 'Ext.field.Field',
    config: {
        labelTextAlign: 'right',
        errorTip: {
            anchor: !0,
            align: 'l-r?',
            ui: 'tooltip invalid'
        }
    },
    platformConfig: {
        phone: {
            errorTarget: 'under'
        }
    }
});
Ext.namespace('Ext.theme.is')['default'] = !0;
Ext.theme.name = 'theme-default';
Ext.define(null, {
    override: 'Ext.tab.Bar',
    config: {
        defaultTabUI: 'flat',
        ui: 'flat',
        shadow: !0
    }
});
Ext.define(null, {
    override: 'Ext.tab.Panel',
    config: {
        ui: 'flat'
    }
});
Ext.cmd.derive('Ext.package.Entry', Ext.Base, {
    count: 0,
    loaded: !1,
    constructor: function (b) {
        var a = this;
        a.packageName = b;
        a.jsUrl = Ext.getResourcePath(b + '.js', null, b);
        a.cssUrl = Ext.getResourcePath(b + '.css', null, b);
        a.promise = new Ext.Promise(function (c, d) {
            a.resolveFn = c;
            a.rejectFn = d
        })
    },
    getRequires: function () {
        var c = this,
            f = c.metadata,
            a = c._requires,
            b, d;
        if (!a) {
            a = [];
            if (f && (b = f.requires) && b.length) {
                for (var e = 0; e < b.length; e++) {
                    d = b[e];
                    if (d != c.packageName) {
                        a.push(d)
                    }
                }
            }
            c._requires = a
        }
        return a
    },
    beginLoad: function () {
        var a = this;
        if (!a.loaded) {
            a.block();
            a.loadStyle();
            a.loadScript();
            a.unblock()
        }
    },
    loadStyle: function () {
        var b = this.metadata,
            c = b && b.required,
            a = b && b.css;
        if (a !== !1 && c !== !0) {
            if (Array.isArray(a)) {
                for (i = 0; i < a.length; i++) {
                    this.load(a[i].path.replaceAll('${package.dir}/', Ext.getResourcePath('', null, this.packageName)))
                }
            } else {
                if (a !== !1 && c !== !0) {
                    this.load(this.cssUrl)
                }
            }
        }
    },
    loadScript: function () {
        var b = this.metadata,
            c = b && b.files,
            f = Ext.manifest,
            e = f && f.loadOrder,
            g = [],
            a, d = b.js;
        if (c && e) {
            for (a = 0; a < c.length; a++) {
                g.push(e[c[a]].path)
            }
            this.load(g)
        } else {
            if (b && !b.included) {
                if (Array.isArray(d)) {
                    for (a = 0; a < d.length; a++) {
                        this.load(d[a].path.replaceAll('${package.dir}/', Ext.getResourcePath('', null, this.packageName)))
                    }
                } else {
                    this.load(this.jsUrl)
                }
            }
        }
    },
    load: function (b) {
        var a = this;
        a.block();
        Ext.Boot.load({
            url: b,
            success: function () {
                a.unblock()
            },
            failure: function () {
                if (b.endsWith('.css')) {
                    a.unblock()
                } else {
                    if (!a.error) {
                        a.error = new Error('Failed to load "' + b + '"');
                        a.error.url = b;
                        a.unblock()
                    }
                }
            }
        })
    },
    block: function () {
        this.count++
    },
    _wait: function (b) {
        var a = this;
        a.block();
        Ext.require(b, function () {
            a.unblock()
        })
    },
    _getPendingClasses: function () {
        var b = Ext.ClassManager,
            c = b && b.classState,
            d, a;
        if (b.getPendingClasses) {
            return b.getPendingClasses()
        } else {
            if (c) {
                d = [];
                for (a in c) {
                    if (a && a !== 'null') {
                        if (c[a] < 30) {
                            d.push(a)
                        }
                    }
                }
                return d
            }
        }
    },
    unblock: function () {
        var a = this;
        if (!a.error && a.count > 1) {
            a.count--
        } else {
            a.count = 0;
            var b = a._getPendingClasses();
            if (b && b.length) {
                a._wait(b)
            } else {
                a.notify()
            }
        }
    },
    notify: function () {
        var a = this;
        if (a.resolveFn) {
            a.count = 0;
            if (a.error) {
                a.rejectFn(a.error)
            } else {
                a.loaded = !0;
                a.resolveFn(a)
            }
            a.resolveFn = a.rejectFn = null
        }
    }
}, 1, 0, 0, 0, 0, 0, [Ext['package'], 'Entry'], 0);
Ext.cmd.derive('Ext.Package', Ext.Base, {
    singleton: !0,
    isLoaded: function (b) {
        var a = this.getEntry(b);
        return a ? a.loaded : !1
    },
    load: function (b) {
        var a = this,
            c;
        if (!a.getPackages()[b]) {
            return Ext.Promise.reject(new Error('Cannot load package "' + b + '"'))
        }
        c = a.getEntry(b);
        a._queue(c);
        if (!a._loading) {
            a._advance()
        }
        return c.promise
    },
    _entryMap: {},
    _usesMap: null,
    _packagesMap: null,
    _loadQueue: [],
    _loading: !1,
    _advance: function () {
        var a = this,
            c = a._loadQueue,
            b = c.shift();
        if (b) {
            a._loading = !0;
            b.beginLoad();
            b.promise.then(function () {
                a._advance()
            }, function () {
                a._advance()
            })
        } else {
            a._loading = !1
        }
    },
    getPackages: function () {
        var a = this._packagesMap;
        if (!a) {
            a = Ext.manifest && Ext.manifest.packages;
            a = a || {};
            this._packagesMap = a
        }
        return a
    },
    _queue: function (a) {
        var d = this,
            c, e, f, b;
        if (!a.queued && !a.loaded) {
            a.queued = !0;
            c = a.getRequires();
            for (b = 0; b < c.length; b++) {
                e = c[b];
                f = d.getEntry(e);
                d._queue(f)
            }
            d._loadQueue.push(a)
        }
        return a
    },
    loadAllScripts: function (a, b) {
        var d = this,
            c = d.getEntry(a);
        c.load(b)
    },
    getEntry: function (a) {
        var c = this._entryMap,
            b = c[a];
        if (!b) {
            c[a] = b = new Ext['package'].Entry(a);
            var d = this.getPackages()[a];
            if (d) {
                b.metadata = d
            }
        }
        return b
    }
}, 0, 0, 0, 0, 0, 0, [Ext, 'Package'], 0);
Ext.onReady(function () {
    if (Ext.Date) {
        Ext.Date.dayNames = ['周日', '周一', '周二', '周三', '周四', '周五', '周六'];
        Ext.Date.monthNames = ['一月', '二月', '三月', '四月', '五月', '六月', '七月', '八月', '九月', '十月', '十一月', '十二月'];
        Ext.Date.getShortMonthName = function (b) {
            var a = Ext.Date.monthNames[b];
            return a.substr(0, a.length - 1)
        };
        Ext.Date.getShortDayName = function (a) {
            return Ext.Date.dayNames[a].substr(1, 1)
        }
    }
    if (Ext.util && Ext.util.Format) {
        Ext.apply(Ext.util.Format, {
            currencySign: '¥',
            defaultDateFormat: 'Y-m-d'
        })
    }
    if (Ext.Date) {
        Ext.apply(Ext.Date, {
            defaultFormat: 'Y-m-d'
        })
    }
});
Ext.define(null, {
    override: 'Ext.Button',
    href: null,
    config: {
        circularProgress: null
    },
    circularProgressCls: 'circular-progress',
    updateCircularProgress: function (b) {
        var a = this;
        Ext.destroy(a.progressBar);
        delete a.progressBar;
        if (a.getDisabled() && b) {
            a.createCircularProgress()
        }
    },
    updateDisabled: function (b) {
        var a = this;
        a.callParent(arguments);
        Ext.destroy(a.progressBar);
        delete a.progressBar;
        if (a.getCircularProgress() && b) {
            a.createCircularProgress()
        }
    },
    createCircularProgress: function () {
        var a = this;
        a.progressBar = a.element.appendChild({
            tag: 'span',
            cls: a.circularProgressCls,
            html: '<svg class="indeterminate" viewBox="0 0 50 50""><circle cx="25" cy="25" r="20" fill="none" stroke-width="3.6"></circle></svg>'
        })
    },
    onTap: function (c) {
        var b = this;
        b.callParent(arguments);
        var a = b.href;
        if (!Ext.isEmpty(a)) {
            Ext.app.Application.instance.redirectTo(a)
        }
    },
    destroy: function () {
        var a = this;
        a.callParent(arguments);
        Ext.destroy(a.progressBar);
        delete a.progressBar
    }
});
Ext.define(null, {
    override: 'Ext.carousel.Carousel',
    setOffset: function (a) {
        var c = this.innerItems.length,
            b = this.activeIndex;
        if (b == 0 && a > 0 || b == c - 1 && a < 0) {
            return
        }
        this.offset = a;
        if (Ext.isNumber(this.itemOffset)) {
            this.getTranslatable().translateAxis(this.currentAxis, a + this.itemOffset)
        }
        return this
    }
});
Ext.define(null, {
    override: 'Ext.Component',
    config: {
        displayed: null,
        html: null,
        draggable: null,
        zIndex: null,
        tpl: null,
        enterAnimation: null,
        exitAnimation: null,
        showAnimation: null,
        hideAnimation: null,
        tplWriteMode: 'overwrite',
        data: null,
        contentEl: null,
        record: null,
        tooltip: null,
        axisLock: null,
        modal: {
            lazy: !0,
            $value: null
        },
        hideOnMaskTap: null,
        weight: null,
        userSelectable: null,
        judgeName: null
    },
    modalBgColor: null,
    ajax: function () {
        var c = this,
            b = arguments,
            a = b[b.length - 1];
        if (a.success || a.failure || a.callback || a.scope || a.loadTarget !== undefined || a.maskTarget !== undefined || a.button) {
            a.ajaxHost = c
        }
        return Utils.ajax.apply(Utils, arguments)
    },
    aioAjax: function () {
        var c = this,
            b = arguments,
            a = b[b.length - 1];
        if (a.success || a.failure || a.callback || a.scope || a.loadTarget !== undefined || a.maskTarget !== undefined || a.button) {
            a.ajaxHost = c
        }
        return Utils.aioAjax.apply(Utils, arguments)
    },
    destroy: function () {
        var a = this;
        a.abortAllAjax();
        a.callParent(arguments)
    },
    abortAllAjax: function () {
        var a = this;
        if (a.ajaxRequests) {
            for (var b in a.ajaxRequests) {
                Ext.Ajax.abort(a.ajaxRequests[b]);
                delete a.ajaxRequests[b]
            }
            delete a.ajaxRequests
        }
    },
    getModalMask: function () {
        var c = this,
            a = c.floatParentNode;
        if (a) {
            if (c.getFloated() && c.getModal() === !0) {
                var b = a.getData(),
                    d = Ext.getFloatRoot();
                if (a !== d && !b.component.getRelative()) {
                    b = d.getData()
                }
                return b.modalMask
            }
        }
        return null
    },
    privates: {
        showModalMask: function () {
            var a = this;
            a.callParent(arguments);
            var b = a.getModalMask();
            if (b) {
                b.setStyle('background-color', a.modalBgColor)
            }
        },
        hideModalMask: function () {
            var b = this;
            b.callParent(arguments);
            var a = b.getModalMask();
            if (a) {
                a.setStyle('background-color', null)
            }
        }
    },
    showByInside: function (d, c, e) {
        var b = this;
        var a = b.element && b.element.getParent();
        if (!a) {
            return
        }
        var f = {
            isWidget: !0,
            el: {
                getRegion: function () {
                    var f = d.element;
                    var b = f.getOffsetsTo(a);
                    var g = f.getSize();
                    var i = a.dom.scrollTop + b[1];
                    var h = a.dom.scrollLeft + b[0];
                    return new Ext.util.Region(i, h + g.width, i + g.height, h)
                }
            }
        };
        b.setHidden(!1);
        b.showBy(f, c, e)
    },
    updateJudgeName: function (a) {
        this.setHidden(!window.VerControll.judgeFn(a))
    }
});
Ext.define(null, {
    override: 'Ext.Container',
    destroyOnHide: !1,
    initialize: function () {
        var a = this;
        a.callParent(arguments);
        a.onAfter({
            hide: 'onAfterHide',
            scope: a
        })
    },
    onAfterHide: function () {
        if (this.destroyOnHide) {
            this.destroy()
        }
    }
});
Ext.define(null, {
    override: 'Ext.MessageBox',
    updatePrompt: function (b, a) {
        if (b) {
            this.add(b)
        }
        if (a && !a.isDestroyed && !a.isDestroying) {
            this.remove(a)
        }
    }
});
Ext.define(null, {
    override: 'Ext.data.AbstractStore',
    config: {
        autoDestroy: !0
    }
});
Ext.define(null, {
    override: 'Ext.data.proxy.Ajax',
    config: {
        api: null,
        silence: !1,
        useDefaultXhrHeader: !1,
        withCredentials: !0,
        actionMethods: {
            read: 'POST'
        },
        reader: {
            type: 'json',
            rootProperty: 'root',
            messageProperty: 'message'
        },
        writer: {
            type: 'json'
        }
    },
    updateApi: function (a) {
        this.setUrl(Utils.getFullUrl(a))
    },
    constructor: function () {
        var me = this;
        me.callParent(arguments);
        me.on({
            exception: function (proxy, r, options) {
                var err = r.responseText;
                if (!Ext.isEmpty(err)) {
                    try {
                        err = eval('(' + err + ')')
                    } catch (b) {}
                } else {
                    err = r.statusText
                }
                var msg = err.message || err;
                if (r.status == '0') {
                    Utils.toastShort(msg || 'communication failure')
                } else {
                    if (r.status == '-1') {} else {
                        if (Utils.isUnauthorized(r.status)) {
                            Utils.toastShort(msg);
                            Utils.getApp().fireEvent('needlogin')
                        } else {
                            if (!this.getSilence()) {
                                Utils.alert(msg)
                            }
                        }
                    }
                }
            }
        })
    },
    buildRequest: function () {
        var a = Utils.getApp().getClientInfo();
        if (a) {
            for (var b in a) {
                if (a.hasOwnProperty(b)) {
                    this.setExtraParam(b, a[b])
                }
            }
        }
        return this.callParent(arguments)
    }
});
Ext.define(null, {
    override: 'Ext.dataview.Abstract',
    onInnerFocusEnter: function (c) {
        var b = this,
            d = b.getNavigationModel(),
            a, e;
        if (d.lastLocation === 'scrollbar') {
            if (c.relatedTarget) {
                c.relatedTarget.focus()
            }
            return
        }
        if (c.target === b.getFocusEl().dom) {
            a = b.restoreFocus && d.getPreviousLocation();
            if (a) {
                a = a.refresh()
            } else {
                if (c.backwards) {
                    a = b.getLastDataItem()
                } else {
                    a = b.getFirstDataItem()
                }
            }
            if (!a) {
                return
            }
        } else {
            a = c
        }
        b.toggleChildrenTabbability(!1);
        e = b.getFastItems().length;
        if (e) {
            if (a.isWidget) {
                a = a.getFocusEl() || a.el
            }
            d.setLocation(a, {
                event: c,
                navigate: !1
            })
        }
        if (d.getLocation()) {
            b.el.dom.setAttribute('tabIndex', -1)
        }
    },
    privates: {
        findTailItem: function (d) {
            var h = this,
                b = d ? h.innerItems : h.items.items,
                g = -1,
                f = null,
                a, c, e;
            for (a = 0; a < b.length; a++) {
                c = b[a];
                if (!c.isEmptyText) {
                    e = c.scrollDock;
                    if (e === 'end') {
                        f = b[g = a]
                    }
                }
            }
            return d ? f : g
        }
    }
});
Ext.define(null, {
    override: 'Ext.dataview.BoundList',
    config: {
        itemConfig: {
            cls: 'x-boundlistitem',
            tools: null
        }
    }
});
Ext.define(null, {
    override: 'Ext.dataview.List',
    platformConfig: {
        desktop: {
            userSelectable: 'text'
        }
    }
});
Ext.define(null, {
    override: 'Ext.dataview.NavigationModel',
    setLocation: function (a, b) {
        var d = this,
            g = d.getView(),
            j = d.location,
            k = b && b.animation,
            i, c, f, e, h;
        if (a == null) {
            return d.clearLocation()
        }
        if (!a.isDataViewLocation) {
            a = this.createLocation(a)
        }
        if (!a.equals(j)) {
            f = a.record;
            c = a.child;
            if (f && !c) {
                return g.ensureVisible(f, {
                    animation: k
                }).then(function () {
                    if (!d.destroyed) {
                        d.setLocation({
                            record: f,
                            column: a.column
                        }, b)
                    }
                })
            }
            if (c && d.floatingItems == null) {
                c = c.isComponent ? c.el : Ext.fly(c);
                e = c.up();
                h = c.getStyleValue('float');
                d.floatingItems = g.getInline && g.getInline() || c.isStyle('display', 'inline-block') || h === 'left' || h === 'right' || e && e.isStyle('display', 'flex') && e.isStyle('flex-direction', 'row')
            }
            i = g.getScrollable();
            if (i) {
                if (!b || !b.event || b.event.type != 'tap' && b.event.type != 'focusenter') {
                    i.ensureVisible(a.sourceElement, {
                        animation: b && b.animation
                    })
                }
            }
            d.handleLocationChange(a, b);
            if (!d.destroyed) {
                d.doFocus()
            }
        }
    },
    privates: {
        onKeyPageDown: function (d) {
            d.preventDefault();
            if (!this.location.actionable && !this.floatingItems) {
                var a = this;
                if (!a.location.child) {
                    return
                }
                var c = a.getView(),
                    e = (c.infinite ? c.getItemTop(a.location.child) : a.location.child.el.dom.offsetTop) + c.el.getClientRegion().height,
                    b = a.createLocation(c.getItemFromPoint(0, e));
                if (!(b.child && b.child.el.isFocusable())) {
                    b = b.previous()
                }
                a.setLocation(b, {
                    event: d
                })
            }
        },
        onKeyPageUp: function (d) {
            d.preventDefault();
            if (!this.location.actionable && !this.floatingItems) {
                var a = this;
                if (!a.location.child) {
                    return
                }
                var c = a.getView(),
                    e = (c.infinite ? c.getItemTop(a.location.child) : a.location.child.el.dom.offsetTop) - c.el.getClientRegion().height,
                    b = a.createLocation(c.getItemFromPoint(0, e));
                if (!(b.child && b.child.el.isFocusable())) {
                    b = b.next()
                }
                a.setLocation(b, {
                    event: d
                })
            }
        }
    }
});
Ext.define(null, {
    override: 'Ext.plugin.ListPaging',
    storeFullyLoaded: function () {
        var e = this,
            a = e.cmp.getStore(),
            c = a.getPageSize(),
            b = a.lastLoadCount,
            d = a.getTotalCount();
        if (b !== undefined && b < c) {
            return !0
        }
        return d !== null ? d <= a.currentPage * c : !1
    },
    onStoreLoad: function (c, b, a, d) {
        c.lastLoadCount = a ? b.length : 0;
        this.callParent(arguments)
    }
});
Ext.define(null, {
    override: 'Ext.dataview.selection.Model',
    selectWithEventMulti: function (b, e, f) {
        var a = this,
            c = e.shiftKey,
            g = e.ctrlKey,
            d = c ? a.selectionStart : null;
        if (c && d) {
            a.selectRange(d, b, g)
        } else {
            if (f) {
                a.deselect(b)
            } else {
                a.select(b, !0)
            }
        }
    },
    fireSelectionChange: function (b, a) {
        this.callParent(arguments);
        this.getView().fireEvent('selectionchange', this.getView(), b, a)
    }
});
Ext.define(null, {
    override: 'Ext.field.Checkbox',
    updateReadOnly: function (a) {
        this.setInputAttribute('disabled', a ? !0 : null)
    }
});
Ext.define(null, {
    override: 'Ext.field.Container',
    onFieldErrorChange: function (c) {
        var e = this,
            f = e.getErrors(),
            h = e.getFields(),
            d, a, g, b;
        for (d in f) {
            c = h[d];
            a = f[d];
            if (a) {
                g = c.getLabel() || c.desc || c.getPlaceholder() || c.getName();
                a = Ext.Array.from(a).map(function (a) {
                    return {
                        label: g,
                        error: a
                    }
                });
                if (b) {
                    b = b.concat(a)
                } else {
                    b = a
                }
            }
        }
        e.setError(b || null)
    }
});
Ext.define(null, {
    override: 'Ext.field.Display',
    config: {
        userSelectable: 'text'
    }
});
Ext.define(null, {
    override: 'Ext.field.Field',
    config: {
        bodyWidth: null
    },
    applyBodyWidth: function (a) {
        if (this.getWidth() !== null) {
            Ext.raise('bodyWidth 和 width 不能同时设置');
            return null
        }
        return this.filterLengthValue(a)
    },
    updateBodyWidth: function (a) {
        var b = this;
        b.bodyWrapElement.setWidth(a)
    }
});
Ext.define(null, {
    override: 'Ext.field.Manager',
    updateReadOnly: function (a) {
        this.getFields(!1).forEach(function (b) {
            if (!b.isXType('displayfield')) {
                if (b.setReadOnly) {
                    b.setReadOnly(a)
                } else {
                    b.setDisabled(a)
                }
            }
        });
        return this
    }
});
Ext.define(null, {
    override: 'Ext.field.Panel',
    config: {
        readOnly: null
    },
    updateReadOnly: function (b, a) {
        this.mixins.fieldmanager.updateReadOnly.call(this, b, a)
    }
});
Ext.define(null, {
    override: 'Ext.field.Select',
    config: {
        clearable: !0,
        nameCtrl: null
    },
    updateDisplayField: function (b) {
        this.callParent(arguments);
        if (this.config.itemTpl === !1) {
            var a = '<span class="x-list-label">{' + b + ':htmlEncode}</span>';
            this.setItemTpl(a);
            if (this.pickerType == 'floated' && this._picker) {
                this._picker.setItemTpl(a)
            }
        }
    },
    applyNameCtrl: function (a) {
        if (a) {
            if (a === !0) {
                a = {}
            } else {
                if (Ext.isString(a)) {
                    a = {
                        name: a
                    }
                }
            }
            return Ext.factory(a, 'MX.field.Hidden', this._nameCtrl)
        }
        return null
    },
    updateNameCtrl: function (a, c) {
        var b = this;
        var d = b.getParent();
        if (c) {
            Ext.destroy(c)
        }
        if (a && d) {
            d.add(a);
            b.on({
                change: function (d) {
                    var b = d.getSelection();
                    if (b) {
                        a.setValue(b.get(d.getDisplayField()))
                    }
                },
                scope: b
            })
        }
    }
});
Ext.define(null, {
    override: 'Ext.field.Slider',
    requires: ['Ext.tip.ToolTip'],
    useTips: !1,
    tipFormat: null,
    config: {
        showValueInBoxLabel: !1,
        boxLabelFormat: null
    },
    initialize: function () {
        var a = this;
        a.callParent(arguments);
        a.getSlider().on({
            scope: this,
            drag: 'onSliderDrag2',
            dragstart: 'onSliderDragStart2',
            dragend: 'onSliderDragEnd2'
        })
    },
    getTipText: function (b) {
        var a = this;
        if (a.tipFormat) {
            return a.tipFormat.call(a, a, b)
        }
        return b
    },
    getTipInstance: function () {
        var b = Utils.getApp().getQuickTips();
        if (b) {
            return b.tip
        }
        var a = Ext.getCmp('global-tooltip');
        if (!a) {
            a = Ext.widget('tooltip', {
                id: 'global-tooltip'
            })
        }
        return a
    },
    onSliderDragStart2: function (e, d, c, f) {
        var a = this;
        if (a.useTips) {
            var b = a.getTipInstance();
            b.setHtml(a.getTipText(c));
            b.showBy(d, 'b-t')
        }
    },
    onSliderDrag2: function (e, d, b, f) {
        var a = this;
        if (a.useTips) {
            var c = a.getTipInstance();
            c.setHtml(a.getTipText(b));
            c.showBy(d, 'b-t')
        }
        if (a.getShowValueInBoxLabel()) {
            a.setBoxLabel(a.getBoxLabelText(b))
        }
    },
    onSliderDragEnd2: function (b, c, d, e) {
        var a = this;
        if (a.useTips) {
            a.getTipInstance().hide()
        }
    },
    getBoxLabelText: function (c) {
        var a = this,
            b = a.getBoxLabelFormat();
        if (b) {
            return b.call(a, a, c)
        }
        return c
    },
    updateValue: function (b, c) {
        var a = this;
        a.callParent(arguments);
        if (a.useTips) {
            if (a.sliderTip) {
                a.sliderTip.setHtml(a.getTipText(b))
            }
        }
        if (a.getShowValueInBoxLabel()) {
            a.setBoxLabel(a.getBoxLabelText(b))
        }
    },
    updateShowValueInBoxLabel: function (b) {
        var a = this;
        if (b) {
            a.setBoxLabel(a.getBoxLabelText(a.getValue()))
        } else {
            a.setBoxLabel(null)
        }
    }
});
Ext.define(null, {
    override: 'Ext.grid.Grid',
    platformConfig: {
        desktop: {
            userSelectable: 'text'
        }
    },
    privates: {
        updateHideHeaders: function (c) {
            var a = this;
            a.callParent(arguments);
            if (a.isRendered) {
                var b = a.getHeaderContainer();
                b.el.setStyle({
                    opacity: c ? 0 : null
                })
            }
        }
    }
});
Ext.define(null, {
    override: 'Ext.grid.PagingToolbar',
    config: {
        sliderField: {
            xtype: 'singlesliderfield',
            liveUpdate: !1,
            useTips: !0,
            value: 1,
            flex: 1,
            minValue: 1
        }
    }
});
Ext.define(null, {
    override: 'Ext.grid.SummaryRow',
    privates: {
        createCell: function (b) {
            var a = b.createCell(this);
            delete a.tools;
            a = Ext.create(a);
            delete a.$initParent;
            if (a.inheritUi) {
                a.doInheritUi()
            }
            a.el.setTabIndex(-1);
            return a
        }
    }
});
Ext.define(null, {
    override: 'Ext.grid.cell.Text',
    config: {
        encodeHtml: !1
    }
});
Ext.define(null, {
    override: 'Ext.grid.plugin.PagingToolbar',
    onPageSliderDrag: function (b, a, c) {
        this.isDragging = !0
    },
    destroy: function () {
        var a = this.getToolbar();
        this.callParent(arguments);
        Ext.destroy(a)
    }
});
Ext.define(null, {
    override: 'Ext.grid.plugin.Summary',
    destroy: function () {
        var a = this._row;
        this.callParent(arguments);
        Ext.destroy(a)
    }
});
Ext.oldGetResourcePath = Ext.getResourcePath;
Ext.getResourcePath = function (c, f, b) {
    if (Ext.manifest.watch) {
        return Ext.oldGetResourcePath.apply(Ext, arguments)
    }
    if (typeof c !== 'string') {
        f = c.pool;
        b = c.packageName;
        c = c.path
    }
    var e = Ext.manifest,
        h = e && e.resources,
        a = h[f],
        d = [];
    if (a == null) {
        a = h.path;
        if (a == null) {
            a = 'resources'
        }
    }
    if (a) {
        var g = Ext.manifest.profile;
        if (g && b && Ext.manifest.packages[b] && !Ext.manifest.packages[b].required && Ext.String.endsWith(a, 'resources')) {
            a = a.substr(0, a.length - 9) + g + '/resources'
        }
        d.push(a)
    }
    if (b) {
        d.push(b)
    }
    d.push(c);
    return d.join('/')
};
Ext.define(null, {
    override: 'Ext.menu.Item',
    config: {
        href: 'javascript:void(0);'
    }
});
Ext.define(null, {
    override: 'Ext.route.Route',
    execute: function (a, b) {
        var d = this,
            c = this.callParent([a, b]);
        return c.then(function (c) {
            Ext.fireEvent('afterroute', d, a);
            return c
        })['catch'](Ext.bind(this.onRouteReject, this))
    },
    onRouteReject: function (a) {
        Ext.fireEvent('routereject', this);
        if (a instanceof Error) {
            console.error(a)
        }
    },
    removeHandler: function (e, d) {
        var a = this;
        a.callParent(arguments);
        var b = a.getHandlers();
        if (b && !b.length) {
            var c = a.getName() || a.getUrl();
            delete Ext.route.Router.routes[c]
        }
        return a
    }
});
Ext.define(null, {
    override: 'Ext.slider.Thumb',
    onBeforeDragStart: function (d, c, b) {
        if (this.isDisabled()) {
            return !1
        }
        var a = c.proxy.current;
        return this.getSlider().onThumbBeforeDragStart(this, b, a.x, a.y)
    }
});
Ext.define(null, {
    override: 'Ext.tab.Panel',
    config: {
        layout: {
            type: 'card',
            animation: !1
        }
    }
});
Ext.cmd.derive('MX.BDMap', Ext.Dialog, {
    fullscreen: !0,
    closeAction: 'destroy',
    title: '定位',
    defaultListenerScope: !0,
    closable: !0,
    config: {
        latitude: null,
        longitude: null,
        address: null
    },
    listeners: {
        initialize: 'showView'
    },
    showView: function () {
        var a = this;
        var c = a.innerElement.dom,
            b = a.getAddress();
        Utils.ensureBaiduMapLib('4di0zf1SqG9GqpZTZY4YgvIn').then(function () {
            a.paintMap()
        })
    },
    paintMap: function () {
        var a = this;
        var h = a.innerElement.dom,
            j = a.getLongitude(),
            i = a.getLatitude(),
            f = a.getAddress();
        var c = new BMap.Map(h);
        var b = new BMap.Point(j, i);
        var d = new BMap.Marker(b);
        c.addOverlay(d);
        c.centerAndZoom(b, 15);
        var g = {
            title: '地址:'
        };
        var e = new BMap.InfoWindow(f, g);
        d.addEventListener('click', function () {
            c.openInfoWindow(e, b)
        })
    }
}, 0, ['baidumap'], ['widget', 'component', 'container', 'panel', 'dialog', 'window', 'baidumap'], {
    'widget': !0,
    'component': !0,
    'container': !0,
    'panel': !0,
    'dialog': !0,
    'window': !0,
    'baidumap': !0
}, ['widget.baidumap'], 0, [MX, 'BDMap'], 0);
Ext.cmd.derive('MX.FABButton', Ext.Button, {
    classCls: 'fab-button',
    bottom: 24,
    right: 24,
    width: 52,
    height: 52,
    focusable: !1,
    draggable: {
        constrain: {
            element: !0
        }
    },
    circularProgressCls: 'circular-progress circular-fabprogress',
    initialize: function () {
        var a = this;
        Ext.Button.prototype.initialize.apply(this, arguments);
        a.addCls('not-backable');
        var b = a.getDraggable();
        if (b) {
            b.on({
                dragstart: 'onDragStart',
                scope: a
            })
        }
    },
    onDragStart: function (b, c, a) {
        a.stopPropagation()
    }
}, 0, ['fabbutton'], ['widget', 'component', 'button', 'fabbutton'], {
    'widget': !0,
    'component': !0,
    'button': !0,
    'fabbutton': !0
}, ['widget.fabbutton'], 0, [MX, 'FABButton'], 0);
Ext.cmd.derive('MX.fab.Container', Ext.Container, {
    classCls: 'fab-container',
    layout: {
        type: 'vbox',
        align: 'center'
    },
    right: 24,
    focusable: !1,
    draggable: {
        constrain: {
            element: !0
        }
    },
    defaults: {
        xtype: 'fabbutton',
        bottom: null,
        right: null,
        draggable: null
    }
}, 0, ['fabcontainer'], ['widget', 'component', 'container', 'fabcontainer'], {
    'widget': !0,
    'component': !0,
    'container': !0,
    'fabcontainer': !0
}, ['widget.fabcontainer'], 0, [MX.fab, 'Container'], 0);
Ext.cmd.derive('MX.HeadsUp', Ext.Sheet, {
    baseCls: 'x-headsup',
    config: {
        enter: 'top',
        exit: 'top',
        centered: !1,
        showAnimation: {
            type: 'slideIn',
            duration: 250,
            easing: 'ease-out'
        },
        hideAnimation: {
            type: 'slideOut',
            duration: 250,
            easing: 'ease-in'
        },
        tpl: '            <div class="x-layout-box x-horizontal x-align-center">                <div class="flex10 ellipsis title">{title}</div>                <div class="time">{time:date("g:i a")}</div>            </div>            <div class="ellipsis message">{message}</div>        ',
        timeout: 5000,
        modal: null,
        layout: {
            type: 'vbox',
            pack: 'center'
        }
    },
    initialize: function () {
        var a = this;
        Ext.Sheet.prototype.initialize.apply(this, arguments);
        a.on({
            show: 'onShow',
            hide: 'onHide',
            scope: a
        });
        a.element.on({
            tap: 'onTap',
            scope: a
        });
        var c = {
            dragend: function (b, a, f) {
                var e = b.getProxy();
                if (Math.abs(a.element.delta.x) > this._elWidth * 0.4 || f.flick.velocity.x >= 0.7) {
                    var c;
                    if (a.element.delta.x > 0) {
                        c = this._elWidth
                    }
                    if (a.element.delta.x < 0) {
                        c = -this._elWidth
                    }
                    var d = e.getPositionable(a);
                    d.setXY([c, 0], Ext.apply({
                        callback: function () {
                            b.dragCleanup(a)
                        }
                    }, !0))
                } else {
                    if (-a.element.delta.y > this._elHeight * 0.5 || f.flick.velocity.y >= 0.7) {
                        var g = -this._elHeight;
                        d.setXY([0, g], Ext.apply({
                            callback: function () {
                                b.dragCleanup(a)
                            }
                        }, !0))
                    } else {
                        e.dragRevert(a, b.revertCls, !0, function () {
                            b.dragCleanup(a)
                        })
                    }
                }
            },
            dragstart: function (c, e, a) {
                var d = this.element.getSize();
                this._elWidth = d.width;
                this._elHeight = d.height;
                var b = c.getConstrain().constrainInfo;
                if (a.absDeltaX > 0 && a.absDeltaX > a.absDeltaY) {
                    c.isDragging = !0;
                    b.x = [null, null];
                    b.y = [0, 0]
                } else {
                    if (a.absDeltaY > 0 && a.absDeltaY > a.absDeltaX) {
                        c.isDragging = !0;
                        b.x = [0, 0];
                        b.y = [null, 0]
                    } else {
                        c.isDragging = !1
                    }
                }
            },
            dragmove: function (b, c, a) {
                this.changeOpacity(a.absDeltaX, a.absDeltaY)
            },
            scope: a
        };
        var b = {
            animationframe: function (c, a, b) {
                this.changeOpacity(Math.abs(a), Math.abs(b))
            },
            animationend: function (c, a, b) {
                if (Math.abs(a) > 0 || Math.abs(b) > 0) {
                    this.hide(!1)
                } else {
                    this.element.setStyle('opacity', 1)
                }
            },
            scope: a
        };
        a.setDraggable({
            constrain: {
                x: [null, null],
                y: [null, 0]
            },
            listeners: c
        });
        a.getTranslatable().on(b)
    },
    changeOpacity: function (b, c) {
        var a;
        if (b > c) {
            a = Math.max(1 - b / this._elWidth * 0.4, 0)
        } else {
            a = Math.max(1 - c / this._elHeight * 0.5, 0)
        }
        this.element.setStyle('opacity', a)
    },
    applyTimeout: function (a) {
        if (this._timeoutID) {
            clearTimeout(this._timeoutID);
            if (!Ext.isEmpty(a)) {
                this._timeoutID = setTimeout(Ext.bind(this.onTimeout, this), a)
            }
        }
        return a
    },
    onShow: function () {
        var a = this,
            b = a.getTimeout();
        if (a._timeoutID) {
            clearTimeout(a._timeoutID)
        }
        if (!Ext.isEmpty(b)) {
            a._timeoutID = setTimeout(Ext.bind(a.onTimeout, a), b)
        }
    },
    onHide: function () {
        clearTimeout(this._timeoutID);
        this.destroy()
    },
    onTimeout: function () {
        this.hide()
    },
    onTap: function () {
        this.fireEvent('tap', this);
        this.hide()
    }
}, 0, 0, ['widget', 'component', 'container', 'panel', 'sheet'], {
    'widget': !0,
    'component': !0,
    'container': !0,
    'panel': !0,
    'sheet': !0
}, 0, 0, [MX, 'HeadsUp'], function (b) {
    var a = 999;
    MX.headsUp = function (f, d) {
        if (d === undefined) {
            d = MX.HeadsUp.prototype.config.timeout
        }
        var c = Ext.create('MX.HeadsUp', {
            data: f,
            timeout: d,
            width: Math.min(window.innerHeight, window.innerWidth) - 10,
            zIndex: a++
        });
        Ext.Viewport.add(c);
        var e = '$centerWrapper';
        c.link(e, new Ext.util.Wrapper({
            className: 'x-topcenter'
        }, c.element));
        c.show();
        return c
    }
});
Ext.cmd.derive('MX.ImgViewer', Ext.Container, {
    config: {
        imgName: null,
        saveDir: '',
        src: !1,
        originNodeId: null,
        doubleTapScale: 1,
        maxScale: 2,
        previewSrc: !1,
        resizeOnLoad: !0,
        imgSize: 0,
        hideOnTap: !1,
        centered: !0,
        top: 0,
        left: 0,
        right: 0,
        bottom: 0,
        stretchX: !0,
        stretchY: !0,
        cls: 'imgviewer',
        style: 'background-color:#000',
        scrollable: 'both',
        html: ['<div class="radial-progress x-hidden">', '<div class="mask full">', '<div class="fill"></div>', '</div>', '<div class="mask half">', '<div class="fill"></div>', '</div>', '</div>', '<div class="tip-wrapper x-layout-box x-align-center x-pack-center">', '<div class="tip x-hidden"></div>', '</div>', '<figure>', '<img>', '</figure>'].join('')
    },
    destroyOnHide: !0,
    translateX: 0,
    translateY: 0,
    firstload: !0,
    applySaveDir: function (a) {
        if (Ext.isEmpty(a)) {
            a = 'images/'
        }
        return a
    },
    initialize: function () {
        var a = this;
        a.on({
            painted: 'initViewer',
            scope: a,
            delay: 10,
            single: !0
        });
        a.element.on({
            singletap: 'tapImg',
            scope: a
        })
    },
    tapImg: function (d, a) {
        var c = this;
        if (Ext.fly(a).hasCls('down')) {
            var b = this.imgEl.dom.src;
            if (!Ext.isEmpty(b)) {
                this.saveType = 'save';
                if (window.plugins && plugins.wizUtils) {
                    plugins.wizUtils.saveToAlbum(function () {
                        Utils.toastShort('成功保存到相册')
                    }, function (b) {
                        Utils.toastShort('保存失败: ' + b)
                    }, b)
                }
            } else {
                this.saveType = 'downsave';
                this.loadImage(c.getSrc())
            }
        } else {
            if (Ext.fly(a).hasCls('exists')) {
                this.loadImage(c.getSrc())
            } else {
                if (this.getHideOnTap()) {
                    this.hide()
                }
            }
        }
    },
    initViewer: function () {
        var a = this,
            e = a.getScrollable(),
            c = a.element;
        a.btnDown = Ext.Element.create({
            cls: 'down',
            hidden: !1
        });
        a.referenceList.push('btnDown');
        a.element.appendChild(a.btnDown);
        var d = ParseUtil.bytesToSize(a.getImgSize());
        a.btnExists = Ext.Element.create({
            cls: 'exists',
            html: '查看原图(' + d + ')',
            hidden: !0
        });
        a.referenceList.push('btnExists');
        a.element.appendChild(a.btnExists);
        a.figEl = c.down('figure');
        a.imgEl = a.figEl.down('img');
        a.figEl.setStyle({
            overflow: 'hidden',
            display: 'block',
            margin: 0
        });
        a.imgEl.setStyle({
            '-webkit-user-drag': 'none',
            'visibility': 'hidden'
        });
        a.setOrigin(0, 0);
        a.imgEl.on({
            scope: a,
            doubletap: a.onDoubleTap
        });
        a.el.on({
            scope: a,
            pinchstart: a.onImagePinchStart,
            pinch: a.onImagePinch,
            pinchend: a.onImagePinchEnd
        });
        if (Ext.browser.is.Cordova) {
            var b = a.getSaveDir() + a.getImgName();
            FileMgr.exists(1, b).then(function (c) {
                if (c) {
                    if (Ext.os.is.iOS) {
                        FileMgr.exists(0, b).then(function (d) {
                            if (d) {
                                a.getImage(d.toURL())
                            } else {
                                FileMgr.copyTo(1, b, 0, b).then(function (b) {
                                    a.getImage(b)
                                })
                            }
                        })
                    } else {
                        a.getImage(c.toURL())
                    }
                } else {
                    if (!a.getPreviewSrc()) {
                        a.loadImage(a.getSrc())
                    } else {
                        if (a.getImgSize() < 102400) {
                            a.loadImage(a.getSrc())
                        } else {
                            a.btnExists.show();
                            a.showPreview(a.getPreviewSrc())
                        }
                    }
                }
            });
            a.btnDown.show()
        } else {
            if (a.getSrc()) {
                a.loadImage(a.getSrc())
            }
        }
    },
    loadImage: function (b, j) {
        var a = this;
        if (a.imgEl) {
            var f = a.btnDown,
                e = a.btnExists,
                c = a.element.down('.radial-progress'),
                i = a.element.down('.tip'),
                g = c.down('div.mask.full'),
                h = c.select('div.fill'),
                d = a.getImgName();
            i.addCls('x-hidden');
            f.hide();
            e.hide();
            if (Ext.browser.is.Cordova && Ext.isString(b) && /^https?:\/\/.*/.test(b) && !Ext.isEmpty(d)) {
                c.removeCls('x-hidden');
                FileMgr.downFileForSrc(b, 1, a.getSaveDir() + d, {
                    downloading: function (d) {
                        var a = (d * 1.8).toFixed(2) + 'deg',
                            c = {
                                '-webkit-transform': 'rotate(' + a + ')',
                                '-ms-transform': 'rotate(' + a + ')',
                                'transform': 'rotate(' + a + ')'
                            };
                        g.setStyle(c);
                        h.setStyle(c)
                    }
                }).then(function (d) {
                    a.getImage(d.path);
                    c.addCls('x-hidden')
                })['catch'](function (d) {
                    c.addCls('x-hidden');
                    a.onImageError(d)
                })
            } else {
                a.getImage(b)
            }
        } else {
            a.setSrc(b)
        }
    },
    getImage: function (a) {
        var b = function (c) {
            var b = this.imgEl.dom;
            b.src = c;
            b.onload = Ext.bind(this.onImageLoad, this);
            b.onerror = Ext.bind(this.onImageError, this);
            var d = this.getOriginNodeId();
            ImgMgr.loadAutomatic(d)
        };
        if (toString.call(a) === '[object File]') {
            ImgUtil.getImageDataURL(a, -1, b, this)
        } else {
            b.call(this, a)
        }
    },
    showPreview: function (a) {
        var b = function (c) {
            var b = this.imgEl.dom;
            b.src = c;
            b.onload = Ext.bind(this.getPreviewAttr, this);
            b.onerror = Ext.bind(this.onImageError, this)
        };
        b.call(this, a)
    },
    getPreviewAttr: function () {
        var a = this;
        a.viewportWidth = a.el.dom.clientWidth;
        a.viewportHeight = a.el.dom.clientHeight;
        a.imgWidth = a.imgEl.dom.width;
        a.imgHeight = a.imgEl.dom.height;
        if (a.getResizeOnLoad()) {
            a.scale = a.baseScale = Math.min(a.viewportWidth / a.imgWidth, a.viewportHeight / a.imgHeight);
            a.setMaxScale(a.scale * 2)
        } else {
            a.scale = a.baseScale = 1
        }
        var b = (a.viewportWidth - a.baseScale * a.imgWidth) / 2,
            c = (a.viewportHeight - a.baseScale * a.imgHeight) / 2;
        a.setTranslation(b, c);
        a.translateBaseX = a.translateX;
        a.translateBaseY = a.translateY;
        a.applyTransform();
        a.adjustScroller();
        a.imgEl.setStyle({
            visibility: 'visible'
        });
        a.element.setStyle({
            backgroundImage: 'none'
        });
        a.getScrollable().refresh()
    },
    onImageLoad: function () {
        var a = this;
        if (!a.parent) {
            return
        }
        var d = a.parent.element;
        a.viewportWidth = a.el.dom.clientWidth;
        a.viewportHeight = a.el.dom.clientHeight;
        a.imgWidth = a.imgEl.dom.width;
        a.imgHeight = a.imgEl.dom.height;
        if (a.getResizeOnLoad()) {
            a.scale = a.baseScale = Math.min(a.viewportWidth / a.imgWidth, a.viewportHeight / a.imgHeight);
            a.setMaxScale(a.scale * 2)
        } else {
            a.scale = a.baseScale = 1
        }
        var b = (a.viewportWidth - a.baseScale * a.imgWidth) / 2,
            c = (a.viewportHeight - a.baseScale * a.imgHeight) / 2;
        a.setTranslation(b, c);
        a.translateBaseX = a.translateX;
        a.translateBaseY = a.translateY;
        a.applyTransform();
        a.adjustScroller();
        a.imgEl.setStyle({
            visibility: 'visible'
        });
        if (a.getPreviewSrc()) {
            a.element.setStyle({
                backgroundImage: 'none'
            })
        }
        a.fireEvent('imageLoaded', a);
        if (Ext.browser.is.Cordova) {
            a.btnDown.show();
            a.btnExists.hide();
            if (a.saveType == 'downsave') {
                if (window.plugins && plugins.wizUtils) {
                    plugins.wizUtils.saveToAlbum(function () {
                        Utils.toastShort('成功保存到相册')
                    }, function (a) {
                        Utils.toastShort('保存失败: ' + a)
                    }, a.imgEl.dom.src)
                }
            }
        }
        a.getScrollable().refresh();
        a.firstload = !1
    },
    onImageError: function () {
        var a = this.element.down('.tip');
        a.removeCls('x-hidden');
        a.setHtml('出错了')
    },
    onImagePinchStart: function (g) {
        var a = this,
            f = a.getScrollable(),
            e = f.position,
            d = g.touches,
            c = a.element,
            b = a.scale;
        a.startScale = b;
        if (a.startScale > a.baseScale) {
            a.originViewportX = (d[0].pageX + d[1].pageX) / 2 - c.getX();
            a.originViewportY = (d[0].pageY + d[1].pageY) / 2 - c.getY()
        } else {
            a.originViewportX = Math.round(c.dom.clientWidth / 2);
            a.originViewportY = Math.round(c.dom.clientHeight / 2)
        }
        a.originScaledImgX = a.originViewportX + e.x - a.translateX;
        a.originScaledImgY = a.originViewportY + e.y - a.translateY;
        a.originFullImgX = a.originScaledImgX / b;
        a.originFullImgY = a.originScaledImgY / b;
        a.translateX += -1 * (a.imgWidth * (1 - b) * (a.originFullImgX / a.imgWidth));
        a.translateY += -1 * (a.imgHeight * (1 - b) * (a.originFullImgY / a.imgHeight));
        a.setOrigin(a.originFullImgX, a.originFullImgY);
        a.applyTransform()
    },
    onImagePinch: function (b) {
        var a = this;
        a.scale = Ext.Number.constrain(b.scale * a.startScale, a.baseScale - 2, a.getMaxScale());
        a.applyTransform()
    },
    onImagePinchEnd: function (b) {
        var a = this;
        if (a.scale == a.baseScale) {
            a.setTranslation(a.translateBaseX, a.translateBaseY)
        } else {
            if (a.scale < a.baseScale && a.getResizeOnLoad()) {
                a.resetZoom();
                return
            }
            a.originReScaledImgX = a.originScaledImgX * (a.scale / a.startScale);
            a.originReScaledImgY = a.originScaledImgY * (a.scale / a.startScale);
            a.setTranslation(a.originViewportX - a.originReScaledImgX, a.originViewportY - a.originReScaledImgY)
        }
        a.setOrigin(0, 0);
        a.applyTransform();
        a.adjustScroller()
    },
    onDoubleTap: function (b, n) {
        var a = this,
            m = a.getScrollable(),
            f = m.position,
            h = a.element;
        if (!a.getDoubleTapScale()) {
            return !1
        }
        if (a.scale > a.baseScale) {
            a.scale = a.baseScale;
            a.setTranslation(a.translateBaseX, a.translateBaseY);
            a.applyTransform();
            a.adjustScroller()
        } else {
            var g = a.scale,
                c = a.baseScale * 2,
                d = b ? b.pageX - h.getX() : 0,
                e = b ? b.pageY - h.getY() : 0,
                k = d + f.x - a.translateX,
                l = e + f.y - a.translateY,
                i = k * (c / g),
                j = l * (c / g);
            a.scale = c;
            setTimeout(function () {
                a.setTranslation(d - i, e - j);
                a.applyTransform();
                a.adjustScroller()
            }, 50)
        }
    },
    setOrigin: function (c, d) {
        var a = this.imgEl.dom,
            b = c + 'px ' + d + 'px';
        a.style.webkitTransformOrigin = b;
        a.style.transformOrigin = b
    },
    setTranslation: function (b, c) {
        var a = this;
        a.translateX = b;
        a.translateY = c;
        a.scrollX = a.scrollY = 0;
        if (a.translateX < 0) {
            a.scrollX = a.translateX;
            a.translateX = 0
        }
        if (a.translateY < 0) {
            a.scrollY = a.translateY;
            a.translateY = 0
        }
    },
    resetZoom: function () {
        var a = this;
        if (a.isDestroying || a.isDestroyed) {
            return
        }
        a.scale = a.baseScale;
        a.setTranslation(a.translateBaseX, a.translateBaseY);
        a.setOrigin(0, 0);
        a.applyTransform();
        a.adjustScroller()
    },
    applyTransform: function () {
        var b = this,
            f = b.imgEl.dom,
            d = Ext.Number.toFixed(b.translateX, 1),
            e = Ext.Number.toFixed(b.translateY, 1),
            a = Ext.Number.toFixed(b.scale, 2),
            c;
        if (Ext.os.is.Android) {
            c = 'matrix(' + a + ',0,0,' + a + ',' + d + ',' + e + ')'
        } else {
            c = 'translate(' + d + 'px, ' + e + 'px) scale(' + a + ',' + a + ')'
        }
        f.style.webkitTransform = c;
        f.style.transform = c
    },
    adjustScroller: function () {
        var a = this,
            b = a.getScrollable(),
            c = a.scale;
        var g = Math.max(a.imgWidth * c + 2 * a.translateX, a.viewportWidth),
            f = Math.max(a.imgHeight * c + 2 * a.translateY, a.viewportHeight);
        a.figEl.setStyle({
            width: g + 'px',
            height: f + 'px'
        });
        b.refresh();
        var d = 0,
            e = 0;
        if (a.scrollX) {
            d = a.scrollX
        }
        if (a.scrollY) {
            e = a.scrollY
        }
        b.scrollTo(d * -1, e * -1)
    },
    hide: function () {
        this.destroy()
    }
}, 0, ['imgviewer'], ['widget', 'component', 'container', 'imgviewer'], {
    'widget': !0,
    'component': !0,
    'container': !0,
    'imgviewer': !0
}, ['widget.imgviewer'], 0, [MX, 'ImgViewer'], 0);
Ext.cmd.derive('MX.ImageCarouselViewerItem', MX.ImgViewer, {
    hideOnTap: !1,
    centered: null,
    top: null,
    left: null,
    right: null,
    bottom: null,
    initialize: function () {
        var a = this;
        MX.ImgViewer.prototype.initialize.apply(this, arguments)
    }
}, 0, ['imgcarouselvieweritem'], ['widget', 'component', 'container', 'imgviewer', 'imgcarouselvieweritem'], {
    'widget': !0,
    'component': !0,
    'container': !0,
    'imgviewer': !0,
    'imgcarouselvieweritem': !0
}, ['widget.imgcarouselvieweritem'], 0, [MX, 'ImageCarouselViewerItem'], 0);
Ext.cmd.derive('MX.ImageCarouselViewer', Ext.carousel.Carousel, {
    indicator: !1,
    config: {
        images: {
            lazy: !0,
            $value: null
        },
        hideOnTap: !0,
        centered: !0,
        top: 0,
        left: 0,
        right: 0,
        bottom: 0,
        defaultType: 'imgcarouselvieweritem'
    },
    destroyOnHide: !0,
    updateImages: function (d, g) {
        var a = this;
        var e = a.initialActiveIdx || 0;
        a.itemIdx = 0;
        if (d.length < 3) {
            for (var b = 0; b < d.length; b++) {
                var c = Ext.widget('imgcarouselvieweritem', d[b]);
                a.add(c)
            }
            a.itemIdx = e
        } else {
            if (e == 0) {
                for (var b = 0; b < 3; b++) {
                    var c = Ext.widget('imgcarouselvieweritem', d[b]);
                    a.add(c)
                }
                a.itemIdx = 0
            } else {
                if (e == d.length - 1) {
                    for (var b = 2; b >= 0; b--) {
                        var f = d[e - b],
                            c = Ext.widget('imgcarouselvieweritem', f);
                        a.add(c)
                    }
                    a.itemIdx = 2
                } else {
                    for (var b = 0; b < 3; b++) {
                        var f = d[e - 1 + b],
                            c = Ext.widget('imgcarouselvieweritem', f);
                        a.add(c)
                    }
                    a.itemIdx = 1
                }
            }
        }
        if (a.getInnerItemAt(e) === a.getActiveItem()) {
            a.refreshActiveItem()
        } else {
            a.setActiveItem(a.itemIdx)
        }
    },
    initialize: function () {
        var a = this;
        a.addCls('imgcarouselviewer');
        Ext.carousel.Carousel.prototype.initialize.apply(this, arguments);
        a.on({
            itemindexchange: 'onItemIndexChange',
            activeItemchange: 'onItemChange',
            scope: a
        });
        a.element.on({
            singletap: 'onTapMe',
            scope: a
        });
        StatusBar.hide();
        a.getImages();
        if (Ext.browser.is.Cordova && Ext.os.is.ios) {
            var b = Ext.bind(a.onResize, a);
            window.addEventListener('orientationchange', b);
            a.on({
                destroy: function () {
                    window.removeEventListener('orientationchange', b)
                },
                scope: a
            })
        }
    },
    onResize: function () {},
    onItemChange: function (a, e, f) {
        var b = a.activeIndex,
            c = a.getImages();
        if (this.doHide) {
            return
        }
        if (c.length <= 3) {
            return
        }
        if (a.itemIdx == b - 1) {
            a.itemIdx = b;
            a.initialActiveIdx = a.initialActiveIdx + 1;
            if (a.initialActiveIdx < c.length - 1 && b != 1) {
                var d = Ext.widget('imgcarouselvieweritem', c[a.initialActiveIdx + 1]);
                a.add(d);
                a.innerItems.shift();
                a.itemIdx = 1;
                a.refreshActiveIndex();
                a.refreshCarouselItems();
                a.refreshInactiveCarouselItems()
            }
        } else {
            if (a.itemIdx == b + 1) {
                a.itemIdx = b;
                a.initialActiveIdx = a.initialActiveIdx - 1;
                if (a.initialActiveIdx > 0 && b != 1) {
                    var d = Ext.widget('imgcarouselvieweritem', c[a.initialActiveIdx - 1]);
                    a.insertBefore(d, e);
                    a.innerItems.pop();
                    a.itemIdx = 1;
                    a.refreshActiveIndex();
                    a.refreshCarouselItems();
                    a.refreshInactiveCarouselItems()
                }
            }
        }
    },
    onDrag: function (h) {
        var g = this;
        var e = g.getActiveItem();
        var c = g.getDirection();
        var a = c == 'horizontal' ? 'x' : 'y';
        if (e) {
            var b = e.getScrollable();
            if (b['get' + a.toUpperCase()]()) {
                var f = b.getPosition();
                var i = b.getMaxPosition();
                var d = c === 'horizontal' ? h.deltaX : h.deltaY;
                if ((f[a] > 0 || d <= 0) && (f[a] < i[a] || d >= 0)) {
                    return
                }
            }
        }
        Ext.carousel.Carousel.prototype.onDrag.apply(this, arguments)
    },
    onItemIndexChange: function (d, c, b) {
        var a = d.getImages();
        if (Ext.isArray(a) && a.length > b) {
            c.setConfig(a[b])
        }
    },
    onTapMe: function (b, a) {
        if (this.getHideOnTap() && !Ext.fly(a).hasCls('down') && !Ext.fly(a).hasCls('exists')) {
            this.onBack()
        }
    },
    onBack: function () {
        this.doHide = !0;
        StatusBar.show();
        this.hide()
    },
    destroy: function () {
        var a = this;
        a.un({
            itemindexchange: 'onItemIndexChange',
            scope: a
        });
        a.element.un({
            tap: 'onTapMe',
            scope: a
        });
        clearTimeout(a.delayHide);
        delete a.delayHide;
        Ext.carousel.Carousel.prototype.destroy.apply(this, arguments)
    }
}, 0, ['imgcarouselviewer'], ['widget', 'component', 'container', 'carousel', 'imgcarouselviewer'], {
    'widget': !0,
    'component': !0,
    'container': !0,
    'carousel': !0,
    'imgcarouselviewer': !0
}, ['widget.imgcarouselviewer'], 0, [MX, 'ImageCarouselViewer'], 0);
Ext.cmd.derive('MX.field.Checkbox', Ext.field.Checkbox, {
    isCheckbox: !1,
    defaultBindProperty: 'value',
    twoWayBindable: {
        checked: 1,
        value: 1
    },
    publishes: {
        checked: 1,
        value: 1
    },
    valueChecked: 'Y',
    valueUnChecked: 'N',
    config: {
        value: null
    },
    getSubmitValue: Ext.emptyFn,
    updateChecked: function (b, e) {
        var a = this,
            c;
        if (!a.$onChange) {
            a.inputElement.dom.checked = b
        }
        a.toggleCls(a.checkedCls, b);
        var d = b ? a.valueChecked : a.valueUnChecked,
            f = e ? a.valueChecked : a.valueUnChecked;
        a._value = d;
        if (a.initialized) {
            c = b ? 'check' : 'uncheck';
            a.fireEvent(c, a);
            a.fireEvent('change', a, d, f)
        }
    },
    applyValue: function (a) {
        if (a === this.valueChecked) {
            return a
        }
        return this.valueUnChecked
    },
    updateValue: function (c, d) {
        var a = this,
            b = c === a.valueChecked;
        a.setChecked(b)
    },
    getSameGroupFields: Ext.emptyFn,
    getGroupValues: Ext.emptyFn,
    setGroupValues: Ext.emptyFn,
    resetGroupValues: Ext.emptyFn
}, 0, ['mx_checkbox', 'mx_checkboxfield'], ['widget', 'component', 'field', 'inputfield', 'checkbox', 'checkboxfield', 'mx_checkbox', 'mx_checkboxfield'], {
    'widget': !0,
    'component': !0,
    'field': !0,
    'inputfield': !0,
    'checkbox': !0,
    'checkboxfield': !0,
    'mx_checkbox': !0,
    'mx_checkboxfield': !0
}, ['widget.mx_checkbox', 'widget.mx_checkboxfield'], 0, [MX.field, 'Checkbox'], 0);
Ext.cmd.derive('MX.field.Display', Ext.field.Field, {
    initialize: function () {
        Ext.field.Field.prototype.initialize.call(this);
        this.bodyElement.addCls('x-customfield')
    }
}, 0, ['customfield'], ['widget', 'component', 'field', 'customfield'], {
    'widget': !0,
    'component': !0,
    'field': !0,
    'customfield': !0
}, ['widget.customfield'], 0, [MX.field, 'Display'], 0);
Ext.cmd.derive('MX.field.CommonField', MX.field.Display, {
    config: {
        onDisclosure: !1,
        jump: null
    },
    updateValue: function (a) {
        var b = this.getFormatedValue(a);
        this.bodyElement.setHtml(b)
    },
    getFormatedValue: function (a) {
        return a
    },
    updateOnDisclosure: function (a) {
        if (a) {
            this.addCls('x-field-disclose')
        } else {
            this.removeCls('x-field-disclose')
        }
    },
    initialize: function () {
        MX.field.Display.prototype.initialize.call(this);
        this.addCls('x-field-display');
        var a = this.bodyElement;
        a.on({
            scope: this,
            tap: 'onFocus'
        })
    },
    onFieldDisclose: function () {
        var h = this;
        var c = this.getJump();
        if (!c) {
            return
        }
        var a;
        if (Ext.isEmpty(c.infoViewXtype)) {
            a = this.getParent()
        } else {
            a = this.up(c.infoViewXtype)
        }
        var b = a.getInfo ? a.getInfo() : a.getValues ? a.getValues() : a.info;
        if (!b) {
            return
        }
        if (b.isModel) {
            b = b.data
        }
        var d, g = c.keyMap;
        for (var f in g) {
            var e = b[g[f]];
            if (!Ext.isEmpty(e)) {
                if (!d) {
                    d = {}
                }
                d[f] = e
            }
        }
    },
    onFocus: function (a) {
        if (this.getDisabled() || !this.getOnDisclosure()) {
            return !1
        }
        this.fireEvent('disclose', this, a);
        this.onFieldDisclose();
        this.isFocused = !0
    }
}, 0, ['displayfield'], ['widget', 'component', 'field', 'customfield', 'displayfield'], {
    'widget': !0,
    'component': !0,
    'field': !0,
    'customfield': !0,
    'displayfield': !0
}, ['widget.displayfield'], 0, [MX.field, 'CommonField'], 0);
Ext.cmd.derive('MX.field.DisplayAttach', MX.field.Display, {
    config: {
        onDisclosure: !0,
        attachments: null
    },
    updateValue: function (a, b) {
        this.setAttachments(a)
    },
    applyAttachments: function (a) {
        return Utils.parseAttachXml(a)
    },
    updateAttachments: function (a, d) {
        var c = this;
        var b = '没有附件';
        if (a && a.length > 0) {
            b = Ext.String.format('{0}个附件', a.length);
            this.addCls('approve-process');
            this.bodyElement.on({
                scope: c,
                tap: 'onFocus'
            })
        }
        this.bodyElement.setHtml(b)
    },
    onFocus: function () {
        Utils.openAttachList(this.getAttachments(), this.getLabel())
    }
}, 0, ['displayattachfield'], ['widget', 'component', 'field', 'customfield', 'displayattachfield'], {
    'widget': !0,
    'component': !0,
    'field': !0,
    'customfield': !0,
    'displayattachfield': !0
}, ['widget.displayattachfield'], 0, [MX.field, 'DisplayAttach'], 0);
Ext.cmd.derive('MX.field.DisplayHtml', MX.field.Display, {
    config: {
        onDisclosure: !0
    },
    updateValue: function (b, c) {
        var a = '(无内容)';
        if (!Ext.isEmpty(b)) {
            a = '(有内容, 点击查看)'
        }
        this.bodyElement.setHtml(a)
    },
    onFieldDisclose: function () {
        var b = this,
            a = b.getValue();
        if (Ext.isEmpty(a)) {
            return
        }
        debugger
    }
}, 0, ['displayhtmlfield'], ['widget', 'component', 'field', 'customfield', 'displayhtmlfield'], {
    'widget': !0,
    'component': !0,
    'field': !0,
    'customfield': !0,
    'displayhtmlfield': !0
}, ['widget.displayhtmlfield'], 0, [MX.field, 'DisplayHtml'], 0);
Ext.cmd.derive('MX.field.DisplayExtend', MX.field.DisplayHtml, {
    config: {
        settings: null,
        content: null
    },
    applyValue: function (a) {
        return a
    },
    updateValue: function (a, b) {
        this.displayValue()
    },
    updateSettings: function (a, b) {
        this.displayValue()
    },
    displayValue: function () {
        var c = this.bodyElement,
            a = this.getValue(),
            d = this.getSettings();
        if (!Ext.isEmpty(a)) {
            c.setHtml(this.getFormatedValue(a))
        } else {
            var b = '(无内容)';
            if (!!d) {
                b = '(点击查看)'
            }
            c.setHtml(b)
        }
    },
    getFormatedValue: function (a) {
        return a
    },
    onFieldDisclose: function () {
        console.log('displayextendfield---onFieldDisclose')
    }
}, 0, ['displayextendfield'], ['widget', 'component', 'field', 'customfield', 'displayhtmlfield', 'displayextendfield'], {
    'widget': !0,
    'component': !0,
    'field': !0,
    'customfield': !0,
    'displayhtmlfield': !0,
    'displayextendfield': !0
}, ['widget.displayextendfield'], 0, [MX.field, 'DisplayExtend'], 0);
Ext.cmd.derive('MX.field.DisplayDateTimeField', MX.field.Display, {
    config: {
        type: 'date'
    },
    applyValue: function (b) {
        var a = this.getFormatedValue(b);
        this.bodyElement.setHtml(a)
    },
    getFormatedValue: function (a) {
        var b = this.getType();
        if (Ext.isEmpty(a)) {
            return ''
        }
        if (b == 'date') {
            return Ext.util.Format.date(a, Ext.util.Format.defaultDateFormat)
        }
        if (b == 'datetime') {
            return Ext.util.Format.date(a, Ext.util.Format.defaultDateFormat + ' H:i')
        }
        if (b == 'time') {
            return Utils.time2Str(a)
        }
    }
}, 0, ['displaydatetimefield'], ['widget', 'component', 'field', 'customfield', 'displaydatetimefield'], {
    'widget': !0,
    'component': !0,
    'field': !0,
    'customfield': !0,
    'displaydatetimefield': !0
}, ['widget.displaydatetimefield'], 0, [MX.field, 'DisplayDateTimeField'], 0);
Ext.cmd.derive('MX.field.DisplayExtendDateTime', MX.field.DisplayExtend, {
    config: {
        type: 'date'
    },
    getFormatedValue: function (a) {
        var b = this.getType();
        if (Ext.isEmpty(a)) {
            return ''
        }
        if (b == 'date') {
            return Ext.util.Format.date(a, Ext.util.Format.defaultDateFormat)
        }
        if (b == 'datetime') {
            return Ext.util.Format.date(a, Ext.util.Format.defaultDateFormat + ' H:i')
        }
        if (b == 'time') {
            return Utils.time2Str(a)
        }
    }
}, 0, ['displayexdatetimefield'], ['widget', 'component', 'field', 'customfield', 'displayhtmlfield', 'displayextendfield', 'displayexdatetimefield'], {
    'widget': !0,
    'component': !0,
    'field': !0,
    'customfield': !0,
    'displayhtmlfield': !0,
    'displayextendfield': !0,
    'displayexdatetimefield': !0
}, ['widget.displayexdatetimefield'], 0, [MX.field, 'DisplayExtendDateTime'], 0);
Ext.cmd.derive('MX.field.Hidden', Ext.field.Field, {
    config: {
        labelAlign: null,
        labelWrap: null,
        placeholder: null
    },
    element: {
        reference: 'element',
        tag: 'input',
        type: 'hidden'
    },
    getTemplate: function () {
        this.inputElement = this.element;
        return null
    },
    applyValue: function (a) {
        a = Ext.isEmpty(a) ? '' : '' + a;
        return Ext.field.Field.prototype.applyValue.call(this, a)
    },
    updateValue: function (b, c) {
        var a = this;
        a.element.dom.value = b;
        if (!a.isConfiguring && b != c) {
            a.fireEvent('change', a, b, c)
        }
    },
    updateFieldAttribute: function (a, b) {
        var c = this.element;
        if (!Ext.isEmpty(b, !0)) {
            c.dom.setAttribute(a, b)
        } else {
            c.dom.removeAttribute(a)
        }
    },
    updateName: function (a) {
        Ext.field.Field.prototype.updateName.apply(this, arguments);
        this.updateFieldAttribute('name', a)
    },
    updateLabelWidth: Ext.emptyFn,
    updateLabelMinWidth: Ext.emptyFn,
    updateLabel: Ext.emptyFn,
    updateLabelCls: Ext.emptyFn
}, 0, ['mx_hiddenfield'], ['widget', 'component', 'field', 'mx_hiddenfield'], {
    'widget': !0,
    'component': !0,
    'field': !0,
    'mx_hiddenfield': !0
}, ['widget.mx_hiddenfield'], 0, [MX.field, 'Hidden'], 0);
Ext.cmd.derive('MX.field.Location', Ext.Component, {
    padding: '5 15',
    config: {
        readOnly: !1,
        userRefresh: !1,
        value: null,
        label: null,
        name: null,
        required: !1,
        mode: 'MULTI',
        autoGenHiddenFields: !0,
        detailMode: !1,
        cls: 'location',
        styleHtmlCls: 'flexbox box-align-center',
        styleHtmlContent: !0
    },
    tpl: ['<div>', '<a href="javascript:;" class="openmap">{Location}</a>', '</div>'],
    data: [],
    initialize: function () {
        Ext.Component.prototype.initialize.apply(this, arguments);
        this.element.on('tap', this.onTap, this)
    },
    applyValue: function (b) {
        var a = this.parseGeoLocationXml(b);
        this.setData(Ext.clone(a));
        return a
    },
    parseGeoLocationXml: function (a) {
        if (Ext.isEmpty(a)) {
            return null
        }
        if (!Ext.isString(a)) {
            return a
        }
        try {
            var d = new DOMParser(),
                e = d.parseFromString(a, 'text/xml'),
                b = e.getElementsByTagName('GeoLocationValue'),
                c = {};
            if (b.length == 1) {
                Ext.each(b[0].childNodes, function (b) {
                    if (b.nodeType == 1) {
                        c[b.nodeName] = b.textContent
                    }
                })
            }
            return c
        } catch (f) {
            return Ext.decode(a)
        }
    },
    onTap: function (d) {
        var b = Ext.fly(d.target);
        var e = this;
        if (b.hasCls('openmap') && MapLocation) {
            var a = this.getData();
            var c = {
                latitude: a.Latitude,
                longitude: a.Longitude,
                address: a.Location
            };
            MapLocation.openMap(c)
        }
    }
}, 0, ['location'], ['widget', 'component', 'location'], {
    'widget': !0,
    'component': !0,
    'location': !0
}, ['widget.location'], 0, [MX.field, 'Location'], 0);
Ext.cmd.derive('UX.event.KeyEvent', Ext.Base, {
    isDefaultPrevented: !1,
    set: function (a, c) {
        if (arguments.length === 1 && typeof a != 'string') {
            var b = a;
            for (a in b) {
                if (b.hasOwnProperty(a)) {
                    this[a] = b[a]
                }
            }
        } else {
            this[a] = c
        }
    },
    which: function () {
        var a = this.browserEvent,
            b = a.which;
        return b
    },
    preventDefault: function () {
        this.isDefaultPrevented = !0;
        return this
    },
    isSpecialKey: function () {
        return !1
    },
    fireKey: function (a) {}
}, 0, 0, 0, 0, 0, 0, [UX.event, 'KeyEvent'], 0);
Ext.cmd.derive('MX.field.RichTextArea', Ext.field.Text, {
    cls: 'x-rich-textarea',
    tag: 'div',
    config: {
        triggerChars: [],
        regexes: [],
        selectOnTab: !0,
        picker: {
            lazy: !0,
            $value: !0
        }
    },
    expanded: !1,
    currentTrigger: !1,
    currentRange: !1,
    selectionEntered: !1,
    doRegex: !0,
    getInputTemplate: function () {
        var a = Ext.field.Text.prototype.getInputTemplate.apply(this, arguments);
        a.contenteditable = !0;
        return a
    },
    applyPicker: function (a, b) {
        if (a) {
            if (a === !0) {
                a = {}
            }
            Ext.applyIf(a, {
                infinite: !1,
                userCls: 'editor-picker',
                ownerCmp: this,
                ownerField: this,
                navigationModel: {
                    disabled: !0
                },
                scrollToTopOnRefresh: !1,
                loadingHeight: 70,
                maxHeight: 300,
                floated: !0,
                axisLock: !0,
                hideAnimation: null,
                hidden: !0
            })
        }
        return Ext.factory(a, 'Ext.dataview.BoundList', b)
    },
    updatePicker: function (a) {
        if (a) {
            a.on({
                show: 'onPickerShow',
                hide: 'onPickerHide',
                select: 'onPickerSelect',
                scope: this
            })
        }
    },
    updateInputValue: function (b) {
        var c = this,
            a = c.inputElement.dom;
        if (a.value !== b) {
            a.innerHTML = b
        }
        Ext.field.Text.prototype.updateInputValue.apply(this, arguments)
    },
    updateReadOnly: function (a) {
        Ext.field.Text.prototype.updateReadOnly.apply(this, arguments);
        this.updateFieldAttribute('contenteditable', !a ? !0 : null)
    },
    updateDisabled: function (a) {
        Ext.field.Text.prototype.updateDisabled.apply(this, arguments);
        this.updateFieldAttribute('contenteditable', !a ? !0 : null)
    },
    updateFieldAttribute: function (a, b) {
        var c = this.inputElement;
        if (!Ext.isEmpty(b, !0)) {
            c.dom.setAttribute(a, b)
        } else {
            c.dom.removeAttribute(a)
        }
    },
    initialize: function () {
        var a = this;
        Ext.field.Text.prototype.initialize.apply(this, arguments);
        a.inputElement.on({
            mouseup: 'onMouseUp',
            scope: a
        })
    },
    destroy: function () {
        var a = this;
        Ext.field.Text.prototype.destroy.apply(this, arguments);
        Ext.destroy(a._picker)
    },
    onPickerShow: function (c) {
        var a = this;
        var b = c.getNavigationModel();
        a.expanded = !0;
        a.touchListeners = Ext.getDoc().on({
            translate: !1,
            touchstart: 'collapseIf',
            scope: a,
            delegated: !1,
            destroyable: !0
        });
        a.hideEventListeners = Ext.on({
            mousedown: 'collapseIf',
            scope: a,
            destroyable: !0
        });
        b.enable();
        b.setLocation(0)
    },
    collapseIf: function (b) {
        var a = this;
        if (!a.destroyed && (!b.within(a.bodyElement, !1, !0) && !a.owns(b.target))) {
            a.collapse()
        }
    },
    onPickerHide: function (c) {
        var a = this;
        var b = c.getNavigationModel();
        a.expanded = !1;
        Ext.destroy(a.hideEventListeners, a.touchListeners);
        b.setLocation(null);
        b.disable()
    },
    onPickerSelect: function (c, a) {
        var b = this;
        b._insertSelection(b.currentTrigger, {
            content: '<span class="r-at r-atU">@' + a.get('user_name') + '</span>',
            value: 'user_id=' + Utils.toHex(a.get('user_id')) + '&user_name=' + Utils.toHex(a.get('user_name'))
        });
        b.collapse()
    },
    collapse: function () {
        this.getPicker().hide()
    },
    maybeCollapse: function (a) {
        this.collapse()
    },
    onInput: function (d) {
        var b = this,
            a = b.inputElement,
            c = a.getHtml();
        a.dom.value = c;
        Ext.field.Text.prototype.onInput.apply(this, arguments);
        b.reDraw()
    },
    reDraw: function () {
        if (Config.isPhone && Ext.os.is.ios) {
            var d = this,
                c = d.el.dom,
                a = c.querySelector('.x-input-el');
            if (!a) {
                return
            }
            var b = a.clientHeight;
            if (b > 65) {
                if (!a.style.paddingBottom || a.style.paddingBottom == '6px') {
                    a.style.paddingBottom = '7px'
                } else {
                    a.style.paddingBottom = '6px'
                }
            }
        }
    },
    onKeyDown: function (c) {
        var a = this,
            e = c.which();
        Ext.field.Text.prototype.onKeyDown.apply(this, arguments);
        if (e == 0) {
            console.error("onKeyDown(): WEBKIT BUG: Keycode 0 returned. probably delete on Linux keypad but can't be sure");
            return
        }
        var b = null,
            f = null,
            h = null;
        if (!a.expanded) {
            h = document.getSelection();
            if (h.rangeCount) {
                var i = h.getRangeAt(0);
                if (i.collapsed == !1 && e != Ext.event.Event.ENTER) {
                    return
                }
            }
            var g, d;
            switch (e) {
                case Ext.event.Event.BACKSPACE:
                    g = !1;
                    if ((g = a._backspaceZeroSpace()) == 'stop') {
                        return
                    };
                    if (b = a._checkForAdjacentObject('left')) {
                        a.deleteObject(b.domNode);
                        if (b.preventDefault) {
                            c.preventDefault()
                        }
                    };
                    break;
                case Ext.event.Event.DELETE:
                    g = !1;
                    if ((g = a._deleteZeroSpace()) == 'stop') {
                        return
                    };
                    if (b = a._checkForAdjacentObject('right')) {
                        a.deleteObject(b.domNode);
                        c.preventDefault()
                    };
                    break;
                case Ext.event.Event.LEFT:
                    d = a._getCaretPosition();
                    if (b = a._isEmbeddedObject(d.domNode)) {
                        a._setCaretPositionRelative(b.previousSibling, 'end');
                        c.preventDefault();
                        break
                    };
                    if (f = a._moveCaret(d.domNode, d.offset, 'left')) {
                        if (f.checkForObjects && (b = a._checkForAdjacentObject('left'))) {
                            a._setCaretPositionRelative(b.domNode.previousSibling, 'end');
                            c.preventDefault()
                        }
                        if (f.preventDefault) {
                            c.preventDefault()
                        }
                    };
                    break;
                case Ext.event.Event.RIGHT:
                    d = a._getCaretPosition();
                    if (b = a._isEmbeddedObject(d.domNode)) {
                        a._setCaretPositionRelative(b.nextSibling, 'beginning');
                        break
                    };
                    if (f = a._moveCaret(d.domNode, d.offset, 'right')) {
                        if (f.checkForObjects && (b = a._checkForAdjacentObject('right'))) {
                            a._setCaretPositionRelative(b.domNode.nextSibling, 'beginning')
                        }
                        if (f.preventDefault) {
                            c.preventDefault()
                        }
                    };
                    break;
                case Ext.event.Event.ENTER:
                    a._handleEnter(c);
                    return !1;
                default:
                    clearTimeout(a.searching);
                    a.searching = setTimeout(function () {
                        var d = a._checkForTrigger();
                        if (d) {
                            a.execTrigger()
                        } else {
                            var b = a.getPicker();
                            if (!b.getHidden()) {
                                if (b.getStore()) {
                                    b.getStore().clearData()
                                }
                                b.hide()
                            }
                        }
                    }, 200);
                    break;
            }
        } else {
            if (e == Ext.event.Event.UP || e == Ext.event.Event.DOWN || e == Ext.event.Event.ENTER) {
                c.preventDefault();
                return !0
            }
            clearTimeout(a.searching);
            a.searching = setTimeout(function () {
                var d = a._checkForTrigger();
                if (d) {
                    a.execTrigger()
                } else {
                    var b = a.getPicker();
                    if (!b.getHidden()) {
                        if (b.getStore()) {
                            b.getStore().clearData()
                        }
                        b.hide()
                    }
                }
            }, 200)
        }
        if (e == Ext.event.Event.TAB) {
            c.preventDefault();
            return !0
        }
    },
    onKeyPress: function (a) {
        var c = this,
            b = a.which();
        Ext.field.Text.prototype.onKeyPress.apply(this, arguments);
        if (!this.expanded) {
            switch (b) {
                case Ext.event.Event.SPACE:
                    this._checkRegexes(a);
                    break;
                case Ext.event.Event.ENTER:
                    this._checkRegexes(a);
                    break;
                default:
                    break;
            }
        } else {
            if (b == Ext.event.Event.UP || b == Ext.event.Event.DOWN || b == Ext.event.Event.ENTER) {
                a.preventDefault();
                return !0
            }
        }
    },
    execTrigger: function () {
        var b = this,
            a = b.currentTrigger;
        if (a == !1 || a == null) {
            return
        }
        if (a.word.length >= a.minChars) {
            var c = function (e) {
                var c = b.getPicker();
                if (e.length > 0) {
                    a.store = Ext.StoreMgr.lookup(a.store);
                    c.setStore(a.store);
                    c.setItemTpl(a.itemTpl);
                    c.getStore().setData(e);
                    var d = b._getCaretPosition();
                    if (d) {
                        var f = b.getTextNodeRegion(d.domNode);
                        if (f) {
                            if (Config.isPC) {
                                ParseUtil.menuShowAtVisible(c, window.getSelection().getRangeAt(0).getBoundingClientRect())
                            }
                        }
                    }
                } else {
                    if (c.getStore()) {
                        c.getStore().clearData()
                    }
                    c.hide()
                }
            };
            a.callback(a.word, c)
        }
    },
    onKeyUp: function (d) {
        var e = this,
            b = d.which();
        Ext.field.Text.prototype.onKeyUp.apply(this, arguments);
        if (b == 0) {
            return
        }
        if (!this.expanded) {
            this._saveRange();
            if (this._handleRangeSelection()) {
                return
            }
            this._highlightObject();
            var c, a;
            switch (b) {
                case Ext.event.Event.ENTER:
                    this.collapse();
                    this.currentTrigger = !1;
                    if (this.selectionEntered) {
                        this.selectionEntered = !1;
                        break
                    };
                    this._onEnterFixUp(d);
                    break;
                case Ext.event.Event.SPACE:
                case Ext.event.Event.TAB:
                case Ext.event.Event.HOME:
                case Ext.event.Event.END:
                    this.collapse();
                    this.currentTrigger = !1;
                    break;
                case Ext.event.Event.LEFT:
                case Ext.event.Event.RIGHT:
                case Ext.event.Event.BACKSPACE:
                    c = this._getCaretPosition();
                    a = this._clickedOnObject(c.domNode);
                    if (a != !1) {
                        this._setCaretPositionRelative(a, 'before');
                        return
                    };
                    if (!this._checkForTrigger()) {
                        this.collapse();
                        this.currentTrigger = !1
                    } else {
                        this.execTrigger()
                    };
                    break;
                case Ext.event.Event.UP:
                case Ext.event.Event.DOWN:
                    c = this._getCaretPosition();
                    a = this._clickedOnObject(c.domNode);
                    if (a != !1) {
                        this._setCaretPositionRelative(a, 'before')
                    };
                    break;
                default:
                    break;
            }
        } else {
            if (b == Ext.event.Event.UP || b == Ext.event.Event.DOWN || b == Ext.event.Event.ENTER) {
                d.preventDefault();
                return !0
            }
        }
    },
    onMouseUp: function (b) {
        var c;
        this.collapse();
        if (this.inputElement.dom !== document.activeElement) {
            return !0
        }
        this._saveRange();
        if (this._handleRangeSelection()) {
            return
        }
        var a = this._clickedOnObject(b.target);
        if (a != !1) {
            this._setCaretPositionRelative(a, 'before');
            b.preventDefault()
        }
        this._highlightObject();
        if (c = this._checkForTrigger()) {
            this.execTrigger()
        }
    },
    privates: {
        handlePaste: function (b) {
            var e = this,
                d = e.getInputMask();
            if (!d) {
                var a = b.browserEvent,
                    c = '';
                if (a && a.clipboardData && a.clipboardData.getData) {
                    c = a.clipboardData.getData('text/plain');
                    if (document.queryCommandSupported('insertText')) {
                        document.execCommand('insertText', !1, c)
                    } else {
                        document.execCommand('paste', !1, c)
                    }
                    this._checkRegexes(b)
                }
                b.preventDefault()
            }
            Ext.field.Text.prototype.handlePaste.apply(this, arguments)
        }
    },
    onFocus: function (a) {
        Ext.field.Text.prototype.onFocus.apply(this, arguments);
        if (this.expanded) {
            a.preventDefault();
            return !1
        }
    },
    onBlur: function (b) {
        Ext.field.Text.prototype.onBlur.apply(this, arguments);
        var a = this.inputElement.dom.childNodes;
        if (a.length == 1 && a[0].nodeType == 3 && escape(a[0].nodeValue) == '%u200B') {
            this.clear()
        }
    },
    _onEnterFixUp: function (c) {
        var a = this._getCaretPosition();
        if (a.domNode.previousSibling == null) {
            this._checkSibling(a.domNode.parentNode, 'prev')
        } else {
            if (a.domNode.previousSibling.nodeType != 3) {
                if (this.getText() != '') {
                    this._insertEmptyNode(a.domNode.previousSibling, 'before')
                }
                this._insertEmptyNode(a.domNode.previousSibling, 'after')
            }
        }
        if (a.domNode.nodeType != 3 && a.domNode.getAttribute('_moz_dirty') !== null) {
            this._insertEmptyNode(a.domNode, 'before');
            this._insertEmptyNode(a.domNode, 'after')
        } else {
            if (a.domNode.nodeName == 'BR') {} else {
                if (this._isEmbeddedObject(a.domNode)) {
                    var b = this._insertEmptyNode(a.domNode, 'before');
                    this._selectTextNode(b, 0)
                } else {
                    if (a.domNode.nodeName == 'DIV' || a.domNode.nodeName == 'SPAN' || a.domNode.nodeName == 'P') {
                        if (a.domNode.childNodes.length == 0) {
                            this._insertEmptyNode(a.domNode, 'child')
                        } else {
                            if (a.domNode.childNodes[0].nodeType != 3) {
                                this._insertEmptyNode(a.domNode.childNodes[0], 'before');
                                this._insertEmptyNode(a.domNode.childNodes[0], 'after')
                            }
                        }
                    }
                }
            }
        }
    },
    _handleEnter: function (e) {
        if (this.getValue() == null) {
            return !1
        }
        e.preventDefault();
        var c = document.getSelection(),
            a = this.currentRange;
        var b = document.createElement('br');
        a.deleteContents();
        a.insertNode(b);
        a.setStartAfter(b);
        a.setEndAfter(b);
        a.collapse(!1);
        c.removeAllRanges();
        c.addRange(a);
        var f = this._insertEmptyNode(b, 'before', !0);
        var d = this._insertEmptyNode(b, 'after', !0);
        this._selectTextNode(d, 1);
        return !1
    },
    _handleRangeSelection: function () {
        var b = document.getSelection(),
            a;
        if (b.rangeCount) {
            a = b.getRangeAt(0)
        } else {
            return !1
        }
        var c = null,
            d = null;
        if (a.collapsed == !1) {
            if ((c = this._clickedOnObject(a.startContainer)) != !1) {
                a.setStartBefore(c)
            }
            if ((d = this._clickedOnObject(a.endContainer)) != !1) {
                a.setEndAfter(d)
            }
            if (c != !1 || d != !1) {
                b.removeAllRanges();
                b.addRange(a)
            }
            return !0
        }
        return !1
    },
    _saveRange: function (a) {
        if (!a) {
            var b = document.getSelection();
            if (b.rangeCount) {
                a = b.getRangeAt(0)
            } else {
                return !1
            }
        }
        this.currentRange = a.cloneRange()
    },
    _checkForTrigger: function () {
        var a = null,
            b = null;
        a = this._getCaretPosition();
        if (!a || a.offset == -1) {
            return !1
        }
        b = this._isTrigger(a.domNode, a.offset - 1);
        this.currentTrigger = b;
        return b
    },
    _checkRegexes: function (e) {
        var a = null,
            c = null;
        a = this._getCaretPosition();
        if (!a || a.offset == -1) {
            return !1
        }
        if (e.type == 'keyup') {
            if (a.offset < 3) {
                return
            }
            a.offset--
        }
        if (c = this._getWord(a.domNode, a.offset - 1)) {
            var d = this.getRegexes();
            for (var b = 0; b < d.length; b++) {
                if (c.word.match(d[b].regex)) {
                    d[b].callback(this, c)
                }
            }
        }
    },
    _isTrigger: function (b, a) {
        var e = 'looking_for_trigger',
            c = null,
            f = 200,
            d = {};
        while (!0) {
            f--;
            if (f <= 0) {
                console.error('_isTrigger(): runaway loop. braking');
                return !1
            }
            if (a == -1) {
                if (b.previousSibling == null) {
                    if (e == 'looking_for_trigger') {
                        return !1
                    }
                    break
                }
                if (b.previousSibling.nodeType != 3) {
                    if (e == 'looking_for_trigger') {
                        return !1
                    }
                    break
                }
                b = b.previousSibling;
                a = b.nodeValue.length - 1;
                if (a == -1) {
                    continue
                }
            }
            if (b.nodeValue.charAt(a) == '\u200b') {
                a--;
                continue
            }
            if (!b.nodeValue.charAt(a).match(/\s+/)) {
                if (e == 'looking_for_trigger') {
                    if (c = this._isTriggerChar(b.nodeValue.charAt(a))) {
                        e = 'looking_for_space';
                        d.domNode = b;
                        d.offset = a;
                        a--;
                        continue
                    }
                    a--
                } else {
                    if (b.nodeValue.charAt(a).match(/[\u4E00-\u9FA5]|[\uFE30-\uFFA0]|。/)) {
                        break
                    }
                    c = null;
                    return !1
                }
            } else {
                if (e == 'looking_for_trigger') {
                    return !1
                }
                break
            }
        }
        c.startOffset = d.offset + 1;
        c.startNode = d.domNode;
        c = this._getWordEnd(c);
        c.startOffset = d.offset;
        this.currentTrigger = c;
        return c
    },
    _getWordEnd: function (a) {
        var e = 200,
            d = '';
        var b = a.startNode,
            c = a.startOffset;
        a.word = '';
        while (!0) {
            if (e-- <= 0) {
                console.error('_getWordEnd(): runaway loop');
                return !1
            }
            if (c >= b.nodeValue.length) {
                if (b.nextSibling == null) {
                    a.endNode = b;
                    a.endOffset = c - 1;
                    a.word = d;
                    return a
                }
                if (b.nextSibling.nodeType != 3) {
                    a.endNode = b;
                    a.endOffset = c - 1;
                    a.word = d;
                    return a
                }
                b = b.nextSibling;
                c = 0;
                if (b.nodeValue.length == 0) {
                    continue
                }
            }
            if (b.nodeValue.charAt(c) == '\u200b') {
                c++;
                continue
            }
            if (!b.nodeValue.charAt(c).match(/\s+/)) {
                d += b.nodeValue.charAt(c);
                c++
            } else {
                a.endNode = b;
                a.endOffset = c - 1;
                a.word = d;
                return a
            }
        }
    },
    _isTriggerChar: function (c) {
        var a = this.getTriggerChars();
        for (var b in a) {
            if (c == a[b].trigger) {
                return a[b]
            }
        }
        return !1
    },
    _getWord: function (b, a) {
        var e = 200,
            c = {},
            d = !1;
        while (!0) {
            e--;
            if (e <= 0) {
                console.error('_getWord(): runaway loop. braking');
                return !1
            }
            if (a == -1) {
                if (b.previousSibling == null) {
                    break
                }
                if (b.previousSibling.nodeType != 3) {
                    break
                }
                b = b.previousSibling;
                a = b.nodeValue.length - 1;
                if (a == -1) {
                    continue
                }
            }
            if (b.nodeValue.charAt(a) == '\u200b') {
                a--;
                continue
            }
            if (b.nodeValue.charAt(a).match(/\s+|[\u4E00-\u9FA5]|[\uFE30-\uFFA0]|。/)) {
                break
            } else {
                d = !0
            }
            a--
        }
        c.startNode = b;
        c.startOffset = a + 1;
        if (!d) {
            return !1
        }
        c = this._getWordEnd(c);
        return c
    },
    _checkForAdjacentObject: function (b) {
        var a = {},
            c = null,
            d = null;
        if (!(a = this._getCaretPosition())) {
            return !1
        }
        c = a.domNode;
        if (this._isEmbeddedObject(c)) {
            return {
                domNode: c,
                container_spanned: !1,
                preventDefault: !0
            }
        }
        if ((a = this._treeWalker(a.domNode, a.offset, b)) == !1) {
            return !1
        }
        if (c.nodeType != 3 && c.getAttribute('_moz_dirty') !== null) {
            if (b == 'left') {
                if ((a = this._treeWalker(a.domNode.previousSibling, a.offset, b)) == !1) {
                    return !1
                }
            } else {
                return !1
            }
        }
        if (a.domNode.nodeType == 3) {
            if (b == 'left' && a.offset == 0) {
                if (this._isEmbeddedObject(a.domNode.previousSibling)) {
                    return {
                        domNode: a.domNode.previousSibling,
                        container_spanned: !a.checkForObjects,
                        preventDefault: a.preventDefault
                    }
                }
            } else {
                if (b == 'right' && a.offset == a.domNode.nodeValue.length) {
                    if (this._isEmbeddedObject(a.domNode.nextSibling)) {
                        return {
                            domNode: a.domNode.nextSibling,
                            container_spanned: !a.checkForObjects,
                            preventDefault: a.preventDefault
                        }
                    }
                }
            }
        }
        if (!this._isEmbeddedObject(a.domNode)) {
            return !1
        }
        return {
            domNode: a.domNode,
            container_spanned: !a.checkForObjects,
            preventDefault: a.preventDefault
        }
    },
    _clickedOnObject: function (a) {
        while (a && a !== this.inputElement.dom) {
            if (this._isEmbeddedObject(a)) {
                return a
            }
            a = a.parentNode
        }
        return !1
    },
    deleteObject: function (d) {
        var c = document.getSelection(),
            b = d.parentNode,
            a = this._getObjectRange(d);
        a.deleteContents();
        a.collapse(!0);
        c.removeAllRanges();
        c.addRange(a);
        if (b !== this.inputElement.dom && b.childNodes.length == 0) {
            a.setStartBefore(b);
            a.setEndAfter(b);
            a.deleteContents();
            a.collapse(!0);
            c.removeAllRanges();
            c.addRange(a)
        }
        this._saveRange();
        this._value = this.inputElement.dom.value = this.inputElement.getHtml();
        return
    },
    _moveCaret: function (d, c, b) {
        var e = 0,
            a = {};
        if ((a = this._treeWalker(d, c, b)) == !1) {
            return !1
        }
        if (a.type == 'object') {
            if (b == 'left') {
                this._setCaretPositionRelative(a.domNode, 'after')
            } else {
                this._setCaretPositionRelative(a.domNode, 'before')
            }
            return a
        }
        if (a.type == 'container') {
            if (b == 'left') {
                if (a.domNode.previousSibling.nodeName == 'DIV' || a.domNode.previousSibling.nodeName == 'P') {
                    if (a.domNode.previousSibling.childNodes.length == 0) {
                        console.error('_moveCaret(): empty container previousSibling');
                        return !1
                    }
                    this._setCaretPositionRelative(a.domNode.previousSibling, 'end');
                    a.domNode = a.domNode.previousSibling.childNodes[a.domNode.previousSibling.childNodes.length - 1];
                    return a
                }
                if (a.domNode.previousSibling.nodeType == 3) {
                    a.domNode = a.domNode.previousSibling;
                    if (a.domNode.nodeValue.length == 0) {
                        console.error('_moveCaret(): previousSibling is a zero length textnode.');
                        return !1
                    }
                    this._setCaretPositionRelative(a.domNode, 'end');
                    return a
                }
                a.domNode = a.domNode.previousSibling;
                this._setCaretPositionRelative(a.domNode, 'before');
                return a
            }
            if (a.domNode.nextSibling == null) {
                this._setCaretPositionRelative(a.domNode, 'after');
                return a
            }
            if (a.domNode.nextSibling.nodeName == 'DIV' || a.domNode.nextSibling.nodeName == 'P') {
                if (a.domNode.nextSibling.childNodes.length == 0) {
                    console.error('_moveCaret(): empty container nextSibling');
                    return !1
                }
                a.domNode = a.domNode.nextSibling.childNodes[0]
            }
            this._setCaretPositionRelative(a.domNode, 'after');
            return a
        }
        if (a.type == 'child') {
            if (a.domNode.nodeType == 3) {
                if (a.domNode.nodeValue.length == 0) {
                    this._selectTextNode(a.domNode, 0);
                    return a
                }
                this._selectTextNode(a.domNode, 0);
                return a
            }
            return a
        }
        if (a.domNode.nodeType == 3) {
            this._selectTextNode(a.domNode, a.offset);
            return a
        }
        if (a.domNode.nodeName == 'BR') {
            if (a.domNode.getAttribute('_moz_dirty') !== null) {
                if (b == 'left') {
                    a.type = '_moz_dirty';
                    a.preventDefault = !0;
                    this._setCaretPositionRelative(a.domNode, 'before');
                    return a
                }
                this._setCaretPositionRelative(a.domNode, 'after');
                return a
            }
            if (b == 'left') {
                this._setCaretPositionRelative(a.domNode, 'before')
            } else {
                this._setCaretPositionRelative(a.domNode, 'after')
            }
        }
        return a
    },
    _backspaceZeroSpace: function (i) {
        var a = null,
            m = !1,
            l = 0,
            k = null,
            g, d, e, h = null,
            c = null;
        g = this._getCaretPosition();
        if (!g) {
            return
        }
        a = g.domNode;
        if (a.nodeType != 3 && a.nodeName != 'BR') {
            return !1
        }
        if (a.nodeName == 'BR') {
            if (a.getAttribute('_moz_dirty') !== null) {
                return 'stop'
            }
            if (a.previousSibling == null) {
                this._setCaretPositionRelative(a, 'before');
                a.parentNode.removeChild(a);
                return !0
            }
            if (a.previousSibling.nodeType != 3) {
                if (a.previousSibling.nodeName == 'BR') {
                    var j = a.previousSibling;
                    j.parentNode.removeChild(j)
                }
                this._setCaretPositionRelative(a, 'before');
                a.parentNode.removeChild(a);
                return !0
            }
            this._setCaretPositionRelative(a.previousSibling, 'end');
            a.parentNode.removeChild(a)
        }
        e = this._getCaretPosition();
        if ((d = this._walkTextNode(e.domNode, e.offset, 'left', i)) == !1) {
            console.error('_backspaceZeroSpace(): walkTextNode return false');
            return !1
        }
        h = document.getSelection();
        c = document.createRange();
        var b = d.domNode;
        if (b.nodeType != 3) {
            c.setStartAfter(b)
        } else {
            c.setStart(b, d.offset)
        }
        if (i) {
            if (b.nodeName == 'BR') {
                c.setStartBefore(b)
            } else {
                if (b.nodeType == 3) {
                    if (b === e.domNode && d.offset > 0 || e.offset == 0 && d.offset == b.nodeValue.length && d.offset > 0) {
                        var f = d.offset - 1;
                        if (f > 0 && b.nodeValue.charCodeAt(f - 1) == '55357') {
                            f--
                        }
                        c.setStart(b, f)
                    }
                }
            }
        }
        c.setEnd(e.domNode, e.offset);
        c.deleteContents();
        h.removeAllRanges();
        h.addRange(c);
        this._saveRange();
        return !0
    },
    _deleteZeroSpace: function () {
        var i = null,
            g = !1,
            f = 0,
            e = null,
            h, a, b, d = null,
            c = null;
        a = this._getCaretPosition();
        if (a.domNode.nodeType != 3) {
            return !1
        }
        if ((b = this._walkTextNode(a.domNode, a.offset, 'right')) == !1) {
            console.error('_deleteZeroSpace(): walkTextNode return false');
            return !1
        }
        if (a.domNode === b.domNode && a.offset == b.offset) {
            return !1
        }
        d = document.getSelection();
        c = document.createRange();
        c.setStart(a.domNode, a.offset);
        if (b.domNode.nodeType != 3) {
            c.setEndBefore(b.domNode)
        } else {
            c.setEnd(b.domNode, b.offset)
        }
        c.deleteContents();
        d.removeAllRanges();
        d.addRange(c);
        this._saveRange();
        return !0
    },
    _treeWalker: function (a, f, e) {
        var c = {
            type: ''
        };
        var i = 100;
        var d = !1;
        var g = !1;
        while (a != null) {
            if (i-- <= 0) {
                console.error('_treeWalker(): runaway loop');
                return !1
            }
            if (a.nodeType == 3) {
                if ((c = this._walkTextNode(a, f, e)) == !1) {
                    console.error('_treeWalker(): walkTextNode returned false');
                    return !1
                }
                switch (c.type) {
                    case 'text':
                        if (c.domNode.nodeValue.length > 0) {
                            c.preventDefault = d;
                            return c
                        };
                        if (e == 'left') {
                            a = c.domNode.previousSibling
                        } else {
                            a = c.domNode.nextSibling
                        };
                        f = -1;
                        continue;
                    case 'element':
                    case 'object':
                        a = c.domNode;
                        f = -1;
                        break;
                    case 'container':
                        d = !0;
                        g = !0;
                        f = -1;
                        a = c.domNode;
                        break;
                    case 'end':
                        return !1;
                    default:
                        break;
                }
            }
            if (this._isEmbeddedObject(a)) {
                var h = !0;
                if (g) {
                    h = !1
                }
                return {
                    domNode: a,
                    offset: -1,
                    type: 'object',
                    preventDefault: d,
                    checkForObjects: h
                }
            }
            if (a.nodeName == 'BR') {
                if (a.getAttribute('_moz_dirty') !== null) {
                    return {
                        domNode: a,
                        offset: -1,
                        type: 'element',
                        preventDefault: d,
                        checkForObjects: !1
                    }
                }
                return {
                    domNode: a,
                    offset: -1,
                    type: 'element',
                    preventDefault: d,
                    checkForObjects: !1
                }
            }
            if (c.type != 'container' && (a.nodeName == 'DIV' || a.nodeName == 'SPAN' || a.nodeName == 'P')) {
                d = !0;
                g = !0;
                if (a.childNodes.length == 0) {
                    var j = this._insertEmptyNode(a, 'child');
                    return {
                        domNode: j,
                        offset: 0,
                        type: 'child',
                        preventDefault: d,
                        checkForObjects: !1
                    }
                }
                var b = null;
                if (e == 'left') {
                    b = a.childNodes[a.childNodes.length - 1]
                } else {
                    b = a.childNodes[0]
                }
                if (b.nodeType != 3 && !this._isEmbeddedObject(b) && b.nodeName != 'DIV' && b.nodeName != 'P' && b.nodeName != 'BR') {
                    return {
                        domNode: a,
                        offset: -1,
                        type: 'child',
                        preventDefault: d,
                        checkForObjects: !1
                    }
                }
                if (b.nodeType == 3 && b.nodeValue.match(/^[\u200B]+$/) != null) {
                    return {
                        domNode: b,
                        offset: 0,
                        type: 'child',
                        preventDefault: d,
                        checkForObjects: !1
                    }
                }
                a = b;
                continue
            }
            if (e == 'left' && a.previousSibling == null || e == 'right' && a.nextSibling == null) {
                if (a.parentNode === this.inputElement.dom) {
                    return !1
                }
                a = a.parentNode
            }
            if (e == 'left') {
                a = a.previousSibling
            } else {
                a = a.nextSibling
            }
            c.type = ''
        }
        console.error('_treeWalker(): outside of while.');
        return !1
    },
    _walkTextNode: function (a, b, d, f) {
        var e = 200;
        if (a.nodeType != 3) {
            console.error('_walkTextNode(): called with a "' + a.nodeName + '" node');
            return !1
        }
        if (b == -1) {
            if (d == 'left') {
                b = a.nodeValue.length
            } else {
                b = 0
            }
        }
        switch (d) {
            case 'left':
                var c = !1;
                if (b == 0) {
                    c = !0
                };
                while (!0) {
                    if (e-- <= 0) {
                        console.error('_walkTextNode(): runaway loop. braking');
                        return !1
                    }
                    if (c) {
                        c = !1;
                        if (a.previousSibling == null) {
                            if (a.parentNode === this.inputElement.dom) {
                                return {
                                    domNode: a,
                                    offset: 0,
                                    type: 'end',
                                    preventDefault: !1,
                                    checkForObjects: !0
                                }
                            }
                            return {
                                domNode: a.parentNode,
                                offset: -1,
                                type: 'container',
                                preventDefault: !1,
                                checkForObjects: !0
                            }
                        }
                        if (a.previousSibling.nodeType != 3) {
                            a = a.previousSibling;
                            return {
                                domNode: a,
                                offset: -1,
                                type: 'element',
                                preventDefault: !1,
                                checkForObjects: !0
                            }
                        }
                        a = a.previousSibling;
                        if ((b = a.nodeValue.length) == 0) {
                            b = 0;
                            c = !0;
                            continue
                        }
                    }
                    if (a.nodeValue.charAt(b - 1) != '\u200b') {
                        return {
                            domNode: a,
                            offset: b,
                            type: 'text',
                            preventDefault: !1,
                            checkForObjects: !1
                        }
                    } else {
                        if (f) {
                            return {
                                domNode: a,
                                offset: b,
                                type: 'text',
                                preventDefault: !1,
                                checkForObjects: !1
                            }
                        }
                    }
                    b--;
                    if (b == 0) {
                        c = !0
                    }
                };
            case 'right':
                while (!0) {
                    if (e-- <= 0) {
                        console.error('_walkTextNode(): runaway loop. braking');
                        return !1
                    }
                    if (b == a.nodeValue.length) {
                        if (a.nextSibling == null) {
                            if (a.parentNode === this.inputElement.dom) {
                                return {
                                    domNode: a,
                                    offset: b,
                                    type: 'end',
                                    preventDefault: !1,
                                    checkForObjects: !1
                                }
                            }
                            if (a.parentNode === this.inputElement.dom) {
                                var g = this._insertEmptyNode(a, 'after');
                                return {
                                    domNode: g,
                                    offset: 0,
                                    type: 'end',
                                    preventDefault: !1,
                                    checkForObjects: !0
                                }
                            }
                            return {
                                domNode: a.parentNode,
                                offset: -1,
                                type: 'container',
                                preventDefault: !1,
                                checkForObjects: !0
                            }
                        }
                        if (a.nextSibling.nodeType != 3) {
                            a = a.nextSibling;
                            return {
                                domNode: a,
                                offset: -1,
                                type: 'element',
                                preventDefault: !1,
                                checkForObjects: !0
                            }
                        }
                        a = a.nextSibling;
                        b = 0;
                        if (a.nodeValue.length == 0) {
                            continue
                        }
                    }
                    if (a.nodeValue.charAt(b) != '\u200b') {
                        return {
                            domNode: a,
                            offset: b,
                            type: 'text',
                            preventDefault: !1,
                            checkForObjects: !0
                        }
                    }
                    b++
                };
            default:
                break;
        }
    },
    _highlightObject: function () {
        var a = !1;
        this._unHighlightObjects(this.inputElement);
        if (a = this._checkForAdjacentObject('left')) {
            if (!a.container_spanned) {
                Ext.fly(a.domNode).addCls('highlight')
            }
        }
        if (a = this._checkForAdjacentObject('right')) {
            if (!a.container_spanned) {
                Ext.fly(a.domNode).addCls('highlight')
            }
        }
    },
    _unHighlightObjects: function (a) {
        a.select('[data-value].highlight').removeCls('highlight')
    },
    _selectTextNode: function (b, d) {
        if (b.nodeType != 3) {
            console.error('_selectTextNode(): ERROR - node of type "' + b.nodeName + '" received.');
            return !1
        }
        var c = document.getSelection(),
            a = document.createRange();
        a.setStart(b, d);
        a.setEnd(b, d);
        a.collapse(!0);
        c.removeAllRanges();
        c.addRange(a);
        this._saveRange(a)
    },
    _setCaretPositionRelative: function (b, e) {
        var c = document.getSelection(),
            a = null;
        if (b.previousSibling != null) {}
        if (this._isEmbeddedObject(b)) {
            a = this._getObjectRange(b);
            switch (e) {
                case 'before':
                case 'beginning':
                    a.collapse(!0);
                    break;
                case 'after':
                case 'end':
                    a.collapse(!1);
                    break;
                default:
                    break;
            }
            c.removeAllRanges();
            c.addRange(a);
            this._saveRange();
            return
        }
        a = c.getRangeAt(0);
        switch (e) {
            case 'before':
                if (b.nodeName == 'BR') {
                    var d = this._insertEmptyNode(b, 'before');
                    this._setCaretPositionRelative(d, 'end');
                    return
                };
                a.setStartBefore(b);
                a.setEndBefore(b);
                a.collapse(!0);
                c.removeAllRanges();
                c.addRange(a);
                this._saveRange();
                var f = this._getCaretPosition();
                break;
            case 'after':
                if (b.nodeName == 'BR') {
                    a.setStartBefore(b);
                    a.setEndBefore(b);
                    a.collapse(!1);
                    c.removeAllRanges();
                    c.addRange(a);
                    this._saveRange();
                    break
                };
                a.setStartAfter(b);
                a.setEndAfter(b);
                a.collapse(!1);
                c.removeAllRanges();
                c.addRange(a);
                this._saveRange();
                break;
            case 'beginning':
                if (b.nodeType != 3) {
                    console.error('_setCaretPositionRelative(): beginning not on a text node: ', b);
                    return
                };
                a.setStart(b, 0);
                a.setEnd(b, 0);
                a.collapse(!1);
                c.removeAllRanges();
                c.addRange(a);
                this._saveRange();
                break;
            case 'end':
                if (b.nodeType != 3) {
                    console.error('_setCaretPositionRelative(): end not on a text node: ', b);
                    return
                };
                a.setStart(b, b.nodeValue.length);
                a.setEnd(b, b.nodeValue.length);
                a.collapse(!1);
                c.removeAllRanges();
                c.addRange(a);
                this._saveRange();
                break;
            default:
                break;
        }
        if (a.startContainer.nodeName == 'DIV' && a.startContainer === this.inputElement.dom && a.startOffset == a.startContainer.childNodes.length) {
            console.error('_setCaretPositionRelative(): attempted to break out of div.');
            d = this._insertEmptyNode(a.startContainer, 'child');
            this._selectTextNode(d, 0)
        }
    },
    _getObjectRange: function (a) {
        var d = document.getSelection(),
            c, e = null,
            f = 0;
        if (d.rangeCount) {
            c = d.getRangeAt(0)
        } else {
            console.error('_getObjectRange(): NO RANGE. UNABLE TO MOVE CARET.');
            return
        }
        var b;
        if (a.previousSibling == null) {
            b = this._insertEmptyNode(a, 'before');
            c.setStart(b, 0)
        } else {
            if (a.previousSibling.nodeType != 3) {
                b = this._insertEmptyNode(a, 'before');
                c.setStart(b, 0)
            } else {
                if (a.previousSibling.nodeValue == null) {
                    b = this._insertEmptyNode(a, 'before');
                    c.setStart(b, 0)
                } else {
                    if (a.previousSibling.nodeValue.length == 0) {
                        b = this._insertEmptyNode(a, 'before');
                        c.setStart(b, 0)
                    } else {
                        c.setStart(a.previousSibling, a.previousSibling.nodeValue.length)
                    }
                }
            }
        }
        e = document.createRange();
        if (a.nextSibling == null) {
            b = this._insertEmptyNode(a, 'after');
            c.setEnd(b, 1)
        } else {
            if (a.nextSibling.nodeType != 3) {
                b = this._insertEmptyNode(a, 'after');
                c.setEnd(b, 1)
            } else {
                if (a.nextSibling.nodeValue == null) {
                    b = this._insertEmptyNode(a, 'after');
                    c.setEnd(b, 1)
                } else {
                    if (a.nextSibling.nodeValue.length == 0) {
                        b = this._insertEmptyNode(a, 'after');
                        c.setEnd(b, 1)
                    } else {
                        if (a.nextSibling.nodeValue != '\u200b') {
                            b = this._insertEmptyNode(a, 'after');
                            c.setEnd(b, 1)
                        } else {
                            c.setEnd(a.nextSibling, 1)
                        }
                    }
                }
            }
        }
        return c
    },
    _getCaretPosition: function () {
        var a = null,
            c = null,
            d = null,
            e = document.getSelection(),
            b;
        if (e.rangeCount) {
            b = e.getRangeAt(0)
        } else {
            if (this.currentRange) {
                b = this.currentRange
            } else {
                return !1
            }
        }
        if (b.collapsed == !1) {
            return !1
        }
        a = b.startContainer;
        if (d = this._isEmbeddedObject(a)) {
            return {
                domNode: d,
                offset: -1
            }
        }
        if (a.nodeType == 3) {
            return {
                domNode: a,
                offset: b.startOffset
            }
        }
        if (a === this.inputElement.dom || a.nodeName == 'DIV' || a.nodeName == 'P') {
            if (a.childNodes.length == 0) {
                c = this._insertEmptyNode(a, 'child');
                this._selectTextNode(c, 0);
                return {
                    domNode: c,
                    offset: 0
                }
            }
            if (b.startOffset >= a.childNodes.length) {
                c = this._insertEmptyNode(a, 'after');
                this._selectTextNode(c, 1);
                return {
                    domNode: c,
                    offset: 1
                }
            }
            a = a.childNodes[b.startOffset];
            if (a.nodeType == 3) {
                this._selectTextNode(a, 0);
                return {
                    domNode: a,
                    offset: 0
                }
            }
        }
        return {
            domNode: a,
            offset: -1
        }
    },
    getTextNodeRegion: function (d) {
        var b = document.createRange();
        b.selectNodeContents(d);
        var c = b.getClientRects();
        if (c.length > 0) {
            var a = c[0];
            return new Ext.util.Region(a.top, a.right, a.bottom, a.left)
        }
        return null
    },
    _insertSelection: function (b, a) {
        this.replaceWord(b, a.content, a.value);
        this.selectionEntered = !0
    },
    replaceWord: function (a, d, c) {
        if (!a.startNode) {
            return
        }
        var e = document.getSelection(),
            b = document.createRange();
        b.setStart(a.startNode, a.startOffset);
        b.setEnd(a.endNode, a.endOffset + 1);
        b.deleteContents();
        this._saveRange(b);
        this.insertObject(d, c)
    },
    _insertEmptyNode: function (a, d, c) {
        if (typeof c === 'undefined') {
            c = !1
        }
        var b = document.createTextNode('\u200b');
        switch (d) {
            case 'before':
                if (!c && a.previousSibling != null && a.previousSibling.nodeType == 3 && a.previousSibling.nodeValue.length > 0) {
                    return a.previousSibling
                };
                a.parentNode.insertBefore(b, a);
                break;
            case 'after':
                if (!c && a.nextSibling != null && a.nextSibling.nodeType == 3 && a.nextSibling.nodeValue.length > 0) {
                    return a.nextSibling
                };
                a.parentNode.insertBefore(b, a.nextSibling);
                break;
            case 'child':
                if (a.childNodes.length != 0 && a.childNodes[a.childNodes.length - 1].nodeType == 3) {
                    return a.childNodes[a.childNodes.length - 1]
                };
                a.appendChild(b);
                break;
            default:
                console.error('_insertEmptyNode(): Invalid direction supplied "' + d + '"');
                break;
        }
        return b
    },
    _checkSibling: function (c, d) {
        var a = null;
        if (d == 'prev') {
            a = c.previousSibling
        } else {
            a = c.nextSibling
        }
        if (a == null) {
            return
        }
        if (this._isEmbeddedObject(a)) {
            this._insertEmptyNode(a, 'before');
            this._insertEmptyNode(a, 'after');
            return
        }
        if (a.nodeName == 'BR') {
            this._insertEmptyNode(a, 'before');
            this._insertEmptyNode(a, 'after');
            return
        }
        if (a.nodeName != 'SPAN' && a.nodeName != 'DIV' && a.nodeName != 'P') {
            return
        }
        if (a.childNodes.length == 0) {
            this._insertEmptyNode(a, 'child');
            return
        }
        if (a.childNodes.length == 1 && a.childNodes[0].nodeName == 'BR') {
            var b = a.childNodes[0];
            this._insertEmptyNode(b, 'before');
            b.parentNode.removeChild(b);
            return
        }
        this._insertEmptyNode(a.childNodes[0], 'before');
        this._insertEmptyNode(a.childNodes[a.childNodes.length - 1], 'after');
        return
    },
    _isEmbeddedObject: function (b) {
        var c = null;
        if (b == null) {
            return !1
        }
        var a = b;
        while (a && a !== this.element.dom) {
            if (a.nodeType != 3 && a.hasAttribute && a.hasAttribute('data-value')) {
                return a
            }
            a = a.parentNode
        }
    },
    insertText: function (d) {
        var b = document.createTextNode(d),
            a = this.currentRange;
        if (a === !1) {
            this.inputElement.dom.appendChild(b)
        } else {
            var c = document.getSelection();
            a.deleteContents();
            a.insertNode(b);
            a.setStartAfter(b);
            a.collapse(!0);
            c.removeAllRanges();
            c.addRange(a)
        }
        this._selectTextNode(b, b.nodeValue.length)
    },
    appendText: function (b) {
        var a = document.createTextNode(b);
        this.inputElement.dom.appendChild(a);
        this._selectTextNode(a, a.nodeValue.length)
    },
    insertObject: function (h, i) {
        this.inputElement.dom.focus();
        var c;
        if (this.currentRange === !1) {
            c = this._insertEmptyNode(this.inputElement.dom, 'child');
            this._selectTextNode(c, 1)
        }
        var e = document.getSelection(),
            b = e.getRangeAt(0);
        var d = document.createElement('div');
        d.innerHTML = h.replace(/^[\s\u200B]+|[\s\u200B]+$/g, '');
        var a;
        if (d.childNodes.length > 0) {
            a = d.childNodes[0]
        }
        if (!a) {
            return
        }
        a.setAttribute('data-value', i);
        b.deleteContents();
        b.insertNode(a);
        b.setStartAfter(a);
        b.collapse(!0);
        e.removeAllRanges();
        e.addRange(b);
        c = this._insertEmptyNode(a, 'before', !0);
        var f = this._insertEmptyNode(a, 'after', !0);
        var g = document.createTextNode('\xa0');
        f.parentNode.insertBefore(g, f.nextSibling);
        this._selectTextNode(g, 1);
        this._value = this.inputElement.dom.value = this.inputElement.getHtml()
    },
    getSubmitValue: function () {
        var a = document.createElement('div');
        a.innerHTML = this.inputElement.getHtml();
        Ext.fly(a).query('span.r-at').forEach(function (a) {
            Ext.DomHelper.insertBefore(a, a.innerText, !1);
            a.parentNode.removeChild(a)
        });
        Ext.fly(a).query('img.emoji').forEach(function (a) {
            Ext.DomHelper.insertBefore(a, a.getAttribute('alt'), !1);
            a.parentNode.removeChild(a)
        });
        return a.innerHTML.replace(/[\u200B]/gm, '')
    },
    getText: function () {
        var a = document.createElement('div');
        a.innerHTML = this.inputElement.getHtml();
        return a.textContent.replace(/[\u200B]/gm, '')
    },
    getEmbeddedValues: function () {
        var a = [];
        this._getEmbeddedValues(this.inputElement.dom.childNodes, a);
        return Ext.Array.unique(a)
    },
    _getEmbeddedValues: function (d, c) {
        var a;
        for (var b = 0; d[b]; b++) {
            a = d[b];
            if (this._isEmbeddedObject(a) && !this._isEmoji(a)) {
                c.push(a.getAttribute('data-value'));
                continue
            }
            if (a.nodeType !== 8) {
                this._getEmbeddedValues(a.childNodes, c)
            }
        }
    },
    _isEmoji: function (a) {
        return Ext.fly(a).is('img.emoji')
    },
    clear: function () {
        this.inputElement.setHtml('');
        this._value = ''
    },
    focusEnd: function () {
        this.inputElement.dom.focus();
        var f = document.getSelection(),
            a = document.createRange(),
            e = this.inputElement.dom,
            b = e.childNodes,
            d;
        if (b.length > 0 && (d = this._walkTextNode(b[b.length - 1], b.length, 'left')) != !1) {
            var c = d.domNode;
            if (c.nodeType != 3) {
                a.setStartAfter(c)
            } else {
                a.setStart(c, c.nodeValue.length)
            }
        } else {
            a.setStart(e, 0)
        }
        a.collapse(!0);
        f.removeAllRanges();
        f.addRange(a);
        this._saveRange()
    },
    simulateBackspace: function () {
        var a = Ext.create('UX.event.KeyEvent');
        a.set('browserEvent', {
            keyCode: 8
        });
        this.onKeyDown(a);
        this.onKeyUp(a);
        if (!a.isDefaultPrevented) {
            this._backspaceZeroSpace(!0)
        }
    }
}, 0, ['richtextareafield'], ['widget', 'component', 'field', 'inputfield', 'textfield', 'richtextareafield'], {
    'widget': !0,
    'component': !0,
    'field': !0,
    'inputfield': !0,
    'textfield': !0,
    'richtextareafield': !0
}, ['widget.richtextareafield'], 0, [MX.field, 'RichTextArea'], 0);
Ext.cmd.derive('MX.mixin.AutoHeightList', Ext.Mixin, {
    mixinConfig: {
        id: 'autoheightlist',
        after: {
            updateStore: 'updateStore'
        }
    },
    updateStore: function (d, b) {
        var e = this,
            a = 'ajustHeight',
            c = {
                add: a,
                remove: a,
                update: a,
                clear: a,
                load: a,
                scope: e
            };
        if (b && Ext.isObject(b) && !b.destroying && !b.destroye) {
            b.unAfter(c)
        }
        if (d) {
            d.onAfter(c)
        }
    },
    ajustHeight: function () {
        var a = this;
        if (!a.destroying && !a.destroyed) {
            var c = a.getScrollable();
            var d = c.getScrollElement();
            var e = d.dom.scrollHeight;
            var b = a.getExtraHeight ? a.getExtraHeight() : 0;
            a.setHeight(e + b)
        }
    }
}, 0, 0, 0, 0, 0, 0, [MX.mixin, 'AutoHeightList'], 0);
Ext.cmd.derive('MX.model.ValueText', Ext.data.Model, {
    idProperty: 'value',
    fields: ['value', 'text']
}, 0, 0, 0, 0, 0, 0, [MX.model, 'ValueText'], 0);
Ext.cmd.derive('MX.plugin.ListOptions', Ext.Base, {
    config: {
        list: null,
        borderOffset: 0,
        items: [],
        optionSelector: 'option-button',
        optionsTpl: ['<tpl for=".">', '<div class="option-button {color}" data-action="{action}">{text}</div>', '</tpl>'].join(''),
        itemFilter: null,
        filter: null
    },
    constructor: function (a) {
        this.initConfig(a)
    },
    applyOptionsTpl: function (a) {
        if (Ext.isString(a)) {
            return Ext.create('Ext.XTemplate', a)
        }
        return a
    },
    init: function (b) {
        var a = this;
        a.setList(b);
        b.addCls('x-list-options-plugin');
        var f = b.getScrollable();
        if (f) {
            f.setX(!1)
        }
        b.el.on({
            scope: a,
            dragstart: 'onDragStart'
        });
        var e = {
            cls: 'item-options-wrapper',
            children: [{
                cls: 'item-options',
                html: a.getOptionsTpl().apply(a.getItems())
            }]
        };
        a.optionsWrapper1 = Ext.Element.create(e);
        a.optionsWrapper1.options = a.optionsWrapper1.child('.item-options');
        a.optionsWrapper2 = Ext.Element.create(e);
        a.optionsWrapper2.options = a.optionsWrapper2.child('.item-options');
        var d = {
            swipe: 'onOptionsSwipe',
            scope: a
        };
        a.optionsWrapper1.on(d);
        a.optionsWrapper2.on(d);
        var c = {
            delegate: '.' + this.getOptionSelector(),
            touchstart: 'onOptionTouchStart',
            touchend: 'onOptionTouchEnd',
            touchcancel: 'onOptionTouchEnd',
            tap: 'onOptionTap',
            scope: a
        };
        a.optionsWrapper1.options.on(c);
        a.optionsWrapper2.options.on(c)
    },
    destroy: function () {
        this.optionsWrapper1.destroy();
        this.optionsWrapper2.destroy();
        this.callParent(arguments)
    },
    onOptionsSwipe: function (b, c) {
        if (b.direction == 'right') {
            var a = Ext.get(b.getTarget())._row;
            if (a) {
                this.moveRow(a, 0)
            }
        }
    },
    getAvailOptionsWrapper: function (a) {
        if (a._isOptionsOpened && a._optionsWrapper) {
            return a._optionsWrapper
        }
        if (this.optionsWrapper1._animating) {
            return this.optionsWrapper2
        }
        return this.optionsWrapper1
    },
    onDragStart: function (c) {
        var b = this,
            d = b.cmp,
            f = d.mapToRecord(c);
        if (c.absDeltaX < c.absDeltaY) {
            return
        }
        if (f) {
            var a = d.mapToItem(f),
                j = b.getFilter();
            if (Ext.isFunction(j) && !j.call(b, d, f)) {
                return !1
            }
            if (c.deltaX > 0 && !a._isOptionsOpened || c.deltaX < 0 && a._isOptionsOpened) {
                return !1
            }
            if (b.animateRow) {
                b.moveRow(b.animateRow, 0)
            }
            a._optionsWrapper = b.getAvailOptionsWrapper(a);
            var h = b.getItemFilter();
            if (Ext.isFunction(h)) {
                a._optionsWrapper.select('.' + b.getOptionSelector()).each(function (a) {
                    if (h.call(this, d, a.getAttribute('data-action'), f)) {
                        a.show()
                    } else {
                        a.hide()
                    }
                }, b)
            }
            a._optionsWrapper._row = a;
            d.el.on({
                scope: b,
                drag: 'onDrag',
                dragend: 'onDragEnd'
            });
            b.dragRow = a;
            b.dragRecord = a.getRecord();
            var i = Math.round(a.element.getHeight() - b.getBorderOffset()),
                g = 0;
            if (d.getInfinite()) {
                a._startTranslateY = a.$position;
                g = a._startTranslateY
            } else {
                a._startTranslateY = 0;
                g = -i
            }
            a._startOffsetX = a._offsetX || 0;
            a._optionsWrapper.insertAfter(a.element);
            a._optionsWrapper.optionsWidth = a._optionsWrapper.options.getWidth();
            var e = a._startOffsetX + c.deltaX;
            e = Math.min(Math.max(-a._optionsWrapper.optionsWidth, e), 0);
            a.translate(e, a._startTranslateY);
            a._optionsWrapper.options.translate(e, 0);
            a._optionsWrapper.options.setHeight(i);
            a._optionsWrapper.translate(0, g);
            a._offsetX = e;
            c.stopPropagation()
        }
    },
    onDrag: function (d) {
        var a = this.dragRow,
            c = a.getRecord();
        if (!c) {
            return
        }
        if (Math.abs(a._offsetX) <= a._optionsWrapper.optionsWidth && a._offsetX <= 0) {
            var b = a._startOffsetX + d.deltaX;
            b = Math.min(Math.max(-a._optionsWrapper.optionsWidth, b), 0);
            a.translate(b, a._startTranslateY);
            a._optionsWrapper.options.translate(b, 0);
            a._offsetX = b
        }
    },
    onAnimationFrame: function (c, b, d) {
        var a = Ext.getCmp(c.getElement().getId());
        a._optionsWrapper.options.translate(b, 0);
        a._offsetX = b
    },
    onAnimationEnd: function (d, c, e) {
        var a = Ext.getCmp(d.getElement().getId());
        if (this.animateRow === a) {
            delete this.animateRow
        }
        a._offsetX = c;
        if (a._animateClosing) {
            var b = a._optionsWrapper.dom;
            if (b.parentNode) {
                b.parentNode.removeChild(b)
            }
            delete a._optionsWrapper._row
        }
        delete a._animateClosing;
        delete a._animateOpening;
        delete a._optionsWrapper._animating;
        a.getTranslatable().un({
            animationframe: 'onAnimationFrame',
            animationend: 'onAnimationEnd',
            scope: this
        });
        if (c != 0) {
            this.addViewportListener(a)
        }
    },
    onDragEnd: function (g) {
        var b = this,
            d = b.dragRow,
            i = b.getList();
        i.el.un({
            drag: 'onDrag',
            dragend: 'onDragEnd',
            scope: b
        });
        delete b.dragRow;
        b.animateRow = d;
        var f = Math.abs(g.flick.velocity.x),
            h = g.deltaX > 0 ? 'right' : 'left',
            a = Math.abs(d._offsetX),
            e = 0,
            c = 0;
        if (a > 0) {
            c = d._optionsWrapper.optionsWidth;
            e = parseInt(c * 0.3, 10);
            switch (h) {
                case 'right':
                    a = f > 0.3 || c - a > e ? 0 : -c;
                    break;
                case 'left':
                    a = f > 0.3 || a > e ? -c : 0;
                    break;
                default:
                    break;
            }
        }
        b.moveRow(d, a)
    },
    moveRow: function (a, b, d) {
        if (b == 0) {
            a._animateClosing = !0
        } else {
            a._animateOpening = !0
        }
        a._optionsWrapper._animating = !0;
        a._isOptionsOpened = b != 0;
        a.element[b == 0 ? 'removeCls' : 'addCls']('opened');
        var c = a.getTranslatable();
        c.on({
            animationframe: 'onAnimationFrame',
            animationend: 'onAnimationEnd',
            scope: this
        });
        c.translateAnimated(b, a._startTranslateY, {
            duration: d || 150,
            easing: 'ease-out'
        })
    },
    addViewportListener: function (b) {
        var a = this;
        if (!a._viewportTouchStart) {
            a._viewportTouchStart = function (c) {
                a.viewportTouchStart(c, b)
            }
        }
        Ext.Viewport.element.dom.addEventListener('touchstart', a._viewportTouchStart, !0)
    },
    removeViewportListener: function (b) {
        var a = this;
        if (a._viewportTouchStart) {
            Ext.Viewport.element.dom.removeEventListener('touchstart', a._viewportTouchStart, !0);
            delete a._viewportTouchStart
        }
    },
    viewportTouchStart: function (c, a) {
        var b = this,
            d = c.target || c.srcElement;
        if (a.isDestroyed) {
            b.removeViewportListener(a);
            return
        }
        if (!Ext.fly(d).hasCls(b.getOptionSelector())) {
            b.moveRow(a, 0);
            b.removeViewportListener(a);
            c.stopPropagation()
        }
    },
    onOptionTouchStart: function (a, b) {
        this.pressedTimeout = Ext.defer(this.addPressedClass, 100, this, [a])
    },
    onOptionTouchEnd: function (a, b) {
        if (this.pressedTimeout) {
            clearTimeout(this.pressedTimeout);
            delete this.pressedTimeout
        }
        this.removePressedClass(a)
    },
    onOptionTap: function (e, f) {
        var d = this,
            b = e.getTarget(),
            c = b.getAttribute('data-action'),
            a = Ext.fly(b).up('.item-options-wrapper');
        this.moveRow(a._row, 0);
        d.removeViewportListener(a._row);
        this.getList().fireEvent('listoptiontap', this.getList(), a._row.getRecord(), c)
    },
    addPressedClass: function (a) {
        Ext.fly(a.getTarget()).addCls('pressed')
    },
    removePressedClass: function (a) {
        Ext.fly(a.getTarget()).removeCls('pressed')
    }
}, 1, 0, 0, 0, ['plugin.listoptions'], 0, [MX.plugin, 'ListOptions'], 0);
(function () {
    if (window.LocalFileSystem === undefined && window.PERSISTENT !== undefined) {
        window.LocalFileSystem = {
            PERSISTENT: window.PERSISTENT,
            TEMPORARY: window.TEMPORARY
        }
    }
    window.requestFileSystem = window.requestFileSystem || window.webkitRequestFileSystem;
    window.resolveLocalFileSystemURL = window.resolveLocalFileSystemURL || window.webkitResolveLocalFileSystemURL
})();
Ext.cmd.derive('MX.util.FileSystemUtil', Ext.Base, {
    alternateClassName: 'FSUtil',
    singleton: !0,
    FILEERROR: {
        1: 'NOT_FOUND_ERR',
        2: 'SECURITY_ERR',
        3: 'ABORT_ERR',
        4: 'NOT_READABLE_ERR',
        5: 'ENCODING_ERR',
        6: 'NO_MODIFICATION_ALLOWED_ERR',
        7: 'INVALID_STATE_ERR',
        8: 'SYNTAX_ERR',
        9: 'INVALID_MODIFICATION_ERR',
        10: 'QUOTA_EXCEEDED_ERR',
        11: 'TYPE_MISMATCH_ERR',
        12: 'PATH_EXISTS_ERR',
        1000: 'UNKNOWN_ERR'
    },
    privates: {
        parse: function (c, a) {
            if (Config.isDesktop || window.cefFileMgr) {
                a = encodeURI(a)
            }
            var e = null,
                f = null;
            if (c === null || c === undefined) {
                c = 1
            }
            var d = window.cordova ? cordova.file.tempDirectory : null;
            var b = '';
            if (window.cefUserSelector) {
                b = User.fileFolder
            } else {
                if (window.cordova) {
                    b = window.cordova.file.dataDirectory
                } else {
                    var g = Utils.getApp().getCefObj();
                    b = g.getDataDirectory();
                    b = encodeURI(b)
                }
            }
            if (FileUtil.isFileUri(a)) {
                f = a;
                if (d && a.indexOf(d) == 0) {
                    c = 0;
                    e = decodeURIComponent(a.substr(d.length))
                } else {
                    if (a.indexOf(b) == 0) {
                        c = 1;
                        e = decodeURIComponent(a.substr(b.length))
                    } else {
                        console.error('暂不支持的路径')
                    }
                }
            } else {
                e = a;
                if (c == 0 && d) {
                    f = d + a
                } else {
                    if (c == 1) {
                        f = b + a
                    } else {
                        console.error('暂不支持的路径')
                    }
                }
            }
            return {
                root: c,
                relative: e,
                full: f
            }
        },
        copyOrMove: function (m, c, g, f, i, d, b, h) {
            if (Ext.isEmpty(c) || Ext.isEmpty(f)) {
                return
            }
            var o = this;
            b = Ext.isFunction(b) ? b : Ext.emptyFn;
            var a = function (a) {
                if (Ext.isFunction(h)) {
                    h(a)
                }
            };
            var n = FSUtil.parse(g, f),
                k = n.relative,
                j = FileUtil.splitPath(k),
                l = j[0],
                e = j[1];
            DirMgr.create(g, l).then(function (k) {
                if (FileUtil.isFileUri(c)) {
                    window.resolveLocalFileSystemURL(c, function (j) {
                        j[d ? 'moveTo' : 'copyTo'](k, e, function (a) {
                            b(a.toURL())
                        }, a)
                    }, a)
                } else {
                    var j = FSUtil.parse(m, c),
                        l = j.relative;
                    FSUtil['load' + j.root]().then(function (n) {
                        var j = '';
                        if (i == 1) {
                            j = 'getFile'
                        } else {
                            if (i == 2) {
                                j = 'getDirectory'
                            }
                        }
                        if (j) {
                            n.root[j](l, {
                                create: !1
                            }, function (j) {
                                j[d ? 'moveTo' : 'copyTo'](k, e, function (a) {
                                    b(a.toURL())
                                }, a)
                            }, a)
                        } else {
                            a('unknown exception')
                        }
                    })['catch'](a)
                }
            })['catch'](a)
        }
    },
    load0: function () {
        var a = this;
        return new Ext.Promise(function (b, c) {
            if (a.tmpFileSystem) {
                return b(a.tmpFileSystem)
            }
            if (!window.requestFileSystem) {
                return c('不支持 requestFileSystem')
            }
            window.resolveLocalFileSystemURL(cordova.file.tempDirectory, function (d) {
                a.tmpFileSystem = d.filesystem;
                b(a.tmpFileSystem)
            }, function (a) {
                c(a)
            })
        })
    },
    load1: function () {
        var a = this;
        return new Ext.Promise(function (c, d) {
            if (a.fileSystem) {
                return c(a.fileSystem)
            }
            if (!window.requestFileSystem) {
                return d('不支持 requestFileSystem')
            }
            var b = '';
            if (window.cefUserSelector) {
                b = User.fileFolder
            } else {
                if (window.cordova) {
                    b = window.cordova.file.dataDirectory
                } else {
                    var e = Utils.getApp().getCefObj();
                    b = e.getDataDirectory()
                }
            }
            window.resolveLocalFileSystemURL(b, function (b) {
                a.fileSystem = b.filesystem;
                c(a.fileSystem)
            }, function (a) {
                d(a)
            })
        })
    }
}, 0, 0, 0, 0, 0, 0, [MX.util, 'FileSystemUtil', 0, 'FSUtil'], 0);
Ext.cmd.derive('MX.util.DirMgr', Ext.Base, {
    alternateClassName: 'DirMgr',
    singleton: !0,
    privates: {
        queues0: {},
        queues1: {},
        create_r: function (e, g, i, d, a) {
            a = typeof a == 'undefined' ? 0 : a;
            var f = this,
                h = g.split('/'),
                b = a + 1,
                c = h.slice(0, b).join('/');
            var j = function (c, b) {
                return function () {
                    b.create_r.apply(b, c)
                }
            };
            if (b == h.length || /\/$/.test(c)) {
                f.create_one(e, c, i, d)
            } else {
                f.create_one(e, c, j([e, g, i, d, b], f), d)
            }
        },
        create_one: function (d, c, b, a) {
            FSUtil['load' + d]().then(function (e) {
                e.root.getDirectory(c, {
                    create: !0,
                    exclusive: !1
                }, function (f) {
                    if (b) {
                        b(f)
                    }
                }, function (f) {
                    if (a) {
                        a(f)
                    }
                })
            })['catch'](a)
        }
    },
    create: function (b, c) {
        var a = this;
        return new Ext.Promise(function (j, k) {
            var f = FSUtil.parse(b, c),
                d = f.relative,
                e = 'queues' + f.root,
                g = a[e][d];
            if (!g) {
                g = a[e][d] = [];
                var i = function (h) {
                    var f = a[e][d];
                    if (f) {
                        while (f.length) {
                            var g = f.shift();
                            if (g.resolve) {
                                g.resolve(h)
                            }
                        }
                        delete a[e][d]
                    }
                };
                var h = function (h) {
                    var f = a[e][d];
                    if (f) {
                        while (f.length) {
                            var g = f.shift();
                            if (g.reject) {
                                g.reject(h)
                            }
                        }
                        delete a[e][d]
                    }
                };
                FSUtil['load' + f.root]().then(function (e) {
                    e.root.getDirectory(d, {
                        create: !1
                    }, i, function (g) {
                        if (g.code == 1) {
                            a.create_r(f.root, d, i, h)
                        } else {
                            h(g)
                        }
                    })
                })['catch'](h)
            }
            g.push({
                resolve: j,
                reject: k
            })
        })
    },
    moveTo: function (b, a, d, c) {
        return new Ext.Promise(function (e, f) {
            FSUtil.copyOrMove(b, a, d, c, 2, !0, e, f)
        })
    },
    copyTo: function (b, a, d, c) {
        return new Ext.Promise(function (e, f) {
            FSUtil.copyOrMove(b, a, d, c, 2, !1, e, f)
        })
    },
    remove: function (a, b) {
        var c = this;
        return new Ext.Promise(function (f, c) {
            var d = FSUtil.parse(a, b),
                e = d.relative;
            FSUtil['load' + d.root]().then(function (d) {
                d.root.getDirectory(e, {
                    create: !1
                }, function (e) {
                    e.removeRecursively(f, c)
                }, function (e) {
                    if (e.code != 1) {
                        c(e)
                    }
                })
            })['catch'](c)
        })
    }
}, 0, 0, 0, 0, 0, 0, [MX.util, 'DirMgr', 0, 'DirMgr'], 0);
Ext.cmd.derive('MX.util.Utils', Ext.Base, {
    alternateClassName: 'Utils',
    singleton: !0,
    regex: {
        url: /^(http|https):\/\/(\w+:{0,1}\w*)?(\S+)(:[0-9]+)?(\/|\/([\w#!:.?+=&%!\-/]))?$/i
    },
    regexStr: {
        query: '((\\?(?:&?[^=&]*=[^=&]*)*)?)',
        query2: '(\\?(?:&?[^=&]*=[^=&]*)*)'
    },
    isDev: Ext.manifest.env === 'development',
    isWeb: location.href.indexOf('http') == 0,
    isDebugBuild: function () {
        return this.isDev || window.BuildInfo && BuildInfo.debug
    },
    isDebugOpened: function () {
        return !!parseInt(this.getLsItem('debug') || 0, 10)
    },
    isDebug: function () {
        return this.isDebugBuild() || this.isDebugOpened()
    },
    getApp: function () {
        return Ext.getApplication() || Ext.route.Router.application
    },
    getAppName: function () {
        return this.getApp().getName()
    },
    err: function (a, b) {
        return function () {
            console.log(arguments.callee.caller);
            if (typeof a !== 'undefined') {
                console.log(' ' + a + ':')
            }
            if (typeof b !== 'undefined') {
                console.log('  ' + b + ':')
            }
            console.error ? console.error(arguments) : console.log(arguments)
        }
    },
    getLsKey: function (a) {
        if (Ext.isEmpty(a)) {
            return ''
        }
        return this.getAppName() + '-' + a
    },
    getLsItem: function (a) {
        return localStorage.getItem(this.getLsKey(a))
    },
    setLsItem: function (b, a) {
        localStorage.setItem(this.getLsKey(b), a)
    },
    removeLsItem: function (a) {
        localStorage.removeItem(this.getLsKey(a))
    },
    redirectTo: function () {
        var a = this.getApp();
        if (a) {
            a.redirectTo.apply(a, arguments)
        }
    },
    replaceState: function (a) {
        if (history.replaceState) {
            history.replaceState(null, '', a)
        }
    },
    redirectToSilently: function (b) {
        if (history.pushState) {
            var c = this;
            var d = Ext.History.getToken();
            var a = c.hash2Token(b);
            history.pushState(null, '', c.token2Hash(b));
            Ext.History.hash = a;
            Ext.route.Router.clearLastTokens(d);
            Ext.fireEvent('afterroute', null, a)
        }
    },
    exitRoute: function (c, b) {
        var a = b || this.getApp().getDefaultToken();
        if (c === !0) {
            this.redirectToSilently(a)
        } else {
            this.redirectTo(a)
        }
    },
    getRouteByToken: function (e, b) {
        var d = Ext.route.Router.routes;
        var a = {},
            f, c;
        if (b && b.getRoutes) {
            var g = b.getRoutes();
            if (g) {
                a = g
            }
        } else {
            a = d
        }
        for (f in a) {
            c = d[f];
            if (e && c.recognize(e)) {
                return c
            }
        }
        return null
    },
    hash2Token: function (a) {
        return (a || '').replace(Ext.History.hashRe, '')
    },
    token2Hash: function (a) {
        return (a || '').replace(Ext.History.hashRe, Ext.History.hashbang ? '#!' : '#')
    },
    _handleOptions: function (a) {
        var f = this;
        a = a || {};
        if (a.maskTarget) {
            if (a.maskTarget == !0) {
                a.maskTarget = Ext.Viewport
            } else {
                if (Ext.isString(a.maskTarget)) {
                    a.maskTarget = Ext.getCmp(a.maskTarget)
                }
            }
        }
        if (a.button) {
            var d = [];
            var b = a.button;
            b = Ext.isArray(b) ? b : [b];
            for (var e = 0; e < b.length; e++) {
                var c = b[e];
                if (Ext.isEmpty(c)) {
                    continue
                }
                d.push(Ext.isString(c) ? Ext.getCmp(c) : c)
            }
            if (d.length) {
                a.button = d
            } else {
                delete a.button
            }
        }
        if (a.data) {
            a.params = Ext.apply({}, a.params, {
                data: Ext.encode(a.data)
            });
            delete a.data
        }
        a.params = Ext.apply({}, a.params, this.getApp().getClientInfo());
        if (!a.ajaxHost || !a.ajaxHost.isComponent || a.ajaxHost.isDestroying) {
            delete a.ajaxHost
        }
        return a
    },
    _handleOptions1: function (a) {
        var f = this;
        a = a || {};
        if (a.maskTarget) {
            if (a.maskTarget == !0) {
                a.maskTarget = Ext.Viewport
            } else {
                if (Ext.isString(a.maskTarget)) {
                    a.maskTarget = Ext.getCmp(a.maskTarget)
                }
            }
        }
        if (a.button) {
            var d = [];
            var b = a.button;
            b = Ext.isArray(b) ? b : [b];
            for (var e = 0; e < b.length; e++) {
                var c = b[e];
                if (Ext.isEmpty(c)) {
                    continue
                }
                d.push(Ext.isString(c) ? Ext.getCmp(c) : c)
            }
            if (d.length) {
                a.button = d
            } else {
                delete a.button
            }
        }
        if (!a.ajaxHost || !a.ajaxHost.isComponent || a.ajaxHost.isDestroying) {
            delete a.ajaxHost
        }
        return a
    },
    joinPath: function () {
        var a = '';
        Ext.each(Array.prototype.slice.call(arguments), function (b) {
            if (!Ext.isEmpty(b)) {
                while (!Ext.isEmpty(a) && a[a.length - 1] == '/') {
                    a = a.substr(0, a.length - 1)
                }
                while (b[0] == '/') {
                    b = b.substr(1)
                }
                if (!Ext.isEmpty(a)) {
                    a += '/'
                }
                a += b
            }
        });
        return a
    },
    getFullUrl: function (a) {
        var d = this;
        if (!Ext.isEmpty(a)) {
            var b;
            if (Utils.isUrl(a) || /\.json$/i.test(a)) {
                b = a
            } else {
                if (/^(ajax|store)\/[^/]+\/[^/]+$/.test(a)) {
                    var c = a.split('/');
                    b = Utils.joinPath(Config.httpUrl, 'ApiEntry', Ext.String.capitalize(c[0]) + '.ashx?class=' + c[1] + '&method=' + c[2])
                } else {
                    b = Utils.joinPath(Config.httpUrl, a)
                }
            }
            return b
        }
        return a
    },
    getFullUrl1: function (a) {
        var c = this;
        if (!Ext.isEmpty(a)) {
            var b;
            if (Utils.isUrl(a) || /\.json$/i.test(a)) {
                b = a
            } else {
                if (a != 'users/login') {
                    a = a + '?token=' + User.token + '&user_id=' + User.ownerID
                }
                b = Utils.joinPath(Config.httpUrlForGo, a)
            }
            return b
        }
        return a
    },
    getFullUrl3: function (e, a) {
        var f = this;
        if (!Ext.isEmpty(a)) {
            var d;
            if (Utils.isUrl(a) || /\.json$/i.test(a)) {
                d = a
            } else {
                var b;
                if (e == 'EA' && User.accURL) {
                    b = User.accURL.split('/');
                    b.pop();
                    b = b.join('/');
                    var c = a.split('/');
                    a = Utils.joinPath('ApiEntry', Ext.String.capitalize(c[0]) + '.ashx?class=' + c[1] + '&method=' + c[2])
                } else {
                    b = Config.httpUrlForGo
                }
                d = Utils.joinPath(b, a)
            }
            return d
        }
        return a
    },
    ajax: function (api, options) {
        var me = this;
        var opt = me._handleOptions(options);
        if (opt.maskTarget) {
            this.mask(opt.maskTarget)
        }
        var btnState = [];
        if (opt.button) {
            Ext.each(opt.button, function (a) {
                btnState.push(a.getDisabled());
                if (a.setCircularProgress) {
                    a.setCircularProgress(!0)
                }
                a.setDisabled(!0)
            })
        }
        var request = Ext.Ajax.request(Ext.applyIf({
            url: me.getFullUrl(api),
            method: 'POST',
            useDefaultXhrHeader: !1,
            withCredentials: !0,
            success: function (d, h) {
                var e = d.getResponseHeader('content-type');
                var g = /json/i.test(e);
                var a = d.responseText,
                    c = !0;
                if (!Ext.isEmpty(a) && g) {
                    try {
                        a = Ext.decode(a)
                    } catch (i) {}
                }
                if (a && a.hasOwnProperty('success')) {
                    c = a.success
                }
                if (c) {
                    if (opt.success) {
                        opt.success.call(this, a)
                    }
                } else {
                    var b = a.message || '';
                    var f = a.code;
                    if (opt.failure) {
                        opt.failure.call(this, b, f)
                    } else {
                        if (!Ext.isEmpty(b)) {
                            me.alert(b)
                        }
                    }
                }
            },
            failure: function (r, op) {
                var err = r.responseText;
                if (!Ext.isEmpty(err)) {
                    try {
                        err = eval('(' + err + ')')
                    } catch (b) {}
                } else {
                    err = r.statusText
                }
                var msg = err.message || err;
                if (r.status == '0') {
                    me.toastShort(msg || 'communication failure')
                } else {
                    if (r.status == '-1') {} else {
                        if (me.isUnauthorized(r.status)) {
                            Ext.route.Router.resume(!0);
                            this.getApp().fireEvent('needlogin');
                            me.toastShort(msg)
                        } else {
                            if (opt.failure) {
                                opt.failure.call(this, msg, r.status)
                            } else {
                                me.alert(msg)
                            }
                        }
                    }
                }
            },
            callback: function (c, b, a) {
                if (opt.button) {
                    Ext.each(opt.button, function (d, e) {
                        if (!d.isDestroyed && !d.isDestroying) {
                            if (d.setCircularProgress) {
                                d.setCircularProgress(!1)
                            }
                            d.setDisabled(btnState[e])
                        }
                    })
                }
                if (opt.ajaxHost && opt.ajaxHost.ajaxRequests && !opt.ajaxHost.isDestroying) {
                    delete opt.ajaxHost.ajaxRequests[a.requestId]
                }
                if (opt.maskTarget) {
                    me.unMask(opt.maskTarget)
                }
                if (opt.callback) {
                    opt.callback.call(this, b, a)
                }
            },
            scope: opt.scope || me
        }, opt));
        var h = opt.ajaxHost;
        if (h && !h.isDestroying) {
            if (!h.ajaxRequests) {
                h.ajaxRequests = {}
            }
            h.ajaxRequests[request.id] = request
        }
        return request
    },
    custAjax: function (method, api, options, modify, params) {
        var me = this;
        var mmm, opt;
        mmm = me.getFullUrl1;
        opt = me._handleOptions1(options);
        var url = mmm(api);
        if (params) {
            url += params
        }
        if (opt.maskTarget) {
            this.mask(opt.maskTarget)
        }
        var btnState = [];
        if (opt.button) {
            Ext.each(opt.button, function (a) {
                btnState.push(a.getDisabled());
                a.setDisabled(!0)
            })
        }
        var request = Ext.Ajax.request(Ext.applyIf({
            url: url,
            method: method,
            useDefaultXhrHeader: !1,
            withCredentials: !0,
            success: function (c, h) {
                if (opt.button) {
                    Ext.each(opt.button, function (a, b) {
                        if (!a.isDestroyed) {
                            a.setDisabled(btnState[b])
                        }
                    })
                }
                var e = c.getResponseHeader('content-type');
                var g = /json/i.test(e);
                var a = c.responseText,
                    d = !0;
                if (!Ext.isEmpty(a) && g) {
                    try {
                        a = Ext.decode(a)
                    } catch (i) {}
                }
                if (a && a.hasOwnProperty('success')) {
                    d = a.success
                }
                if (d) {
                    if (opt.success) {
                        opt.success.call(this, a, c.status)
                    }
                } else {
                    var b = a.message || '';
                    var f = a.code;
                    if (opt.failure) {
                        opt.failure.call(this, b, f)
                    } else {
                        if (!Ext.isEmpty(b)) {
                            me.alert(b)
                        }
                    }
                }
                if (WebSocketUtil.conn === null) {
                    if (window.cefSetting || window.cefMsgMgr || window.cefUserSelector || window.cefTransfer || window.cefChat || window.cefCrowdSetting) {
                        return
                    }
                    WebSocketUtil.initialize(Config.wsGoUrl)
                }
            },
            failure: function (r, op) {
                if (opt.button) {
                    Ext.each(opt.button, function (a, b) {
                        if (!a.isDestroyed) {
                            a.setDisabled(btnState[b])
                        }
                    })
                }
                var err = r.responseText;
                if (!Ext.isEmpty(err)) {
                    try {
                        err = eval('(' + err + ')')
                    } catch (b) {}
                } else {
                    err = r.statusText
                }
                var msg = '';
                if (err) {
                    msg = err.message || err
                }
                if (me.isUnauthorized(r.status)) {
                    Ext.route.Router.resume(!0);
                    this.getApp().fireEvent('unauthorized');
                    me.toastShort(msg)
                } else {
                    if (r.status == '412') {
                        this.getApp().fireEvent('unauthorized');
                        this.getApp().fireEvent('needUpdate');
                        me.toastShort(msg)
                    } else {
                        if (opt.failure) {
                            opt.failure.call(this, msg, r.status)
                        } else {}
                    }
                }
            },
            callback: function (c, b, a) {
                if (opt.ajaxHost && opt.ajaxHost.ajaxRequests && !opt.ajaxHost.isDestroying) {
                    delete opt.ajaxHost.ajaxRequests[a.requestId]
                }
                if (opt.maskTarget) {
                    me.unMask(opt.maskTarget)
                }
                if (opt.callback) {
                    opt.callback.call(this, b, a)
                }
            },
            scope: opt.scope || me
        }, opt));
        var h = opt.ajaxHost;
        if (h && !h.isDestroying) {
            if (!h.ajaxRequests) {
                h.ajaxRequests = {}
            }
            h.ajaxRequests[request.id] = request
        }
        return request
    },
    ajaxWithSuffix: function (api, options, suffixType, method) {
        var me = this;
        if (!window.VerControll.judgeFn('verApprove')) {
            return !1
        }
        if (!method) {
            method = 'POST'
        }
        if (!suffixType) {
            suffixType = 'EA'
        }
        var url, opt;
        url = me.getFullUrl3(suffixType, api);
        opt = me._handleOptions(options);
        if (suffixType == 'EA') {
            if (Config.isPC) {
                opt.params.deviceId = window.cef.getDeviceID();
                opt.params.appId = window.cef.getAppID();
                opt.params.sessionId = window.cef.getERPToken();
                opt.params.userSign = window.cef.getUserSign()
            } else {
                opt.params.deviceId = User.EAdatas.deviceId;
                opt.params.appId = User.EAdatas.appId;
                opt.params.sessionId = User.EAdatas.sessionId;
                opt.params.userSign = User.EAdatas.userSign
            }
        }
        if (opt.maskTarget) {
            this.mask(opt.maskTarget)
        }
        var btnState = [];
        if (opt.button) {
            Ext.each(opt.button, function (a) {
                btnState.push(a.getDisabled());
                if (a.setCircularProgress) {
                    a.setCircularProgress(!0)
                }
                a.setDisabled(!0)
            })
        }
        var request = Ext.Ajax.request(Ext.applyIf({
            url: url,
            method: method,
            useDefaultXhrHeader: !1,
            success: function (d, h) {
                var e = d.getResponseHeader('content-type');
                var g = /json/i.test(e);
                var a = d.responseText,
                    c = !0;
                if (!Ext.isEmpty(a) && g) {
                    try {
                        a = Ext.decode(a)
                    } catch (i) {}
                }
                if (a && a.hasOwnProperty('success')) {
                    c = a.success
                }
                if (c) {
                    if (opt.success) {
                        opt.success.call(this, a)
                    }
                } else {
                    var b = a.message || '';
                    var f = a.code;
                    if (opt.failure) {
                        opt.failure.call(this, b, f)
                    } else {
                        if (!Ext.isEmpty(b)) {
                            me.alert(b)
                        }
                    }
                }
            },
            failure: function (r, op) {
                var err = r.responseText;
                if (!Ext.isEmpty(err)) {
                    try {
                        err = eval('(' + err + ')')
                    } catch (b) {}
                } else {
                    err = r.statusText
                }
                var msg = err.message || err;
                if (me.isUnauthorized(r.status)) {
                    Ext.route.Router.resume(!0);
                    this.getApp().fireEvent('needlogin');
                    me.toastShort(msg)
                } else {
                    if (opt.failure) {
                        opt.failure.call(this, msg, r.status)
                    } else {
                        me.alert(msg)
                    }
                }
            },
            callback: function (c, b, a) {
                if (opt.button) {
                    Ext.each(opt.button, function (d, e) {
                        if (!d.isDestroyed && !d.isDestroying) {
                            if (d.setCircularProgress) {
                                d.setCircularProgress(!1)
                            }
                            d.setDisabled(btnState[e])
                        }
                    })
                }
                if (opt.ajaxHost && opt.ajaxHost.ajaxRequests && !opt.ajaxHost.isDestroying) {
                    delete opt.ajaxHost.ajaxRequests[a.requestId]
                }
                if (opt.maskTarget) {
                    me.unMask(opt.maskTarget)
                }
                if (opt.callback) {
                    opt.callback.call(this, b, a)
                }
            },
            scope: opt.scope || me
        }, opt));
        var h = opt.ajaxHost;
        if (h && !h.isDestroying) {
            if (!h.ajaxRequests) {
                h.ajaxRequests = {}
            }
            h.ajaxRequests[request.id] = request
        }
        return request
    },
    aioAjax: function (method, api, options) {
        var me = this;
        var opt = me._handleOptions1(options);
        var url = me.getFullUrl1(api);
        if (opt.judgeFn) {
            try {
                var bool = !1;
                if (opt.judgeFn instanceof Array) {
                    opt.judgeFn.forEach(function (a) {
                        if (window.VerControll[a]) {
                            bool = !0
                        }
                    })
                } else {
                    bool = window.VerControll[opt.judgeFn]
                }
                if (!bool) {
                    return !1
                }
            } catch (b) {
                return !1
            }
        }
        if (opt.maskTarget) {
            this.mask(opt.maskTarget)
        }
        var btnState = [];
        if (opt.button) {
            Ext.each(opt.button, function (a) {
                btnState.push(a.getDisabled());
                if (a.setCircularProgress) {
                    a.setCircularProgress(!0)
                }
                a.setDisabled(!0)
            })
        }
        var request = Ext.Ajax.request(Ext.applyIf({
            url: url,
            method: method,
            useDefaultXhrHeader: !1,
            withCredentials: !0,
            success: function (d, h) {
                var e = d.getResponseHeader('content-type');
                var g = /json/i.test(e);
                var a = d.responseText,
                    c = !0;
                if (!Ext.isEmpty(a) && g) {
                    try {
                        a = Ext.decode(a)
                    } catch (i) {}
                }
                if (a && a.hasOwnProperty('success')) {
                    c = a.success
                }
                if (c) {
                    if (opt.success) {
                        opt.success.call(this, a)
                    }
                } else {
                    var b = a.message || '';
                    var f = a.code;
                    if (opt.failure) {
                        opt.failure.call(this, b, f)
                    } else {
                        if (!Ext.isEmpty(b)) {
                            me.alert(b)
                        }
                    }
                }
            },
            failure: function (r, op) {
                var err = r.responseText;
                if (!Ext.isEmpty(err)) {
                    try {
                        err = eval('(' + err + ')')
                    } catch (c) {}
                } else {
                    err = r.statusText
                }
                var msg = err.message || err;
                if (r.status == '0') {
                    me.toastShort(msg || 'communication failure')
                } else {
                    if (op.url.indexOf('api/v1/version') > 0) {
                        opt.failure.call(this, msg, r.status)
                    } else {
                        if (r.status == '-1') {} else {
                            if (me.isUnauthorized(r.status)) {
                                Ext.route.Router.resume(!0);
                                this.getApp().fireEvent('needlogin');
                                me.toastShort(msg)
                            } else {
                                if (opt.failure) {
                                    opt.failure.call(this, msg, r.status)
                                } else {
                                    me.alert(msg)
                                }
                            }
                        }
                    }
                }
            },
            callback: function (c, b, a) {
                if (opt.button) {
                    Ext.each(opt.button, function (d, e) {
                        if (!d.isDestroyed && !d.isDestroying) {
                            if (d.setCircularProgress) {
                                d.setCircularProgress(!1)
                            }
                            d.setDisabled(btnState[e])
                        }
                    })
                }
                if (opt.ajaxHost && opt.ajaxHost.ajaxRequests && !opt.ajaxHost.isDestroying) {
                    delete opt.ajaxHost.ajaxRequests[a.requestId]
                }
                if (opt.maskTarget) {
                    me.unMask(opt.maskTarget)
                }
                if (opt.callback) {
                    opt.callback.call(this, b, a)
                }
            },
            scope: opt.scope || me
        }, opt));
        var h = opt.ajaxHost;
        if (h && !h.isDestroying) {
            if (!h.ajaxRequests) {
                h.ajaxRequests = {}
            }
            h.ajaxRequests[request.id] = request
        }
        return request
    },
    aio8Ajax: function (api, options) {
        var me = this;
        var opt = me._handleOptions1(options);
        if (!options.method) {
            options.method = 'POST'
        }
        var params = options.params = options.params || {};
        var data = options.data;
        if (data) {
            Object.keys(data).forEach(function (a) {
                if (Ext.isObject(data[a]) || Ext.isArray(data[a])) {
                    options.params[a] = Ext.encode(data[a])
                } else {
                    options.params[a] = data[a]
                }
            });
            delete options.data
        }
        options.headers = options.headers || {};
        var agentHeaders = Utils.getAio8Agent() || {};
        Ext.apply(options.headers, {
            'X-PushApi-Agent': Object.keys(agentHeaders).map(function (a) {
                return a + '=' + agentHeaders[a]
            }).join(',')
        });
        if (!Config.aErp8Url) {
            return
        }
        var url = Utils.joinPath(Config.aErp8Url, 'Agent', api);
        if (options.CORP && options.CORP.toLocaleLowerCase() === 'group') {
            if (!Config.aGrp8Url) {
                return
            }
            url = Utils.joinPath(Config.aGrp8Url, 'Agent', api)
        }
        var request = Ext.Ajax.request(Ext.applyIf({
            url: url,
            method: options.method,
            useDefaultXhrHeader: !1,
            withCredentials: !0,
            success: function (c, h) {
                var e = c.getResponseHeader('content-type');
                var g = /json/i.test(e);
                var a = c.responseText,
                    d = !0;
                if (!Ext.isEmpty(a) && g) {
                    try {
                        a = Ext.decode(a)
                    } catch (i) {}
                }
                if (a && a.hasOwnProperty('success')) {
                    d = a.success
                }
                if (d) {
                    if (opt.success) {
                        opt.success.call(this, a, c.status)
                    }
                } else {
                    var b = a.message || '';
                    var f = a.code;
                    if (opt.failure) {
                        opt.failure.call(this, b, f)
                    } else {
                        if (!Ext.isEmpty(b)) {
                            me.alert(b)
                        }
                    }
                }
                if (WebSocketUtil.conn === null) {
                    if (Utils.isCEF()) {
                        return
                    }
                    WebSocketUtil.initialize(Config.wsGoUrl)
                }
            },
            failure: function (r, op) {
                var err = r.responseText;
                if (!Ext.isEmpty(err)) {
                    try {
                        err = eval('(' + err + ')')
                    } catch (b) {}
                } else {
                    err = r.statusText
                }
                var msg = '';
                if (err) {
                    msg = err.message || err.ErrMsg || err
                }
                if (me.isUnauthorized(r.status)) {
                    Ext.route.Router.resume(!0);
                    this.getApp().fireEvent('unauthorized');
                    me.toastShort(msg)
                } else {
                    if (r.status == '412') {
                        this.getApp().fireEvent('unauthorized');
                        this.getApp().fireEvent('needUpdate');
                        me.toastShort(msg)
                    } else {
                        if (opt.failure) {
                            opt.failure.call(this, msg, r.status)
                        } else {
                            if (err.ErrMsg) {
                                Utils.toastLong(err.ErrMsg)
                            }
                        }
                    }
                }
            },
            callback: function (c, b, a) {
                if (opt.ajaxHost && opt.ajaxHost.ajaxRequests && !opt.ajaxHost.isDestroying) {
                    delete opt.ajaxHost.ajaxRequests[a.requestId]
                }
                if (opt.maskTarget) {
                    me.unMask(opt.maskTarget)
                }
                if (opt.callback) {
                    opt.callback.call(this, b, a)
                }
            },
            scope: opt.scope || me
        }, opt));
        var h = opt.ajaxHost;
        if (h && !h.isDestroying) {
            if (!h.ajaxRequests) {
                h.ajaxRequests = {}
            }
            h.ajaxRequests[request.id] = request
        }
        return request
    },
    isUnauthorized: function (a) {
        return a == '440' || a == '401'
    },
    alert: function (b) {
        var a = (b || '').replace(/(?:<style.*?>)((\n|\r|.)*?)(?:<\/style>)/ig, '');
        if (!Ext.isEmpty(a)) {
            Ext.Msg.alert('系统提示', a)
        }
    },
    confirm: function (b, a) {
        Ext.Msg.confirm('系统提示', b, function (c) {
            if (c == 'yes' && a != null) {
                a()
            }
        })
    },
    prompt: function (b, a) {
        this._prompt(!1, b, a)
    },
    multiLinePrompt: function (b, a) {
        this._prompt(!0, b, a)
    },
    _prompt: function (b, a, c) {
        if (Ext.isString(a)) {
            a = {
                message: a
            }
        }
        var d = b ? 'textareafield' : 'textfield';
        Ext.Msg.show(Ext.merge({
            title: '系统提示',
            width: null,
            height: null,
            buttons: Ext.MessageBox.OKCANCEL,
            multiLine: b,
            defaultFocus: d,
            prompt: {
                xtype: d
            },
            fn: function (e, d) {
                if (e == 'ok' && c) {
                    c(d)
                }
            }
        }, a))
    },
    toastShort: function (a) {
        if (!Ext.isEmpty(a)) {
            Ext.toast(a, 1500)
        }
    },
    toastLong: function (a) {
        if (!Ext.isEmpty(a)) {
            Ext.toast(a, 3000)
        }
    },
    formatNum: function (d, c) {
        if (!Ext.isEmpty(d)) {
            var b = '0,000.';
            while (c > 0) {
                b += '0';
                c--
            }
            var a = Ext.util.Format.number(d, b);
            while (a[a.length - 1] == '0') {
                a = a.substr(0, a.length - 1)
            }
            if (a[a.length - 1] == '.') {
                a = a.substr(0, a.length - 1)
            }
            return a
        }
        return ''
    },
    toHex: function (b) {
        var d = '';
        if (b != null) {
            b = b.toString();
            for (var c = 0; c < b.length; c++) {
                var a = b.charCodeAt(c).toString(16);
                if (a.length == 1) {
                    a = '0' + a + '00'
                } else {
                    if (a.length == 2) {
                        a = a + '00'
                    } else {
                        if (a.length == 3) {
                            a = a.substring(1, 3) + '0' + a.substring(0, 1)
                        } else {
                            if (a.length == 4) {
                                a = a.substring(2, 4) + a.substring(0, 2)
                            }
                        }
                    }
                }
                d += a
            }
        }
        return d.toUpperCase()
    },
    fromHex: function (b) {
        var c = '';
        if (b != null) {
            b = b.toString();
            for (var a = 0; a < b.length; a += 4) {
                c = c + String.fromCharCode('0x' + b.substring(a + 2, a + 4) + b.substring(a, a + 2))
            }
        }
        return c
    },
    toKey: function (a, b) {
        if (b === undefined) {
            b = !0
        }
        var c = a.indexOf('?');
        if (c >= 0) {
            a = a.substr(c + 1)
        }
        var f = this;
        var d = {};
        var e = a.split('&');
        Ext.each(e, function (e) {
            var c = e.split('=');
            d[c[0]] = b ? f.fromHex(c[1]) : c[1]
        });
        return d
    },
    toKeyByKeyNames: function (d, b, e) {
        var c = this.toKey(d, e);
        var a = {};
        Ext.each(b, function (f) {
            a[f] = c[f]
        });
        return a
    },
    toKeyList: function (a, d) {
        if (d === undefined) {
            d = !0
        }
        var f = this;
        var b = {
            k: [],
            v: []
        };
        if (Ext.isString(a)) {
            var e = a.split('&');
            Ext.each(e, function (e) {
                var c = e.split('=');
                b.k.push(c[0]);
                b.v.push(d ? f.fromHex(c[1]) : c[1])
            })
        } else {
            for (var c in a) {
                if (a.hasOwnProperty(c)) {
                    b.k.push(c);
                    b.v.push(a[c])
                }
            }
        }
        return b
    },
    toKeyStr: function (b, c) {
        if (c === undefined) {
            c = !0
        }
        var f = this;
        var d = [];
        for (var a in b) {
            if (!Ext.isEmpty(b[a])) {
                var e = c ? f.toHex(b[a]) : b[a];
                d.push(a + '=' + e)
            }
        }
        return d.join('&')
    },
    isEqKeyStr: function (a, b) {
        if (!a && !b) {
            return !0
        }
        if (!a && b || a && !b) {
            return !1
        }
        var e = this;
        var d = e.toKey(a, !1);
        var f = e.toKey(b, !1);
        var c;
        for (c in d) {
            if (d.hasOwnProperty(c)) {
                if (f[c] !== d[c]) {
                    return !1
                }
            }
        }
        return !0
    },
    time2Str: function (a, e) {
        if (!Ext.isEmpty(a)) {
            if (Ext.isDate(a)) {
                return Ext.util.Format.date(a, 'H:i')
            }
            if (a.toString().indexOf(':', 0) >= 0) {
                if (a.toString().length == 4) {
                    return '0' + a
                }
                return a
            }
            var b = '0000' + a;
            b = b.substr(b.length - 4, 4);
            if (e) {
                var c = parseInt(b.substr(0, 2), 10);
                var f = 'AM',
                    d = c;
                if (c > 12) {
                    f = 'PM';
                    d -= 12
                } else {
                    if (c == 12) {
                        e = 'PM'
                    } else {
                        if (c == 0) {
                            d = 12
                        }
                    }
                }
                return d + ':' + b.substr(2, 2) + ' ' + f
            }
            return b.substr(0, 2) + ':' + b.substr(2, 2)
        }
        return ''
    },
    joinDateTime: function (f, b) {
        if (!f) {
            return null
        }
        var d = 0,
            c = 0;
        var a = Ext.Date.clone(f);
        if (Ext.isEmpty(b)) {
            return a
        } else {
            if (Ext.isNumber(b)) {
                d = parseInt(b / 100, 10);
                c = b % 100
            } else {
                var e = this.toTime(b);
                d = parseInt(e.substr(0, 2), 10), c = parseInt(e.substr(3), 10)
            }
        }
        a.setHours(d);
        a.setMinutes(c);
        a.setSeconds(0);
        return a
    },
    datetime2Str: function (a) {
        if (!a) {
            return ''
        }
        if (!Ext.isDate(a)) {
            a = new Date(a)
        }
        return Ext.util.Format.date(a, Ext.Date.defaultFormat + ' ' + Ext.Date.defaultTimeFormat)
    },
    date2Str: function (a) {
        if (!a) {
            return ''
        }
        if (!Ext.isDate(a)) {
            a = new Date(a)
        }
        return Ext.util.Format.date(a, Ext.Date.defaultFormat)
    },
    datetime2Ago: function (a, o, r) {
        if (!a) {
            return ''
        }
        if (!Ext.isDate(a)) {
            a = new Date(a)
        }
        var q = [Ext.Date.SECOND, Ext.Date.MINUTE, Ext.Date.HOUR, Ext.Date.DAY];
        var c = q.indexOf(r);
        var b = new Date();
        var g = b - a;
        var f = parseInt(g / (1000 * 60), 10);
        if (c >= 0 && f <= 0) {
            return '刚刚'
        }
        if (c >= 1 && f <= 60) {
            return f + ' 分钟前'
        }
        var i = parseInt(g / (1000 * 60 * 60), 10);
        if (c >= 2 && i <= 24) {
            return i + ' 小时前'
        }
        var j = parseInt(g / (1000 * 60 * 60 * 24), 10);
        if (c >= 3 && j <= 30) {
            return j + ' 天前'
        }
        var e = o ? Ext.util.Format.date(a, ' H:i') : '';
        var h = b.getFullYear() == a.getFullYear();
        var k = h && b.getMonth() == a.getMonth();
        var p = k && b.getDate() == a.getDate();
        if (p) {
            return '今天' + e
        }
        var d = Ext.Date.add(b, Ext.Date.DAY, -1);
        var n = d.getFullYear() == a.getFullYear();
        var m = n && d.getMonth() == a.getMonth();
        var l = m && d.getDate() == a.getDate();
        if (l) {
            return '昨天' + e
        }
        return Ext.util.Format.date(a, h ? 'm-d' : 'Y-m-d') + e
    },
    removeAllBut: function (c, e) {
        if (!c) {
            return
        }
        var d = c.items;
        var f = d.length,
            b = 0,
            a;
        for (; b < f; b++) {
            a = d.getAt(b);
            if (a && a.isInnerItem()) {
                if (e && e(a)) {
                    c.doRemove(a, b, !0);
                    b--;
                    f--
                }
            }
        }
    },
    delegateButtonEvents: function (b, a) {
        if (a === undefined) {
            a = b
        }
        b.on({
            delegate: 'button',
            tap: function (c) {
                a.fireEvent('tap' + c.config.action, a, c)
            }
        })
    },
    mask: function (a, d) {
        var c = d || '';
        if (a && !a.isDestroyed) {
            var b = this.getLoadMask(c);
            if (b && b.getParent() !== a) {
                a.add(b)
            }
            a.setMasked(b)
        }
    },
    unMask: function (a) {
        if (a && !a.isDestroyed && a._masked && !a._masked.isDestroyed) {
            a.setMasked(!1)
        }
    },
    getLoadMask: function (b) {
        var a = this.getCmp('loadmask', !0);
        if (a) {
            a.setMessage(b)
        } else {
            a = Ext.widget('loadmask', {
                message: b
            })
        }
        return a
    },
    backAllFloated: function () {
        Ext.each((Ext.floatRoot || Ext).query('.x-floated:not(.x-tooltip):not(.not-backable)'), function (b, c) {
            var a = Ext.getCmp(b.id);
            if (a) {
                a.hide()
            }
        })
    },
    backOneFloating: function () {
        var a = !1;
        Ext.each((Ext.floatRoot || Ext).query('.x-floated:not(.x-tooltip)'), function (c, d) {
            var b = Ext.getCmp(c.id);
            if (b) {
                if (b.onBack) {
                    b.onBack()
                } else {
                    b.hide()
                }
                a = !0;
                return !1
            }
        });
        return a
    },
    hasXType: function (a) {
        return Ext.ClassManager.maps.aliasToName.hasOwnProperty('widget.' + a)
    },
    getCmp: function (c, a) {
        if (a === undefined) {
            a = !0
        }
        var b = Ext.ComponentQuery.query(c + (a ? '(true)' : ''));
        return b.length >= 1 ? b[0] : null
    },
    getAncestor: function (c, b) {
        var a = c;
        while (!(a instanceof b)) {
            if (a) {
                a = a.getParent()
            } else {
                break
            }
        }
        return a
    },
    isUrl: function (a) {
        return this.regex.url.test(a)
    },
    encodeHtml: function (a, b) {
        return Ext.isEmpty(a) ? '' : Ext.htmlEncode(a.substr(0, b)).replace(/\r?\n/g, '&nbsp;&nbsp;')
    },
    htmlEncode: function (a) {
        return Ext.isEmpty(a) ? '' : Ext.util.Format.nl2br(Ext.htmlEncode(a))
    },
    htmlToText: function (c) {
        var a = document.createElement('div');
        a.innerHTML = c;
        var b = a.textContent;
        return b
    },
    hashCode: function (c) {
        if (!c) {
            return null
        }
        var a = 0,
            b, d, e;
        if (!c.length) {
            return a
        }
        for (b = 0, e = c.length; b < e; b++) {
            d = c.charCodeAt(b);
            a = (a << 5) - a + d;
            a |= 0
        }
        return a
    },
    copy: function (f, d) {
        if (Ext.isEmpty(f) && Ext.isEmpty(d)) {
            return
        }
        var a = this;
        var c = arguments;
        if (window.clipboard) {
            a.doCopy.apply(a, c)
        } else {
            var b = 'clipboardlibsloaded';
            if (!RM.isDefined(b)) {
                var e = Ext.getResourcePath('UEditor/', 'shared', 'MX');
                var g = Ext.manifest.version;
                RM.load(e + 'third-party/clipboard-polyfill.js?v=' + g, b)
            }
            RM.ready(b, {
                success: function () {
                    a.doCopy.apply(a, c)
                }
            })
        }
    },
    count: 0,
    doCopy: function (c, b) {
        var a = new clipboard.DT();
        if (!Ext.isEmpty(c)) {
            a.setData('text/plain', c)
        }
        if (!Ext.isEmpty(b)) {
            a.setData('text/html', b)
        }
        clipboard.write(a).then(function () {
            Utils.toastShort('已复制')
        }, function (a) {
            Utils.toastShort('复制失败, 请重试')
        })
    },
    stripQuestionMark: function (a) {
        if (!Ext.isEmpty(a)) {
            if (a[0] == '?') {
                return a.substr(1)
            }
        }
        return a
    },
    stripQueryStr: function (a) {
        if (!Ext.isEmpty(a)) {
            var b = a.lastIndexOf('?');
            if (b >= 0) {
                return a.substring(0, b)
            }
        }
        return a
    },
    treeify: function (d, e, i, k) {
        if (!d || !d.length) {
            return []
        }
        var j = this;
        var f = [];
        var b;
        var c = {};
        var g = $jscomp.makeIterator(d),
            a = g.next();
        for (; !a.done; c = {
                curId: c.curId,
                curPId: c.curPId
            }, a = g.next()) {
            b = a.value; {
                c.curId = b[e];
                c.curPId = b[i];
                var l = j.findChildrenBy(d, function (a) {
                    return function (b) {
                        return b[e] != a.curId && b[e] == a.curPId
                    }
                }(c));
                if (!l.length) {
                    b.expanded = !!k;
                    f.push(b)
                }
            }
        }
        for (var h = $jscomp.makeIterator(f), a = h.next(); !a.done; a = h.next()) {
            b = a.value; {
                j.doTreeify(b, d, e, i)
            }
        }
        return f
    },
    doTreeify: function (c, h, a, g) {
        var i = this;
        var b = i.findChildrenBy(h, function (b) {
            return b[a] != c[a] && b[g] == c[a]
        });
        if (b.length) {
            c.children = b
        }
        c.leaf = !b.length;
        var f;
        for (var e = $jscomp.makeIterator(b), d = e.next(); !d.done; d = e.next()) {
            f = d.value; {
                i.doTreeify(f, h, a, g)
            }
        }
    },
    findChildrenBy: function (e, f) {
        var d = [];
        var b;
        for (var c = $jscomp.makeIterator(e), a = c.next(); !a.done; a = c.next()) {
            b = a.value; {
                if (f(b)) {
                    d.push(b)
                }
            }
        }
        return d
    },
    validateFields: function (e, g) {
        var d = [];
        var b, f, a, c;
        for (b = 0, f = e.length; b < f; b++) {
            a = e[b];
            if (!a.validate(g)) {
                c = a.getError();
                if (c) {
                    d.push({
                        errors: c,
                        name: a.getLabel() || a.desc || a.getPlaceholder() || a.getName()
                    })
                }
            }
        }
        return d
    },
    clearFileInput: function (a) {
        var b = document.createElement('form');
        document.body.appendChild(b);
        var d = a.nextSibling,
            c = a.previousSibling,
            f = a.parentNode;
        b.appendChild(a);
        b.reset();
        if (d) {
            d.parentNode.insertBefore(a, d)
        } else {
            if (c) {
                var e = c.parentNode;
                if (e.lastChild === c) {
                    e.appendChild(a)
                } else {
                    e.insertBefore(a, c.nextSibling)
                }
            } else {
                if (f) {
                    f.appendChild(a)
                }
            }
        }
        document.body.removeChild(b)
    },
    uuid: function () {
        var a = 0;
        return function (d) {
            var c = (new Date()).getTime().toString(32),
                b;
            for (b = 0; b < 5; b++) {
                c += Math.floor(Math.random() * 65535).toString(32)
            }
            return (d || '') + c + (a++).toString(32)
        }
    }(),
    showKeyboard: function () {
        if (Ext.os.is.Android && window.Keyboard && Keyboard.show) {
            Keyboard.show()
        }
    },
    JsExpStyle: function (values, expList, colorList, strikeoutList) {
        var result = '';
        for (var i = expList.length - 1; i >= 0; i--) {
            try {
                var temp = eval(expList[i]);
                if (temp == !0) {
                    result += 'color:' + colorList[i] + ';';
                    if (strikeoutList[i] == !0) {
                        result += 'text-decoration:line-through;'
                    }
                    break
                }
            } catch (b) {}
        }
        return result
    },
    parseAttachXml: function (d) {
        if (Ext.isEmpty(d)) {
            return []
        }
        if (!Ext.isString(d)) {
            return d
        }
        try {
            var q = new DOMParser(),
                o = q.parseFromString(d, 'text/xml'),
                b = o.getElementsByTagName('Att'),
                g = [];
            for (var a = 0; a < b.length; a++) {
                var m = b[a].getElementsByTagName('ID'),
                    s = m.length > 0 ? m[0].textContent : '',
                    j = b[a].getElementsByTagName('FileName'),
                    n = j.length > 0 ? j[0].textContent : '',
                    l = b[a].getElementsByTagName('FilePath'),
                    r = l.length > 0 ? l[0].textContent : '',
                    i = b[a].getElementsByTagName('AttType'),
                    c = i.length > 0 ? i[0].textContent : '',
                    e = b[a].getElementsByTagName('Size'),
                    k = e.length > 0 ? e[0].textContent : '',
                    h = b[a].getElementsByTagName('OpDate'),
                    t = h.length > 0 ? h[0].textContent : '',
                    f = b[a].getElementsByTagName('UserText'),
                    p = f.length > 0 ? f[0].textContent : '';
                c = Ext.isEmpty(c) ? 'F' : c;
                g.push({
                    DocID: s,
                    DocName: n,
                    AttType: c,
                    IconFile: c == 'I' ? 'pdf' : FileUtil.getExtension(n),
                    FullPath: r,
                    DocSize: Ext.isEmpty(k) ? 0 : parseInt(k, 10),
                    OpDate: t,
                    AnnexUserText: p
                })
            }
            return g
        } catch (u) {
            return Ext.decode(d)
        }
    },
    openAttachList: function (e, f) {
        var c = this.parseAttachXml(e);
        console.log('openAttachList', c);
        if (c.length == 0) {
            return
        }
        var b, d = Ext.ComponentQuery.query('attachlist#displayattachlist'),
            a;
        if (!Config.isPC) {
            b = Ext.Viewport.lookup('IMMobile')
        }
        if (!b) {
            return
        }
        if (d.length > 0) {
            a = d[0]
        } else {
            a = Ext.widget('attachlist', {
                itemId: 'displayattachlist'
            });
            a.on({
                popview: function (a) {
                    a.getStore().clearData()
                }
            })
        }
        a.getStore().setData(c);
        b.push(a)
    },
    jsFormat: function (b, d, e) {
        if (!Ext.isEmpty(b)) {
            var c = '0,000.';
            while (d > 0) {
                c += '0';
                d--
            }
            var a = this.FormatNum(b, c);
            if (e != 'Money') {
                while (a[a.length - 1] == '0') {
                    a = a.substr(0, a.length - 1)
                }
                if (a[a.length - 1] == '.') {
                    a = a.substr(0, a.length - 1)
                }
            }
            return a
        }
        return ''
    },
    FormatNum: function (b, c) {
        var k, m, j, d, f, e, o, l, n, g, i, h, a;
        if (!c) {
            return b
        }
        b = Ext.Number.from(b, NaN);
        if (isNaN(b)) {
            return ''
        }
        m = ',';
        j = '.';
        o = !1;
        i = b < 0;
        f = void 0;
        a = void 0;
        b = Math.abs(b);
        if (c.substr(c.length - 2) === '/i') {
            c = c.substr(0, c.length - 2);
            o = !0;
            f = c.indexOf(m) !== -1;
            a = c.replace(/[^\d\.]/g, '').split(j)
        } else {
            f = c.indexOf(',') !== -1;
            a = c.replace(/[^\d\.]/g, '').split('.')
        }
        if (1 < a.length) {
            b = b.toFixed(a[1].length)
        } else {
            if (2 < a.length) {
                Ext.Error.raise({
                    sourceClass: 'Ext.util.Format',
                    sourceMethod: 'number',
                    value: b,
                    formatString: c,
                    msg: 'Invalid number format, should have no more than 1 decimal'
                })
            } else {
                b = b.toFixed(0)
            }
        }
        d = b.toString();
        a = d.split('.');
        if (f) {
            k = a[0];
            h = [];
            l = k.length;
            n = Math.floor(l / 3);
            g = k.length % 3 || 3;
            e = void 0;
            e = 0;
            while (e < l) {
                if (e !== 0) {
                    g = 3
                }
                h[h.length] = k.substr(e, g);
                n -= 1;
                e += g
            }
            d = h.join(m);
            if (a[1]) {
                d += j + a[1]
            }
        } else {
            if (a[1]) {
                d = a[0] + j + a[1]
            }
        }
        if (i) {
            i = d.replace(/[^1-9]/g, '') !== ''
        }
        return (i ? '-' : '') + c.replace(/[\d,?\.?]+/, d)
    },
    ensureBaiduMapLib: function (a) {
        if (window.BMap) {
            return Promise.resolve()
        }
        return new Promise(function (d, e) {
            var b = 'baidumaplibloaded';
            if (!RM.isDefined(b)) {
                var c = window.location.protocol == 'https:';
                if (c) {
                    window.HOST_TYPE = 2
                }
                RM.load(['http' + (c ? 's' : '') + '://api.map.baidu.com/getscript?v=3.0&ak=' + a + (c ? '&s=1' : '')], b)
            }
            RM.ready(b, {
                success: function () {
                    d()
                },
                error: function () {
                    e()
                }
            })
        })
    },
    isCEF: function () {
        return !!window.cef
    },
    getDeviceID: function () {
        if (window.Cordova && window.device) {
            return device.uuid
        } else {
            if (Utils.isCEF()) {
                return window.cef.getDeviceID()
            }
        }
        var a = Utils.getLsItem('deviceuuid');
        if (!Utils.getLsItem('deviceuuid')) {
            a = 'web_' + Utils.uuid();
            Utils.setLsItem('deviceuuid', a)
        }
        return a
    },
    getAio8Agent: function () {
        return {
            UserID: User.ownerID,
            DeviceID: Utils.getDeviceID(),
            ClientID: 'WorktopClient',
            ClientVersion: 'v' + Ext.util.Format.date(new Date(), 'ymd'),
            ClientAppID: 'AIO8WorktopClient'
        }
    }
}, 0, 0, 0, 0, 0, 0, [MX.util, 'Utils', 0, 'Utils'], 0);
Ext.cmd.derive('MX.util.FileUtil', Ext.Base, {
    alternateClassName: 'FileUtil',
    singleton: !0,
    imageFilter: {
        title: '图片文件',
        extensions: 'jpg,jpeg,gif,png,bmp,webp'
    },
    videoFilter: {
        title: '适配文件',
        extensions: 'mp4,mpg,mpeg,avi,mov,ogv,webm'
    },
    archiveFilter: {
        title: '压缩文件',
        extensions: 'rar,zip,7z'
    },
    docFilter: {
        title: '文档',
        extensions: 'doc,docx,ppt,pptx,xls,xlsx,txt,rtf,pdf'
    },
    otherFilter: {
        title: '其它文件',
        extensions: 'xsd,cer,pi,chm,xml,sql'
    },
    isImgExtension: function (a) {
        if (!a) {
            return !1
        }
        return this.imageFilter.extensions.indexOf(a.toLowerCase()) >= 0
    },
    isDocExtension: function (a) {
        if (!a) {
            return !1
        }
        return 'doc,docx,ppt,pptx,xls,xlsx,pdf'.indexOf(a.toLowerCase()) >= 0
    },
    isArchiveExtension: function (a) {
        if (!a) {
            return !1
        }
        return this.archiveFilter.extensions.indexOf(a.toLowerCase()) >= 0
    },
    isFileUri: function (a) {
        if (Ext.isEmpty(a)) {
            return !1
        }
        return a.substr(0, 7).toLowerCase() == 'file://'
    },
    splitPath: function (c) {
        var d = '',
            a = '',
            b = c.lastIndexOf('/');
        if (b == -1) {
            a = c
        } else {
            d = c.substr(0, b);
            a = c.substr(b + 1)
        }
        b = a.indexOf('?');
        if (b >= 0) {
            a = a.substr(0, b)
        }
        return [d, this.stripIllegalChars(a)]
    },
    getFileName: function (a) {
        if (!a) {
            return ''
        }
        return this.splitPath(a)[1]
    },
    getFileNameWoExt: function (b) {
        if (!b) {
            return ''
        }
        var a = this.splitPath(b);
        var c = a[1].lastIndexOf('.');
        if (c < 0) {
            return a[1]
        }
        return a[1].substr(0, c)
    },
    getExtension: function (a, e) {
        if (!a) {
            return ''
        }
        var b = this.splitPath(a);
        var d = b[1].lastIndexOf('.');
        if (d < 0) {
            return ''
        }
        var c = b[1].substr(d + 1);
        return e ? c.toLowerCase() : c
    },
    stripIllegalChars: function (a) {
        if (Ext.isEmpty(a)) {
            return a
        }
        return a.replace(/[\\\\/:*?"<>|]/g, '_')
    },
    getMIMEIcon: function (a) {
        var b = this;
        a = (a || '').toLowerCase();
        if (['rtf', 'doc', 'docx'].indexOf(a) >= 0) {
            return 'x-fa fa-file-word-o'
        }
        if (['xls', 'xlsx'].indexOf(a) >= 0) {
            return 'x-fa fa-file-excel-o'
        }
        if (['ppt', 'pptx'].indexOf(a) >= 0) {
            return 'x-fa fa-file-powerpoint-o'
        }
        if (['wav', 'mp3', 'wma', 'acc', 'ogg'].indexOf(a) >= 0) {
            return 'x-fa fa-file-sound-o'
        }
        if (['avi', 'mp4', 'avi', 'mkv', 'mov', 'flv'].indexOf(a) >= 0) {
            return 'x-fa fa-file-movie-o'
        }
        if (b.isImgExtension(a)) {
            return 'x-fa fa-file-photo-o'
        }
        if (b.isArchiveExtension(a)) {
            return 'x-fa fa-file-zip-o'
        }
        if (a == 'pdf') {
            return 'x-fa fa-file-pdf-o'
        }
        if (a == 'txt') {
            return 'x-fa fa-file-text-o'
        }
        return 'x-fa fa-file-o'
    },
    ensurePlUploadlibs: function (e) {
        var c = 'pluploadlibsloaded';
        if (!RM.isDefined(c)) {
            var a = Ext.getResourcePath('libs/plupload/', 'shared', null);
            var f = Ext.manifest.env == 'development';
            var g = navigator.language || navigator.systemLanguage || navigator.userLanguage;
            var b = Ext.manifest.version;
            var d = f ? [a + 'moxie.js?v=' + b, a + 'plupload.dev.js?v=' + b] : [a + 'plupload.full.min.js?v=' + b];
            if (g == 'zh-CN') {
                d.push(a + 'i18n/zh_CN.js?v=' + b)
            }
            RM.load(d, c, {
                async: !1
            })
        }
        RM.ready(c, {
            success: function () {
                e()
            }
        })
    }
}, 0, 0, 0, 0, 0, 0, [MX.util, 'FileUtil', 0, 'FileUtil'], 0);
Ext.cmd.derive('MX.util.FileMgr', Ext.Base, {
    alternateClassName: 'FileMgr',
    singleton: !0,
    downMap: {},
    downFile: function (c, e, d, b) {
        var a = this;
        return new Ext.Promise(function (p, r) {
            var s = !!(b && b.force),
                j = FSUtil.parse(e, d),
                k = j.relative,
                o = FileUtil.splitPath(k),
                q = o[0],
                m = o[1],
                f = 'queues' + j.root,
                g = k,
                h = a[f][g];
            if (!h) {
                h = a[f][g] = [];
                var n = function (k, h) {
                    h = h === undefined ? !1 : h;
                    var i = a[f][g];
                    if (i) {
                        while (i.length) {
                            var j = i.shift();
                            if (j.resolve) {
                                j.resolve({
                                    path: k.toURL(),
                                    alreadyExists: h
                                })
                            }
                        }
                        delete a[f][g]
                    }
                    delete a.downMap[c]
                };
                var i = function (j) {
                    var h = a[f][g];
                    if (h) {
                        while (h.length) {
                            var i = h.shift();
                            if (i.reject) {
                                i.reject(j)
                            }
                        }
                        delete a[f][g]
                    }
                    delete a.downMap[c]
                };
                var l = function (j) {
                    var h = new FileTransfer();
                    h.onprogress = function (h) {
                        if (h.lengthComputable) {
                            var k = (h.loaded / h.total * 100).toFixed(2);
                            var i = a[f][g];
                            if (i && i.length) {
                                i.forEach(function (a) {
                                    if (a.downloading) {
                                        a.downloading(k)
                                    }
                                })
                            }
                        }
                    };
                    h.download(c, j, n, i);
                    a.downMap[c] = h
                };
                DirMgr.create(j.root, q).then(function (f) {
                    var a = f.toURL() + encodeURIComponent(m);
                    if (s) {
                        l(a)
                    } else {
                        f.getFile(m, {
                            create: !1
                        }, function (a) {
                            n(a, !0)
                        }, function (g) {
                            if (g.code == 1) {
                                l(a)
                            } else {
                                i(g)
                            }
                        })
                    }
                })['catch'](i)
            }
            h.push({
                resolve: p,
                reject: r,
                downloading: b && Ext.isFunction(b.downloading) ? b.downloading : null
            })
        })
    },
    abortDownFile: function (b) {
        var c = this;
        if (c.downMap.hasOwnProperty(b)) {
            var a = c.downMap[b];
            if (a && a instanceof FileTransfer) {
                a.abort()
            }
        }
    },
    downFileForSrc: function (g, e, d, c) {
        var a = this;
        var f = arguments;
        var b = FSUtil.parse(e, d);
        if (Ext.browser.is.Cordova && Ext.os.is.iOS && window.indexedDB && b.root !== 0) {
            return new Ext.Promise(function (n, o) {
                var f = 'srcQueues' + b.root,
                    i = b.relative,
                    l = a[f][i];
                if (!l) {
                    l = a[f][i] = [];
                    var k = function (k, b) {
                        b = b === undefined ? !1 : b;
                        var h = a[f][i];
                        if (h) {
                            while (h.length) {
                                var j = h.shift();
                                if (j.resolve) {
                                    j.resolve({
                                        path: k,
                                        alreadyExists: b
                                    })
                                }
                            }
                            delete a[f][i]
                        }
                    };
                    var h = function (j) {
                        var b = a[f][i];
                        if (b) {
                            while (b.length) {
                                var h = b.shift();
                                if (h.reject) {
                                    h.reject(j)
                                }
                            }
                            delete a[f][i]
                        }
                    };
                    var m = !!(c && c.force);
                    var j = function () {
                        a.downFile(g, b.root, b.relative, {
                            force: m,
                            downloading: function (h) {
                                var b = a[f][i];
                                if (b && b.length) {
                                    b.forEach(function (a) {
                                        if (a.downloading) {
                                            a.downloading(h)
                                        }
                                    })
                                }
                            }
                        }).then(function (f) {
                            return a.copyTo(b.root, f.path, 0, b.relative).then(function (a) {
                                k(a, f.alreadyExists)
                            })['catch'](h)
                        })['catch'](h)
                    };
                    if (m) {
                        j()
                    } else {
                        a.exists(1, b.relative).then(function (f) {
                            if (f) {
                                var i = f.toURL();
                                a.exists(0, b.relative).then(function (j) {
                                    if (j) {
                                        var l = j.toURL();
                                        k(l, !0)
                                    } else {
                                        return a.copyTo(1, i, 0, b.relative).then(function (a) {
                                            k(a, !0)
                                        })['catch'](h)
                                    }
                                })['catch'](h)
                            } else {
                                a.exists(0, b.relative).then(function (i) {
                                    if (i) {
                                        a.remove(0, b.relative).then(function () {
                                            j()
                                        })['catch'](h)
                                    } else {
                                        j()
                                    }
                                })['catch'](h)
                            }
                        })['catch'](h)
                    }
                }
                l.push({
                    resolve: n,
                    reject: o,
                    downloading: c && Ext.isFunction(c.downloading) ? c.downloading : null
                })
            })
        }
        return a.downFile.apply(a, f)
    },
    remove: function (b, a) {
        var c = this;
        return new Ext.Promise(function (d, g) {
            var c = function (c) {
                g(c)
            };
            if (Ext.isEmpty(a)) {
                c('路径为空')
            }
            if (FileUtil.isFileUri(a)) {
                window.resolveLocalFileSystemURL(a, function (e) {
                    e.remove(d, c)
                }, c)
            } else {
                var e = FSUtil.parse(b, a),
                    f = e.relative;
                FSUtil['load' + e.root]().then(function (e) {
                    e.root.getFile(f, {
                        create: !1,
                        exclusive: !1
                    }, function (f) {
                        f.remove(d, c)
                    }, c)
                })['catch'](c)
            }
        })
    },
    exists: function (c, a, b) {
        var d = this;
        return new Ext.Promise(function (d, e) {
            var f = function (f) {
                e(f)
            };
            if (Ext.isEmpty(a)) {
                f('路径为空')
            }
            var g = FSUtil.parse(c, a),
                h = g.relative;
            FSUtil['load' + g.root]().then(function (f) {
                f.root[b ? 'getDirectory' : 'getFile'](h, {
                    create: !1
                }, d, function (g) {
                    if (g.code == 1) {
                        d(null)
                    } else {
                        e(g)
                    }
                })
            })['catch'](f)
        })
    },
    moveTo: function (b, a, d, c) {
        return new Ext.Promise(function (e, f) {
            FSUtil.copyOrMove(b, a, d, c, 1, !0, e, f)
        })
    },
    copyTo: function (b, a, d, c) {
        return new Ext.Promise(function (e, f) {
            FSUtil.copyOrMove(b, a, d, c, 1, !1, e, f)
        })
    },
    solveDup: function (d, b, a) {
        var c = this;
        return new Ext.Promise(function (f, i) {
            var e = function (c) {
                i(c)
            };
            if (FileUtil.isFileUri(b)) {
                c.exists(1, b, !0).then(function (g) {
                    if (g) {
                        window.resolveLocalFileSystemURL(b, function (h) {
                            var e = FileUtil.getFileNameWoExt(a),
                                j = FileUtil.getExtension(a);
                            c._solveDup(h, e, j, 0, f)
                        }, e)
                    } else {
                        DirMgr.create(1, b).then(function () {
                            window.resolveLocalFileSystemURL(b, function (h) {
                                var e = FileUtil.getFileNameWoExt(a),
                                    j = FileUtil.getExtension(a);
                                c._solveDup(h, e, j, 0, f)
                            }, e)
                        })
                    }
                })
            } else {
                var g = FSUtil.parse(d, b),
                    h = g.relative;
                FSUtil['load' + g.root]().then(function (g) {
                    g.root.getDirectory(h, {
                        create: !1
                    }, function (h) {
                        var e = FileUtil.getFileNameWoExt(a),
                            j = FileUtil.getExtension(a);
                        c._solveDup(h, e, j, 0, f)
                    }, e)
                })['catch'](e)
            }
        })
    },
    open: function (a) {
        var b = this;
        return new Ext.Promise(function (c, e) {
            if (a) {
                var b = a;
                if (window.FileEntry && a instanceof window.FileEntry) {
                    b = a.toURL()
                }
                if (window.plugins && plugins.fileOpener) {
                    plugins.fileOpener.open(b, c, function (b) {
                        e(b);
                        Utils.toastShort(b.message || '')
                    })
                } else {
                    if (Config.isPC) {
                        var d = Utils.getApp().getCefObj();
                        if (d) {
                            b = ParseUtil.getAbsolutePath(b);
                            d.open(b, c, function (b) {
                                e(b);
                                Utils.toastShort(b || '')
                            })
                        }
                    }
                }
            }
        })
    },
    saveAs: function (a, b) {
        if (Ext.isEmpty(a)) {
            return
        }
        if (Config.isPC) {
            var c = Utils.getApp().getCefObj();
            a = ParseUtil.getAbsolutePath(a);
            c.saveAs(a, b, Ext.emptyFn, function (c) {
                Utils.toastShort(c || '')
            })
        }
    },
    openFolder: function (a) {
        if (Ext.isEmpty(a)) {
            return
        }
        if (Config.isDesktop) {
            a = ParseUtil.getAbsolutePath(a);
            var b = Utils.getApp().getCefObj();
            b.openFolder(a, Ext.emptyFn, function (b) {
                Utils.toastShort(b || '')
            })
        }
    },
    openErpLink: function (d, a, b) {
        if (Config.isDesktop) {
            var c = Utils.getApp().getCefObj();
            c.openLink(d, a, b)
        }
    },
    share: function (a) {
        return new Ext.Promise(function (d, e) {
            if (window.plugins && plugins.socialsharing) {
                var b = Ext.isString(a) ? [a] : Ext.isArray(a) ? a : [];
                b = b.filter(function (b) {
                    return !Ext.isEmpty(b)
                });
                if (!b.length) {
                    return
                }
                var c = {
                    subject: '文件: ' + FileUtil.getFileName(b[0]) + (b.length > 1 ? ' 等' : ''),
                    files: b
                };
                plugins.socialsharing.shareWithOptions(c, function (b) {
                    d(b)
                }, function (b) {
                    e(b)
                })
            }
        })
    },
    chooseFiles: function () {
        return new Ext.Promise(function (a, b) {
            if (Config.isDesktop) {
                Utils.getApp().getCefObj().selectFiles(function (c) {
                    a(c)
                })
            } else {
                if (Ext.browser.is.Cordova) {
                    if (Ext.os.is.Android && window.fileChooser) {
                        fileChooser.open(function (c) {
                            if (!FileUtil.isFileUri(c)) {
                                a(['file://' + c])
                            }
                        }, b)
                    } else {
                        if (Ext.os.is.iOS && window.FilePicker) {
                            FilePicker.pickFile(function (c) {
                                if (!FileUtil.isFileUri(c)) {
                                    a(['file://' + c])
                                }
                            }, b)
                        }
                    }
                }
            }
        })
    },
    getFileSize: function (a) {
        return new Ext.Promise(function (d, b) {
            if (!Ext.isEmpty(a)) {
                var c = FileUtil.isFileUri(a) ? a : 'file://' + a;
                window.resolveLocalFileSystemURL(c, function (c) {
                    c.getMetadata(function (e) {
                        d(e.size)
                    }, function (e) {
                        b(e.code ? FSUtil.FILEERROR[e.code] : e)
                    })
                }, function (c) {
                    b(c.code ? FSUtil.FILEERROR[c.code] : c)
                })
            }
        })
    },
    privates: {
        queues0: {},
        queues1: {},
        srcQueues0: {},
        srcQueues1: {},
        _solveDup: function (a, f, e, d, c) {
            var g = this,
                b = f + (d == 0 ? '.' : ' (' + d + ').') + e;
            if (a.getFile) {
                a.getFile(b, {
                    create: !1
                }, function (b) {
                    g._solveDup(a, f, e, d + 1, c)
                }, function () {
                    c(b)
                })
            } else {
                c(b)
            }
        }
    }
}, 0, 0, 0, 0, 0, 0, [MX.util, 'FileMgr', 0, 'FileMgr'], 0);
Ext.cmd.derive('MX.util.ImgUtil', Ext.Base, {
    singleton: !0,
    alternateClassName: 'ImgUtil',
    onePxImg: 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7',
    createHolder: function (b, a) {
        var d = '<svg xmlns="http://www.w3.org/2000/svg" width="' + b + '" height="' + a + '" viewBox="0 0 ' + b + ' ' + a + '" preserveAspectRatio="none"></svg>';
        var c = 'data:image/svg+xml;charset=UTF-8;base64,';
        return c + btoa(unescape(encodeURIComponent(d)))
    },
    isImgExtension: function (a) {
        return FileUtil.isImgExtension(a)
    },
    getImageDataURL: function (c, a, b, e) {
        if (!c.type.match(/image.+/)) {
            Utils.toastShort('只能选择图片文件');
            return
        }
        var d = new FileReader();
        d.onload = function (f) {
            if (a > 0) {
                var d = new Image();
                d.onload = function () {
                    var g = document.createElement('canvas');
                    if (d.height > a) {
                        d.width *= a / d.height;
                        d.height = a
                    }
                    var h = g.getContext('2d');
                    h.clearRect(0, 0, g.width, g.height);
                    g.width = d.width;
                    g.height = d.height;
                    h.drawImage(d, 0, 0, d.width, d.height);
                    b.call(e, g.toDataURL('image/jpeg', 0.7))
                };
                d.src = f.target.result
            } else {
                b.call(e, f.target.result)
            }
        };
        d.readAsDataURL(c)
    },
    viewImgs: function (b, f) {
        if (!b) {
            return
        }
        var h = this;
        var a = 'viewerjslibsloaded';
        if (!RM.isDefined(a)) {
            var c = Ext.getResourcePath('viewerjs/', 'shared', 'MX');
            var g = Ext.manifest.env == 'development';
            var d = g ? '' : '.min';
            var e = Ext.manifest.version;
            RM.load([c + 'viewer' + d + '.css?v=' + e, c + 'viewer' + d + '.js?v=' + e], a)
        }
        RM.ready(a, {
            success: function () {
                h.doViewImgs(b, f)
            }
        })
    },
    doViewImgs: function (a, b) {
        if (a.isComponent) {
            a = a.element.dom
        } else {
            if (a.isElement) {
                a = a.dom
            } else {
                if (Ext.isString(a)) {
                    var c = document.createElement('img');
                    c.setAttribute('data-original', a);
                    c.src = ImgUtil.onePxImg;
                    c.alt = FileUtil.getFileName(a);
                    a = c
                }
            }
        }
        var d = new Viewer(a, Ext.apply({
            url: 'data-original',
            zIndex: 2000000,
            zoomRatio: 0.25,
            transition: !1,
            toolbar: {
                download: !0,
                oneToOne: !0,
                zoomIn: !0,
                zoomOut: !0,
                rotateLeft: !0,
                rotateRight: !0
            },
            hide: function () {
                d.destroy()
            }
        }, b));
        if (b && b.initialIndex) {
            d.view(b.initialIndex)
        } else {
            d.show()
        }
    },
    dataURLtoBlob: function (e) {
        var d = e.split(','),
            f = d[0].match(/:(.*?);/)[1],
            c = atob(d[1]),
            a = c.length,
            b = new Uint8Array(a);
        while (a--) {
            b[a] = c.charCodeAt(a)
        }
        return new Blob([b], {
            type: f
        })
    }
}, 0, 0, 0, 0, 0, 0, [MX.util, 'ImgUtil', 0, 'ImgUtil'], 0);
Ext.cmd.derive('MX.utils.ResourceMgr', Ext.Base, function () {
    var a = function () {},
        c = {},
        d = {},
        b = {};
    var h = function (a, k) {
        a = a.push ? a : [a];
        var h = [],
            f = a.length,
            i = f,
            e, c, g, j;
        e = function (c, b) {
            if (b.length) {
                h.push(c)
            }
            i--;
            if (!i) {
                k(h)
            }
        };
        while (f--) {
            c = a[f];
            g = d[c];
            if (g) {
                e(c, g);
                continue
            }
            j = b[c] = b[c] || [];
            j.push(e)
        }
    };
    var f = function (a, e) {
        if (!a) {
            return
        }
        var c = b[a];
        d[a] = e;
        if (!c) {
            return
        }
        while (c.length) {
            c[0](a, e);
            c.splice(0, 1)
        }
    };
    var e = function (c, h, f, d) {
        var g = document,
            i = f.async,
            l = (f.numRetries || 0) + 1,
            k = f.before || a,
            j, b;
        d = d || 0;
        if (/(^css!|\.css$|\.css?)/.test(c)) {
            j = !0;
            b = g.createElement('link');
            b.rel = 'stylesheet';
            b.href = c.replace(/^css!/, '')
        } else {
            b = g.createElement('script');
            b.src = c;
            b.async = i === undefined ? !0 : i
        }
        b.onload = b.onerror = b.onbeforeload = function (g) {
            var a = g.type[0];
            if (j && 'hideFocus' in b) {
                try {
                    if (!b.sheet.cssText.length) {
                        a = 'e'
                    }
                } catch (m) {
                    a = 'e'
                }
            }
            if (a == 'e') {
                d += 1;
                if (d < l) {
                    return e(c, h, f, d)
                }
            }
            h(c, a, g.defaultPrevented)
        };
        if (k(c, b) !== !1) {
            g.head.appendChild(b)
        }
    };
    var g = function (a, g, h) {
        a = a.push ? a : [a];
        var d = a.length,
            i = d,
            c = [],
            f, b;
        f = function (e, b, f) {
            if (b == 'e') {
                c.push(e)
            }
            if (b == 'b') {
                if (f) {
                    c.push(e)
                } else {
                    return
                }
            }
            d--;
            if (!d) {
                g(c)
            }
        };
        for (b = 0; b < i; b++) {
            e(a[b], f, h)
        }
    };
    return {
        singleton: !0,
        alternateClassName: 'RM',
        load: function (h, d, i) {
            var b, e;
            if (d && d.trim) {
                b = d
            }
            e = (b ? i : d) || {};
            if (b) {
                if (b in c) {
                    throw 'LoadJS'
                } else {
                    c[b] = !0
                }
            }
            g(h, function (c) {
                if (c.length) {
                    (e.error || a)(c)
                } else {
                    (e.success || a)()
                }
                f(b, c)
            }, e)
        },
        ready: function (c, b) {
            h(c, function (d) {
                if (d.length) {
                    (b.error || a)(d)
                } else {
                    (b.success || a)()
                }
            });
            return this
        },
        done: function (a) {
            f(a, [])
        },
        reset: function () {
            c = {};
            d = {};
            b = {}
        },
        isDefined: function (a) {
            return a in c
        }
    }
}(), 0, 0, 0, 0, 0, 0, [MX.utils, 'ResourceMgr', 0, 'RM'], 0);
Ext.cmd.derive('Common.field.comment.EmojiPanel', Ext.Panel, {
    statics: {
        emojis: ['😄', '😊', '🙂', '😆', '☺', '😉', '🤗', '😇', '😬', '😏', '😝', '😜', '😎', '😌', '😋', '😍', '😙', '😘', '😅', '😂', '😓', '😰', '😨', '😥', '😢', '🙄', '😵', '😲', '😳', '😤', '😖', '😕', '😒', '😣', '🤔', '😴', '😩', '😯', '😪', '😑', '😠', '😡', '🤑', '😫', '😞', '😧', '🤐', '😷', '😱', '😭', '😔', '☹', '😟', '👿', '😈', '🌚', '🙋🏻', '🙋🏻♂', '🙏', '✌', '💪', '👌', '👍', '👎', '👏', '💋', '❤', '💔', '🙊', '🙉', '🐷', '🐶', '🐮', '🐌', '👻', '🌈', '☀', '🌤', '🌦', '💐', '🌻', '🍀', '🎄', '🎁', '🎂', '🎉', '🍭', '🍗', '🍻', '🍉', '🍹', '🍦', '💊', '🍼', '🏆', '🎤', '🏓', '🏸', '🎸', '💰', '💣', '🕳', '💯', '🆘', '💩']
    },
    cls: 'emj-panel',
    width: 495,
    maxWidth: '100vw',
    height: 247,
    maxHeight: '100vh',
    floated: !0,
    bodyPadding: 15,
    hidden: !0,
    scrollable: !1,
    tpl: ['<ul class="faces">', '<tpl for=".">', '<li>', '{[window.minEmoji(values.ch, 24)]}', '</li>', '</tpl>', '</ul>', '<div style="clear:both"></div>'].join(''),
    initialize: function () {
        var a = this;
        var b = a.self.emojis.map(function (a) {
            return {
                ch: a
            }
        });
        Ext.Panel.prototype.initialize.apply(this, arguments);
        a.setData(b);
        a.element.on({
            delegate: 'img.emoji',
            tap: 'onTapEmj',
            scope: a
        });
        a.on({
            show: 'onShowPanel',
            hide: 'onHidePanel',
            scope: a
        })
    },
    onTapEmj: function (c, b) {
        var a = b.getAttribute('alt');
        this.fireEvent('ok', this, a);
        this.hide()
    },
    onShowPanel: function (b) {
        var a = this;
        a.touchListeners = Ext.getDoc().on({
            touchstart: a.collapseIf,
            scope: a,
            delegated: !1,
            destroyable: !0
        })
    },
    collapseIf: function (b) {
        var a = this;
        if (!a.destroyed && !a.owns(b.target)) {
            a.hide()
        }
    },
    onHidePanel: function (a) {
        Ext.destroy(this.touchListeners)
    },
    doDestroy: function () {
        Ext.destroy(this.touchListeners);
        Ext.Panel.prototype.doDestroy.call(this)
    }
}, 0, ['emojipanel'], ['widget', 'component', 'container', 'panel', 'emojipanel'], {
    'widget': !0,
    'component': !0,
    'container': !0,
    'panel': !0,
    'emojipanel': !0
}, ['widget.emojipanel'], 0, [Common.field.comment, 'EmojiPanel'], 0);
Ext.define(null, {
    override: 'Ext.Panel',
    config: {
        standardButtons: {
            ok: {
                weight: 120
            },
            abort: {
                weight: 110
            },
            retry: {
                weight: 100
            },
            ignore: {
                weight: 90
            },
            yes: {
                weight: 80
            },
            no: {
                weight: 70
            },
            cancel: {
                weight: 60
            },
            apply: {
                weight: 50
            },
            save: {
                weight: 40
            },
            submit: {
                weight: 30
            },
            help: {
                weight: 10
            },
            close: {
                weight: 20
            }
        }
    }
});
Ext.cmd.derive('IMCommon.enumType.ChatType', Ext.Base, {
    singleton: !0,
    alternateClassName: 'ChatType',
    Direct: 'D',
    Group: 'C',
    Multi: 'G',
    News: 'News'
}, 0, 0, 0, 0, 0, 0, [IMCommon.enumType, 'ChatType', 0, 'ChatType'], 0);
Ext.cmd.derive('IMCommon.enumType.MsgType', Ext.Base, {
    singleton: !0,
    alternateClassName: 'MsgType',
    TextMsg: 'T',
    ImgMsg: 'I',
    FileMsg: 'F',
    LinkErp: 'L',
    BigFileMsg: 'E',
    Revoke: 'B',
    GroupNotice: 'G',
    NotShow: 'R',
    AddMem: 'A',
    RePly: 'P',
    CrowdInFo: 'N'
}, 0, 0, 0, 0, 0, 0, [IMCommon.enumType, 'MsgType', 0, 'MsgType'], 0);
Ext.cmd.derive('IMCommon.enumType.MsgWrapperType', Ext.Base, {
    singleton: !0,
    alternateClassName: 'MsgWrapperType',
    Notice: 'notice',
    Message: 'message'
}, 0, 0, 0, 0, 0, 0, [IMCommon.enumType, 'MsgWrapperType', 0, 'MsgWrapperType'], 0);
Ext.cmd.derive('IMCommon.enumType.NoticeType', Ext.Base, {
    singleton: !0,
    alternateClassName: 'NoticeType',
    CreateGrp: 'G',
    AddMem: 'A',
    RemoveMem: 'R',
    ChgTitle: 'M',
    ChgManager: 'C',
    HisChange: 'H',
    FirstReply: 'P',
    CrowdSetAdmin: 'S',
    DismissMultiChat: 'D',
    RecoverMultiChat: 'V',
    JoinERPMultiChat: 'J'
}, 0, 0, 0, 0, 0, 0, [IMCommon.enumType, 'NoticeType', 0, 'NoticeType'], 0);
Ext.cmd.derive('IMCommon.enumType.SearchType', Ext.Base, {
    singleton: !0,
    alternateClassName: 'SearchType',
    SendName: 'sn',
    GroupName: 'gn',
    MsgRecord: 'mr',
    FileName: 'fn',
    Time: 'time'
}, 0, 0, 0, 0, 0, 0, [IMCommon.enumType, 'SearchType', 0, 'SearchType'], 0);
Ext.cmd.derive('IMCommon.enumType.SocketEventType', Ext.Base, {
    singleton: !0,
    alternateClassName: 'SocketEventType',
    hello: 'hello',
    posted: 'posted',
    createGrp: 'group_added',
    memAdd: 'members_added',
    memRemove: 'member_removed',
    chgManager: 'change_manager',
    updateChat: 'chat_updated',
    getFile: 'get_file',
    viewChat: 'view_chat',
    revoke: 'recall',
    getBigFile: 'update_bfile_status',
    updateMute: 'update_mute',
    updateNap: 'update_nap',
    viewAt: 'view_at',
    hisRange: 'chat_history_range',
    replied: 'replied',
    seeHis: 'chat_seehistory',
    news: 'news',
    crowdnotice: 'chat_updatecrowdinfo',
    crowdsetAdmin: 'chat_updatecrowdadmin',
    pushMail: 'push_mail',
    updateMailBadge: 'update_worktop_badge',
    pushApprove: 'push_approve',
    pushNotice: 'push_notice',
    pushCommon: 'push_common',
    updateRead: 'update_read',
    dismissMultiChat: 'dismiss',
    recoverMultiChat: 'recover',
    joinERPMultiChat: 'join_erp_chat'
}, 0, 0, 0, 0, 0, 0, [IMCommon.enumType, 'SocketEventType', 0, 'SocketEventType'], 0);
Ext.cmd.derive('IMCommon.enumType.StaticChatID', Ext.Base, {
    singleton: !0,
    alternateClassName: 'StaticChatID',
    News: 'newschatid'
}, 0, 0, 0, 0, 0, 0, [IMCommon.enumType, 'StaticChatID', 0, 'StaticChatID'], 0);
Ext.cmd.derive('IMCommon.local.ChatformSearch', Ext.Base, {
    singleton: !0,
    alternateClassName: 'ChatformSearch',
    selectChat: function (b, a) {
        var c = 'SELECT * From IMChat WHERE ChatID=?;';
        LocalDataMgr.cExecSqlWithP(c, [b], a)
    },
    beforeDoGrpChat: function (c, e, b, a) {
        var f = this,
            d = 'SELECT * From IMChat WHERE ChatID=?;';
        LocalDataMgr.cExecSqlWithP(d, [c], function (k, h) {
            var d = h.rows;
            if (d.length > 0) {
                var g = d.item(0);
                var j = g.UserIDs,
                    i = j.split(',');
                if (f.inThisChat(e, i)) {
                    b(g)
                } else {
                    a('对不起，您没有权限做此操作')
                }
            } else {
                a('对不起，您没有权限做此操作')
            }
        })
    },
    inThisChat: function (c, b) {
        for (var a = 0; a < b.length; a++) {
            if (c == b[a]) {
                return !0
            }
        }
        return !1
    },
    beforeDoDitChat: function (c, e, a, b) {
        var d = 'SELECT * FROM IMChat WHERE ChatID=?;';
        LocalDataMgr.cExecSqlWithP(d, [c], function (g, f) {
            var d = f.rows;
            if (d.length > 0) {
                a(d.item(0))
            } else {
                b('对不起，您所打开的会话已经不存在')
            }
        })
    },
    ditChatHeaderShowPD: function () {}
}, 0, 0, 0, 0, 0, 0, [IMCommon.local, 'ChatformSearch', 0, 'ChatformSearch'], 0);
Ext.cmd.derive('IMCommon.local.InitDb', Ext.Base, {
    alternateClassName: 'InitDb',
    singleton: !0,
    initDB: function (b) {
        var c = this;
        var a = LocalDataMgr.getDB();
        a.transaction(function (d) {
            d.executeSql('SELECT * FROM IMAdm', [], function (g, e) {
                if (e.rows.length == 0) {
                    c.execSQL(a, '0.0', b)
                } else {
                    var f = e.rows.item(0).Version;
                    c.execSQL(a, f, b)
                }
            }, function (f, e) {
                c.execSQL(a, '0.0', b)
            })
        })
    },
    execSQL: function (d, f, e) {
        var b = this;
        var g = f.split('.');
        if (g.length == 1) {
            f = g[0] + '.0'
        }
        var a = [],
            c = '';
        switch (f) {
            case '0.0':
                a = b.getV0_0();
                b.doExecSQL(d, a);
                c = '1.0';
            case '1.0':
                a = b.getV1_0();
                b.doExecSQL(d, a);
                c = '2.0';
            case '2.0':
                a = b.getV2_0();
                b.doExecSQL(d, a);
                c = '3.0';
            case '3.0':
                a = b.getV3_0();
                b.doExecSQL(d, a);
                c = '4.0';
            case '4.0':
                a = b.getV4_0();
                b.doExecSQL(d, a);
                c = '5.0';
            case '5.0':
                a = b.getV5_0();
                b.doExecSQL(d, a);
                c = '6.0';
            case '6.0':
                a = b.getV6_0();
                b.doExecSQL(d, a);
                c = '7.0';
            case '7.0':
                a = b.getV7_0();
                b.doExecSQL(d, a);
                c = '8.0';
            case '8.0':
                a = b.getV8_0();
                b.doExecSQL(d, a);
                c = '9.0';
            case '9.0':
                a = b.getV9_0();
                b.doExecSQL(d, a);
                c = '10.0';
            case '10.0':
                a = b.getV10_0();
                b.doExecSQL(d, a);
                c = '11.0';
            case '11.0':
                a = b.getV11_0();
                b.doExecSQL(d, a);
                c = '12.0';
            case '12.0':
                a = b.getV12_0();
                b.doExecSQL(d, a);
                c = '13.0';
            case '13.0':
                a = b.getV13_0();
                b.doExecSQL(d, a);
                c = '14.0';
            case '14.0':
                a = b.getV14_0();
                b.doExecSQL(d, a);
                c = '15.0';
            case '15.0':
                c = '16.0';
            case '16.0':
                a = b.getV16_0();
                b.doExecSQL(d, a);
                c = '17.0';
            case '17.0':
                a = b.getV17_0();
                b.doExecSQL(d, a);
                c = '18.0';
            case '18.0':
                a = b.getV18_0();
                b.doExecSQL(d, a, e);
                c = '19.0';
            case '19.0':
                a = b.getV19_0();
                b.doExecSQL(d, a, e);
                c = '20.0';
            case '20.0':
                a = b.getV20_0();
                b.doExecSQL(d, a, e);
                c = '21.0';
            case '21.0':
                a = b.getV21_0();
                b.doExecSQL(d, a, e);
                c = '22.0';
            case '22.0':
                a = b.getV22_0();
                b.doExecSQL(d, a, e);
                c = '23.0';
            case '23.0':
                a = b.getV23_0();
                b.doExecSQL(d, a, e);
                c = '24.0';
            case '24.0':
                a = b.getV24_0();
                b.doExecSQL(d, a, e);
                c = '25.0';
            case '25.0':
                a = b.getV25_0();
                b.doExecSQL(d, a, e);
                c = '26.0';
            case '26.0':
                a = b.getV26_0();
                b.doExecSQL(d, a, e);
                c = '27.0';
            case '27.0':
                a = b.getV27_0();
                b.doExecSQL(d, a, e);
                c = '28.0';
            case '28.0':
                a = b.getV28_0();
                b.doExecSQL(d, a, e);
                c = '29.0';
            default:
                if (e) {
                    e()
                };
                break;
        }
        if (c) {
            LocalDataMgr.cExecSqlWithP('UPDATE IMAdm SET Version=?', [c])
        }
    },
    doExecSQL: function (c, b, a) {
        c.transaction(function (e) {
            for (var d = 0; d < b.length; d++) {
                e.executeSql(b[d], [])
            }
        }, function (d) {
            console.error('数据库初始化失败', d.message);
            if (a) {
                a()
            }
        }, function () {
            if (a) {
                a()
            }
        })
    },
    execSQL1: function (g, d, e) {
        var c = this;
        var f = d.split('.');
        if (f.length == 1) {
            d = f[0] + '.0'
        }
        var a = [],
            b = '';
        switch (d) {
            case '0.0':
                a = a.concat(c.getV0_0());
                b = '1.0';
            case '1.0':
                a = a.concat(c.getV1_0());
                b = '2.0';
            case '2.0':
                a = a.concat(c.getV2_0());
                b = '3.0';
            case '3.0':
                a = a.concat(c.getV3_0());
                b = '4.0';
            case '4.0':
                a = a.concat(c.getV4_0());
                b = '5.0';
            case '5.0':
                a = a.concat(c.getV5_0());
                b = '6.0';
            case '6.0':
                a = a.concat(c.getV6_0());
                b = '7.0';
            case '7.0':
                a = a.concat(c.getV7_0());
                b = '8.0';
            case '8.0':
                a = a.concat(c.getV8_0());
                b = '9.0';
            case '9.0':
                a = a.concat(c.getV9_0());
                b = '10.0';
            case '10.0':
                a = a.concat(c.getV10_0());
                b = '11.0';
            case '11.0':
                a = a.concat(c.getV11_0());
                b = '12.0';
            case '12.0':
                a = a.concat(c.getV12_0());
                b = '13.0';
            case '13.0':
                a = a.concat(c.getV13_0());
                b = '14.0';
            case '14.0':
                a = a.concat(c.getV14_0());
                b = '15.0';
            case '15.0':
                b = '16.0';
            case '16.0':
                a = a.concat(c.getV16_0());
                b = '17.0';
            case '17.0':
                a = a.concat(c.getV17_0());
                b = '18.0';
            case '18.0':
                a = a.concat(c.getV18_0());
                b = '19.0';
            default:
                break;
        }
        if (b) {
            a.push(c.getUpdateVer(b))
        }
        g.transaction(function (c) {
            for (var b = 0; b < a.length; b++) {
                c.executeSql(a[b], null, function (b, a) {}, function (h, f) {
                    console.log('Transaction ERROR: ' + f.message, a[b])
                })
            }
        }, function (a) {
            console.error('数据库初始化失败', a.message)
        }, function () {
            if (e) {
                e()
            }
        })
    },
    getUpdateVer: function (a) {
        var b = "UPDATE IMAdm SET Version = '" + a + "';";
        return b
    },
    getV0_0: function () {
        var b = 'CREATE TABLE IF NOT EXISTS IMAdm (ID INTEGER PRIMARY KEY AUTOINCREMENT, Version NVARCHAR(20));';
        var a = "INSERT INTO IMAdm (Version) VALUES ('1.0');";
        var c = 'CREATE TABLE IF NOT EXISTS IMMsg (ID INTEGER PRIMARY KEY AUTOINCREMENT, MsgID NVARCHAR(50), ChatID NVARCHAR(50), MsgType CHAR(1), Content TEXT, FilePath TEXT, CreateAt BIGINT,SenderID NVARCHAR(20), SenderName NVARCHAR(30), MsgSeq BIGINT, Status CHAR(1) );';
        var d = 'CREATE TABLE IF NOT EXISTS IMRct (ChatID NVARCHAR(50) PRIMARY KEY, ChatType CHAR(1), DisplayName TEXT, UnreadCount INTEGER DEFAULT(0), LastPostAt BIGINT, LastUserID NVARCHAR(20), LastUserName NVARCHAR(30), LastMessage TEXT, LastMsgType CHAR(1), IsTop CHAR(1), AtCount INTEGER );';
        var e = 'CREATE TABLE IF NOT EXISTS IMChat (ChatID NVARCHAR(50) PRIMARY KEY, DisplayName TEXT, CreatorID NVARCHAR(20), CreatorName NVARCHAR(30), ManagerID NVARCHAR(20), ManagerName NVARCHAR(30), Status CHAR(1), CreateAt BIGINT, Remarks TEXT, UserIDs TEXT,UserNames TEXT );';
        var f = 'CREATE TABLE IF NOT EXISTS IMFile (ID INTEGER PRIMARY KEY AUTOINCREMENT, MsgID NVARCHAR(50), ChatID NVARCHAR(50), FilePath TEXT, FileType CHAR(1), FileName NVARCHAR(255), MimeType NVARCHAR(100), Width INT, Height INT, CreateAt BIGINT, FileSize BIGINT );';
        var g = 'CREATE TABLE IF NOT EXISTS IMUsr (UserID NVARCHAR(20) PRIMARY KEY,UserName NVARCHAR(30),Email NVARCHAR(100),Sex CHAR(1),Age INT,Phone NVARCHAR(100),Mobile NVARCHAR(100),Notes NVARCHAR(200),CustomMark NVARCHAR(200),OrgIDs NVARCHAR(100),DefRoleName NVARCHAR(100),DefRolID NVARCHAR(40),Locale NVARCHAR(5),IsSupperUser CHAR(1));';
        var h = 'CREATE TABLE IF NOT EXISTS IMOrg (OrgID NVARCHAR(40) PRIMARY KEY,OrgName NVARCHAR(40),ParentID NVARCHAR(40),Remarks NVARCHAR(200));';
        return [b, a, c, d, e, f, g, h]
    },
    getV1_0: function () {
        var a = 'ALTER TABLE IMMsg ADD COLUMN ClientID NVARCHAR(50);';
        var b = 'ALTER TABLE IMFile ADD COLUMN ClientID NVARCHAR(50);';
        return [a, b]
    },
    getV2_0: function () {
        var a = 'CREATE TABLE IF NOT EXISTS IMLink (LID INTEGER PRIMARY KEY AUTOINCREMENT,MsgID NVARCHAR(50),Type CHAR(1),LinkObjType INT,LinkKeyString NVARCHAR(500),LinkID NVARCHAR(50),LinkTitle nvarchar(50),LinkType nvarchar(10),LinkOpUser nvarchar(20),LinkDesc nvarchar(200),LinkStr nvarchar(200),LinkFromID nvarchar(20),LinkStepID nvarchar(50),LinkStepDesc nvarchar(200),LinkStepStatus char(1),LinkStatus char(1));';
        var b = 'CREATE TABLE IF NOT EXISTS IMAva(AvaHash NVARCHAR(50) PRIMARY KEY,AvaPath NVARCHAR(50));';
        return [a, b]
    },
    getV3_0: function () {
        var a = 'ALTER TABLE IMChat ADD COLUMN ChatType CHAR(1);';
        var b = "UPDATE IMChat SET ChatType='G';";
        return [a, b]
    },
    getV4_0: function () {
        var a = 'ALTER TABLE IMAdm ADD COLUMN OrgVersion VARCHAR(20);';
        var b = 'ALTER TABLE IMAva RENAME TO IMAva1;';
        return [a, b, 'CREATE TABLE IMAva (AvaID NVARCHAR(50) PRIMARY KEY,AvaHash NVARCHAR(50),AvaPath NVARCHAR(50),AvaType CHAR(1));', 'DROP TABLE IMAva1;']
    },
    getV5_0: function () {
        var a = 'ALTER TABLE IMFile ADD COLUMN Extension VARCHAR(20);';
        return [a]
    },
    getV6_0: function () {
        var h = 'ALTER TABLE IMAdm RENAME TO IMAdm1;';
        var i = 'CREATE TABLE IF NOT EXISTS IMAdm (AdminID INTEGER PRIMARY KEY, Version NVARCHAR(20),OrgHash NVARCHAR(50),LastActiveAt BIGINT);';
        var j = "INSERT INTO IMAdm (Version) VALUES ('7.0');";
        var k = 'DROP TABLE IMAdm1';
        var l = 'DROP TABLE IMAva';
        var m = 'DROP TABLE IMChat;';
        var g = 'CREATE TABLE IF NOT EXISTS IMChat (ChatID NVARCHAR(50) PRIMARY KEY, DisplayName TEXT, CreatorID NVARCHAR(20), ManagerID NVARCHAR(20), Status CHAR(1), CreateAt BIGINT, UpdateAt BIGINT, Remarks TEXT, UserIDs TEXT,AvatarHash NVARCHAR(50),ChatType CHAR(1));';
        var n = 'DROP TABLE IMMsg;';
        var o = 'CREATE TABLE IF NOT EXISTS IMMsg (ID INTEGER PRIMARY KEY AUTOINCREMENT, MsgID NVARCHAR(50), ChatID NVARCHAR(50), MsgType CHAR(1), Content TEXT, CreateAt BIGINT,SenderID NVARCHAR(20), SenderName NVARCHAR(30), MsgSeq BIGINT, Status CHAR(1) );';
        var p = 'DROP TABLE IMFile;';
        var q = 'CREATE TABLE IF NOT EXISTS IMFile (ID INTEGER PRIMARY KEY AUTOINCREMENT, FileID NVARCHAR(50),BaseID BIGINT, ChatID NVARCHAR(50), FilePath TEXT, FileType CHAR(1), FileName NVARCHAR(255), MimeType NVARCHAR(100), Width INT, Height INT, CreateAt BIGINT, FileSize BIGINT,Extension VARCHAR(20));';
        var a = 'DROP TABLE IMLink;';
        var b = 'CREATE TABLE IF NOT EXISTS IMLink (ID INTEGER PRIMARY KEY AUTOINCREMENT,LID NVARCHAR(50),BaseID BIGINT,ChatID NVARCHAR(50),Type CHAR(1),LinkObjType INT,LinkKeyString NVARCHAR(500),LinkID NVARCHAR(50),LinkTitle nvarchar(50),LinkType nvarchar(10),LinkOpUser nvarchar(20),LinkDesc nvarchar(200),LinkStr nvarchar(200),LinkFromID nvarchar(20),LinkStepID nvarchar(50),LinkStepDesc nvarchar(200),LinkStepStatus char(1),LinkStatus char(1));';
        var c = 'DROP TABLE IMUsr;';
        var d = 'CREATE TABLE IF NOT EXISTS IMUsr (UserID NVARCHAR(20) PRIMARY KEY,UserName NVARCHAR(30),Email NVARCHAR(100),Sex CHAR(1),Phone NVARCHAR(100),Mobile NVARCHAR(100),Notes NVARCHAR(200),CustomMark NVARCHAR(200),OrgIDs NVARCHAR(100),DefRoleName NVARCHAR(100),DefRoleID NVARCHAR(40),RoleIDs NVARCHAR(50),RoleNames NVARCHAR(100),AvatarHash NVARCHAR(50));';
        var e = 'DROP TABLE IMRct;';
        var f = 'CREATE TABLE IF NOT EXISTS IMRct (ChatID NVARCHAR(50) PRIMARY KEY, ChatType CHAR(1), DisplayName TEXT, UnreadCount INTEGER DEFAULT(0), LastPostAt BIGINT, LastUserID NVARCHAR(20), LastUserName NVARCHAR(30), LastMessage TEXT, LastMsgType CHAR(1), IsTop CHAR(1), AtCount INTEGER,UserID NVARCHAR(20),CreateAt BIGINT);';
        return [h, i, j, k, l, m, g, n, o, p, q, a, b, c, d, e, f]
    },
    getV7_0: function () {
        var a = 'ALTER TABLE IMLink ADD COLUMN LinkStgGuid NVARCHAR(50);';
        return [a]
    },
    getV8_0: function () {
        var a = 'CREATE INDEX INDEX_IMMSG_CREATEAT ON IMMsg (CreateAt);';
        var b = 'CREATE UNIQUE INDEX INDEX_IMMSG_ID ON IMMsg (ID);';
        var c = 'CREATE INDEX INDEX_IMMSG_MSGID ON IMMsg (MsgID);';
        var d = 'CREATE INDEX INDEX_IMLINK_ID ON IMLink (ID);';
        var e = 'CREATE INDEX INDEX_IMFILE_ID ON IMFile (ID);';
        return [a, b, c, d, e]
    },
    getV9_0: function () {
        var a = 'CREATE INDEX INDEX_IMMSG_CHATID ON IMMsg (ChatID);';
        var b = 'CREATE INDEX INDEX_IMFILE_BASEID ON IMFile (BaseID);';
        var c = 'CREATE INDEX INDEX_IMLINK_BASEID ON IMLink (BaseID);';
        return [a, b, c]
    },
    getV10_0: function () {
        return ['CREATE INDEX INDEX_IMCHAT_CHATID ON IMChat (ChatID);']
    },
    getV11_0: function () {
        return ['ALTER TABLE IMFile ADD COLUMN FileStatus INT;']
    },
    getV12_0: function () {
        return ['ALTER TABLE IMFile ADD COLUMN HasPreview CHAR(1);']
    },
    getV13_0: function () {
        return ['ALTER TABLE IMRct RENAME TO IMRctTemp;', "CREATE TABLE IF NOT EXISTS IMRct(\n            ChatID NVARCHAR(50) PRIMARY KEY,\n                    ChatType CHAR(1),\n                    DisplayName TEXT,\n                    UnreadCount INTEGER DEFAULT(0),\n                    LastPostAt BIGINT, \n                    LastUserID NVARCHAR(20),\n                    LastUserName NVARCHAR(30),\n                    LastMessage TEXT,\n                    LastMsgType CHAR(1),\n                    IsTop CHAR(1) DEFAULT('N'),\n                    AtCount INTEGER DEFAULT(0),\n                    UserID NVARCHAR(20),\n                    CreateAt BIGINT);", 'INSERT INTO IMRct SELECT * FROM IMRctTemp;', 'DROP TABLE IMRctTemp;', "UPDATE IMRct SET IsTop='N' WHERE IsTop<>'Y' OR IsTop IS NULL;"]
    },
    getV14_0: function () {
        var a = 'CREATE TABLE IF NOT EXISTS IMBFile (\n            ID INTEGER PRIMARY KEY AUTOINCREMENT,\n            BFileID NVARCHAR(50),\n            BaseID BIGINT,\n            ChatID NVARCHAR(50),\n            UserID NVARCHAR(20),\n            BFilePath TEXT,\n            BFileName TEXT,\n            BFileSize BIGINT,\n            BFileExtension VARCHAR(20),\n            BFileStatus INT,\n            CreateAt BIGINT,\n            ExpireAt BIGINT\n        );';
        return [a]
    },
    getV15_0: function () {
        var a = "UPDATE IMMsg SET Content=replace(Content,'<br>',char(10)) \n        WHERE MsgType='T' AND CreateAt>1541001600000;";
        var b = "UPDATE IMMsg SET Content=replace(Content,'&lt;','<') \n        WHERE MsgType='T' AND CreateAt>1541001600000;";
        var c = "UPDATE IMMsg SET Content=replace(Content,'&gt;', '>') \n        WHERE MsgType='T' AND CreateAt>1541001600000;";
        var d = "UPDATE IMMsg SET Content=replace(Content,'&nbsp;',' ') \n        WHERE MsgType='T' AND CreateAt>1541001600000;";
        return [a, b, c, d]
    },
    getV16_0: function () {
        var a = "ALTER TABLE IMBFile ADD COLUMN IsHiddenInForm CHAR(1) DEFAULT('N');";
        return [a]
    },
    getV17_0: function () {
        return ['ALTER TABLE IMAdm ADD COLUMN FixVersion NVARCHAR(20);']
    },
    getV18_0: function () {
        var a = 'ALTER TABLE IMRct ADD COLUMN MentionCount INT DEFAULT(0);';
        var b = "ALTER TABLE IMMsg ADD CoLUMN HasMention CHAR(1) DEFAULT('N');";
        var c = "ALTER TABLE IMRct ADD COLUMN IsMute CHAR(1) DEFAULT('N');";
        var d = "ALTER TABLE IMChat ADD COLUMN IsMute CHAR(1) DEFAULT('N');";
        var e = 'CREATE TABLE IF NOT EXISTS IMMsgA (\n            MsgID NVARCHAR(50) PRIMARY KEY,\n            MsgSeq BIGINT,\n            ChatID NVARCHAR(50),\n            UserID NVARCHAR(20),\n            UserName NVARCHAR(50),\n            CreateAt BIGINT,\n            ViewAt BIGINT,\n            Status INT DEFAULT(0)\n        );';
        return [a, b, c, d, e]
    },
    getV19_0: function () {
        var a = "ALTER TABLE IMMsg ADD COLUMN NewReply CHAR(1) DEFAULT('N');";
        var b = 'ALTER TABLE IMMsg ADD COLUMN ReplyCount INT DEFAULT(0);';
        var c = 'CREATE TABLE IF NOT EXISTS IMReply (\n            ReplyID NVARCHAR(50) PRIMARY KEY NOT NULL,\n            ReplySeq NVARCHAR(50),\n            CreateAt BIGINT,\n            UpdateAt BIGINT,\n            EditAt BIGINT,\n            DeleteAt BIGINT,\n            UserID NVARCHAR(20),\n            UserName NVARCHAR(30),\n            RootID NVARCHAR(50),\n            Content TEXT,\n            ContentType CHAR(1),\n            AttachID NVARCHAR(50),\n            ContentEx TEXT,\n            ChatID NVARCHAR(50)\n        );';
        return [a, b, c]
    },
    getV20_0: function () {
        var a = 'ALTER TABLE IMMsg ADD COLUMN ReplyUpdateAt BIGINT;';
        return [a]
    },
    getV21_0: function () {
        var a = 'CREATE TABLE IF NOT EXISTS IMNews (\n            NewsID NVARCHAR(50) PRIMARY KEY NOT NULL,\n            NewsSeq BIGINT,\n            CreatorID NVARCHAR(20),\n            CreateAt BIGINT,\n            UpdateAt BIGINT,\n            DeleteAt BIGINT,\n            Title NVARCHAR(50),\n            Description NVARCHAR(200),\n            PicUrl NVARCHAR(1024),\n            DescUrl NVARCHAR(1024),\n            IsText CHAR(1),\n            NewsType CHAR(1),\n            Extras TEXT\n        );';
        return [a]
    },
    getV22_0: function () {
        var a = "CREATE TABLE IF NOT EXISTS IMChatCM (\n            ChatID NVARCHAR(50) NOT NULL,\n            BodyID NVARCHAR(50) NOT NULL,\n            IsAdmin CHAR(1) DEFAULT('N'),\n            constraint pk_main primary key (ChatID, BodyID)\n            );";
        return [a]
    },
    getV23_0: function () {
        var a = 'CREATE TABLE IF NOT EXISTS IMChatC (\n            ID INTEGER PRIMARY KEY NOT NULL,\n            ChatID NVARCHAR(50),\n            Notice TEXT ,\n            ReMark TEXT,\n            DeleteAt BIGINT,\n            CreateAt BIGINT,\n            UpdateAt BIGINT,\n            Header TEXT,\n            ManagerID NVARCHAR(50),\n            ChatStatus CHAR(1),\n            Hash NVARCHAR(50),\n            AvaHash NVARCHAR(50)\n            );';
        return [a]
    },
    getV24_0: function () {
        var a = 'CREATE TABLE IF NOT EXISTS IMWFile (\n            ID INTEGER PRIMARY KEY AUTOINCREMENT ,\n            FileID NVARCHAR(50),           \n            FileName NVARCHAR(255),\n            FileSize BIGINT ,\n            FilePath TEXT,\n            FileStatus char(1),\n            Extension NVARCHAR(20),\n            CreateAt BIGINT,\n            DeleteAt BIGINT DEFAULT(0),\n            MimeType NVARCHAR(100),\n            Extras TEXT,\n            RemoteUrl NVARCHAR(1024)\n            );';
        return [a]
    },
    getV25_0: function () {
        var a = 'ALTER TABLE IMFile ADD COLUMN DeleteAt BIGINT DEFAULT(0);';
        return [a]
    },
    getV26_0: function () {
        var a = 'ALTER TABLE IMMsg ADD COLUMN ReadCount INT DEFAULT(0);';
        var b = 'ALTER TABLE IMMsg ADD COLUMN UnReadCount INT DEFAULT(0);';
        var c = 'ALTER TABLE IMMsg ADD COLUMN HasRead INT DEFAULT(0);';
        return [a, b, c]
    },
    getV27_0: function () {
        var a = 'ALTER TABLE IMOrg RENAME TO IMOrgTmp;';
        var b = 'CREATE TABLE IF NOT EXISTS IMOrg (\n            OrgID NVARCHAR(40),\n            CorpID NVARCHAR(50),\n            OrgName NVARCHAR(40),\n            ParentID NVARCHAR(40),\n            Remarks NVARCHAR(200),\n            PRIMARY KEY(OrgID,CorpID)\n        );';
        var c = "insert into IMOrg (CorpID,OrgID,OrgName,ParentID,Remarks) \n            select '' CorpID,OrgID,OrgName,ParentID,Remarks from IMOrgTmp;";
        var d = 'DROP TABLE IMOrgTmp;';
        var g = 'ALTER TABLE IMUsr ADD COLUMN Organizations TEXT;';
        var h = 'ALTER TABLE IMUsr ADD COLUMN UserPosts NVARCHAR(254);';
        var e = 'ALTER TABLE IMLink ADD COLUMN CorpID NVARCHAR(50);';
        var f = 'CREATE TABLE IF NOT EXISTS IMCache (\n            CacheKey NVARCHAR(50) PRIMARY KEY,           \n            CacheValue TEXT,\n            CreateAt BIGINT ,\n            Interval BIGINT DEFAULT(0),\n            ExpireAt BIGINT\n            );';
        return [a, b, c, d, g, h, e, f]
    },
    getV28_0: function () {
        var a = "ALTER TABLE IMChat ADD COLUMN FromERP CHAR(1) DEFAULT('N');";
        var b = "ALTER TABLE IMRct ADD COLUMN FromERP CHAR(1) DEFAULT('N');";
        return [a, b]
    },
    doFixVer: function () {
        var a = this,
            b = 'SELECT FixVersion FROM IMAdm;';
        LocalDataMgr.cExecSqlWithP(b, [], function (d, c) {
            var b = c.rows;
            if (b.length > 0) {
                var e = b.item(0).FixVersion;
                a.execFixSql(d, e)
            }
        }, function () {
            a.validateDoFixSql()
        })
    },
    validateDoFixSql: function () {
        var b = this,
            a = 'SELECT Version FROM IMAdm;';
        LocalDataMgr.cExecSqlWithP(a, [], function (e, d) {
            var c = d.rows;
            if (c.length > 0) {
                var a = c.item(0).Version;
                a = parseInt(a, 10);
                if (a >= 15) {
                    b.execFixSql(e, a)
                }
            }
        })
    },
    execFixSql: function (d, a) {
        if (Ext.isEmpty(a)) {
            a = '0.0'
        }
        var b = [],
            c;
        switch (a) {
            case '0.0':
                b = this.getFixVer0_0();
                c = '1.0';
                break;
            default:
                break;
        }
        if (b.length == 0) {
            return
        }
        LocalDataMgr.getDB().transaction(function (e) {
            LogUtil.writeLogErr('开始执行事务,FixVer:' + a);
            for (var c = 0; c < b.length; c++) {
                InitDb.doExecFixSql(e, b[c], a)
            }
        }, function () {
            LogUtil.writeLogErr('事务执行失败,FixVer:' + a)
        }, function () {
            LogUtil.writeLogErr('事务执行成功,FixVer:' + a);
            LocalDataMgr.cExecSqlWithP('UPDATE IMAdm SET FixVersion=?', [c])
        })
    },
    doExecFixSql: function (c, a, b) {
        c.executeSql(a, [], function (f, e) {
            var d = e.rowsAffected;
            LogUtil.writeFixVerLog(b, d, a)
        }, function (d) {
            LogUtil.writeFixVerLogErr(b, d, a)
        })
    },
    getFixVer0_0: function () {
        var a = "UPDATE IMMsg SET Content=replace(Content,'<br>',char(10)) \n        WHERE MsgType='T' AND CreateAt>1541001600000;";
        var b = "UPDATE IMMsg SET Content=replace(Content,'&lt;','<') \n        WHERE MsgType='T' AND CreateAt>1541001600000;";
        var c = "UPDATE IMMsg SET Content=replace(Content,'&gt;', '>') \n        WHERE MsgType='T' AND CreateAt>1541001600000;";
        var d = "UPDATE IMMsg SET Content=replace(Content,'&nbsp;',' ') \n        WHERE MsgType='T' AND CreateAt>1541001600000;";
        return [a, b, c, d]
    }
}, 0, 0, 0, 0, 0, 0, [IMCommon.local, 'InitDb', 0, 'InitDb'], 0);
Ext.cmd.derive('IMCommon.local.LocalDataMgr', Ext.Base, {
    alternateClassName: 'LocalDataMgr',
    singleton: !0,
    newGuid: function () {
        var a = '';
        if (window.cefMain) {
            a = cefMain.getGuid()
        } else {
            a = this.getImitateGuid()
        }
        return a
    },
    getImitateGuid: function () {
        var a = '';
        for (var b = 1; b <= 26; b++) {
            var c = Math.floor(Math.random() * 16).toString(16);
            a += c
        }
        return a
    },
    commonExecSql: function (c, b) {
        var a = this;
        a.getDB().transaction(function (d) {
            a.handleSql(d, c, b)
        })
    },
    getDB: function () {
        var b = User.ownerID;
        if (Ext.isEmpty(b)) {
            return
        }
        var a = window.RouteList.getAccIDByUrl();
        a = a + 'apiv1_' + User.ownerID;
        if (Config.isPC) {
            return sqlitePlugin.openDatabase({
                name: b,
                iosDatabaseLocation: 'default'
            })
        } else {
            if (Ext.browser.is.Cordova) {
                return sqlitePlugin.openDatabase({
                    name: a,
                    iosDatabaseLocation: 'default'
                })
            }
        }
        return openDatabase(a, '1.0', Config.httpUrlForGo + ' ' + User.ownerID + ' Database', 5 * 1024 * 1024)
    },
    getDBName: function () {
        return Config.httpUrlForGo.replace(/(https?:\/\/)|(\/)/g, '').replace(/:/g, '.') + '_' + User.ownerID
    },
    handleSql: function (c, b, a) {
        c.executeSql(b, null, function (e, d) {
            if (a) {
                a(e, d)
            }
        }, function (e, d) {
            console.error('操作本地数据库出错：', b, d.message)
        })
    },
    cExecSqlWithP: function (a, b, d, c) {
        if (Config.isDebug) {
            console.log('sql：', a);
            console.log('参数：', b)
        }
        LocalDataMgr.getDB().transaction(function (e) {
            e.executeSql(a, b, function (g, f) {
                if (d) {
                    d(g, f)
                }
            }, function (g, f) {
                console.error('操作本地数据库出错', a, f.message);
                LogUtil.writeLogErr(a, b);
                if (c) {
                    c(f)
                }
            })
        })
    },
    getRecentChat: function (a) {
        var b = 'select TM.*, T0.Status as ChatStatus\n        from IMRct TM \n        left join IMChat T0 on TM.ChatID = T0.ChatID\n        order by TM.IsTop desc, TM.LastPostAt desc, TM.UnreadCount desc limit 50;';
        this.commonExecSql(b, a)
    },
    getHistory: function (a, d, b) {
        var c = 'SELECT M.*,\n        F.ID FID,F.FileID,F.BaseID FileBaseID,F.FilePath,F.CreateAt FileCreateAt,F.FileType,F.FileName,F.MimeType,F.Width,F.Height,F.FileSize,F.Extension,F.FileStatus,F.HasPreview,\n        L.ID LID,L.BaseID LinkBaseID,L.Type,L.LinkObjType,L.CorpID,L.LinkKeyString,L.LinkID,L.LinkTitle,L.LinkType,L.LinkOpUser,L.LinkDesc,L.LinkStr,L.LinkFromID,L.LinkStepID,L.LinkStepDesc,L.LinkStepStatus,L.LinkStatus,L.LinkStgGuid,\n        B.BFileID,B.BFilePath,B.BFileName,B.BFileSize,B.BFileExtension,B.BFileStatus,B.ExpireAt,B.IsHiddenInForm \n        FROM \n        (SELECT * FROM IMMsg WHERE ChatID=? \n        ORDER BY CreateAt DESC,MsgSeq DESC limit 0,20) M \n        LEFT JOIN IMFile F ON M.ID=F.BaseID \n        LEFT JOIN IMLink L ON M.ID=L.BaseID \n        LEFT JOIN IMBFile B ON M.ID=B.BaseID';
        this.cExecSqlWithP(c, [b], function (e, c) {
            if (a) {
                a(e, c)
            }
        })
    },
    getHistoryWoNotShow: function (a, d, b) {
        var c = 'SELECT M.*,F.*,F.BaseID FileBaseID,L.*,L.BaseID LinkBaseID,B.* FROM \n            (SELECT * FROM IMMsg WHERE ChatID=? AND MsgType<>?  \n                ORDER BY CreateAt DESC,MsgSeq DESC limit 0,20) M \n                    LEFT JOIN IMFile F ON M.ID=F.BaseID \n                    LEFT JOIN IMLink L ON M.ID=L.BaseID \n                    LEFT JOIN IMBFile B ON M.ID=B.BaseID;';
        this.cExecSqlWithP(c, [b, MsgType.NotShow], function (e, c) {
            if (a) {
                a(e, c)
            }
        })
    },
    getHistoryWhenshow: function (a, e, b, c) {
        var d = 'SELECT M.MsgID,M.ChatID,M.MsgType,M.Content,M.CreateAt,M.SenderID,M.SenderName,M.MsgSeq,M.Status,F.FileID,F.BaseID FileBaseID,F.FilePath,F.FileType,F.FileName,F.MimeType,F.Width,F.Height,F.FileSize,F.Extension,F.FileStatus,F.HasPreview,L.BaseID LinkBaseID,L.Type,L.LinkObjType,L.CorpID,L.LinkKeyString,L.LinkID,L.LinkTitle,L.LinkType,L.LinkOpUser,L.LinkDesc,L.LinkStr,L.LinkFromID,L.LinkStepID,L.LinkStepDesc,L.LinkStepStatus,L.LinkStatus,L.LinkStgGuid, B.BaseID BFileBaseID,B.BFileID,B.BFilePath,B.BFileName,B.BFileSize,B.BFileExtension,B.BFileStatus,B.CreateAt BCreateAt,B.ExpireAt FROM IMMsg M LEFT JOIN IMFile F ON M.ID = F.BaseID LEFT JOIN IMLink L ON M.ID = L.BaseID LEFT JOIN IMBFile B ON M.ID = B.BaseID WHERE M.ChatID = ? AND M.CreateAt < ? AND M.MsgType<>? ORDER BY M.CreateAt DESC LIMIT 20;';
        this.cExecSqlWithP(d, [c, b, MsgType.NotShow], function (f, d) {
            if (a) {
                a(f, d)
            }
        })
    },
    getHistoryBySeq: function (e, a, c, b, d) {
        if (!a) {
            a = c - 20
        }
        this.getDB().transaction(function (f) {
            var g = 'SELECT M.*,\n                 F.ID FID,F.FileID,F.BaseID FileBaseID,F.FilePath,F.CreateAt FileCreateAt,F.FileType,F.FileName,F.MimeType,F.Width,F.Height,F.FileSize,F.Extension,F.FileStatus,F.HasPreview,\n                 L.ID LID,L.BaseID LinkBaseID,L.Type,L.LinkObjType,L.CorpID,L.LinkKeyString,L.LinkID,L.LinkTitle,L.LinkType,L.LinkOpUser,L.LinkDesc,L.LinkStr,L.LinkFromID,L.LinkStepID,L.LinkStepDesc,L.LinkStepStatus,L.LinkStatus,L.LinkStgGuid\n                 FROM (SELECT * FROM IMMsg WHERE ChatID=? and MsgSeq<? AND MsgSeq>=? ORDER BY CreateAt DESC,MsgSeq DESC limit 20) M\n                 LEFT JOIN IMFile F ON M.ID=F.BaseID LEFT JOIN IMLink L ON M.ID=L.BaseID;';
            f.executeSql(g, [e, c, a], function (h, g) {
                if (b) {
                    b(h, g)
                }
            }, function () {
                if (d) {
                    d()
                }
            })
        })
    },
    getOldIMMsg: function (d, c, a, b) {
        var e = 'select M.*,F.*,L.*,B.* FROM IMMsg M LEFT JOIN IMFile F ON M.ID=F.BaseID LEFT JOIN IMLink L ON M.ID=L.BaseID LEFT JOIN IMBFile B ON M.ID=B.BaseID WHERE M.ChatID=? and M.CreateAt<? ORDER BY M.CreateAt DESC,M.MsgSeq DESC LIMIT 20;';
        this.cExecSqlWithP(e, [d, c], function (f, e) {
            if (a) {
                a(f, e)
            }
        }, function () {
            if (b) {
                b()
            }
        })
    },
    getOldMsgWoNotShow: function (d, c, a, b) {
        var e = 'select M.*,F.*,L.*,B.* FROM IMMsg M LEFT JOIN IMFile F ON M.ID=F.BaseID LEFT JOIN IMLink L ON M.ID=L.BaseID LEFT JOIN IMBFile B ON M.ID=B.BaseID WHERE M.ChatID=? and M.CreateAt<? AND M.MsgType<>? ORDER BY M.CreateAt DESC LIMIT 20;';
        this.cExecSqlWithP(e, [d, c, MsgType.NotShow], function (f, e) {
            if (a) {
                a(f, e)
            }
        }, function () {
            if (b) {
                b()
            }
        })
    },
    getNegativeIMMsg: function (d, c, a, b) {
        var e = 'select M.*,F.*,L.*,B.* FROM IMMsg M LEFT JOIN IMFile F ON M.ID=F.BaseID LEFT JOIN IMLink L ON M.ID=L.BaseID LEFT JOIN IMFile B ON M.ID=B.BaseID WHERE M.ChatID=? and M.CreateAt<? and MsgSeq=? ORDER BY M.CreateAt DESC LIMIT 20;';
        this.cExecSqlWithP(e, [d, c, -1], function (f, e) {
            if (a) {
                a(f, e)
            }
        }, function () {
            if (b) {
                b()
            }
        })
    },
    getMoreEndHistory: function (d, c, a, b) {
        var e = 'select M.*,F.*,L.*,B.* FROM (SELECT * FROM IMMsg WHERE ChatID=? and CreateAt>? ORDER BY CreateAt ASC,MsgSeq ASC LIMIT 20) M LEFT JOIN IMFile F ON M.ID=F.BaseID LEFT JOIN IMLink L ON M.ID=L.BaseID LEFT JOIN IMBFile B ON M.ID=B.BaseID;';
        this.cExecSqlWithP(e, [d, c], function (f, e) {
            if (a) {
                a(f, e)
            }
        }, function (f, e) {
            if (b) {
                b(e)
            }
        })
    },
    getMoreEndHisWoNotShow: function (d, c, a, b) {
        var e = 'select M.*,F.*,L.*,B.* FROM (SELECT * FROM IMMsg WHERE ChatID=? and CreateAt>? AND MsgType<>? ORDER BY CreateAt ASC LIMIT 20) M LEFT JOIN IMFile F ON M.ID=F.BaseID LEFT JOIN IMLink L ON M.ID=L.BaseID LEFT JOIN IMBFile B ON M.ID=B.BaseID;';
        this.cExecSqlWithP(e, [d, c, MsgType.NotShow], function (f, e) {
            if (a) {
                a(f, e)
            }
        }, function (f, e) {
            if (b) {
                b(e)
            }
        })
    },
    searchHistoryTxt: function (c, a, b) {
        this.getDB().transaction(function (d) {
            var e = "SELECT * FROM IMMsg WHERE (Content like ? or SenderName like ?) AND ChatID=? AND MsgType != 'G' AND MsgType != 'R'  ORDER BY CreateAt DESC;";
            d.executeSql(e, ['%' + a + '%', '%' + a + '%', c], function (f, e) {
                if (b) {
                    b(e)
                }
            }, function (f, e) {
                console.log('本地查询出错：', e.message)
            })
        })
    },
    searchRctList: function (a, b) {
        this.getDB().transaction(function (c) {
            var d = '\n            select distinct S.ChatID,S.ChatType,S.DisplayName,S.LastPostAt,S.LastUserID,S.LastUserName,S.LastMessage,S.LastMsgType,S.UserID,S.CreateAt,Max(RType) as RType,Max(MsgSeq) as MsgSeq \n            from\n            (\n                select T1.*,1 as RType,0 as MsgSeq\n                from IMRct T1 \n                where exists(\n                    select * from IMMsg T3 \n                    inner join IMUsr T2 on T3.SenderID = T2.UserID\n                    where T2.UserName like ? and T3.ChatID = T1.ChatID\n                )\n                or T1.DisplayName like ?\n                union all\n                select distinct T1.*,2 as RType,Max(T2.MsgSeq) \n                from IMRct T1 \n                left join IMMsg T2 on T1.ChatID = T2.ChatID\n                where T2.Content like ? \n                group by T1.ChatID\n            )S \n            group by S.ChatID \n            ORDER BY S.CreateAt DESC;';
            c.executeSql(d, [a + '%', '%' + a + '%', '%' + a + '%'], function (e, d) {
                if (b) {
                    b(d)
                }
            }, function (e, d) {
                console.log('本地查询出错：', d.message)
            })
        })
    },
    getHistoryFromMsgSeq: function (a, b, c) {
        var d = this;
        d.getDB().transaction(function (d) {
            var e = 'SELECT M.*, F.ID FID,F.FileID,F.BaseID FileBaseID,F.FilePath,F.CreateAt FileCreateAt,F.FileType,F.FileName,F.MimeType,F.Width,F.Height,F.FileSize,F.Extension,F.FileStatus,F.HasPreview,\n            L.ID LID,L.BaseID LinkBaseID,L.Type,L.LinkObjType,L.CorpID,L.LinkKeyString,L.LinkID,L.LinkTitle,L.LinkType,L.LinkOpUser,L.LinkDesc,L.LinkStr,L.LinkFromID,L.LinkStepID,L.LinkStepDesc,L.LinkStepStatus,L.LinkStatus,L.LinkStgGuid \n            FROM \n            (SELECT * FROM IMMsg WHERE ChatID=? AND MsgSeq >=? ORDER BY CreateAt DESC,MsgSeq DESC) M \n            LEFT JOIN IMFile F ON M.ID=F.BaseID \n            LEFT JOIN IMLink L ON M.ID=L.BaseID;';
            d.executeSql(e, [c, b], function (f, e) {
                if (a) {
                    a(f, e)
                }
            })
        })
    },
    getImageHistory: function (b, a) {
        var c = this;
        c.getDB().transaction(function (c) {
            var d = "SELECT M.*, F.ID FID,F.FileID,F.BaseID FileBaseID,F.FilePath,F.CreateAt FileCreateAt,F.FileType,F.FileName,F.MimeType,F.Width,F.Height,F.FileSize,F.Extension,F.FileStatus,F.HasPreview\n            FROM IMMsg M \n            LEFT JOIN IMFile F ON M.ID=F.BaseID \n            WHERE M.ChatID=? \n            AND M.MsgType = 'I' \n            ORDER BY M.MsgSeq DESC;";
            c.executeSql(d, [b], function (e, d) {
                if (a) {
                    a(d)
                }
            })
        })
    },
    getFileHistory: function (b, a) {
        var c = this;
        c.getDB().transaction(function (c) {
            var d = "SELECT M.*, F.ID FID,F.FileID,F.BaseID FileBaseID,F.FilePath,F.CreateAt FileCreateAt,F.FileType,F.FileName,F.MimeType,F.Width,F.Height,F.FileSize,F.Extension,F.FileStatus,F.HasPreview\n            FROM IMMsg M \n            LEFT JOIN IMFile F ON M.ID=F.BaseID          \n            WHERE M.ChatID=? \n            AND M.MsgType = 'F' \n            ORDER BY M.MsgSeq DESC;";
            c.executeSql(d, [b], function (e, d) {
                if (a) {
                    a(d)
                }
            })
        })
    },
    getLastMsgTime: function (b, a) {
        var d = this;
        var c = 'select CreateAt from IMMsg where ChatID="' + b + '" order by CreateAt desc limit 0,1';
        d.commonExecSql(c, a)
    },
    getLastMsgSeq: function (b, a) {
        var c = this;
        c.getDB().transaction(function (c) {
            var d = 'select Max(MsgSeq) MsgSeq from IMMsg where ChatID=?';
            c.executeSql(d, [b], function (e, d) {
                if (a) {
                    a(e, d)
                }
            }, function (e, d) {
                console.log('本地查询最大MsgSeq号出错：', d.message)
            })
        })
    },
    initUpdateChats: function (b) {
        var c = this;
        for (var a = 0; a < b.length; a++) {
            c.doInitUpdateChat(b[a]);
            c.doInitUpdateRct(b[a])
        }
    },
    doInitUpdateChat: function (b) {
        var g = this;
        var a = b.chat;
        var e = a.header;
        var c = a.creator_id,
            f = a.manager_id;
        var i = g.getUsersMsg(b.members),
            h = i.ids;
        if (a.chat_type == ChatType.Direct) {
            e = ParseUtil.getDctNameFromMems(b.members);
            c = ParseUtil.getDctIdFromMems(b.members);
            f = c
        }
        var d = a.is_mute;
        if (Ext.isEmpty(d)) {
            d = 'N'
        }
        if (a.iscrowd == 'Y') {
            a.chat_type = 'C'
        }
        var j = 'INSERT OR REPLACE INTO IMChat (\n            ChatID,\n            DisplayName,\n            CreatorID,\n            ManagerID,\n            Status,\n            CreateAt,\n            UpdateAt,\n            Remarks,\n            UserIDs,\n            AvatarHash,\n            ChatType,\n            IsMute\n        ) VALUES (?,?,?,?,?,?,?,?,?,?,?,?);';
        g.cExecSqlWithP(j, [a.chat_id, e, c, f, '0', a.create_at, a.update_at, a.purpose, h, a.avatar_hash, a.chat_type, d])
    },
    doInitUpdateRct: function (e) {
        var a = e.chat,
            g = a.chat_id;
        var d = a.header,
            f = a.manager_id;
        if (a.chat_type == ChatType.Direct) {
            d = ParseUtil.getDctNameFromMems(e.members);
            f = ParseUtil.getDctIdFromMems(e.members)
        }
        if (a.iscrowd == 'Y') {
            a.chat_type = 'C'
        }
        var c = a.is_mute;
        if (Ext.isEmpty(c)) {
            c = 'N'
        }
        var b;
        if (a.last_msg_type == 'B') {
            b = GroupNotice.getRevokeNotice(a.last_sender, a.last_message)
        } else {
            b = a.last_message
        }
        this.beforeDoRct(g, function (h, i) {
            var g = 'UPDATE IMRct SET DisplayName=?,ChatType=?,UnreadCount=?,LastPostAt=?,LastUserID=?,\n            LastUserName=?,LastMessage=?,LastMsgType=?,UserID=?,CreateAt=?,MentionCount=?,IsMute=? WHERE ChatID=?;';
            h.executeSql(g, [d, a.chat_type, a.unread_count, a.last_post_at, a.last_sender, a.last_sender_name, b, a.last_msg_type, f, a.create_at, a.mention_count, c, a.chat_id])
        }, function (i) {
            var h = 'INSERT INTO IMRct (ChatID, DisplayName, ChatType, UnreadCount, LastPostAt, LastUserID, LastUserName, LastMessage, LastMsgType, UserID, CreateAt, MentionCount, IsMute, FromERP) VALUES (?,?,?,?,?,?,?,?,?,?,?,?,?,?);';
            i.executeSql(h, [g, d, a.chat_type, a.unread_count, a.last_post_at, a.last_sender, a.last_sender_name, b, a.last_msg_type, f, a.create_at, a.mention_count, c, a.from_erp])
        })
    },
    initUpdateSyncChats: function (a) {
        var b = this;
        var e = 'UPDATE IMChat SET IsMute=? WHERE IsMute=?;';
        b.cExecSqlWithP(e, ['N', 'Y']);
        var f = 'UPDATE IMRct SET IsMute=? WHERE IsMute=?;';
        b.cExecSqlWithP(f, ['N', 'Y']);
        if (Ext.isEmpty(a) || a.length == 0) {
            return
        }
        var d = a.length;
        for (var c = 0; c < d; c++) {
            b.doInitSyncChat(a[c]);
            b.doInitSyncRct(a[c])
        }
    },
    doInitSyncChat: function (a) {
        this.beforeDoChat(a, function (c, d) {
            var b = 'UPDATE IMChat SET IsMute=? WHERE ChatID=?;';
            c.executeSql(b, ['Y', a])
        })
    },
    doInitSyncRct: function (a) {
        this.beforeDoRct(a, function (c, d) {
            var b = 'UPDATE IMRct SET IsMute=? WHERE ChatID=?;';
            c.executeSql(b, ['Y', a])
        })
    },
    asyncChatAndRct: function (a) {
        var b = 'SELECT * FROM IMChat WHERE ChatID = ?;';
        this.cExecSqlWithP(b, [a.chat_id], function (g, f) {
            var d = f.rows;
            if (d.length == 0) {
                var e = 'INSERT INTO IMChat (ChatID, ChatType, DisplayName, CreatorID, ManagerID, CreateAt, UserIDs, Status, UpdateAt, AvatarHash, IsMute, FromERP) VALUES(?,?,?,?,?,?,?,?,?,?,?);';
                var b = [];
                for (var c = 0; c < a.members.length; c++) {
                    b.push(a.members[c].user_id)
                }
                b = b.join(',');
                g.executeSql(e, [a.chat_id, a.chat_type, a.displayname, a.creator_id, a.manager_id, a.create_at, b, '0', a.update_at, a.avatar_hash, a.is_mute, a.from_erp])
            }
        });
        var c = 'SELECT * FROM IMRct WHERE ChatID = ?;';
        this.cExecSqlWithP(c, [a.chat_id], function (f, e) {
            var c = e.rows;
            if (c.length == 0) {
                var d = 'INSERT INTO IMRct (ChatID, DisplayName, ChatType, UnreadCount, LastPostAt, LastUserID, LastUserName, LastMessage, LastMsgType, UserID, CreateAt, MentionCount, IsMute,FromERP) VALUES (?,?,?,?,?,?,?,?,?,?,?,?,?,?);';
                var b = a.manager_id;
                if (a.chat_type == ChatType.Direct) {
                    b = a.ava
                }
                f.executeSql(d, [a.chat_id, a.displayname, a.chat_type, 0, a.last_post_at, User.ownerID, User.crtUser.user_name, '', 'T', b, a.create_at, 0, a.is_mute, a.from_erp])
            }
        })
    },
    getUsersMsg: function (d) {
        var e = {},
            b = [],
            a = [];
        for (var c = 0; c < d.length; c++) {
            b.push(d[c].user_id);
            a.push(d[c].user_name)
        }
        b = b.join(',');
        a = a.join(',');
        e.ids = b;
        e.names = a;
        return e
    },
    createDitChat: function (a) {
        this.getDB().transaction(function (d) {
            var e = 'INSERT OR REPLACE INTO IMRct (ChatID, DisplayName, ChatType, UnreadCount, LastPostAt, LastUserID, LastUserName, LastMessage, LastMsgType, IsTop, UserID, CreateAt) VALUES (?,?,?,?,?,?,?,?,?,?,?,?);';
            d.executeSql(e, [a.chat_id, a.display_name, a.chat_type, a.unread_count, ParseUtil.getLocalTime(!0), a.last_sender_id, a.last_sender_name, a.last_message, a.last_msg_type, a.is_top == 'Y' ? 'Y' : 'N', ParseUtil.getDctIdFromMems(a.members), a.create_at]);
            var f = 'INSERT OR REPLACE INTO IMChat (ChatID, ChatType, DisplayName, CreateAt, UserIDs, Status, UpdateAt, Remarks, AvatarHash) VALUES (?,?,?,?,?,?,?,?,?);';
            var b = [];
            for (var c = 0; c < a.members.length; c++) {
                b.push(a.members[c].user_id)
            }
            b = b.join(',');
            d.executeSql(f, [a.chat_id, a.chat_type, a.display_name, a.create_at, b, '0', a.update_at, a.purpose, a.avatar_hash])
        })
    },
    createGrpChat: function (a, b) {
        this.getDB().transaction(function (d) {
            var f = GroupNotice.createNewGrpNotice(a.creator_id, a.members, b[0].user_name);
            var g = b[0];
            var h = 'INSERT INTO IMRct (ChatID, ChatType, DisplayName, LastPostAt, LastMessage, LastMsgType, LastUserID, LastUserName, IsTop, UserID, CreateAt, FromERP) VALUES (?,?,?,?,?,?,?,?,?,?,?,?)';
            d.executeSql(h, [a.chat_id, a.chat_type, a.header, a.create_at, f, MsgType.GroupNotice, g.user_id, g.user_name, a.is_top == 'Y' ? 'Y' : 'N', a.creator_id, a.create_at, a.from_erp]);
            var c = [];
            for (var e = 0; e < a.members.length; e++) {
                c.push(a.members[e].user_id)
            }
            c = c.join(',');
            var i = 'INSERT INTO IMChat (ChatID, ChatType, DisplayName, CreatorID, ManagerID, CreateAt, UserIDs, Status, UpdateAt, AvatarHash, FromERP) VALUES(?,?,?,?,?,?,?,?,?,?,?);';
            d.executeSql(i, [a.chat_id, a.chat_type, a.header, a.creator_id, a.manager_id, a.create_at, c, '0', a.update_at, a.avatar_hash, a.from_erp]);
            var j = 'INSERT INTO IMMsg (MsgID, ChatID, MsgType, Content, CreateAt, Status, SenderID, SenderName, MsgSeq) VALUES (?,?,?,?,?,?,?,?,?)';
            d.executeSql(j, [b[0].msg_id, a.chat_id, MsgType.GroupNotice, f, a.create_at, '0', b[0].user_id, b[0].user_name, b[0].msg_seq])
        })
    },
    updateRctBySend: function (a, d, c, b) {
        var e = 'UPDATE IMRct SET LastPostAt=?, LastUserID=?, LastUserName=?, LastMessage=?, LastMsgType=? WHERE ChatID=?;';
        this.cExecSqlWithP(e, [d, User.ownerID, User.crtUser.user_name, a, b, c])
    },
    aboutIMChat: function (a) {
        if (a.iscrowd == 'Y') {
            a.chat_type = 'C'
        }
        var b = 'INSERT OR REPLACE INTO IMRct (ChatID, DisplayName, ChatType, UnreadCount, LastPostAt,LastMsgType, UserID, CreateAt) VALUES (?,?,?,?,?,?,?,?);';
        LocalDataMgr.cExecSqlWithP(b, [a.chat_id, User.crtChatName, a.chat_type, '0', a.last_post_at, a.last_msg_type, ParseUtil.getDctIdFromMems(a.members), a.create_at])
    },
    rctSetUnreadToRead: function (a) {
        var b = 'UPDATE IMRct SET UnreadCount=0 WHERE ChatID=?;';
        this.cExecSqlWithP(b, [a])
    },
    rctSetAllRead: function () {
        var a = 'UPDATE IMRct SET UnreadCount=0';
        this.cExecSqlWithP(a)
    },
    rctUpdateHeader: function (b, a) {
        var c = this;
        c.getDB().transaction(function (c) {
            var d = 'UPDATE IMRct SET DisplayName=? WHERE ChatID=?;';
            c.executeSql(d, [a, b])
        })
    },
    initAddToMsg: function (d) {
        var b = this;
        for (var e = 0; e < d.length; e++) {
            var a = d[e].message;
            if (d[e].wrapper_type == MsgWrapperType.Message) {
                switch (a.msg_type) {
                    case MsgType.TextMsg:
                        b.initTextMsg(d[e]);
                        break;
                    case MsgType.ImgMsg:
                        b.initImgMsg(d[e]);
                        break;
                    case MsgType.FileMsg:
                        b.initFileMsg(d[e]);
                        break;
                    case MsgType.LinkErp:
                        b.initERPLinkMsg(d[e]);
                        break;
                    case NoticeType.CreateGrp:
                        var c = GroupNotice.cNewGrpByStrs(a.user_id, a.user_name, a.message, a.message_ex);
                        b.initGrpNoticeMsg(a, c);
                        break;
                    case NoticeType.AddMem:
                        var c = GroupNotice.cAddGrpByStrs(a.user_id, a.user_name, a.message, a.message_ex);
                        var g = '0',
                            i = a.message.concat(','),
                            k = User.ownerID + ',';
                        if (i.indexOf(k) >= 0) {
                            g = '99'
                        };
                        b.initGrpNoticeMsg2(a, c, g);
                        break;
                    case NoticeType.ChgTitle:
                        var c = GroupNotice.chgName(a.user_name, a.message);
                        b.initGrpNoticeMsg(a, c);
                        break;
                    case NoticeType.RemoveMem:
                        var c = GroupNotice.removeMem(a.user_id, a.user_name, a.message, a.message_ex);
                        if (User.ownerID == a.user_id || User.ownerID == a.message) {
                            b.initGrpNoticeMsg(a, c)
                        } else {
                            b.initGrpWithoutMeMsg(a, c)
                        };
                        break;
                    case NoticeType.CrowdSetAdmin:
                        var m = a.message.split(',')[0];
                        var c = GroupNotice.CrowdsetAdmin(a.user_id, a.user_name, a.message);
                        if (User.ownerID == a.user_id || User.ownerID == m) {
                            b.initGrpNoticeMsg(a, c)
                        } else {
                            b.initCrowdWithoutMeMsg(a, c)
                        };
                        break;
                    case NoticeType.HisChange:
                        var c = GroupNotice.changeHisat(a.user_id, a.message);
                        if (User.ownerID == a.message) {
                            b.initGrpNoticeMsg(a, c)
                        } else {
                            if (User.ownerID == a.user_id) {
                                var f;
                                if (Config.isPhone || Config.isPad) {
                                    f = '<span class="' + User.userInfos[a.message].user_id + '">您收到一条通知，请于PC端查看</span>'
                                } else {
                                    f = '<span class="' + User.userInfos[a.message].user_id + '">' + User.userInfos[a.message].user_name + '申请查看更多历史消息</span> ' + '     <a>设置</a>'
                                }
                                c = f;
                                b.initGrpNoticeMsg(a, c)
                            } else {
                                b.initGrpWithoutMeMsg(a, c)
                            }
                        };
                        break;
                    case NoticeType.DismissMultiChat:
                        var h = GroupNotice.dismissMultiChat(a.user_id);
                        b.initGrpNoticeMsg(a, h);
                        break;
                    case NoticeType.RecoverMultiChat:
                        var j = GroupNotice.recoverMultiChat(a.user_id);
                        b.initGrpNoticeMsg(a, j);
                        break;
                    case NoticeType.JoinERPMultiChat:
                        var l = GroupNotice.joinERPChat(a.user_id);
                        b.initGrpNoticeMsg(a, l);
                        break;
                    case NoticeType.ChgManager:
                        var c = GroupNotice.chgMgr(a.user_id, a.user_name, a.message, a.message_ex);
                        if (User.ownerID == a.user_id || User.ownerID == a.message) {
                            b.initGrpNoticeMsg(a, c)
                        } else {
                            b.initGrpWithoutMeMsg(a, c)
                        };
                        break;
                    case MsgType.Revoke:
                        b.initRevoke(a);
                        break;
                    case MsgType.BigFileMsg:
                        b.initBFileMsg(a);
                        break;
                    case NoticeType.FirstReply:
                        b.initFirstReply(a);
                        break;
                    default:
                        break;
                }
            }
        }
        b.doInitMsgMention(d.mentions)
    },
    initFirstReply: function (a) {
        this.beforeDoMsg(a.msg_id, function () {}, function (b) {
            var c = 'INSERT INTO IMMsg (MsgID,ChatID,MsgType,Content,CreateAt,SenderID,SenderName,Status,MsgSeq) VALUES (?,?,?,?,?,?,?,?,?)';
            b.executeSql(c, [a.msg_id, a.chat_id, MsgType.NotShow, a.message, a.create_at, a.user_id, a.user_name, '0', a.msg_seq]);
            var d = 'UPDATE IMMsg SET ReplyCount=? WHERE ChatID=? AND UserID<>? AND MsgID=?;';
            b.executeSql(d, [a.reply_count, a.chat_id, a.user_id, a.message])
        })
    },
    doInitMsgMention: function (a) {
        if (Ext.isArray(a) && a.length > 0) {
            for (var b = 0; b < a.length; b++) {
                this.cExecSqlWithP('UPDATE IMMsg SET HasMention=? WHERE MsgID=?;', ['Y', a[b].msg_id])
            }
        }
    },
    initBFileMsg: function (a) {
        this.beforeDoMsg(a.msg_id, function () {}, function (b) {
            console.log('dawenjian' + a.msg_id);
            var c = 'INSERT INTO IMMsg (MsgID,ChatID,MsgType,Content,CreateAt,SenderID,SenderName,Status,MsgSeq,NewReply,ReplyCount) VALUES (?,?,?,?,?,?,?,?,?,?,?)';
            b.executeSql(c, [a.msg_id, a.chat_id, a.msg_type, a.message, a.create_at, a.user_id, a.user_name, '0', a.msg_seq, a.new_reply, a.reply_count]);
            var d = 'SELECT ID FROM IMMsg WHERE MsgID=?;';
            b.executeSql(d, [a.msg_id], function (h, e) {
                var d = e.rows;
                if (d.length > 0) {
                    var f = d.item(0).ID;
                    var g = 'INSERT INTO IMBFile (BFileID,BaseID,ChatID,UserID,BFileName,BFileSize,BFileExtension,BFileStatus,CreateAt) VALUES (?,?,?,?,?,?,?,?,?);';
                    var c = ParseUtil.getBFileNS(a.message);
                    h.executeSql(g, [a.attach_id, f, a.chat_id, a.user_id, c.fileName, c.fileSize, FileUtil.getExtension(c.fileName), c.fileStatus, a.create_at])
                }
            })
        })
    },
    initRevokeMsg: function (b) {
        for (var a = 0; a < b.length; a++) {
            this.initRevoke(b[a].message);
            this.doChgPageRevoke(b[a].message)
        }
    },
    doChgPageRevoke: function (a) {
        this.revokeUpdateRct(a.chat_id, a.msg_id, a.user_id, a.message, function () {
            if (Config.isPC) {
                var c = Ext.getStore(a.chat_id);
                if (!c) {
                    return
                }
                var d = GroupNotice.getRevokeNotice(a.user_id, a.message);
                var b = c.getById(a.msg_id);
                if (b) {
                    b.set({
                        msg_type: MsgType.Revoke,
                        senderID: a.user_id,
                        senderName: User.userInfos[a.user_id].user_name,
                        sendText: d
                    })
                }
            }
        });
        var d = 'SELECT MsgID FROM IMMsgA WHERE MsgID=? AND Status=?;';
        this.cExecSqlWithP(d, [a.msg_id, 0], function (e, b) {
            var c = b.rows;
            if (c.length > 0) {
                var d = 'UPDATE IMMsgA SET Status=? WHERE MsgID=?;';
                e.executeSql(d, [1, a.msg_id]);
                if (Config.isPC) {
                    DesktopChatUtil.doPageRemoveMention(a.chat_id, !0)
                }
            }
        });
        if (Config.isPC) {
            var c = Ext.getStore(a.chat_id);
            if (!c) {
                return
            }
            var b = c.getById(a.msg_id);
            if (b) {
                b.set({
                    msg_type: MsgType.Revoke,
                    senderID: a.user_id,
                    senderName: User.userInfos[a.user_id].user_name
                })
            }
        }
    },
    initRevoke: function (a) {
        var b = 'SELECT * FROM IMMsg WHERE MsgID=?;';
        this.cExecSqlWithP(b, [a.msg_id], function (b, e) {
            var c = e.rows;
            if (c.length > 0) {
                var d = c.item(0);
                LocalDataMgr.revokeDeleteDetail(d.ID, d.MsgType);
                var f = 'UPDATE IMMsg SET SenderName=?,SenderID=?,MsgType=?,Content=? WHERE MsgID=?;';
                b.executeSql(f, [User.getUserName(a.user_id), a.user_id, MsgType.Revoke, a.message, a.msg_id]);
                if (Config.isDesktop) {
                    if (a.msg_type == MsgType.BigFileMsg) {
                        DesktopChatUtil.doBFileRevoke(JSON.stringify([{
                            msg_id: a.msg_id
                        }]))
                    }
                }
            } else {
                var g = 'INSERT INTO IMMsg (MsgID,ChatID,MsgType,Content,CreateAt,SenderID,SenderName,Status,MsgSeq) VALUES (?,?,?,?,?,?,?,?,?);';
                b.executeSql(g, [a.msg_id, a.chat_id, a.msg_type, a.message, a.create_at, a.user_id, a.user_name, '0', a.msg_seq])
            }
        })
    },
    initTextMsg: function (a) {
        var b = a.message;
        this.beforeDoMsg(b.msg_id, function () {}, function (d) {
            var b = a.message;
            var c = 'INSERT INTO IMMsg (MsgID,ChatID,MsgType,Content,CreateAt,SenderID,SenderName,Status,MsgSeq,ReplyCount,NewReply) VALUES (?,?,?,?,?,?,?,?,?,?,?)';
            d.executeSql(c, [b.msg_id, b.chat_id, b.msg_type, b.message, b.create_at, b.user_id, b.user_name, '0', b.msg_seq, b.reply_count, b.new_reply])
        })
    },
    initImgMsg: function (c) {
        var a = c.message,
            b = c.file;
        this.beforeDoMsg(a.msg_id, function () {}, function (f) {
            var d = Config.httpUrlForGo + 'files/' + a.attach_id;
            var e = 'INSERT INTO IMMsg (MsgID,ChatID,MsgType,Content,CreateAt,SenderID,SenderName,Status,MsgSeq,NewReply,ReplyCount) VALUES (?,?,?,?,?,?,?,?,?,?,?)';
            f.executeSql(e, [a.msg_id, a.chat_id, a.msg_type, d, a.create_at, a.user_id, a.user_name, '0', a.msg_seq, a.new_reply, a.reply_count], function (e) {
                var g = 'SELECT ID FROM IMMsg WHERE MsgID=?;';
                e.executeSql(g, [a.msg_id], function (k, h) {
                    var g = h.rows;
                    if (g.length > 0) {
                        var i = g.item(0).ID;
                        var j = 'INSERT INTO IMFile (FileID,BaseID,ChatID,FileType,FilePath,FileName,Width,Height,Extension,CreateAt,FileSize,FileStatus) VALUES (?,?,?,?,?,?,?,?,?,?,?,?);';
                        k.executeSql(j, [b.file_id, i, a.chat_id, a.msg_type, d, b.file_name, b.width, b.height, b.extension, b.create_at, b.size, 1])
                    }
                })
            })
        })
    },
    initFileMsg: function (c) {
        var a = c.message,
            b = c.file;
        this.beforeDoMsg(a.msg_id, function () {}, function (f) {
            var d = Config.httpUrlForGo + 'files/' + a.attach_id;
            var e = 'INSERT INTO IMMsg (MsgID,ChatID,MsgType,Content,CreateAt,SenderID,SenderName,Status,MsgSeq,NewReply,ReplyCount) VALUES (?,?,?,?,?,?,?,?,?,?,?)';
            f.executeSql(e, [a.msg_id, a.chat_id, a.msg_type, d, a.create_at, a.user_id, a.user_name, '0', a.msg_seq, a.new_reply, a.reply_count], function (e) {
                var g = 'SELECT ID FROM IMMsg WHERE MsgID=?;';
                e.executeSql(g, [a.msg_id], function (k, h) {
                    var g = h.rows;
                    if (g.length > 0) {
                        var i = g.item(0).ID;
                        var j = 'INSERT INTO IMFile (FileID,BaseID,ChatID,FileType,FilePath,FileName,Width,Height,Extension,CreateAt,FileSize,FileStatus) VALUES (?,?,?,?,?,?,?,?,?,?,?,?);';
                        k.executeSql(j, [b.file_id, i, a.chat_id, a.msg_type, d, b.file_name, b.width, b.height, b.extension, b.create_at, b.size, 3])
                    }
                })
            })
        })
    },
    initERPLinkMsg: function (c) {
        var b = c.message,
            a = c.link;
        this.beforeDoMsg(b.msg_id, function () {}, function (e) {
            var d = 'INSERT INTO IMMsg (MsgID,ChatID,MsgType,Content,CreateAt,SenderID,SenderName,Status,MsgSeq,NewReply,ReplyCount) VALUES (?,?,?,?,?,?,?,?,?,?,?)';
            e.executeSql(d, [b.msg_id, b.chat_id, b.msg_type, b.message, b.create_at, b.user_id, b.user_name, '0', b.msg_seq, b.new_reply, b.reply_count], function (d) {
                if (a) {
                    var f = 'SELECT ID FROM IMMsg WHERE MsgID=?;';
                    d.executeSql(f, [b.msg_id], function (j, g) {
                        var f = g.rows;
                        if (f.length > 0) {
                            var h = f.item(0).ID;
                            var i = 'INSERT INTO IMLink (LID, ChatID, baseID, Type, LinkObjType, CorpID, LinkKeyString, LinkTitle, LinkID, LinkType, LinkOpUser, LinkDesc, LinkStr, LinkFromID, LinkStepID, LinkStepDesc, LinkStepStatus, LinkStatus, LinkStgGuid) VALUES (?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)';
                            j.executeSql(i, [a.lid, b.chat_id, h, a.type, a.link_obj_type, a.link_corp_id, a.link_key_string, a.link_title, a.link_id, a.link_type, a.link_op_user, a.link_desc, a.link_str, a.link_from_id, a.link_step_id, a.link_step_desc, a.link_step_status, a.link_status, a.link_stg_guid])
                        }
                    })
                }
            })
        })
    },
    initGrpNoticeMsg: function (a, b) {
        this.beforeDoMsg(a.msg_id, function () {}, function (d) {
            var c = 'INSERT INTO IMMsg (MsgID,ChatID,MsgType,Content,CreateAt,SenderID,SenderName,Status,MsgSeq) VALUES (?,?,?,?,?,?,?,?,?)';
            d.executeSql(c, [a.msg_id, a.chat_id, MsgType.GroupNotice, b, a.create_at, a.user_id, a.user_name, '0', a.msg_seq])
        })
    },
    initGrpNoticeMsg2: function (a, b, c) {
        this.beforeDoMsg(a.msg_id, function () {}, function (e) {
            var d = 'INSERT INTO IMMsg (MsgID,ChatID,MsgType,Content,CreateAt,SenderID,SenderName,Status,MsgSeq) VALUES (?,?,?,?,?,?,?,?,?)';
            e.executeSql(d, [a.msg_id, a.chat_id, MsgType.GroupNotice, b, a.create_at, a.user_id, a.user_name, c, a.msg_seq])
        })
    },
    initGrpWithoutMeMsg: function (a, b) {
        this.beforeDoMsg(a.msg_id, function () {}, function (d) {
            var c = 'INSERT INTO IMMsg (MsgID,ChatID,MsgType,Content,CreateAt,SenderID,SenderName,Status,MsgSeq) VALUES (?,?,?,?,?,?,?,?,?)';
            d.executeSql(c, [a.msg_id, a.chat_id, MsgType.NotShow, b, a.create_at, a.user_id, a.user_name, '0', a.msg_seq])
        })
    },
    initCrowdWithoutMeMsg: function (a, b) {
        this.beforeDoMsg(a.msg_id, function () {}, function (d) {
            var c = 'INSERT INTO IMMsg (MsgID,ChatID,MsgType,Content,CreateAt,SenderID,SenderName,Status,MsgSeq) VALUES (?,?,?,?,?,?,?,?,?)';
            d.executeSql(c, [a.msg_id, a.chat_id, NoticeType.CrowdSetAdmin, b, a.create_at, a.user_id, a.user_name, '0', a.msg_seq])
        })
    },
    initCreateGrpMsg: function (c) {
        var a = c.message,
            b = GroupNotice.cNewGrpByStrs(a.user_id, a.user_name, a.message, a.message_ex);
        var d = 'INSERT INTO IMMsg (MsgID,ChatID,MsgType,Content,CreateAt,SenderID,SenderName,Status,MsgSeq) VALUES (?,?,?,?,?,?,?,?,?)';
        this.cExecSqlWithP(d, [a.msg_id, a.chat_id, MsgType.GroupNotice, b, a.create_at, a.user_id, a.user_name, '0', a.msg_seq])
    },
    initAddMemMsg: function (c) {
        var a = c.message,
            b = GroupNotice.cAddGrpByStrs(a.user_id, a.user_name, a.message, a.message_ex);
        var d = 'INSERT INTO IMMsg (MsgID,ChatID,MsgType,Content,CreateAt,SenderID,SenderName,Status,MsgSeq) VALUES (?,?,?,?,?,?,?,?,?)';
        this.cExecSqlWithP(d, [a.msg_id, a.chat_id, MsgType.GroupNotice, b, a.create_at, a.user_id, a.user_name, '0', a.msg_seq])
    },
    initChgTitleMsg: function (c) {
        var a = c.message,
            b = GroupNotice.chgName(a.user_name, a.message);
        var d = 'INSERT INTO IMMsg (MsgID,ChatID,MsgType,Content,CreateAt,SenderID,SenderName,Status,MsgSeq) VALUES (?,?,?,?,?,?,?,?,?)';
        this.cExecSqlWithP(d, [a.msg_id, a.chat_id, MsgType.GroupNotice, b, a.create_at, a.user_id, a.user_name, '0', a.msg_seq])
    },
    execSendWrapperMsg: function (d, c) {
        for (var b = 0; b < d.length; b++) {
            var a = d[b];
            switch (a.msg_type) {
                case MsgType.TextMsg:
                    this.doSendTextLocal(a, c);
                    break;
                case MsgType.ImgMsg:
                    this.doSendImgLocal(a, c);
                    break;
                case MsgType.FileMsg:
                    this.doSendFileLocal(a);
                    break;
                case MsgType.BigFileMsg:
                    this.doSendBFileLocal(a);
                    break;
                default:
                    break;
            }
        }
    },
    doSendTextLocal: function (a, c) {
        var b = 'N';
        if (c && c.length > 0) {
            b = 'Y'
        }
        var e = 'INSERT INTO IMMsg (MsgID, ChatID, MsgType, Content, CreateAt, SenderID, SenderName, Status, HasMention) VALUES (?,?,?,?,?,?,?,?,?);';
        var d = a.sendText;
        this.cExecSqlWithP(e, [a.localMsgID, a.chatID, MsgType.TextMsg, d, a.updateTime, a.senderID, a.senderName, '1', b])
    },
    doSendImgLocal: function (a, c) {
        var b = 'N';
        if (c && c.length > 0) {
            b = 'Y'
        }
        var d = 'INSERT INTO IMMsg (MsgID, ChatID, MsgType, Content, CreateAt, SenderID, SenderName, Status, HasMention) VALUES (?,?,?,?,?,?,?,?,?);';
        this.cExecSqlWithP(d, [a.localMsgID, a.chatID, MsgType.ImgMsg, a.localPath, a.updateTime, a.senderID, a.senderName, '1', b], function (b, e) {
            var d = 'SELECT ID FROM IMMsg WHERE MsgID=?';
            b.executeSql(d, [a.localMsgID], function (j, h) {
                var d = h.rows;
                if (d.length > 0) {
                    var g = d.item(0).ID;
                    var i = 'INSERT INTO IMFile (ChatID, BaseID, CreateAt, Width, Height, FileType, Extension, FileName, FilePath, MimeType, FileStatus) VALUES (?,?,?,?,?,?,?,?,?,?,?);';
                    var f = FileUtil.getExtension(a.localPath);
                    j.executeSql(i, [a.chatID, g, a.updateTime, a.width, a.height, MsgType.ImgMsg, f, a.fileName, a.localPath, MimeType.getMimeType(f), 1])
                } else {
                    LogUtil.writeLogErr('发送图片时，在本地插入数据时没有找到刚刚插入MsgID为' + a.localMsgID + '的Msg')
                }
            })
        })
    },
    doSendFileLocal: function (a) {
        var b = 'INSERT INTO IMMsg (MsgID, ChatID, MsgType, Content, CreateAt, SenderID, SenderName, Status) VALUES (?,?,?,?,?,?,?,?);';
        this.cExecSqlWithP(b, [a.localMsgID, a.chatID, MsgType.FileMsg, a.localPath, a.updateTime, a.senderID, a.senderName, '1'], function (b, d) {
            var c = 'SELECT ID FROM IMMsg WHERE MsgID=?';
            b.executeSql(c, [a.localMsgID], function (i, g) {
                var c = g.rows;
                if (c.length > 0) {
                    var f = c.item(0).ID;
                    var h = 'INSERT INTO IMFile (ChatID, BaseID, CreateAt, FileSize, FileType, Extension, FileName, FilePath, MimeType, FileStatus) VALUES (?,?,?,?,?,?,?,?,?,?);';
                    var e = FileUtil.getExtension(a.localPath);
                    i.executeSql(h, [a.chatID, f, a.updateTime, a.fileSize, MsgType.FileMsg, e, a.fileName, a.localPath, MimeType.getMimeType(e), 1])
                } else {
                    LogUtil.writeLogErr('发送文件时，在本地插入数据时没有找到刚刚插入MsgID为' + a.localMsgID + '的Msg')
                }
            })
        })
    },
    doSendBFileLocal: function (a) {
        console.log('大文件的内容1' + a.localMsgID);
        var c = this;
        var b = 'INSERT INTO IMMsg (MsgID, ChatID, MsgType, Content, CreateAt, SenderID, SenderName, Status) VALUES (?,?,?,?,?,?,?,?);';
        c.cExecSqlWithP(b, [a.localMsgID, a.chatID, MsgType.BigFileMsg, a.localPath, a.updateTime, a.senderID, a.senderName, '1'], function (b, d) {
            var c = 'SELECT ID FROM IMMsg WHERE MsgID=?';
            b.executeSql(c, [a.localMsgID], function (h, f) {
                var c = f.rows;
                if (c.length > 0) {
                    var e = c.item(0).ID;
                    var g = 'INSERT INTO IMBFile \n                            (BaseID, ChatID, UserID, BFilePath, BFileName, BFileSize, BFileExtension, BFileStatus, CreateAt) \n                            VALUES (?,?,?,?,?,?,?,?,?)';
                    h.executeSql(g, [e, a.chatID, a.senderID, a.localPath, a.fileName, a.fileSize + '', FileUtil.getExtension(a.fileName), 1, a.updateTime])
                } else {
                    LogUtil.writeLogErr('发送大文件时，在本地插入数据时没有找到刚刚插入MsgID为' + a.localMsgID + '的Msg')
                }
            })
        })
    },
    doSendTextSuccess: function (b, a) {
        var c = 'UPDATE IMMsg SET MsgID=?, MsgSeq=?, status=?, CreateAt=?, UnReadCount = ? WHERE MsgID=?;';
        this.cExecSqlWithP(c, [a.msg_id, a.msg_seq, '0', a.create_at, a.unread_count, b.localMsgID])
    },
    doSendImgSuccess: function (b, a) {
        var c = 'UPDATE IMMsg SET MsgID=?, MsgSeq=?, Status=?, CreateAt=?, UnReadCount = ? WHERE MsgID=?;';
        this.cExecSqlWithP(c, [a.msg_id, a.msg_seq, '0', a.create_at, a.unread_count, b.localMsgID]);
        var d = 'SELECT ID FROM IMMsg WHERE MsgID=?';
        this.cExecSqlWithP(d, [a.msg_id], function (g, e) {
            var c = e.rows;
            if (c.length > 0) {
                var d = c.item(0).ID;
                var f = 'UPDATE IMFile SET FileID=?,CreateAt=?,HasPreview=? WHERE BaseID=?;';
                g.executeSql(f, [a.attach_id, a.create_at, 'N', d])
            } else {
                LogUtil.writeLogErr('发送图片成功后，在本地插入数据时没有找到刚刚插入MsgID为' + b.localMsgID + '的Msg')
            }
        })
    },
    doSendFileSuccess: function (b, a) {
        var c = 'UPDATE IMMsg SET MsgID=?, MsgSeq=?, Status=?, CreateAt=?, UnReadCount = ? WHERE MsgID=?;';
        this.cExecSqlWithP(c, [a.msg_id, a.msg_seq, '0', a.create_at, a.unread_count, b.localMsgID]);
        var d = 'SELECT ID FROM IMMsg WHERE MsgID=?';
        this.cExecSqlWithP(d, [a.msg_id], function (g, e) {
            var c = e.rows;
            if (c.length > 0) {
                var d = c.item(0).ID;
                var f = 'UPDATE IMFile SET FileID=?,CreateAt=? WHERE BaseID=?;';
                g.executeSql(f, [a.attach_id, a.create_at, d])
            } else {
                LogUtil.writeLogErr('发送文件成功后，在本地插入数据时没有找到刚刚插入MsgID为' + b.localMsgID + '的Msg')
            }
        })
    },
    doSendBFileSuccess: function (b, a) {
        var c = 'UPDATE IMMsg SET MsgID=?, MsgSeq=?, Status=?, CreateAt=?, UnReadCount = ? WHERE MsgID=?;';
        this.cExecSqlWithP(c, [a.msg_id, a.msg_seq, '0', a.create_at, a.unread_count, b.localMsgID]);
        var d = 'SELECT ID FROM IMMsg WHERE MsgID=?';
        this.cExecSqlWithP(d, [a.msg_id], function (g, e) {
            var c = e.rows;
            if (c.length > 0) {
                var d = c.item(0).ID;
                var f = 'UPDATE IMBFile SET BFileID=?,CreateAt=? WHERE BaseID=?;';
                g.executeSql(f, [a.attach_id, a.create_at, d])
            } else {
                LogUtil.writeLogErr('发送文件成功后，在本地插入数据时没有找到刚刚插入MsgID为' + b.localMsgID + '的Msg')
            }
        })
    },
    execSendText: function (c, a, b) {
        var d = 'INSERT INTO IMMsg (ChatID, MsgType, Content, CreateAt, SenderID, SenderName, Status) VALUES (?,?,?,?,?,?,?);';
        this.cExecSqlWithP(d, [c, MsgType.TextMsg, a, ParseUtil.getLocalTime(!0), User.ownerID, User.crtUser.user_name, '1']);
        var e = 'select seq from sqlite_sequence where name=?';
        this.cExecSqlWithP(e, ['IMMsg'], function (g, f) {
            var d = 1;
            var e = f.rows;
            if (e.length > 0) {
                d = e.item(0).seq
            }
            b(d)
        })
    },
    execSendTextPC: function (d, e, b, c, a) {
        var f = 'INSERT INTO IMMsg (MsgID, ChatID, MsgType, Content, CreateAt, SenderID, SenderName, Status) VALUES (?,?,?,?,?,?,?,?);';
        this.cExecSqlWithP(f, [d, e, MsgType.TextMsg, b, c, User.ownerID, User.crtUser.user_name, '1']);
        if (Ext.isFunction(a)) {
            var g = 'select seq from sqlite_sequence where name=?';
            this.cExecSqlWithP(g, ['IMMsg'], function (i, h) {
                var f = 1;
                var g = h.rows;
                if (g.length > 0) {
                    f = g.item(0).seq
                }
                a(f)
            })
        }
    },
    execSendImg: function (a, b) {
        var c = 'INSERT INTO IMMsg (MsgID, ChatID, MsgType, Content, CreateAt, SenderID, SenderName, Status) VALUES (?,?,?,?,?,?,?,?);';
        this.cExecSqlWithP(c, [a.localMsgID, a.chat_id, MsgType.ImgMsg, a.path, a.nowTime, User.ownerID, User.crtUser.user_name, '1']);
        var d = 'select seq from sqlite_sequence where name=?';
        this.cExecSqlWithP(d, ['IMMsg'], function (i, f) {
            var c = 1;
            var d = f.rows;
            if (d.length > 0) {
                c = d.item(0).seq
            }
            var e = FileUtil.getExtension(a.path),
                g = FileUtil.getFileName(a.path);
            var h = 'INSERT INTO IMFile (ChatID, BaseID, CreateAt, Width, Height, FileType, Extension, FileName, FilePath, MimeType, FileStatus) VALUES (?,?,?,?,?,?,?,?,?,?,?);';
            i.executeSql(h, [a.chat_id, c, a.nowTime, a.width, a.height, MsgType.ImgMsg, e, g, a.path, MimeType.getMimeType(e), 1]);
            b(c)
        })
    },
    execSendFile: function (a, b) {
        var c = 'INSERT INTO IMMsg (MsgID, ChatID, MsgType, Content, CreateAt, SenderID, SenderName, Status) VALUES (?,?,?,?,?,?,?,?);';
        this.cExecSqlWithP(c, [a.localMsgID, a.chat_id, MsgType.FileMsg, a.path, a.nowTime, User.ownerID, User.crtUser.user_name, '1']);
        var d = 'select seq from sqlite_sequence where name=?';
        this.cExecSqlWithP(d, ['IMMsg'], function (j, f) {
            var c = 1;
            var d = f.rows;
            if (d.length > 0) {
                c = d.item(0).seq
            }
            var e = FileUtil.getExtension(a.path),
                h = FileUtil.getFileName(a.path),
                g = MimeType.getMimeType(e);
            var i = 'INSERT INTO IMFile (ChatID, BaseID, CreateAt, FileSize, FileType, Extension, FileName, MimeType, FilePath, FileStatus) VALUES (?,?,?,?,?,?,?,?,?,?);';
            j.executeSql(i, [a.chat_id, c, a.nowTime, a.size, MsgType.FileMsg, e, h, g, a.path, 1]);
            b(c)
        })
    },
    updateSendText: function (a, b) {
        var c = this;
        c.getDB().transaction(function (c) {
            var d = 'UPDATE IMMsg SET MsgID=?, MsgSeq=?, status=?, CreateAt=? WHERE ID=?;';
            c.executeSql(d, [a.msg_id, a.msg_seq, '0', a.create_at, b])
        })
    },
    updateSendImg: function (a, b) {
        var c = this;
        var d = 'UPDATE IMMsg SET MsgID=?, MsgSeq=?, Status=?, CreateAt=? WHERE ID=?;';
        c.cExecSqlWithP(d, [a.msg_id, a.msg_seq, '0', a.create_at, b]);
        var e = 'UPDATE IMFile SET FileID=?,CreateAt=?,HasPreview=? WHERE BaseID=?;';
        c.cExecSqlWithP(e, [a.attach_id, a.create_at, 'N', b])
    },
    afterDownGifSuc: function (a, b) {
        if (!b) {
            b = ParseUtil.getRelativeImgPath(a.file_id + '.' + a.extension, a.create_at)
        } else {
            b = ParseUtil.parseRelativePath(b)
        }
        var c = 'UPDATE IMFile SET Extension=?, ChatID=?, FilePath=?, FileType=?, FileName=?, MimeType=?, CreateAt=?, Width=?, Height=?, FileSize=?, FileStatus=?, HasPreview=? WHERE FileID=?;';
        this.cExecSqlWithP(c, [a.extension, a.chat_id, b, MsgType.ImgMsg, a.file_name, a.mime_type, a.create_at, a.width, a.height, a.size, 0, 'N', a.file_id])
    },
    afterUploadSuc: function (a, c, b) {
        var d = this;
        if (Ext.isEmpty(b)) {
            b = 'Y'
        }
        if (Ext.isBoolean(b)) {
            b = b ? 'Y' : 'N'
        }
        if (!c) {
            c = ParseUtil.getRelativeImgPath(a.file_id + '.' + a.extension, a.create_at)
        } else {
            c = ParseUtil.parseRelativePath(c)
        }
        d.getDB().transaction(function (d) {
            var e = 'SELECT ID FROM IMMsg WHERE MsgID=?;';
            d.executeSql(e, [a.msg_id], function (h, e) {
                if (e.rows.length > 0) {
                    var f = e.rows.item(0).ID;
                    var g = 'UPDATE IMFile SET Extension=?, ChatID=?, FilePath=?, FileType=?, FileName=?, MimeType=?, CreateAt=?, Width=?, Height=?, FileSize=?, FileStatus=?, HasPreview=? WHERE baseID=?;';
                    h.executeSql(g, [a.extension, a.chat_id, c, MsgType.ImgMsg, a.file_name, a.mime_type, a.create_at, a.width, a.height, a.size, 0, b, f])
                }
            })
        })
    },
    updateSendFile: function (a, b) {
        var c = this;
        var d = 'UPDATE IMMsg SET MsgID=?, MsgSeq=?, Status=?, CreateAt=? WHERE ID=?;';
        c.cExecSqlWithP(d, [a.msg_id, a.msg_seq, '0', a.create_at, b]);
        var e = 'UPDATE IMFile SET FileID=?,CreateAt=? WHERE BaseID=?;';
        c.cExecSqlWithP(e, [a.attach_id, a.create_at, b])
    },
    afterDownFileSuc: function (a, b) {
        var c = this;
        if (!b) {
            b = ParseUtil.getRelativeFilePath(a.file_name, a.create_at)
        } else {
            b = ParseUtil.parseRelativePath(b)
        }
        c.getDB().transaction(function (c) {
            var d = 'SELECT ID FROM IMMsg WHERE MsgID=?;';
            c.executeSql(d, [a.msg_id], function (g, d) {
                if (d.rows.length > 0) {
                    var e = d.rows.item(0).ID;
                    var f = 'UPDATE IMFile SET Extension=?, ChatID=?, FilePath=?, FileType=?, FileName=?, MimeType=?, CreateAt=?, Width=?, Height=?, FileSize=?, FileStatus=?, DeleteAt=? WHERE baseID=?;';
                    g.executeSql(f, [a.extension, a.chat_id, b, MsgType.FileMsg, a.file_name, a.mime_type, a.create_at, a.width, a.height, a.size, 0, 0, e])
                }
            })
        })
    },
    afterUpFileSucNew: function (a) {
        var b = this;
        b.getDB().transaction(function (b) {
            var c = 'SELECT ID FROM IMMsg WHERE MsgID=?;';
            b.executeSql(c, [a.msg_id], function (f, c) {
                if (c.rows.length > 0) {
                    var d = c.rows.item(0).ID;
                    var e = 'UPDATE IMFile SET Extension=?, ChatID=?, FileType=?, FileName=?, MimeType=?, CreateAt=?, Width=?, Height=?, FileSize=?, FileStatus=? WHERE baseID=?;';
                    f.executeSql(e, [a.extension, a.chat_id, MsgType.FileMsg, a.file_name, a.mime_type, a.create_at, a.width, a.height, a.size, 0, d])
                }
            })
        })
    },
    addMsgByWS: function (a) {
        var b = this;
        switch (a.msg_type) {
            case MsgType.TextMsg:
                b.addTextMsgByWS(a);
                break;
            case MsgType.ImgMsg:
                b.addImgMsgByWS(a);
                break;
            case MsgType.FileMsg:
                b.addFileMsgByWS(a);
                break;
            case MsgType.GroupNotice:
                b.addNoticeByWS(a);
                break;
            case MsgType.BigFileMsg:
                b.addBFileMsgByWS(a);
                break;
            default:
                console.log('暂未支持该类型：', a.msg_type);
        }
    },
    addTextMsgByWS: function (a) {
        this.getDB().transaction(function (b) {
            var c = 'INSERT INTO IMMsg(MsgID, ChatID, MsgType, Content, CreateAt, SenderID, SenderName, Status, MsgSeq, HasMention, ReadCount, UnReadCount) VALUES (?,?,?,?,?,?,?,?,?,?,?,?)';
            b.executeSql(c, [a.msg_id, a.chat_id, a.msg_type, a.message, a.create_at, a.user_id, a.user_name, '0', a.msg_seq, a.hasMention ? 'Y' : 'N', a.read_count, a.unread_count])
        })
    },
    addImgMsgByWS: function (a) {
        var c = 'INSERT INTO IMMsg (MsgID, ChatID, MsgType, Content, CreateAt, SenderID, SenderName, Status, MsgSeq, HasMention, ReadCount, UnReadCount) VALUES(?,?,?,?,?,?,?,?,?,?,?,?);';
        var b = Config.httpUrlForGo + 'files/' + a.attach_id;
        this.cExecSqlWithP(c, [a.msg_id, a.chat_id, a.msg_type, b, a.create_at, a.user_id, a.user_name, '0', a.msg_seq, a.hasMention ? 'Y' : 'N', a.read_count, a.unread_count]);
        var d = 'select ID from IMMsg where MsgID=?';
        this.cExecSqlWithP(d, [a.msg_id], function (h, e) {
            var c = e.rows;
            if (c.length > 0) {
                var f = c.item(0).ID;
                var g = 'INSERT INTO IMFile (FileID,BaseID,ChatID,FileType,FilePath,Width,Height,Extension,MimeType,CreateAt,FileSize,FileName,FileStatus,HasPreview) VALUES (?,?,?,?,?,?,?,?,?,?,?,?,?,?);';
                var d = FileUtil.getExtension(a.message);
                h.executeSql(g, [a.attach_id, f, a.chat_id, a.msg_type, b, a.width, a.height, d, MimeType.getMimeType(d), a.create_at, a.size, a.message, 1, a.has_preview ? 'Y' : 'N'])
            }
        })
    },
    addFileMsgByWS: function (a) {
        var c = 'INSERT INTO IMMsg (MsgID, ChatID, MsgType, Content, CreateAt, SenderID, SenderName, Status, MsgSeq, ReadCount, UnReadCount) VALUES(?,?,?,?,?,?,?,?,?,?,?)';
        var b = Config.httpUrlForGo + 'files/' + a.attach_id;
        this.cExecSqlWithP(c, [a.msg_id, a.chat_id, a.msg_type, b, a.create_at, a.user_id, a.user_name, '0', a.msg_seq, a.read_count, a.unread_count]);
        var d = 'select ID from IMMsg where MsgID=?';
        this.cExecSqlWithP(d, [a.msg_id], function (h, e) {
            var c = e.rows;
            if (c.length > 0) {
                var f = c.item(0).ID;
                var g = 'INSERT INTO IMFile (FileID,BaseID,ChatID,FileType,FilePath,Width,Height,Extension,MimeType,CreateAt,FileSize,FileName,FileStatus) VALUES (?,?,?,?,?,?,?,?,?,?,?,?,?);';
                var d = FileUtil.getExtension(a.message),
                    i = FileUtil.getFileName(a.message);
                h.executeSql(g, [a.attach_id, f, a.chat_id, a.msg_type, b, a.width, a.height, d, MimeType.getMimeType(d), a.create_at, a.size, a.message, 3])
            }
        })
    },
    addNoticeByWS: function (a) {
        this.getDB().transaction(function (b) {
            var c = 'INSERT INTO IMMsg(MsgID, ChatID, MsgType, Content, CreateAt, SenderID, SenderName, Status, MsgSeq) VALUES (?,?,?,?,?,?,?,?,?)';
            b.executeSql(c, [a.msg_id, a.chat_id, a.msg_type, a.message, a.create_at, a.user_id, a.user_name, '0', a.msg_seq])
        })
    },
    addBFileMsgByWS: function (a) {
        this.beforeDoMsg(a.msg_id, function (b, c) {}, function (c) {
            console.log('大文件的内容2' + a.msg_id);
            var b = 'INSERT INTO IMMsg \n                (MsgID, ChatID, MsgType, Content, CreateAt, SenderID, SenderName, MsgSeq, Status, ReadCount, UnReadCount) VALUES \n                (?,?,?,?,?,?,?,?,?,?,?);\n            ';
            c.executeSql(b, [a.msg_id, a.chat_id, a.msg_type, a.message, a.create_at, a.user_id, a.user_name, a.msg_seq, '0', a.read_count, a.unread_count], function (d) {
                var b = 'SELECT * FROM IMMsg WHERE MsgID=?;';
                d.executeSql(b, [a.msg_id], function (k, g) {
                    var f = g.rows;
                    if (f.length > 0) {
                        var i = f.item(0).ID;
                        var j = 'INSERT INTO IMBFile \n                            (BFileID, BaseID, ChatID, UserID, BFileName, BFileSize, BFileExtension, BFileStatus, CreateAt) \n                            VALUES (?,?,?,?,?,?,?,?,?)';
                        var b = a.message.split('|'),
                            e = b[0],
                            h = b[1] ? b[1] : 0;
                        k.executeSql(j, [a.attach_id, i, a.chat_id, a.user_id, e, h, FileUtil.getExtension(e), 8, a.create_at])
                    } else {}
                })
            })
        })
    },
    addChatByWSGrpAdd: function (b) {
        var d = JSON.parse(b.data.user_ids),
            c = d.join(',');
        var a = b.data;
        var e = 'INSERT OR REPLACE INTO IMChat \n            (ChatID, \n            DisplayName,\n            CreatorID, \n            ManagerID, \n            Status, \n            CreateAt, \n            UpdateAt, \n            UserIDs,\n            ChatType,\n            FromERP) VALUES \n            (?,?,?,?,?,?,?,?,?,?);';
        this.cExecSqlWithP(e, [b.broadcast.chat_id, a.chat_name, a.creator_id, a.creator_id, '1', a.create_at, a.create_at, c, a.chat_type, a.from_erp])
    },
    addErpLinkByWS: function (b, a) {
        var c = this;
        var d = 'select ID from IMMsg where MsgID=?';
        this.cExecSqlWithP(d, [b.msg_id], function (e, f) {
            var d = f.rows;
            if (d.length > 0) {
                var g = d.item(0).ID;
                var h = 'SELECT * FROM IMLink WHERE LID=?;';
                e.executeSql(h, [a.lid], function (i, d) {
                    var c = d.rows;
                    if (c.length <= 0) {
                        var h = 'INSERT INTO IMLink (LID, ChatID, baseID, Type, LinkObjType, CorpID, LinkKeyString, LinkTitle, LinkID, LinkType, LinkOpUser, LinkDesc, LinkStr, LinkFromID, LinkStepID, LinkStepDesc, LinkStepStatus, LinkStatus, LinkStgGuid) VALUES (?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)';
                        i.executeSql(h, [a.lid, b.chat_id, g, a.type, a.link_obj_type, a.link_corp_id, a.link_key_string, a.link_title, a.link_id, a.link_type, a.link_op_user, a.link_desc, a.link_str, a.link_from_id, a.link_step_id, a.link_step_desc, a.link_step_status, a.link_status, a.link_stg_guid])
                    }
                })
            } else {
                var i = 'INSERT INTO IMMsg(MsgID, ChatID, MsgType, Content, CreateAt, SenderID, SenderName, Status, MsgSeq, ReadCount, UnReadCount) VALUES (?,?,?,?,?,?,?,?,?,?,?)';
                e.executeSql(i, [b.msg_id, b.chat_id, b.msg_type, b.message, b.create_at, b.user_id, b.user_name, '0', b.msg_seq, b.read_count, b.unread_count]);
                c.addErpLinkByWS(b, a)
            }
        })
    },
    addRctByWsPost: function (a, b, c) {
        var d = 'SELECT * FROM IMRct WHERE ChatID=?;';
        this.cExecSqlWithP(d, [a.chat_id], function (e, f) {
            var g = f.rows,
                d = 0;
            if (a.showMention) {
                d = 1
            }
            if (g.length > 0) {
                var h = 'UPDATE IMRct SET DisplayName=?, UnreadCount=?, LastPostAt=?, LastUserID=?, LastUserName=?, LastMessage=?, LastMsgType=?, UserID=?, CreateAt=?, MentionCount=? WHERE ChatID=?;';
                e.executeSql(h, [b, 1, a.create_at, a.user_id, a.user_name, a.message, a.msg_type, c, a.chat_create_at, d, a.chat_id], function () {}, function () {})
            } else {
                var i = 'INSERT INTO IMRct (ChatID, DisplayName, ChatType, UnreadCount, LastPostAt, LastUserID, LastUserName, LastMessage, LastMsgType, UserID, CreateAt, MentionCount, FromERP) VALUES (?,?,?,?,?,?,?,?,?,?,?,?,?);';
                e.executeSql(i, [a.chat_id, b, a.chat_type, 1, a.create_at, a.user_id, a.user_name, a.message, a.msg_type, c, a.chat_create_at, d, a.from_erp], function () {}, function () {})
            }
        });
        var e = 'SELECT ChatID From IMChat WHERE ChatID=?;';
        this.cExecSqlWithP(e, [a.chat_id], function (g, d) {
            var e = d.rows;
            if (e.length <= 0) {
                LocalDataMgr.insertIntoChatByAPI(a.chat_id, '0')
            } else {
                var f = 'UPDATE IMChat SET DisplayName=?, Status=? WHERE ChatID=?;';
                g.executeSql(f, [b, '0', a.chat_id])
            }
        })
    },
    addPadRctByWsPost: function (a, b) {
        var c = 'INSERT OR REPLACE INTO IMRct (ChatID, DisplayName, ChatType, UnreadCount, LastPostAt, LastUserID, LastUserName, LastMessage, LastMsgType, UserID, CreateAt) VALUES (?,?,?,?,?,?,?,?,?,?,?);';
        this.cExecSqlWithP(c, [a.chat_id, b, a.chat_type, 0, a.update_at, a.user_id, a.user_name, a.message, a.msg_type, a.user_id, a.chat_create_at]);
        var d = 'SELECT ChatID From IMChat WHERE ChatID=?;';
        this.cExecSqlWithP(d, [a.chat_id], function (c, d) {
            var e = d.rows;
            if (e.length <= 0) {
                var f = 'INSERT INTO IMChat (ChatID, ChatType, DisplayName, Status)VALUES (?,?,?,?)';
                c.executeSql(f, [a.chat_id, a.chat_type, b, '0'])
            } else {
                var g = 'UPDATE IMChat SET Status=? WHERE ChatID=?;';
                c.executeSql(g, ['0', a.chat_id])
            }
        })
    },
    updateRctByWsPost: function (a, d) {
        var b = '';
        var c = 'UPDATE IMRct SET ChatType=?, DisplayName=?, UnreadCount=UnreadCount + 1, ' + b + ' LastPostAt = ?, LastUserID = ?, LastUserName = ?, \n            LastMessage = ?, LastMsgType = ? where ChatID = ?;';
        if (a.user_id == User.ownerID) {
            var c = 'UPDATE IMRct SET ChatType=?, DisplayName=?, UnreadCount=UnreadCount, ' + b + ' LastPostAt = ?, LastUserID = ?, LastUserName = ?, \n            LastMessage = ?, LastMsgType = ? where ChatID = ?;'
        }
        LocalDataMgr.cExecSqlWithP(c, [a.chat_type, d, a.create_at, a.user_id, a.user_name, a.message, a.msg_type, a.chat_id], function () {}, function () {})
    },
    initGetOrg: function (a) {
        var b = this;
        b.getDB().transaction(function (d) {
            var c = 'SELECT * FROM IMUsr ORDER BY DefRoleID ASC,UserID ASC;';
            b.handleSql(d, c, function (j, i) {
                var g = i.rows;
                if (g.length > 0) {
                    User.allUsers = [];
                    for (var h = 0; h < g.length; h++) {
                        var f = g.item(h);
                        var e = {};
                        e.user_id = f.UserID;
                        e.user_name = f.UserName;
                        e.org_ids = f.OrgIDs;
                        e.custom_mark = f.CustomMark;
                        e.def_role_name = f.DefRoleName;
                        e.def_role_id = f.DefRoleID;
                        e.email = f.Email;
                        e.mobile = f.Mobile;
                        e.notes = f.Notes;
                        e.phone = f.Phone;
                        e.sex = f.Sex;
                        e.avatar_hash = f.AvatarHash;
                        e.role_ids = f.RoleIDs;
                        e.role_names = f.RoleNames;
                        e.user_posts = f.UserPosts;
                        try {
                            e.roles = JSON.parse(f.Organizations)
                        } catch (k) {
                            e.roles = f.Organizations
                        }
                        User.allUsers.push(e);
                        User.userInfos[f.UserID] = e
                    }
                    c = 'SELECT * FROM IMOrg';
                    b.handleSql(j, c, function (g, f) {
                        var b = f.rows;
                        if (b.length > 0) {
                            User.organization = [];
                            for (var c = 0; c < b.length; c++) {
                                var e = {};
                                e.corp_id = b.item(c).CorpID;
                                e.org_id = b.item(c).OrgID;
                                e.org_name = b.item(c).OrgName;
                                e.parent_id = b.item(c).ParentID;
                                e.remarks = b.item(c).Remarks;
                                User.organization.push(e)
                            }
                            a(!0)
                        } else {
                            a(!1)
                        }
                    })
                } else {
                    a(!1)
                }
            })
        })
    },
    initUpdateOrg: function (b, a, d) {
        var c = this;
        c.getDB().transaction(function (f) {
            var i = 'UPDATE IMAdm SET OrgHash=?;';
            f.executeSql(i, [d]);
            f.executeSql('DELETE FROM IMUsr;');
            f.executeSql('DELETE FROM IMOrg');
            for (var g = 0; g < b.length; g++) {
                var c = b[g];
                var j = 'INSERT OR REPLACE INTO IMUsr (UserID,UserName,CustomMark,DefRoleName,DefRoleID,Email,Mobile,Notes,OrgIDs,Phone,Sex,AvatarHash,RoleIDs,RoleNames,Organizations,UserPosts) VALUES (?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?);';
                var h = c.roles;
                try {
                    h = JSON.stringify(c.roles)
                } catch (l) {}
                f.executeSql(j, [c.user_id, c.user_name, c.custom_mark, c.def_role_name, c.def_role_id, c.email, c.mobile, c.notes, c.org_ids, c.phone, c.sex, c.avatar_hash, c.role_ids, c.role_names, h, c.user_posts], null, function (e, c) {
                    console.log(c.message)
                })
            }
            for (var e = 0; e < a.length; e++) {
                var k = 'INSERT OR REPLACE INTO IMOrg (OrgID, CorpID, OrgName, ParentID, Remarks) VALUES (?,?,?,?,?);';
                f.executeSql(k, [a[e].org_id, a[e].corp_id, a[e].org_name, a[e].parent_id, a[e].remarks], null, function (e, c) {
                    console.log(c.message)
                })
            }
        })
    },
    validOrgV: function (b, a) {
        LocalDataMgr.getDB().transaction(function (c) {
            var d = 'SELECT * FROM IMAdm';
            c.executeSql(d, null, function (h, e) {
                var d = e.rows,
                    f = d.length;
                if (f > 0) {
                    var g = d.item(0).OrgVersion;
                    if (g == b + '') {
                        a(!1)
                    } else {
                        a(!0)
                    }
                }
            }, function () {
                a(!0)
            })
        })
    },
    getOrgHash: function (a) {
        LocalDataMgr.getDB().transaction(function (b) {
            var c = 'SELECT * FROM IMAdm';
            b.executeSql(c, null, function (g, e) {
                var c = e.rows,
                    f = c.length;
                if (f > 0) {
                    var d = c.item(0).OrgHash;
                    if (!d) {
                        a('')
                    } else {
                        a(d)
                    }
                } else {
                    a('')
                }
            }, function () {
                a('')
            })
        })
    },
    updateRctAndChat: function (a) {
        var c = this,
            b = '';
        LocalDataMgr.getDB().transaction(function (d) {
            if (a.chat_type == ChatType.Direct) {
                b = ParseUtil.getDctNameFromMems(a.members)
            } else {
                if (a.chat_type == ChatType.Multi || a.chat_type == 'C') {
                    b = a.header
                }
            }
            if (a.iscrowd == 'Y') {
                a.chat_type = 'C'
            }
            var i = c.getUsersMsg(a.members),
                h = i.ids;
            var j = 'UPDATE IMChat SET ChatType=?, DisplayName=?, CreatorID=?, ManagerID=?, CreateAt=?, UserIDs=?, Status=?, UpdateAt=? WHERE ChatID=?;';
            var g = '0';
            if (a.chat_status == 'X') {
                g = '2'
            }
            d.executeSql(j, [a.chat_type, b, a.creator_id, a.manager_id, a.create_at, h, g, a.update_at, a.chat_id]);
            if (a.last_post_at > 0) {
                var e = 'UPDATE IMRct SET DisplayName=?, ChatType=?, UnreadCount=?, LastPostAt=?, CreateAt=?, UserID=? WHERE ChatID=?;';
                d.executeSql(e, [b, a.chat_type, a.unread_count, a.last_post_at, a.create_at, ParseUtil.getDctIdFromMems(a.members), a.chat_id], function () {
                    LogUtil.writeLog(e, [b, a.chat_type, a.unread_count, a.last_post_at, a.create_at, ParseUtil.getDctIdFromMems(a.members), a.chat_id])
                }, function () {
                    LogUtil.writeLogErr(e, [b, a.chat_type, a.unread_count, a.last_post_at, a.create_at, ParseUtil.getDctIdFromMems(a.members), a.chat_id])
                })
            } else {
                var f = 'UPDATE IMRct SET DisplayName=?, ChatType=?, UnreadCount=?, CreateAt=?, UserID=? WHERE ChatID=?;';
                d.executeSql(f, [b, a.chat_type, a.unread_count, a.create_at, ParseUtil.getDctIdFromMems(a.members), a.chat_id], function () {
                    LogUtil.writeLog(f, [b, a.chat_type, a.unread_count, a.create_at, ParseUtil.getDctIdFromMems(a.members), a.chat_id])
                }, function () {
                    LogUtil.writeLogErr(f, [b, a.chat_type, a.unread_count, a.create_at, ParseUtil.getDctIdFromMems(a.members), a.chat_id])
                })
            }
        })
    },
    getUnCompleteChat: function (a) {
        var b = this;
        b.getDB().transaction(function (b) {
            var c = 'SELECT * FROM IMChat Where Status=?;';
            b.executeSql(c, ['1'], function (d, c) {
                if (a) {
                    a(d, c)
                }
            })
        })
    },
    addMemToGroup: function (a, b, c) {
        LocalDataMgr.getDB().transaction(function (e) {
            var j = 'UPDATE IMChat SET DisplayName=?, CreatorID=?, ManagerID=?, UserIDs=?, UpdateAt=?WHERE ChatID=?;';
            var g = LocalDataMgr.getMemsStr(a.members);
            e.executeSql(j, [a.header, a.creator_id, a.manager_id, g.ids, a.update_at, a.chat_id]);
            var d = c[0],
                f = d.user_name ? d.user_name : User.getUserName(d.user_id);
            var h = 'UPDATE IMRct SET DisplayName=?,LastMessage=?,LastMsgType=?,LastPostAt=?,LastUserID=?,LastUserName=? WHERE ChatID=?;';
            e.executeSql(h, [a.header, b, MsgType.GroupNotice, d.create_at, d.user_id, f, a.chat_id]);
            var i = 'INSERT INTO IMMsg (MsgID, ChatID, MsgType, Content, CreateAt, Status, SenderID, SenderName, MsgSeq) VALUES (?,?,?,?,?,?,?,?,?);';
            e.executeSql(i, [d.msg_id, a.chat_id, MsgType.GroupNotice, b, d.create_at, '0', d.user_id, f, d.msg_seq])
        })
    },
    getMemsStr: function (d) {
        var b = [],
            a = [];
        for (var c = 0; c < d.length; c++) {
            b.push(d[c].user_id);
            a.push(d[c].user_name)
        }
        b = b.join(',');
        a = a.join(',');
        return {
            ids: b,
            names: a
        }
    },
    wsAddMemMsg: function (d, b, e) {
        var c = this;
        var a = JSON.parse(b.message);
        var f = 'INSERT INTO IMMsg (MsgID, ChatID, MsgType, Content, CreateAt, Status, MsgSeq) VALUES (?,?,?,?,?,?,?);';
        this.cExecSqlWithP(f, [a.msg_id, a.chat_id, MsgType.GroupNotice, d, a.create_at, e, a.msg_seq]);
        c.beforeDoChat(a.chat_id, function (h, i) {
            var g = 'UPDATE IMChat SET UserIDs=? WHERE ChatID=?;';
            var c = i.UserIDs,
                f = JSON.parse(b.user_ids).join(',');
            c += ',' + f;
            h.executeSql(g, [c, a.chat_id])
        }, function () {
            c.insertIntoChatByAPI(a.chat_id, '1')
        });
        c.beforeDoRct(a.chat_id, function (f, g) {
            var c = 'UPDATE IMRct SET LastPostAt=?,LastUserID=?,LastUserName=?,LastMessage=?,LastMsgType=?,CreateAt=? WHERE ChatID=?;';
            f.executeSql(c, [a.create_at, b.operator_id, b.operator_name, d, a.msg_type, a.chat_create_at, a.chat_id])
        }, function (a) {})
    },
    removeRct: function (a) {
        LocalDataMgr.getDB().transaction(function (b) {
            b.executeSql('DELETE FROM IMRct WHERE ChatID=?', [a])
        })
    },
    updateChatName: function (b, a, c) {
        var d = ['UPDATE IMRct SET DisplayName=?,', 'LastPostAt=?,', 'LastUserID=?,', 'LastUserName=?,', 'LastMessage=?,', 'LastMsgType=? ', 'WHERE ChatID=?;'].join('');
        LocalDataMgr.cExecSqlWithP(d, [a.message, a.create_at, a.user_id, c, b, MsgType.GroupNotice, a.chat_id]);
        var e = 'UPDATE IMChat SET DisplayName=? WHERE ChatID=?;';
        LocalDataMgr.cExecSqlWithP(e, [a.message, a.chat_id]);
        var f = ['INSERT INTO IMMsg (MsgID,MsgSeq,ChatID,MsgType,Content,CreateAt,SenderID,SenderName,Status) VALUES ', '(?,?,?,?,?,?,?,?,?);'].join('');
        LocalDataMgr.cExecSqlWithP(f, [a.msg_id, a.msg_seq, a.chat_id, MsgType.GroupNotice, b, a.create_at, a.user_id, c, '0'])
    },
    getMaxMsgTime: function (a) {
        var b = 'SELECT Max(CreateAt) CreateAt FROM IMMsg WHERE MsgSeq IS NOT NULL AND MsgSeq<>-1;';
        this.getDB().transaction(function (c) {
            c.executeSql(b, [], function (f, b) {
                var e = b.rows.length;
                if (e > 0) {
                    var d = b.rows.item(0).CreateAt;
                    if (!d) {
                        a(0)
                    } else {
                        a(d)
                    }
                } else {
                    a(0)
                }
            }, function () {
                a(0)
            })
        })
    },
    needUpdateChatAva: function (b, c, a) {
        var d = 'SELECT AvatarHash FROM IMChat WHERE ChatID=?;';
        this.getDB().transaction(function (e) {
            e.executeSql(d, [b], function (i, f) {
                var d = f.rows,
                    g = d.length;
                if (g > 0) {
                    var h = d.item(0).AvatarHash;
                    if (h == c) {
                        a(!1)
                    } else {
                        a(!0)
                    }
                } else {
                    a(!0)
                }
            }, function () {
                a(!0)
            })
        })
    },
    needUpdateCrowdAva: function (b, c, a) {
        var d = 'SELECT AvaHash FROM IMChatC WHERE ChatID=?;';
        this.getDB().transaction(function (e) {
            e.executeSql(d, [b], function (i, f) {
                var d = f.rows,
                    g = d.length;
                if (g > 0) {
                    var h = d.item(0).Hash;
                    if (h == c) {
                        a(!1)
                    } else {
                        a(!0)
                    }
                } else {
                    a(!0)
                }
            }, function () {
                a(!0)
            })
        })
    },
    needUpdateUserAva: function (c, b, a) {
        if (!(b && b !== 'undefined' && b !== 'null')) {
            a(!1);
            return
        }
        var d = 'SELECT AvatarHash FROM IMUsr WHERE UserID=?;';
        this.getDB().transaction(function (e) {
            e.executeSql(d, [c], function (i, f) {
                var d = f.rows,
                    g = d.length;
                if (g > 0) {
                    var h = d.item(0).AvatarHash;
                    if (h == b) {
                        a(!1)
                    } else {
                        a(!0)
                    }
                } else {
                    a(!0)
                }
            }, function () {
                a(!0)
            })
        })
    },
    doUpdateChatAva: function (a, b) {
        var c = 'UPDATE IMChat SET AvatarHash=? WHERE ChatID=?;';
        this.cExecSqlWithP(c, [b, a])
    },
    doUpdateUserAva: function (b, a) {
        if (a && a != 'undefined') {
            var c = 'UPDATE IMUsr SET AvatarHash=? WHERE UserID=?;';
            this.cExecSqlWithP(c, [a, b])
        }
    },
    getChatUpTime: function (b, a) {
        var c = 'SELECT * FROM IMChat WHERE ChatID=?;';
        this.getDB().transaction(function (d) {
            d.executeSql(c, [b], function (e, c) {
                if (a) {
                    a(e, c)
                }
            }, function (e, c) {
                console.error('查询IMChat表出错', c.message)
            })
        })
    },
    getCrowdheader: function (b, a) {
        var c = 'SELECT * FROM IMChatC WHERE ChatID=?;';
        this.getDB().transaction(function (d) {
            d.executeSql(c, [b], function (e, c) {
                if (a) {
                    a(e, c)
                }
            }, function (e, c) {
                console.error('查询IMChat表出错', c.message)
            })
        })
    },
    hasDirectChat: function (d, a, b) {
        var c = 'SELECT * FROM IMRct WHERE UserID=? AND ChatType=?;';
        this.cExecSqlWithP(c, [d, 'D'], function (e, c) {
            if (a) {
                a(e, c)
            }
            if (b) {
                b()
            }
        })
    },
    hasDitChat: function (b, a) {
        var c = 'SELECT * FROM IMChat WHERE ChatType=? AND UserIDs LIKE ?;';
        this.cExecSqlWithP(c, [ChatType.Direct, '%' + b + '%'], function (j, h) {
            var d = h.rows;
            if (d.length > 0) {
                var c, f = !1;
                for (var e = 0; e < d.length; e++) {
                    c = d.item(e);
                    var g = c.UserIDs.split(',');
                    if (g[0] == b || g[1] == b) {
                        f = !0;
                        break
                    }
                }
                if (f) {
                    var i = 'SELECT M.MsgType,M.Content,M.SenderID,M.SenderName,M.CreateAt MsgCreateAt FROM IMMsg M WHERE M.ChatID=? ORDER BY M.CreateAt DESC LIMIT 1;';
                    j.executeSql(i, [c.ChatID], function (g, f) {
                        var e = f.rows;
                        if (e.length > 0) {
                            var d = e.item(0);
                            c.MsgType = d.MsgType;
                            c.Content = d.Content;
                            c.SenderID = d.SenderID;
                            c.SenderName = d.SenderName;
                            c.MsgCreateAt = d.MsgCreateAt
                        }
                        a(!0, c)
                    }, function () {
                        a(!0, c)
                    })
                } else {
                    a(!1)
                }
            } else {
                a(!1)
            }
        }, function (d, c) {
            a(!1)
        })
    },
    updateIMOldChat: function (a) {
        var b = 'update IMChat SET Status=?,CreateAt=?,UpdateAt=? WHERE ChatID=?;';
        this.cExecSqlWithP(b, ['0', a.create_at, a.update_at, a.chat_id]);
        var c = 'UPDATE IMRct SET CreateAt=? WHERE ChatID=?;';
        this.cExecSqlWithP(c, [a.create_at, a.chat_id])
    },
    hasChat: function (b, a) {
        var c = this;
        var d = 'SELECT * FROM IMChat WHERE ChatID=?;';
        c.cExecSqlWithP(d, [b], function (f, e) {
            var d = e.rows;
            if (d.length > 0) {
                var c = d.item(0);
                var g = 'SELECT M.MsgType,M.Content,M.SenderID,M.SenderName,M.CreateAt MsgCreateAt FROM IMMsg M WHERE M.ChatID=? ORDER BY M.CreateAt DESC LIMIT 1;';
                f.executeSql(g, [b], function (i, h) {
                    var g = h.rows;
                    if (g.length > 0) {
                        var d = g.item(0);
                        c.MsgType = d.MsgType;
                        c.Content = d.Content;
                        c.SenderID = d.SenderID;
                        c.SenderName = d.SenderName;
                        c.MsgCreateAt = d.MsgCreateAt
                    }
                    a(!0, c)
                }, function () {
                    a(!0, c)
                })
            } else {
                a(!1)
            }
        }, function () {
            a(!1)
        })
    },
    CrowdSearchID: function (b, a) {
        var c = this;
        var d = 'SELECT * FROM IMChatC WHERE ChatID=?;';
        c.cExecSqlWithP(d, [b], a)
    },
    openChatByListNotHave: function (a, b) {
        var c = 'SELECT * FROM IMRct WHERE ChatID=?;';
        LocalDataMgr.cExecSqlWithP(c, [a.ChatID], function (d, e) {
            var f = e.rows;
            if (f.length > 0) {
                var g = 'UPDATE IMRct SET LastPostAt=?,UnreadCount=0 WHERE ChatID=?;';
                d.executeSql(g, [b, a.ChatID])
            } else {
                var c = a.CreatorID;
                if (a.ChatType == ChatType.Direct) {
                    c = ParseUtil.getUserIDByDitChat(a.UserIDs)
                }
                var h = 'INSERT INTO IMRct (ChatID, ChatType, DisplayName, LastPostAt,UserID,CreateAt,IsMute) VALUES (?,?,?,?,?,?,?)';
                d.executeSql(h, [a.ChatID, a.ChatType, a.DisplayName, b, c, a.CreateAt, a.IsMute])
            }
        })
    },
    openMsgreplyByListNotHave: function (a, b) {
        var c = 'SELECT * FROM IMRct WHERE ChatID=?;';
        LocalDataMgr.cExecSqlWithP(c, [a.ChatID], function (c, d) {
            var e = d.rows;
            if (e.length > 0) {
                var f = 'UPDATE IMRct SET LastPostAt=?,UnreadCount=0 WHERE ChatID=?;';
                c.executeSql(f, [b, a.ChatID])
            } else {
                var g = 'INSERT INTO IMRct (ChatID, ChatType, DisplayName, LastPostAt) VALUES (?,?,?,?)';
                c.executeSql(g, [a.ChatID, a.ChatType, a.DisplayName, b])
            }
        })
    },
    openCrowdByListNotHave: function (a, b) {
        var c = 'SELECT * FROM IMRct WHERE ChatID=?;';
        LocalDataMgr.cExecSqlWithP(c, [a.chat_id], function (c, d) {
            var e = d.rows;
            if (e.length > 0) {
                var f = 'UPDATE IMRct SET ChatType=?,DisplayName=?,LastPostAt=?,UnreadCount=0 WHERE ChatID=?;';
                c.executeSql(f, [a.chat_type, a.header, b, a.chat_id])
            } else {
                var g = 'INSERT INTO IMRct (ChatID, ChatType, CreateAt, DisplayName, LastPostAt) VALUES (?,?,?,?,?)';
                c.executeSql(g, [a.chat_id, a.chat_type, a.chat_create_at, a.header, b])
            }
        })
    },
    updateCrowdtoGroup: function (a, b) {
        if (a.iscrowd == 'Y') {
            a.chat_type = 'C'
        }
        var c = 'UPDATE IMChat SET DisplayName=?,Status=?,UpdateAt=?,ChatType=?,CreateAt=? WHERE ChatID=?;';
        LocalDataMgr.cExecSqlWithP(c, [a.header, '0', b, a.chat_type, a.chat_create_at, a.chat_id]);
        var d = 'UPDATE IMRct SET ChatType=?,DisplayName=?,CreateAt=? WHERE ChatID=?;';
        LocalDataMgr.cExecSqlWithP(d, [a.chat_type, a.header, a.chat_create_at, a.chat_id])
    },
    openChatByChatNotHave: function (a, e, b) {
        var h = 'SELECT * FROM IMRct WHERE ChatID=?;';
        LocalDataMgr.cExecSqlWithP(h, [a.chat_id], function (d, f) {
            var g = f.rows;
            if (g.length > 0) {
                var h = 'UPDATE IMRct SET LastPostAt=?,UnreadCount=0 WHERE ChatID=?;';
                d.executeSql(h, [e, a.chat_id])
            } else {
                var c = a.creator_id;
                if (a.chat_type == ChatType.Direct) {
                    c = a.members[0].user_id == User.ownerID ? a.members[1].user_id : a.members[0].user_id
                }
                var i = 'INSERT INTO IMRct (ChatID, ChatType, DisplayName, LastPostAt,UserID,CreateAt,IsMute,FromERP) VALUES (?,?,?,?,?,?,?,?)';
                d.executeSql(i, [a.chat_id, a.chat_type, b, e, c, a.create_at, a.is_mute, a.from_erp])
            }
        });
        var c = a.creator_id,
            d = a.manager_id;
        if (a.chat_type == ChatType.Direct) {
            c = d = a.members[0].user_id == User.ownerID ? a.members[1].user_id : a.members[0].user_id
        }
        var g = LocalDataMgr.getUsersMsg(a.members),
            f = g.ids;
        var i = 'INSERT INTO IMChat (ChatID,DisplayName,CreatorID,ManagerID,Status,CreateAt,UpdateAt,Remarks,UserIDs,AvatarHash,ChatType,FromERP) VALUES (?,?,?,?,?,?,?,?,?,?,?,?);';
        LocalDataMgr.cExecSqlWithP(i, [a.chat_id, b, c, d, '0', a.create_at, a.update_at, a.purpose, f, a.avatar_hash, a.chat_type, a.from_erp])
    },
    openMsgreplyByChatNotHave: function (a, b) {
        var c = 'SELECT * FROM IMRct WHERE ChatID=?;';
        LocalDataMgr.cExecSqlWithP(c, [a], function (c, d) {
            var e = d.rows;
            if (e.length > 0) {
                var f = 'UPDATE IMRct SET LastPostAt=?,UnreadCount=0 WHERE ChatID=?;';
                c.executeSql(f, [b, a])
            } else {
                var g = 'INSERT INTO IMRct (ChatID, ChatType, DisplayName, LastPostAt) VALUES (?,?,?,?)';
                c.executeSql(g, [a, 'P', '消息回复', b])
            }
        });
        var d = 'INSERT INTO IMChat (ChatID,DisplayName,Status,UpdateAt,ChatType) VALUES (?,?,?,?,?);';
        LocalDataMgr.cExecSqlWithP(d, [a, '消息回复', '0', b, 'P'])
    },
    openCrowdyByChatNotHave: function (a, b) {
        var c = 'SELECT * FROM IMRct WHERE ChatID=?;';
        LocalDataMgr.cExecSqlWithP(c, [a.chat_id], function (c, d) {
            var e = d.rows;
            if (e.length > 0) {
                var f = 'UPDATE IMRct SET ChatType=?,DisplayName=?,LastPostAt=?,UnreadCount=0 WHERE ChatID=?;';
                c.executeSql(f, [a.chat_type, a.header, b, a.chat_id])
            } else {
                var g = 'INSERT INTO IMRct (ChatID, ChatType, CreateAt, DisplayName, LastPostAt) VALUES (?,?,?,?,?)';
                c.executeSql(g, [a.chat_id, a.chat_type, a.chat_create_at, a.header, b])
            }
        });
        var d = 'INSERT INTO IMChat (ChatID,DisplayName,Status,UpdateAt,ChatType, CreateAt) VALUES (?,?,?,?,?,?);';
        LocalDataMgr.cExecSqlWithP(d, [a.chat_id, a.header, '0', b, a.chat_type, a.chat_create_at])
    },
    getHistoryContext: function (b, a, c) {
        var d = 'SELECT M.*,F.*,L.*,B.* FROM \n            (SELECT * FROM IMMsg WHERE ChatID=? AND CreateAt<=? ORDER BY CreateAt DESC,MsgSeq DESC limit 0,10) M \n            LEFT JOIN IMFile F ON M.ID=F.BaseID \n            LEFT JOIN IMLink L ON M.ID=L.BaseID\n            LEFT JOIN IMBFile B ON M.ID=B.BaseID;';
        this.cExecSqlWithP(d, [b, a], function (g, e) {
            var h = e.rows;
            var d = ParseUtil.parseLocalMsg(h);
            var f = d[d.length - 1];
            var i = 'SELECT M.*,F.*,L.*,B.* \n            FROM (SELECT * FROM IMMsg WHERE ChatID=? AND CreateAt>? ORDER BY CreateAt ASC,MsgSeq ASC limit 0,10) M \n            LEFT JOIN IMFile F ON M.ID=F.BaseID \n            LEFT JOIN IMLink L ON M.ID=L.BaseID\n            LEFT JOIN IMBFile B ON M.ID=B.BaseID;';
            g.executeSql(i, [b, a], function (l, j) {
                var k = j.rows;
                var i = ParseUtil.parseLocalOrderedMsg(k);
                var h = d;
                if (i.length > 0) {
                    h = d.concat(i)
                }
                c(h, f)
            })
        })
    },
    doChatAfterRemoveUser: function (e, g, d) {
        var a = d.split(',');
        for (var b = 0; b < a.length; b++) {
            if (g == a[b]) {
                a.splice(b, 1)
            }
        }
        var c = a.join(',');
        var f = 'UPDATE IMChat SET UserIDs=? WHERE ChatID=?;';
        this.cExecSqlWithP(f, [c, e])
    },
    doMsgAfterRemoveUser: function (c, a, b) {
        var d = 'INSERT INTO IMMsg (MsgID, ChatID, MsgType, Content, CreateAt, MsgSeq, Status) VALUES (?,?,?,?,?,?,?);';
        this.cExecSqlWithP(d, [a.msg_id, c, 'G', b, a.create_at, a.msg_seq, '0']);
        var e = 'UPDATE IMRct SET LastPostAt=?,LastMessage=?,LastMsgType=? WHERE ChatID=?;';
        this.cExecSqlWithP(e, [a.create_at, b, 'G', c])
    },
    doChatAfterRemoveUserByWS: function (a, c) {
        var b = this;
        var d = 'SELECT UserIDs FROM IMChat WHERE ChatID=?';
        b.cExecSqlWithP(d, [a], function (l, g) {
            var f = g.rows;
            if (f.length > 0) {
                var k = f.item(0),
                    i = k.UserIDs;
                var d = i.split(',');
                for (var e = 0; e < d.length; e++) {
                    if (c == d[e]) {
                        d.splice(e, 1)
                    }
                }
                var h = d.join(',');
                var j = 'UPDATE IMChat SET UserIDs=? WHERE ChatID=?;';
                b.cExecSqlWithP(j, [h, a])
            }
        })
    },
    doMsgAfterRemoveUserByWS: function (c, a, b) {
        var d = 'INSERT INTO IMMsg (MsgID, ChatID, MsgType, Content, CreateAt, MsgSeq, Status) VALUES (?,?,?,?,?,?,?);';
        this.cExecSqlWithP(d, [a.msg_id, c, MsgType.GroupNotice, b, a.create_at, a.msg_seq, '0']);
        var e = 'UPDATE IMRct SET LastPostAt=?,LastMessage=?,LastMsgType=? WHERE ChatID=?;';
        this.cExecSqlWithP(e, [a.create_at, b, MsgType.GroupNotice, c])
    },
    doMsgAtrRmUserByWSWOM: function (c, a, b) {
        var d = 'INSERT INTO IMMsg (MsgID, ChatID, MsgType, Content, CreateAt, MsgSeq, Status) VALUES (?,?,?,?,?,?,?);';
        this.cExecSqlWithP(d, [a.msg_id, c, MsgType.NotShow, b, a.create_at, a.msg_seq, '0'])
    },
    doChatAfterChgMgr: function (a, c) {
        var b = 'UPDATE IMChat SET ManagerID=? WHERE ChatID=?;';
        this.cExecSqlWithP(b, [c, a])
    },
    doMsgAfterChgMgr: function (c, a, b) {
        var d = 'INSERT INTO IMMsg (MsgID, ChatID, MsgType, Content, CreateAt, MsgSeq, Status) VALUES (?,?,?,?,?,?,?);';
        this.cExecSqlWithP(d, [a.msg_id, c, MsgType.GroupNotice, b, a.create_at, a.msg_seq, '0']);
        var e = 'UPDATE IMRct SET LastPostAt=?,LastMessage=?,LastMsgType=? WHERE ChatID=?;';
        this.cExecSqlWithP(e, [a.create_at, b, MsgType.GroupNotice, c])
    },
    doChatAfterChgMgrByWS: function (a, c) {
        var b = this;
        var d = 'SELECT ManagerID FROM IMChat WHERE ChatID=?';
        b.cExecSqlWithP(d, [a], function (g, d) {
            var e = d.rows;
            if (e.length > 0) {
                var f = 'UPDATE IMChat SET ManagerID=? WHERE ChatID=?;';
                b.cExecSqlWithP(f, [c, a])
            }
        })
    },
    doMsgAfterChgMgrByWS: function (c, a, b) {
        var d = 'INSERT INTO IMMsg (MsgID, ChatID, MsgType, Content, CreateAt, MsgSeq, Status) VALUES (?,?,?,?,?,?,?);';
        this.cExecSqlWithP(d, [a.msg_id, c, MsgType.GroupNotice, b, a.create_at, a.msg_seq, '0']);
        var e = 'UPDATE IMRct SET LastPostAt=?,LastMessage=?,LastMsgType=? WHERE ChatID=?;';
        this.cExecSqlWithP(e, [a.create_at, b, MsgType.GroupNotice, c])
    },
    doMsgAfterChgMgrByWSWOM: function (c, a, b) {
        var d = 'INSERT INTO IMMsg (MsgID, ChatID, MsgType, Content, CreateAt, MsgSeq, Status) VALUES (?,?,?,?,?,?,?);';
        this.cExecSqlWithP(d, [a.msg_id, c, 'R', b, a.create_at, a.msg_seq, '0'])
    },
    toTop: function (a) {
        var b = 'UPDATE IMRct SET IsTop=? WHERE ChatID=?;';
        LocalDataMgr.cExecSqlWithP(b, ['Y', a])
    },
    cancelToTop: function (a) {
        var b = 'UPDATE IMRct SET IsTop=? WHERE ChatID=?;';
        LocalDataMgr.cExecSqlWithP(b, ['N', a])
    },
    searchUsers: function (a, b) {
        this.getDB().transaction(function (c) {
            var d = 'SELECT UserID,UserName,AvatarHash,Organizations FROM IMUsr WHERE UserName like ? or UserID like ? or Mobile like ?;';
            c.executeSql(d, [a + '%', a + '%', a + '%'], function (e, d) {
                if (b) {
                    b(d)
                }
            }, function (e, d) {
                console.log('本地查询出错：', d.message)
            })
        })
    },
    setRctTop: function (b, a) {
        LocalDataMgr.getDB().transaction(function (c) {
            c.executeSql('Update IMRct Set IsTop = ? WHERE ChatID=?;', [a == 'Y' ? 'Y' : 'N', b])
        })
    },
    updateUserInfo: function (a) {
        if (ConfigMgr.isAio8()) {
            var b = [];
            try {
                b = JSON.stringify(a.roles)
            } catch (d) {}
            a.organizations = b
        }
        var c = 'UPDATE IMUsr SET \n            UserID=?,UserName=?,Email=?,Sex=?,Phone=?,Mobile=?,\n            Notes=?,CustomMark=?,OrgIDs=?,DefRoleName=?,DefRoleID=?,\n            RoleIDs=?,RoleNames=?,Organizations=?,UserPosts=? WHERE UserID=?;';
        LocalDataMgr.cExecSqlWithP(c, [a.user_id, a.user_name, a.email, a.sex, a.phone, a.mobile, a.notes, a.custom_mark, a.org_ids, a.def_role_name, a.def_role_id, a.role_ids, a.role_names, a.organizations, a.user_posts, a.user_id])
    },
    updateMyInfoByKey: function (b, a) {
        var c = 'UPDATE IMUsr SET ' + b + '=? WHERE UserID=?;';
        LocalDataMgr.cExecSqlWithP(c, [a, User.ownerID])
    },
    searchUserInfo: function (a, b) {
        var c = 'SELECT * FROM IMUsr WHERE UserID LIKE ? OR UserName LIKE ? OR Mobile LIKE ? ORDER BY DefRoleID ASC,UserID ASC;';
        this.cExecSqlWithP(c, ['%' + a + '%', '%' + a + '%', '%' + a + '%'], b)
    },
    getOldMsgWithKey: function (e, d, c, b, a) {
        var f = 'SELECT * FROM IMMsg WHERE ChatID=? AND CreateAt<? AND MsgType=? AND Content LIKE ? ORDER BY CreateAt DESC LIMIT 20;';
        this.cExecSqlWithP(f, [e, d, MsgType.TextMsg, '%' + c + '%'], b, a)
    },
    updateChat: function (a) {
        var e = LocalDataMgr.getUsersMsg(a.members),
            c = e.ids;
        var b = '';
        if (a.chat_type == ChatType.Direct) {
            b = ParseUtil.getDctNameFromMems(a.members)
        } else {
            if (a.chat_type == ChatType.Multi) {
                b = a.header
            }
        }
        var d = SocketEventUtil.getMuteByRemote(a.members);
        this.beforeDoChat(a.chat_id, function (d, f) {
            var e = 'UPDATE IMChat SET DisplayName=?,CreatorID=?,ManagerID=?,Status=?,CreateAt=?,UpdateAt=?,Remarks=?,UserIDs=?,ChatType=? WHERE ChatID=?;';
            d.executeSql(e, [b, a.creator_id, a.manager_id, '0', a.create_at, a.update_at, a.purpose, c, a.chat_type, a.chat_id])
        }, function (e) {
            var f = 'INSERT INTO IMChat \n            (ChatID, ChatType, DisplayName, CreatorID, ManagerID, Status, CreateAt, UpdateAt, Remarks, UserIDs, IsMute) VALUES \n            (?,?,?,?,?,?,?,?,?,?,?);';
            e.executeSql(f, [a.chat_id, a.chat_type, b, a.creator_id, a.manager_id, '0', a.create_at, a.update_at, a.purpose, c, d])
        })
    },
    doRevoke: function (a, e, d) {
        var b = this;
        var c = 'SELECT * FROM IMMsg WHERE MsgID=?;';
        this.cExecSqlWithP(c, [a.msg_id], function (i, g) {
            var f = g.rows;
            if (f.length > 0) {
                var c = f.item(0);
                if (c.MsgType == MsgType.ImgMsg) {
                    b.deleteImgByBaseID(c.ID)
                } else {
                    if (c.MsgType == MsgType.FileMsg) {
                        b.deleteFileByBaseID(c.ID)
                    } else {
                        if (c.MsgType == MsgType.LinkErp) {
                            b.deleteLinkByBaseID(c.ID)
                        }
                    }
                }
            }
            var h = 'UPDATE IMMsg SET SenderID=?,SenderName=?,Content=?,MsgType=? WHERE MsgID=?;';
            i.executeSql(h, [a.user_id, User.userInfos[a.user_id].user_name, a.message, a.msg_type, a.msg_id])
        })
    },
    revokeDeleteDetail: function (b, a) {
        var c = this;
        if (a == MsgType.ImgMsg) {
            c.deleteImgByBaseID(b)
        } else {
            if (a == MsgType.FileMsg) {
                c.deleteFileByBaseID(b)
            } else {
                if (a == MsgType.LinkErp) {
                    c.deleteLinkByBaseID(b)
                }
            }
        }
    },
    deleteImgByBaseID: function (a) {
        var b = 'DELETE FROM IMFile WHERE BaseID=?;';
        this.cExecSqlWithP(b, [a])
    },
    deleteFileByBaseID: function (a) {
        var b = 'DELETE FROM IMFile WHERE BaseID=?;';
        this.cExecSqlWithP(b, [a])
    },
    deleteLinkByBaseID: function (a) {
        var b = 'DELETE FROM IMLink WHERE BaseID=?;';
        this.cExecSqlWithP(b, [a])
    },
    revokeUpdateRct: function (f, d, a, e, c) {
        var b = this;
        var g = 'SELECT MAX(MsgSeq),* FROM IMMsg WHERE ChatID=?;';
        this.cExecSqlWithP(g, [f], function (m, h) {
            var g = h.rows;
            if (g.length > 0) {
                var l = g.item(0);
                var i = GroupNotice.getRevokeNotice(a, e);
                if (l.MsgID == d) {
                    var k = 'UPDATE IMRct SET LastMsgType=?,LastMessage=?,LastUserID=?,LastUserName=? WHERE ChatID=?;';
                    b.cExecSqlWithP(k, [MsgType.Revoke, i, a, User.getUserName(a), f]);
                    var j = 'UPDATE IMMsg SET SenderID=?,SenderName=?,Content=?,MsgType=? WHERE MsgID=?;';
                    b.cExecSqlWithP(j, [a, User.userInfos[a].user_name, e, MsgType.Revoke, d]);
                    if (c) {
                        c()
                    }
                }
            }
        })
    },
    doWebSocketRevoke: function (g, b, c, f, e) {
        var d = this;
        var a = this;
        var h = 'SELECT * FROM IMMsg WHERE MsgID=?;';
        this.cExecSqlWithP(h, [b], function (l, j) {
            var i = j.rows;
            if (i.length > 0) {
                var h = i.item(0);
                if (h.MsgType == MsgType.ImgMsg) {
                    a.deleteImgByBaseID(h.ID)
                } else {
                    if (h.MsgType == MsgType.FileMsg) {
                        a.deleteFileByBaseID(h.ID)
                    } else {
                        if (h.MsgType == MsgType.LinkErp) {
                            a.deleteLinkByBaseID(h.ID)
                        }
                    }
                }
            }
            var k = 'UPDATE IMMsg SET SenderID=?,SenderName=?,Content=?,MsgType=? WHERE MsgID=?;';
            d.cExecSqlWithP(k, [c, User.userInfos[c].user_name, f, MsgType.Revoke, b])
        });
        a.doRevokeRctAndMsgA(b, g, e)
    },
    doRevokeRctAndMsgA: function (b, c, a) {
        var d = 'SELECT MsgID FROM IMMsgA WHERE MsgID=? AND Status=?;';
        this.cExecSqlWithP(d, [b, 0], function (d, e) {
            var f = e.rows;
            if (f.length > 0) {
                var g = 'UPDATE IMMsgA SET Status=? WHERE MsgID=?;';
                d.executeSql(g, [1, b]);
                var h = 'UPDATE IMRct SET MentionCount=MentionCount-1 WHERE ChatID=?;';
                d.executeSql(h, [c]);
                if (Ext.isFunction(a)) {
                    a(c)
                }
            }
        })
    },
    doTransmit: function (e, c) {
        var b = this;
        for (var d = 0; d < e.length; d++) {
            var a = e[d];
            var f = 'UPDATE IMRct SET LastPostAt=?,LastUserID=?,LastUserName=?,LastMessage=?,LastMsgType=? WHERE ChatID=?;';
            this.cExecSqlWithP(f, [a.create_at, User.ownerID, User.crtUser.user_name, a.message, a.msg_type, a.chat_id]);
            switch (a.msg_type) {
                case MsgType.TextMsg:
                    b.transmitTextMsg(a);
                    break;
                case MsgType.ImgMsg:
                    b.transmitImgMsg(a, c);
                    break;
                case MsgType.FileMsg:
                    b.transmitFileMsg(a, c);
                    break;
                case MsgType.LinkErp:
                    b.transmitLinkMsg(a, c);
                    break;
                case MsgType.BigFileMsg:
                    b.transmitBFileMsg(a, c);
                    break;
                default:
                    break;
            }
        }
    },
    transmitTextMsg: function (a) {
        var c = 'INSERT INTO IMMsg (MsgID,ChatID,MsgType,Content,CreateAt,SenderID,SenderName,Status,MsgSeq,ReadCount, UnReadCount) VALUES (?,?,?,?,?,?,?,?,?,?,?)';
        this.cExecSqlWithP(c, [a.msg_id, a.chat_id, a.msg_type, a.message, a.create_at, a.user_id, User.crtUser.user_name, '0', a.msg_seq, a.read_count, a.unread_count]);
        if (Config.isPC) {
            if (User.crtChannelId == a.chat_id) {
                var b = Ext.getStore(a.chat_id);
                if (b) {
                    b.add({
                        msg_id: a.msg_id,
                        msg_type: a.msg_type,
                        senderID: a.user_id,
                        senderName: User.getUserName(a.user_id),
                        sendText: a.message,
                        ROL: a.user_id == User.ownerID ? 'right' : '',
                        updateTime: a.create_at,
                        msgSeq: a.msg_seq,
                        read_count: a.read_count,
                        unread_count: a.unread_count < 0 ? 0 : a.unread_count
                    });
                    AddDataUtil.onScrolMsgView()
                }
            }
        }
    },
    transmitImgMsg: function (a, b) {
        var c = this;
        var d = 'INSERT INTO IMMsg (MsgID,ChatID,MsgType,Content,CreateAt,SenderID,SenderName,Status,MsgSeq,ReadCount, UnReadCount) VALUES (?,?,?,?,?,?,?,?,?,?,?)';
        this.cExecSqlWithP(d, [a.msg_id, a.chat_id, a.msg_type, a.message, a.create_at, a.user_id, User.crtUser.user_name, '0', a.msg_seq, a.read_count, a.unread_count]);
        var e = 'SELECT ID FROM IMMsg WHERE MsgID=?;';
        this.cExecSqlWithP(e, [a.msg_id], function (g, e) {
            var d = e.rows;
            if (d.length > 0) {
                var f = d.item(0).ID;
                c.doTransmitImg(f, b, a)
            }
        })
    },
    doTransmitImg: function (c, b, a) {
        var d = 'SELECT * FROM IMMsg WHERE MsgID=?;';
        this.cExecSqlWithP(d, [b], function (f, e) {
            var d = e.rows;
            if (d.length > 0) {
                var g = d.item(0).ID;
                var h = 'SELECT * FROM IMFile WHERE BaseID=?;';
                f.executeSql(h, [g], function (j, i) {
                    var h = i.rows;
                    if (h.length > 0) {
                        var d = h.item(0);
                        var k = 'INSERT INTO IMFile (FileID,BaseID,ChatID,FileType,FilePath,FileName,Width,Height,Extension,CreateAt,FileSize,FileStatus,HasPreview,MimeType) VALUES (?,?,?,?,?,?,?,?,?,?,?,?,?,?);';
                        j.executeSql(k, [d.FileID, c, a.chat_id, d.FileType, d.FilePath, d.FileName, d.Width, d.Height, d.Extension, a.create_at, d.FileSize, 0, d.HasPreview, d.MimeType]);
                        if (Config.isPC) {
                            if (User.crtChannelId == a.chat_id) {
                                var g = Ext.getStore(a.chat_id);
                                if (g) {
                                    g.add({
                                        chat_id: a.chat_id,
                                        msg_id: a.msg_id,
                                        msg_type: a.msg_type,
                                        senderID: a.user_id,
                                        senderName: User.getUserName(a.user_id),
                                        sendText: ImgMgr.parsePic(d.FileID, !0, d.Height, d.Width, d.Status, a.chat_id, d.CreateAt, d.Extension, d.FileName),
                                        ROL: User.ownerID == a.user_id ? 'right' : 'left',
                                        updateTime: a.create_at,
                                        fileName: d.FileName,
                                        msgSeq: a.msg_seq,
                                        width: d.Width,
                                        height: d.Height,
                                        fileID: d.FileID,
                                        read_count: a.read_count,
                                        unread_count: a.unread_count < 0 ? 0 : a.unread_count
                                    });
                                    AddDataUtil.onScrolMsgView()
                                }
                            }
                        }
                    }
                })
            }
        })
    },
    transmitFileMsg: function (a, b) {
        var c = this;
        var d = 'INSERT INTO IMMsg (MsgID,ChatID,MsgType,Content,CreateAt,SenderID,SenderName,Status,MsgSeq,ReadCount, UnReadCount) VALUES (?,?,?,?,?,?,?,?,?,?,?)';
        this.cExecSqlWithP(d, [a.msg_id, a.chat_id, a.msg_type, a.message, a.create_at, a.user_id, User.crtUser.user_name, '0', a.msg_seq, a.read_count, a.unread_count]);
        var e = 'SELECT ID FROM IMMsg WHERE MsgID=?;';
        this.cExecSqlWithP(e, [a.msg_id], function (g, e) {
            var d = e.rows;
            if (d.length > 0) {
                var f = d.item(0).ID;
                c.doTransmitFile(f, b, a)
            }
        })
    },
    doTransmitFile: function (c, b, a) {
        var d = 'SELECT * FROM IMMsg WHERE MsgID=?;';
        this.cExecSqlWithP(d, [b], function (f, e) {
            var d = e.rows;
            if (d.length > 0) {
                var g = d.item(0).ID;
                var h = 'SELECT * FROM IMFile WHERE BaseID=?;';
                f.executeSql(h, [g], function (j, i) {
                    var h = i.rows;
                    if (h.length > 0) {
                        var d = h.item(0);
                        var k = 'INSERT INTO IMFile (FileID,BaseID,ChatID,FileType,FilePath,FileName,Width,Height,Extension,CreateAt,FileSize,FileStatus) VALUES (?,?,?,?,?,?,?,?,?,?,?,?);';
                        j.executeSql(k, [d.FileID, c, a.chat_id, d.FileType, d.FilePath, d.FileName, d.Width, d.Height, d.Extension, a.create_at, d.FileSize, 0]);
                        if (Config.isPC) {
                            if (User.crtChannelId == a.chat_id) {
                                var g = Ext.getStore(a.chat_id);
                                if (g) {
                                    g.add({
                                        chat_id: a.chat_id,
                                        msg_id: a.msg_id,
                                        msg_type: a.msg_type,
                                        senderID: a.user_id,
                                        senderName: User.getUserName(a.user_id),
                                        ROL: a.user_id == User.ownerID ? 'right' : '',
                                        updateTime: a.create_at,
                                        msgSeq: a.msg_seq,
                                        fileStatus: 0,
                                        fileSize: d.FileSize,
                                        fileName: d.FileName,
                                        localPath: d.FilePath,
                                        read_count: a.read_count,
                                        unread_count: a.unread_count < 0 ? 0 : a.unread_count
                                    });
                                    AddDataUtil.onScrolMsgView()
                                }
                            }
                        }
                    }
                })
            }
        })
    },
    transmitLinkMsg: function (a, b) {
        var c = this;
        var d = 'INSERT INTO IMMsg (MsgID,ChatID,MsgType,Content,CreateAt,SenderID,SenderName,Status,MsgSeq,ReadCount, UnReadCount) VALUES (?,?,?,?,?,?,?,?,?,?,?)';
        this.cExecSqlWithP(d, [a.msg_id, a.chat_id, a.msg_type, a.message, a.create_at, a.user_id, User.crtUser.user_name, '0', a.msg_seq, a.read_count, a.unread_count]);
        var e = 'SELECT ID FROM IMMsg WHERE MsgID=?;';
        this.cExecSqlWithP(e, [a.msg_id], function (g, e) {
            var d = e.rows;
            if (d.length > 0) {
                var f = d.item(0).ID;
                c.doTransmitLink(f, b, a)
            }
        })
    },
    doTransmitLink: function (c, b, a) {
        var d = 'SELECT * FROM IMMsg WHERE MsgID=?;';
        this.cExecSqlWithP(d, [b], function (f, e) {
            var d = e.rows;
            if (d.length > 0) {
                var g = d.item(0).ID;
                var h = 'SELECT * FROM IMLink WHERE BaseID=?;';
                f.executeSql(h, [g], function (j, i) {
                    var h = i.rows;
                    if (h.length > 0) {
                        var d = h.item(0);
                        var k = 'INSERT INTO IMLink (LID, ChatID, baseID, Type, LinkObjType, LinkKeyString, LinkTitle, LinkID, LinkType, LinkOpUser, LinkDesc, LinkStr, LinkFromID, LinkStepID, LinkStepDesc, LinkStepStatus, LinkStatus, LinkStgGuid) VALUES (?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)';
                        j.executeSql(k, [d.LID, a.chat_id, c, d.Type, d.LinkObjType, d.LinkKeyString, d.LinkTitle, d.LinkID, d.LinkType, d.LinkOpUser, d.LinkDesc, d.LinkStr, d.LinkFromID, d.LinkStepID, d.LinkStepDesc, d.LinkStepStatus, d.LinkStatus, d.LinkStgGuid]);
                        if (Config.isPC) {
                            if (User.crtChannelId == a.chat_id) {
                                var g = Ext.getStore(a.chat_id);
                                if (g) {
                                    g.add({
                                        chat_id: a.chat_id,
                                        msg_id: a.msg_id,
                                        msg_type: a.msg_type,
                                        content: a.message,
                                        senderID: a.user_id,
                                        senderName: User.getUserName(a.user_id),
                                        ROL: a.user_id == User.ownerID ? 'right' : '',
                                        updateTime: a.create_at,
                                        msgSeq: a.msg_seq,
                                        linkName: d.LinkTitle,
                                        linkLinkType: d.LinkType,
                                        linkKeyString: d.LinkKeyString,
                                        linkObjType: d.LinkObjType,
                                        link_stg_guid: d.LinkStgGuid,
                                        read_count: a.read_count,
                                        unread_count: a.unread_count < 0 ? 0 : a.unread_count
                                    });
                                    AddDataUtil.onScrolMsgView()
                                }
                            }
                        }
                    }
                })
            }
        })
    },
    transmitBFileMsg: function (a, b) {
        var c = this;
        var d = 'INSERT INTO IMMsg (MsgID,ChatID,MsgType,Content,CreateAt,SenderID,SenderName,Status,MsgSeq,ReadCount, UnReadCount) VALUES (?,?,?,?,?,?,?,?,?,?,?)';
        this.cExecSqlWithP(d, [a.msg_id, a.chat_id, a.msg_type, a.message, a.create_at, a.user_id, User.crtUser.user_name, '0', a.msg_seq, a.read_count, a.unread_count]);
        var e = 'SELECT ID FROM IMMsg WHERE MsgID=?;';
        this.cExecSqlWithP(e, [a.msg_id], function (g, e) {
            var d = e.rows;
            if (d.length > 0) {
                var f = d.item(0).ID;
                c.doTransmitBFile(f, b, a, g)
            }
        })
    },
    doTransmitBFile: function (c, b, a, e) {
        var d = 'SELECT * FROM IMMsg WHERE MsgID=?;';
        e.executeSql(d, [b], function (g, f) {
            var d = f.rows;
            if (d.length > 0) {
                var h = d.item(0).ID;
                var i = 'SELECT * FROM IMBFile WHERE BaseID=?;';
                g.executeSql(i, [h], function (k, j) {
                    var i = j.rows;
                    if (i.length > 0) {
                        var d = i.item(0);
                        var l = 'INSERT INTO IMBFile (BFileID,BaseID,ChatID,UserID,BFilePath,BFileName,BFileSize,BFileExtension,BFileStatus,CreateAt) VALUES (?,?,?,?,?,?,?,?,?,?);';
                        k.executeSql(l, [d.BFileID, c, a.chat_id, a.msg_type, d.BFilePath, d.BFileName, d.BFileSize, d.BFileExtension, 0, a.create_at]);
                        if (Config.isDesktop) {
                            if (User.crtChannelId == a.chat_id) {
                                var h = Ext.getStore(a.chat_id);
                                if (h) {
                                    h.add({
                                        chat_id: a.chat_id,
                                        msg_id: a.msg_id,
                                        msg_type: a.msg_type,
                                        senderID: a.user_id,
                                        senderName: User.getUserName(a.user_id),
                                        file_id: d.BFileID,
                                        ROL: a.user_id == User.ownerID ? 'right' : '',
                                        updateTime: a.create_at,
                                        msgSeq: a.msg_seq,
                                        fileStatus: 0,
                                        fileSize: d.BFileSize,
                                        fileName: d.BFileName,
                                        localPath: d.BFilePath,
                                        read_count: a.read_count,
                                        unread_count: a.unread_count < 0 ? 0 : a.unread_count
                                    });
                                    AddDataUtil.onScrolMsgView()
                                }
                            }
                            Utils.getApp().getCefObj().addTransferItem(JSON.stringify([{
                                chat_id: a.chat_id,
                                chat_name: ParseUtil.getChatnameFromRct(a.chat_id),
                                user_id: a.user_id,
                                user_name: User.getUserName(a.user_id),
                                msg_id: a.msg_id,
                                fetch_id: d.BFileID,
                                file_id: d.BFileID,
                                create_at: a.create_at,
                                file_path: d.BFilePath,
                                path: d.BFilePath,
                                extension: FileUtil.getExtension(d.BFileName),
                                file_name: d.BFileName,
                                file_size: d.BFileSize,
                                size: d.BFileSize,
                                file_status: d.BFileStatus,
                                owner_id: User.ownerID,
                                msg_status: '0'
                            }]))
                        }
                    }
                })
            }
        })
    },
    deleteFailMsg: function (b, a) {
        var c = 'DELETE FROM IMMsg WHERE MsgID=?;';
        this.cExecSqlWithP(c, [b], a)
    },
    getUserInfo: function (d, b, a) {
        var c = 'SELECT * FROM IMUsr WHERE UserID=?;';
        this.cExecSqlWithP(c, [d], b, a)
    },
    beforeDoChat: function (c, b, a) {
        var d = 'SELECT * FROM IMChat WHERE ChatID=?;';
        this.cExecSqlWithP(d, [c], function (e, f) {
            var d = f.rows;
            if (d.length > 0) {
                if (Ext.isFunction(b)) {
                    b(e, d.item(0))
                }
            } else {
                if (Ext.isFunction(a)) {
                    a(e)
                }
            }
        })
    },
    insertIntoChatByAPI: function (d, b, a, c) {
        var e = this;
        Utils.custAjax('get', 'users/me/chats/' + d, {
            success: function (f) {
                e.beforeDoChat(d, function (e, g) {
                    if (a) {
                        a()
                    }
                }, function (k) {
                    if (f.iscrowd == 'Y') {
                        f.chat_type = 'C'
                    }
                    var j = 'INSERT INTO IMChat (ChatID, ChatType, DisplayName, CreatorID, ManagerID, Status, CreateAt, UpdateAt, Remarks, UserIDs, IsMute, FromERP) VALUES (?,?,?,?,?,?,?,?,?,?,?,?);';
                    var i = LocalDataMgr.getUsersMsg(f.members),
                        h = i.ids;
                    if (!b) {
                        b = '0'
                    }
                    var g = '';
                    if (f.chat_type == ChatType.Direct) {
                        g = ParseUtil.getDctNameFromMems(f.members)
                    } else {
                        if (f.chat_type == ChatType.Multi || f.chat_type == 'C') {
                            g = f.header
                        }
                    }
                    var e = f.is_mute;
                    if (Ext.isEmpty(e)) {
                        e = 'N'
                    }
                    k.executeSql(j, [f.chat_id, f.chat_type, g, f.creator_id, f.manager_id, b, f.create_at, f.update_at, f.purpose, h, e, f.from_erp], function () {
                        if (a) {
                            a()
                        }
                    })
                })
            },
            failure: function () {
                if (Ext.isFunction(c)) {
                    c()
                }
            }
        }, !1)
    },
    beforeDoRct: function (c, b, a) {
        var d = 'SELECT * FROM IMRct WHERE ChatID=?;';
        this.cExecSqlWithP(d, [c], function (e, f) {
            var d = f.rows;
            if (d.length > 0) {
                if (Ext.isFunction(b)) {
                    b(e, d.item(0))
                }
            } else {
                if (Ext.isFunction(a)) {
                    a(e)
                }
            }
        })
    },
    beforeDoMsg: function (c, b, a) {
        var d = 'SELECT * FROM IMMsg WHERE MsgID=?;';
        this.cExecSqlWithP(d, [c], function (e, f) {
            var d = f.rows;
            if (d.length > 0) {
                if (Ext.isFunction(b)) {
                    b(e, d.item(0))
                }
            } else {
                if (Ext.isFunction(a)) {
                    a(e)
                }
            }
        })
    },
    execSendBFile: function (a) {
        this.beforeDoMsg(a.msg_id, function (b, c) {}, function (c) {
            console.log('dawenjia' + a.msg_id);
            var b = 'INSERT INTO IMMsg \n                (MsgID, ChatID, MsgType, Content, CreateAt, SenderID, SenderName, Status) \n                VALUES (?,?,?,?,?,?,?,?);\n            ';
            c.executeSql(b, [a.msg_id, a.chat_id, MsgType.BigFileMsg, a.path, a.now_time, User.ownerID, User.crtUser.user_name, '1'], function (d) {
                var b = 'SELECT * FROM IMMsg WHERE MsgID = ?';
                d.executeSql(b, [a.msg_id], function (h, e) {
                    var b = e.rows;
                    if (b.length > 0) {
                        var f = b.item(0).ID;
                        var g = 'INSERT INTO IMBFile \n                            (BFileID, BaseID, ChatID, UserID, BFilePath, BFileName, BFileSize, BFileExtension, BFileStatus, CreateAt) \n                            VALUES (?,?,?,?,?,?,?,?,?,?)';
                        h.executeSql(g, [a.fetch_id, f, a.chat_id, User.ownerID, a.path, a.file_name, a.file_size, FileUtil.getExtension(a.file_name), 1, a.now_time])
                    } else {
                        Utils.toastShort('操作数据库出错：execSendBFile')
                    }
                })
            })
        })
    },
    upBigFileSuccess: function (a) {
        this.beforeDoIMBFile(a.file_id, function (c, d) {
            var b = 'UPDATE IMBFile SET BFileStatus=? WHERE BFileID=?;';
            c.executeSql(b, [2, a.file_id])
        }, function () {
            console.error('upBigFileSuccess 因为有转发大文件问题 错误暂不输出', a)
        })
    },
    notifyBFileSuccess: function (a) {
        this.beforeDoIMBFile(a.file_id, function (c, d) {
            var b = 'UPDATE IMBFile SET BFileStatus=? WHERE BFileID=?;';
            c.executeSql(b, [0, a.file_id])
        }, function () {
            console.error('notifyBFileSuccess 因为有转发大文件问题 错误暂不输出', a)
        })
    },
    beforeDoIMBFile: function (c, b, a) {
        var d = 'SELECT * FROM IMBFile WHERE BFileID=?;';
        this.cExecSqlWithP(d, [c], function (e, f) {
            var d = f.rows;
            if (d.length > 0) {
                if (Ext.isFunction(b)) {
                    b(e, d.item(0))
                }
            } else {
                if (Ext.isFunction(a)) {
                    a(e)
                }
            }
        })
    },
    getBigFileByWS: function (a) {
        this.beforeDoIMBFile(a.file_id, function (c, d) {
            var b = 'UPDATE IMBFile SET BFileStatus=? WHERE BFileID=?;';
            c.executeSql(b, [a.status, a.file_id])
        }, function () {
            console.error('getBigFileByWS 因为有转发大文件问题 错误暂不输出', a)
        })
    },
    doDownBigFile: function (a) {
        this.beforeDoIMBFile(a.file_id, function (c, d) {
            var b = 'UPDATE IMBFile SET BFileStatus=?,BFilePath=? WHERE BFileID=?;';
            c.executeSql(b, [1, a.file_path, a.file_id])
        }, function () {
            console.error('doDownBigFile', a)
        })
    },
    downBigFileSuccess: function (a) {
        this.beforeDoIMBFile(a.file_id, function (c, d) {
            var b = 'UPDATE IMBFile SET BFileStatus=?,BFilePath=? WHERE BFileID=?;';
            c.executeSql(b, [0, a.file_path, a.file_id])
        }, function () {
            console.error('downBigFileSuccess', a)
        })
    },
    downBigFileFailure: function (a) {
        this.beforeDoIMBFile(a.file_id, function (c, d) {
            var b = 'UPDATE IMBFile SET BFileStatus=? WHERE BFileID=?;';
            c.executeSql(b, [1, a.file_id])
        }, function () {
            console.error('downBigFileFailure', a)
        })
    },
    getBFiles: function (a) {
        var b = 'SELECT M.*,B.*,C.DisplayName FROM IMBFile B \n        JOIN IMMsg M ON M.ID=B.BaseID\n        LEFT JOIN IMChat C ON M.ChatID=C.ChatID\n        WHERE B.IsHiddenInForm = ? AND M.MsgType = ?\n        ORDER BY M.CreateAt DESC;\n        ';
        this.cExecSqlWithP(b, ['N', MsgType.BigFileMsg], function (d, b) {
            var c = b.rows;
            if (Ext.isFunction(a)) {
                a(d, c)
            }
        })
    },
    cancelUpBigFile: function (a) {
        this.beforeDoIMBFile(a, function (c, d) {
            var b = 'UPDATE IMBFile SET BFileStatus=? WHERE BFileID=?;';
            c.executeSql(b, [-1, a])
        }, function () {
            console.error('notifyBFileSuccess 因为有转发大文件问题 错误暂不输出', a)
        })
    },
    downloadingBigFile: function (a) {
        this.beforeDoIMBFile(a.file_id, function (c, d) {
            var b = 'UPDATE IMBFile SET BFileStatus=?,BFilePath=? WHERE BFileID=?;';
            c.executeSql(b, [2, a.down_to_path, a.file_id])
        }, function () {
            console.error('downloadingBigFile', a.file_id)
        })
    },
    hideBFileInBFileForm: function (a) {
        this.beforeDoIMBFile(a.file_id, function (c, d) {
            var b = 'UPDATE IMBFile SET IsHiddenInForm=? WHERE BFileID=?;';
            c.executeSql(b, ['Y', a.file_id])
        }, function () {
            console.error('hideBFileInBFileForm', a.file_id)
        })
    },
    showBFileInBFileForm: function (a) {
        this.beforeDoIMBFile(a, function (c, d) {
            var b = 'UPDATE IMBFile SET IsHiddenInForm=? WHERE BFileID=?;';
            c.executeSql(b, ['N', a])
        }, function () {})
    },
    clearRctMentionCount: function (a) {
        var b = 'UPDATE IMRcT SET MentionCount=? WHERE ChatID=?;';
        this.cExecSqlWithP(b, [0, a])
    },
    beforeDoIMMsgA: function (d, c, b, a) {
        var e = 'SELECT * FROM IMMsgA WHERE MsgID=? AND ChatID=?;';
        this.cExecSqlWithP(e, [d, c], function (f, g) {
            var e = g.rows;
            if (e.length > 0) {
                if (Ext.isFunction(b)) {
                    b(f, e.item(0))
                }
            } else {
                if (Ext.isFunction(a)) {
                    a(f)
                }
            }
        })
    },
    addMentions: function (d, c) {
        var g = 'UPDATE IMMsgA SET Status=? WHERE Status<>? AND ChatID=?;';
        LocalDataMgr.cExecSqlWithP(g, [1, 1, d]);
        var e = c.length,
            a, f = 'INSERT OR REPLACE INTO IMMsgA (MsgID,MsgSeq,ChatID,UserID,UserName,CreateAt,ViewAt,Status) \n        VALUES \n        (?,?,?,?,?,?,?,?);';
        for (var b = 0; b < e; b++) {
            a = c[b];
            LocalDataMgr.cExecSqlWithP(f, [a.msg_id, a.msg_seq, a.chat_id, a.user_id, User.getUserName(a.user_id), a.create_at, 0, 0])
        }
    },
    addOneMention: function (a) {
        var b = 'INSERT OR REPLACE INTO IMMsgA (MsgID,MsgSeq,ChatID,UserID,UserName,CreateAt,ViewAt,Status) \n                VALUES \n                (?,?,?,?,?,?,?,?);';
        LocalDataMgr.cExecSqlWithP(b, [a.msg_id, a.msg_seq, a.chat_id, a.user_id, User.getUserName(a.user_id), a.create_at, 0, 0]);
        var c = 'UPDATE IMRct SET MentionCount=MentionCount+1 WHERE ChatID=?';
        LocalDataMgr.cExecSqlWithP(c, [a.chat_id])
    },
    addOneReadedMention: function (a) {
        var b = 'INSERT OR REPLACE INTO IMMsgA (MsgID,MsgSeq,ChatID,UserID,UserName,CreateAt,ViewAt,Status) \n                VALUES \n                (?,?,?,?,?,?,?,?);';
        LocalDataMgr.cExecSqlWithP(b, [a.msg_id, a.msg_seq, a.chat_id, a.user_id, User.getUserName(a.user_id), a.create_at, ParseUtil.getLocalTime(!0), 1])
    },
    getMentions: function (b, a) {
        var c = 'SELECT * FROM IMMsgA WHERE ChatID=? AND Status=? ORDER BY MsgSeq DESC;';
        this.cExecSqlWithP(c, [b, 0], function (d, c) {
            if (Ext.isFunction(a)) {
                a(d, c)
            }
        })
    },
    removeOneMention: function (a, b) {
        var c = 'UPDATE IMMsgA SET Status=?,ViewAt=? WHERE MsgID=? AND ChatID=? AND Status<>?;';
        this.cExecSqlWithP(c, [1, ParseUtil.getLocalTime(!0), b, a, 1]);
        this.beforeDoRct(a, function (d, e) {
            var c = 'UPDATE IMRct SET MentionCount=MentionCount-1 WHERE ChatID=?;';
            d.executeSql(c, [a])
        })
    },
    clearMentions: function (a) {
        var b = 'UPDATE IMRct SET MentionCount=? WHERE ChatID=?;';
        this.cExecSqlWithP(b, [0, a]);
        var c = 'UPDATE IMMsgA SET Status=?,ViewAt=? WHERE Status<>? AND ChatID=?;';
        this.cExecSqlWithP(c, [1, ParseUtil.getLocalTime(!0), 1, a])
    },
    muteChat: function (a) {
        var b = 'UPDATE IMRct SET IsMute=? WHERE ChatID=?;';
        LocalDataMgr.cExecSqlWithP(b, ['Y', a]);
        var c = 'UPDATE IMChat SET IsMute=? WHERE ChatID=?;';
        LocalDataMgr.cExecSqlWithP(c, ['Y', a])
    },
    remindChat: function (a) {
        var b = 'UPDATE IMRct SET IsMute=? WHERE ChatID=?;';
        LocalDataMgr.cExecSqlWithP(b, ['N', a]);
        var c = 'UPDATE IMChat SET IsMute=? WHERE ChatID=?;';
        LocalDataMgr.cExecSqlWithP(c, ['N', a])
    },
    updateMute: function (a, b) {
        var c = this;
        var d = 'UPDATE IMRct SET IsMute=? WHERE ChatID=?;';
        LocalDataMgr.cExecSqlWithP(d, [b, a]);
        c.beforeDoChat(a, function () {
            var c = 'UPDATE IMChat SET IsMute=? WHERE ChatID=?;';
            LocalDataMgr.cExecSqlWithP(c, [b, a])
        }, function () {
            c.insertIntoChatByAPI(a, '0')
        })
    },
    getMaxReplySeq: function (c, a, b) {
        var d = 'SELECT MAX(ReplySeq) ReplySeq FROM IMReply WHERE RootID=?;';
        this.cExecSqlWithP(d, [c], function (h, f) {
            var e = f.rows;
            if (e.length > 0) {
                var g = e.item(0);
                var d = g.ReplySeq;
                if (Ext.isEmpty(d)) {
                    d = 0
                }
                if (a) {
                    a(d)
                }
            }
        }, b)
    },
    getLatestReply: function (c, b, a) {
        var d = 'SELECT * FROM IMReply WHERE RootID=? ORDER BY CreateAt DESC LIMIT ?;';
        this.cExecSqlWithP(d, [c, ConfigMgr.msgCountInOnePage], b, a)
    },
    initReplyNotice: function (c) {
        var d = c.length,
            a, e = 'UPDATE IMMsg SET NewReply=?,ReplyCount=?,ReplyUpdateAt=? WHERE MsgID=?;';
        for (var b = 0; b < d; b++) {
            a = c[b];
            this.cExecSqlWithP(e, ['Y', a.reply_count, a.update_at, a.root_id])
        }
    },
    viewReply: function (a) {
        var b = 'UPDATE IMMsg SET NewReply=? WHERE MsgID=?;';
        this.cExecSqlWithP(b, ['N', a])
    },
    saveReplies: function (c) {
        var d = c.length;
        if (d <= 0) {
            return
        }
        var e = '\n                INSERT INTO IMReply (ReplyID, ReplySeq, CreateAt, UpdateAt, EditAt, DeleteAt, UserID, UserName, RootID, Content, ContentType, AttachID, ContentEx, ChatID) \n                VALUES\n                (?,?,?,?,?,?,?,?,?,?,?,?,?,?);\n            ',
            a;
        for (var b = 0; b < d; b++) {
            a = c[b];
            this.cExecSqlWithP(e, [a.reply_id, a.reply_seq, a.create_at, a.update_at, a.edit_at, a.delete_at, a.user_id, a.user_name, a.root_id, a.content, a.content_type, a.attach_id, a.content_ex, a.chat_id])
        }
    },
    wsReplied: function (a, c, b) {
        var d = 'UPDATE IMMsg SET NewReply=?,ReplyCount=?,ReplyUpdateAt=? WHERE MsgID=?;';
        this.cExecSqlWithP(d, [c, b, a.update_at, a.root_id])
    },
    beforeDoReply: function (d, b, a) {
        var c = 'SELECT * FROM IMReply WHERE ReplyID=?;';
        this.cExecSqlWithP(c, [d], function (e, f) {
            var c = f.rows;
            if (c.length > 0) {
                if (Ext.isFunction(b)) {
                    b(e, c.item(0))
                }
            } else {
                if (Ext.isFunction(a)) {
                    a(e)
                }
            }
        })
    },
    getMsgReplyhead: function (a) {
        var b = ' SELECT C.AvatarHash,C.ChatType,C.UserIDs,C.DisplayName,C.CreateAt as Creatatchat,B.BFilePath,L.LinkObjType,L.LinkType,L.LinkKeyString,F.FilePath,F.FileID,F.FileName,F.CreateAt as CreatatFile,M.SenderID,M.MsgType,M.ChatID,M.Content,M.CreateAt,M.SenderName,M.MsgID,M.NewReply,M.ReplyUpdateAt FROM IMMsg M  LEFT JOIN IMChat C ON M.ChatID = C.ChatID  LEFT JOIN IMFile F ON M.ID = F.BaseID  LEFT JOIN IMLink L ON M.ID = L.BaseID  LEFT JOIN IMBFile B ON M.ID = B.BaseID  WHERE M.ReplyCount > 0 AND M.ReplyCount is NOT Null   Order by M.NewReply DESC, M.ReplyUpdateAt DESC ';
        this.cExecSqlWithP(b, [], a)
    },
    getMsgReplycontent: function (a, b) {
        var c = ' SELECT E.* FROM IMReply E  WHERE E.RootID=?  Order by E.CreateAt ASC ';
        this.cExecSqlWithP(c, [a], b)
    },
    getMsgmyReplyhead: function (a, b) {
        var c = ' SELECT C.AvatarHash,C.ChatType,C.UserIDs,C.DisplayName,C.CreateAt as Creatatchat,B.BFilePath,L.LinkObjType,L.LinkType,L.LinkKeyString,F.FilePath,F.FileID,F.FileName,F.CreateAt as CreatatFile,M.SenderID,M.MsgType,M.ChatID,M.Content,M.CreateAt,M.SenderName,M.MsgID,M.NewReply,M.ReplyUpdateAt FROM IMMsg M  LEFT JOIN IMChat C ON M.ChatID = C.ChatID  INNER JOIN ( SELECT * FROM ( SELECT * FROM IMReply WHERE UserID= ? ) Group by RootID ) E ON M.MsgID = E.RootID  LEFT JOIN IMFile F ON M.ID = F.BaseID  LEFT JOIN IMLink L ON M.ID = L.BaseID  LEFT JOIN IMBFile B ON M.ID = B.BaseID  WHERE M.ReplyCount > 0 AND  M.SenderID NOT IN (?) Order by M.NewReply DESC, M.ReplyUpdateAt DESC ';
        this.cExecSqlWithP(c, [a, a], b)
    },
    getchattype: function (b, a) {
        var c = 'SELECT R.ChatType From IMRct R WHERE R.ChatID=? ';
        this.cExecSqlWithP(c, [b], function (e, d) {
            var c = d.rows.item(0).ChatType;
            a(c)
        })
    },
    getMsgaboutmeReplyhead: function (b, a) {
        var c = ' SELECT C.AvatarHash,C.ChatType,C.UserIDs,C.DisplayName,C.CreateAt as Creatatchat,B.BFilePath,L.LinkObjType,L.LinkType,L.LinkKeyString,F.FilePath,F.FileID,F.FileName,F.CreateAt as CreatatFile,M.SenderID,M.MsgType,M.ChatID,M.Content,M.CreateAt,M.SenderName,M.MsgID,M.NewReply,M.ReplyUpdateAt FROM IMMsg M  LEFT JOIN IMChat C ON M.ChatID = C.ChatID  LEFT JOIN IMFile F ON M.ID = F.BaseID  LEFT JOIN IMLink L ON M.ID = L.BaseID  LEFT JOIN IMBFile B ON M.ID = B.BaseID  WHERE M.ReplyCount > 0 AND M.ReplyCount is NOT Null AND M.SenderID= ?  Order by M.NewReply DESC, M.ReplyUpdateAt DESC ';
        this.cExecSqlWithP(c, [b], a)
    },
    getMsgNewreply: function (b, a) {
        var c = ' SELECT M.NewReply FROM IMMsg M  WHERE M.MsgID= ? ';
        this.cExecSqlWithP(c, [b], a)
    },
    IfinMsg: function (a) {
        var c = a.length;
        if (c <= 0) {
            return
        }
        var d = ' SELECT M.MsgSeq,M.SenderID FROM IMMsg M  WHERE M.MsgID= ? ';
        var b = {};
        b.i$24 = 0;
        for (; b.i$24 < c; b = {
                i$24: b.i$24
            }, b.i$24++) {
            this.cExecSqlWithP(d, [a[b.i$24].root_id], function (b) {
                return function (d, c) {
                    (new Ext.Promise(function (j, n) {
                        if (c.rows.length < 1) {
                            var m = [{
                                to_seq: parseInt(a[b.i$24].msg_seq),
                                from_seq: a[b.i$24].msg_seq - 1
                            }];
                            Utils.custAjax('post', 'chats/' + a[b.i$24].chat_id + '/posts/unread', {
                                params: JSON.stringify(m),
                                success: function (g) {
                                    var f = 'N';
                                    var e = g.message_list[0].message;
                                    if (User.ownerID == e.user_id) {
                                        f = 'Y'
                                    }
                                    var h = 'INSERT INTO IMMsg (MsgID, ChatID, MsgType, Content, CreateAt, SenderID, SenderName, NewReply, ReplyCount, MsgSeq, Status) VALUES (?,?,?,?,?,?,?,?,?,?,?);';
                                    LocalDataMgr.cExecSqlWithP(h, [e.msg_id, e.chat_id, e.msg_type, e.message, e.create_at, e.user_id, e.user_name, e.new_reply, e.reply_count, e.msg_seq, '0']);
                                    console.log('没有本地数据' + a[b.i$24].chat_id);
                                    j(a[b.i$24].chat_id)
                                }
                            })
                        } else {
                            if (!window.cefMsgMgr) {
                                var i = Ext.getStore('comRct').data.items;
                                var g = !1;
                                for (var f = 0; f < i.length; f++) {
                                    if (Ext.getStore('comRct').data.items[f].data.chat_id == 'eeeeeeeebbbbbbbbbfffffffff') {
                                        g = !0;
                                        break
                                    }
                                }
                                var h = !1,
                                    e = 0;
                                if (c.rows.item(0).SenderID == User.ownerID) {
                                    h = !0;
                                    e = 1
                                }
                                if (g) {
                                    Ext.getStore('comRct').getById('eeeeeeeebbbbbbbbbfffffffff').set({
                                        last_msg_type: 'P',
                                        last_post_msg: '',
                                        last_post_at: new Date(a[b.i$24].update_at),
                                        isUnRead: h,
                                        unReadNum: e
                                    });
                                    var k = 'UPDATE IMRct SET DisplayName=?, UnreadCount=?, LastPostAt=?, LastMsgType=? WHERE ChatID=?;';
                                    LocalDataMgr.cExecSqlWithP(k, ['消息回复', e, a[b.i$24].update_at, 'P', 'eeeeeeeebbbbbbbbbfffffffff']);
                                    var l = 'UPDATE IMChat SET DisplayName=?, ChatType=?, UpdateAt=?, Status=? WHERE ChatID=?;';
                                    LocalDataMgr.cExecSqlWithP(l, ['消息回复', 'P', a[b.i$24].update_at, '0', 'eeeeeeeebbbbbbbbbfffffffff'])
                                } else {
                                    SocketEventUtil.addRctReplyWsPost(Ext.getStore('comRct'), c.rows.item(0).SenderID, a[b.i$24], function () {})
                                }
                                console.log('这是有本地数据的' + a[b.i$24].chat_id)
                            }
                        }
                    })).then(function (e) {
                        console.log('没有本地数据插入chat：' + e);
                        var f = ' SELECT C.ChatType FROM IMChat C  WHERE C.ChatID= ? ';
                        LocalDataMgr.cExecSqlWithP(f, [e], function (g, f) {
                            if (f.rows.length < 1) {
                                ChatUtil.getChat(e, function (h) {})
                            }
                        })
                    })
                }
            }(b))
        }
    },
    getLocalNews: function (c, b, a) {
        var d = 'SELECT NewsID,NewsSeq,CreatorID,CreateAt,Title,Description,PicUrl,DescUrl,IsText,NewsType FROM IMNews WHERE CreateAt < ? ORDER BY CreateAt DESC limit 0,' + b;
        this.cExecSqlWithP(d, [c], a)
    },
    saveToLocalNews: function (a) {
        var b = 'SELECT NewsID FROM IMNews WHERE NewsID = ?';
        this.cExecSqlWithP(b, [a.news_id], function (d, c) {
            if (c.rows.length == 0) {
                var b = 'INSERT INTO IMNews (\n                    NewsID,\n                    NewsSeq,\n                    CreatorID,\n                    CreateAt,\n                    UpdateAt,\n                    DeleteAt,\n                    Title,\n                    Description,\n                    PicUrl,\n                    DescUrl,\n                    IsText,\n                    NewsType,\n                    Extras\n                ) VALUES (?,?,?,?,?,?,?,?,?,?,?,?,?);';
                LocalDataMgr.cExecSqlWithP(b, [a.news_id, a.news_seq, a.creator_id, a.create_at, a.create_at, 0, a.title, a.description, a.pic_url, a.des_url, a.is_text, a.news_type, a.extras])
            }
        })
    },
    newsToLocalChat: function (a) {
        var b = 'SELECT ChatID FROM IMChat WHERE ChatID = ?;';
        this.cExecSqlWithP(b, [StaticChatID.News], function (d, c) {
            if (c.rows.length == 0) {
                var b = 'INSERT INTO IMChat (\n                    ChatID,\n                    DisplayName,\n                    CreatorID,\n                    ManagerID,\n                    Status,\n                    CreateAt,\n                    UpdateAt,\n                    Remarks,\n                    UserIDs,\n                    ChatType,\n                    IsMute\n                ) VALUES (?,?,?,?,?,?,?,?,?,?,?);';
                LocalDataMgr.cExecSqlWithP(b, [StaticChatID.News, '消息中心', a.creator_id, a.creator_id, 0, a.create_at, a.create_at, '', User.ownerID, ChatType.News, 'N'])
            }
        })
    },
    newsToLocalRct: function (a) {
        var b = 'SELECT ChatID FROM IMRct WHERE ChatID = ?;';
        this.cExecSqlWithP(b, [StaticChatID.News], function (e, d) {
            if (d.rows.length == 0) {
                var b = 'INSERT OR REPLACE INTO IMRct (\n                    ChatID, \n                    DisplayName, \n                    ChatType, \n                    UnreadCount, \n                    LastPostAt,\n                    LastUserID,\n                    LastUserName,\n                    LastMessage,\n                    LastMsgType, \n                    UserID, \n                    CreateAt\n                ) VALUES (?,?,?,?,?,?,?,?,?,?,?);';
                LocalDataMgr.cExecSqlWithP(b, [StaticChatID.News, '消息中心', ChatType.News, a.unReadNum, a.create_at, 'sys', 'sys', a.title, a.news_type, User.ownerID, a.create_at])
            } else {
                var c = 'UPDATE IMRct SET LastPostAt = ?, UnreadCount = ?, LastMessage = ?, LastMsgType = ? WHERE ChatID = ?';
                LocalDataMgr.cExecSqlWithP(c, [a.create_at, a.unReadNum, a.title || a.description, a.news_type, StaticChatID.News])
            }
        })
    },
    newsToUpdateRct: function (a) {
        var b = 'UPDATE IMRct SET LastUserID = ?, LastUserName = ?, LastPostAt = ?,  UnreadCount = ? WHERE ChatID = ?';
        this.cExecSqlWithP(b, [a.creator_id, User.crtUser.user_name, a.create_at, a.unReadNum, StaticChatID.News])
    },
    ifHasmems: function (b, a) {
        var c = 'SELECT * FROM IMChatCM WHERE ChatID=?;';
        this.cExecSqlWithP(c, [b.chat_id], a)
    },
    saveCrowdInfo: function (b, c) {
        var d = 'SELECT * FROM IMChatC WHERE ID=?;';
        var a = b;
        LocalDataMgr.cExecSqlWithP(d, [a.id], function (o, h) {
            if (h.rows.length == 0) {
                var l = 'INSERT INTO IMChatC (ID, ChatID, Notice, DeleteAt, CreateAt, UpdateAt, Header, ManagerID, ChatStatus, Hash, AvaHash) \n                    VALUES \n                    (?,?,?,?,?,?,?,?,?,?,?);';
                LocalDataMgr.cExecSqlWithP(l, [a.id, a.chat_id, a.notice, a.delete_at, a.create_at, a.update_at, a.header, a.manager_id, a.chat_status, a.hash, a.avatar_hash], c);
                var g = b.members.length;
                var d;
                var k = 'INSERT OR REPLACE INTO IMChatCM (\n                            ChatID, \n                            BodyID, \n                            IsAdmin\n                        ) VALUES (?,?,?);';
                for (var e = 0; e < g; e++) {
                    d = b.members[e];
                    LocalDataMgr.cExecSqlWithP(k, [b.chat_id, d.user_id, d.is_admin])
                }
            } else {
                var i = h.rows.item(0).Hash;
                if (i == a.hash) {
                    var m = 'UPDATE IMChatC SET Notice = ?, ReMark = ?, UpdateAt = ?, Hash = ?, AvaHash = ? WHERE ID = ?';
                    LocalDataMgr.cExecSqlWithP(m, [a.notice, a.remark, a.update_at, a.hash, a.avatar_hash, a.id], c)
                } else {
                    var n = 'UPDATE IMChatC SET Notice = ?, ReMark = ?, UpdateAt = ?, Hash = ?, AvaHash = ? WHERE ID = ?';
                    LocalDataMgr.cExecSqlWithP(n, [a.notice, a.remark, a.update_at, a.hash, a.avatar_hash, a.id], c);
                    var g = b.members.length;
                    var d;
                    var j = 'INSERT OR REPLACE INTO IMChatCM (\n                                ChatID, \n                                BodyID, \n                                IsAdmin\n                            ) VALUES (?,?,?);';
                    for (var f = 0; f < g; f++) {
                        d = b.members[f];
                        LocalDataMgr.cExecSqlWithP(j, [b.chat_id, d.user_id, d.is_admin])
                    }
                }
            }
        })
    },
    updatecrowdName: function (a, c, b, d) {
        var e = ['UPDATE IMRct SET DisplayName=?,', 'LastPostAt=?,', 'LastUserID=?,', 'LastUserName=?,', 'LastMessage=?,', 'LastMsgType=? ', 'WHERE ChatID=?;'].join('');
        LocalDataMgr.cExecSqlWithP(e, [a, c, User.ownerID, b, d, MsgType.GroupNotice, User.crtChannelId]);
        var f = 'UPDATE IMChat SET DisplayName=? WHERE ChatID=?;';
        LocalDataMgr.cExecSqlWithP(f, [a, User.crtChannelId])
    },
    UpdateCrowd: function (c, b) {
        var d = 'SELECT * FROM IMChatC WHERE ID=?;';
        var a = c;
        LocalDataMgr.cExecSqlWithP(d, [a.id], function (g, f) {
            if (f.rows.length == 0) {
                var d = 'INSERT INTO IMChatC (ID, ChatID, Notice, DeleteAt, CreateAt, UpdateAt, Header, ManagerID, ChatStatus, Hash, ReMark, AvaHash) \n                    VALUES \n                    (?,?,?,?,?,?,?,?,?,?,?,?);';
                LocalDataMgr.cExecSqlWithP(d, [a.id, a.chat_id, a.notice, a.delete_at, a.create_at, a.update_at, a.header, a.manager_id, a.chat_status, a.hash, a.remark, a.avatar_hash], b)
            } else {
                var e = 'UPDATE IMChatC SET Notice = ?, ReMark = ?, UpdateAt = ?, Hash = ?, AvaHash = ? WHERE ID = ?';
                LocalDataMgr.cExecSqlWithP(e, [a.notice, a.remark, a.update_at, a.hash, a.avatar_hash, a.id], b)
            }
        })
    },
    CrowdInfoToLocalChat: function (a) {
        var b = 'SELECT ChatID FROM IMChat WHERE ChatID = ?;';
        this.cExecSqlWithP(b, [a.chat_id], function (d, c) {
            if (c.rows.length == 0) {
                var b = 'INSERT INTO IMChat (\n                    ChatID,\n                    DisplayName,\n                    ManagerID,\n                    Status,\n                    CreateAt,\n                    UpdateAt,\n                    Remarks,\n                    ChatType,\n                    IsMute\n                ) VALUES (?,?,?,?,?,?,?,?,?);';
                LocalDataMgr.cExecSqlWithP(b, [a.chat_id, a.header, a.manager_id, 0, a.create_at, a.update_at, '', 'C', 'N'])
            }
        })
    },
    CrowdToLocalRct: function (a, c, d, b) {
        var e = 'UPDATE IMRct SET DisplayName = ?, ChatType = ?, UnreadCount = ?, LastPostAt = ?, LastMessage = ?, LastMsgType = ?, CreateAt = ?, LastUserID = ?, LastUserName = ? WHERE ChatID = ?';
        this.cExecSqlWithP(e, [a.header, 'C', c, a.update_at, '通知', d, a.create_at, b.user_id, User.userInfos[b.user_id].user_name, a.chat_id])
    },
    saveToLocalMsg: function (a) {
        var b = 'SELECT MsgID FROM IMMsg WHERE MsgID = ?';
        this.cExecSqlWithP(b, [a.msg_id], function (d, c) {
            if (c.rows.length == 0) {
                var b = 'INSERT INTO IMMsg (\n                    MsgID,\n                    ChatID,\n                    MsgSeq,\n                    MsgType,\n                    CreateAt,\n                    Content,\n                    Status,\n                    SenderID,\n                    SenderName\n                ) VALUES (?,?,?,?,?,?,?,?,?);';
                LocalDataMgr.cExecSqlWithP(b, [a.msg_id, a.chat_id, a.msgseq, a.msg_type, a.updateat, '有新的群信息', '0', a.user_id, User.userInfos[a.user_id].user_name])
            }
        })
    },
    saveCrowdSetMsg: function (a, b, c) {
        var d = 'SELECT MsgID FROM IMMsg WHERE MsgID = ?';
        this.cExecSqlWithP(d, [a.msg_id], function (f, e) {
            if (e.rows.length == 0) {
                var d = 'INSERT INTO IMMsg (\n                    MsgID,\n                    ChatID,\n                    MsgSeq,\n                    MsgType,\n                    CreateAt,\n                    Content,\n                    Status,\n                    SenderID,\n                    SenderName\n                ) VALUES (?,?,?,?,?,?,?,?,?);';
                LocalDataMgr.cExecSqlWithP(d, [a.msg_id, a.chat_id, a.msgseq, c, a.updateat, b, '0', a.user_id, User.userInfos[a.user_id].user_name])
            }
        })
    },
    delFilelist: function (b) {
        var c = (new Date()).getTime();
        var d = 'UPDATE IMFile SET DeleteAt = ? WHERE BaseID = ?';
        for (var a = 0; a < b.length; a++) {
            d1 = b[a];
            LocalDataMgr.cExecSqlWithP(d, [c, d1])
        }
    },
    delWorkFilelist: function (b) {
        var c = (new Date()).getTime();
        var d = 'UPDATE IMWFile SET DeleteAt = ? WHERE ID = ?;';
        for (var a = 0; a < b.length; a++) {
            d1 = b[a];
            LocalDataMgr.cExecSqlWithP(d, [c, d1])
        }
    },
    getWorkTopFiles: function (a, b) {
        var c = 'SELECT FileID,FileName,FileSize,FilePath,Extension,CreateAt,MimeType,Extras FROM IMWFile WHERE DeleteAt = 0 ORDER BY CreateAt DESC;';
        this.cExecSqlWithP(c, [], a, b)
    },
    saveToLocalWFile: function (a) {
        var b = 'INSERT OR REPLACE INTO IMWFile (\n            FileID,\n            FileName,\n            FileSize,\n            FilePath,\n            Extension,\n            CreateAt,\n            DeleteAt,\n            MimeType,\n            Extras,\n            RemoteUrl\n        ) VALUES (?,?,?,?,?,?,?,?,?,?);';
        this.cExecSqlWithP(b, [a.fileID, a.fileName, a.fileSize, a.filePath, a.extension, a.createAt, a.deleteAt || 0, a.mimeType, a.extras, a.remoteUrl])
    },
    judgeWFileExists: function (b, a) {
        var c = 'SELECT FileID,FilePath,DeleteAt FROM IMWFile WHERE FileID = ?;';
        this.cExecSqlWithP(c, [b], function (e, d) {
            var c = d.rows;
            if (a) {
                if (c && c.length > 0 && c.item(0).DeleteAt == 0) {
                    a(c.item(0).FilePath)
                } else {
                    a(!1)
                }
            }
        })
    },
    getCFileYM: function (c, f) {
        var a = '';
        var e = '"jpg","jpeg","gif","png","bmp","webp"',
            d = '"doc","docx","ppt","pptx","xls","xlsx","txt","rtf","pdf"';
        var b = "SELECT strftime('%Y-%m',newDate, 'unixepoch','localtime') MyTime \n                FROM (SELECT Extension,substr(CreateAt,0,11) newDate FROM IMFile WHERE FileStatus = 0 And FileType = 'F') ";
        if (c == 'file') {
            a = 'Where Extension in (' + d + ')'
        } else {
            if (c == 'picture') {
                a = 'Where Extension in (' + e + ')'
            }
        }
        var g = ' GROUP BY MyTime ORDER BY MyTime DESC';
        b = b + a + g;
        this.cExecSqlWithP(b, [], f)
    },
    getWFileYM: function (c, f) {
        var a = '';
        var e = '"jpg","jpeg","gif","png","bmp","webp"',
            d = '"doc","docx","ppt","pptx","xls","xlsx","txt","rtf","pdf"';
        var b = "SELECT strftime('%Y-%m',newDate, 'unixepoch','localtime') MyTime \n                FROM (SELECT Extension,substr(CreateAt,0,11) newDate FROM IMWFile WHERE DeleteAt = 0) ";
        if (c == 'file') {
            a = 'Where Extension in (' + d + ')'
        } else {
            if (c == 'picture') {
                a = 'Where Extension in (' + e + ')'
            }
        }
        var g = 'GROUP BY MyTime ORDER BY MyTime DESC';
        b = b + a + g;
        this.cExecSqlWithP(b, [], f)
    },
    getCFileByMonth: function (c, b, e, a) {
        if (!a) {
            a = (new Date()).getTime()
        }
        var d = "SELECT T1.DisplayName,T2.SenderID,T2.SenderName,T0.ID,T0.FileID,T0.FileName,T0.FileSize,T0.FilePath,T0.Extension,T0.CreateAt,T0.MimeType, strftime('%Y-%m',T0.newDate, 'unixepoch','localtime') MyTime \n                FROM (SELECT ID,ChatID,BaseID,FileType,FileStatus,FileID,FileName,FileSize,FilePath,Extension,CreateAt,MimeType,substr(CreateAt,0,11) newDate FROM IMFile) T0 \n                LEFT JOIN IMChat T1 ON T0.ChatID = T1.ChatID \n                LEFT JOIN IMMsg T2 ON T0.BaseID = T2.ID \n                WHERE MyTime = ? And T0.FileType = 'F' AND T0.FileStatus = 0 And T0.CreateAt <= ? \n                ORDER BY T0.CreateAt DESC limit 21";
        this.cExecSqlWithP(d, [c, a], b)
    },
    getWFileByMonth: function (c, b, e, a) {
        if (!a) {
            a = (new Date()).getTime()
        }
        var d = "SELECT T0.*, strftime('%Y-%m',newDate, 'unixepoch','localtime') MyTime \n                FROM (SELECT ID,FileID,FileName,FileSize,FilePath,Extension,CreateAt,DeleteAt,MimeType,Extras,substr(CreateAt,0,11) newDate FROM IMWFile) T0 \n                WHERE MyTime = ? AND T0.DeleteAt = 0 And T0.CreateAt <= ? \n                ORDER BY T0.CreateAt DESC limit 21";
        this.cExecSqlWithP(d, [c, a], b)
    },
    getCFileByMonthFile: function (g, f, e, a) {
        if (!a) {
            a = (new Date()).getTime()
        }
        var d = '"jpg","jpeg","gif","png","bmp","webp"',
            c = '"doc","docx","ppt","pptx","xls","xlsx","txt","rtf","pdf"';
        var h = "SELECT T1.DisplayName,T2.SenderID,T2.SenderName,T0.ID,T0.FileID,T0.FileName,T0.FileSize,T0.FilePath,T0.Extension,T0.CreateAt,T0.MimeType, strftime('%Y-%m',T0.newDate, 'unixepoch','localtime') MyTime \n                FROM (SELECT ID,ChatID,BaseID,FileStatus,FileType,FileID,FileName,FileSize,FilePath,Extension,CreateAt,MimeType,substr(CreateAt,0,11) newDate FROM IMFile) T0 \n                LEFT JOIN IMChat T1 ON T0.ChatID = T1.ChatID \n                LEFT JOIN IMMsg T2 ON T0.BaseID = T2.ID \n                WHERE MyTime = ? And T0.FileType = 'F' And T0.FileStatus = 0 And T0.CreateAt <= ? And ";
        var b = 'T0.Extension in (' + d;
        if (e == 'F') {
            b = 'T0.Extension in (' + c
        }
        var i = ') ORDER BY T0.CreateAt DESC limit 21';
        var j = h + b + i;
        this.cExecSqlWithP(j, [g, a], f)
    },
    getWFileByMonthFile: function (g, f, e, a) {
        if (!a) {
            a = (new Date()).getTime()
        }
        var d = '"jpg","jpeg","gif","png","bmp","webp"',
            c = '"doc","docx","ppt","pptx","xls","xlsx","txt","rtf","pdf"';
        var h = "SELECT T0.*, strftime('%Y-%m',newDate, 'unixepoch','localtime') MyTime \n                FROM (SELECT ID,FileID,FileName,FileSize,FilePath,Extension,CreateAt,DeleteAt,MimeType,Extras,substr(CreateAt,0,11) newDate FROM IMWFile) T0 \n                WHERE MyTime = ? AND T0.DeleteAt = 0 And T0.CreateAt <= ? ";
        var b = 'And T0.Extension in (' + d;
        if (e == 'F') {
            b = 'And T0.Extension in (' + c
        }
        var i = ') ORDER BY T0.CreateAt DESC limit 21';
        var j = h + b + i;
        this.cExecSqlWithP(j, [g, a], f)
    },
    deleteCFile: function (c) {
        var a = (new Date()).getTime();
        var b = 'UPDATE IMFile SET DeleteAt = ?,FileStatus = ? WHERE ID = ?;';
        this.cExecSqlWithP(b, [a, 3, c])
    },
    deleteWFile: function (c) {
        var a = (new Date()).getTime();
        var b = 'UPDATE IMWFile SET DeleteAt = ? WHERE ID = ?;';
        this.cExecSqlWithP(b, [a, c])
    },
    searchCFile: function (a, b) {
        var c = "SELECT T1.DisplayName,T2.SenderID,T2.SenderName,T0.FileID,T0.FileName,T0.FileSize,T0.FilePath,T0.Extension,T0.CreateAt,T0.MimeType \n                FROM IMFile T0 \n                LEFT JOIN IMChat T1 ON T0.ChatID = T1.ChatID \n                LEFT JOIN IMMsg T2 ON T0.BaseID = T2.ID \n                WHERE T0.FileType = 'F' And T0.FileStatus = 0 And (T2.SenderID like ? Or T1.DisplayName like ? Or T0.FileName like ?) \n                ORDER BY T0.CreateAt DESC limit 20";
        this.cExecSqlWithP(c, ['%' + a + '%', '%' + a + '%', '%' + a + '%'], b)
    },
    searchWFile: function (c, a) {
        var b = 'SELECT T0.FileID,T0.FileName,T0.FileSize,T0.FilePath,T0.Extension,T0.CreateAt,T0.MimeType \n                FROM IMWFile T0 \n                WHERE T0.DeleteAt = 0 And T0.FileName like ? \n                ORDER BY T0.CreateAt DESC limit 20';
        this.cExecSqlWithP(b, ['%' + c + '%'], a)
    },
    searchCFileMore: function (a, c, b) {
        var d = "SELECT T1.DisplayName,T2.SenderName,T0.FileID,T0.FileName,T0.FileSize,T0.FilePath,T0.Extension,T0.CreateAt,T0.MimeType \n                FROM IMFile T0 \n                LEFT JOIN IMChat T1 ON T0.ChatID = T1.ChatID \n                LEFT JOIN IMMsg T2 ON T0.BaseID = T2.ID \n                WHERE T0.FileType = 'F' And T0.FileStatus = 0 And (T2.SenderID like ? Or T1.DisplayName like ? Or T0.FileName like ?) And T0.CreateAt < ? \n                ORDER BY T0.CreateAt DESC limit 20";
        this.cExecSqlWithP(d, ['%' + a + '%', '%' + a + '%', '%' + a + '%', c], b)
    },
    searchWFileMore: function (d, b, a) {
        var c = 'SELECT T0.FileID,T0.FileName,T0.FileSize,T0.FilePath,T0.Extension,T0.CreateAt,T0.MimeType \n                FROM IMWFile T0 \n                WHERE T0.DeleteAt = 0 And T0.FileName like ? And T0.CreateAt < ? \n                ORDER BY T0.CreateAt DESC limit 20';
        this.cExecSqlWithP(c, ['%' + d + '%', b], a)
    },
    openChatByListFortrans: function (a, c, d, b) {
        var e = 'SELECT * FROM IMRct WHERE ChatID=?;';
        LocalDataMgr.cExecSqlWithP(e, [a.ChatID], function (f, g) {
            var h = g.rows;
            if (h.length > 0) {
                var i = 'UPDATE IMRct SET LastPostAt=?,UnreadCount=0,LastUserID=?,LastUserName=?,LastMessage=?,LastMsgType=? WHERE ChatID=?;';
                f.executeSql(i, [c, User.ownerID, User.crtUser.user_name, b, d, a.ChatID])
            } else {
                var e = a.CreatorID;
                if (a.ChatType == ChatType.Direct) {
                    e = ParseUtil.getUserIDByDitChat(a.UserIDs)
                }
                var j = 'INSERT INTO IMRct (ChatID, ChatType, DisplayName, LastPostAt,UserID,CreateAt,IsMute,LastUserID,LastUserName,LastMessage,LastMsgType,FromERP) VALUES (?,?,?,?,?,?,?,?,?,?,?,?)';
                f.executeSql(j, [a.ChatID, a.ChatType, a.DisplayName, c, e, a.CreateAt, a.IsMute, User.ownerID, User.crtUser.user_name, b, d, a.FromERP])
            }
        })
    },
    isAdminInChat: function (d, b, c, a) {
        if (c == ChatType.Multi) {
            var e = 'SELECT ManagerID FROM IMChat WHERE ChatID = ?;';
            LocalDataMgr.cExecSqlWithP(e, [d], function (g, f) {
                var e = f.rows;
                if (e.length > 0 && a && e.item(0).ManagerID == b) {
                    a(!0)
                } else {
                    a(!1)
                }
            })
        } else {
            if (c == 'C') {
                var f = 'SELECT T0.ManagerID,T1.IsAdmin FROM IMChat T0 \n                LEFT JOIN IMChatCM T1 ON T0.ChatID = T1.ChatID \n                WHERE T1.BodyID = ? AND T1.ChatID = ?';
                LocalDataMgr.cExecSqlWithP(f, [b, d], function (g, f) {
                    var e = f.rows;
                    if (e.length > 0 && a && (e.item(0).ManagerID == b || e.item(0).IsAdmin == 'Y')) {
                        a(!0)
                    } else {
                        a(!1)
                    }
                })
            } else {
                a(!1)
            }
        }
    },
    openChatByChatNotHaveforTrans: function (a, f, b, g, e) {
        var j = 'SELECT * FROM IMRct WHERE ChatID=?;';
        LocalDataMgr.cExecSqlWithP(j, [a.chat_id], function (d, h) {
            var i = h.rows;
            if (i.length > 0) {
                var j = 'UPDATE IMRct SET LastPostAt=?,UnreadCount=0,LastUserID=?,LastUserName=?,LastMessage=?,LastMsgType=? WHERE ChatID=?;';
                d.executeSql(j, [f, User.ownerID, User.crtUser.user_name, e, g, a.chat_id])
            } else {
                var c = a.creator_id;
                if (a.chat_type == ChatType.Direct) {
                    c = a.members[0].user_id == User.ownerID ? a.members[1].user_id : a.members[0].user_id
                }
                var k = 'INSERT INTO IMRct (ChatID, ChatType, DisplayName, LastPostAt,UserID,CreateAt,IsMute,LastUserID,LastUserName,LastMessage,LastMsgType, FromERP) VALUES (?,?,?,?,?,?,?,?,?,?,?,?)';
                d.executeSql(k, [a.chat_id, a.chat_type, b, f, c, a.create_at, a.is_mute, User.ownerID, User.crtUser.user_name, e, g, a.from_erp])
            }
        });
        var c = a.creator_id,
            d = a.manager_id;
        if (a.chat_type == ChatType.Direct) {
            c = d = a.members[0].user_id == User.ownerID ? a.members[1].user_id : a.members[0].user_id
        }
        var i = LocalDataMgr.getUsersMsg(a.members),
            h = i.ids;
        var k = 'INSERT INTO IMChat (ChatID,DisplayName,CreatorID,ManagerID,Status,CreateAt,UpdateAt,Remarks,UserIDs,AvatarHash,ChatType,FromERP) VALUES (?,?,?,?,?,?,?,?,?,?,?,?);';
        LocalDataMgr.cExecSqlWithP(k, [a.chat_id, b, c, d, '0', a.create_at, a.update_at, a.purpose, h, a.avatar_hash, a.chat_type, a.from_erp])
    },
    createtransDitChat: function (a) {
        var d = 'INSERT OR REPLACE INTO IMChat (ChatID, ChatType, DisplayName, CreateAt, UserIDs, Status, UpdateAt, Remarks, AvatarHash) VALUES (?,?,?,?,?,?,?,?,?);';
        var b = [];
        for (var c = 0; c < a.members.length; c++) {
            b.push(a.members[c].user_id)
        }
        b = b.join(',');
        LocalDataMgr.cExecSqlWithP(d, [a.chat_id, a.chat_type, a.display_name, a.create_at, b, '0', a.update_at, a.purpose, a.avatar_hash])
    },
    chgMsgToRead: function (b) {
        var a = b.join('","');
        a = Ext.String.format('"' + a + '"');
        var c = Ext.String.format('Update IMMsg Set HasRead = 1 Where MsgID in ({0}) and HasRead = 0;', a);
        LocalDataMgr.cExecSqlWithP(c, [])
    },
    findUnReadMsg: function (c, b) {
        var a = c.join('","');
        a = Ext.String.format('"' + a + '"');
        var d = Ext.String.format('Select MsgID From IMMsg Where MsgID in ({0}) and HasRead = 0;', a);
        LocalDataMgr.cExecSqlWithP(d, [], function (g, f) {
            var d = f.rows,
                e = [];
            if (d.length > 0) {
                for (var a = 0; a < d.length; a++) {
                    e.push(d.item(a).MsgID)
                }
            }
            if (b) {
                b(e)
            }
        })
    },
    updateMsgWithReceipt: function (a) {
        var g = [];
        var h = 'Update IMMsg Set ReadCount = ?, UnReadCount = ? Where MsgID = ?;';
        if (!a || a.length < 1) {
            return
        }
        if (Config.isPC || window.Cordova) {
            for (var c = 0; c < a.length; c++) {
                var f = a[c];
                var e = [];
                e.push(h);
                e.push([f.read_count, f.unread_count, f.msg_id]);
                g.push(e)
            }
            LocalDataMgr.getDB().sqlBatch(g, function () {}, function (b) {
                Utils.toastShort(b)
            })
        } else {
            for (var d = 0; d < a.length; d++) {
                var b = a[d];
                LocalDataMgr.cExecSqlWithP(h, [b.read_count, b.unread_count, b.msg_id], function () {}, function (b) {
                    Utils.toastShort(b)
                })
            }
        }
    },
    updateMsgWithReadCount: function (b, a) {
        var c = Ext.String.format('Update IMMsg Set ReadCount = ReadCount + {0}, UnReadCount = UnReadCount - {0} Where MsgID = ?;', a);
        LocalDataMgr.cExecSqlWithP(c, [b])
    },
    updateDeatailsReadCount: function (b, a, c) {
        var d = 'Update IMMsg Set ReadCount = ?, UnReadCount = ? Where MsgID = ?;';
        LocalDataMgr.cExecSqlWithP(d, [b, a, c])
    },
    insertIMCache: function (a) {
        if (!a.createAt) {
            a.createAt = (new Date()).getTime()
        }
        if (!a.interval) {
            a.interval = 0
        }
        if (!a.expireAt) {
            a.expireAt = 0
        }
        var b = 'INSERT OR REPLACE Into IMCache(CacheKey,CacheValue,CreateAt,Interval,ExpireAt) values (?,?,?,?,?);';
        LocalDataMgr.cExecSqlWithP(b, [a.cacheKey, a.cacheValue, a.createAt, a.interval, a.expireAt])
    },
    updateCacheValue: function (b, a) {
        var c = 'Update IMCache set CacheValue=? where CacheKey=?;';
        LocalDataMgr.cExecSqlWithP(c, [a, b])
    },
    getCache: function (b, a) {
        var c = 'select * from IMCache where CacheKey=?;';
        LocalDataMgr.cExecSqlWithP(c, [b], function (d, c) {
            if (c.rows.length == 0) {
                a([])
            } else {
                a(c.rows.item(0).CacheValue)
            }
        })
    },
    updateChatStatus: function (b, c, a) {
        var e = this;
        var d = 'update IMChat set Status = ? where ChatID = ?;';
        e.cExecSqlWithP(d, [c, b], function () {
            if (a) {
                a()
            }
        })
    },
    insertNotice: function (a) {
        var c = this;
        var b = 'insert into IMMsg \n        (MsgID, MsgSeq, ChatID, MsgType, Content, CreateAt, SenderID, SenderName, Status) \n        values \n        (?, ?, ?, ?, ?, ?, ?, ?, ?)';
        c.cExecSqlWithP(b, [a.msg_id, a.msg_seq, a.chat_id, a.msg_type, a.content, a.create_at, a.sender_id, a.sender_name, a.status])
    },
    selectChat: function (b, a) {
        var d = this;
        var c = 'select * from IMChat where ChatID = ?';
        d.cExecSqlWithP(c, [b], function (d, c) {
            if (a) {
                a(c)
            }
        })
    },
    selectGroupChat: function (b, a) {
        var d = this;
        var c = 'select * from IMChatC where ChatID = ?';
        d.cExecSqlWithP(c, [b], function (d, c) {
            if (a) {
                a(c)
            }
        })
    },
    selectRecentChat: function (b, a) {
        var d = this;
        var c = 'select TM.*, T0.Status as ChatStatus\n        from IMRct TM\n        left join IMChat T0 on TM.ChatID = T0.ChatID\n        where TM.chatId = ?';
        d.cExecSqlWithP(c, [b], function (d, c) {
            if (a) {
                a(c)
            }
        })
    }
}, 0, 0, 0, 0, 0, 0, [IMCommon.local, 'LocalDataMgr', 0, 'LocalDataMgr'], 0);
Ext.cmd.derive('IMCommon.local.LocalSearchMgr', Ext.Base, {
    alternateClassName: 'LocalSearchMgr',
    singleton: !0,
    getConditions: function (c, b) {
        var a = {};
        switch (c) {
            case SearchType.SendName:
                a.sql = '(INSTR(M.SenderName,?)>0 OR INSTR(M.SenderID,?)>0)';
                a.val = b + ',' + b;
                break;
            case SearchType.GroupName:
                a.sql = 'INSTR(C.DisplayName,?)>0';
                a.val = '' + b;
                break;
            case SearchType.MsgRecord:
                a.sql = '(INSTR(M.Content,?)>0 AND M.MsgType=?)';
                a.val = b + ',T';
                break;
            case SearchType.FileName:
                a.sql = '(INSTR(M.Content,?)>0 AND M.MsgType=?)';
                a.val = b + ',F';
                break;
            case SearchType.Time:
                a.sql = 'M.CreateAt>?';
                a.val = LocalSearchMgr.getSearchTime(b);
                break;
            default:
                break;
        }
        return a
    },
    getSearchTime: function (c) {
        var a = 0,
            b = ParseUtil.getLocalTime(!0);
        switch (c) {
            case 'oneWeek':
                a = b - 1000 * 60 * 60 * 24 * 7;
                break;
            case 'oneMonth':
                a = b - 1000 * 60 * 60 * 24 * 30;
                break;
            case 'threeMonth':
                a = b - 1000 * 60 * 60 * 24 * 30 * 3;
                break;
            case 'oneYear':
                a = b - 1000 * 60 * 60 * 24 * 30 * 12;
                break;
            case 'all':
                break;
            default:
                break;
        }
        return a
    },
    getTimeStr: function (b) {
        var a = '';
        switch (b) {
            case 'oneWeek':
                a = '最近一周';
                break;
            case 'oneMonth':
                a = '最近一个月';
                break;
            case 'threeMonth':
                a = '最近三个月';
                break;
            case 'oneYear':
                a = '最近一年';
                break;
            case 'all':
                a = '不限';
                break;
            default:
                break;
        }
        return a
    },
    searchUserInfo: function (a, b) {
        var c = 'SELECT U.UserID, U.UserName, U.Email, U.Mobile, U.Notes, U.AvatarHash, U.Organizations FROM IMUsr U LEFT JOIN (SELECT SenderID, max(CreateAt) CreateAt FROM IMMsg GROUP BY SenderID) M ON U.UserID = M.SenderID WHERE INSTR(UserID, ?) > 0 OR INSTR(UserName, ?) > 0 OR INSTR(Mobile, ?) > 0 ORDER BY M.CreateAt DESC;';
        LocalDataMgr.cExecSqlWithP(c, ['' + a, '' + a, '' + a], b)
    },
    localRctSearch: function (a, b) {
        var c = 'SELECT S.* FROM ( SELECT T.UserID,T.UserName,T.AvatarHash UserAva,T.Mobile,T1.ChatID,T1.ChatType,T1.CreateAt, T1.DisplayName,T1.AvatarHash ChatAva, 1 HasUser FROM IMUsr T ' + "LEFT JOIN IMChat T1 On INSTR(T1.UserIDs||',', T.UserID||',') " + 'WHERE INSTR(T.UserID, ?) > 0 OR INSTR(T.UserName, ?) > 0 OR INSTR(T.Mobile, ?) > 0 UNION All ' + "SELECT '' UserID, '' UserName,'' UserAva,'' Mobile, ChatID, ChatType,CreateAt, DisplayName,AvatarHash ChatAva,  0 HasUser " + 'FROM IMChat WHERE INSTR(DisplayName, ?) And (ChatType = ? or ChatType = "C") GROUP BY ChatID, UserID, UserName ORDER BY HasUser, ChatID ) S LEFT JOIN ( SELECT ChatID,CreateAt FROM IMMsg GROUP BY ChatID ORDER BY CreateAt DESC LIMIT 100 ) T1 ON S.ChatID = T1.ChatID LEFT JOIN IMRct T2 ON S.ChatID = T2.ChatID ORDER BY HasUser ASC, T2.LastPostAt DESC, T1.CreateAt DESC;';
        LocalDataMgr.cExecSqlWithP(c, ['' + a, '' + a, '' + a, '' + a, ChatType.Multi], function (r, o) {
            var l = o.rows,
                k = [],
                e = [],
                i = '',
                j = '',
                g = {};
            if (l.length > 0) {
                for (var d = 0; d < l.length; d++) {
                    var c = l.item(d);
                    if (d == 0) {
                        e.push({
                            ChatID: c.ChatID,
                            CreateAt: c.CreateAt,
                            DisplayName: c.DisplayName,
                            AvatarHash: c.ChatAva,
                            ChatType: c.ChatType,
                            hasU: c.HasUser
                        });
                        i = c.ChatID;
                        var h = c.UserID;
                        if (h) {
                            k.push({
                                UserID: c.UserID,
                                UserName: c.UserName,
                                AvatarHash: c.UserAva,
                                Mobile: c.Mobile
                            });
                            j = h;
                            g[c.ChatID] = c.UserName
                        }
                    } else {
                        var f = c.ChatID,
                            h = c.UserID;
                        if (!h) {
                            e.push({
                                ChatID: c.ChatID,
                                CreateAt: c.CreateAt,
                                DisplayName: c.DisplayName,
                                AvatarHash: c.ChatAva,
                                ChatType: c.ChatType,
                                hasU: c.HasUser
                            });
                            i = i.concat(',', f)
                        } else {
                            if (!f) {
                                k.push({
                                    UserID: c.UserID,
                                    UserName: c.UserName,
                                    AvatarHash: c.UserAva,
                                    Mobile: c.Mobile
                                })
                            } else {
                                var p = i.concat(','),
                                    q = f.concat(','),
                                    m = j.concat(','),
                                    n = h.concat(',');
                                if (p.indexOf(q) >= 0) {
                                    if (m.indexOf(n) < 0) {
                                        k.push({
                                            UserID: c.UserID,
                                            UserName: c.UserName,
                                            AvatarHash: c.UserAva,
                                            Mobile: c.Mobile
                                        });
                                        j = j.concat(',', h)
                                    }
                                    if (!g[f]) {
                                        g[f] = ''
                                    }
                                    g[f] = g[f].concat(',', c.UserName)
                                } else {
                                    e.push({
                                        ChatID: c.ChatID,
                                        CreateAt: c.CreateAt,
                                        DisplayName: c.DisplayName,
                                        AvatarHash: c.ChatAva,
                                        ChatType: c.ChatType,
                                        hasU: c.HasUser
                                    });
                                    i = i.concat(',', f);
                                    g[f] = c.UserName;
                                    if (m.indexOf(n) < 0) {
                                        k.push({
                                            UserID: c.UserID,
                                            UserName: c.UserName,
                                            AvatarHash: c.UserAva,
                                            Mobile: c.Mobile
                                        });
                                        j = j.concat(',', h)
                                    }
                                }
                            }
                        }
                    }
                }
                for (var d = 0; d < e.length; d++) {
                    if (e[d].hasU == 1) {
                        e[d].SenderName = g[e[d].ChatID]
                    }
                    if (e[d].ChatType == 'D') {
                        e.splice(d, 1);
                        d = d - 1
                    }
                }
            }
            if (b) {
                b(k, e)
            }
        })
    },
    searchMsgAgoDesc: function (d, b, a, c) {
        var e = 'SELECT MsgID,ChatID,MsgType,Content,CreateAt,SenderID,SenderName,MsgSeq,Status FROM IMMsg WHERE ChatID = ? AND CreateAt >= ? AND MsgType = ? AND ( INSTR(Content,?)>0 OR INSTR(SenderName,?)>0) ORDER BY CreateAt DESC ;';
        LocalDataMgr.cExecSqlWithP(e, [d, b, 'T', '' + a, '' + a], c)
    },
    searchMsgByDate: function (h, a, f) {
        var d = a.getFullYear(),
            b = a.getMonth(),
            c = a.getDate();
        var e = (new Date(d, b, c)).getTime(),
            g = (new Date(d, b, c + 1)).getTime();
        LocalSearchMgr.getTimeRangeHis(h, e, g, f)
    },
    getTimeRangeHis: function (d, b, c, a) {
        var e = 'SELECT M.MsgID,M.ChatID,M.MsgType,M.Content,M.CreateAt,M.SenderID,M.SenderName,M.MsgSeq,M.Status,F.FileID,F.BaseID FileBaseID,F.FilePath,F.FileType,F.FileName,F.MimeType,F.Width,F.Height,F.FileSize,F.Extension,F.FileStatus,F.HasPreview,L.BaseID LinkBaseID,L.Type,L.LinkObjType,L.LinkKeyString,L.LinkID,L.LinkTitle,L.LinkType,L.LinkOpUser,L.LinkDesc,L.LinkStr,L.LinkFromID,L.LinkStepID,L.LinkStepDesc,L.LinkStepStatus,L.LinkStatus,L.LinkStgGuid, B.BaseID BFileBaseID,B.BFileID,B.BFilePath,B.BFileName,B.BFileSize,B.BFileExtension,B.BFileStatus,B.CreateAt BCreateAt,B.ExpireAt FROM IMMsg M LEFT JOIN IMFile F ON M.ID = F.BaseID LEFT JOIN IMLink L ON M.ID = L.BaseID LEFT JOIN IMBFile B ON M.ID = B.BaseID WHERE M.ChatID = ? AND M.CreateAt >= ? AND M.CreateAt < ? ORDER BY M.CreateAt ASC LIMIT 20;';
        LocalDataMgr.cExecSqlWithP(e, [d, b, c], function (l, k) {
            var i = k.rows,
                j = i.length;
            var f, g;
            var h = [];
            if (j > 0) {
                for (var e = 0; e < j; e++) {
                    g = i.item(e);
                    if (e == 0) {
                        g.showDate = !0;
                        f = g
                    } else {
                        g.showDate = !1
                    }
                    h.push(i.item(e))
                }
                if (!f) {
                    f = h[j - 1]
                }
            }
            if (a) {
                a(h, f)
            }
        }, function (e) {})
    },
    getHistoryContext: function (c, a, b) {
        var d = 'SELECT M.MsgID,M.ChatID,M.MsgType,M.Content,M.CreateAt,M.SenderID,M.SenderName,M.MsgSeq,M.Status,M.ReplyCount,M.ReadCount,M.UnReadCount, F.FileID,F.BaseID FileBaseID,F.FilePath,F.FileType,F.FileName,F.MimeType,F.Width,F.Height,F.FileSize,F.Extension,F.FileStatus,F.HasPreview,L.BaseID LinkBaseID,L.Type,L.LinkObjType,L.LinkKeyString,L.LinkID,L.LinkTitle,L.LinkType,L.LinkOpUser,L.LinkDesc,L.LinkStr,L.LinkFromID,L.LinkStepID,L.LinkStepDesc,L.LinkStepStatus,L.LinkStatus,L.LinkStgGuid, B.BaseID BFileBaseID,B.BFileID,B.BFilePath,B.BFileName,B.BFileSize,B.BFileExtension,B.BFileStatus,B.CreateAt BCreateAt,B.ExpireAt FROM IMMsg M LEFT JOIN IMFile F ON M.ID = F.BaseID LEFT JOIN IMLink L ON M.ID = L.BaseID LEFT JOIN IMBFile B ON M.ID = B.BaseID WHERE M.ChatID = ? AND M.CreateAt < ? ORDER BY M.CreateAt DESC LIMIT 10;';
        LocalDataMgr.cExecSqlWithP(d, [c, a], function (h, f) {
            var e = f.rows,
                d;
            if (e.length > 0) {
                d = ParseUtil.parseLocalMsg(e)
            }
            var g = 'SELECT M.MsgID,M.ChatID,M.MsgType,M.Content,M.CreateAt,M.SenderID,M.SenderName,M.MsgSeq,M.Status,M.ReplyCount,M.ReadCount,M.UnReadCount, F.FileID,F.BaseID FileBaseID,F.FilePath,F.FileType,F.FileName,F.MimeType,F.Width,F.Height,F.FileSize,F.Extension,F.FileStatus,F.HasPreview,L.BaseID LinkBaseID,L.Type,L.LinkObjType,L.LinkKeyString,L.LinkID,L.LinkTitle,L.LinkType,L.LinkOpUser,L.LinkDesc,L.LinkStr,L.LinkFromID,L.LinkStepID,L.LinkStepDesc,L.LinkStepStatus,L.LinkStatus,L.LinkStgGuid, B.BaseID BFileBaseID,B.BFileID,B.BFilePath,B.BFileName,B.BFileSize,B.BFileExtension,B.BFileStatus,B.CreateAt BCreateAt,B.ExpireAt FROM IMMsg M LEFT JOIN IMFile F ON M.ID = F.BaseID LEFT JOIN IMLink L ON M.ID = L.BaseID LEFT JOIN IMBFile B ON M.ID = B.BaseID WHERE M.ChatID = ? AND M.CreateAt >= ? ORDER BY M.CreateAt ASC LIMIT 10;';
            h.executeSql(g, [c, a], function (k, g) {
                var j = g.rows,
                    e, i;
                if (j.length > 0) {
                    e = ParseUtil.parseLocalOrderedMsg(j);
                    i = e[0]
                }
                var g = d.concat(e);
                if (b) {
                    b(g, i)
                }
            })
        }, function (d) {})
    },
    getOldMsgWoNotShow: function (d, c, a, b) {
        var e = 'SELECT M.MsgID,M.ChatID,M.MsgType,M.Content,M.CreateAt,M.SenderID,M.SenderName,M.MsgSeq,M.Status,F.FileID,F.BaseID FileBaseID,F.FilePath,F.FileType,F.FileName,F.MimeType,F.Width,F.Height,F.FileSize,F.Extension,F.FileStatus,F.HasPreview,L.BaseID LinkBaseID,L.Type,L.LinkObjType,L.LinkKeyString,L.LinkID,L.LinkTitle,L.LinkType,L.LinkOpUser,L.LinkDesc,L.LinkStr,L.LinkFromID,L.LinkStepID,L.LinkStepDesc,L.LinkStepStatus,L.LinkStatus,L.LinkStgGuid, B.BaseID BFileBaseID,B.BFileID,B.BFilePath,B.BFileName,B.BFileSize,B.BFileExtension,B.BFileStatus,B.CreateAt BCreateAt,B.ExpireAt FROM IMMsg M LEFT JOIN IMFile F ON M.ID = F.BaseID LEFT JOIN IMLink L ON M.ID = L.BaseID LEFT JOIN IMBFile B ON M.ID = B.BaseID WHERE M.ChatID = ? AND M.CreateAt < ? AND INSTR(M.MsgType,?)<=0 ORDER BY M.CreateAt DESC LIMIT 20;';
        LocalDataMgr.cExecSqlWithP(e, [d, c, MsgType.NotShow], function (f, e) {
            if (a) {
                a(f, e)
            }
        }, function (f, e) {
            if (b) {
                b(e)
            }
        })
    },
    getMoreEndHisWoNotShow: function (d, c, a, b) {
        var e = 'SELECT M.MsgID,M.ChatID,M.MsgType,M.Content,M.CreateAt,M.SenderID,M.SenderName,M.MsgSeq,M.Status,F.FileID,F.BaseID FileBaseID,F.FilePath,F.FileType,F.FileName,F.MimeType,F.Width,F.Height,F.FileSize,F.Extension,F.FileStatus,F.HasPreview,L.BaseID LinkBaseID,L.Type,L.LinkObjType,L.LinkKeyString,L.LinkID,L.LinkTitle,L.LinkType,L.LinkOpUser,L.LinkDesc,L.LinkStr,L.LinkFromID,L.LinkStepID,L.LinkStepDesc,L.LinkStepStatus,L.LinkStatus,L.LinkStgGuid, B.BaseID BFileBaseID,B.BFileID,B.BFilePath,B.BFileName,B.BFileSize,B.BFileExtension,B.BFileStatus,B.CreateAt BCreateAt,B.ExpireAt FROM IMMsg M LEFT JOIN IMFile F ON M.ID = F.BaseID LEFT JOIN IMLink L ON M.ID = L.BaseID LEFT JOIN IMBFile B ON M.ID = B.BaseID WHERE M.ChatID = ? AND M.CreateAt > ? AND INSTR(M.MsgType,?)<=0 ORDER BY M.CreateAt ASC LIMIT 20;';
        LocalDataMgr.cExecSqlWithP(e, [d, c, MsgType.NotShow], function (f, e) {
            if (a) {
                a(f, e)
            }
        }, function (f, e) {
            if (b) {
                b(e)
            }
        })
    },
    getPicOrFile: function (c, b, a) {
        var d = 'SELECT M.MsgID,M.ChatID,M.MsgType,M.Content,M.CreateAt,M.SenderID,M.SenderName,M.MsgSeq,M.Status,F.FileID,F.BaseID FileBaseID,F.FilePath,F.FileType,F.FileName,F.MimeType,F.Width,F.Height,F.FileSize,F.Extension,F.FileStatus,F.HasPreview FROM IMMsg M LEFT JOIN IMFile F ON M.ID = F.BaseID WHERE M.ChatID = ? AND M.MsgType = ? ORDER BY M.CreateAt DESC LIMIT 50;';
        LocalDataMgr.cExecSqlWithP(d, [c, b], function (e, d) {
            if (a) {
                a(e, d)
            }
        }, function (d) {})
    },
    searchLastPic: function (b, a) {
        var c = 'SELECT FileID,BaseID,FilePath,FileType,FileName,MimeType,Width,Height,FileSize,Extension,FileStatus,HasPreview,CreateAt FROM IMFile WHERE FileType=? AND ChatID=? ORDER BY CreateAt DESC limit 50;';
        LocalDataMgr.cExecSqlWithP(c, ['I', b], function (d, c) {
            if (a) {
                a(d, c)
            }
        })
    },
    searchLastFile: function (b, a) {
        var c = 'SELECT FileID,BaseID,FilePath,FileType,FileName,MimeType,FileSize,Extension,FileStatus,CreateAt FROM IMFile WHERE FileType=? AND ChatID=? ORDER BY CreateAt DESC limit 50;';
        LocalDataMgr.cExecSqlWithP(c, ['F', b], function (d, c) {
            if (a) {
                a(d, c)
            }
        })
    },
    searchPicFromTime: function (c, b, a) {
        var d = 'SELECT FileID,BaseID,FilePath,FileType,FileName,MimeType,Width,Height,FileSize,Extension,FileStatus,HasPreview FROM IMFile WHERE CreateAt<? AND FileType=? AND ChatID=? ORDER BY CreateAt DESC limit 50;';
        LocalDataMgr.cExecSqlWithP(d, [b, 'I', c], function (e, d) {
            if (a) {
                a(e, d)
            }
        })
    },
    searchFileFromTime: function (c, b, a) {
        var d = 'SELECT FileID,BaseID,FilePath,FileType,FileName,MimeType,Width,Height,FileSize,Extension,FileStatus FROM IMFile WHERE CreateAt<? AND FileType=? AND ChatID=? ORDER BY CreateAt DESC limit 50;';
        LocalDataMgr.cExecSqlWithP(d, [b, 'F', c], function (e, d) {
            if (a) {
                a(e, d)
            }
        })
    },
    getCalendarDate: function (b, a) {
        var c = 'SELECT CreateAt FROM IMMsg WHERE INSTR(MsgType,?)<=0 AND ChatID=? ORDER BY CreateAt ASC;';
        LocalDataMgr.cExecSqlWithP(c, [MsgType.NotShow, b], function (h, g) {
            var d = g.rows,
                f = d.length;
            var e = [];
            if (f > 0) {
                for (var c = 0; c < f; c++) {
                    if (c == 0) {
                        e.push(new Date(d.item(c).CreateAt))
                    } else {
                        if (!ParseUtil.inOneDay(d.item(c).CreateAt, d.item(c - 1).CreateAt)) {
                            e.push(new Date(d.item(c).CreateAt))
                        }
                    }
                }
            }
            a.setSpecialDates(e)
        })
    },
    getShowWhenCalendarDate: function (c, b, a) {
        var d = 'SELECT CreateAt FROM IMMsg WHERE INSTR(MsgType,?)<=0 AND ChatID=? AND CreateAt <? ORDER BY CreateAt ASC;';
        LocalDataMgr.cExecSqlWithP(d, [MsgType.NotShow, c, b], function (i, h) {
            var e = h.rows,
                g = e.length;
            var f = [];
            if (g > 0) {
                for (var d = 0; d < g; d++) {
                    if (d == 0) {
                        f.push(new Date(e.item(d).CreateAt))
                    } else {
                        if (!ParseUtil.inOneDay(e.item(d).CreateAt, e.item(d - 1).CreateAt)) {
                            f.push(new Date(e.item(d).CreateAt))
                        }
                    }
                }
            }
            a.setSpecialDates(f)
        })
    },
    addSqlLimit: function (a, c, b) {
        if (c && typeof c === 'number') {
            if (!b || typeof b !== 'number') {
                b = 50
            }
            if (/;$/.test(a)) {
                a = a.replace(/;$/g, '')
            }
            a = a + ' LIMIT ' + c + ',' + b
        }
        return a
    },
    getChat: function (a) {
        var b = 'SELECT DISTINCT T.ChatID, T1.DisplayName,T1.ChatType,T1.CreateAt,T1.UserIDs,T1.Status FROM IMChat T1 JOIN IMMsg T On T.ChatID = T1.ChatID WHERE T1.Status != ? ORDER BY T.CreateAt DESC LIMIT 200';
        LocalDataMgr.cExecSqlWithP(b, ['1'], function (c, b) {
            if (a) {
                a(c, b)
            }
        })
    },
    getChat1: function (c, a, b) {
        var d = 'SELECT DISTINCT T.ChatID, T1.DisplayName,T1.ChatType,T1.CreateAt,T1.UserIDs,T1.Status FROM IMChat T1 JOIN IMMsg T On T.ChatID = T1.ChatID WHERE T1.Status != ? ORDER BY T.CreateAt DESC LIMIT ' + c * a + ',' + a;
        LocalDataMgr.cExecSqlWithP(d, ['1'], function (e, d) {
            if (b) {
                b(e, d)
            }
        })
    },
    searchPtcp: function (b, c, e, d) {
        var a = 'SELECT DISTINCT T.ChatID, T1.DisplayName,T1.CreateAt,T1.ChatType,T1.UserIDs,T1.Status FROM IMChat T1 JOIN IMMsg T On T.ChatID = T1.ChatID LEFT JOIN IMUsr T2 On T.SenderID = T2.UserID WHERE INStr(T.SenderID, ?)>0 Or INStr(T.SenderName, ?)>0 Or INStr(T2.Mobile, ?)>0 ORDER BY T.CreateAt DESC ';
        a = this.addSqlLimit(a, e, d);
        LocalDataMgr.cExecSqlWithP(a, ['' + b, '' + b, '' + b], function (f, a) {
            if (c) {
                c(f, a)
            }
        })
    },
    searchPtcp1: function (d, b, a, c) {
        var e = 'SELECT DISTINCT T.ChatID, T1.DisplayName,T1.CreateAt,T1.ChatType,T1.UserIDs,T1.Status FROM IMChat T1 JOIN IMMsg T On T.ChatID = T1.ChatID LEFT JOIN IMUsr T2 On T.SenderID = T2.UserID WHERE INStr(T.SenderID, ?)>0 Or INStr(T.SenderName, ?)>0 Or INStr(T2.Mobile, ?)>0 ORDER BY T.CreateAt DESC limit ' + d * b + ', ' + b + ';';
        LocalDataMgr.cExecSqlWithP(e, ['' + a, '' + a, '' + a], function (f, e) {
            if (c) {
                c(f, e)
            }
        })
    },
    searchGN: function (e, a, d, c) {
        var b = this;
        LocalDataMgr.getDB().transaction(function (g) {
            var f = 'Select Distinct T.ChatID, T1.DisplayName,T1.ChatType,T1.CreateAt,T1.UserIDs,T1.Status From IMChat T1 Join IMMsg T On T.ChatID = T1.ChatID Where INSTR(T1.DisplayName,?)>0 AND T1.Status != ? Order By T.CreateAt DESC ';
            f = b.addSqlLimit(f, d, c);
            g.executeSql(f, ['' + e, '1'], function (f, b) {
                if (a) {
                    a(f, b)
                }
            })
        })
    },
    searchGN1: function (c, a, d, b) {
        LocalDataMgr.getDB().transaction(function (e) {
            var f = 'Select Distinct T.ChatID, T1.DisplayName,T1.ChatType,T1.CreateAt,T1.UserIDs,T1.Status From IMChat T1 Join IMMsg T On T.ChatID = T1.ChatID Where INSTR(T1.DisplayName,?)>0 AND T1.Status != ? Order By T.CreateAt DESC Limit ?,?';
            e.executeSql(f, ['' + d, '1', c * a, a], function (g, f) {
                if (b) {
                    b(g, f)
                }
            })
        })
    },
    searchCR: function (d, b) {
        var a = Ext.Date.add(new Date(), Ext.Date.DAY, -7).getTime();
        var c = 'SELECT C.DisplayName,C.CreateAt ChatCreateAt,C.UserIDs,C.ChatType,C.Status,M.MsgID,M.ChatID,M.MsgType,M.Content,M.CreateAt,M.SenderID,M.SenderName,M.MsgSeq FROM IMMsg M JOIN IMChat C ON M.ChatID=C.ChatID WHERE M.MsgType=? AND INSTR(M.Content,?)>0 AND M.CreateAt>? ORDER BY M.CreateAt DESC;';
        LocalDataMgr.cExecSqlWithP(c, ['T', '' + d, a], b)
    },
    searchChatName: function (e, c, d, b) {
        var a = 'SELECT C.ChatID,C.DisplayName,C.CreateAt,C.UserIDs,C.ChatType,C.Status,M.Counts FROM IMChat C JOIN ( SELECT ChatID,MAX(CreateAt) CreateAt,COUNT(CreateAt) Counts FROM IMMsg WHERE MsgType=? AND INSTR(Content,?)>0 GROUP BY ChatID ) M ON C.ChatID = M.ChatID Where M.Counts >0 ORDER BY M.CreateAt DESC ';
        a = this.addSqlLimit(a, d, b);
        LocalDataMgr.cExecSqlWithP(a, ['T', '' + e], c)
    },
    searchChatName1: function (c, a, e, b) {
        var d = 'SELECT C.ChatID,C.DisplayName,C.CreateAt,C.UserIDs,C.ChatType,C.Status,M.Counts FROM IMChat C JOIN ( SELECT ChatID,MAX(CreateAt) CreateAt,COUNT(CreateAt) Counts FROM IMMsg WHERE MsgType=? AND INSTR(Content,?)>0 GROUP BY ChatID ) M ON C.ChatID = M.ChatID Where M.Counts >0 ORDER BY M.CreateAt DESC Limit ?,?;';
        LocalDataMgr.cExecSqlWithP(d, ['T', '' + e, c * a, a], b)
    },
    searchChatContent: function (e, f, c, d, b) {
        var a = 'SELECT MsgID,ChatID,MsgType,Content,CreateAt,SenderID,SenderName,MsgSeq,Status FROM IMMsg WHERE ChatID = ? AND MsgType=? AND INSTR(Content,?)>0 ORDER BY CreateAt DESC ';
        a = this.addSqlLimit(a, d, b);
        LocalDataMgr.cExecSqlWithP(a, [e, 'T', '' + f], c)
    },
    searchFileContent: function (e, f, c, d, b) {
        var a = 'SELECT M.*,F.FileName,F.FileStatus,F.FileSize FROM ( SELECT ID,MsgID,ChatID,MsgType,Content,CreateAt,SenderID,SenderName,MsgSeq FROM IMMsg WHERE ChatID = ? ) M JOIN IMFile F ON M.ID = F.BaseID WHERE F.FileType=? AND INSTR(F.FileName,?)>0 ORDER BY M.CreateAt DESC ';
        a = this.addSqlLimit(a, d, b);
        LocalDataMgr.cExecSqlWithP(a, [e, 'F', '' + f], c)
    },
    searchFile: function (e, c, d, b) {
        var a = 'SELECT C.ChatID,C.DisplayName,C.CreateAt,C.UserIDs,C.ChatType,C.Status,F.Counts FROM IMChat C JOIN ( SELECT ChatID,MAX(CreateAt) CreateAt FROM IMMsg GROUP BY ChatID ) M ON C.ChatID = M.ChatID JOIN ( SELECT ChatID,COUNT(CreateAt) Counts FROM IMFile WHERE FileType=? AND INSTR(FileName,?)>0 GROUP BY ChatID ) F ON M.ChatID = F.ChatID ORDER BY M.CreateAt DESC ';
        a = this.addSqlLimit(a, d, b);
        LocalDataMgr.cExecSqlWithP(a, ['F', '' + e], c)
    },
    searchChatByTime: function (e, c, d, b) {
        var a = 'SELECT C.ChatID,C.DisplayName,C.CreateAt,C.ChatType,C.UserIDs,C.Status FROM IMChat C Join (SELECT DISTINCT ChatID FROM IMMsg WHERE CreateAt>? ORDER BY CreateAt DESC LIMIT 50) M On C.ChatID = M.ChatID ';
        a = this.addSqlLimit(a, d, b);
        LocalDataMgr.cExecSqlWithP(a, [e], c)
    },
    searchChatByTime1: function (c, a, d, b) {
        var e = 'SELECT C.ChatID,C.DisplayName,C.CreateAt,C.ChatType,C.UserIDs,C.Status FROM IMChat C Join (SELECT DISTINCT ChatID FROM IMMsg WHERE CreateAt>? ORDER BY CreateAt DESC LIMIT 50) M On C.ChatID = M.ChatID Limit ?,?;';
        LocalDataMgr.cExecSqlWithP(e, [d, c, a], b)
    },
    doAdvSearch: function (e, n, m, o, l) {
        if (e.sql) {
            var r = 'SELECT C.ChatID,C.DisplayName,M.Counts,C.CreateAt,C.UserIDs,C.ChatType,C.Status FROM IMChat C JOIN ( SELECT ChatID,MAX(CreateAt) CreateAt,COUNT(CreateAt) Counts FROM IMMsg M ';
            var p = ' ORDER BY M.CreateAt DESC ';
            var c = e.sql,
                b = e.val;
            var i = '',
                j = '',
                f = [];
            for (var a = 0; a < c.length; a++) {
                if (c[a].indexOf('C.DisplayName') >= 0) {
                    j = 'WHERE ' + c[a];
                    c.splice(a, 1);
                    f.push(b[a]);
                    b.splice(a, 1);
                    break
                }
            }
            i = 'WHERE ' + c.join(' AND ');
            var q = ' GROUP BY ChatID) M ON C.ChatID = M.ChatID ';
            var h = r + i + q + j + p;
            h = this.addSqlLimit(h, o, l);
            var d = [];
            for (var a = 0; a < b.length; a++) {
                if (Ext.isNumber(b[a])) {
                    d.push(b[a])
                } else {
                    var k = b[a].split(',');
                    for (var g = 0; g < k.length; g++) {
                        d.push(k[g])
                    }
                }
            }
            if (f[0]) {
                d.push(f[0])
            }
            LocalDataMgr.cExecSqlWithP(h, d, n, m)
        }
    },
    doAdvSearch1: function (o, h, e, m, l) {
        if (e.sql) {
            var q = 'SELECT C.ChatID,C.DisplayName,M.Counts,C.CreateAt,C.UserIDs,C.ChatType,C.Status FROM IMChat C JOIN ( SELECT ChatID,MAX(CreateAt) CreateAt,COUNT(CreateAt) Counts FROM IMMsg M ';
            var n = ' ORDER BY M.CreateAt DESC';
            var c = e.sql,
                b = e.val;
            var i = '',
                j = '',
                f = [];
            for (var a = 0; a < c.length; a++) {
                if (c[a].indexOf('C.DisplayName') >= 0) {
                    j = 'WHERE ' + c[a];
                    c.splice(a, 1);
                    f.push(b[a]);
                    b.splice(a, 1);
                    break
                }
            }
            i = 'WHERE ' + c.join(' AND ');
            var p = ' GROUP BY ChatID) M ON C.ChatID = M.ChatID ';
            var r = q + i + p + j + n + (' Limit ' + o * h + ', ' + h);
            var d = [];
            for (var a = 0; a < b.length; a++) {
                if (Ext.isNumber(b[a])) {
                    d.push(b[a])
                } else {
                    var k = b[a].split(',');
                    for (var g = 0; g < k.length; g++) {
                        d.push(k[g])
                    }
                }
            }
            if (f[0]) {
                d.push(f[0])
            }
            LocalDataMgr.cExecSqlWithP(r, d, m, l)
        }
    },
    doAdvSearchContent: function (o, g, k, j, l, i) {
        var p = 'SELECT M.MsgID,M.ChatID,M.MsgType,M.Content,M.CreateAt,M.SenderID,M.SenderName,M.MsgSeq,M.Status FROM IMMsg M ';
        var m = ' ORDER BY M.CreateAt DESC ';
        var c = g.sql,
            b = g.val;
        for (var a = 0; a < c.length; a++) {
            if (c[a].indexOf('C.DisplayName') >= 0) {
                c.splice(a, 1);
                b.splice(a, 1);
                break
            }
        }
        var n = 'WHERE M.ChatID =? AND ' + c.join(' AND ');
        var f = p + n + m;
        f = this.addSqlLimit(f, l, i);
        var d = [];
        d.push(o);
        for (var a = 0; a < b.length; a++) {
            if (Ext.isNumber(b[a])) {
                d.push(b[a])
            } else {
                var h = b[a].split(',');
                for (var e = 0; e < h.length; e++) {
                    d.push(h[e])
                }
            }
        }
        LocalDataMgr.cExecSqlWithP(f, d, k, j)
    },
    searchMsgContext: function (c, a, f, e, b) {
        var d = this;
        LocalDataMgr.getDB().transaction(function (g) {
            var h = 'SELECT M.MsgID,M.ChatID,M.MsgType,M.Content,M.CreateAt,M.SenderID,M.SenderName,M.MsgSeq,M.Status,F.FileID,F.BaseID FileBaseID,F.FilePath,F.FileType,F.FileName,F.MimeType,F.Width,F.Height,F.FileSize,F.Extension,F.FileStatus,F.HasPreview,L.BaseID LinkBaseID,L.Type,L.LinkObjType,L.LinkKeyString,L.LinkID,L.LinkTitle,L.LinkType,L.LinkOpUser,L.LinkDesc,L.LinkStr,L.LinkFromID,L.LinkStepID,L.LinkStepDesc,L.LinkStepStatus,L.LinkStatus,L.LinkStgGuid, B.BaseID BFileBaseID,B.BFileID,B.BFilePath,B.BFileName,B.BFileSize,B.BFileExtension,B.BFileStatus,B.CreateAt BCreateAt,B.ExpireAt FROM IMMsg M LEFT JOIN IMFile F ON M.ID = F.BaseID LEFT JOIN IMLink L ON M.ID = L.BaseID LEFT JOIN IMBFile B ON M.ID = B.BaseID WHERE M.ChatID=? AND M.CreateAt<=? ORDER BY M.CreateAt DESC LIMIT 10;';
            g.executeSql(h, [c, parseInt(a, 10)], function (n, k) {
                var i = k.rows,
                    h = [];
                var l = i.item(0);
                for (var j = i.length - 1; j >= 0; j--) {
                    var o = i.item(j);
                    h.push(d.getStoreMsgData(o, e))
                }
                var m = 'SELECT M.MsgID,M.ChatID,M.MsgType,M.Content,M.CreateAt,M.SenderID,M.SenderName,M.MsgSeq,M.Status,F.FileID,F.BaseID FileBaseID,F.FilePath,F.FileType,F.FileName,F.MimeType,F.Width,F.Height,F.FileSize,F.Extension,F.FileStatus,F.HasPreview,L.BaseID LinkBaseID,L.Type,L.LinkObjType,L.LinkKeyString,L.LinkID,L.LinkTitle,L.LinkType,L.LinkOpUser,L.LinkDesc,L.LinkStr,L.LinkFromID,L.LinkStepID,L.LinkStepDesc,L.LinkStepStatus,L.LinkStatus,L.LinkStgGuid, B.BaseID BFileBaseID,B.BFileID,B.BFilePath,B.BFileName,B.BFileSize,B.BFileExtension,B.BFileStatus,B.CreateAt BCreateAt,B.ExpireAt FROM IMMsg M LEFT JOIN IMFile F ON M.ID = F.BaseID LEFT JOIN IMLink L ON M.ID = L.BaseID LEFT JOIN IMBFile B ON M.ID = B.BaseID WHERE M.ChatID=? AND M.CreateAt>? ORDER BY M.CreateAt LIMIT 10;';
                n.executeSql(m, [c, parseInt(a, 10)], function (p, o) {
                    var j = o.rows;
                    for (var i = 0; i < j.length; i++) {
                        var m = j.item(i);
                        h.push(d.getStoreMsgData(m, e))
                    }
                    if (b) {
                        b(h, l)
                    }
                })
            })
        })
    },
    searchLastMsg: function (b, a) {
        LocalDataMgr.getDB().transaction(function (c) {
            var d = 'SELECT M.MsgID,M.ChatID,M.MsgType,M.Content,M.CreateAt,M.SenderID,M.SenderName,M.MsgSeq,M.Status,F.FileID,F.BaseID FileBaseID,F.FilePath,F.FileType,F.FileName,F.MimeType,F.Width,F.Height,F.FileSize,F.Extension,F.FileStatus,F.HasPreview,L.BaseID LinkBaseID,L.Type,L.LinkObjType,L.LinkKeyString,L.LinkID,L.LinkTitle,L.LinkType,L.LinkOpUser,L.LinkDesc,L.LinkStr,L.LinkFromID,L.LinkStepID,L.LinkStepDesc,L.LinkStepStatus,L.LinkStatus,L.LinkStgGuid, B.BaseID BFileBaseID,B.BFileID,B.BFilePath,B.BFileName,B.BFileSize,B.BFileExtension,B.BFileStatus,B.CreateAt BCreateAt,B.ExpireAt FROM IMMsg M LEFT JOIN IMFile F ON M.ID = F.BaseID LEFT JOIN IMLink L ON M.ID = L.BaseID LEFT JOIN IMBFile B ON M.ID = B.BaseID WHERE M.ChatID=? ORDER BY M.CreateAt DESC limit 20;';
            c.executeSql(d, [b], function (e, d) {
                if (a) {
                    a(e, d)
                }
            })
        })
    },
    getStoreMsgData: function (a, b) {
        return {
            chatID: a.ChatID,
            msgID: a.MsgID,
            updateTime: a.CreateAt,
            SenderID: a.SenderID,
            senderName: a.SenderName,
            content: a.Content,
            msgType: a.MsgType,
            width: a.Width,
            height: a.Height,
            fileName: a.FileName,
            fileSize: a.FileSize,
            filePath: a.FilePath,
            highlightWord: b,
            linkObjType: a.LinkObjType,
            linkTitle: a.LinkTitle,
            linkType: a.LinkType,
            linkStgGuid: a.LinkStgGuid,
            linkKeyString: a.LinkKeyString,
            status: a.Status,
            extension: a.Extension,
            fileID: a.FileID,
            hasPreview: !0,
            BFileSize: a.BFileSize,
            BFileName: a.BFileName,
            BFilePath: a.BFilePath
        }
    },
    getLastHisByTime: function (c, b, a) {
        var d = 'SELECT M.MsgID,M.ChatID,M.MsgType,M.Content,M.CreateAt,M.SenderID,M.SenderName,M.MsgSeq,M.Status,F.FileID,F.BaseID FileBaseID,F.FilePath,F.FileType,F.FileName,F.MimeType,F.Width,F.Height,F.FileSize,F.Extension,F.FileStatus,F.HasPreview,L.BaseID LinkBaseID,L.Type,L.LinkObjType,L.LinkKeyString,L.LinkID,L.LinkTitle,L.LinkType,L.LinkOpUser,L.LinkDesc,L.LinkStr,L.LinkFromID,L.LinkStepID,L.LinkStepDesc,L.LinkStepStatus,L.LinkStatus,L.LinkStgGuid, B.BaseID BFileBaseID,B.BFileID,B.BFilePath,B.BFileName,B.BFileSize,B.BFileExtension,B.BFileStatus,B.CreateAt BCreateAt,B.ExpireAt FROM IMMsg M LEFT JOIN IMFile F ON M.ID = F.BaseID LEFT JOIN IMLink L ON M.ID = L.BaseID LEFT JOIN IMBFile B ON M.ID = B.BaseID WHERE M.ChatID = ? AND M.CreateAt >= ? ORDER BY M.CreateAt ASC LIMIT ?;';
        LocalDataMgr.cExecSqlWithP(d, [c, b, ConfigMgr.msgCountInOnePage], function (h, g) {
            var e = g.rows;
            if (e.rows <= 0) {
                return
            }
            var d = ParseUtil.parseLocalOrderedMsg(e),
                f = d[0];
            if (a) {
                a(d, f)
            }
        })
    },
    searchLastReplyByCid: function (b, a) {
        var c = 'SELECT R.Content As RContent,R.CreateAt AS RCreateAt,M1.* FROM (SELECT M.*,\n            F.ID FID,F.FileID,F.BaseID FileBaseID,F.FilePath,F.CreateAt FileCreateAt,F.FileType,F.FileName,F.MimeType,F.Width,F.Height,F.FileSize,F.Extension,F.FileStatus,F.HasPreview,\n            L.ID LID,L.BaseID LinkBaseID,L.Type,L.LinkObjType,L.LinkKeyString,L.LinkID,L.LinkTitle,L.LinkType,L.LinkOpUser,L.LinkDesc,L.LinkStr,L.LinkFromID,L.LinkStepID,L.LinkStepDesc,L.LinkStepStatus,L.LinkStatus,L.LinkStgGuid,\n            B.BFileID,B.BFilePath,B.BFileName,B.BFileSize,B.BFileExtension,B.BFileStatus,B.ExpireAt,B.IsHiddenInForm \n            FROM \n            (SELECT * FROM IMMsg WHERE ChatID=? AND ReplyCount>0) M \n            LEFT JOIN IMFile F ON M.ID=F.BaseID \n            LEFT JOIN IMLink L ON M.ID=L.BaseID \n            LEFT JOIN IMBFile B ON M.ID=B.BaseID) M1 \n            JOIN IMReply R ON R.RootID=M1.MsgID ORDER BY R.CreateAt DESC;';
        LocalDataMgr.cExecSqlWithP(c, [b], a)
    },
    searchLastFileByFileMgr: function (c, b, a) {
        var e = "SELECT F.*,C.DisplayName,C.ChatType,M.SenderName,M.MsgID FROM IMFile F\n                    LEFT JOIN IMChat C ON F.ChatID=C.ChatID\n                    LEFT JOIN IMMsg M ON F.BaseID=M.ID\n                    WHERE F.DeleteAt=0 AND F.CreateAt >? AND F.FileType='F'";
        var d = e + b;
        LocalDataMgr.cExecSqlWithP(d, [c], function (e, d) {
            if (a) {
                a(e, d)
            }
        })
    },
    searchLastFileByFileMgrIsPicFromTime: function (c, d, b, a) {
        var f = "SELECT F.*,C.DisplayName,C.ChatType,M.SenderName,M.MsgID FROM IMFile F\n                    LEFT JOIN IMChat C ON F.ChatID=C.ChatID\n                    LEFT JOIN IMMsg M ON F.BaseID=M.ID\n                    WHERE F.CreateAt<? AND F.DeleteAt=0 AND F.CreateAt >? AND F.FileType='F'";
        var e = f + b;
        LocalDataMgr.cExecSqlWithP(e, [d, c], function (f, e) {
            if (a) {
                a(f, e)
            }
        })
    },
    searchLastFileByWorkDeskFileMgr: function (c, b, a) {
        var e = 'SELECT W.* FROM IMWFile W\n                    WHERE W.DeleteAt=0 AND W.CreateAt >?';
        var d = e + b;
        LocalDataMgr.cExecSqlWithP(d, [c], function (e, d) {
            if (a) {
                a(e, d)
            }
        })
    },
    searchLastFileByWorkDeskFileMgrFromTime: function (c, d, b, a) {
        var f = 'SELECT W.* FROM IMWFile W\n                    WHERE W.DeleteAt=0 AND W.CreateAt<? AND W.CreateAt >?';
        var e = f + b;
        LocalDataMgr.cExecSqlWithP(e, [d, c], function (f, e) {
            if (a) {
                a(f, e)
            }
        })
    },
    searchLastFileByFileMgrIsPic: function (c, b, a) {
        var e = "SELECT F.*,C.DisplayName,C.ChatType,M.SenderName,M.MsgID FROM IMFile F\n                    LEFT JOIN IMChat C ON F.ChatID=C.ChatID\n                    LEFT JOIN IMMsg M ON F.BaseID=M.ID\n                    WHERE F.DeleteAt=0 AND F.Extension  IN('jpg','jpeg','gif','png','bmp','webp') AND F.CreateAt >? AND F.FileType='F'";
        var d = e + b;
        LocalDataMgr.cExecSqlWithP(d, [c], function (e, d) {
            if (a) {
                a(e, d)
            }
        })
    },
    searchLastFileByFileMgrHasPicFromTime: function (c, d, b, a) {
        var f = "SELECT F.*,C.DisplayName,C.ChatType,M.SenderName,M.MsgID FROM IMFile F\n                    LEFT JOIN IMChat C ON F.ChatID=C.ChatID\n                    LEFT JOIN IMMsg M ON F.BaseID=M.ID\n                    WHERE F.DeleteAt=0 AND F.Extension  IN('jpg','jpeg','gif','png','bmp','webp') AND F.CreateAt<? AND F.CreateAt >? AND F.FileType='F'";
        var e = f + b;
        LocalDataMgr.cExecSqlWithP(e, [d, c], function (f, e) {
            if (a) {
                a(f, e)
            }
        })
    },
    searchLastFileByWorkDeskFileMgrIsPic: function (c, b, a) {
        var e = "SELECT W.* FROM IMWFile W\n                    WHERE W.DeleteAt=0 AND W.Extension  IN('jpg','jpeg','gif','png','bmp','webp') AND W.CreateAt >?";
        var d = e + b;
        LocalDataMgr.cExecSqlWithP(d, [c], function (e, d) {
            if (a) {
                a(e, d)
            }
        })
    },
    searchLastFileByWorkDeskFileMgrIsPicFromTime: function (c, d, b, a) {
        var f = "SELECT W.* FROM IMWFile W\n                    WHERE W.DeleteAt=0 AND W.CreateAt<? AND W.Extension  IN('jpg','jpeg','gif','png','bmp','webp') AND W.CreateAt >?";
        var e = f + b;
        LocalDataMgr.cExecSqlWithP(e, [d, c], function (f, e) {
            if (a) {
                a(f, e)
            }
        })
    },
    searchLastFileByFileMgrIsNoPic: function (c, b, a) {
        var e = "SELECT F.*,C.DisplayName,C.ChatType,M.SenderName,M.MsgID FROM IMFile F\n                    LEFT JOIN IMChat C ON F.ChatID=C.ChatID\n                    LEFT JOIN IMMsg M ON F.BaseID=M.ID\n                    WHERE F.DeleteAt=0 AND  F.Extension IN('doc','docx','ppt','pptx','xls','xlsx','txt','rtf','pdf') AND F.CreateAt >? AND F.FileType='F'";
        var d = e + b;
        LocalDataMgr.cExecSqlWithP(d, [c], function (e, d) {
            if (a) {
                a(e, d)
            }
        })
    },
    searchLastFileByFileMgrHasNoPicFromTime: function (c, d, b, a) {
        var f = "SELECT F.*,C.DisplayName,C.ChatType,M.SenderName,M.MsgID FROM IMFile F\n                    LEFT JOIN IMChat C ON F.ChatID=C.ChatID\n                    LEFT JOIN IMMsg M ON F.BaseID=M.ID\n                    WHERE F.DeleteAt=0 AND F.Extension IN('doc','docx','ppt','pptx','xls','xlsx','txt','rtf','pdf') AND F.CreateAt<? AND F.CreateAt >? AND F.FileType='F'";
        var e = f + b;
        LocalDataMgr.cExecSqlWithP(e, [d, c], function (f, e) {
            if (a) {
                a(f, e)
            }
        })
    },
    searchLastFileByWorkDeskFileMgrIsNoPic: function (c, b, a) {
        var e = "SELECT W.* FROM IMWFile W\n                    WHERE W.DeleteAt=0 AND W.Extension IN('doc','docx','ppt','pptx','xls','xlsx','txt','rtf','pdf') AND W.CreateAt >?";
        var d = e + b;
        LocalDataMgr.cExecSqlWithP(d, [c], function (e, d) {
            if (a) {
                a(e, d)
            }
        })
    },
    searchLastFileByWorkDeskFileMgrIsNoPicFromTime: function (c, d, b, a) {
        var f = "SELECT W.* FROM IMWFile W\n                    WHERE W.DeleteAt=0 AND W.CreateAt<? AND W.Extension IN('doc','docx','ppt','pptx','xls','xlsx','txt','rtf','pdf') AND W.CreateAt >?";
        var e = f + b;
        LocalDataMgr.cExecSqlWithP(e, [d, c], function (f, e) {
            if (a) {
                a(f, e)
            }
        })
    },
    searchPCByFileList: function (c, b, a, d) {
        var f = "SELECT F.*,C.DisplayName,C.ChatType,M.SenderName,M.MsgID FROM IMFile F\n                    LEFT JOIN IMChat C ON F.ChatID=C.ChatID\n                    LEFT JOIN IMMsg M ON F.BaseID=M.ID\n                WHERE F.DeleteAt=0 And (M.SenderID like ? Or M.SenderName like ? Or C.DisplayName like ? Or F.FileName like ?) AND F.CreateAt >? AND F.FileType='F'";
        var e = f + b;
        LocalDataMgr.cExecSqlWithP(e, ['%' + a + '%', '%' + a + '%', '%' + a + '%', '%' + a + '%', c], d)
    },
    searchPCByFileListIsNoPic: function (c, b, a, d) {
        var f = "SELECT F.*,C.DisplayName,C.ChatType,M.SenderName,M.MsgID FROM IMFile F\n                    LEFT JOIN IMChat C ON F.ChatID=C.ChatID\n                    LEFT JOIN IMMsg M ON F.BaseID=M.ID\n                WHERE F.DeleteAt=0 And (M.SenderID like ? Or M.SenderName like ? Or C.DisplayName like ? Or F.FileName like ?) AND F.CreateAt >? AND F.Extension IN('doc','docx','ppt','pptx','xls','xlsx','txt','rtf','pdf') AND F.FileType='F'";
        var e = f + b;
        LocalDataMgr.cExecSqlWithP(e, ['%' + a + '%', '%' + a + '%', '%' + a + '%', '%' + a + '%', c], d)
    },
    searchPCByFileListIsPic: function (c, b, a, d) {
        var f = "SELECT F.*,C.DisplayName,C.ChatType,M.SenderName,M.MsgID FROM IMFile F\n                    LEFT JOIN IMChat C ON F.ChatID=C.ChatID\n                    LEFT JOIN IMMsg M ON F.BaseID=M.ID\n                WHERE F.DeleteAt=0 And (M.SenderID like ? Or M.SenderName like ? Or C.DisplayName like ? Or F.FileName like ?) AND F.CreateAt >? AND F.Extension IN('jpg','jpeg','gif','png','bmp','webp') AND F.FileType='F'";
        var e = f + b;
        LocalDataMgr.cExecSqlWithP(e, ['%' + a + '%', '%' + a + '%', '%' + a + '%', '%' + a + '%', c], d)
    },
    searchPCByFileListmore: function (c, e, b, a, d) {
        var g = "SELECT F.*,C.DisplayName,C.ChatType,M.SenderName,M.MsgID FROM IMFile F\n                    LEFT JOIN IMChat C ON F.ChatID=C.ChatID\n                    LEFT JOIN IMMsg M ON F.BaseID=M.ID\n                WHERE F.DeleteAt=0 And (M.SenderID like ? Or M.SenderName like ? Or C.DisplayName like ? Or F.FileName like ?) AND F.CreateAt >? AND F.CreateAt<? AND F.FileType='F'";
        var f = g + b;
        LocalDataMgr.cExecSqlWithP(f, ['%' + a + '%', '%' + a + '%', '%' + a + '%', '%' + a + '%', c, e], d)
    },
    searchPCByFileListIsNoPicmore: function (c, e, b, a, d) {
        var g = "SELECT F.*,C.DisplayName,C.ChatType,M.SenderName,M.MsgID FROM IMFile F\n                    LEFT JOIN IMChat C ON F.ChatID=C.ChatID\n                    LEFT JOIN IMMsg M ON F.BaseID=M.ID\n                WHERE F.DeleteAt=0 And (M.SenderID like ? Or M.SenderName like ? Or C.DisplayName like ? Or F.FileName like ?) AND F.CreateAt >? AND F.Extension IN('doc','docx','ppt','pptx','xls','xlsx','txt','rtf','pdf') AND F.CreateAt<? AND F.FileType='F'";
        var f = g + b;
        LocalDataMgr.cExecSqlWithP(f, ['%' + a + '%', '%' + a + '%', '%' + a + '%', '%' + a + '%', c, e], d)
    },
    searchPCByFileListIsPicmore: function (c, e, b, a, d) {
        var g = "SELECT F.*,C.DisplayName,C.ChatType,M.SenderName,M.MsgID FROM IMFile F\n                    LEFT JOIN IMChat C ON F.ChatID=C.ChatID\n                    LEFT JOIN IMMsg M ON F.BaseID=M.ID\n                WHERE F.DeleteAt=0 And (M.SenderID like ? Or M.SenderName like ? Or C.DisplayName like ? Or F.FileName like ?) AND F.CreateAt >? AND F.Extension IN('jpg','jpeg','gif','png','bmp','webp') AND F.CreateAt<? AND F.FileType='F'";
        var f = g + b;
        LocalDataMgr.cExecSqlWithP(f, ['%' + a + '%', '%' + a + '%', '%' + a + '%', '%' + a + '%', c, e], d)
    },
    searchPCByWorkList: function (c, b, f, a) {
        var e = 'SELECT W.* FROM IMWFile W\n                    WHERE W.DeleteAt=0 And W.FileName like ? AND W.CreateAt >?';
        var d = e + b;
        LocalDataMgr.cExecSqlWithP(d, ['%' + f + '%', c], function (e, d) {
            if (a) {
                a(e, d)
            }
        })
    },
    searchPCByWorkListISPic: function (c, b, f, a) {
        var e = "SELECT W.* FROM IMWFile W\n                    WHERE W.DeleteAt=0 And W.FileName like ? AND W.CreateAt >? AND W.Extension IN('jpg','jpeg','gif','png','bmp','webp')";
        var d = e + b;
        LocalDataMgr.cExecSqlWithP(d, ['%' + f + '%', c], function (e, d) {
            if (a) {
                a(e, d)
            }
        })
    },
    searchPCByWorkListISNotPic: function (c, b, f, a) {
        var e = "SELECT W.* FROM IMWFile W\n                    WHERE W.DeleteAt=0 And W.FileName like ? AND W.CreateAt >? AND W.Extension IN('doc','docx','ppt','pptx','xls','xlsx','txt','rtf','pdf')";
        var d = e + b;
        LocalDataMgr.cExecSqlWithP(d, ['%' + f + '%', c], function (e, d) {
            if (a) {
                a(e, d)
            }
        })
    },
    searchPCByWorkListmore: function (c, d, b, g, a) {
        var f = 'SELECT W.* FROM IMWFile W\n                    WHERE W.DeleteAt=0 And W.FileName like ? AND W.CreateAt >? AND W.CreateAt<?';
        var e = f + b;
        LocalDataMgr.cExecSqlWithP(e, ['%' + g + '%', c, d], function (f, e) {
            if (a) {
                a(f, e)
            }
        })
    },
    searchPCByWorkListISPicmore: function (c, d, b, g, a) {
        var f = "SELECT W.* FROM IMWFile W\n                    WHERE W.DeleteAt=0 And W.FileName like ? AND W.CreateAt >? AND W.Extension IN('jpg','jpeg','gif','png','bmp','webp') AND W.CreateAt<?";
        var e = f + b;
        LocalDataMgr.cExecSqlWithP(e, ['%' + g + '%', c, d], function (f, e) {
            if (a) {
                a(f, e)
            }
        })
    },
    searchPCByWorkListISNotPicmore: function (c, d, b, g, a) {
        var f = "SELECT W.* FROM IMWFile W\n                    WHERE W.DeleteAt=0 And W.FileName like ? AND W.CreateAt >? AND W.Extension IN('doc','docx','ppt','pptx','xls','xlsx','txt','rtf','pdf') AND W.CreateAt<?";
        var e = f + b;
        LocalDataMgr.cExecSqlWithP(e, ['%' + g + '%', c, d], function (f, e) {
            if (a) {
                a(f, e)
            }
        })
    }
}, 0, 0, 0, 0, 0, 0, [IMCommon.local, 'LocalSearchMgr', 0, 'LocalSearchMgr'], 0);
Ext.cmd.derive('IMCommon.local.MsgMgrSearch', Ext.Base, {
    alternateClassName: 'MsgMgrSearch',
    singleton: !0,
    getChat: function (a) {
        var b = 'SELECT * FROM IMChat ORDER BY UpdateAt DESC;';
        LocalDataMgr.cExecSqlWithP(b, [], function (c, b) {
            if (a) {
                a(c, b)
            }
        })
    },
    searchPtcp: function (c, a) {
        var b = 'SELECT distinct C.* FROM IMChat C JOIN IMMsg M ON C.ChatID=M.ChatID WHERE C.ChatType=?  AND M.SenderName LIKE ? ORDER BY C.UpdateAt DESC;';
        LocalDataMgr.cExecSqlWithP(b, ['G', '%' + c + '%'], function (d, b) {
            if (a) {
                a(d, b)
            }
        })
    },
    searchGN: function (b, a) {
        LocalDataMgr.getDB().transaction(function (c) {
            var d = 'select * from IMChat where DisplayName like ? ORDER BY UpdateAt DESC';
            c.executeSql(d, ['%' + b + '%'], function (e, d) {
                if (a) {
                    a(e, d)
                }
            })
        })
    },
    searchCR: function (b, a) {
        LocalDataMgr.getDB().transaction(function (c) {
            var d = 'SELECT C.DisplayName,M.* FROM IMMsg M JOIN IMChat C ON M.ChatID=C.ChatID WHERE M.Status!=? AND M.MsgType=? AND M.Content LIKE ? ORDER BY M.CreateAt DESC limit 0,20;';
            c.executeSql(d, ['1', 'T', '%' + b + '%'], function (e, d) {
                if (a) {
                    a(e, d)
                }
            })
        })
    },
    searchFile: function (b, a) {
        LocalDataMgr.getDB().transaction(function (c) {
            var d = 'select F.FileName,M.MsgID,M.MsgSeq,M.CreateAt,M.SenderName,R.DisplayName,R.ChatID from IMFile F join IMMsg M on F.BaseID=M.ID join IMChat R ON R.ChatID=M.ChatID where M.MsgType=? AND M.Status!=? AND F.FileName like ? ORDER BY M.CreateAt DESC limit 0,20';
            c.executeSql(d, ['F', '1', '%' + b + '%'], function (e, d) {
                if (a) {
                    a(e, d)
                }
            })
        })
    },
    searchMsgContext: function (c, a, f, e, b) {
        var d = this;
        LocalDataMgr.getDB().transaction(function (g) {
            var h = 'SELECT M.ChatID,M.MsgID,M.MsgSeq,M.CreateAt,M.Content,M.SenderName,M.MsgType,F.Width,F.Height,F.FileName,F.FileSize,F.FilePath,L.* FROM IMMsg M LEFT JOIN IMFile F ON M.ID=F.BaseID LEFT JOIN IMLink L ON M.ID=L.BaseID WHERE M.ChatID=? AND M.CreateAt<=? AND M.Status!=? ORDER BY M.CreateAt DESC limit 0,10;';
            g.executeSql(h, [c, parseInt(a, 10), '1'], function (n, k) {
                var i = k.rows,
                    h = [];
                var l = i.item(0);
                for (var j = i.length - 1; j >= 0; j--) {
                    var o = i.item(j);
                    h.push(d.getStoreMsgData(o, e))
                }
                var m = 'SELECT M.ChatID,M.MsgID,M.MsgSeq,M.CreateAt,M.Content,M.SenderName,M.MsgType,F.Width,F.Height,F.FileName,F.FileSize,F.FilePath,L.* FROM IMMsg M LEFT JOIN IMFile F ON M.ID=F.BaseID LEFT JOIN IMLink L ON M.ID=L.BaseID WHERE M.ChatID=? AND M.CreateAt>? AND M.Status!=? ORDER BY M.CreateAt limit 0,10;';
                n.executeSql(m, [c, parseInt(a, 10), '1'], function (p, o) {
                    var j = o.rows;
                    for (var i = 0; i < j.length; i++) {
                        var m = j.item(i);
                        h.push(d.getStoreMsgData(m, e))
                    }
                    if (b) {
                        b(h, l)
                    }
                })
            })
        })
    },
    getStoreMsgData: function (a, b) {
        return {
            chatID: a.ChatID,
            msgID: a.MsgID,
            updateTime: a.CreateAt,
            senderName: a.SenderName,
            content: a.Content,
            msgType: a.MsgType,
            width: a.Width,
            height: a.Height,
            fileName: a.FileName,
            fileSize: a.FileSize,
            filePath: a.FilePath,
            highlightWord: b
        }
    },
    searchLastMsg: function (b, a) {
        LocalDataMgr.getDB().transaction(function (c) {
            var d = 'SELECT M.ChatID,M.MsgID,M.CreateAt,M.Content,M.SenderName,M.MsgType,M.Status,F.Width,F.Height,F.FileName,F.FileSize,F.FilePath,L.* FROM IMMsg M LEFT JOIN IMFile F ON M.ID=F.BaseID LEFT JOIN IMLink L ON M.ID=L.BaseID  WHERE M.ChatID=? AND M.Status!=? ORDER BY M.CreateAt DESC limit 0,20;';
            c.executeSql(d, [b, '1'], function (e, d) {
                if (a) {
                    a(e, d)
                }
            })
        })
    },
    searchLastPic: function (b, a) {
        var c = 'SELECT * FROM IMFile WHERE FileType=? AND ChatID=? ORDER BY CreateAt DESC limit 50;';
        LocalDataMgr.cExecSqlWithP(c, ['I', b], function (d, c) {
            if (a) {
                a(d, c)
            }
        })
    },
    PadsearchLastPic: function (b, a) {
        var c = 'SELECT F.*,M.* FROM IMFile F LEFT JOIN IMMsg M ON F.BaseID=M.ID  WHERE F.FileType=? AND M.ChatID=? ORDER BY F.CreateAt DESC limit 50;';
        LocalDataMgr.cExecSqlWithP(c, ['I', b], function (d, c) {
            if (a) {
                a(d, c)
            }
        })
    },
    searchLastFile: function (b, a) {
        var c = 'SELECT * FROM IMFile WHERE FileType=? AND ChatID=? ORDER BY CreateAt DESC limit 50;';
        LocalDataMgr.cExecSqlWithP(c, ['F', b], function (d, c) {
            if (a) {
                a(d, c)
            }
        })
    },
    PadsearchLastFile: function (b, a) {
        var c = 'SELECT F.*,M.* FROM IMFile F LEFT JOIN IMMsg M ON F.BaseID=M.ID WHERE F.FileType=? AND M.ChatID=? ORDER BY F.CreateAt DESC limit 50;';
        LocalDataMgr.cExecSqlWithP(c, ['F', b], function (d, c) {
            if (a) {
                a(d, c)
            }
        })
    },
    searchMsgAgo: function (c, b, a) {
        var d = 'SELECT M.ChatID,M.MsgID,M.CreateAt,M.SenderID,M.Content,M.SenderName,M.MsgType,M.Status,F.HasPreview,F.Extension,F.FileID,F.BaseID,F.Width,F.Height,F.FileName,F.FileSize,F.FilePath,L.* FROM IMMsg M LEFT JOIN IMFile F ON M.ID=F.BaseID LEFT JOIN IMLink L ON M.ID=L.BaseID WHERE M.CreateAt<? AND M.ChatID=? AND M.Status!=? AND M.MsgType<>? ORDER BY M.CreateAt DESC limit 0,20;';
        LocalDataMgr.cExecSqlWithP(d, [b, c, '1', MsgType.NotShow], function (e, d) {
            if (a) {
                a(e, d)
            }
        })
    },
    searchMsgEnd: function (c, b, a) {
        var d = 'SELECT M.ChatID,M.MsgID,M.CreateAt,M.SenderID,M.Content,M.SenderName,M.MsgType,M.Status,F.HasPreview,F.Extension,F.FileID,F.BaseID,F.Width,F.Height,F.FileName,F.FileSize,F.FilePath,L.* FROM IMMsg M LEFT JOIN IMFile F ON M.ID=F.BaseID LEFT JOIN IMLink L ON M.ID=L.BaseID WHERE M.CreateAt>? AND M.ChatID=? AND M.Status!=? AND M.MsgType<>? ORDER BY M.CreateAt DESC limit 0,20;';
        LocalDataMgr.cExecSqlWithP(d, [b, c, '1', MsgType.NotShow], function (e, d) {
            if (a) {
                a(e, d)
            }
        })
    },
    searchMsgInOneDay: function (d, c, b, a) {
        var e = 'SELECT M.ChatID,M.MsgID,M.CreateAt,M.Content,M.SenderName,M.MsgType,F.Width,F.Height,F.FileName,F.FileSize,F.FilePath,L.* FROM IMMsg M LEFT JOIN IMFile F ON M.ID=F.BaseID LEFT JOIN IMLink L ON M.ID=L.BaseID WHERE M.CreateAt>=? AND M.CreateAt<=? AND M.ChatID=? AND M.Status!=? AND M.MsgType<>? ORDER BY M.CreateAt ASC;';
        LocalDataMgr.cExecSqlWithP(e, [c, b, d, '1', MsgType.NotShow], function (f, e) {
            if (a) {
                a(f, e)
            }
        })
    },
    searchMsgByDate: function (a, e, b) {
        var d = ParseUtil.getZeroTimeOfDay(e),
            c = ParseUtil.get24TimeOfDay(e);
        var f = 'SELECT M.ChatID,M.MsgID,M.CreateAt,M.Content,M.SenderID,M.SenderName,M.MsgType,F.FileID,F.Width,F.Height,F.FileName,F.FileSize,F.FilePath,L.* FROM IMMsg M LEFT JOIN IMFile F ON M.ID=F.BaseID LEFT JOIN IMLink L ON M.ID=L.BaseID WHERE M.CreateAt<? AND M.ChatID=? AND M.Status!=? AND M.MsgType<>? ORDER BY M.CreateAt DESC limit 20;';
        LocalDataMgr.cExecSqlWithP(f, [d, a, '1', MsgType.NotShow], function (l, k) {
            var i = k.rows,
                j = i.length;
            var g = [],
                f;
            for (var h = j - 1; h >= 0; h--) {
                f = i.item(h);
                if (h == j - 1) {
                    f.showDate = !0
                } else {
                    f.showDate = !ParseUtil.inOneDay(f.CreateAt, i.item(h + 1).CreateAt)
                }
                g.push(f)
            }
            var m = 'SELECT M.ChatID,M.MsgID,M.CreateAt,M.Content,M.SenderID,M.SenderName,M.MsgType,F.FileID,F.Width,F.Height,F.FileName,F.FileSize,F.FilePath,L.* FROM IMMsg M LEFT JOIN IMFile F ON M.ID=F.BaseID LEFT JOIN IMLink L ON M.ID=L.BaseID WHERE M.CreateAt>=? AND M.CreateAt<=? AND M.ChatID=? AND M.Status!=? AND M.MsgType<>? ORDER BY M.CreateAt ASC limit 20;';
            l.executeSql(m, [d, c, a, '1', MsgType.NotShow], function (n, j) {
                var i = j.rows,
                    o = i.length;
                var d;
                for (var h = 0; h < o; h++) {
                    f = i.item(h);
                    if (h == 0) {
                        f.showDate = !0;
                        d = f
                    } else {
                        f.showDate = !1
                    }
                    g.push(f)
                }
                if (!d) {
                    d = g[g.length - 1]
                }
                if (g.length >= 20) {
                    b(g, d)
                } else {
                    var p = 'SELECT M.ChatID,M.MsgID,M.CreateAt,M.Content,M.SenderID,M.SenderName,M.MsgType,F.FileID,F.Width,F.Height,F.FileName,F.FileSize,F.FilePath,L.* FROM IMMsg M LEFT JOIN IMFile F ON M.ID=F.BaseID LEFT JOIN IMLink L ON M.ID=L.BaseID WHERE M.CreateAt>? AND M.ChatID=? AND M.Status!=? AND M.MsgType<>? ORDER BY M.CreateAt ASC limit ?;';
                    var m = 20 - g.length;
                    n.executeSql(p, [c, a, '1', MsgType.NotShow, m], function (o, i) {
                        var h = i.rows,
                            m = h.length;
                        for (var c = 0; c < m; c++) {
                            f = h.item(c);
                            if (c == 0) {
                                f.showDate = !0
                            } else {
                                f.showDate = !ParseUtil.inOneDay(f.CreateAt, h.item(c - 1).CreateAt)
                            }
                            g.push(f)
                        }
                        if (!d) {
                            d = g[0]
                        }
                        b(g, d)
                    })
                }
            })
        })
    },
    searchMsgAgoDesc: function (c, b, e, a) {
        var d = 'SELECT * FROM IMMsg WHERE ChatID=? AND CreateAt>? AND MsgType=? AND Content LIKE ? ORDER BY CreateAt DESC;';
        LocalDataMgr.cExecSqlWithP(d, [c, b, MsgType.TextMsg, '%' + e + '%'], a)
    }
}, 0, 0, 0, 0, 0, 0, [IMCommon.local, 'MsgMgrSearch', 0, 'MsgMgrSearch'], 0);
Ext.cmd.derive('IMCommon.model.Mention', Ext.data.Model, {
    fields: ['user_id', 'user_name', 'Type', {
        name: 'TypeDesc',
        type: 'string',
        convert: function (b, a) {
            switch (a.get('Type')) {
                case 'R':
                    return '岗位';
                case 'G':
                    return '用户组';
                case 'O':
                    return '组织';
                case 'D':
                    return '部门';
                default:
                    return '用户';
            }
        }
    }]
}, 0, 0, 0, 0, 0, 0, [IMCommon.model, 'Mention'], 0);
Ext.cmd.derive('IMCommon.model.Msg', Ext.data.Model, {
    idProperty: 'msg_id',
    fields: ['senderName', 'sendText', {
        name: 'sendStatus',
        type: 'int',
        defaultValue: 0
    }, 'msgSeq', {
        name: 'updateTime'
    }, 'ROL', {
        name: 'showTime',
        type: 'bool',
        defaultValue: !0
    }, 'msg_id', 'msg_type', {
        name: 'showGrpChange',
        type: 'bool',
        defaultValue: !1
    }, 'GrpChangeMsg', 'notShowGrpChange', 'chat_id', 'attach_id', {
        name: 'isUpload',
        type: 'bool',
        defaultValue: !1
    }, 'width', 'height', 'localPath', 'fileName', 'fileSize', 'fileIcon', {
        name: 'fileProgress',
        type: 'float',
        defaultValue: 0
    }, {
        name: 'fileStatus',
        type: 'int',
        defaultValue: 4
    }, {
        name: 'failMsg',
        type: 'string',
        defaultValue: '文件已失效'
    }, {
        name: 'waitMsg',
        type: 'string',
        defaultValue: '请稍等...'
    }, 'linkName', 'linkType', 'linkOwner', 'linkTime', 'linkObjType', 'linkKeyString', 'linkType', 'linkLinkType', 'corpId']
}, 0, 0, 0, 0, 0, 0, [IMCommon.model, 'Msg'], 0);
Ext.cmd.derive('IMCommon.model.MsgReplay', Ext.data.Model, {
    idProperty: 'RootID',
    fields: ['ReplyID', 'ReplySeq', 'CreateAt', 'UpdateAt', 'EditAt', 'DeleteAt', 'UserID', 'UserName', 'RootID', 'Content', 'ContentType', 'AttachID', 'ContentEx', 'ChatID', 'MsgContent', 'MsgType', 'AvaHash', 'Sendername', 'Displayname', {
        name: 'avaRefresh',
        type: 'int',
        defaultValue: 0
    }, 'avaID', 'type', 'create_at', 'chat_id', 'Newreply', 'filepath', 'fileid', 'filename', 'filecreateat', 'linkobjtype', 'linktype', 'linkkeystring', 'bfilepath', 'senderid']
}, 0, 0, 0, 0, 0, 0, [IMCommon.model, 'MsgReplay'], 0);
Ext.cmd.derive('IMCommon.model.PersonList', Ext.data.Model, {
    idProperty: 'user_id',
    fields: ['user_id', 'user_name', {
        name: 'selList',
        type: 'bool',
        defaultValue: !1
    }]
}, 0, 0, 0, 0, 0, 0, [IMCommon.model, 'PersonList'], 0);
Ext.cmd.derive('IMCommon.model.RctChat', Ext.data.Model, {
    idProperty: 'chat_id',
    fields: ['chat_id', 'chat_name', 'user_id', 'type', {
        name: 'isUnRead',
        type: 'boolean',
        defaultValue: !1
    }, {
        name: 'status',
        type: 'int',
        convert: function (a) {
            if (a == 0) {
                return '在线'
            } else {
                if (a == -1) {
                    return '离线'
                }
            }
            return ''
        }
    }, {
        name: 'name',
        type: 'string'
    }, {
        name: 'last_post_at',
        type: 'date'
    }, {
        name: 'unReadNum',
        type: 'int',
        defaultValue: 0
    }, {
        name: 'toTop',
        type: 'boolean',
        defaultValue: !1
    }, {
        name: 'last_post_name',
        type: 'string'
    }, {
        name: 'last_msg_type',
        type: 'string',
        defaultValue: '0'
    }, 'last_post_msg', 'members', {
        name: 'msgToLatest',
        type: 'bool',
        defaultValue: !0
    }, 'msgScrY', 'avaHash', {
        name: 'avaLoaded',
        type: 'bool',
        defaultValue: !1
    }, {
        name: 'avaRefresh',
        type: 'int',
        defaultValue: 0
    }, {
        name: 'MentionCount',
        type: 'int',
        defaultValue: 0
    }, {
        name: 'applyCount',
        type: 'int',
        defaultValue: 0
    }]
}, 0, 0, 0, 0, 0, 0, [IMCommon.model, 'RctChat'], 0);
Ext.cmd.derive('IMCommon.model.Reply', Ext.data.Model, {
    idProperty: 'ReplyID',
    fields: ['ReplyID', 'ReplySeq', 'CreateAt', 'UpdateAt', 'EditAt', 'DeleteAt', 'UserID', 'UserName', 'RootID', 'Content', 'ContentType', 'AttachID', 'ContentEx', 'ChatID', 'MsgContent', 'MsgType', 'AvaHash', 'Sendername', 'Displayname', {
        name: 'avaRefresh',
        type: 'int',
        defaultValue: 0
    }, 'avaID', 'type', 'create_at', 'chat_id', 'Newreply', 'filepath', 'fileid', 'filename', 'filecreateat', 'linkobjtype', 'linktype', 'linkkeystring', 'bfilepath']
}, 0, 0, 0, 0, 0, 0, [IMCommon.model, 'Reply'], 0);
Ext.cmd.derive('IMCommon.model.desktop.ChatListViewModel', Ext.app.ViewModel, {
    data: {
        hideMoreMsg: !0,
        msgNum: 0,
        hideUpBtn: !0,
        upMsgNum: 0,
        hideAtBtn: !0,
        atCount: 0
    }
}, 0, 0, 0, 0, ['viewmodel.desktop_chatlist'], 0, [IMCommon.model.desktop, 'ChatListViewModel'], 0);
Ext.cmd.derive('IMCommon.model.desktop.DeskFileMgr', Ext.data.Model, {
    idProperty: 'baseID',
    fields: ['updateTime', 'senderName', 'fileName', 'fileSize', 'filePath', 'fileStatus', 'msgID', 'baseID', 'remoteUrl', 'chatType', 'displayName', 'showPart']
}, 0, 0, 0, 0, 0, 0, [IMCommon.model.desktop, 'DeskFileMgr'], 0);
Ext.cmd.derive('IMCommon.model.desktop.DeskWorkFileMgr', Ext.data.Model, {
    idProperty: 'baseID',
    fields: ['updateTime', 'senderName', 'fileName', 'fileSize', 'filePath', 'fileStatus', 'msgID', 'baseID', 'remoteUrl', 'chatType', 'displayName', 'showPart']
}, 0, 0, 0, 0, 0, 0, [IMCommon.model.desktop, 'DeskWorkFileMgr'], 0);
Ext.cmd.derive('IMCommon.model.desktop.DesktopGrpMems', Ext.data.Model, {
    idProperty: 'user_id',
    fields: ['uid', 'name', 'mobile', 'email', 'isManager', {
        name: 'status',
        type: 'int',
        defaultValue: -1
    }, {
        name: 'user_id',
        type: 'string'
    }, {
        name: 'user_name',
        type: 'string'
    }, 'onlineDev', 'isadmin']
}, 0, 0, 0, 0, 0, 0, [IMCommon.model.desktop, 'DesktopGrpMems'], 0);
Ext.cmd.derive('IMCommon.utils.AddDataUtil', Ext.Base, {
    alternateClassName: 'AddDataUtil',
    singleton: !0,
    bindSyncChats: function (c) {
        var d = Ext.getStore('comRct'),
            e = d.getCount(),
            b;
        for (var a = 0; a < e; a++) {
            b = d.getAt(a);
            if (b) {
                b.set({
                    IsMute: 'N'
                })
            }
        }
        if (Ext.isEmpty(c) || c.length == 0) {
            return
        }
        var f = c.length;
        for (var a = 0; a < f; a++) {
            b = d.getById(c[a]);
            if (b) {
                b.set({
                    IsMute: 'Y'
                })
            }
        }
    },
    bindUnreadmsgReply: function () {
        LocalDataMgr.getMsgReplyhead(function (f, e) {
            var d = Ext.getStore('msgReply'),
                b = e.rows,
                c = [];
            d.removeAll();
            for (var a = 0; a < b.length; a++) {
                if (b.item(a).ChatType == 'D') {} else {
                    c.push({
                        chat_id: b.item(a).ChatID,
                        AvaHash: b.item(a).AvatarHash,
                        CreateAt: b.item(a).CreateAt,
                        MsgContent: b.item(a).Content,
                        Sendername: b.item(a).SenderName,
                        Displayname: b.item(a).DisplayName,
                        type: b.item(a).ChatType,
                        create_at: b.item(a).Creatatchat,
                        RootID: b.item(a).MsgID,
                        Newreply: b.item(a).NewReply,
                        MsgType: b.item(a).MsgType,
                        filepath: b.item(a).FilePath,
                        fileid: b.item(a).FileID,
                        filename: b.item(a).FileName,
                        filecreateat: b.item(a).CreatatFile,
                        linkobjtype: b.item(a).LinkObjType,
                        linktype: b.item(a).LinkType,
                        linkkeystring: b.item(a).LinkKeyString,
                        bfilepath: b.item(a).BFilePath,
                        senderid: b.item(a).SenderID
                    })
                }
            }
            d.add(c)
        });
        LocalDataMgr.getMsgmyReplyhead(User.ownerID, function (f, e) {
            var d = Ext.getStore('msgmyReply'),
                b = e.rows,
                c = [];
            d.removeAll();
            for (var a = 0; a < b.length; a++) {
                if (b.item(a).ChatType == 'D') {} else {
                    c.push({
                        chat_id: b.item(a).ChatID,
                        AvaHash: b.item(a).AvatarHash,
                        CreateAt: b.item(a).CreateAt,
                        MsgContent: b.item(a).Content,
                        Sendername: b.item(a).SenderName,
                        Displayname: b.item(a).DisplayName,
                        type: b.item(a).ChatType,
                        create_at: b.item(a).Creatatchat,
                        RootID: b.item(a).MsgID,
                        Newreply: b.item(a).NewReply,
                        MsgType: b.item(a).MsgType,
                        filepath: b.item(a).FilePath,
                        fileid: b.item(a).FileID,
                        filename: b.item(a).FileName,
                        filecreateat: b.item(a).CreatatFile,
                        linkobjtype: b.item(a).LinkObjType,
                        linktype: b.item(a).LinkType,
                        linkkeystring: b.item(a).LinkKeyString,
                        bfilepath: b.item(a).BFilePath,
                        senderid: b.item(a).SenderID
                    })
                }
            }
            d.add(c)
        });
        LocalDataMgr.getMsgaboutmeReplyhead(User.ownerID, function (f, e) {
            var d = Ext.getStore('msgaboutmeReply'),
                b = e.rows,
                c = [];
            d.removeAll();
            for (var a = 0; a < b.length; a++) {
                if (b.item(a).ChatType == 'D') {} else {
                    c.push({
                        chat_id: b.item(a).ChatID,
                        AvaHash: b.item(a).AvatarHash,
                        CreateAt: b.item(a).CreateAt,
                        MsgContent: b.item(a).Content,
                        Sendername: b.item(a).SenderName,
                        Displayname: b.item(a).DisplayName,
                        type: b.item(a).ChatType,
                        create_at: b.item(a).Creatatchat,
                        RootID: b.item(a).MsgID,
                        Newreply: b.item(a).NewReply,
                        MsgType: b.item(a).MsgType,
                        filepath: b.item(a).FilePath,
                        fileid: b.item(a).FileID,
                        filename: b.item(a).FileName,
                        filecreateat: b.item(a).CreatatFile,
                        linkobjtype: b.item(a).LinkObjType,
                        linktype: b.item(a).LinkType,
                        linkkeystring: b.item(a).LinkKeyString,
                        bfilepath: b.item(a).BFilePath,
                        senderid: b.item(a).SenderID
                    })
                }
            }
            d.add(c)
        })
    },
    bindMsgReplyList: function (a) {
        LocalDataMgr.getMsgReplycontent(a, function (f, e) {
            var d = e.rows,
                c = [];
            for (var b = 0; b < d.length; b++) {
                c.push(d.item(b))
            }
            Ext.ComponentQuery.query('#replycontentlist')[0].setData(c);
            AddDataUtil.onScroll(Ext.ComponentQuery.query('#replycontentlist')[0])
        })
    },
    bindUnreadChats: function (d) {
        var j = Ext.getStore('comRct'),
            l = '',
            e = '',
            i = [];
        for (var c = 0; c < d.length; c++) {
            var a = d[c].chat;
            if (Config.isPC) {
                var m = a.chat_id;
                if (!Ext.isEmpty(User.popupChat[m])) {
                    continue
                }
            }
            var h = a.chat_id;
            if (a.chat_type == ChatType.Multi) {
                e = a.header
            } else {
                if (a.chat_type == 'C') {
                    e = a.header
                } else {
                    if (a.chat_type == ChatType.Direct) {
                        e = ParseUtil.getDctNameFromMems(d[c].members);
                        h = ParseUtil.getDctIdFromMems(d[c].members)
                    }
                }
            }
            var b = a.last_msg_type;
            if (b == 'G' || b == 'A' || b == 'R' || b == 'M' || b == 'C' || b == 'X' || b == 'H' || b == 'S' || b == 'N') {
                b = MsgType.GroupNotice
            }
            var k = !1;
            var g = j.getById(a.chat_id);
            if (g) {
                k = g.get('toTop')
            }
            if (a.last_msg_type == 'B') {
                a.last_message = GroupNotice.getRevokeNotice(a.last_sender, a.last_message)
            }
            var f = a.is_mute;
            if (Ext.isEmpty(f)) {
                f = 'N'
            }
            i.push({
                chat_id: a.chat_id,
                create_at: a.create_at,
                name: e,
                type: a.chat_type,
                status: l,
                chat_name: a.chat_name,
                isUnRead: a.unread_count > 0,
                unReadNum: a.unread_count,
                last_post_at: new Date(a.last_post_at),
                last_post_id: a.last_sender,
                last_post_name: a.last_sender_name,
                last_msg_type: b,
                last_post_msg: a.last_message,
                members: d[c].members,
                avaHash: a.avatar_hash,
                avaID: h,
                toTop: k,
                atcount: a.mention_count > 0 ? 1 : 0,
                MentionCount: a.mention_count,
                IsMute: f
            })
        }
        j.add(i)
    },
    bindLocalHistory: function (c, b, a) {
        LocalDataMgr.getHistory(function (i, f) {
            var e = f.rows,
                d = c.getStore();
            if (!d) {
                return
            }
            var g = ParseUtil.parseLocalMsg(e);
            d.add(g);
            var h = ParseUtil.judgeSlice(e);
            ChatUtil.getSliceHistory(a, h, d, function () {
                d.sort('updateTime', 'ASC');
                AddDataUtil.onScrolMsgView()
            })
        }, b, a)
    },
    addChannelToRecent: function (a, f, e, b) {
        var d = b.getStore();
        var c = d.add({
            chat_id: a.chat_id,
            name: e,
            type: a.chat_type,
            last_post_at: new Date(a.update_at),
            chat_name: a.chat_name,
            members: a.members
        });
        if (a.creator_id == User.ownerID) {
            b.setSelection(c[0])
        }
        return c[0]
    },
    bindAllMsg: function (b, e) {
        if (b.length > 0) {
            var f = [];
            for (var a = 0; a < b.length; a++) {
                var d = !0;
                if (a > 0) {
                    if (ParseUtil.inOneMinute(b[a].create_at, b[a - 1].create_at)) {
                        d = !1
                    }
                }
                var c = ParseUtil.getMsgData(b[a]);
                c.showTime = d;
                c.name = c.user_name;
                f.push(c)
            }
            e.add(f);
            e.sort('updateTime', 'ASC')
        }
    },
    getNoticeMemsByContent: function (d, c) {
        var a = c.split(',');
        for (var b = 0; b < a.length; b++) {
            if (a[b] == d) {
                a.splice(b, 1);
                break
            }
        }
        return a
    },
    onScroll: function (a) {
        if (Config.isPC) {
            a.isCodeScrol = !0;
            this.doScroll(a).then(function () {
                if (IMHelper.canUseReceipt()) {
                    ChatUtil.sendScrollReadDetails()
                }
            })
        } else {
            this.doScroll(a)
        }
    },
    doScroll: function (b) {
        var a = b.getScrollable();
        if (a) {
            var c = a.getScrollElement().dom.scrollHeight,
                d = a.getScrollElement().dom.scrollTop;
            return a.scrollTo(0, c)
        }
    },
    onScrollToTop: function (a) {
        if (Config.isPC) {
            User.isRefresh = !0;
            this.doScrollToTop(a).then(function () {
                User.isRefresh = !1
            })
        } else {
            this.doScrollToTop(a)
        }
    },
    doScrollToTop: function (a) {
        var b = a.getScrollable();
        return b.scrollTo(0, 0)
    },
    onScrolMsgView: function () {
        var a = this.getCefMsgView();
        if (a) {
            this.onScroll(a)
        }
    },
    getCefMsgView: function () {
        var a;
        if (window.cefMain) {
            if (Ext.Viewport.lookup('IM').lookup('im-main')) {
                a = Ext.Viewport.lookup('IM').lookup('im-main').down('#chatView')
            }
        } else {
            if (window.cefChat) {
                var b = Utils.getCmp('desktopChatView');
                if (b) {
                    a = b.lookup('desktopChatList')
                }
            }
        }
        return a
    },
    isMsgViewBottom: function () {
        var a = this.getCefMsgView();
        return this.isViewBottom(a)
    },
    isViewBottom: function (b) {
        if (b) {
            var a = b.getScrollable().getScrollElement().dom,
                e = a.scrollTop,
                c = a.offsetHeight,
                d = a.scrollHeight;
            if (e + c === d) {
                return !0
            }
        }
        return !1
    },
    onShowChatTime: function (c) {
        var b = c.data.items,
            d = b.length;
        for (var a = 1; a < d; a++) {
            if (b[a].data.updateTime == b[a - 1].data.updateTime) {
                c.getAt(a).set('showTime', !1)
            }
        }
    },
    bindChatToRecent: function (a, f, d) {
        var b = Ext.Viewport.lookup('IMMobile').down('#IMMobile_Chat').down('#ChatList');
        var c = b.getStore();
        var e = c.add({
            chat_id: a.chat_id,
            name: d,
            type: a.chat_type,
            updateTime: a.update_at,
            last_post_at: new Date(a.update_at),
            chat_name: a.chat_name
        });
        if (a.creator_id == User.ownerID) {
            b.setSelection(e)
        }
    },
    msgScrollToRecord: function (b, a) {
        if (!a) {
            a = this.getCefMsgView()
        }
        if (!a) {
            return
        }
        setTimeout(function () {
            a.isCodeScrol = !0;
            a.ensureVisible(b, {
                align: {
                    y: 'start'
                }
            })
        }, 100)
    },
    doScrollByMyself: function (c, a) {
        a.isCodeScrol = !0;
        var d = a.getScrollable(),
            b = a.getItemTop(c);
        console.log('当前的itemTop', b);
        d.scrollTo(0, b)
    },
    bindNews: function (c, b) {
        var a = c.getStore();
        a.removeAll();
        ChatUtil.getLocalNews(c, function (d) {
            var f = d.length,
                e = 0;
            if (f > 0) {
                var g = d[f - 1];
                e = g.newsSeq
            }
            ChatUtil.getLastedNewsFromServer(e, function (f) {
                var e;
                if (f >= 20) {
                    e = f.slice(Math.max(0, e.length - 20), 20);
                    a.add(e)
                } else {
                    e = d.concat(f);
                    if (e > 20) {
                        e = e.slice(Math.max(0, e.length - 20), 20)
                    }
                    a.add(e)
                }
                if (b) {
                    b(e.slice(-1))
                }
            }, function () {
                a.add(d);
                if (b) {
                    b(d.slice(-1))
                }
            })
        })
    }
}, 0, 0, 0, 0, 0, 0, [IMCommon.utils, 'AddDataUtil', 0, 'AddDataUtil'], 0);
Ext.cmd.derive('IMCommon.utils.AtUtil', Ext.Base, {
    alternateClassName: 'AtUtil',
    singleton: !0,
    ats: {},
    clear: function () {
        this.ats = {}
    },
    useDB: !0,
    manualRemoveAt: !0,
    chgChatToClear: !1,
    scrolToClear: !1,
    canShowAt: function (a) {
        return !0
    },
    doSearchAtMems: function (d, b, a) {
        var c = this;
        var e = 'SELECT * FROM IMChat WHERE ChatID=?';
        LocalDataMgr.cExecSqlWithP(e, [d], function (m, k) {
            var e = k.rows;
            if (e.length > 0) {
                var j = e.item(0).UserIDs;
                var h = e.item(0).ChatType;
                if (h == 'G') {
                    var g = e.item(0).ManagerID;
                    var f = !1;
                    if (g == User.ownerID) {
                        f = !0
                    }
                    var i = c.doGetAtMems(j, b, f);
                    if (Ext.isFunction(a)) {
                        a(i)
                    }
                } else {
                    if (h == 'D') {
                        var g = '';
                        var f = !1;
                        var i = c.doGetAtMems(j, b, f);
                        if (Ext.isFunction(a)) {
                            a(i)
                        }
                    } else {
                        if (h == 'C') {
                            var g = e.item(0).ManagerID;
                            var l = 'SELECT * FROM IMChatCM WHERE ChatID=?';
                            LocalDataMgr.cExecSqlWithP(l, [d], function (n, l) {
                                var e = l.rows;
                                var h = !1;
                                if (e.length > 0) {
                                    for (var f = 0; f < e.length; f++) {
                                        if (e.item(f).IsAdmin == 'Y' && e.item(f).BodyID == User.ownerID || User.ownerID == g) {
                                            h = !0
                                        }
                                    }
                                    var i = c.doGetAtMems(j, b, h);
                                    if (Ext.isFunction(a)) {
                                        a(i)
                                    }
                                }
                            })
                        }
                    }
                }
            }
        })
    },
    doGetAtMems: function (i, g, h) {
        var d = i.split(',');
        if (d.length > 2 && h) {
            d.push('all_user')
        }
        var a = '',
            b = '',
            e = [],
            c = !0;
        for (var f = 0; f < d.length; f++) {
            a = d[f];
            if (User.ownerID != a) {
                if (a == 'all_user') {
                    b = '所有人'
                } else {
                    b = User.getUserName(a)
                }
                if (!b) {
                    continue
                }
                c = !0;
                if (a.indexOf(g) >= 0) {
                    e.push({
                        user_id: a,
                        user_name: b
                    });
                    c = !1
                }
                if (c) {
                    if (b.indexOf(g) >= 0) {
                        e.push({
                            user_id: a,
                            user_name: b
                        });
                        c = !1
                    }
                }
            }
        }
        return e
    },
    showMsgViewAtBtn: function (c, a) {
        if (Config.isDesktop) {
            var b = this;
            if (!a) {
                if (window.cefMain) {
                    a = ViewGet.getMsgView()
                } else {
                    return
                }
            }
            if (!b.ats[c]) {
                b.clearPageCache(c, a);
                return
            }
            var d = b.ats[c];
            if (d.length == 0) {
                b.clearPageCache(c, a);
                return
            }
            var f = !1,
                g;
            for (var e = d.length - 1; e > -1; e--) {
                g = b.mentionInVisible(d[e], a);
                if (g) {
                    b.removeMentionCache(d[e], a)
                } else {
                    f = !0;
                    break
                }
            }
            if (f) {
                b.showAtBtn(a)
            } else {
                b.clearPageCache(c, a)
            }
        }
    },
    mentionInVisible: function (b, c) {
        var h = b.chat_id,
            a = Ext.getStore(h),
            f = b.msg_id;
        if (!a) {
            return !1
        }
        var d = a.getById(f);
        if (d) {
            var e = a.indexOf(d),
                g = c.getItemAt(e);
            if (ChatUtil.msgInVisibleArea(g, c)) {
                return !0
            }
        }
        return !1
    },
    addMentionsCache: function (c, a) {
        if (Ext.isArray(a) && a.length > 0) {
            for (var b = a.length - 1; b > -1; b--) {
                this.addMentionCache(a[b])
            }
        }
    },
    addMentionCache: function (c) {
        var b = this,
            a = c.chat_id;
        if (!b.ats[a]) {
            b.ats[a] = []
        }
        b.ats[a].unshift(c)
    },
    doMsgViewAtBtn: function (e, c) {
        if (Config.isPC) {
            var b = this,
                a = b.ats[e];
            if (!a) {
                b.hideAtBtn(c);
                return
            }
            for (var d in a) {
                if (b.mentionInVisible(a[d], c)) {
                    b.removeMentionCache(a[d], c)
                }
            }
        }
    },
    removeMentionCache: function (d, e) {
        var b = this,
            a = d.chat_id;
        if (a != User.crtChannelId) {
            return
        }
        if (!b.ats[a]) {
            return
        }
        var c = d.msg_id;
        ParseUtil.objArrRemoveByKey(b.ats[a], 'msg_id', c);
        if (Config.isDesktop) {
            DesktopChatUtil.removeMentionNoticeByMsgID(c)
        }
        var f = b.ats[a].length;
        if (f == 0) {
            b.clearPageCache(a, e)
        }
    },
    clearPageCache: function (a, d) {
        delete this.ats[a];
        LocalDataMgr.clearRctMentionCount(a);
        var c = Ext.getStore('comRct');
        if (c) {
            var b = c.getById(a);
            if (b) {
                if (b.get('MentionCount') != 0) {
                    b.set({
                        MentionCount: 0
                    })
                }
            }
        }
        if (User.crtChannelId == a) {
            this.hideAtBtn(d)
        }
        if (Config.isDesktop) {
            DesktopChatUtil.clearCefAtForm(a)
        }
    },
    hideAtBtn: function (a) {
        if (!a) {
            if (window.cefMain) {
                a = ViewGet.getMsgView()
            } else {
                return
            }
        }
        var b = a.getViewModel();
        if (!b.get('hideAtBtn')) {
            b.set({
                hideAtBtn: !0
            })
        }
    },
    showAtBtn: function (a) {
        if (!a) {
            if (window.cefMain) {
                a = ViewGet.getMsgView()
            } else {
                return
            }
        }
        var b = a.getViewModel();
        if (b.get('hideAtBtn')) {
            b.set({
                hideAtBtn: !1
            })
        }
    },
    addMentionsInDB: function (b, a) {
        if (Ext.isArray(a) && a.length > 0) {
            LocalDataMgr.addMentions(b, a)
        } else {
            LocalDataMgr.clearMentions(b)
        }
    },
    showAtBtnInMsgView: function (c, a) {
        var b = this;
        LocalDataMgr.getMentions(c, function (g, f) {
            var e = f.rows,
                d = e.length;
            if (!AtUtil.manualRemoveAt) {
                d = b.doInChatClearVisibleAt(e, d, a)
            }
            if (d > 0) {
                b.showAtBtnNew(a, d)
            } else {
                b.doPageClearMention(c, a, !0)
            }
        })
    },
    doInChatClearVisibleAt: function (e, b, d) {
        var a;
        for (var c = 0; c < b; c++) {
            a = e.item(c);
            if (AtUtil.mentionInVisible({
                    chat_id: a.ChatID,
                    msg_id: a.MsgID
                }, d)) {
                b--;
                AtUtil.removeOneMentionUseDB(a.ChatID, a.MsgID)
            } else {
                break
            }
        }
        return b
    },
    showAtBtnNew: function (b, c) {
        var a = b.getViewModel();
        a.set({
            hideAtBtn: !1,
            atCount: c
        })
    },
    hideAtBtnNew: function (a) {
        var b = a.getViewModel();
        b.set({
            hideAtBtn: !0,
            atCount: 0
        });
        if (Config.isPad || Ext.os.is.tablet) {
            a.getAtBtn().hide()
        }
    },
    showapplyBtnNew: function (b, c) {
        var a = b.getViewModel();
        a.set({
            applyBtn: !1,
            applyCount: c
        })
    },
    removeOneMentionUseDB: function (a, c, b) {
        AtUtil.removeServerOneMention(a, c, function () {
            LocalDataMgr.removeOneMention(a, c)
        });
        if (b) {
            this.doPageRemoveMention(a, b)
        }
    },
    doPageRemoveMention: function (a, b, d) {
        var c = this;
        LocalDataMgr.getMentions(a, function (j, h) {
            var i = h.rows,
                e = i.length;
            if (!d) {
                var f = Ext.getStore('comRct');
                if (f) {
                    var g = f.getById(a);
                    if (g) {
                        g.set({
                            MentionCount: e
                        })
                    }
                }
            }
            if (User.crtChannelId == a) {
                if (e > 0) {
                    c.showAtBtnNew(b, e)
                } else {
                    c.hideAtBtnNew(b)
                }
            }
        })
    },
    clearMentionsUseDB: function (a, b) {
        this.clearServerMention(a, function () {
            LocalDataMgr.clearMentions(a)
        });
        this.doPageClearMention(a, b)
    },
    doPageClearMention: function (b, d) {
        var c = Ext.getStore('comRct');
        if (c) {
            var a = c.getById(b);
            if (a) {
                if (a.get('MentionCount') != 0) {
                    a.set({
                        MentionCount: 0
                    })
                }
            }
        }
        if (User.crtChannelId == b) {
            this.hideAtBtnNew(d)
        }
        if (Config.isDesktop) {
            DesktopChatUtil.clearCefAtForm(b)
        }
    },
    removeServerOneMention: function (d, c, a, b) {
        Utils.custAjax('PUT', 'chats/' + d + '/viewat', {
            success: function (e) {
                if (Ext.isFunction(a)) {
                    a(e)
                }
            },
            failure: function (e) {
                if (Ext.isFunction(b)) {
                    a(e)
                }
            }
        }, !1, '&msg_id=' + c)
    },
    clearServerMention: function (c, a, b) {
        Utils.custAjax('PUT', 'chats/' + c + '/viewat', {
            success: function (d) {
                if (Ext.isFunction(a)) {
                    a(d)
                }
            },
            failure: function (d) {
                if (Ext.isFunction(b)) {
                    a(d)
                }
            }
        }, !1, '&msg_id=all')
    }
}, 0, 0, 0, 0, 0, 0, [IMCommon.utils, 'AtUtil', 0, 'AtUtil'], 0);
Ext.cmd.derive('IMCommon.utils.AvatarMgr', Ext.Base, {
    singleton: !0,
    alternateClassName: 'AvatarMgr',
    loadAvt: function (a, d) {
        var c = a.getAttribute('data-hash');
        var b = a.getAttribute('data-user');
        if (!b) {
            return
        }
        a.onload = null;
        if (d) {
            if (!c) {
                LocalDataMgr.commonExecSql("select A.AvaHash from IMAva A where A.AvaID='" + b + "'", function (f, c) {
                    var e;
                    if (c.rows.length > 0) {
                        e = c.rows[0].AvaHash
                    }
                    AvatarMgr.execLoadAvt(a, e || 'imdefault', b)
                })
            } else {
                AvatarMgr.execLoadAvt(a, c, b)
            }
        } else {
            c = c || 'imdefault';
            AvatarMgr.execLoadAvt(a, c, b)
        }
    },
    execLoadAvt: function (c, b, d) {
        if (window.cordova || Config.isDesktop) {
            AvatarMgr.downAva(b, d, function (a) {
                if (a) {
                    c.src = a
                }
            })
        } else {
            var a = AvatarMgr.getAvaUrl(b);
            if (a) {
                c.src = a
            }
        }
    },
    loadError: function (a) {
        a.target.onerror = null;
        a.target.removeEventListener('error', AvatarMgr.loadError, !1);
        a.target.src = Ext.getResourcePath('images/imdefault.png', null, 'IMMobile')
    },
    loadAvt2: function (a, g) {
        var b = a.getAttribute('data-user');
        if (!b) {
            return
        }
        var h = a.getAttribute('data-hasload');
        if (h) {
            return
        }
        var e = a.getAttribute('data-time');
        var d = a.getAttribute('data-type');
        var j = a.getAttribute('data-hash');
        var i = a.getAttribute('cid');
        a.onload = null;
        a.setAttribute('data-hasload', '1');
        var c;
        if (d == 'G') {
            c = AvatarMgr.getChatAvaUrl(b, e)
        } else {
            if (d == 'C') {
                c = AvatarMgr.getCrowdAvaUrl(i, e)
            } else {
                if (d == 'at') {
                    a.src = Ext.getResourcePath('images/at.png', null, 'IMMobile');
                    return
                } else {
                    c = AvatarMgr.getUserAvaUrl(b)
                }
            }
        }
        var f;
        if (d == 'G') {
            f = User.getChatAvaDir(b, e)
        } else {
            if (d == 'C') {
                f = User.getUserAvaCrowd(b)
            } else {
                f = User.getUserAvaDir(b)
            }
        }
        a.addEventListener('error', AvatarMgr.loadError, !1);
        if (window.cordova || Config.isDesktop) {
            if (g) {
                AvatarMgr.downAva1(b, d, e, '', 'old', function (b) {
                    a.src = b + '?' + User.cacheMil
                })
            } else {
                FileMgr.downFileForSrc(c, 1, f + b + '.png').then(function (b) {
                    a.src = b.path + '?' + User.cacheMil
                })['catch'](function (b) {
                    a.src = c
                })
            }
        } else {
            a.src = c
        }
    },
    _getIdBy: function (a, b) {
        if (Ext.isEmpty(a)) {
            return ''
        }
        if (b) {
            if (a == '系统') {
                return 'System'
            }
            return ''
        }
        return a
    },
    getAvatarHtmlByName: function (e, b, c, d) {
        var a = '';
        if (d) {
            a = 'small'
        }
        return '<a class="avatar link-avatar firstletter ' + a + '" letter="' + AvatarMgr.getFirstLetter(e) + '"  >\n                    <img src="' + ImgUtil.onePxImg + '" onload="AvatarMgr.onload(this)" style="display:none" ava-hash="' + b + '" ava-id="' + c + '">\n                </a>'
    },
    getAvatarHtmlByName1: function (e, c, a, d) {
        var b = '';
        if (d) {
            b = 'small'
        }
        return '<a class="avatar link-avatar firstletter ' + b + '" letter="' + AvatarMgr.getFirstLetter(e) + '">\n                    <img src="' + ImgUtil.onePxImg + '" onload="AvatarMgr.onload1(this)" style="display:none" ava-hash="' + c + '" ava-id="' + a + '" chat-id="' + a + '" type="D" create-time="0">\n                </a>'
    },
    onload: function (a) {
        if (!a || !a.parentNode || !a.parentNode.parentNode) {
            return
        }
        var d = a.getAttribute('ava-hash');
        var b = a.getAttribute('ava-id');
        a.removeAttribute('onload');
        if (Ext.browser.is.Cordova) {} else {
            var c = function (e) {
                if (Config.isPC) {
                    e = ParseUtil.getLocalFileURL(e);
                    var f = Ext.getStore('comRct').getById(b);
                    if (f) {
                        f.set({
                            avaLoaded: !0
                        })
                    }
                }
                var g = e,
                    c, d;
                c = function (b) {
                    b.target.parentNode.className += ' loaded';
                    b.target.style.removeProperty('display');
                    b.target.removeEventListener('load', c, !1);
                    b.target.removeEventListener('error', d, !1)
                };
                d = function (b) {
                    b.target.parentNode.removeChild(b.target);
                    b.target.removeEventListener('load', c, !1);
                    b.target.removeEventListener('error', d, !1)
                };
                a.addEventListener('load', c, !1);
                a.addEventListener('error', d, !1);
                a.src = g
            };
            AvatarMgr.downAva(d, b, c)
        }
    },
    onload1: function (a) {
        if (!a || !a.parentNode || !a.parentNode.parentNode) {
            return
        }
        var e = a.getAttribute('ava-id');
        var b = a.getAttribute('chat-id');
        var g = a.getAttribute('type');
        var d = a.getAttribute('create-time');
        var f = a.getAttribute('ava-hash');
        a.removeAttribute('onload');
        if (Ext.browser.is.Cordova) {} else {
            var c = function (e) {
                if (Config.isPC) {
                    e = ParseUtil.getLocalFileURL(e);
                    var f = Ext.getStore('comRct').getById(b);
                    if (f) {
                        f.set({
                            avaLoaded: !0
                        })
                    }
                }
                var g = e,
                    c, d;
                c = function (b) {
                    b.target.parentNode.className += ' loaded';
                    b.target.style.removeProperty('display');
                    b.target.removeEventListener('load', c, !1);
                    b.target.removeEventListener('error', d, !1)
                };
                d = function (b) {
                    b.target.parentNode.removeChild(b.target);
                    b.target.removeEventListener('load', c, !1);
                    b.target.removeEventListener('error', d, !1)
                };
                a.addEventListener('load', c, !1);
                a.addEventListener('error', d, !1);
                a.src = g
            };
            AvatarMgr.downAva1(e, g, d, b, f, c)
        }
    },
    downAva1: function (a, f, c, g, b, d) {
        var e = this;
        if (f == ChatType.Multi) {
            LocalDataMgr.needUpdateChatAva(a, b, function (i) {
                if (i) {
                    var h = User.getChatAvaDir(c) + a + '.png';
                    FileMgr.exists(null, h).then(function (j) {
                        if (j) {
                            FileMgr.remove(null, h).then(function () {
                                e.downChatAva(a, c, b, d)
                            })
                        } else {
                            e.downChatAva(a, c, b, d)
                        }
                    })
                } else {
                    e.downChatAva(a, c, b, d)
                }
            })
        } else {
            if (f == ChatType.Direct) {
                LocalDataMgr.needUpdateUserAva(a, b, function (i) {
                    if (i) {
                        User.cacheMil = (new Date()).getTime();
                        var h = User.getUserAvaDir() + a + '.png';
                        FileMgr.exists(null, h).then(function (j) {
                            if (j) {
                                FileMgr.remove(null, h).then(function () {
                                    e.downUserAva(a, c, b, d)
                                })
                            } else {
                                e.downUserAva(a, c, b, d)
                            }
                        })
                    } else {
                        e.downUserAva(a, c, b, d)
                    }
                })
            } else {
                if (f == 'C') {
                    LocalDataMgr.needUpdateCrowdAva(a, b, function (i) {
                        if (i) {
                            var h = User.getUserAvaCrowd() + a + '.png';
                            FileMgr.exists(null, h).then(function (j) {
                                if (j) {
                                    FileMgr.remove(null, h).then(function () {
                                        e.downCrowdAva(a, c, b, d)
                                    })
                                } else {
                                    e.downCrowdAva(a, c, b, d)
                                }
                            })
                        } else {
                            e.downCrowdAva(a, c, b, d)
                        }
                    })
                } else {
                    console.error('下载头像时没有匹配的chat_type')
                }
            }
        }
    },
    getLocalRctAvaUrl1: function (b, c, d, e) {
        if (Ext.isEmpty(b)) {
            return Ext.getResourcePath('images/imdefault.png')
        }
        var a = '';
        if (c == ChatType.Multi) {
            a = User.getChatAvaDir(d) + b + '.png'
        } else {
            if (c == ChatType.Direct) {
                a = User.getUserAvaDir() + b + '.png'
            }
        }
        FileMgr.exists(null, ConfigMgr.getDataDirectory() + a).then(function (f) {
            if (!f) {
                var a = Ext.getStore('comRct').getById(e);
                if (a) {
                    a.set({
                        isLocal: !1,
                        avaLoaded: !1
                    })
                }
            }
        });
        if (Config.isPC) {
            return 'local' + ConfigMgr.getDataDirectory() + a
        }
        return ConfigMgr.getDataDirectory() + a
    },
    getRctAvaHtml: function (c, a, b) {
        return '<a class="avatar link-avatar firstletter" letter="' + AvatarMgr.getFirstLetter(c) + '"  >\n                    <img src="' + ImgUtil.onePxImg + '" onload="AvatarMgr.onload(this)" style="display:none" ava-hash="' + a + '" ava-id="' + b + '">\n                </a>'
    },
    getRctAvaHtml1: function (e, d, f, a, c, b) {
        return '<a class="avatar link-avatar firstletter" letter="' + AvatarMgr.getFirstLetter(e) + '">\n                    <img src="' + ImgUtil.onePxImg + '" onload="AvatarMgr.onload1(this)" style="display:none" ava-hash="' + b + '" ava-id="' + d + '" chat-id="' + c + '" type="' + f + '" create-time="' + a + '">\n                </a>'
    },
    getMergeAva: function (a, b) {
        return '<div class="mergeAvatar" style="float:left;' + [AvatarMgr.getColorStyle(a)] + '">'
    },
    getMergeDiv: function (d) {
        if (Ext.isEmpty(d)) {
            return ''
        }
        var a = d.split(', '),
            c = a.length,
            b;
        if (c == 1) {
            b = this.insertTextToDiv(a[0].substr(0, 1))
        } else {
            if (c == 2) {
                b = this.insertTextToDiv(a[0].substr(0, 1) + ' ' + a[1].substr(0, 1))
            } else {
                if (c == 3) {
                    b = this.insertTextToDiv(a[0].substr(0, 1) + ' ' + a[1].substr(0, 1)) + this.insertTextToDiv(a[2].substr(0, 1))
                } else {
                    b = this.insertTextToDiv(a[0].substr(0, 1) + ' ' + a[1].substr(0, 1)) + this.insertTextToDiv(a[2].substr(0, 1) + ' ' + a[3].substr(0, 1))
                }
            }
        }
        return b
    },
    insertTextToDiv: function (a) {
        a = ParseUtil.trim(a);
        return '<div style="height:19px;line-height:19px;padding-left: 4px;">' + a + '</div>'
    },
    getFirstLetter: function (a) {
        if (Ext.isEmpty(a)) {
            return ''
        }
        if (a.length == 1) {
            return a
        }
        var b = a.substr(0, 1).toUpperCase(),
            c = a.substr(1, 1);
        if (!/[\u4E00-\u9FFF]/.test(b) && !/[\u4E00-\u9FFF]/.test(c)) {
            return b + c.toLowerCase()
        }
        return b
    },
    getUniqueColor: function (a) {
        if (Ext.isEmpty(a)) {
            return 'transparent'
        }
        var c = (Math.abs(Utils.hashCode(a)) % 13421772).toString(16),
            b = '#' + Ext.String.leftPad(c, 6, '0');
        return b
    },
    getColorStyle: function (b) {
        var a = this.getUniqueColor(b);
        return 'background-color:' + a + ';'
    },
    getChatAvaUrl: function (b, a) {
        var c = (new Date()).getTime();
        return Config.httpUrlForGo + '/chats/' + b + '/avatar?token=' + User.token + '&create_at=' + a + '&' + c
    },
    getCrowdAvaUrl: function (b, a) {
        var c = (new Date()).getTime();
        return Config.httpUrlForGo + 'chatcs/' + b + '/avatar?token=' + User.token + '&create_at=' + a + '&' + c
    },
    getUserAvaUrl: function (a) {
        var b = (new Date()).getTime();
        return Config.httpUrlForGo + '/users/' + a + '/avatar?token=' + User.token + '&' + b
    },
    downChatAva: function (b, d, a, c) {
        FileMgr.downFileForSrc(AvatarMgr.getChatAvaUrl(b, d), 1, User.getChatAvaDir(d) + b + '.png').then(function (e) {
            c(e.path);
            if (a && a != 'undefined' && a != 'null') {
                LocalDataMgr.doUpdateChatAva(b, a)
            }
        })['catch'](function (e) {
            c(AvatarMgr.getDefaultChatAva())
        })
    },
    downCrowdAva: function (b, d, a, c) {
        FileMgr.downFileForSrc(AvatarMgr.getCrowdAvaUrl(b, d), 1, User.getUserAvaCrowd() + b + '.png').then(function (e) {
            c(e.path);
            if (a && a != 'undefined' && a != 'null') {
                LocalDataMgr.doUpdateChatAva(b, a)
            }
        })['catch'](function (e) {
            c(AvatarMgr.getDefaultChatAva())
        })
    },
    downUserAva: function (b, d, a, c) {
        FileMgr.downFileForSrc(AvatarMgr.getUserAvaUrl(b), 1, User.getUserAvaDir() + b + '.png').then(function (e) {
            c(e.path);
            if (a && a != 'undefined' && a != 'null') {
                LocalDataMgr.doUpdateUserAva(b, a)
            }
        })['catch'](function (e) {
            c(AvatarMgr.getDefaultUserAva())
        })
    },
    getNavUserAvaUrlWOCache: function (c, b) {
        var a = ConfigMgr.getDataDirectory() + User.getUserAvaDir() + c + '.png?' + b;
        if (Config.isPC) {
            a = 'local' + a
        }
        return a
    },
    getNavUserAvaUrl: function (b) {
        var a = ConfigMgr.getDataDirectory() + User.getUserAvaDir() + b + '.png?' + User.cacheMil;
        if (Config.isPC) {
            a = 'local' + a
        }
        return a
    },
    getNavChatAvaUrl: function (c, b) {
        var a = ConfigMgr.getDataDirectory() + User.getChatAvaDir(b) + c + '.png?' + User.cacheMil;
        if (Config.isPC) {
            a = 'local' + a
        }
        return a
    },
    getNavCrowdUrl: function (b) {
        var a = ConfigMgr.getDataDirectory() + User.getUserAvaCrowd() + b + '.png?' + User.cacheMil;
        if (Config.isPC) {
            a = 'local' + a
        }
        return a
    },
    getIOSChatAvaUrl: function (b, d, c) {
        var a = '';
        if (c == 'D') {
            a = window.cordova.file.applicationStorageDirectory + 'tmp/' + User.getUserAvaDir() + b + '.png?' + User.cacheMil
        } else {
            if (c == 'C') {
                a = window.cordova.file.applicationStorageDirectory + 'tmp/' + User.getUserAvaCrowd() + b + '.png?' + User.cacheMil
            } else {
                a = window.cordova.file.applicationStorageDirectory + 'tmp/' + User.getChatAvaDir(d) + b + '.png?' + User.cacheMil
            }
        }
        return a
    },
    getDefaultUserAva: function () {
        return Ext.getResourcePath('images/userdefault.png')
    },
    getDefaultChatAva: function () {
        return Ext.getResourcePath('images/chatdefault.png')
    },
    getUserAvaHtml: function (a, f, e, d) {
        var h = this;
        var c = '';
        if (e) {
            c = 'small'
        }
        var b = '';
        if (d) {
            b = 'onload="AvatarMgr.loadUserAva(this)"'
        }
        var g = h.getNavUserAvaUrl(a);
        return '<a class="avatar link-avatar firstletter ' + c + ' loaded">\n                    <img src="' + g + '" ' + b + ' onerror="AvatarMgr.doUserAvaErr(this)" ava-id="' + a + '" hash="' + f + '">\n                </a>'
    },
    downloadUserAvatar: function (a) {
        var b = a.getAttribute('ava-id');
        if (!b) {
            a.src = this.getDefaultUserAva();
            return
        }
        if (window.cordova) {
            a.src = this.getDefaultUserAva()
        }
        this.downUserAva(b, 0, 0, function (b) {
            if (Config.isPC) {
                b = ParseUtil.getLocalFileURL(b)
            }
            a.src = b + '?' + User.cacheMil;
            a.removeAttribute('onerror')
        })
    },
    loadUserAva: function (a) {
        var c = a.getAttribute('ava-id');
        var b = a.getAttribute('hash');
        if (!c || !b || b == 'undefined' || b == 'null') {
            a.removeAttribute('onload');
            return
        }
        User.needUpdateUserAva(c, b, function (b) {
            a.src = b;
            a.removeAttribute('onload')
        })
    },
    doUserAvaErr: function (a) {
        var b = a.getAttribute('ava-id');
        var c = a.getAttribute('hash');
        if (!b) {
            a.src = this.getDefaultUserAva();
            return
        }
        if (window.cordova) {
            a.src = this.getDefaultUserAva()
        }
        this.downUserAva(b, 0, c, function (b) {
            if (Config.isPC) {
                b = ParseUtil.getLocalFileURL(b)
            }
            a.src = b + '?' + User.cacheMil;
            a.removeAttribute('onerror')
        })
    },
    getChatAvaHtml: function (b, a, g, f, e) {
        var i = this;
        var d = '';
        if (f) {
            d = 'small'
        }
        var c = '';
        if (e) {
            c = 'onload="AvatarMgr.loadChatAva(this)"'
        }
        var h = i.getNavChatAvaUrl(b, a);
        return '<a class="avatar link-avatar firstletter ' + d + ' loaded">\n                <img src="' + h + '" ' + c + ' onerror="AvatarMgr.doChatAvaErr(this)" ava-id="' + b + '" create-at="' + a + '" hash="' + g + '">\n            </a>'
    },
    getCrowdAvaHtml: function (b, a, g, f, e) {
        var i = this;
        var d = '';
        if (f) {
            d = 'small'
        }
        var c = '';
        if (e) {
            c = 'onload="AvatarMgr.loadCrowdAva(this)"'
        }
        var h = i.getNavCrowdUrl(b, a);
        return '<a class="avatar link-avatar firstletter ' + d + ' loaded">\n                <img src="' + h + '" ' + c + ' onerror="AvatarMgr.doCrowdAvaErr(this)" ava-id="' + b + '" create-at="' + a + '" hash="' + g + '">\n            </a>'
    },
    getcefCrowdAvaHtml: function (f, c, i, e, d) {
        var h = this;
        var b = '';
        if (e) {
            b = 'small'
        }
        var a = '';
        if (d) {
            a = 'onload="AvatarMgr.loadCrowdAva(this)"'
        }
        var g = h.getNavCrowdUrl(f, c);
        return '<a class="avatar link-avatar firstletter ' + b + ' loaded">\n                <img src="' + g + '" ' + a + ' onerror="AvatarMgr.getCefCrowdAva(this)" >\n            </a>'
    },
    loadChatAva: function (a) {
        var e = a.getAttribute('ava-id');
        var d = a.getAttribute('create-at');
        var b = a.getAttribute('hash');
        if (!e || !b || b == 'undefined' || b == 'null' || !d) {
            a.removeAttribute('onload');
            return
        }
        var c = a.getAttribute('src');
        c = c.split('?')[0];
        User.needUpdateChatAva(e, d, b, function (b) {
            if (c != b.split('?')[0]) {
                a.src = b
            }
            a.removeAttribute('onload')
        })
    },
    loadCrowdAva: function (a) {
        var e = a.getAttribute('ava-id');
        var d = a.getAttribute('create-at');
        var b = a.getAttribute('hash');
        if (!e || !b || b == 'undefined' || b == 'null' || !d) {
            a.removeAttribute('onload');
            return
        }
        var c = a.getAttribute('src');
        c = c.split('?')[0];
        User.needUpdateCrowdAva(e, d, b, function (b) {
            if (c != b.split('?')[0]) {
                a.src = b
            }
            a.removeAttribute('onload')
        })
    },
    doChatAvaErr: function (a) {
        var c = a.getAttribute('ava-id');
        var b = a.getAttribute('create-at');
        var d = a.getAttribute('hash');
        if (!c || !b || b == '0') {
            a.src = this.getDefaultChatAva();
            return
        }
        if (window.cordova) {
            a.src = this.getDefaultChatAva()
        }
        this.downChatAva(c, b, d, function (b) {
            if (Config.isPC) {
                b = ParseUtil.getLocalFileURL(b)
            }
            a.src = b + '?' + User.cacheMil;
            a.removeAttribute('onerror')
        })
    },
    doCrowdAvaErr: function (a) {
        var c = a.getAttribute('ava-id');
        var b = a.getAttribute('create-at');
        var d = a.getAttribute('hash');
        if (!c || !b || b == '0') {
            a.src = this.getDefaultChatAva();
            return
        }
        if (window.cordova) {
            a.src = this.getDefaultChatAva()
        }
        this.downCrowdAva(c, b, d, function (b) {
            if (Config.isPC) {
                b = ParseUtil.getLocalFileURL(b)
            }
            a.src = b + '?' + User.cacheMil;
            a.removeAttribute('onerror')
        })
    },
    getCefCrowdAva: function (b) {
        var c = User.cid;
        var a = (new Date()).getTime();
        var d = '';
        if (!c || !a || a == '0') {
            b.src = this.getDefaultChatAva();
            return
        }
        this.downCrowdAva(c, a, d, function (a) {
            if (Config.isPC) {
                a = ParseUtil.getLocalFileURL(a)
            }
            b.src = a + '?' + User.cacheMil;
            b.removeAttribute('onerror')
        })
    },
    parseUserAva: function (a, c) {
        var d = this;
        var b = '';
        if (c) {
            b = 'small'
        }
        return '<a class="avatar link-avatar firstletter ' + b + ' loaded">\n                    <img src="' + d.getNavUserAvaUrl(a) + '" onerror="AvatarMgr.showUserDefault(this)" ava-id="' + a + '">\n                </a>'
    },
    showUserDefault: function (a) {
        var b = a.getAttribute('ava-id');
        a.src = this.getDefaultUserAva();
        a.removeAttribute('onerror')
    },
    parseChatAva: function (a, d, c) {
        var e = this;
        var b = '';
        if (c) {
            b = 'small'
        }
        return '<a class="avatar link-avatar firstletter ' + b + ' loaded">\n                    <img src="' + e.getNavChatAvaUrl(a, d) + '" onerror="AvatarMgr.showChatDefault(this)" ava-id="' + a + '">\n                </a>'
    },
    parseCrowdAva: function (a, d, c) {
        var e = this;
        var b = '';
        if (c) {
            b = 'small'
        }
        return '<a class="avatar link-avatar firstletter ' + b + ' loaded">\n                    <img src="' + e.getNavCrowdUrl(a, d) + '" onerror="AvatarMgr.doCrowdAvaErr(this)" ava-id="' + a + '">\n                </a>'
    },
    showChatDefault: function (a) {
        a.src = this.getDefaultChatAva();
        a.removeAttribute('onerror')
    },
    setUrl: function (c, b) {
        if (b) {
            var a = b.split('?');
            if (a.length > 1) {
                a[1] = User.cacheMil
            } else {
                a.push(User.cacheMil)
            }
            b = a.join('?');
            c.src = b
        }
    }
}, 0, 0, 0, 0, 0, 0, [IMCommon.utils, 'AvatarMgr', 0, 'AvatarMgr'], 0);
Ext.cmd.derive('IMCommon.utils.AvatarUtil', Ext.Base, {
    singleton: !0,
    alternateClassName: 'AvatarUtil',
    load: function (a) {
        if (!a || !a.parentNode || !a.parentNode.parentNode) {
            return
        }
        var e = a.getAttribute('data-user'),
            f = a.hasAttribute('data-isname');
        if (Ext.isEmpty(e)) {
            return
        }
        var d = this._getIdBy(e, f);
        if (Ext.isEmpty(d)) {
            return
        }
        if (d == 'System') {
            a.parentNode.className += ' system'
        }
        a.removeAttribute('onload');
        if (Ext.browser.is.Cordova) {} else {
            var g = this.getAvatarUrl(d),
                b, c;
            b = function (d) {
                d.target.parentNode.className += ' loaded';
                d.target.style.removeProperty('display');
                d.target.removeEventListener('load', b, !1);
                d.target.removeEventListener('error', c, !1)
            };
            c = function (d) {
                d.target.parentNode.removeChild(d.target);
                d.target.removeEventListener('load', b, !1);
                d.target.removeEventListener('error', c, !1)
            };
            a.addEventListener('load', b, !1);
            a.addEventListener('error', c, !1);
            a.src = g
        }
    },
    _getIdBy: function (a, b) {
        if (Ext.isEmpty(a)) {
            return ''
        }
        if (b) {
            if (a == '系统') {
                return 'System'
            }
            return ''
        }
        return a
    },
    getAvatarHtml: function (a) {
        a = a || {};
        var e = a.idField || 'UserSign';
        var b = a.nameField || 'UserName';
        var f = a.cls || '';
        var c = a.title || '';
        var d = Ext.isEmpty(c) ? '' : ' title="' + c + '"';
        return ['<a class="avatar link-avatar firstletter ' + f + '" letter="{[AvatarMgr.getFirstLetter(values.' + b + ')]}" style="{[AvatarMgr.getColorStyle(values.' + b + ')]}" ' + d + '>', '<img src="{[ImgUtil.onePxImg]}" onload="AvatarMgr.load(this)" style="display:none" data-user="{' + e + '}" />', '</a>'].join('')
    },
    getAvatarHtmlByName: function (a) {
        return '<a class="avatar link-avatar firstletter " letter="' + AvatarMgr.getFirstLetter(a) + '" style="float:null;margin:auto;' + AvatarMgr.getColorStyle(a) + '" ></a>'
    },
    getAvatarUrl: function (a) {
        if (Ext.isEmpty(a)) {
            a = User.getUserID()
        }
        if (!Ext.isEmpty(a)) {
            return Utils.joinPath(config.httpUrl, 'Doc/Avatar.ashx?UserID=' + a)
        }
        return ''
    },
    getFirstLetter: function (a) {
        if (Ext.isEmpty(a)) {
            return ''
        }
        if (a.length == 1) {
            return a
        }
        var b = a.substr(0, 1).toUpperCase(),
            c = a.substr(1, 1);
        if (!/[\u4E00-\u9FFF]/.test(b) && !/[\u4E00-\u9FFF]/.test(c)) {
            return b + c.toLowerCase()
        }
        return b
    },
    getUniqueColor: function (a) {
        if (Ext.isEmpty(a)) {
            return 'transparent'
        }
        var c = (Math.abs(Utils.hashCode(a)) % 13421772).toString(16),
            b = '#' + Ext.String.leftPad(c, 6, '0');
        return b
    },
    getColorStyle: function (b) {
        var a = this.getUniqueColor(b);
        return 'background-color:' + a + ';'
    },
    getMergeDiv: function (d) {
        if (Ext.isEmpty(d)) {
            return ''
        }
        var a = d.split(', '),
            c = a.length,
            b;
        if (c == 1) {
            b = this.insertTextToDiv(a[0].substr(0, 1))
        } else {
            if (c == 2) {
                b = this.insertTextToDiv(a[0].substr(0, 1) + ' ' + a[1].substr(0, 1))
            } else {
                if (c == 3) {
                    b = this.insertTextToDiv(a[0].substr(0, 1) + ' ' + a[1].substr(0, 1)) + this.insertTextToDiv(a[2].substr(0, 1))
                } else {
                    b = this.insertTextToDiv(a[0].substr(0, 1) + ' ' + a[1].substr(0, 1)) + this.insertTextToDiv(a[2].substr(0, 1) + ' ' + a[3].substr(0, 1))
                }
            }
        }
        return b
    },
    insertTextToDiv: function (a) {
        return '<div style="height:19px;line-height:19px;padding-left: 4px;">' + a + '</div>'
    }
}, 0, 0, 0, 0, 0, 0, [IMCommon.utils, 'AvatarUtil', 0, 'AvatarUtil'], 0);
Ext.cmd.derive('IMCommon.utils.ChatUtil', Ext.Base, {
    singleton: !0,
    alternateClassName: 'ChatUtil',
    firstUnread: {},
    isFirst: !0,
    clear: function () {
        this.firstUnread = {}
    },
    doAutoLogin: function (h, f, e) {
        var a = this;
        var d = Ext.Viewport.getController();
        var g = window.VerControll.getAvailableLogin(!0),
            b, c;
        if (Config.newLoginWays) {
            if (Config.isPC) {
                b = JSON.parse(cefMain.getCurrentRouteConfigJsonStr());
                c = b.IsDemo;
                a.fromRouteID = b.RouteID;
                if (c == 'Y') {
                    a.fromRouteID = b.DemoRouteID
                }
            } else {
                b = Ext.decode(localStorage.getItem('currentRoute'));
                c = b.isDemo;
                a.fromRouteID = b.routeID;
                if (c == 'Y') {
                    a.fromRouteID = b.demoRouteID
                }
            }
        }
        if (Config.isPC || Config.isPhone) {
            g = window.VerControll.getAvailableLogin(!0)
        }
        Utils.custAjax('post', g, {
            params: JSON.stringify(h),
            success: function (b) {
                var c = !0;
                a.currentRouteID = null;
                if (b.server_version) {
                    c = d.compareServerVersion(b.server_version);
                    if (a.newRoute && Config.newLoginWays) {
                        if (Config.isPC) {
                            cefMain.selectRoute(a.newRoute.routeID, function (a) {
                                console.log(a)
                            })
                        } else {
                            window.RouteList.updateCurRoute(a.newRoute);
                            localStorage.setItem('newServerUrl', a.newRoute.routeUrl)
                        }
                    }
                }
                if (!c) {
                    Utils.toastShort('服务器版本低，请联系管理员或者切换其他账套');
                    d.doUnauthorized();
                    return
                }
                if (f) {
                    f(b)
                }
            },
            failure: function (d) {
                var b = window.RouteList.nextRoute(a.currentRouteID || a.fromRouteID, c, a.fromRouteID);
                if (b && Config.newLoginWays) {
                    a.currentRouteID = b.routeID;
                    a.newRoute = b;
                    Config.httpUrlForGo = Utils.joinPath(b.routeUrl, 'api/v1/');
                    Config.wsGoUrl = Utils.joinPath(b.routeUrl.replace('http', 'ws'), 'api/v1/websocket');
                    a.doAutoLogin(h, f, e)
                } else {
                    a.currentRouteID = null;
                    if (Ext.isFunction(e)) {
                        e(d)
                    }
                }
            },
            needUpdate: function (a) {
                d.needUpdate(a)
            }
        })
    },
    getUnreadPostsBySlice: function (d, c, b, a) {
        Utils.custAjax('post', 'chats/' + d + '/posts/unread', {
            params: JSON.stringify(c),
            success: function (e) {
                if (b) {
                    b(e)
                }
            },
            failure: function (e) {
                if (a) {
                    a(e)
                }
            }
        })
    },
    doTransmit: function (c, d, b, a) {
        Utils.custAjax('POST', 'posts/forward', {
            params: JSON.stringify({
                msg_id: c,
                chat_ids: d
            }),
            success: function (e) {
                LocalDataMgr.doTransmit(e, c);
                if (b) {
                    b(e)
                }
            },
            failure: function (e) {
                Utils.toastShort('转发失败：', e.message);
                if (a) {
                    a(e)
                }
            }
        })
    },
    doRevoke: function (a, d, c, b) {
        Utils.custAjax('POST', 'chats/' + a + '/posts/recall', {
            params: JSON.stringify(d),
            success: function (e) {
                LocalDataMgr.doRevoke(e, a);
                LocalDataMgr.revokeUpdateRct(a, e.msg_id, e.user_id, e.message, function () {
                    if (window.cefMain || Config.isPad || Ext.os.is.tablet) {
                        var h = Ext.getStore('comRct'),
                            f = h.getById(a);
                        var g = GroupNotice.getRevokeNotice(e.user_id, e.message);
                        if (f) {
                            f.set({
                                last_msg_type: MsgType.Revoke,
                                last_post_id: e.user_id,
                                last_post_msg: g
                            })
                        }
                    }
                });
                if (c) {
                    c(e)
                }
            },
            failure: function (e) {
                Utils.toastShort('撤回失败：', e.message);
                if (b) {
                    b(e)
                }
            }
        })
    },
    getChat: function (c, b, a) {
        Utils.custAjax('get', 'users/me/chats/' + c, {
            success: function (d) {
                LocalDataMgr.updateChat(d);
                if (b) {
                    b(d)
                }
            },
            failure: function (d) {
                if (a) {
                    a(d)
                }
            }
        })
    },
    getChatc: function (c, b, a) {
        Utils.custAjax('get', 'chatcs/' + c, {
            success: function (d) {
                var e = User.getUserAvaCrowd() + d.chat_id + '.png';
                FileMgr.exists(null, e).then(function (f) {
                    if (f) {
                        FileMgr.remove(null, e).then(function () {
                            User.doDownCrowdAva(d.chat_id, d.create_at, d.avatar_hash)
                        })
                    } else {
                        User.doDownCrowdAva(d.chat_id, d.create_at, d.avatar_hash)
                    }
                });
                LocalDataMgr.saveCrowdInfo(d, function (f, e) {});
                if (b) {
                    b(d)
                }
            },
            failure: function (d) {
                if (a) {
                    a(d)
                }
            }
        })
    },
    createDirectChat: function (c, a, d, b) {
        Utils.custAjax('post', 'chats/direct', {
            params: JSON.stringify([User.ownerID, c]),
            success: function (e) {
                User.crtChannelId = e.chat_id;
                User.crtChannelType = e.chat_type;
                User.chatMemID = '';
                var f = Ext.getStore('comRct').getById(e.chat_id);
                if (!f) {
                    if (Config.isPC) {
                        e.display_name = a;
                        e.unread_count = 0;
                        e.last_sender_id = User.ownerID;
                        e.last_sender_name = User.crtUser.user_name;
                        e.last_message = '';
                        LocalDataMgr.createDitChat(e)
                    }
                    AddDataUtil.addChannelToRecent(e, c, a, d)
                }
                if (b) {
                    b(e.chat_id)
                }
            },
            failure: function (e) {
                console.log(e)
            }
        })
    },
    createDirectChat2: function (a) {
        var b = User.chatMemID;
        Utils.custAjax('post', 'chats/direct', {
            params: JSON.stringify([User.ownerID, b]),
            success: function (b) {
                User.crtChannelId = b.chat_id;
                User.crtChannelType = b.chat_type;
                b.user_id = User.chatMemID;
                User.chatMemID = '';
                b.display_name = User.crtChatName;
                b.unread_count = 0;
                b.last_sender_id = User.ownerID;
                b.last_sender_name = User.crtUser.user_name;
                b.last_message = '';
                LocalDataMgr.createDitChat(b);
                if (a) {
                    a(b)
                }
            },
            failure: function (b) {
                console.log(b)
            }
        })
    },
    createGrpChat: function (b, a) {
        Utils.custAjax('post', 'chats/group', {
            params: JSON.stringify(b),
            success: a,
            failure: function (c) {
                console.log('创建多人会话失败', c)
            }
        })
    },
    setUnreadToRead: function (b, a) {
        Utils.custAjax('post', 'chats/members/' + User.ownerID + '/view', {
            params: JSON.stringify({
                chat_id: a
            }),
            success: function (d) {
                if (d.Status == 'OK') {
                    if (Config.needLocal) {
                        LocalDataMgr.rctSetUnreadToRead(a)
                    }
                    if (b) {
                        var c = b.getById(a);
                        if (c) {
                            if (AtUtil.useDB) {
                                c.set({
                                    'isUnRead': !1,
                                    'unReadNum': 0
                                })
                            } else {
                                c.set({
                                    'isUnRead': !1,
                                    'unReadNum': 0,
                                    'MentionCount': 0
                                });
                                if (window.cefMain) {
                                    AtUtil.doMsgViewAtBtn(User.crtChannelId, ViewGet.getMsgView())
                                }
                            }
                        }
                    }
                    PushNotification.resetBadgeNum()
                }
            }
        })
    },
    getNativeRct: function (a, b) {
        Utils.mask(a);
        LocalDataMgr.getRecentChat(function (k, j) {
            var g = j.rows,
                h = g.length;
            if (h > 0) {
                var i = a.getStore(),
                    f = [],
                    c = {};
                for (var d = 0; d < h; d++) {
                    c = g.item(d);
                    var e = c.UserID;
                    if (c.ChatType == ChatType.Multi) {
                        e = c.ChatID
                    }
                    try {
                        k.executeSql("Select * From IMMsg Where ChatID = '" + c.ChatID + "' Order By CreateAt Desc Limit 0,20", null, function (d, c) {}, function (d, c) {})
                    } catch (l) {}
                    f.push({
                        chat_id: c.ChatID,
                        create_at: c.CreateAt,
                        chat_status: c.ChatStatus,
                        name: c.DisplayName,
                        type: c.ChatType,
                        isUnRead: c.UnreadCount > 0,
                        unReadNum: c.UnreadCount,
                        last_post_at: new Date(c.LastPostAt),
                        last_post_id: c.LastUserID,
                        last_post_name: c.LastUserName,
                        last_msg_type: c.LastMsgType ? c.LastMsgType : '0',
                        last_post_msg: c.LastMessage,
                        avaID: e,
                        isLocal: !0,
                        toTop: c.IsTop == 'Y',
                        MentionCount: c.MentionCount,
                        IsMute: c.IsMute
                    })
                }
                i.add(f)
            }
            Utils.unMask(a);
            if (Ext.isFunction(b)) {
                b()
            }
        })
    },
    getLocalRct: function (a) {
        this.getNativeRct(a, function () {
            ChatUtil.getUnreadChats()
        })
    },
    getLocalRct2: function (a) {
        LocalDataMgr.getRecentChat(function (i, h) {
            var f = h.rows,
                g = f.length;
            if (g > 0) {
                var e = [],
                    b = {};
                for (var c = 0; c < g; c++) {
                    b = f.item(c);
                    var d = b.UserID;
                    if (b.ChatType == ChatType.Multi || b.ChatType == 'C') {
                        d = b.ChatID
                    }
                    e.push({
                        chat_id: b.ChatID,
                        create_at: b.CreateAt,
                        name: b.DisplayName,
                        type: b.ChatType,
                        chat_status: b.ChatStatus,
                        status: -2,
                        isUnRead: b.UnreadCount > 0,
                        unReadNum: b.UnreadCount,
                        last_post_at: new Date(b.LastPostAt),
                        last_post_id: b.LastUserID,
                        last_post_name: b.LastUserName,
                        last_msg_type: b.LastMsgType,
                        last_post_msg: b.LastMessage,
                        avaID: d,
                        isLocal: !0,
                        manager_id: b.ManagerID,
                        toTop: b.IsTop == 'Y',
                        atcount: b.MentionCount > 0 ? 1 : 0,
                        MentionCount: b.MentionCount,
                        IsMute: b.IsMute
                    })
                }
                a(e)
            } else {
                a([])
            }
        })
    },
    getSyncChats: function (b, a) {
        Utils.custAjax('GET', 'users/me/mute', {
            success: function (c) {
                AddDataUtil.bindSyncChats(c);
                LocalDataMgr.initUpdateSyncChats(c);
                if (Ext.isFunction(b)) {
                    b(c)
                }
            },
            failure: function (c) {
                if (Ext.isFunction(a)) {
                    a(c)
                }
            }
        });
        if (Config.isPhone) {
            Utils.custAjax('get', 'users/me/chatfavorites', {
                success: function (c) {
                    User.favChats = c
                }
            })
        }
        if (Config.isPC) {}
    },
    getUnreadChats: function (a) {
        this.getSyncChats();
        if (!ConfigMgr.isAio8()) {
            this.syncRctNewsChat()
        }
        this.getWorkDeskBadges();
        Utils.custAjax('GET', 'users/me/chats/unread', {
            success: function (b) {
                if (b) {
                    LocalDataMgr.initUpdateChats(b);
                    AddDataUtil.bindUnreadChats(b);
                    for (var c = 0; c < b.length; c++) {
                        if (b[c].chat.iscrowd == 'Y') {
                            ChatUtil.getChatc(b[c].chat.chat_id, function (c) {})
                        }
                    }
                }
                if (a) {
                    a()
                }
            }
        })
    },
    getWorkDeskBadges: function (a) {
        if (Config.isPC) {
            return
        }
        Utils.aioAjax('get', 'worktop/badge', {
            success: function (h) {
                var i = h.total_badge;
                var e = h.work_items;
                var c;
                if (Config.isPC) {} else {
                    var f = Ext.Viewport.down('IMMobile');
                    var j = f.getViewModel();
                    var d = f.down('IMMobile-WorkDesk');
                    c = d.getViewModel();
                    for (var b = 0; b < e.length; b++) {
                        var g = e[b];
                        c.getData()['module_' + g.item_type] = g.item_badge
                    }
                    j.setData({
                        wkBadgeNum: i
                    });
                    d.setBadge()
                }
                if (a) {
                    a()
                }
            },
            failure: function (b) {
                console.log(b)
            },
            judgeFn: ['verMailPush', 'verNoticePush']
        })
    },
    rctAfterOpenChat: function (c, b, a) {
        LocalDataMgr.getChatUpTime(c, function (h, g) {
            var d = g.rows,
                e = d.length;
            var f = 0;
            if (e > 0) {
                f = d.item(0).UpdateAt
            }
            if (a) {
                a(d.item(0).DisplayName)
            }
            Utils.custAjax('get', 'users/me/chats/' + c, {
                success: function (f, l) {
                    var j = Ext.getStore('comRct').getById(c);
                    if (j) {
                        var k = [];
                        if (l == '304') {
                            if (e > 0) {
                                var m = d.item(0);
                                k = ParseUtil.getMembersByLocalIDs(m.UserIDs);
                                j.set({
                                    members: k
                                }, {
                                    silent: !0
                                })
                            }
                        } else {
                            var i = '';
                            if (f.chat_type == ChatType.Direct) {
                                i = ParseUtil.getDctNameFromMems(f.members)
                            } else {
                                if (f.chat_type == ChatType.Multi) {
                                    i = f.header;
                                    if (f.iscrowd != 'Y') {
                                        User.needUpdateChatAva(f.chat_id, f.create_at, f.avatar_hash, function (m) {
                                            var e = Ext.Viewport.down('rctchatlist').mapToItem(j),
                                                i = e.el.query('img'),
                                                d = i[0],
                                                k = d.src;
                                            AvatarMgr.setUrl(d, k)
                                        })
                                    }
                                } else {
                                    if (f.chat_type == 'C') {
                                        i = f.header
                                    }
                                }
                            }
                            j.set({
                                name: i,
                                avaLoaded: !1,
                                avaHash: f.avatar_hash,
                                members: f.members
                            }, {
                                silent: !0
                            });
                            if (f.last_post_at) {
                                j.set('last_post_at', new Date(f.last_post_at))
                            }
                            LocalDataMgr.updateRctAndChat(f);
                            if (a) {
                                a(i)
                            }
                        }
                    }
                    if (b) {
                        b(!0, f)
                    }
                },
                failure: function () {
                    if (e > 0) {
                        var j = d.item(0);
                        var i = Ext.getStore('comRct').getById(c);
                        if (i) {
                            var f = [];
                            f = ParseUtil.getMembersByLocalIDs(j.UserIDs);
                            i.set({
                                members: f
                            }, {
                                silent: !0
                            })
                        }
                    }
                    if (b) {
                        b(!1, null)
                    }
                }
            }, !1, '&update_at=' + f)
        })
    },
    getHistory: function (b, d, e) {
        var c = this;
        c.doLastChat(e);
        var a = Ext.getStore(b);
        if (!a) {
            a = Ext.factory({
                storeId: b,
                model: 'IMCommon.model.Msg',
                isFirst: !0
            }, Ext.data.Store)
        }
        d.setStore(a);
        if (a.isFirst) {
            c.handleFirstIn(a, b, d);
            a.isFirst = !1
        } else {
            a.isFirst = !1;
            c.handleUnreadPic(a);
            c.handleUreadFile(a);
            c.doNowChat(b, d);
            User.isRefresh = !0;
            d.refresh();
            AddDataUtil.onScroll(d);
            User.isRefresh = !1
        }
        var f = Ext.getStore('comRct').getById(b).get('unReadNum');
        if (f) {
            c.setUnreadToRead(Ext.getStore('comRct'), b)
        }
    },
    getHistory2: function (a, e, f) {
        var c = this;
        c.handleFirstIn2(a, e, f);
        var b = Ext.getStore('comRct').getById(a);
        if (b) {
            var d = b.get('unReadNum');
            if (d) {
                c.setUnreadToRead(Ext.getStore('comRct'), a)
            }
        }
    },
    getRemoteHistory: function (b, a) {
        var c = this;
        LocalDataMgr.getLastMsgSeq(b, function (f, e) {
            var d = e.rows,
                c = 0;
            if (d.length > 0) {
                if (d.item(0).MsgSeq) {
                    c = d.item(0).MsgSeq
                }
            }
            Utils.custAjax('get', 'chats/' + b + '/posts/unread', {
                success: function (j) {
                    var d = j.message_list;
                    if (d && d.length > 0) {
                        var i = 0;
                        for (var g = 0; g < d.length; g++) {
                            if (d[g].wrapper_type == MsgWrapperType.Message) {
                                i = d[g].message.msg_seq;
                                a.remoteSeq = d[g].message.msg_seq;
                                break
                            }
                        }
                        if (i > c) {
                            a.removeAll()
                        }
                        AddDataUtil.bindAllMsg(d, a);
                        LocalDataMgr.initAddToMsg(d);
                        AddDataUtil.onScrolMsgView()
                    }
                    var h = j.recall_message_list;
                    if (h && h.length > 0) {
                        LocalDataMgr.initRevokeMsg(h)
                    }
                }
            }, '', '&from_seq=' + c)
        })
    },
    getSliceHistory: function (d, b, c, a) {
        if (b.length <= 0) {
            if (a) {
                a()
            }
            return
        }
        Utils.custAjax('post', 'chats/' + d + '/posts/unread', {
            params: JSON.stringify(b),
            success: function (g) {
                var e = g.message_list;
                if (e && e.length > 0) {
                    AddDataUtil.bindAllMsg(e, c);
                    LocalDataMgr.initAddToMsg(e)
                }
                var f = g.recall_message_list;
                if (f && f.length > 0) {
                    LocalDataMgr.initRevokeMsg(f)
                }
                if (a) {
                    a()
                }
            }
        })
    },
    doLastChat: function (b) {
        if (b) {
            var c = Ext.getStore(b),
                a = '';
            if (window.cefMain) {
                a = Ext.Viewport.lookup('IM').lookup('im-main').down('#richEditor')
            } else {
                if (Config.isPhone) {
                    a = Ext.Viewport.lookup('IMMobile').down('#chatview').down('#IMMobile-Editor')
                }
            }
            if (a) {
                c.editorVal = a.getValue();
                a.setValue('')
            }
        }
    },
    doNowChat: function (c, d) {
        var a = '',
            b = Ext.getStore(c);
        if (window.cefMain) {
            a = Ext.Viewport.lookup('IM').lookup('im-main').down('#richEditor')
        } else {
            if (Config.isPhone) {
                a = Ext.Viewport.lookup('IMMobile').down('#chatview').down('#IMMobile-Editor')
            }
        }
        if (b && b.editorVal && a) {
            a.setValue(b.editorVal)
        }
    },
    handleUnreadPic: function (d) {
        if (User.unReadPic.length > 0) {
            var c = [];
            for (var a = 0; a < User.unReadPic.length; a++) {
                var b = d.getById(User.unReadPic[a].msg_id),
                    e = ImgMgr.parsePic(User.unReadPic[a].attach_id, !0, User.unReadPic[a].height, User.unReadPic[a].width, '1', User.unReadPic[a].chat_id, User.unReadPic[a].create_at, User.unReadPic[a].extension, User.unReadPic[a].file_name);
                if (b && b.get('msg_type') == MsgType.ImgMsg) {
                    b.set('sendText', e)
                }
                c.push(a)
            }
            for (var a = 0; a < c.length; a++) {
                User.unReadPic.splice(a, 1)
            }
        }
    },
    handleUreadFile: function (e) {
        if (User.unReadFile.length > 0) {
            var b = [];
            for (var a = 0; a < User.unReadFile.length; a++) {
                var d = e.getById(User.unReadFile[a].msg_id);
                if (d) {
                    var c = User.unReadFile[a].size;
                    if (ConfigMgr.autoLoad(c) && window.cefMain) {
                        DownFileMgr.downloadFile(User.unReadFile[a].chat_id, User.unReadFile[a].attach_id, User.unReadFile[a].message, c, User.unReadFile[a].msg_id, User.unReadFile[a].create_at)
                    } else {
                        d.set('fileStatus', 4)
                    }
                }
                b.push(a)
            }
            for (var a = 0; a < b.length; a++) {
                User.unReadFile.splice(a, 1)
            }
        }
    },
    handleFirstIn: function (a, c, b) {
        if (!a) {
            return
        }
        var d = this;
        if (Config.isPC) {
            b.abortViewAPI = !0
        }
        LocalDataMgr.getHistory(function (k, j) {
            var e = j.rows;
            var h = 0;
            if (e.length > 0) {
                for (var g = 0; g < e.length; g++) {
                    if (e.item(g).MsgSeq >= 10000) {
                        h = e.item(g).MsgSeq;
                        break
                    }
                }
            }
            var f = ParseUtil.parseLocalMsg(e);
            if (f.length > 0) {
                a.add(f);
                AddDataUtil.onScroll(b);
                d.checkReadInfo(a, f)
            }
            var i = ParseUtil.judgeSlice(e);
            if (i.length > 0) {
                Utils.custAjax('post', 'chats/' + c + '/posts/unread', {
                    params: JSON.stringify(i),
                    success: function (m) {
                        var g = m.message_list;
                        var l = [];
                        if (g && g.length > 0) {
                            l = ParseUtil.parseRemoteMsg(g);
                            LocalDataMgr.initAddToMsg(g)
                        }
                        var e = ParseUtil.sortHistory(f.concat(l));
                        e = ParseUtil.objArrReduce(e, 'msg_id');
                        User.isMsgRemoveAll = !0;
                        a.removeAll();
                        a.add(e);
                        AddDataUtil.onScroll(b);
                        d.firstGetRemoteHis(c, e, h, a, b);
                        var i = m.recall_message_list;
                        if (i && i.length > 0) {
                            LocalDataMgr.initRevokeMsg(i)
                        }
                    },
                    failure: function () {
                        if (Config.isPC) {
                            b.abortViewAPI = !1
                        }
                    }
                })
            } else {
                d.firstGetRemoteHis(c, f, h, a, b)
            }
        }, 0, c)
    },
    handleFirstIn2: function (b, a, c) {
        var d = this;
        LocalDataMgr[c ? 'getHistoryFromMsgSeq' : 'getHistory'](function (k, j) {
            var f = j.rows;
            var h = 0;
            if (f.length > 0) {
                for (var g = 0; g < f.length; g++) {
                    if (f.item(g).MsgSeq >= 10000) {
                        h = f.item(g).MsgSeq;
                        break
                    }
                }
            }
            var e = ParseUtil.parseLocalMsg(f);
            var i = ParseUtil.judgeSlice(f);
            if (i.length > 0) {
                Utils.custAjax('post', 'chats/' + b + '/posts/unread', {
                    params: JSON.stringify(i),
                    success: function (l) {
                        var f = l.message_list;
                        var g = [];
                        if (f && f.length > 0) {
                            g = ParseUtil.parseRemoteMsg(f);
                            LocalDataMgr.initAddToMsg(f)
                        }
                        e = ParseUtil.sortHistory(e.concat(g));
                        a(e);
                        d.firstGetRemoteHis2(b, e.concat(g), h, a);
                        var i = l.recall_message_list;
                        if (i && i.length > 0) {
                            LocalDataMgr.initRevokeMsg(i)
                        }
                    },
                    failure: function () {
                        console.log('handleFirstIn2 ERR:', e);
                        a(e)
                    }
                })
            } else {
                a(e);
                d.firstGetRemoteHis2(b, e, h, a)
            }
        }, c || 0, b)
    },
    firstGetRemoteHis: function (a, f, e, d, b) {
        if (!e) {
            e = 0
        }
        var c = this;
        Utils.custAjax('get', 'chats/' + a + '/posts/unread', {
            success: function (g) {
                c.doUpBtnCache(a, g.first_unread);
                if (AtUtil.useDB) {
                    AtUtil.addMentionsInDB(a, g.mentions)
                } else {
                    AtUtil.addMentionsCache(a, g.mentions)
                }
                var i = g.message_list;
                var l = g.receipts;
                i.mentions = g.mentions;
                if (i && i.length > 0) {
                    var m = ParseUtil.parseRemoteMsg(i);
                    LocalDataMgr.initAddToMsg(i);
                    var h = ParseUtil.sortHistory(f.concat(m));
                    h = ParseUtil.objArrReduce(h, 'msg_id');
                    var j = [];
                    if (h.length > 20) {
                        j = h.slice(-20);
                        User.isMsgRemoveAll = !0;
                        d.removeAll()
                    } else {
                        if (h.length == 20) {
                            j = h
                        } else {
                            c.doTwentyHis(a, h, b, d)
                        }
                    }
                    d.add(j);
                    c.checkReadInfo(d, j);
                    AddDataUtil.onScroll(b)
                } else {
                    if (f.length < 20) {
                        c.doTwentyHis(a, f, b, d)
                    }
                }
                if (IMHelper.canUseReceipt() && l && l.length > 0) {
                    LocalDataMgr.updateMsgWithReceipt(l)
                }
                var k = g.recall_message_list;
                if (k && k.length > 0) {
                    LocalDataMgr.initRevokeMsg(k)
                }
            },
            failure: function () {},
            callback: function () {
                if (window.cefMain) {
                    b.abortViewAPI = !1;
                    c.doMsgUpBtn1(a);
                    if (AtUtil.useDB) {
                        AtUtil.showAtBtnInMsgView(a, b)
                    } else {
                        AtUtil.showMsgViewAtBtn(a, b)
                    }
                    var g = 0;
                    var i = ViewGet.getRctStore();
                    var h = i.getById(a);
                    if (h) {
                        g = h.get('unReadNum');
                        User.unReadNum[a] = g;
                        if (g > 0) {
                            ChatUtil.setUnreadToRead(i, a)
                        }
                    }
                    c.doReplyOpenChat()
                } else {
                    if (window.cefChat) {
                        b.abortViewAPI = !1;
                        if (Ext.isFunction(b.doFloatedBtn)) {
                            b.doFloatedBtn(a)
                        }
                        if (Ext.isFunction(b.doUnread)) {
                            b.doUnread()
                        }
                    }
                }
            }
        }, '', '&from_seq=' + e)
    },
    doReplyOpenChat: function () {
        var a = User.replyMsg;
        if (!a) {
            return
        }
        User.replyMsg = null;
        var e = a.chat_id,
            d = a.msg_id,
            c = parseInt(a.msg_seq, 10);
        if (User.popupChat[e]) {
            cefMain.execChatMethod(e, 'openReply', JSON.stringify({
                msg_id: d,
                msg_seq: c
            }));
            return
        }
        var b = ViewGet.getMsgView();
        b.doScrolToMsg(d, c, function (a) {
            b.isCodeScrol = !0;
            b.ensureVisible(a, {
                align: {
                    y: 'start'
                }
            });
            DesktopChatUtil.showReply(a)
        })
    },
    doTwentyHis: function (g, a, d, c) {
        var e = 0,
            b = [];
        var h = this;
        for (var f = 0; f < a.length; f++) {
            if (a[f].msgSeq && a[f].msgSeq >= 10000) {
                e = a[f].msgSeq;
                break
            }
        }
        if (e > 10000) {
            var i = 'SELECT * FROM IMMsg WHERE MsgSeq>=? AND MsgSeq<? AND ChatID=? ORDER BY MsgSeq DESC;';
            LocalDataMgr.cExecSqlWithP(i, [10000, e, g], function (n, f) {
                var m = f.rows;
                if (m.length > 0) {} else {
                    var k = a.length,
                        j = 20 - k,
                        i = e - 1 - j,
                        l = e - 1;
                    ChatUtil.getUnreadPostsBySlice(g, [{
                        from_seq: i,
                        to_seq: l
                    }], function (j) {
                        var e = j.message_list;
                        if (e && e.length > 0) {
                            LocalDataMgr.initAddToMsg(e);
                            var k = ParseUtil.parseRemoteMsg(e);
                            b = ParseUtil.sortHistory(a.concat(k));
                            b = ParseUtil.objArrReduce(b, 'msg_id');
                            c.add(b);
                            h.checkReadInfo(c, b)
                        } else {
                            c.add(a);
                            h.checkReadInfo(c, a);
                            if (window.cefMain) {
                                ChatUtil.doMsgUpBtn1(g)
                            } else {
                                if (window.cefChat) {
                                    if (Ext.isFunction(d.doFloatedBtn)) {
                                        d.doFloatedBtn(g)
                                    }
                                }
                            }
                        }
                        AddDataUtil.onScroll(d);
                        var i = j.recall_message_list;
                        if (i && i.length > 0) {
                            LocalDataMgr.initRevokeMsg(i)
                        }
                    }, function () {
                        c.add(a);
                        AddDataUtil.onScroll(d)
                    })
                }
            })
        } else {
            b = a;
            User.isMsgRemoveAll = !0;
            c.removeAll();
            c.add(b);
            AddDataUtil.onScroll(d)
        }
    },
    firstGetRemoteHis2: function (b, f, a, d) {
        var c = this;
        c.preLocalData = !0;
        if (!a) {
            a = 0
        }
        var e = [];
        Utils.custAjax('get', 'chats/' + b + '/posts/unread', {
            success: function (g) {
                var i = g.recall_message_list;
                if (i && i.length > 0) {
                    LocalDataMgr.initRevokeMsg(i)
                }
                if (AtUtil.useDB) {
                    AtUtil.addMentionsInDB(b, g.mentions)
                } else {
                    AtUtil.addMentionsCache(b, g.mentions)
                }
                var e = g.message_list,
                    j = [];
                if (e && e.length > 0) {
                    j = ParseUtil.parseRemoteMsg(e);
                    var l = 0;
                    for (var h = 0; h < e.length; h++) {
                        if (e[h].wrapper_type == MsgWrapperType.Message) {
                            l = e[h].message.msg_seq;
                            break
                        }
                    }
                    LocalDataMgr.initAddToMsg(e)
                }
                var k = ParseUtil.sortHistory(j);
                c.preLocalData = !1;
                d(k)
            },
            failure: function (c) {
                console.log('firstGetRemoteHis2 ERR', c)
            }
        }, '', '&from_seq=' + a)
    },
    doMsgUpBtn: function (a) {
        var h = this;
        var e = Ext.getStore(a),
            b = ViewGet.getMsgView().getViewModel();
        var c = User.unReadNum[a];
        if (c > 20) {
            var g = e.getAt(0);
            if (!g) {
                return
            }
            var i = g.get('updateTime');
            var n = 'SELECT * FROM IMMsg WHERE ChatID=? AND CreateAt<? ORDER BY CreateAt DESC LIMIT 1;';
            LocalDataMgr.cExecSqlWithP(n, [a, i], function (f, e) {
                var c = e.rows;
                var d = 1;
                if (c.length > 0) {
                    d = c.item(0).CreateAt
                }
                h.doShowMsgUpBtn(a, b, d)
            })
        } else {
            if (c > 0) {
                var d = e.getData().length - c;
                if (d < 0) {
                    return
                }
                var f = ViewGet.getMsgView(),
                    k = f.getScrollable().getScrollElement().dom;
                var l = k.scrollTop;
                var j = f.getRecordIndexFromPoint(0, l);
                if (d < j) {
                    var m = e.getAt(d).get('updateTime');
                    h.doShowMsgUpBtn(a, b, m)
                } else {
                    b.set('hideUpBtn', !0)
                }
            } else {
                b.set('hideUpBtn', !0)
            }
        }
    },
    doShowMsgUpBtn: function (c, a, b) {
        if (c != User.crtChannelId) {
            return
        }
        a.set({
            hideUpBtn: !1,
            upBtnTime: b
        })
    },
    doUpBtnCache: function (a, b) {
        if (a != User.crtChannelId) {
            return
        }
        if (Ext.isEmpty(b.msg_id)) {
            return
        }
        var c = this;
        var d = c.firstUnread[a];
        if (!d) {
            c.firstUnread[a] = b
        }
    },
    doMsgUpBtn1: function (b) {
        if (User.crtChannelId != b) {
            return
        }
        var e = this;
        var d = Ext.getStore(b);
        var c = ViewGet.getMsgView();
        var a = c.getViewModel();
        if (!d) {
            return
        }
        var g = e.firstUnread[b];
        if (!g) {
            a.set('hideUpBtn', !0);
            return
        }
        var f = d.getById(g.msg_id);
        if (!f) {
            a.set('hideUpBtn', !1)
        } else {
            var h = d.indexOf(f),
                i = c.getItemAt(h);
            if (e.msgInVisibleArea(i, c)) {
                a.set('hideUpBtn', !0);
                delete e.firstUnread[b]
            } else {
                a.set('hideUpBtn', !1)
            }
        }
    },
    msgInVisibleArea: function (d, a) {
        if (!d) {
            return !1
        }
        if (!a) {
            if (window.cefMain) {
                a = ViewGet.getMsgView()
            } else {
                return !1
            }
        }
        var c = d.getScrollableClientRegion(),
            b = a.getScrollableClientRegion();
        if (c.top - b.top > -5 && c.bottom - b.bottom < 5) {
            return !0
        }
        return !1
    },
    getLastedNewsFromServer: function (a, b, c) {
        Utils.custAjax('get', 'news/' + User.ownerID + '/unread', {
            success: function (e) {
                var d = ParseUtil.parseNewsFromServer(e);
                b(d)
            },
            failure: function () {
                console.log('ERRRRRRR');
                c()
            }
        }, '', '&from_seq=' + a)
    },
    syncRctNewsChat: function () {
        var a = Ext.getStore('comRct'),
            b = a.getById(StaticChatID.News);
        Utils.custAjax('get', 'news/' + User.ownerID + '/unread/count', {
            success: function (d) {
                if (!d.last_news || d.last_news.length == 0) {
                    return
                }
                var c = d.last_news[0];
                c.unReadNum = d.counts;
                if (!b) {
                    if (d.counts == 0) {
                        return
                    }
                    a.add({
                        chat_id: StaticChatID.News,
                        name: '消息中心',
                        type: ChatType.News,
                        last_post_at: new Date(c.create_at),
                        last_post_msg: c.title || c.description,
                        last_post_name: 'sys',
                        last_msg_type: c.news_type,
                        isUnRead: d.counts > 0 ? !0 : !1,
                        unReadNum: d.counts
                    });
                    LocalDataMgr.newsToLocalChat(c);
                    LocalDataMgr.newsToLocalRct(c)
                } else {
                    b.set({
                        last_post_at: new Date(c.create_at),
                        last_post_msg: c.title || c.description,
                        last_post_name: 'sys',
                        last_msg_type: c.news_type,
                        isUnRead: d.counts > 0 ? !0 : !1,
                        unReadNum: d.counts
                    });
                    LocalDataMgr.newsToUpdateRct(c)
                }
            },
            failure: function () {
                console.log('ERRRRRRR')
            }
        })
    },
    getMissNewsFromServer: function (b, a) {
        Utils.custAjax('post', 'news/' + User.ownerID + '/missing', {
            params: JSON.stringify(b),
            success: function (c) {
                if (c.length == 0) {
                    a([])
                }
                var d = ParseUtil.parseNewsFromServer(c);
                a(d)
            },
            failure: function () {
                console.log('ERRRRRRR')
            }
        })
    },
    getLocalNews: function (b, a) {
        LocalDataMgr.getLocalNews((new Date()).getTime(), 20, function (j, i) {
            var d = i.rows,
                e = [];
            if (d.length > 0) {
                for (var f = d.length - 1; f >= 0; f--) {
                    var c = d.item(f),
                        g = !0;
                    if (f < d.length - 1) {
                        if (ParseUtil.inOneMinute(d.item(f + 1).CreateAt, c.CreateAt)) {
                            g = !1
                        }
                    }
                    e.push({
                        showTime: g,
                        updateTime: c.CreateAt,
                        newsSeq: c.NewsSeq,
                        newsID: c.NewsID,
                        newsType: c.NewsType,
                        title: c.Title,
                        desc: c.Description,
                        picUrl: c.PicUrl,
                        desUrl: c.DescUrl,
                        isText: c.IsText,
                        extras: c.Extras,
                        creatorID: c.CreatorID
                    })
                }
                var h = ParseUtil.judgeNewsSlice(d);
                if (h.length > 0) {
                    ChatUtil.getMissNewsFromServer(h, function (d) {
                        var c = e.concat(d);
                        c = ParseUtil.sortHistory(c);
                        if (a) {
                            a(e)
                        }
                    })
                } else {
                    if (a) {
                        a(e)
                    }
                }
            } else {
                if (a) {
                    a(e)
                }
            }
        })
    },
    viewNews: function () {
        Utils.custAjax('put', 'news/' + User.ownerID + '/view', {
            success: function () {
                PushNotification.resetBadgeNum()
            },
            failure: function () {
                console.log('ERRRRRRR')
            }
        })
    },
    setcrowdNotice: function (a) {
        if (a == '' || a == null) {
            var b = '<div class="null_notice"></div>';
            Ext.ComponentQuery.query('#crowdNullnotice')[0].show();
            Ext.ComponentQuery.query('#crowdNotice')[0].hide()
        } else {
            Ext.ComponentQuery.query('#crowdNullnotice')[0].hide();
            Ext.ComponentQuery.query('#crowdNotice')[0].show();
            Ext.ComponentQuery.query('#crowdNotice')[0].setValue(a)
        }
    },
    getcrowdChatName: function (a) {
        var c = [];
        for (var b = 0; b < a.members.length; b++) {
            c.push(a.members[b].user_id)
        }
        var d = c.join(',');
        var e = 'UPDATE IMChat SET UserIDs=?,AvatarHash=?,ManagerID=? WHERE ChatID=?;';
        LocalDataMgr.cExecSqlWithP(e, [d, a.avatar_hash, a.manager_id, a.chat_id])
    },
    transMessage: function (c, a) {
        if (!c) {
            return
        }
        if (!a || a.length == 0) {
            return
        }
        for (var b = 0; b < a.length; b++) {
            if (User.popupChat[a[b]]) {
                cefMain.execChatMethod(a[b], 'transmit', JSON.stringify({
                    msgID: c
                }));
                continue
            }
            SendUtil.beforeSend(a[b]).then(function (b) {
                if (!Ext.isEmpty(b)) {
                    ChatUtil.doTransmit(c, [b], function (e) {
                        var h = Ext.getStore('comRct');
                        for (var d = 0; d < e.length; d++) {
                            var f = h.getById(e[d].chat_id);
                            if (f) {
                                f.set({
                                    last_post_at: new Date(e[d].create_at),
                                    last_post_id: User.ownerID,
                                    last_post_name: User.crtUser.user_name,
                                    last_msg_type: e[d].msg_type,
                                    last_post_msg: e[d].message
                                })
                            } else {
                                var i = e[d].chat_id;
                                var j = e[d].msg_type;
                                var g = e[d].message;
                                ChatUtil.showOldRct(i, j, g)
                            }
                        }
                    })
                }
            })
        }
    },
    transBigFile: function (c, a) {
        if (!c) {
            return
        }
        if (!a || a.length == 0) {
            return
        }
        for (var b = 0; b < a.length; b++) {
            if (User.popupChat[a[b]]) {
                cefMain.execChatMethod(a[b], 'transmit', JSON.stringify({
                    msgID: c
                }));
                continue
            }
            SendUtil.beforeSend(a[b]).then(function (b) {
                if (!Ext.isEmpty(b)) {
                    ChatUtil.doTransmit(c, [b], function (e) {
                        var h = Ext.getStore('comRct');
                        for (var d = 0; d < e.length; d++) {
                            var f = h.getById(e[d].chat_id);
                            if (f) {
                                f.set({
                                    last_post_at: new Date(e[d].create_at),
                                    last_post_id: User.ownerID,
                                    last_post_name: User.crtUser.user_name,
                                    last_msg_type: e[d].msg_type,
                                    last_post_msg: e[d].message
                                })
                            } else {
                                var i = e[d].chat_id;
                                var j = e[d].msg_type;
                                var g = e[d].message;
                                ChatUtil.showOldRct(i, j, g)
                            }
                            User.BfileMsgid = e[d].msg_id;
                            Utils.getApp().getCefObj().doTransferUpload(JSON.stringify({
                                chat_id: a[d],
                                chat_name: User.cefBfileinfo.chat_name,
                                user_id: User.cefBfileinfo.senderID,
                                user_name: User.cefBfileinfo.senderName,
                                msg_id: e[d].msg_id,
                                fetch_id: e[d].attach_id,
                                file_id: e[d].attach_id,
                                create_at: e[d].create_at,
                                file_path: User.cefBfileinfo.localPath,
                                path: User.cefBfileinfo.localPath,
                                extension: FileUtil.getExtension(User.cefBfileinfo.fileName),
                                file_name: User.cefBfileinfo.fileName,
                                file_size: User.cefBfileinfo.fileSize
                            }))
                        }
                    })
                }
            })
        }
    },
    transWorkFile: function (d, c, b) {
        if (!d) {
            return
        }
        if (!c) {
            return
        }
        if (!b || b.length == 0) {
            return
        }
        for (var a = 0; a < b.length; a++) {
            SendUtil.beforeSend(b[a]).then(function (g) {
                var e = [];
                if (ParseUtil.fileExists(c)) {
                    if (ConfigMgr.canUpload(d)) {
                        e.push({
                            path: c,
                            size: d,
                            type: MsgType.FileMsg
                        })
                    } else {
                        Ext.Msg.alert('提示', '您选择的文件中大于20兆的文件将不予发送，请通过大文件的方式进行发送')
                    }
                }
                if (e.length > 0) {
                    var f = [],
                        j = [];
                    var n = LocalDataMgr.newGuid();
                    var m = ParseUtil.getLocalTime(!0),
                        p = !1;
                    var h = FileUtil.getFileName(e[0].path);
                    h = ParseUtil.parseName(h);
                    f.push({
                        chatID: g,
                        chat_id: g,
                        localMsgID: n,
                        localPath: e[0].path,
                        fileSize: e[0].size,
                        fileStatus: 3,
                        fileName: h,
                        senderID: User.ownerID,
                        senderName: User.crtUser.user_name,
                        msg_type: MsgType.FileMsg,
                        updateTime: m,
                        sendStatus: 1,
                        ROL: 'right',
                        showTime: p,
                        isUpload: !0,
                        waitMsg: '等待上传...'
                    });
                    j.push({
                        chat_id: g,
                        msg_type: MsgType.FileMsg,
                        user_id: User.ownerID,
                        user_name: User.crtUser.user_name,
                        size: e[0].size,
                        path: e[0].path,
                        message: h
                    });
                    var q = [];
                    var i = e[0].type == MsgType.TextMsg ? e[0].value : e[0].path,
                        l = Ext.getStore('comRct');
                    if (l) {
                        var k = l.getById(g);
                        if (k) {
                            k.set({
                                last_post_msg: i,
                                last_msg_type: e[0].type,
                                last_post_at: new Date(m),
                                last_post_id: User.ownerID,
                                last_post_name: User.crtUser.user_name,
                                chat_id: g
                            })
                        } else {
                            var r = result[a].chat_id;
                            var s = result[a].msg_type;
                            var o = result[a].message;
                            ChatUtil.showOldRct(r, s, o)
                        }
                    }
                    LocalDataMgr.updateRctBySend(i, ParseUtil.getLocalTime(!0), g, e[0].type);
                    LocalDataMgr.execSendWrapperMsg(f, q);
                    SendUtil.doSendAPI(j, function (a) {
                        var e;
                        if (Config.isPC) {
                            if (User.crtChannelId == g) {
                                e = Ext.getStore(g);
                                e.add({
                                    chat_id: a[0].chat_id,
                                    msg_id: a[0].msg_id,
                                    msg_type: a[0].msg_type,
                                    senderID: a[0].user_id,
                                    senderName: User.getUserName(a[0].user_id),
                                    ROL: a[0].user_id == User.ownerID ? 'right' : '',
                                    updateTime: a[0].create_at,
                                    msgSeq: a[0].msg_seq,
                                    fileStatus: 0,
                                    fileSize: f[0].fileSize,
                                    fileName: f[0].fileName,
                                    localPath: f[0].localPath
                                });
                                AddDataUtil.onScrolMsgView();
                                SendUtil.doSendMsgsSuccess(f, a, e)
                            } else {
                                a[0].localPath = f[0].localPath;
                                UpFileMgr.pushFileToQue(a[0]);
                                LocalDataMgr.doSendFileSuccess(f[0], a[0])
                            }
                        }
                    }, function () {
                        SendUtil.doSendMsgsFail(f, msgStore)
                    })
                } else {
                    Utils.toastShort('您所选择的文件太大或已不存在')
                }
            })
        }
    },
    showOldRct: function (d, b, a) {
        var c = Ext.getStore('comRct');
        LocalDataMgr.hasChat(d, function (h, e) {
            if (h) {
                var g = e.ChatID;
                if (e.ChatType == ChatType.Direct) {
                    g = ParseUtil.getUserIDByDitChat(e.UserIDs)
                }
                var f = ParseUtil.getLocalTime(!0);
                c.insert(0, {
                    chat_id: e.ChatID,
                    create_at: e.CreateAt,
                    name: e.DisplayName,
                    type: e.ChatType,
                    isUnRead: !1,
                    unReadNum: 0,
                    last_post_at: new Date(f),
                    chatStatus: e.Status,
                    avaID: g,
                    IsMute: e.IsMute,
                    last_post_id: User.ownerID,
                    last_post_name: User.crtUser.user_name,
                    last_msg_type: b,
                    last_post_msg: a
                });
                LocalDataMgr.openChatByListFortrans(e, f, b, a)
            } else {
                Utils.custAjax('GET', 'users/me/chats/' + d, {
                    success: function (f) {
                        var i = ParseUtil.getLocalTime(!0);
                        var g = '',
                            j = f.chat_id;
                        if (f.chat_type == ChatType.Direct) {
                            j = f.members[0].user_id == User.ownerID ? f.members[1].user_id : f.members[0].user_id;
                            g = f.members[0].user_id == User.ownerID ? f.members[1].user_name : f.members[0].user_name
                        } else {
                            if (f.chat_type == ChatType.Multi) {
                                g = f.header
                            }
                        }
                        c.insert(0, {
                            chat_id: f.chat_id,
                            create_at: f.create_at,
                            name: g,
                            type: f.chat_type,
                            isUnRead: !1,
                            unReadNum: 0,
                            last_post_at: new Date(i),
                            chatStatus: '0',
                            avaID: j,
                            IsMute: f.is_mute,
                            last_post_id: User.ownerID,
                            last_post_name: User.crtUser.user_name,
                            last_msg_type: b,
                            last_post_msg: a
                        });
                        LocalDataMgr.openChatByChatNotHaveforTrans(f, i, g, b, a)
                    },
                    failure: function (c) {
                        Utils.toastShort(c)
                    }
                })
            }
        })
    },
    checkReadInfo: function (d, b) {
        var c = [];
        if (!IMHelper.canUseReceipt()) {
            return
        }
        for (var a = 0; a < b.length; a++) {
            var f = !1;
            var e = !1;
            if (b[a].msg_type == 'T' || b[a].msg_type == 'F' || b[a].msg_type == 'I' || b[a].msg_type == 'E' || b[a].msg_type == 'L') {
                f = !0
            }
            if (b[a].updateTime - (new Date()).getTime() < 2.592E9) {
                e = !0
            }
            if (b[a].senderID == User.ownerID && f && (b[a].unread_count != 0 || b[a].read_count == 0) && e) {
                c.push(b[a].msg_id)
            }
        }
        if (c.length > 0) {
            Utils.custAjax('post', 'chats/' + User.crtChannelId + '/posts/receipt', {
                params: JSON.stringify(c),
                success: function (a) {
                    if (a.length > 0) {
                        for (var c = 0; c < a.length; c++) {
                            d.findRecord('msg_id', a[c].msg_id).set('read_count', a[c].read_count);
                            d.findRecord('msg_id', a[c].msg_id).set('unread_count', a[c].unread_count)
                        }
                        LocalDataMgr.updateMsgWithReceipt(a)
                    }
                },
                failure: function (a) {}
            })
        }
    },
    sendScrollReadDetails: function () {
        var e;
        var d;
        var a;
        if (Config.isPC) {
            if (User.isMainFormActive == 'N') {
                return
            }
            if (window.cefMain) {
                e = ViewGet.getMsgView().getScrollable().getElement().getTop();
                d = ViewGet.getMsgView().getScrollable().getElement().getBottom();
                a = ViewGet.getMsgView()
            } else {
                e = Utils.getCmp('desktopChatView').lookup('desktopChatList').getScrollable().getElement().getTop();
                d = Utils.getCmp('desktopChatView').lookup('desktopChatList').getScrollable().getElement().getBottom();
                a = Utils.getCmp('desktopChatView').lookup('desktopChatList')
            }
        } else {
            e = Ext.Viewport.down('msgview').getScrollable().getElement().getTop();
            d = Ext.Viewport.down('msgview').getScrollable().getElement().getBottom();
            a = Ext.Viewport.down('msgview')
        }
        var c = [];
        var f = [];
        for (var b = a.innerItems.length - 1; b >= 0; b--) {
            var g = !1;
            if (a.innerItems[b].getRecord().data.msg_type == 'T' || a.innerItems[b].getRecord().data.msg_type == 'I' || a.innerItems[b].getRecord().data.msg_type == 'F' || a.innerItems[b].getRecord().data.msg_type == 'E' || a.innerItems[b].getRecord().data.msg_type == 'L') {
                g = !0
            }
            if (a.innerItems[b].el.getBottom() > e && a.innerItems[b].el.getTop() < d && a.innerItems[b].getRecord().data.senderID != User.ownerID && g) {
                f.push(a.innerItems[b].getRecord().data.msg_id)
            }
        }
        LocalDataMgr.findUnReadMsg(f, function (a) {
            for (var b = 0; b < a.length; b++) {
                if (Config.isPC) {
                    c.push({
                        msg_id: a[b],
                        user_id: Ext.getStore(User.crtChannelId).findRecord('msg_id', a[b]).data.senderID,
                        chat_id: User.crtChannelId,
                        device_type: User.devType
                    })
                } else {
                    var d = Ext.Viewport.down('msgview').getStore().findRecord('msg_id', a[b]);
                    if (d) {
                        c.push({
                            msg_id: a[b],
                            user_id: d.data.senderID,
                            chat_id: User.crtChannelId,
                            device_type: User.devType
                        })
                    }
                }
            }
            if (c.length > 0) {
                if (window.cefChat) {
                    cefChat.execWebMethod('mainSendReceipt', JSON.stringify(c))
                } else {
                    WebSocketUtil.sendMessage('setRead', JSON.stringify(c), function (b) {
                        LocalDataMgr.chgMsgToRead(a)
                    })
                }
            }
        })
    }
}, 0, 0, 0, 0, 0, 0, [IMCommon.utils, 'ChatUtil', 0, 'ChatUtil'], 0);
Ext.cmd.derive('IMCommon.utils.ConfigMgr', Ext.Base, {
    alternateClassName: 'ConfigMgr',
    singleton: !0,
    fileAutoLoadSize: 5 * 1024 * 1024,
    fileUpMaxSize: 20 * 1024 * 1024,
    orgShowRoot: 'N',
    maxMsgLength: 5000,
    oneSendMaxFileNum: 10,
    morningWorkTime: 1000 * 60 * 60 * 8,
    recentSearchNum: 5,
    msgCountInOnePage: 20,
    useAio8: 'N',
    getDataDirectory: function () {
        var a = '';
        if (window.cordova) {
            a = window.cordova.file.dataDirectory
        } else {
            a = Utils.getApp().getCefObj().getDataDirectory()
        }
        return a
    },
    getDefaultDir: function () {
        return this.getDataDirectory() + this.getSecDefaultDir()
    },
    getDefaultImgDir: function () {
        return this.getDataDirectory() + this.getSecDefaultDir() + 'images/'
    },
    getDefaultFileDir: function () {
        return this.getDataDirectory() + this.getSecDefaultDir() + 'files/'
    },
    getDefaultWorkTopFileDir: function () {
        return this.getDataDirectory() + this.getSecDefaultDir() + 'workTop/'
    },
    getSecDefaultDir: function () {
        return User.accountID + '/' + User.ownerID + '/'
    },
    autoLoad: function (a) {
        var b = ConfigMgr.fileAutoLoadSize;
        if (a <= b) {
            return !0
        }
        return !1
    },
    canUpload: function (a) {
        var b = ConfigMgr.fileUpMaxSize;
        if (a <= b) {
            return !0
        }
        return !1
    },
    showOrgRoot: function () {
        return ConfigMgr.orgShowRoot == 'Y'
    },
    isAio8: function () {
        return ConfigMgr.useAio8 === 'Y'
    },
    lessThanMaxSendLength: function (a) {
        if (!a) {
            return !0
        }
        if (a && a.length && a.length <= ConfigMgr.maxMsgLength) {
            return !0
        }
        return !1
    }
}, 0, 0, 0, 0, 0, 0, [IMCommon.utils, 'ConfigMgr', 0, 'ConfigMgr'], 0);
Ext.cmd.derive('IMCommon.utils.DesktopChatUtil', Ext.Base, {
    alternateClassName: 'DesktopChatUtil',
    singleton: !0,
    hasPopupChat: function () {
        if (window.cefMain) {
            if (Object.keys(User.popupChat).length > 0) {
                return !0
            }
        }
        return !1
    },
    hasPopupChatById: function (a) {
        if (User.popupChat[a]) {
            return !0
        }
        return !1
    },
    setWholeRest: function (a) {
        if (Config.isPC) {
            this.getCefObj().setWholeRest(a)
        }
    },
    getWholeRest: function () {
        return this.getCefObj().getWholeRest()
    },
    getCefObj: function () {
        return Utils.getApp().getCefObj()
    },
    supportBigFile: function () {
        return this.getCefObj().supportBigFile()
    },
    hideFormToCut: function () {
        if (this.getCefObj()) {
            this.getCefObj().captureNoWindow()
        }
    },
    openBFileForm: function () {
        this.getCefObj().showTransferForm()
    },
    setCopyPTData: function (c, b, a) {
        this.getCefObj().setCopyPTData(c, b, a)
    },
    capture: function () {
        this.getCefObj().capture()
    },
    captureNoWindow: function () {
        this.getCefObj().captureNoWindow()
    },
    showInformation: function (b, c) {
        var a = this;
        Utils.custAjax('get', 'users/' + b, {
            success: function (d) {
                if (d) {
                    d = ParseUtil.aio8UserInfoParser(d);
                    User.doUpdateUserAva(d.user_id, d.avatar_hash, function () {
                        a.getCefObj().showInformationForm(JSON.stringify(d), c);
                        d.mobile = a.getText(d.mobile);
                        d.notes = a.getText(d.notes);
                        d.email = a.getText(d.email);
                        LocalDataMgr.updateUserInfo(d);
                        User.updateUserCache(b, d)
                    })
                } else {
                    a.doUserCache(b, c)
                }
            },
            failure: function () {
                a.doUserCache(b, c)
            }
        })
    },
    getText: function (b) {
        var a = document.createElement('div');
        a.innerHTML = b;
        return a.innerText
    },
    doUserCache: function (c, b) {
        var a = User.getUserInfoByCache(c);
        if (a) {
            a.mobile = this.getText(a.mobile);
            a.notes = this.getText(a.notes);
            a.email = this.getText(a.email);
            var d = JSON.stringify(a);
            this.getCefObj().showInformationForm(d, b)
        } else {}
    },
    reDownBFile: function (a) {
        if (!a) {
            return
        }
        var b = a.get('start_index');
        if (!b) {
            b = 0
        }
        var c = a.get('attach_id') || a.get('file_id');
        this.getCefObj().doTransferReDownload(JSON.stringify({
            chat_id: a.get('chat_id'),
            chat_name: a.get('chat_name'),
            user_id: a.get('senderID'),
            user_name: a.get('senderName'),
            msg_id: a.get('msg_id'),
            fetch_id: c,
            file_id: c,
            create_at: a.get('updateTime'),
            extension: FileUtil.getExtension(a.get('fileName')),
            file_name: a.get('fileName'),
            file_size: a.get('fileSize'),
            size: a.get('fileSize'),
            start_index: b
        }), a.get('localPath'))
    },
    clearCefAtForm: function (a) {
        this.getCefObj().clearNotice(a)
    },
    openErpLink: function (d, b, c) {
        var a = this;
        a.getERPSession(function (e) {
            a.getCefObj().openLink1('' + d, b, c, e)
        })
    },
    openAio8Link: function (b) {
        var a = this;
        if (ConfigMgr.isAio8()) {
            a.getERPSession(function (c) {
                a.getCefObj().openAIO8Link(b, c)
            })
        }
    },
    openErpLinkInAio8: function (b) {
        var c = this;
        var a = b.content;
        if (a.startsWith('[ErpMsg]')) {
            c.openErpLinkFor75To8(b)
        } else {
            c.openAio8Link(a)
        }
    },
    openErpLinkFor75To8: function (b) {
        var d = this;
        var e = b.linkObjType;
        var f = b.link_stg_guid || b.linkStgGuid || '';
        var g = b.linkKeyString;
        var a = {};
        var h = g.split('&');
        h.forEach(function (d) {
            var c = d.split('=');
            if (c.length == 2) {
                a[c[0]] = c[1]
            }
        });
        for (var c in a) {
            if (a.hasOwnProperty(c)) {
                var i = a[c];
                a[c] = Utils.fromHex(i)
            }
        }
        d.getERPSession(function (c) {
            d.getCefObj().openAIO8LinkByInfo(c, JSON.stringify({
                CorpID: User.crtCorpID || cef.getCurrentCorpID(),
                ObjectID: e,
                KeyValues: JSON.stringify(a),
                StgGuid: f
            }))
        })
    },
    getERPSession: function (a) {
        Utils.custAjax('GET', 'users/' + User.ownerID + '/erpsession', {
            success: function (b) {
                if (Ext.isFunction(a)) {
                    a(b)
                }
            }
        })
    },
    fileExists: function (a) {
        return this.getCefObj().fileExist(a)
    },
    viewImages: function (b, a) {
        this.getCefObj.viewImages(b, a)
    },
    doBFileRevoke: function (a) {
        this.getCefObj().doBFileRevoke(a)
    },
    showTransferFormByType: function (a, b) {
        this.getCefObj().showTransferFormByType(a, b)
    },
    doPageRemoveMention: function (c, b) {
        var a;
        if (window.cefMain) {
            a = ViewGet.getMsgView()
        } else {
            if (window.cefChat) {
                a = Utils.getCmp('desktop_chatlist')
            }
        }
        if (a) {
            AtUtil.doPageRemoveMention(c, a, b)
        }
    },
    addNotice: function (a) {
        if (Config.isPC) {
            var h = Ext.getStore('comRct'),
                f = '0';
            if (h) {
                var g = h.getById(a.chat_id);
                if (g) {
                    f = g.get('unReadNum')
                }
            }
            var b = '';
            if (a.msg_type == MsgType.TextMsg) {
                b = a.message
            } else {
                if (a.msg_type == MsgType.ImgMsg) {
                    b = '[图片]'
                } else {
                    if (a.msg_type == MsgType.FileMsg) {
                        b = '[文件]'
                    } else {
                        if (a.msg_type == MsgType.LinkErp) {
                            b = '[erp链接]'
                        }
                    }
                }
            }
            var c = '';
            var e = '';
            if (a.chat_type == ChatType.Direct) {
                c = a.user_name;
                e = 'users/' + a.user_id + '.png'
            } else {
                if (a.chat_type == ChatType.Multi || a.chat_type == 'C') {
                    c = a.header + ': ' + a.user_name;
                    e = ParseUtil.getTimeMStr(a.chat_create_at) + a.chat_id + '.png'
                }
            }
            var d = {
                chat_id: a.chat_id,
                msg_id: a.msg_id,
                header: c,
                message: b,
                badge: f,
                create_at: a.create_at,
                chat_type: a.chat_type,
                sender: a.user_name,
                image_id: e
            };
            if (this.getWholeRest()) {
                return
            }
            if (a.showMention) {
                if (window.cefMain) {
                    if (User.crtChannelId == a.chat_id && User.isMainFormActive == 'Y') {} else {
                        this.showNotice(d)
                    }
                } else {
                    this.showNotice(d)
                }
                return
            }
            if (window.cefMain) {
                if (a.isMute == 'Y') {
                    return
                }
            } else {
                if (window.cefChat) {
                    var i = cefChat.getIsMute(a.chat_id);
                    if (i == 'Y') {
                        return
                    }
                }
            }
            this.doAddNotice(d)
        }
    },
    showNotice: function (a) {
        this.getCefObj().showNotice(JSON.stringify(a))
    },
    doAddNotice: function (a) {
        this.getCefObj().addNotice(JSON.stringify(a))
    },
    pushInfoToDom: function (a) {
        var d = a.MsgType;
        var b = 'type="' + d + '" ';
        switch (d) {
            case MsgType.TextMsg:
                break;
            case MsgType.ImgMsg:
                var c = this.getImgUrlByTN(a.FilePath, a.CreateAt);
                b += 'origin_path="' + c + '" fileName="' + a.FileName + '" createAt="' + a.CreateAt + '"';
                break;
            case MsgType.FileMsg:
                var c = ParseUtil.getAbsolutePath(a.FilePath);
                b += 'origin_path="' + c + '" fileName="' + a.FileName + '"';
                break;
            case MsgType.LinkErp:
                b += 'content="' + a.Content + '" linkObjType="' + a.LinkObjType + '" linkStgGuid="' + a.LinkStgGuid + '" linkKeyString="' + a.LinkKeyString + '" linkType="' + a.LinkType + '"';
                break;
            default:
                break;
        }
        return b
    },
    parseLoadedPic: function (f, g, e, b, d, c) {
        var a = this.getImgUrlByTN(e, b);
        a = ParseUtil.getLocalFileURL(a);
        return '<img class="msgRecord_img" src="' + a + '" create_at="' + b + '" fileName="' + d + '" fileID="' + c + '" >'
    },
    getImgUrlByTN: function (e, b) {
        var a = FileUtil.getFileName(e);
        var c = FileUtil.getExtension(a);
        if (!c) {
            a = a + '.png'
        }
        var f = ParseUtil.getTimeYMStr(b);
        var d = ConfigMgr.getDefaultDir() + 'images/' + f + a;
        return d
    },
    getImgDomAttr: function (c, a, b) {
        var d = this.getImgUrlByTN(c, a);
        return 'origin_path="' + d + '" fileName="' + b + '" createAt="' + a + '"'
    },
    doBindSendSetting: function (b) {
        var e = this;
        var a;
        if (window.cefMain) {
            a = ViewGet.getEditorView()
        } else {
            if (window.cefChat) {
                var c = Utils.getCmp('cefOneChat');
                if (c) {
                    a = c.down('#richEditor')
                }
            }
        }
        if (a) {
            var d = function (d) {
                if (d) {
                    if (window.cefMain) {
                        SendUtil.sendMsg(a, User.crtChannelId, Ext.getStore('comRct'), ViewGet.getMsgView())
                    } else {
                        if (window.cefChat) {
                            var c = Utils.getCmp('desktopChatView');
                            if (c) {
                                SendUtil.sendMsgWORct(a, User.crtChannelId, c.lookup('desktopChatList'))
                            }
                        }
                    }
                } else {
                    Utils.toastShort('不能发送空白消息')
                }
            };
            e.onChgEditorSendFunc(a, b, d)
        }
        this.doReplyEditor(b)
    },
    getSendFunc: function () {},
    doReplyEditor: function (e) {
        var b = DtPageCache.rightPages,
            a;
        for (var f in b) {
            a = b[f];
            if (a.xtype == 'desktopReply') {
                var c = a.lookup('reply_editor'),
                    d = function (b) {
                        if (b) {
                            SendUtil.sendReply(a, a.cid)
                        }
                    };
                this.onChgEditorSendFunc(c, e, d)
            }
        }
    },
    onChgEditorSendFunc: function (a, e, d) {
        var f = a.getPicker(),
            b = a.inputElement.dom;
        var c = '';
        switch (e) {
            case 'Ctrl+Enter':
                c = 'Ctrl+Enter';
                break;
            case 'Enter':
                c = 'Enter';
                break;
            default:
                break;
        }
        if (c) {
            a.setPlaceholder(c)
        }
        $(b).unbind('keydown');
        $(b).bind('keydown', function (c) {
            if (c.keyCode == 13) {
                if (!f.getHidden()) {} else {
                    if (e == 'Ctrl+Enter') {
                        a.setPlaceholder('Ctrl+Enter发送');
                        if (c.ctrlKey) {
                            d(b.value)
                        } else {
                            a._handleEnter(c)
                        }
                    } else {
                        a.setPlaceholder('Enter发送');
                        if (c.ctrlKey) {
                            a._handleEnter(c)
                        } else {
                            d(b.value)
                        }
                    }
                    return !1
                }
            }
            if (c.keyCode == 83) {
                if (c.altKey) {
                    d(b.value);
                    return !1
                }
            }
            if (c.keyCode == 67) {
                if (c.ctrlKey) {
                    var g = ParseUtil.getSelectedContents();
                    var h = ParseUtil.htmlToText(g);
                    DesktopChatUtil.getCefObj().setCopyPTData(h, g, function (b) {
                        if (!b) {
                            Utils.toastShort('复制出错了')
                        }
                    });
                    return !1
                }
            }
        })
    },
    parseGrpListCls: function (d) {
        var c = User.getUserInfoByCache(d);
        var a = 'gpl_grey_Female',
            b = !1;
        if (c.sex && c.sex == 'M') {
            a = 'gpl_grey_Male'
        }
        if (User.allStatus[d]) {
            var f = User.allStatus[d].pc_online,
                e = User.allStatus[d].mobile_online;
            if (c.sex && c.sex == 'F') {
                if (f == 'Y') {
                    b = !0;
                    a = 'gpl_ava_Female'
                } else {
                    if (e == 'Y') {
                        a = 'gpl_mobile_ava_Female';
                        b = !0
                    }
                }
            } else {
                if (f == 'Y') {
                    b = !0;
                    a = 'gpl_ava_Male'
                } else {
                    if (e == 'Y') {
                        a = 'gpl_mobile_ava_Male';
                        b = !0
                    }
                }
            }
        }
        return {
            cls: a,
            isOnline: b
        }
    },
    showMobile: function (d) {
        var a = User.allStatus[d];
        if (a) {
            var c = a.pc_online,
                b = a.mobile_online;
            if (c != 'Y' && b == 'Y') {
                return '<div class="gpl_mobile"></div>'
            }
        }
    },
    setStatus: function (a) {
        if (this.hasPopupChat()) {
            if (Ext.isObject(a)) {
                a = JSON.stringify(a)
            }
            this.getCefObj().setStatus(a)
        }
    },
    chgName: function (a, b) {
        return a + '将会话名修改为' + b
    },
    ditChatHeaderShowPD: function () {
        var a;
        if (window.cefMain) {
            a = ViewGet.getRctStore().getById(User.crtChannelId).get('avaID')
        } else {
            if (window.cefChat) {
                a = User.userID
            }
        }
        this.showInformation(a, 2)
    },
    mainViewOnTapJumpToMsg: function (b, c) {
        if (!b) {
            return
        }
        if (b != User.crtChannelId) {
            return
        }
        if (!c) {
            return
        }
        var a = Ext.getStore(b);
        if (!a) {
            return
        }
        var d = AddDataUtil.getCefMsgView();
        if (!d) {
            return
        }
        LocalSearchMgr.getHistoryContext(b, c, function (f, g) {
            a.removeAll();
            a.add(f);
            var e = a.findRecord('updateTime', c, 0, !1, !1, !0);
            if (e) {
                AddDataUtil.msgScrollToRecord(e, d)
            }
        })
    },
    doSearchHistoryAt: function (d, c, b, a) {
        Utils.custAjax('post', 'chats/' + User.crtChannelId + '/history', {
            params: JSON.stringify({
                chat_id: User.crtChannelId,
                user_ids: [d],
                history_at: c,
                is_origin: b
            }),
            success: function (e) {
                var i = User.userInfos[e.message].user_name,
                    f;
                f = '您已经修改了' + i + '可查看消息的时间';
                LocalDataMgr.getDB().transaction(function (g) {
                    var h = 'INSERT INTO IMMsg (MsgID, ChatID, MsgType, Content, CreateAt, Status, MsgSeq) VALUES (?,?,?,?,?,?,?);';
                    g.executeSql(h, [e.msg_id, e.chat_id, MsgType.GroupNotice, f, e.update_at, '0', e.msg_seq]);
                    var i = 'UPDATE IMRct SET LastMessage=?,LastMsgType=?,LastPostAt=? WHERE ChatID=?;';
                    g.executeSql(i, [f, MsgType.GroupNotice, e.update_at, e.chat_id])
                });
                if (!window.cefMsgMgr) {
                    var g = Ext.getStore('comRct').getById(e.chat_id);
                    if (g) {
                        g.set({
                            last_msg_type: MsgType.GroupNotice,
                            last_post_msg: '通知',
                            last_post_at: new Date(e.update_at)
                        })
                    }
                }
                if (User.crtChannelId == e.chat_id) {
                    var h = Ext.getStore(e.chat_id);
                    if (h) {
                        h.add({
                            msg_id: e.msg_id,
                            msgSeq: e.msg_seq,
                            updateTime: e.update_at,
                            GrpChangeMsg: f,
                            showGrpChange: !0
                        })
                    }
                }
                Ext.Viewport.down('list').time = '';
                a.hide();
                a.down('#groupDialog_list').getStore().removeAll();
                AddDataUtil.onScrolMsgView()
            },
            failure: function (e) {
                Ext.Msg.alert('温馨提示', '选择时间有误')
            }
        })
    },
    setMinWidthWoRight: function () {
        var a;
        if (window.cefMain) {
            a = ViewGet.getIMMainMinWidthView()
        } else {
            if (window.cefChat) {
                a = Utils.getCmp('im-main-minWidth-view')
            }
        }
        if (a) {
            var b = a.el.getWidth();
            a.setMinWidth(b)
        }
    },
    clearMinWidthWoRight: function () {
        var a;
        if (window.cefMain) {
            a = ViewGet.getIMMainMinWidthView()
        } else {
            if (window.cefChat) {
                a = Utils.getCmp('im-main-minWidth-view')
            }
        }
        if (a) {
            a.setMinWidth(0)
        }
    },
    toggleShowRightView: function (g, a, b) {
        DtPageCache.rightPages[g] = b;
        var d = this;
        if (window.cefMain) {
            var e = ViewGet.getMrdMainViewContainer(),
                c = ViewGet.getGrpMemsView();
            d.setMinWidthWoRight();
            e.add(b);
            b.show();
            if (a == ChatType.Multi) {
                c.hide()
            }
            if (a == 'C') {
                c.hide()
            }
            cefMain.toggleRight(a, 'Y', function () {
                d.clearMinWidthWoRight()
            })
        } else {
            if (window.cefChat) {
                var f = Utils.getCmp('desktopChatView'),
                    e = f.lookup('desktopChatMainContainer'),
                    c = f.lookup('desktopChatGrp');
                d.setMinWidthWoRight();
                e.add(b);
                b.show();
                if (a == ChatType.Multi) {
                    c.hide()
                }
                if (a == 'C') {
                    c.hide()
                }
                cefChat.toggleRight(a, 'Y', function () {
                    d.clearMinWidthWoRight()
                })
            }
        }
    },
    toggleHideRightView: function (g, b, e) {
        delete DtPageCache.rightPages[g];
        var c = this;
        if (window.cefMain) {
            var d = ViewGet.getMrdMainViewContainer(),
                a = ViewGet.getGrpMemsView();
            c.setMinWidthWoRight();
            cefMain.toggleRight(b, 'N', function () {
                c.clearMinWidthWoRight();
                d.remove(e, !0);
                if (b == ChatType.Multi) {
                    a.show()
                } else {
                    if (b == 'C') {
                        a.show()
                    } else {
                        a.hide()
                    }
                }
            })
        } else {
            if (window.cefChat) {
                var f = Utils.getCmp('desktopChatView'),
                    d = f.lookup('desktopChatMainContainer'),
                    a = f.lookup('desktopChatGrp');
                c.setMinWidthWoRight();
                cefChat.toggleRight(b, 'N', function () {
                    c.clearMinWidthWoRight();
                    d.remove(e, !0);
                    if (b == ChatType.Multi) {
                        a.show()
                    } else {
                        if (b == 'C') {
                            a.show()
                        } else {
                            a.hide()
                        }
                    }
                })
            }
        }
    },
    showRightViewWoToggle: function (d, b, c) {
        DtPageCache.rightPages[d] = b;
        var a;
        if (window.cefMain) {
            a = ViewGet.getMrdMainViewContainer()
        } else {
            if (window.cefChat) {
                a = Utils.getCmp('desktopChatView').lookup('desktopChatMainContainer')
            }
        }
        if (a) {
            a.remove(c, !0);
            a.add(b);
            b.show()
        }
    },
    showReply: function (c) {
        var a = User.crtChannelId;
        if (!a) {
            return
        }
        var e = User.crtChannelType;
        if (!e) {
            return
        }
        var f = c.get('msg_id');
        if (!f) {
            return
        }
        var g = this;
        var b = DtPageCache.rightPages[a],
            d;
        if (b) {
            if (b.xtype == 'desktopReply') {
                b.getController().imitateInit(a, c);
                if (b.getHidden()) {
                    DesktopChatUtil.toggleShowRightView(a, e, b)
                }
            } else {
                d = g.getReplyView(a, c, f);
                DesktopChatUtil.showRightViewWoToggle(a, d, b)
            }
        } else {
            d = g.getReplyView(a, c, f);
            DesktopChatUtil.toggleShowRightView(a, e, d)
        }
        if (window.cefMain) {
            ViewGet.getMrdBtn().setPressed(!1)
        } else {
            if (window.cefChat) {
                Utils.getCmp('desktopChat_input').down('#chatInput_mrd_btn').setPressed(!1)
            }
        }
    },
    getReplyView: function (b, d, e) {
        var a = Ext.create('IMCommon.view.desktop.reply.DesktopReply', {
            style: 'border-left: solid 1px #cfcfcf; width:300px;',
            cid: b,
            msgid: e
        });
        var c = a.getController();
        c.imitateInit(b, d);
        return a
    },
    clearReplyNotice: function (a) {
        this.getCefObj().clearReplyNotice(a)
    },
    showReplyNotice: function (a) {
        var b = JSON.stringify({
            chat_id: a.chat_id,
            msg_id: a.root_id,
            message: a.content,
            sender: a.user_name,
            image_id: 'users/' + a.user_id + '.png',
            msg_seq: a.msg_seq,
            create_at: a.create_at
        });
        this.getCefObj().showReplyNotice(b)
    },
    approveNotice: function (a) {
        var c = Ext.getResourcePath('images/LOGO1.png');
        var b = JSON.stringify({
            WddID: a.approveDatas.WddID,
            Version: a.approveDatas.Version,
            message: a.approveDatas.ReqObjName,
            ReleaseKey: a.approveDatas.ReleaseKey,
            ObjectID: a.approveDatas.ObjectID,
            header: '审批',
            sender: '系统',
            create_at: (new Date()).getTime(),
            image_id: c
        });
        cefMain.showApproveNotice(b)
    },
    defaults4UserSelForm: function (c, a) {
        var b = Ext.apply({
            fileFolder: ConfigMgr.getDataDirectory(),
            showOrgRoot: ConfigMgr.showOrgRoot(),
            corpId: User.crtCorpID,
            useAio8: ConfigMgr.useAio8
        }, c || {});
        User.cefBfileinfo = Ext.apply({}, a || {});
        this.getCefObj().showUserSelectorForm(JSON.stringify(b), JSON.stringify(User.cefBfileinfo))
    },
    updateUIForMultiChatHeader: function (a, b) {
        var c = this;
        c.updateUIForChatHeader(ChatType.Multi, a, b)
    },
    updateUIForChatHeader: function (e, f, g) {
        var d = Ext.Viewport.lookup('cefOneChat').down('#addMemsButton'),
            b = Ext.Viewport.lookup('cefOneChat').down('#directChatHeader'),
            a = Ext.Viewport.lookup('cefOneChat').down('#btnEdit'),
            c = Ext.Viewport.lookup('cefOneChat').down('#setCrowd');
        if (e == ChatType.Direct) {
            a.hide();
            c.hide();
            b.show();
            d.show()
        } else {
            if (e == ChatType.Multi) {
                b.hide();
                c.hide();
                if (f) {
                    d.hide()
                } else {
                    d.show()
                }
                var h = f ? 'dismiss' : '';
                a.show();
                a.setUi(h);
                a.setReadOnly(f || !g)
            } else {
                if (e == ChatType.Group) {
                    b.hide();
                    a.show();
                    c.show();
                    a.setReadOnly(!0)
                }
            }
        }
    },
    updateUIWithNotice: function (a, e, f, d, c) {
        var b = Ext.getStore(a);
        if (b) {
            b.add({
                msg_id: f,
                msgSeq: e,
                updateTime: c,
                GrpChangeMsg: d,
                showGrpChange: !0
            })
        }
        if (User.crtChannelId == a) {
            AddDataUtil.onScrolMsgView()
        }
    }
}, 0, 0, 0, 0, 0, 0, [IMCommon.utils, 'DesktopChatUtil', 0, 'DesktopChatUtil'], 0);
Ext.cmd.derive('IMCommon.utils.DesktopPageCache', Ext.Base, {
    singleton: !0,
    alternateClassName: 'DtPageCache',
    rightPages: {},
    clear: function () {
        this.rightPages = {}
    }
}, 0, 0, 0, 0, 0, 0, [IMCommon.utils, 'DesktopPageCache', 0, 'DtPageCache'], 0);
Ext.cmd.derive('IMCommon.utils.DownFileMgr', Ext.Base, {
    alternateClassName: 'DownFileMgr',
    singleton: !0,
    pushFileToQue: function (a, d, f, g, e, c) {
        var b = !1;
        if (!DownFileMgr[a]) {
            DownFileMgr[a] = [];
            b = !0
        }
        DownFileMgr[a].push({
            chat_id: a,
            attach_id: d,
            name: f,
            size: g,
            msg_id: e,
            create_at: c
        });
        if (b) {
            DownFileMgr.downloadFileA(DownFileMgr[a].shift())
        }
    },
    downloadFileA: function (a) {
        this.downloadFile(a.chat_id, a.attach_id, a.name, a.size, a.msg_id, a.create_at)
    },
    downloadFile: function (a, d, h, j, c, g) {
        if (!a) {
            return
        }
        if (!d) {
            return
        }
        if (!c) {
            return
        }
        var b = this;
        var i = DownFileMgr.getFullFileUrl(d),
            f = ParseUtil.getCFileDir(g),
            e = h;
        if (Ext.browser.is.Cordova || Config.isDesktop) {
            if (Config.isPhone) {
                e = encodeURIComponent(e)
            }
            FileMgr.solveDup(null, f, e).then(function (k) {
                var e = f + k;
                FileMgr.downFile(i, 1, e, {
                    downloading: function (e) {
                        b.setPageStus(a, c, {
                            fileStatus: 2,
                            fileProgress: e
                        })
                    },
                    slove: !0
                }).then(function (f) {
                    var e = f.path;
                    if (Config.isPhone) {
                        e = decodeURIComponent(e)
                    }
                    b.setPageStus(a, c, {
                        fileStatus: 0,
                        localPath: Config.isPC ? e : ParseUtil.parseRelativePath(e)
                    });
                    Utils.custAjax('get', 'files/' + d + '/info', {
                        success: function (b) {
                            b.chat_id = a;
                            b.msg_id = c;
                            LocalDataMgr.afterDownFileSuc(b, e)
                        },
                        failure: function (b) {
                            Utils.toastShort(b);
                            console.error('DownFileMgr', 'getFileInfo failed', b);
                            var e = 'UPDATE IMFile SET FileStatus=?, DeleteAt=? WHERE FileID=?;';
                            LocalDataMgr.cExecSqlWithP(e, [0, 0, d])
                        }
                    });
                    b.doQueueDown(a)
                })['catch'](function (e) {
                    console.error('DownFileMgr', 'downFile failed', e);
                    b.setPageStus(a, c, {
                        fileStatus: 1,
                        failMsg: '文件下载失败<a class="file_re_download">重新下载</a>'
                    });
                    b.doQueueDown(a)
                })
            })['catch'](function (e) {
                console.error('DownFileMgr', 'solveDup failed', e);
                b.setPageStus(a, c, {
                    fileStatus: 1,
                    failMsg: '文件插件处理错误<a class="file_re_download">重新下载</a>'
                });
                b.doQueueDown(a)
            })
        }
    },
    downFileForA: function (a) {
        this.pushFileToQue(a.chat_id, a.attach_id, a.fileName, a.fileSize, a.msg_id, a.updateTime)
    },
    getFullFileUrl: function (a) {
        return Config.httpUrlForGo + 'files/' + a
    },
    abortDownFile: function (b, c, e, d) {
        var g = this;
        var a = '';
        if (d) {
            UpFileMgr.abortUpFile(c, b);
            a = '<a class="file_re_upload">重新上传</a>'
        } else {
            var f = DownFileMgr.getFullFileUrl(c);
            FileMgr.abortDownFile(f);
            a = '<a class="file_re_download">重新下载</a>';
            this.doQueueDown(b)
        }
        g.setPageStus(b, e, {
            fileStatus: 1,
            failMsg: a
        })
    },
    setPageStus: function (f, e, d) {
        var a;
        if (Config.isPC || Config.isPad) {
            a = Ext.getStore(f)
        } else {
            if (User.crtChannelId == f) {
                var c = Ext.Viewport.lookup('IMMobile').down('#chatview').down('#msgView');
                if (c) {
                    a = c.getStore()
                }
            }
        }
        if (!a) {
            return
        }
        var b = a.getById(e);
        if (!b) {
            return
        }
        b.set(d);
        if (Config.isPhone) {
            c = Ext.Viewport.lookup('IMMobile').down('#chathistoryf');
            if (c) {
                a = c.down('#pageFile').getStore();
                if (!a) {
                    return
                }
                b = a.getById(e);
                if (!b) {
                    return
                }
                b.set(d)
            }
        }
    },
    doQueueDown: function (a) {
        if (DownFileMgr[a]) {
            var b = DownFileMgr[a].shift();
            if (b) {
                DownFileMgr.downloadFileA(b)
            } else {
                delete DownFileMgr[a]
            }
        }
    }
}, 0, 0, 0, 0, 0, 0, [IMCommon.utils, 'DownFileMgr', 0, 'DownFileMgr'], 0);
Ext.cmd.derive('IMCommon.utils.GroupNotice', Ext.Base, {
    alternateClassName: 'GroupNotice',
    singleton: !0,
    cNewGrpByStrs: function (e, d, g, f) {
        var c = g.split(','),
            h = f.split(',');
        var b = [];
        for (var a = 0; a < c.length; a++) {
            b.push({
                user_id: c[a],
                user_name: h[a]
            })
        }
        return this.createNewGrpNotice(e, b, d)
    },
    createNewGrpNotice: function (d, b, e) {
        var c = [];
        if (d == User.ownerID) {
            for (var a = 0; a < b.length; a++) {
                if (d != b[a].user_id) {
                    c.push(b[a].user_name)
                }
            }
            return '你邀请' + c.join('、') + '加入了多人会话'
        }
        for (var a = 0; a < b.length; a++) {
            if (d != b[a].user_id && User.ownerID != b[a].user_id) {
                c.push(b[a].user_name)
            }
        }
        return e + '邀请你和' + c.join('、') + '加入了多人会话'
    },
    cAddGrpByStrs: function (e, c, d, b) {
        var f = d.split(','),
            a = b.split(',');
        if (e == User.ownerID) {
            return this.meAddMemsByWS(a)
        }
        return this.otherAddMeByWS(c, f, a)
    },
    cMeAddMems: function (d, b) {
        var e = [];
        for (var c = 0; c < d.length; c++) {
            for (var a = 0; a < b.length; a++) {
                if (d[c] == b[a].user_id) {
                    e.push(b[a].user_name);
                    break
                }
            }
        }
        return '你邀请' + e.join('、') + '加入多人会话'
    },
    cAddMemsByWS: function (a) {
        var c = JSON.parse(a.user_ids),
            b = JSON.parse(a.user_names);
        if (a.operator_id == User.ownerID) {
            return this.meAddMemsByWS(b)
        }
        return this.otherAddMeByWS(a.operator_name, c, b)
    },
    meAddMemsByWS: function (a) {
        return '你邀请' + a.join('、') + '加入多人会话'
    },
    otherAddMeByWS: function (c, e, a) {
        var d = !1;
        for (var b = 0; b < e.length; b++) {
            if (e[b] == User.ownerID) {
                a.splice(b, 1);
                d = !0;
                break
            }
        }
        if (d) {
            var f = '';
            if (a.length > 0) {
                f = '和'
            }
            return c + '邀请你' + f + a.join('、') + '加入多人会话'
        }
        return c + '邀请' + a.join('、') + '加入多人会话'
    },
    chgName: function (a, b) {
        return a + '将会话名修改为' + b
    },
    removeMem: function (a, c, b, d) {
        if (a == b) {
            return '你退出了会话'
        }
        var e = a == User.ownerID ? '你' : c;
        var f = b == User.ownerID ? '你' : d;
        return e + '将' + f + '移出会话'
    },
    CrowdsetAdmin: function (g, f, i) {
        var a;
        var h = [];
        var d = [];
        var e = !1;
        var c = i.split(',');
        for (var b = 0; b < c.length; b++) {
            if (c[b] == 'A' || c[b] == 'R') {
                h.push(c[b])
            } else {
                d.push(User.getUserName(c[b]));
                if (c[b] == User.ownerID) {
                    e = !0
                }
            }
        }
        if (h[0] == 'A') {
            if (g == User.ownerID) {
                a = '你设置了' + d.join('、') + '为管理员'
            } else {
                if (e) {
                    a = '您被设置为管理员'
                } else {
                    a = f + '设置了' + d.join('、') + '为管理员'
                }
            }
        } else {
            if (g == User.ownerID) {
                a = '你撤销了' + d.join('、') + '的管理员'
            } else {
                if (e) {
                    a = '您被撤销了管理员'
                } else {
                    a = f + '撤销了' + d.join('、') + '的管理员'
                }
            }
        }
        return a
    },
    changeHisat: function (a) {
        if (a != User.ownerID) {
            return '你可以查看更多历史消息'
        }
    },
    chgMgr: function (d, b, c, a) {
        if (d == User.ownerID) {
            return '你将管理员转让给' + a
        }
        if (User.ownerID == c) {
            return b + '将管理员转让给你'
        }
        return b + '将管理员转让给' + a
    },
    getRevokeNotice: function (a, d) {
        var b = d.split(',');
        var c;
        if (b.length < 2) {
            if (a == User.ownerID) {
                c = '你撤回了一条消息'
            } else {
                c = User.getUserName(a) + '撤回了一条消息'
            }
        } else {
            if (b[1] == a && a == User.ownerID) {
                c = '你撤回了一条消息'
            } else {
                if (b[1] == a && a != User.ownerID) {
                    c = User.getUserName(a) + '撤回了一条消息'
                } else {
                    if (b[1] != a && a == User.ownerID) {
                        c = '你撤回了' + User.getUserName(b[1]) + '的一条消息'
                    } else {
                        if (b[1] != a && b[1] == User.ownerID) {
                            c = User.getUserName(a) + '撤回了你的一条消息'
                        } else {
                            if (b[1] != a && b[1] != User.ownerID && a != User.ownerID) {
                                c = User.getUserName(a) + '撤回了' + User.getUserName(b[1]) + '的一条消息'
                            }
                        }
                    }
                }
            }
        }
        return c
    },
    dismissMultiChat: function (b) {
        var a = '';
        if (b == User.ownerID) {
            a = '你解散了会话'
        } else {
            var c = User.getUserName(b);
            a = c + '解散了会话'
        }
        return a
    },
    recoverMultiChat: function (b) {
        var a = '';
        if (b == User.ownerID) {
            a = '你恢复了会话'
        } else {
            var c = User.getUserName(b);
            a = c + '恢复了会话'
        }
        return a
    },
    joinERPChat: function (b) {
        var a = '';
        if (b == User.ownerID) {
            a = '你加入了会话'
        } else {
            var c = User.getUserName(b);
            a = c + '加入了会话'
        }
        return a
    }
}, 0, 0, 0, 0, 0, 0, [IMCommon.utils, 'GroupNotice', 0, 'GroupNotice'], 0);
Ext.cmd.derive('IMCommon.utils.Helper', Ext.Base, {
    singleton: !0,
    alternateClassName: 'IMHelper',
    updateApp: function (a) {
        if (!Ext.browser.is.Cordova) {
            return
        }
        var d = this,
            b = Ext.Viewport;
        if (Ext.os.is.iOS) {} else {
            if (Ext.os.is.Android) {
                if (!a) {
                    Utils.mask(b)
                }
                var c = a ? null : function (c) {
                    Utils.unMask(b)
                };
                d._updateAndroid(a, c, c)
            }
        }
    },
    _updateAndroid: function (c, b, a) {
        var d = this;
        if (window.plugins && plugins.update) {
            plugins.update.updateApp(Config.upgradeUrl, function (d) {
                if (b) {
                    b.call(null, d)
                }
                if (d == 0 && !c) {
                    Utils.toastShort('已经是最新版本.')
                }
            }, a || Ext.emptyFn)
        } else {
            if (a) {
                a.call(null)
            }
        }
    },
    _updateIOS: function (c, b) {
        var a = this,
            d = Utils.getApp();
        Ext.Ajax.request({
            url: 'https://itunes.apple.com/lookup?id=' + Config.trackId,
            success: function (g, h) {
                var f = Ext.decode(g.responseText);
                if (f.results && f.results.length) {
                    var e = f.results[0];
                    if (a._wasNewVer(e.version, d.versionName)) {
                        Ext.Msg.show({
                            title: '新版本 v' + e.version,
                            message: a.htmlEncode(e.releaseNotes),
                            buttons: [{
                                text: '稍后再说',
                                itemId: 'cancel'
                            }, {
                                text: '立即去更新',
                                itemId: 'ok'
                            }],
                            promptConfig: !1,
                            fn: function (d) {
                                if (d == 'ok') {
                                    a.openLink(Config.appStore)
                                }
                            }
                        })
                    } else {
                        if (!c) {
                            Utils.toastShort('已经是最新版本.')
                        }
                    }
                }
            },
            failure: function (d, a) {
                console.log(d, a)
            },
            callback: b || Ext.emptyFn
        })
    },
    _wasNewVer: function (e, f) {
        var c = (e || '').split('.'),
            d = (f || '').split('.'),
            g = Math.max(c.length, d.length);
        for (var a = 0; a < g; a++) {
            var b = parseInt(c[a] || 0, 10) - parseInt(d[a] || 0, 10);
            if (b > 0) {
                return !0
            } else {
                if (b < 0) {
                    return !1
                }
            }
        }
        return !1
    },
    canUseReceipt: function () {
        if (User.useReceipt == 'Y') {
            return !0
        }
        return !1
    }
}, 0, 0, 0, 0, 0, 0, [IMCommon.utils, 'Helper', 0, 'IMHelper'], 0);
Ext.cmd.derive('IMCommon.utils.ImgMgr', Ext.Base, {
    alternateClassName: 'ImgMgr',
    singleton: !0,
    prefix: 'node-',
    spinner: '<div class="x-fa fa-spinner spin"></div>',
    gifSpinner: '<div class="x-fa fa-spinner img-tip-gif img-tip-gifPic"></div><div class="img-tip img-tip-gifPic">gif</div>',
    getDom: function (a) {
        return document.getElementById(a)
    },
    isInBody: function (a) {
        if (!a) {
            return !1
        }
        if (a.baseURI !== undefined) {
            return !Ext.isEmpty(a.baseURI)
        }
        return Ext.getBody().isAncestor(a)
    },
    loadAutomatic: function (a) {
        if (Ext.isEmpty(a)) {
            return
        }
        if (Ext.isString(a)) {
            a = this.getDom(a)
        }
        if (a) {
            if (a.hasAttribute('data-preview') && a.hasAttribute('data-original')) {
                this.loadPic(a)
            }
        }
    },
    parsePic: function (d, h, b, a, l, k, j, c, e) {
        var f = this;
        var i = f.getFullPicUrl(d + '_preview');
        var g = f.getFullPicUrl(d);
        if (!b) {
            b = 500
        }
        if (!a) {
            a = 400
        }
        if (!c) {
            c = FileUtil.getExtension(e)
        }
        return ['<div class="imgHolder-wrapper">', '<div class="imgHolder" style="width:' + a + 'px;padding-bottom: ' + (b * 100 / a).toFixed(4) + '%;">', '</div>', '</div>', '<div class="imgBlock">', '<img style="background:white;" attachID="' + d + '" fileName="' + e + '" extension="' + c + '" orgChatID="' + k + '" status="' + l + '" class="viewPic" src="' + ImgUtil.createHolder(a, b) + '" onload="ImgMgr.loadPic(this)" data-preview="' + i + '" data-original="' + g + '" _width="' + a + '" _height="' + b + '" ' + (h ? 'data-showpreview="Y"' : '') + ' create_at="' + j + '"/>', '</div>'].join('')
    },
    setPicIndex: function (a, b) {
        return ['<div class="imgHolder-wrapper">', '<div class="imgHolder" style="width:' + a + 'px;padding-bottom: ' + (b * 100 / a).toFixed(4) + '%;">', '</div>', '</div>', '<div class="imgBlock">', '<img style="background:white;" class="viewPic prepare-receive" src="' + ImgUtil.createHolder(a, b) + '" _width="' + a + '" _height="' + b + '"/>', '<div class="img-tip">', this.spinner, '</div>', '</div>'].join('')
    },
    loadPic: function (a) {
        var d = this;
        if (!a || !d.isInBody(a)) {
            return
        }
        var e = a.hasAttribute('data-showpreview'),
            o = a.hasAttribute('data-showprogress'),
            q = a.getAttribute('data-preview'),
            p = a.getAttribute('data-original'),
            n = a.getAttribute('attachID'),
            f = e ? q : p,
            r = parseInt(a.getAttribute('create_at'), 10),
            l = User.getImageDir() + ParseUtil.getTimeYMStr(r),
            k = FileUtil.getFileName(f);
        var h = a.getAttribute('status'),
            m = a.getAttribute('orgChatID'),
            b = a.getAttribute('extension');
        var j = k;
        if (!(b == 'undefined' || b == 'null')) {
            j = FileUtil.getFileNameWoExt(k) + '.' + b
        }
        a.removeAttribute('onload');
        d._setNodeTipText(a, d.spinner);
        if (Ext.browser.is.Cordova || Config.isDesktop) {
            var c = Ext.id(a, d.prefix);
            var g = l + j;
            var i = l + n + '.' + b;
            FileMgr.exists(1, i).then(function (k) {
                if (k) {
                    var j = k.nativeURL;
                    if (Config.isPC) {
                        j = ParseUtil.getLocalFileURL(j)
                    }
                    if (Ext.os.is.iOS) {
                        FileMgr.downFileForSrc(f, 1, i).then(function (b) {
                            ImgMgr._setNodeSrc(c, b.path, undefined)
                        })['catch'](function (b) {
                            console.error('ImgMgr', 'loadPic failed', b);
                            ImgMgr._setNodeSrc(c, '!error')
                        })
                    } else {
                        ImgMgr._setNodeSrc(c, j, undefined)
                    }
                } else {
                    FileMgr.downFileForSrc(f, 1, g, {
                        downloading: function (b) {
                            if (o) {
                                d._setNodeTipText(a, b + '%')
                            }
                        }
                    }).then(function (d) {
                        ImgMgr._setNodeSrc(c, d.path, undefined, e, b);
                        if (h && h != '0') {
                            if (!d.alreadyExists) {
                                if (m) {
                                    Utils.custAjax('get', 'files/' + n + '/info', {
                                        success: function (b) {
                                            b.chat_id = m;
                                            a.setAttribute('size', b.size);
                                            if (h == '2') {
                                                LocalDataMgr.afterDownGifSuc(b, g)
                                            } else {
                                                LocalDataMgr.afterUploadSuc(b, g, e ? 'Y' : 'N')
                                            }
                                        }
                                    })
                                }
                            }
                        }
                    })['catch'](function (b) {
                        console.error('ImgMgr', 'loadPic failed', b);
                        ImgMgr._setNodeSrc(c, '!error')
                    })
                }
            })
        } else {
            ImgMgr._setNodeSrc(a, f, undefined, e, b)
        }
    },
    _setNodeSrc: function (a, b, d, g, h) {
        if (Ext.isString(a) && !Ext.isEmpty(a)) {
            a = Ext.getDom(a)
        }
        if (!a) {
            return
        }
        if (d === undefined) {
            d = !0
        }
        var e = this;
        var c = function (i) {
            var f = i.target;
            f.className += ' loaded';
            f.style.removeProperty('background-color');
            f.removeAttribute('status');
            f.removeEventListener('load', c, !1);
            e._removeNodeTip(f);
            if (h == 'gif' && g && (Config.isPC || Config.isPad || Ext.os.is.Tablet)) {
                ImgMgr._setGifTip(a)
            }
        };
        var f = function (j) {
            var i = j.target;
            i.className += ' err';
            i.removeEventListener('load', c, !1);
            i.removeEventListener('error', f, !1);
            i.src = Ext.getResourcePath('images/failed.png');
            if ($(i.parentNode.previousSibling).hasClass('imgHolder-wrapper')) {
                i.parentNode.previousSibling.setAttribute('style', 'width: 63px;height: 48px;')
            }
            if (d) {
                e._setNodeTipText(i, i.getAttribute('data-errtip') || '')
            } else {
                e._removeNodeTip(i)
            }
        };
        a.addEventListener('load', c, !1);
        a.addEventListener('error', f, !1);
        if (Config.isDesktop && FileUtil.isFileUri(b)) {
            b = 'local' + b
        }
        if (a.src == b) {
            c({
                target: a
            })
        } else {
            a.src = b
        }
    },
    _setNodeTipText: function (b, c) {
        if (!b || !b.parentNode) {
            return
        }
        var a = b.parentNode.querySelector('.img-tip');
        if (!a) {
            a = document.createElement('div');
            a.className = 'img-tip';
            b.parentNode.insertBefore(a, null)
        }
        a.innerHTML = c
    },
    _removeNodeTip: function (a) {
        if (!a || !a.parentNode) {
            return
        }
        var b = a.parentNode.querySelector('.img-tip');
        if (b) {
            a.parentNode.removeChild(b)
        }
    },
    _setGifTip: function (b) {
        if (!b || !b.parentNode) {
            return
        }
        var a = b.parentNode.querySelector('.img-gif-tip');
        if (!a) {
            a = document.createElement('div');
            a.className = 'img-gif-tip';
            b.parentNode.insertBefore(a, null)
        }
        a.innerHTML = '<div class="img-tip-gif">GIF</div>'
    },
    _removeGifTip: function (a) {
        if (!a || !a.parentNode) {
            return
        }
        var b = a.parentNode.querySelector('.img-gif-tip');
        if (b) {
            a.parentNode.removeChild(b)
        }
    },
    getFullPicUrl: function (a) {
        return Config.httpUrlForGo + 'files/' + a
    },
    parseNewsPic: function (b, a, c) {
        var e = User.accURL.split('/');
        e.pop();
        var f = e.join('/'),
            k = '/News/NewsImage.ashx?ntf_img=',
            m = b.picUrl.replace('\\', '/');
        var j = f + k + Utils.toHex(m);
        var l = b.newsID,
            i = b.updateTime,
            d = b.picUrl,
            h = FileUtil.getExtension(d),
            g = j;
        if (!a) {
            a = 360
        }
        if (!c) {
            c = Math.round(a * 11 / 24)
        }
        return ['<img style="background-color: #efefef;width:100%;height:auto" newsID="' + l + '" fileName="' + d + '" extension="' + h + '" class="viewPic" src="' + ImgUtil.createHolder(a, c) + '" onload="ImgMgr.loadNewsPic(this)" data-original="' + g + '" create_at="' + i + '"/>'].join('')
    },
    loadNewsPic: function (a) {
        var c = this;
        var d = a.getAttribute('data-original'),
            j = a.getAttribute('fileName'),
            g = a.getAttribute('create_at'),
            i = a.getAttribute('newsID'),
            f = a.getAttribute('extension'),
            h = User.getImageDir() + ParseUtil.getTimeYMStr(g);
        a.removeAttribute('onload');
        if (Ext.browser.is.Cordova || Config.isDesktop) {
            var b = Ext.id(a, c.prefix);
            var e = h + i + '.' + f;
            c._setNodeTipText(a, c.spinner);
            FileMgr.exists(1, e).then(function (g) {
                if (g) {
                    var f = g.nativeURL;
                    if (Config.isPC) {
                        f = ParseUtil.getLocalFileURL(f)
                    }
                    if (Ext.os.is.iOS) {
                        FileMgr.downFileForSrc(d, 1, e).then(function (c) {
                            ImgMgr._setNodeSrc(b, c.path, undefined)
                        })['catch'](function (c) {
                            console.error('ImgMgr', 'loadPic failed', c);
                            ImgMgr._setNodeSrc(b, '!error')
                        })
                    } else {
                        ImgMgr._setNodeSrc(b, f, undefined)
                    }
                } else {
                    FileMgr.downFileForSrc(d, 1, e, {
                        downloading: function (b) {
                            c._setNodeTipText(a, b + '%')
                        }
                    }).then(function (c) {
                        ImgMgr._setNodeSrc(b, c.path, undefined)
                    })['catch'](function (c) {
                        console.error('ImgMgr', 'loadPic failed', c);
                        ImgMgr._setNodeSrc(b, '!error')
                    })
                }
            })
        } else {
            a.src = d
        }
    },
    getRemoteName: function (a) {
        if (Ext.isEmpty(a)) {
            return a
        }
        var b = FileUtil.getExtension(a);
        if (b) {
            b = '.' + b
        }
        return a.length + '_' + Utils.hashCode(a) + b
    },
    chooseImages: function () {
        return new Ext.Promise(function (a, c) {
            var b = Utils.getApp().getCefObj();
            if (b) {
                b.selectImages(function (b) {
                    Ext.each(b, function (d) {
                        if (!FileUtil.isFileUri(d.path)) {
                            d.path = 'file://' + d.path
                        }
                    });
                    a({
                        images: JSON.parse(b),
                        isOrigin: !0
                    })
                })
            } else {
                if (Ext.browser.is.Cordova) {
                    ImagePicker.getPictures(function (b) {
                        Ext.each(b.images, function (d) {
                            if (!FileUtil.isFileUri(d.path)) {
                                d.path = 'file://' + d.path
                            }
                        });
                        a(b)
                    }, c)
                }
            }
        })
    },
    takePhoto: function () {
        return new Ext.Promise(function (a, b) {
            if (Ext.browser.is.Cordova) {
                if (Ext.os.is.Android) {
                    ImagePicker.takePhoto(a, b)
                } else {
                    navigator.camera.getPicture(function (c) {
                        c = Utils.stripQueryStr(c);
                        $('<img src="' + c + '"/>').on('load', function () {
                            a({
                                images: [{
                                    path: c,
                                    width: this.naturalWidth,
                                    height: this.naturalHeight
                                }],
                                isOrigin: !1
                            })
                        })
                    }, b, {
                        quality: 50,
                        targetWidth: 800,
                        targetHeight: 800,
                        correctOrientation: !0,
                        destinationType: navigator.camera.DestinationType.FILE_URI,
                        sourceType: navigator.camera.PictureSourceType.CAMERA,
                        saveToPhotoAlbum: !0
                    })
                }
            }
        })
    },
    addViewerListener: function (a) {
        (a.innerElement || a.element).on({
            delegate: 'img',
            tap: 'showViewerOnTapImg',
            scope: this
        })
    },
    showViewerOnTapImg: function (a) {
        this.showViewerOfDom(a.target)
    },
    showViewerOfDom: function (a, b) {
        if (a.hasAttribute('data-original')) {
            var d = a.getAttribute('data-original'),
                c = a.hasAttribute('data-showpreview'),
                g = a.className.indexOf('loaded') >= 0,
                e = c && g ? a.src : null,
                h = FileUtil.getFileName(d),
                f = parseInt(a.getAttribute('create_at'), 10),
                i = b && b.size || a.getAttribute('data-original') ? b.size : 0;
            var j = Ext.Viewport.lookup('IMMobile');
            j.push({
                xtype: 'imgviewer',
                imgName: h,
                saveDir: User.getImageDir() + ParseUtil.getTimeYMStr(f),
                previewSrc: e,
                originNodeId: c ? null : Ext.id(a, this.prefix),
                src: d,
                imgSize: i
            })
        }
    },
    showViewerOfDom2: function (e, i) {
        var u = '.imgBlock',
            g = e.el.dom.querySelectorAll(u);
        var q = '.picIcon',
            k = e.el.dom.querySelectorAll(q);
        var c = 0,
            b = [];
        if (g.length > 0) {
            c = parseInt(i.getAttribute('create_at'), 10);
            for (var j = 0; j < g.length; j++) {
                var a = g[j].firstChild,
                    B = parseInt(a.getAttribute('create_at'), 10);
                var o = e.mapToRecord(a),
                    n = 0;
                if (o) {
                    n = o.data.fileSize
                }
                var p = a.getAttribute('data-original'),
                    l = a.hasAttribute('data-showpreview'),
                    w = a.className.indexOf('loaded') >= 0,
                    r = l && w ? a.src : null,
                    x = FileUtil.getFileName(p),
                    m = parseInt(a.getAttribute('create_at'), 10);
                b.push({
                    imgName: x,
                    saveDir: User.getImageDir() + ParseUtil.getTimeYMStr(m),
                    previewSrc: r,
                    originNodeId: l ? null : Ext.id(a, this.prefix),
                    src: p,
                    imgSize: n,
                    idx: m
                })
            }
        }
        if (i.getAttribute('data-recordindex')) {
            var s = i.getAttribute('data-recordindex');
            var t = e.dataItems[s].getRecord();
            c = t.data.updateTime;
            for (var h = 0; h < k.length; h++) {
                var A = k[h].closest('.x-listitem');
                var y = A.getAttribute('data-recordindex');
                var d = e.dataItems[y].getRecord();
                b.push({
                    imgName: FileUtil.getFileName(d.data.fileName),
                    saveDir: User.getImageDir() + ParseUtil.getTimeYMStr(d.data.updateTime),
                    previewSrc: null,
                    originNodeId: null,
                    src: Config.httpUrlForGo + 'files/' + d.data.attach_id,
                    imgSize: d.data.fileSize,
                    idx: d.data.updateTime
                })
            }
        }
        if (b.length > 0) {
            b.sort(function (a, b) {
                return a.idx - b.idx
            });
            for (var f = 0; f < b.length; f++) {
                var v = b[f];
                if (v.idx == c) {
                    c = f;
                    break
                }
            }
        }
        var z = Ext.Viewport.lookup('IMMobile');
        z.push({
            xtype: 'imgcarouselviewer',
            images: b,
            initialActiveIdx: c
        })
    }
}, 0, 0, 0, 0, 0, 0, [IMCommon.utils, 'ImgMgr', 0, 'ImgMgr'], 0);
Ext.cmd.derive('IMCommon.utils.LogUtil', Ext.Base, {
    alternateClassName: 'LogUtil',
    singleton: !0,
    writeLog: function (d, b) {
        if (Config.isDesktop) {
            var c = '语句：' + d + '\n 参数：';
            for (var a = 0; a < b.length; a++) {
                c += b[a] + ', '
            }
            Utils.getApp().getCefObj().writeLog(c + '\n\n')
        }
    },
    writeLogErr: function (c, b) {
        if (Config.isDesktop) {
            if (arguments.length == 1) {
                Utils.getApp().getCefObj().writeLogError(c)
            } else {
                var d = '语句：' + c + '\n 参数：';
                for (var a = 0; a < b.length; a++) {
                    d += b[a] + ', '
                }
                Utils.getApp().getCefObj().writeLogError(d + '\n\n')
            }
        }
    },
    writeFixVerLog: function (a, b, c) {
        if (Config.isDesktop) {
            Utils.getApp().getCefObj().writeLogError('更新FixVer成功：' + a + '，\n\n成功更新了' + b + '条数据，\n\n更新语句为' + c)
        }
    },
    writeFixVerLogErr: function (b, a, c) {
        if (Config.isDesktop) {
            Utils.getApp().getCefObj().writeLogError('更新FixVer失败：' + b + '，\n\n错误编码：' + a.code + '，错误信息：' + a.message + '，\n\n更新语句为' + c)
        }
    }
}, 0, 0, 0, 0, 0, 0, [IMCommon.utils, 'LogUtil', 0, 'LogUtil'], 0);
Ext.cmd.derive('IMCommon.utils.MimeType', Ext.Base, {
    alternateClassName: 'MimeType',
    singleton: !0,
    getMimeTypeByPath: function (a) {
        var b = FileUtil.getExtension(a);
        return this.getMimeType(b)
    },
    getMimeType: function (a) {
        a = (a || '').toLowerCase();
        return MimeType.m[a]
    },
    m: {
        323: 'text/h323',
        '3gp': 'video/3gpp',
        'aab': 'application/x-authoware-bin',
        'aam': 'application/x-authoware-map',
        'aas': 'application/x-authoware-seg',
        'acx': 'application/internet-property-stream',
        'ai': 'application/postscript',
        'aif': 'audio/x-aiff',
        'aifc': 'audio/x-aiff',
        'aiff': 'audio/x-aiff',
        'als': 'audio/X-Alpha5',
        'amc': 'application/x-mpeg',
        'ani': 'application/octet-stream',
        'apk': 'application/vndandroidpackage-archive',
        'asc': 'text/plain',
        'asd': 'application/astound',
        'asf': 'video/x-ms-asf',
        'asn': 'application/astound',
        'asp': 'application/x-asap',
        'asr': 'video/x-ms-asf',
        'asx': 'video/x-ms-asf',
        'au': 'audio/basic',
        'avb': 'application/octet-stream',
        'avi': 'video/x-msvideo',
        'awb': 'audio/amr-wb',
        'axs': 'application/olescript',
        'bas': 'text/plain',
        'bcpio': 'application/x-bcpio',
        'bin ': 'application/octet-stream',
        'bld': 'application/bld',
        'bld2': 'application/bld2',
        'bmp': 'image/bmp',
        'bpk': 'application/octet-stream',
        'bz2': 'application/x-bzip2',
        'c': 'text/plain',
        'cal': 'image/x-cals',
        'cat': 'application/vndms-pkiseccat',
        'ccn': 'application/x-cnc',
        'cco': 'application/x-cocoa',
        'cdf': 'application/x-cdf',
        'cer': 'application/x-x509-ca-cert',
        'cgi': 'magnus-internal/cgi',
        'chat': 'application/x-chat',
        'class': 'application/octet-stream',
        'clp': 'application/x-msclip',
        'cmx': 'image/x-cmx',
        'co': 'application/x-cult3d-object',
        'cod': 'image/cis-cod',
        'conf': 'text/plain',
        'cpio': 'application/x-cpio',
        'cpp': 'text/plain',
        'cpt': 'application/mac-compactpro',
        'crd': 'application/x-mscardfile',
        'crl': 'application/pkix-crl',
        'crt': 'application/x-x509-ca-cert',
        'csh': 'application/x-csh',
        'csm': 'chemical/x-csml',
        'csml': 'chemical/x-csml',
        'css': 'text/css',
        'cur': 'application/octet-stream',
        'dcm': 'x-lml/x-evm',
        'dcr': 'application/x-director',
        'dcx': 'image/x-dcx',
        'der': 'application/x-x509-ca-cert',
        'dhtml': 'text/html',
        'dir': 'application/x-director',
        'dll': 'application/x-msdownload',
        'dmg': 'application/octet-stream',
        'dms': 'application/octet-stream',
        'doc': 'application/msword',
        'docx': 'application/vndopenxmlformats-officedocumentwordprocessingmldocument',
        'dot': 'application/msword',
        'dvi': 'application/x-dvi',
        'dwf': 'drawing/x-dwf',
        'dwg': 'application/x-autocad',
        'dxf': 'application/x-autocad',
        'dxr': 'application/x-director',
        'ebk': 'application/x-expandedbook',
        'emb': 'chemical/x-embl-dl-nucleotide',
        'embl': 'chemical/x-embl-dl-nucleotide',
        'eps': 'application/postscript',
        'epub': 'application/epub+zip',
        'eri': 'image/x-eri',
        'es': 'audio/echospeech',
        'esl': 'audio/echospeech',
        'etc': 'application/x-earthtime',
        'etx': 'text/x-setext',
        'evm': 'x-lml/x-evm',
        'evy': 'application/envoy',
        'exe': 'application/octet-stream',
        'fh4': 'image/x-freehand',
        'fh5': 'image/x-freehand',
        'fhc': 'image/x-freehand',
        'fif': 'application/fractals',
        'flr': 'x-world/x-vrml',
        'flv': 'flv-application/octet-stream',
        'fm': 'application/x-maker',
        'fpx': 'image/x-fpx',
        'fvi': 'video/isivideo',
        'gau': 'chemical/x-gaussian-input',
        'gca': 'application/x-gca-compressed',
        'gdb': 'x-lml/x-gdb',
        'gif': 'image/gif',
        'gps': 'application/x-gps',
        'gtar': 'application/x-gtar',
        'gz': 'application/x-gzip',
        'h': 'text/plain',
        'hdf': 'application/x-hdf',
        'hdm': 'text/x-hdml',
        'hdml': 'text/x-hdml',
        'hlp': 'application/winhlp',
        'hqx': 'application/mac-binhex40',
        'hta': 'application/hta',
        'htc': 'text/x-component',
        'htm': 'text/html',
        'html': 'text/html',
        'hts': 'text/html',
        'htt': 'text/webviewhtml',
        'ice': 'x-conference/x-cooltalk',
        'ico': 'image/x-icon',
        'ief': 'image/ief',
        'ifm': 'image/gif',
        'ifs': 'image/ifs',
        'iii': 'application/x-iphone',
        'imy': 'audio/melody',
        'ins': 'application/x-internet-signup',
        'ips': 'application/x-ipscript',
        'ipx': 'application/x-ipix',
        'isp': 'application/x-internet-signup',
        'it': 'audio/x-mod',
        'itz': 'audio/x-mod',
        'ivr': 'i-world/i-vrml',
        'j2k': 'image/j2k',
        'jad': 'text/vndsunj2meapp-descriptor',
        'jam': 'application/x-jam',
        'jar': 'application/java-archive',
        'java': 'text/plain',
        'jfif': 'image/pipeg',
        'jnlp': 'application/x-java-jnlp-file',
        'jpe': 'image/jpeg',
        'jpeg': 'image/jpeg',
        'jpg': 'image/jpeg',
        'jpz': 'image/jpeg',
        'js': 'application/x-javascript',
        'jwc': 'application/jwc',
        'kjx': 'application/x-kjx',
        'lak': 'x-lml/x-lak',
        'latex': 'application/x-latex',
        'lcc': 'application/fastman',
        'lcl': 'application/x-digitalloca',
        'lcr': 'application/x-digitalloca',
        'lgh': 'application/lgh',
        'lha': 'application/octet-stream',
        'lml': 'x-lml/x-lml',
        'lmlpack': 'x-lml/x-lmlpack',
        'log': 'text/plain',
        'lsf': 'video/x-la-asf',
        'lsx': 'video/x-la-asf',
        'lzh': 'application/octet-stream',
        'm13': 'application/x-msmediaview',
        'm14': 'application/x-msmediaview',
        'm15': 'audio/x-mod',
        'm3u': 'audio/x-mpegurl',
        'm3url': 'audio/x-mpegurl',
        'm4a': 'audio/mp4a-latm',
        'm4b': 'audio/mp4a-latm',
        'm4p': 'audio/mp4a-latm',
        'm4u': 'video/vndmpegurl',
        'm4v': 'video/x-m4v',
        'ma1': 'audio/ma1',
        'ma2': 'audio/ma2',
        'ma3': 'audio/ma3',
        'ma5': 'audio/ma5',
        'man': 'application/x-troff-man',
        'map': 'magnus-internal/imagemap',
        'mbd': 'application/mbedlet',
        'mct': 'application/x-mascot',
        'mdb': 'application/x-msaccess',
        'mdz': 'audio/x-mod',
        'me': 'application/x-troff-me',
        'mel': 'text/x-vmel',
        'mht': 'message/rfc822',
        'mhtml': 'message/rfc822',
        'mi': 'application/x-mif',
        'mid': 'audio/mid',
        'midi': 'audio/midi',
        'mif': 'application/x-mif',
        'mil': 'image/x-cals',
        'mio': 'audio/x-mio',
        'mmf': 'application/x-skt-lbs',
        'mng': 'video/x-mng',
        'mny': 'application/x-msmoney',
        'moc': 'application/x-mocha',
        'mocha': 'application/x-mocha',
        'mod': 'audio/x-mod',
        'mof': 'application/x-yumekara',
        'mol': 'chemical/x-mdl-molfile',
        'mop': 'chemical/x-mopac-input',
        'mov': 'video/quicktime',
        'movie': 'video/x-sgi-movie',
        'mp2': 'video/mpeg',
        'mp3': 'audio/mpeg',
        'mp4': 'video/mp4',
        'mpa': 'video/mpeg',
        'mpc': 'application/vndmpohuncertificate',
        'mpe': 'video/mpeg',
        'mpeg': 'video/mpeg',
        'mpg': 'video/mpeg',
        'mpg4': 'video/mp4',
        'mpga': 'audio/mpeg',
        'mpn': 'application/vndmophunapplication',
        'mpp': 'application/vndms-project',
        'mps': 'application/x-mapserver',
        'mpv2': 'video/mpeg',
        'mrl': 'text/x-mrml',
        'mrm': 'application/x-mrm',
        'ms': 'application/x-troff-ms',
        'msg': 'application/vndms-outlook',
        'mts': 'application/metastream',
        'mtx': 'application/metastream',
        'mtz': 'application/metastream',
        'mvb': 'application/x-msmediaview',
        'mzv': 'application/metastream',
        'nar': 'application/zip',
        'nbmp': 'image/nbmp',
        'nc': 'application/x-netcdf',
        'ndb': 'x-lml/x-ndb',
        'ndwn': 'application/ndwn',
        'nif': 'application/x-nif',
        'nmz': 'application/x-scream',
        'nokia-op-logo': 'image/vndnok-oplogo-color',
        'npx': 'application/x-netfpx',
        'nsnd': 'audio/nsnd',
        'nva': 'application/x-neva1',
        'nws': 'message/rfc822',
        'oda': 'application/oda',
        'ogg': 'audio/ogg',
        'oom': 'application/x-AtlasMate-Plugin',
        'p10': 'application/pkcs10',
        'p12': 'application/x-pkcs12',
        'p7b': 'application/x-pkcs7-certificates',
        'p7c': 'application/x-pkcs7-mime',
        'p7m': 'application/x-pkcs7-mime',
        'p7r': 'application/x-pkcs7-certreqresp',
        'p7s': 'application/x-pkcs7-signature',
        'pac': 'audio/x-pac',
        'pae': 'audio/x-epac',
        'pan': 'application/x-pan',
        'pbm': 'image/x-portable-bitmap',
        'pcx': 'image/x-pcx',
        'pda': 'image/x-pda',
        'pdb': 'chemical/x-pdb',
        'pdf': 'application/pdf',
        'pfr': 'application/font-tdpfr',
        'pfx': 'application/x-pkcs12',
        'pgm': 'image/x-portable-graymap',
        'pict': 'image/x-pict',
        'pko': 'application/yndms-pkipko',
        'pm': 'application/x-perl',
        'pma': 'application/x-perfmon',
        'pmc': 'application/x-perfmon',
        'pmd': 'application/x-pmd',
        'pml': 'application/x-perfmon',
        'pmr': 'application/x-perfmon',
        'pmw': 'application/x-perfmon',
        'png': 'image/png',
        'pnm': 'image/x-portable-anymap',
        'pnz': 'image/png',
        'pot,': 'application/vndms-powerpoint',
        'ppm': 'image/x-portable-pixmap',
        'pps': 'application/vndms-powerpoint',
        'ppt': 'application/vndms-powerpoint',
        'pptx': 'application/vndopenxmlformats-officedocumentpresentationmlpresentation',
        'pqf': 'application/x-cprplayer',
        'pqi': 'application/cprplayer',
        'prc': 'application/x-prc',
        'prf': 'application/pics-rules',
        'prop': 'text/plain',
        'proxy': 'application/x-ns-proxy-autoconfig',
        'ps': 'application/postscript',
        'ptlk': 'application/listenup',
        'pub': 'application/x-mspublisher',
        'pvx': 'video/x-pv-pvx',
        'qcp': 'audio/vndqcelp',
        'qt': 'video/quicktime',
        'qti': 'image/x-quicktime',
        'qtif': 'image/x-quicktime',
        'r3t': 'text/vndrn-realtext3d',
        'ra': 'audio/x-pn-realaudio',
        'ram': 'audio/x-pn-realaudio',
        'rar': 'application/octet-stream',
        'ras': 'image/x-cmu-raster',
        'rc': 'text/plain',
        'rdf': 'application/rdf+xml',
        'rf': 'image/vndrn-realflash',
        'rgb': 'image/x-rgb',
        'rlf': 'application/x-richlink',
        'rm': 'audio/x-pn-realaudio',
        'rmf': 'audio/x-rmf',
        'rmi': 'audio/mid',
        'rmm': 'audio/x-pn-realaudio',
        'rmvb': 'audio/x-pn-realaudio',
        'rnx': 'application/vndrn-realplayer',
        'roff': 'application/x-troff',
        'rp': 'image/vndrn-realpix',
        'rpm': 'audio/x-pn-realaudio-plugin',
        'rt': 'text/vndrn-realtext',
        'rte': 'x-lml/x-gps',
        'rtf': 'application/rtf',
        'rtg': 'application/metastream',
        'rtx': 'text/richtext',
        'rv': 'video/vndrn-realvideo',
        'rwc': 'application/x-rogerwilco',
        's3m': 'audio/x-mod',
        's3z': 'audio/x-mod',
        'sca': 'application/x-supercard',
        'scd': 'application/x-msschedule',
        'sct': 'text/scriptlet',
        'sdf': 'application/e-score',
        'sea': 'application/x-stuffit',
        'setpay': 'application/set-payment-initiation',
        'setreg': 'application/set-registration-initiation',
        'sgm': 'text/x-sgml',
        'sgml': 'text/x-sgml',
        'sh': 'application/x-sh',
        'shar': 'application/x-shar',
        'shtml': 'magnus-internal/parsed-html',
        'shw': 'application/presentations',
        'si6': 'image/si6',
        'si7': 'image/vndstiwapsis',
        'si9': 'image/vndlgtwapsis',
        'sis': 'application/vndsymbianinstall',
        'sit': 'application/x-stuffit',
        'skd': 'application/x-Koan',
        'skm': 'application/x-Koan',
        'skp': 'application/x-Koan',
        'skt': 'application/x-Koan',
        'slc': 'application/x-salsa',
        'smd': 'audio/x-smd',
        'smi': 'application/smil',
        'smil': 'application/smil',
        'smp': 'application/studiom',
        'smz': 'audio/x-smd',
        'snd': 'audio/basic',
        'spc': 'application/x-pkcs7-certificates',
        'spl': 'application/futuresplash',
        'spr': 'application/x-sprite',
        'sprite': 'application/x-sprite',
        'sdp': 'application/sdp',
        'spt': 'application/x-spt',
        'src': 'application/x-wais-source',
        'sst': 'application/vndms-pkicertstore',
        'stk': 'application/hyperstudio',
        'stl': 'application/vndms-pkistl',
        'stm': 'text/html',
        'svg': 'image/svg+xml',
        'sv4cpio': 'application/x-sv4cpio',
        'sv4crc': 'application/x-sv4crc',
        'svf': 'image/vnd',
        'svh': 'image/svh',
        'svr': 'x-world/x-svr',
        'swf': 'application/x-shockwave-flash',
        'swfl': 'application/x-shockwave-flash',
        't': 'application/x-troff',
        'tad': 'application/octet-stream',
        'talk': 'text/x-speech',
        'tar': 'application/x-tar',
        'taz': 'application/x-tar',
        'tbp': 'application/x-timbuktu',
        'tbt': 'application/x-timbuktu',
        'tcl': 'application/x-tcl',
        'tex': 'application/x-tex',
        'texi': 'application/x-texinfo',
        'texinfo': 'application/x-texinfo',
        'tgz': 'application/x-compressed',
        'thm': 'application/vnderithm',
        'tif': 'image/tiff',
        'tiff': 'image/tiff',
        'tki': 'application/x-tkined',
        'tkined': 'application/x-tkined',
        'toc': 'application/toc',
        'toy': 'image/toy',
        'tr': 'application/x-troff',
        'trk': 'x-lml/x-gps',
        'trm': 'application/x-msterminal',
        'tsi': 'audio/tsplayer',
        'tsp': 'application/dsptype',
        'tsv': 'text/tab-separated-values',
        'ttf': 'application/octet-stream',
        'ttz': 'application/t-time',
        'txt': 'text/plain',
        'uls': 'text/iuls',
        'ult': 'audio/x-mod',
        'ustar': 'application/x-ustar',
        'uu': 'application/x-uuencode',
        'uue': 'application/x-uuencode',
        'vcd': 'application/x-cdlink',
        'vcf': 'text/x-vcard',
        'vdo': 'video/vdo',
        'vib': 'audio/vib',
        'viv': 'video/vivo',
        'vivo': 'video/vivo',
        'vmd': 'application/vocaltec-media-desc',
        'vmf': 'application/vocaltec-media-file',
        'vmi': 'application/x-dreamcast-vms-info',
        'vms': 'application/x-dreamcast-vms',
        'vox': 'audio/voxware',
        'vqe': 'audio/x-twinvq-plugin',
        'vqf': 'audio/x-twinvq',
        'vql': 'audio/x-twinvq',
        'vre': 'x-world/x-vream',
        'vrml': 'x-world/x-vrml',
        'vrt': 'x-world/x-vrt',
        'vrw': 'x-world/x-vream',
        'vts': 'workbook/formulaone',
        'wav': 'audio/x-wav',
        'wax': 'audio/x-ms-wax',
        'wbmp': 'image/vndwapwbmp',
        'wcm': 'application/vndms-works',
        'wdb': 'application/vndms-works',
        'web': 'application/vndxara',
        'wi': 'image/wavelet',
        'wis': 'application/x-InstallShield',
        'wks': 'application/vndms-works',
        'wm': 'video/x-ms-wm',
        'wma': 'audio/x-ms-wma',
        'wmd': 'application/x-ms-wmd',
        'wmf': 'application/x-msmetafile',
        'wml': 'text/vndwapwml',
        'wmlc': 'application/vndwapwmlc',
        'wmls': 'text/vndwapwmlscript',
        'wmlsc': 'application/vndwapwmlscriptc',
        'wmlscript': 'text/vndwapwmlscript',
        'wmv': 'audio/x-ms-wmv',
        'wmx': 'video/x-ms-wmx',
        'wmz': 'application/x-ms-wmz',
        'wpng': 'image/x-up-wpng',
        'wps': 'application/vndms-works',
        'wpt': 'x-lml/x-gps',
        'wri': 'application/x-mswrite',
        'wrl': 'x-world/x-vrml',
        'wrz': 'x-world/x-vrml',
        'ws': 'text/vndwapwmlscript',
        'wsc': 'application/vndwapwmlscriptc',
        'wv': 'video/wavelet',
        'wvx': 'video/x-ms-wvx',
        'wxl': 'application/x-wxl',
        'x-gzip': 'application/x-gzip',
        'xaf': 'x-world/x-vrml',
        'xar': 'application/vndxara',
        'xbm': 'image/x-xbitmap',
        'xdm': 'application/x-xdma',
        'xdma': 'application/x-xdma',
        'xdw': 'application/vndfujixeroxdocuworks',
        'xht': 'application/xhtml+xml',
        'xhtm': 'application/xhtml+xml',
        'xhtml': 'application/xhtml+xml',
        'xla': 'application/vndms-excel',
        'xlc': 'application/vndms-excel',
        'xll': 'application/x-excel',
        'xlm': 'application/vndms-excel',
        'xls': 'application/vndms-excel',
        'xlsx': 'application/vndopenxmlformats-officedocumentspreadsheetmlsheet',
        'xlt': 'application/vndms-excel',
        'xlw': 'application/vndms-excel',
        'xm': 'audio/x-mod',
        'xml': 'application/xml',
        'xmz': 'audio/x-mod',
        'xof': 'x-world/x-vrml',
        'xpi': 'application/x-xpinstall',
        'xpm': 'image/x-xpixmap',
        'xsit': 'text/xml',
        'xsl': 'text/xml',
        'xul': 'text/xul',
        'xwd': 'image/x-xwindowdump',
        'xyz': 'chemical/x-pdb',
        'yz1': 'application/x-yz1',
        'z': 'application/x-compress',
        'zac': 'application/x-zaurus-zac',
        'zip': 'application/zip',
        'json': 'application/json'
    }
}, 0, 0, 0, 0, 0, 0, [IMCommon.utils, 'MimeType', 0, 'MimeType'], 0);
Ext.cmd.derive('IMCommon.utils.ParseUtil', Ext.Base, {
    alternateClassName: 'ParseUtil',
    singleton: !0,
    htmlToText: function (b) {
        var a = document.createElement('div');
        a.innerHTML = b;
        if (Config.isPC) {
            return this.getEmojiText(a.innerHTML)
        }
        return a.innerText
    },
    getEmojiText: function (b) {
        var a = document.createElement('div');
        a.innerHTML = b;
        Ext.fly(a).query('img.emoji').forEach(function (a) {
            Ext.DomHelper.insertBefore(a, a.getAttribute('alt'), !1);
            a.parentNode.removeChild(a)
        });
        a.innerHTML = a.innerHTML.replace(/[\u200B]/gm, '');
        return a.innerText
    },
    textToHtml: function (c) {
        var b = document.createElement('div');
        b.innerText = c;
        var a = b.innerHTML.replace(/\t/g, '&nbsp;&nbsp;&nbsp;&nbsp;');
        a = a.replace(/\s/g, '&nbsp;');
        if (Config.isPC) {
            return window.minEmoji(a)
        }
        return a
    },
    textToHtmlWithoutEmoji: function (b) {
        var a = document.createElement('div');
        a.innerText = b;
        return a.innerHTML.replace(/\t/g, '&nbsp;&nbsp;&nbsp;&nbsp;').replace(/\s/g, '&nbsp;')
    },
    parseTextToHtml: function (a) {
        var b = this.textToHtml(a);
        return this.parseHyperLink(b)
    },
    parseHisTextToHtml: function (a) {
        var b = this.textToHtml(a);
        return b
    },
    parseHyperLink: function (e) {
        var f = Utils.regex.url,
            c = e.split('&nbsp;');
        for (var d = 0; d < c.length; d++) {
            if (c[d]) {
                var a = c[d].split('<br>');
                for (var b = 0; b < a.length; b++) {
                    if (a[b]) {
                        if (f.test(a[b])) {
                            a[b] = '<a href="' + a[b] + '" target="_blank">' + a[b] + '</a>'
                        }
                    }
                }
                c[d] = a.join('<br>')
            }
        }
        return c.join('&nbsp;')
    },
    parseHtmlToText: function (a) {
        return a.replace(/<\/?br[^>]*>/g, '\r\n').replace(/<\/?a[^>]*>/g, ' ').replace(/<div[^>]*>/g, '').replace(/<\/div[^>]*>/g, '\r\n').replace(/&nbsp;?/g, ' ').replace(/<\/?span[^>]*>/gi, '').replace(/&lt;/gi, '<').replace(/&gt;/gi, '>').replace(/&amp;/gi, '&')
    },
    parseltgt: function (a) {
        return a.replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\r\n/g, '<br>').replace(/\n/g, '<br>').replace(/\s/g, '&nbsp;')
    },
    parseltgtToLM: function (a) {
        return a.replace(/&lt;/g, '<').replace(/&gt;/g, '>')
    },
    parseLMToltgt: function (a) {
        return a.replace(/</g, '&lt;').replace(/>/g, '&gt;')
    },
    parsePic: function (a, h) {
        var g = this,
            f = a.isUpload;
        if (f) {
            var b = '',
                d = a.localPath;
            if (Config.isPC) {
                d = g.getLocalFileURL(a.localPath)
            }
            var e = a.height || 400,
                c = a.width || 500;
            switch (a.fileStatus) {
                case 0:
                    b = '<img src="' + d + '" class="viewPic loaded" data-original="' + a.localPath + '" fileName="' + a.fileName + '" create_at="' + a.updateTime + '">';
                    break;
                case 1:
                    b = ['<img src="' + d + '" class="viewPic loaderr" data-original="' + a.localPath + '" _width="' + c + '" _height="' + e + '" fileName="' + a.fileName + '">', '<div class="img-tip">上传失败</div>'].join('');
                    break;
                case 2:
                    b = ['<img src="' + d + '" class="viewPic loading" data-original="' + a.localPath + '" _width="' + c + '" _height="' + e + '" fileName="' + a.fileName + '">', '<div class="img-tip">', ImgMgr.spinner, '</div>', '<div class="img-tip img-tip-percent" style="font-size:20px;top:60%">' + a.fileProgress + '%</div>'].join('');
                    break;
                case 3:
                    UpImgMgr.upFileForSrc(a);
                    b = ['<img src="' + d + '" class="viewPic loading" data-original="' + a.localPath + '" _width="' + c + '" _height="' + e + '" fileName="' + a.fileName + '">', '<div class="img-tip">', ImgMgr.spinner, '</div>', '<div class="img-tip img-tip-percent" style="font-size:20px;top:60%">' + a.fileProgress + '%</div>'].join('');
                    break;
                case -1:
                    b = ['<img src="' + d + '" class="viewPic sendImgerr" data-original="' + a.localPath + '" _width="' + c + '" _height="' + e + '" fileName="' + a.fileName + '">', '<div class="img-tip">发送失败</div>'].join('');
                    break;
                default:
                    break;
            }
            return ['<div class="imgHolder-wrapper">', '<div class="imgHolder" style="width:' + c + 'px;padding-bottom: ' + (e * 100 / c).toFixed(4) + '%;">', '</div>', '</div>', '<div class="imgBlock">', b, '</div>'].join('')
        }
        return a.sendText
    },
    parseAvatar: function (a) {
        var b = AvatarMgr.getNavUserAvaUrl(a.senderID);
        return '<img class="avatar" src="' + b + '" onerror="AvatarMgr.downloadUserAvatar(this)" ava-id="' + a.senderID + '"/>'
    },
    parseFile: function (a) {
        var e = a.fileStatus,
            c = ParseUtil.getFileIcon(a.fileName),
            d = ParseUtil.bytesToSize(a.fileSize);
        a.fileName = ParseUtil.parseName(a.fileName);
        var b = '';
        switch (e) {
            case 0:
                if (Config.isPC) {
                    b = '<a class="fileOpenFolder">打开目录</a><a class="fileSaveAs">另存为</a><a class="fileSuc">打开</a>'
                } else {
                    b = '<a class="fileOpenFolder">已完成</a>'
                };
                break;
            case 1:
                b = '<div class="fileErr">找不到指定文件<a class="fileDone" style="float: right;padding: 0px 7px 0 10px;">重新下载</a></div>';
                break;
            case 2:
                b = '<div class="fileProgress">\n                <div style="width:' + a.fileProgress + '%;" class="fileLoaded"></div>\n            </div>\n            <a class="fileClose" onclick="DownFileMgr.abortDownFile(\'' + a.chat_id + "','" + a.attach_id + "','" + a.msg_id + "','" + a.isUpload + '\');">取消</a>';
                break;
            case 3:
                if (Config.isPC) {
                    b = '<div class="fileWait">' + a.waitMsg + '</div>'
                } else {
                    b = '<div class="fileWait">准备中</div>'
                };
                break;
            case 4:
                if (Config.isPC) {
                    b = '<a class="fileDone">下载</a>'
                } else {
                    b = '<div class="fileWait">未下载</div>'
                };
                break;
            case 5:
                b = ParseUtil.parseDownFile(a);
                break;
            default:
                break;
        }
        return ['<div class="fileMsg">', '<div class="fileWrapper">', '<div class="fileIcon ' + c + '"></div>', '<div class="fileName">' + a.fileName + '</div>', '<div class="fileSize">' + d + '</div>', '</div>', '<div class="fileTool">', b, '</div>', '</div>'].join('')
    },
    parseBigFile: function (b) {
        var d = parseInt(b.sendStatus, 10),
            c = parseInt(b.fileStatus, 10),
            f = ParseUtil.getFileIcon(b.fileName),
            g = ParseUtil.bytesToSize(b.fileSize),
            h = b.senderID == User.ownerID;
        var a = '';
        if (d == 2) {
            a = '大文件消息正在发送中'
        } else {
            if (d == 1) {
                a = '大文件消息发送失败 <a class="bfile_re_send">重新发送</a>'
            } else {
                var e = '<a class="open_bigfile_form">点击查看</a>';
                if (h) {
                    switch (c) {
                        case 0:
                            a = '<a class="fileOpenFolder">打开目录</a><a class="fileSaveAs">另存为</a><a class="fileSuc">打开</a>';
                            break;
                        default:
                            a = e;
                            break;
                    }
                } else {
                    switch (c) {
                        case 0:
                            a = '<a class="fileOpenFolder">打开目录</a><a class="fileSaveAs">另存为</a><a class="fileSuc">打开</a>';
                            break;
                        default:
                            a = e;
                            break;
                    }
                }
            }
        }
        return ['<div class="fileMsg">', '<div class="fileWrapper">', '<div class="fileIcon ' + f + '"></div>', '<div class="fileName">' + b.fileName + '</div>', '<div class="fileSize">' + g + '</div>', '</div>', '<div class="fileTool">', '<div class="x-fa fa-reorder bigfile-more"></div>', a, '</div>', '</div>', '<div class="bigfile-special"></div>'].join('')
    },
    getFileIcon: function (b) {
        var a = FileUtil.getExtension(b);
        a = (a || '').toLowerCase();
        if (['rtf', 'doc', 'docx'].indexOf(a) >= 0) {
            return 'wordIcon'
        }
        if (['xls', 'xlsx'].indexOf(a) >= 0) {
            return 'excelIcon'
        }
        if (['ppt', 'pptx'].indexOf(a) >= 0) {
            return 'pptIcon'
        }
        if (['wav', 'mp3', 'wma', 'acc', 'ogg'].indexOf(a) >= 0) {
            return 'audioIcon'
        }
        if (['avi', 'mp4', 'avi', 'mkv', 'mov', 'flv'].indexOf(a) >= 0) {
            return 'videoIcon'
        }
        if (['jpg', 'jpeg', 'gif', 'png', 'bmp', 'webp'].indexOf(a) >= 0) {
            return 'picIcon'
        }
        if (FileUtil.isArchiveExtension(a)) {
            return 'zipIcon'
        }
        if (a == 'pdf') {
            return 'PDFIcon'
        }
        if (a == 'txt') {
            return 'textIcon'
        }
        if (a == 'exe') {
            return 'exeIcon'
        }
        if (a == 'code') {
            return 'codeIcon'
        }
        return 'defaultIcon'
    },
    bytesToSize: function (a) {
        if (!a) {
            return '0 B'
        }
        if (a === 0) {
            return '0 B'
        }
        if (a <= 1024) {
            return '1 KB'
        }
        var c = 1024,
            d = ['B', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'],
            b = Math.floor(Math.log(a) / Math.log(c)),
            e = a / Math.pow(c, b);
        if (e > 999) {
            return e.toPrecision(4) + ' ' + d[b]
        }
        return (a / Math.pow(c, b)).toPrecision(3) + ' ' + d[b]
    },
    parseName: function (a) {
        if (a) {
            try {
                a = decodeURIComponent(a)
            } catch (b) {}
            return a
        }
        return a
    },
    encodeFileName: function (b) {
        var a = FileUtil.splitPath(b);
        if (a[1]) {
            try {
                a[1] = encodeURIComponent(a[1])
            } catch (c) {}
        }
        if (a[0]) {
            return a.join('/')
        }
        return a[1]
    },
    parseRctText: function (b) {
        var a = this.textToHtml(b);
        return a.replace(/<br[^>]*\/?>/gi, '&nbsp;').replace(/<div[^>]*>/gi, '').replace(/<\/div[^>]*>/gi, '&nbsp;').replace(/<a[^>]*\/?>/gi, '').replace(/<video[^>]*\/?>/gi, '')
    },
    getUserIDByDitChat: function (b) {
        var a = b.split(',');
        if (a[0] == User.ownerID) {
            return a[1]
        }
        return a[0]
    },
    getDitUidByArray: function (a) {
        var b = a[0].user_id;
        if (b == User.ownerID) {
            return a[1].user_id
        }
        return b
    },
    parseDirectChatName: function (a, b) {
        if (!b) {
            b = User.ownerID
        }
        if (a.members[0].user_id !== b) {
            return a.members[0].user_name
        }
        return a.members[1].user_name
    },
    parsePATMsg1: function (b) {
        var f = this;
        var g = /<img[^>]*src="([^"]*)"[^>]*>/g;
        var e = [],
            d = 0,
            a = '';
        while (a = g.exec(b)) {
            if (a.index == 0) {
                var c = f.parsePATImgMsg(b.substr(0, a[0].length));
                e.push({
                    type: MsgType.ImgMsg,
                    value: b.substr(0, a[0].length),
                    path: c.path,
                    height: c.height,
                    width: c.width
                })
            } else {
                if (f.reduceBlankBtwPic(b.substring(d, a.index))) {
                    e.push({
                        type: MsgType.TextMsg,
                        value: b.substring(d, a.index).replace(/<\/?span[^>]*>/gi, '')
                    })
                }
                var c = f.parsePATImgMsg(b.substr(a.index, a[0].length));
                e.push({
                    type: MsgType.ImgMsg,
                    value: b.substr(a.index, a[0].length),
                    path: c.path,
                    height: c.height,
                    width: c.width
                })
            }
            d = a.index + a[0].length
        }
        if (b.length > d) {
            if (f.reduceBlankBtwPic(b.substr(d))) {
                e.push({
                    type: MsgType.TextMsg,
                    value: b.substr(d).replace(/<\/?span[^>]*>/gi, '')
                })
            }
        }
        return e
    },
    parsePATImgMsg: function (d) {
        var a = {};
        var c = document.createElement('div');
        c.innerHTML = d;
        var b = c.childNodes[0];
        if (b.hasAttribute('data-url')) {
            a.width = parseInt(b.getAttribute('_width'), 10);
            a.height = parseInt(b.getAttribute('_height'), 10);
            a.path = b.getAttribute('data-url')
        }
        return a
    },
    parsePATMsg: function (b) {
        var e = this;
        var f = /<img[^>]*src="([^"]*)"[^>]*>/g;
        var d = [],
            c = 0,
            a = '';
        while (a = f.exec(b)) {
            if (a.index == 0) {
                d.push({
                    type: MsgType.ImgMsg,
                    value: b.substr(0, a[0].length)
                })
            } else {
                if (e.reduceBlankBtwPic(b.substring(c, a.index))) {
                    d.push({
                        type: MsgType.TextMsg,
                        value: b.substring(c, a.index).replace(/<\/?span[^>]*>/gi, '')
                    })
                }
                d.push({
                    type: MsgType.ImgMsg,
                    value: b.substr(a.index, a[0].length)
                })
            }
            c = a.index + a[0].length
        }
        if (b.length > c) {
            if (e.reduceBlankBtwPic(b.substr(c))) {
                d.push({
                    type: MsgType.TextMsg,
                    value: b.substr(c).replace(/<\/?span[^>]*>/gi, '')
                })
            }
        }
        return d
    },
    getTextByPT: function (d) {
        var b = this.parsePATMsg(d),
            c = '';
        for (var a = 0; a < b.length; a++) {
            if (b[a].type == MsgType.TextMsg) {
                c += this.parseHtmlToText(b[a].value)
            }
        }
        return c
    },
    reduceBlankBtwPic: function (a) {
        return a.replace(/&nbsp;/g, '').replace(/<br[^>]*\/?>/gi, '').replace(/<\/?div[^>]*>/gi, '').replace(/\s/g, '').replace(/<\/?span[^>]*>/gi, '')
    },
    replaceBrNbsp: function (a) {
        var b = '';
        if (a) {
            b = a.replace(/<br[\s\S]*\/?>/gi, '\r\n').replace(/&nbsp;/gi, ' ')
        }
        return b
    },
    trim: function (a) {
        return a.replace(/(^([\s\n\t]|(&nbsp;))+|([\s\n\t]|(&nbsp;))+$)/g, '')
    },
    getLocalPic: function (a) {
        if (a) {
            if (Config.isPC) {
                a = this.getLocalFileURL(a)
            }
            return ['<div class="imgBlock">', '<img class="viewPic loaded" src="' + a + '" data-original="' + a + '"/>', '</div>'].join('')
        }
        return ['<div class="imgBlock">', '<img class="" src="' + Ext.getResourcePath('images/failed.png') + '"/>', '<div class="img-tip">加载失败</div>', '</div>'].join('')
    },
    getLocalFileURL: function (b) {
        var a = '';
        if (b) {
            var c = /file:[\/]+/g;
            a = b.replace(c, 'localfile:///')
        }
        return a
    },
    clearFileOfURL: function (a) {
        var b = /file:[\/]+/g;
        a = a.replace(b, '');
        return a
    },
    getDctIdFromMems: function (a) {
        if (a[0].user_id !== User.ownerID || a.length == 1) {
            return a[0].user_id
        }
        return a[1].user_id
    },
    getDctNameFromMems: function (a) {
        if (a[0].user_id !== User.ownerID) {
            return a[0].user_name
        }
        return a[1].user_name
    },
    getNoticeMemsByContent: function (d, c) {
        var a = c.split(',');
        for (var b = 0; b < a.length; b++) {
            if (a[b] == d) {
                a.splice(b, 1);
                break
            }
        }
        return a
    },
    getGrpNotice: function (a) {
        var c = this,
            b = '';
        switch (a.notice_type) {
            case NoticeType.CreateGrp:
                b = c.getCreateNotice(a);
                break;
            case NoticeType.AddMem:
                b = c.getAddMemNotice(a);
                break;
            case NoticeType.RemoveMem:
                break;
            case NoticeType.ChgTitle:
                break;
            case NoticeType.ChgManager:
                break;
            default:
                break;
        }
        return b
    },
    getCreateNotice: function (a) {
        var c = '',
            f = '',
            d = '';
        if (a.content instanceof Array) {
            c = a.content
        } else {
            c = a.content.split(',')
        }
        if (a.content_ex instanceof Array) {
            f = a.content_ex
        } else {
            f = a.content_ex.split(',')
        }
        if (a.operator_id == User.ownerID) {
            d += '你邀请';
            var e = [];
            for (var b = 0; b < c.length; b++) {
                if (a.operator_id != c[b]) {
                    e.push(f[b])
                }
            }
            d += e.join('、')
        } else {
            d += a.operator_name + '邀请你和';
            var e = [];
            for (var b = 0; b < c.length; b++) {
                if (a.operator_id != c[b] && User.ownerID != c[b]) {
                    e.push(f[b])
                }
            }
            d += e.join('、')
        }
        d += '加入多人会话';
        return d
    },
    getAddMemNotice: function (a) {
        var b = a.operator_name;
        if (User.ownerID == a.operator_id) {
            b = '你'
        }
        return b + '邀请' + a.content_ex + '加入多人会话'
    },
    inOneMinute: function (a, b) {
        return Utils.datetime2Ago(a, !0) == Utils.datetime2Ago(b, !0)
    },
    inOneDay: function (a, b) {
        if (a && b) {
            if (!Ext.isDate(a)) {
                a = new Date(a)
            }
            if (!Ext.isDate(b)) {
                b = new Date(b)
            }
            if (a.toLocaleDateString() == b.toLocaleDateString()) {
                return !0
            }
        }
        return !1
    },
    dataShowTime: function (a, c) {
        var b = !0;
        if (a && a.data.length > 0) {
            if (ParseUtil.inOneMinute(a.last().get('updateTime'), c)) {
                b = !1
            }
        }
        return b
    },
    judgeSlice: function (h, c, d) {
        var b = [];
        for (var a = 0; a < h.length; a++) {
            var g = h.item(a);
            if (g.MsgSeq && typeof g.MsgSeq == 'number') {
                if (g.MsgSeq >= 10000) {
                    b.push(g)
                }
            }
        }
        var i = b.length,
            e = [];
        if (i > 0) {
            if (d) {
                var j = b[b.length - 1].MsgSeq;
                while (d < j) {
                    e.push({
                        to_seq: d,
                        from_seq: d - 1
                    });
                    d++
                }
            }
            var f = b[0].MsgSeq;
            if (c > 0) {
                if (c - f > 1) {
                    e.push({
                        to_seq: c - 1,
                        from_seq: f
                    })
                }
            }
            for (var a = 1; a < i; a++) {
                if (f - b[a].MsgSeq > 1) {
                    e.push({
                        to_seq: f - 1,
                        from_seq: b[a].MsgSeq
                    })
                }
                f = b[a].MsgSeq
            }
        } else {
            if (c > 10000) {
                e.push({
                    to_seq: c - 1,
                    from_seq: c - 21
                })
            }
        }
        return e
    },
    parseLocalMsg: function (c) {
        var d = c.length,
            e = {},
            g = [];
        if (d > 0) {
            for (var a = d - 1; a >= 0; a--) {
                e = c.item(a);
                var f = !0;
                if (a < d - 1) {
                    if (ParseUtil.inOneMinute(c.item(a + 1).CreateAt, e.CreateAt)) {
                        f = !1
                    }
                }
                var b = ParseUtil.getLocalMsgData(e, 1);
                if (b.notShowGrpChange) {
                    b.showTime = !1
                } else {
                    b.showTime = f
                }
                g.push(b)
            }
        }
        return g
    },
    parseLocalOrderedMsg: function (c) {
        var f = c.length;
        var e = [];
        if (f > 0) {
            for (var a = 0; a < f; a++) {
                var g = c.item(a);
                var d = !0;
                if (a > 0) {
                    if (ParseUtil.inOneMinute(c.item(a - 1).CreateAt, g.CreateAt)) {
                        d = !1
                    }
                }
                var b = ParseUtil.getLocalMsgData(g);
                if (b.notShowGrpChange) {
                    b.showTime = !1
                } else {
                    b.showTime = d
                }
                e.push(b)
            }
        }
        return e
    },
    getLocalMsgData: function (a) {
        var b = {},
            e = a.Content;
        if (!a.ReplyCount) {
            a.ReplyCount = 0
        }
        if (!a.UnReadCount) {
            a.UnReadCount = 0
        }
        try {
            switch (a.MsgType) {
                case MsgType.TextMsg:
                    b = {
                        msg_id: a.MsgID,
                        msg_type: a.MsgType,
                        senderName: a.SenderName,
                        sendText: e,
                        ROL: a.SenderID == User.ownerID ? 'right' : '',
                        updateTime: a.CreateAt,
                        msgSeq: a.MsgSeq,
                        sendStatus: a.Status,
                        reply_count: a.ReplyCount,
                        read_count: a.ReadCount,
                        unread_count: a.UnReadCount
                    };
                    break;
                case MsgType.ImgMsg:
                    var f = !0;
                    if (a.HasPreview == 'N') {
                        f = !1
                    };
                    e = ImgMgr.parsePic(a.FileID, f, a.Height, a.Width, a.FileStatus, a.ChatID, a.CreateAt, a.Extension, a.FileName, f);
                    var m = parseInt(a.FileStatus, 10);
                    b = {
                        chat_id: a.ChatID,
                        msg_id: a.MsgID,
                        msg_type: a.MsgType,
                        senderName: a.SenderName,
                        sendText: e,
                        ROL: a.SenderID == User.ownerID ? 'right' : '',
                        updateTime: a.CreateAt,
                        msgSeq: a.MsgSeq,
                        extension: a.Extension,
                        senderID: a.SenderID,
                        fileID: a.FileID,
                        fileName: a.FileName,
                        fileStatus: m,
                        filePath: a.FilePath,
                        fileSize: a.FileSize,
                        height: a.Height,
                        width: a.Width,
                        reply_count: a.ReplyCount,
                        read_count: a.ReadCount,
                        unread_count: a.UnReadCount
                    };
                    break;
                case MsgType.FileMsg:
                    var c = parseInt(a.Status, 10),
                        h = a.SenderID == User.ownerID;
                    if (c == 0) {
                        b = ParseUtil.getFileDataByFtu(a)
                    } else {
                        if (c == 1) {
                            if (h) {
                                b = {
                                    chat_id: a.ChatID,
                                    msg_id: a.MsgID,
                                    msg_type: a.MsgType,
                                    senderName: a.SenderName,
                                    ROL: 'right',
                                    updateTime: a.CreateAt,
                                    msgSeq: a.MsgSeq,
                                    fileStatus: 1,
                                    failMsg: Config.isPC ? '消息发送失败，<a class="file_re_send">重新发送</a>' : '消息发送失败',
                                    fileSize: a.FileSize,
                                    fileName: a.FileName,
                                    localPath: a.FilePath,
                                    reply_count: a.ReplyCount,
                                    read_count: a.ReadCount,
                                    unread_count: a.UnReadCount
                                }
                            } else {
                                b = ParseUtil.getFileDataByFtu(a)
                            }
                        } else {
                            if (c == 8) {
                                b = {
                                    chat_id: a.ChatID,
                                    msg_id: a.MsgID,
                                    msg_type: a.MsgType,
                                    senderName: a.SenderName,
                                    ROL: h ? 'right' : '',
                                    updateTime: a.CreateAt,
                                    msgSeq: a.MsgSeq,
                                    fileStatus: 2,
                                    fileSize: a.FileSize,
                                    fileName: a.FileName,
                                    localPath: a.FilePath,
                                    failMsg: '文件已丢失',
                                    reply_count: a.ReplyCount,
                                    read_count: a.ReadCount,
                                    unread_count: a.UnReadCount
                                }
                            } else {
                                if (c == 9) {
                                    b = {
                                        chat_id: a.ChatID,
                                        msg_id: a.MsgID,
                                        msg_type: a.MsgType,
                                        senderName: a.SenderName,
                                        ROL: h ? 'right' : '',
                                        updateTime: a.CreateAt,
                                        msgSeq: a.MsgSeq,
                                        fileStatus: 0,
                                        fileSize: a.FileSize,
                                        fileName: a.FileName,
                                        localPath: a.FilePath,
                                        reply_count: a.ReplyCount,
                                        read_count: a.ReadCount,
                                        unread_count: a.UnReadCount
                                    }
                                }
                            }
                        }
                    };
                    break;
                case MsgType.LinkErp:
                    var l = a.LinkKeyString;
                    if (!l) {
                        b = {
                            msg_id: a.MsgID,
                            msg_type: a.MsgType,
                            content: a.Content,
                            senderName: a.SenderName,
                            ROL: a.SenderID == User.ownerID ? 'right' : '',
                            updateTime: a.CreateAt,
                            msgSeq: a.MsgSeq,
                            linkName: a.LinkTitle,
                            linkLinkType: a.LinkType,
                            linkKeyString: a.LinkKeyString,
                            linkObjType: a.LinkObjType,
                            link_stg_guid: a.LinkStgGuid,
                            corpId: a.CorpID,
                            reply_count: a.ReplyCount,
                            read_count: a.ReadCount,
                            unread_count: a.UnReadCount
                        };
                        break
                    };
                    var i = l.split(/[=&]/);
                    var g = 0;
                    if (i.length == 1) {
                        g = i[0]
                    } else {
                        g = Utils.fromHex(i[1])
                    };
                    b = {
                        msg_id: a.MsgID,
                        msg_type: a.MsgType,
                        content: a.Content,
                        senderName: a.SenderName,
                        ROL: a.SenderID == User.ownerID ? 'right' : '',
                        updateTime: a.CreateAt,
                        msgSeq: a.MsgSeq,
                        linkName: a.LinkTitle,
                        linkLinkType: a.LinkType,
                        linkKeyString: a.LinkKeyString,
                        linkObjType: a.LinkObjType,
                        link_stg_guid: a.LinkStgGuid,
                        linkKey: g,
                        reply_count: a.ReplyCount,
                        read_count: a.ReadCount,
                        corpId: a.CorpID,
                        unread_count: a.UnReadCount
                    };
                    break;
                case MsgType.GroupNotice:
                    if (window.cefChat) {
                        if (User.crtChannelType == 'C') {
                            var c = parseInt(a.Status);
                            b = {
                                updateTime: a.CreateAt,
                                GrpChangeMsg: a.Content,
                                showGrpChange: !0,
                                msgSeq: a.MsgSeq,
                                msg_id: a.MsgID,
                                showGrpSeeMore: !1
                            };
                            break
                        } else {
                            var c = parseInt(a.Status);
                            b = {
                                updateTime: a.CreateAt,
                                GrpChangeMsg: a.Content,
                                showGrpChange: !0,
                                msgSeq: a.MsgSeq,
                                msg_id: a.MsgID,
                                showGrpSeeMore: c == 99 ? !0 : !1
                            };
                            break
                        }
                    } else {
                        if (Ext.getStore('comRct').getById(a.ChatID).data.type == 'C') {
                            var c = parseInt(a.Status);
                            b = {
                                updateTime: a.CreateAt,
                                GrpChangeMsg: a.Content,
                                showGrpChange: !0,
                                msgSeq: a.MsgSeq,
                                msg_id: a.MsgID,
                                showGrpSeeMore: !1
                            };
                            break
                        } else {
                            var c = parseInt(a.Status);
                            b = {
                                updateTime: a.CreateAt,
                                GrpChangeMsg: a.Content,
                                showGrpChange: !0,
                                msgSeq: a.MsgSeq,
                                msg_id: a.MsgID,
                                showGrpSeeMore: c == 99 ? !0 : !1
                            };
                            break
                        }
                    };
                case MsgType.CrowdInFo:
                    var c = parseInt(a.Status);
                    b = {
                        updateTime: a.CreateAt,
                        GrpChangeMsg: a.Content,
                        msgSeq: a.MsgSeq,
                        msg_id: a.MsgID,
                        senderName: a.SenderName,
                        msg_type: a.MsgType,
                        sendText: e
                    };
                    break;
                case NoticeType.CrowdSetAdmin:
                    b = {
                        showTime: !1,
                        notShowGrpChange: !0,
                        msgSeq: a.MsgSeq,
                        msg_id: a.MsgID,
                        updateTime: a.CreateAt
                    };
                    break;
                case MsgType.NotShow:
                    b = {
                        showTime: !1,
                        notShowGrpChange: !0,
                        msgSeq: a.MsgSeq,
                        msg_id: a.MsgID,
                        updateTime: a.CreateAt
                    };
                    break;
                case MsgType.Revoke:
                    var n = a.MsgID,
                        k = !1;
                    if (User.revokeMsgs[n]) {
                        k = !0
                    };
                    e = GroupNotice.getRevokeNotice(a.SenderID, a.Content);
                    b = {
                        msg_id: a.MsgID,
                        msg_type: a.MsgType,
                        senderName: a.SenderName,
                        sendText: e,
                        ROL: a.SenderID == User.ownerID ? 'right' : '',
                        updateTime: a.CreateAt,
                        msgSeq: a.MsgSeq,
                        showRevokeEdit: k
                    };
                    break;
                case MsgType.BigFileMsg:
                    var o = parseInt(a.Status, 10),
                        j = parseInt(a.BFileStatus, 10);
                    if (User.ownerID == a.SenderID) {
                        if (j == 2) {
                            j = 0
                        }
                    };
                    b = {
                        chatID: a.ChatID,
                        chat_id: a.ChatID,
                        chat_name: this.getChatnameFromRct(a.ChatID),
                        msg_id: a.MsgID,
                        msgSeq: a.MsgSeq,
                        localPath: a.BFilePath,
                        senderID: a.SenderID,
                        senderName: a.SenderName,
                        msg_type: MsgType.BigFileMsg,
                        file_id: a.BFileID,
                        fileName: a.BFileName,
                        fileSize: a.BFileSize,
                        sendStatus: o,
                        fileStatus: j,
                        updateTime: a.CreateAt,
                        ROL: a.SenderID == User.ownerID ? 'right' : '',
                        reply_count: a.ReplyCount,
                        read_count: a.ReadCount,
                        unread_count: a.UnReadCount
                    };
                    break;
                default:
                    var d = a.MsgType;
                    if (d == 'G' || d == 'A' || d == 'R' || d == 'M' || d == 'C' || d == 'X') {
                        d = MsgType.GroupNotice
                    };
                    b = {
                        chatID: a.ChatID,
                        chat_id: a.ChatID,
                        chat_name: this.getChatnameFromRct(a.ChatID),
                        msg_id: a.MsgID,
                        msgSeq: a.MsgSeq,
                        senderID: a.SenderID,
                        senderName: a.SenderName,
                        msg_type: a.MsgType,
                        updateTime: a.CreateAt,
                        ROL: a.SenderID == User.ownerID ? 'right' : ''
                    };
                    break;
            }
            if (b) {
                b.senderID = a.SenderID;
                b.localMsgID = a.MsgID;
                b.attach_id = a.FileID || a.BFileID;
                b.reply_count = a.ReplyCount
            }
        } catch (p) {
            console.log(p);
            b = {
                msg_id: a.MsgID,
                msgSeq: a.MsgSeq,
                showGrpChange: !1,
                notShowGrpChange: !0,
                updateTime: a.CreateAt
            }
        }
        return b
    },
    getFileDataByFtu: function (a) {
        var e = parseInt(a.FileStatus, 10),
            c = a.SenderID == User.ownerID;
        var b = {};
        if (e == 1) {
            var d = '文件下载失败，<a class="file_re_download">重新下载</a>';
            if (c) {
                d = '文件上传失败，<a class="file_re_upload">重新上传</a>'
            }
            b = {
                chat_id: a.ChatID,
                attach_id: a.FileID,
                msg_id: a.MsgID,
                msg_type: a.MsgType,
                senderID: a.SenderID,
                senderName: a.SenderName,
                ROL: c ? 'right' : '',
                updateTime: a.CreateAt,
                msgSeq: a.MsgSeq,
                fileStatus: 1,
                failMsg: d,
                fileSize: a.FileSize,
                fileName: a.FileName,
                localPath: a.FilePath,
                read_count: a.ReadCount,
                unread_count: a.UnReadCount
            }
        } else {
            if (e == 3) {
                if (a.FilePath) {
                    var f = DownFileMgr.getFullFileUrl(a.FileID);
                    if (ConfigMgr.autoLoad(a.FileSize) && Config.isPC) {
                        b = {
                            chat_id: a.ChatID,
                            attach_id: a.FileID,
                            msg_id: a.MsgID,
                            msg_type: a.MsgType,
                            senderID: a.SenderID,
                            senderName: a.SenderName,
                            ROL: a.SenderID == User.ownerID ? 'right' : '',
                            updateTime: a.CreateAt,
                            msgSeq: a.MsgSeq,
                            fileStatus: 5,
                            fileSize: a.FileSize,
                            fileName: a.FileName,
                            localPath: f,
                            read_count: a.ReadCount,
                            unread_count: a.UnReadCount
                        }
                    } else {
                        b = {
                            chat_id: a.ChatID,
                            attach_id: a.FileID,
                            msg_id: a.MsgID,
                            msg_type: a.MsgType,
                            senderID: a.SenderID,
                            senderName: a.SenderName,
                            ROL: a.SenderID == User.ownerID ? 'right' : '',
                            updateTime: a.CreateAt,
                            msgSeq: a.MsgSeq,
                            fileStatus: 4,
                            fileSize: a.FileSize,
                            fileName: a.FileName,
                            localPath: f,
                            read_count: a.ReadCount,
                            unread_count: a.UnReadCount
                        }
                    }
                } else {
                    b = {
                        chat_id: a.ChatID,
                        attach_id: a.FileID,
                        msg_id: a.MsgID,
                        msg_type: a.MsgType,
                        senderID: a.SenderID,
                        senderName: a.SenderName,
                        ROL: a.SenderID == User.ownerID ? 'right' : '',
                        updateTime: a.CreateAt,
                        msgSeq: a.MsgSeq,
                        fileStatus: 0,
                        fileSize: a.FileSize,
                        fileName: a.FileName,
                        read_count: a.ReadCount,
                        unread_count: a.UnReadCount
                    }
                }
            } else {
                b = {
                    chat_id: a.ChatID,
                    msg_id: a.MsgID,
                    msg_type: a.MsgType,
                    senderID: a.SenderID,
                    senderName: a.SenderName,
                    ROL: c ? 'right' : '',
                    updateTime: a.CreateAt,
                    msgSeq: a.MsgSeq,
                    fileStatus: 0,
                    fileSize: a.FileSize,
                    fileName: a.FileName,
                    localPath: a.FilePath,
                    read_count: a.ReadCount,
                    unread_count: a.UnReadCount
                }
            }
        }
        return b
    },
    parseRemoteMsg: function (c) {
        var f = this,
            e = [];
        for (var b = 0; b < c.length; b++) {
            var d = !0;
            if (b > 0) {
                if (f.inOneMinute(c[b].create_at, c[b - 1].create_at)) {
                    d = !1
                }
            }
            var a = f.getMsgData(c[b]);
            if (!a) {
                continue
            }
            if (a.notShowGrpChange) {
                a.showTime = !1
            } else {
                a.showTime = d
            }
            a.name = a.user_name;
            e.push(a)
        }
        return e
    },
    getMsgData: function (f) {
        var p = this;
        var b = {};
        if (f.wrapper_type == MsgWrapperType.Notice) {
            var d = ParseUtil.getGrpNotice(f.notice);
            b = {
                updateTime: f.create_at,
                GrpChangeMsg: d,
                showGrpChange: !0
            }
        } else {
            if (f.wrapper_type == MsgWrapperType.Message) {
                var a = f.message,
                    c = f.file || {},
                    i = a.user_name,
                    e = a.user_id == User.ownerID ? 'right' : '',
                    g = a.message;
                if (a.msg_type == MsgType.TextMsg) {
                    b = {
                        msg_id: a.msg_id,
                        msg_type: a.msg_type,
                        senderID: a.user_id,
                        senderName: a.user_name,
                        sendText: g,
                        ROL: e,
                        updateTime: a.create_at,
                        msgSeq: a.msg_seq
                    }
                } else {
                    if (a.msg_type == MsgType.ImgMsg) {
                        var l = a.has_preview,
                            y = l ? c.preview_height : c.height,
                            z = l ? c.preview_width : c.width;
                        g = ImgMgr.parsePic(a.attach_id, l, y, z, '1', a.chat_id, a.create_at, c.extension, c.file_name, l);
                        b = {
                            chat_id: a.chat_id,
                            msg_id: a.msg_id,
                            msg_type: a.msg_type,
                            senderID: a.user_id,
                            senderName: i,
                            sendText: g,
                            ROL: e,
                            updateTime: a.create_at,
                            fileID: a.attach_id,
                            fileName: c.file_name,
                            height: c.height,
                            width: c.width,
                            msgSeq: a.msg_seq,
                            fileSize: c.size,
                            extension: c.extension,
                            fileStatus: 1,
                            filePath: Config.httpUrlForGo + 'files/' + (c.preview_path || c.path + '_preview')
                        }
                    } else {
                        if (a.msg_type == MsgType.FileMsg) {
                            var r = 4;
                            if (ConfigMgr.autoLoad(c.size) && Config.isPC) {
                                r = 5
                            }
                            b = {
                                chat_id: a.chat_id,
                                msg_id: a.msg_id,
                                msg_type: MsgType.FileMsg,
                                attach_id: a.attach_id,
                                fileName: c.file_name,
                                fileSize: c.size,
                                fileStatus: r,
                                senderID: a.user_id,
                                senderName: i,
                                ROL: e,
                                updateTime: a.create_at,
                                msgSeq: a.msg_seq
                            }
                        } else {
                            if (a.msg_type == MsgType.LinkErp) {
                                var h = f.link;
                                if (h) {
                                    var u = h.link_key_string;
                                    var o = u.split(/[=&]/);
                                    var n = 0;
                                    if (o.length == 1) {
                                        n = o[0]
                                    } else {
                                        n = Utils.fromHex(o[1])
                                    }
                                    b = {
                                        msg_id: a.msg_id,
                                        msg_type: MsgType.LinkErp,
                                        content: a.message,
                                        senderID: a.user_id,
                                        senderName: i,
                                        ROL: e,
                                        updateTime: a.create_at,
                                        msgSeq: a.msg_seq,
                                        linkLinkType: h.link_type,
                                        linkName: h.link_title,
                                        linkKeyString: h.link_key_string,
                                        linkObjType: h.link_obj_type,
                                        link_stg_guid: h.link_stg_guid,
                                        linkKey: n
                                    }
                                } else {
                                    b = {
                                        chat_id: a.chat_id,
                                        chatID: a.chat_id,
                                        msg_id: a.msg_id,
                                        msgSeq: a.msg_seq,
                                        senderID: a.user_id,
                                        senderName: i,
                                        msg_type: a.msg_type,
                                        updateTime: a.create_at,
                                        ROL: e,
                                        notShowGrpChange: !0
                                    }
                                }
                            } else {
                                if (a.msg_type == NoticeType.CreateGrp) {
                                    var d = GroupNotice.cNewGrpByStrs(a.user_id, a.user_name, a.message, a.message_ex);
                                    b = {
                                        msg_id: a.msg_id,
                                        msgSeq: a.msg_seq,
                                        updateTime: a.create_at,
                                        GrpChangeMsg: d,
                                        showGrpChange: !0
                                    }
                                } else {
                                    if (a.msg_type == NoticeType.AddMem) {
                                        var d = GroupNotice.cAddGrpByStrs(a.user_id, a.user_name, a.message, a.message_ex);
                                        var w = a.message.split(',').length;
                                        var s = !1;
                                        for (var q = 0; q < w; q++) {
                                            if (User.ownerID == a.message.split(',')[q]) {
                                                s = !0;
                                                break
                                            }
                                        }
                                        if (s) {
                                            if (window.cefChat) {
                                                if (User.crtChannelType == 'C') {
                                                    b = {
                                                        msg_id: a.msg_id,
                                                        msgSeq: a.msg_seq,
                                                        updateTime: a.create_at,
                                                        GrpChangeMsg: d,
                                                        showGrpChange: !0,
                                                        showGrpSeeMore: !1
                                                    }
                                                } else {
                                                    b = {
                                                        msg_id: a.msg_id,
                                                        msgSeq: a.msg_seq,
                                                        updateTime: a.create_at,
                                                        GrpChangeMsg: d,
                                                        showGrpChange: !0,
                                                        showGrpSeeMore: !0
                                                    }
                                                }
                                            } else {
                                                if (Ext.getStore('comRct').getById(a.chat_id).data.type == 'C') {
                                                    b = {
                                                        msg_id: a.msg_id,
                                                        msgSeq: a.msg_seq,
                                                        updateTime: a.create_at,
                                                        GrpChangeMsg: d,
                                                        showGrpChange: !0,
                                                        showGrpSeeMore: !1
                                                    }
                                                } else {
                                                    b = {
                                                        msg_id: a.msg_id,
                                                        msgSeq: a.msg_seq,
                                                        updateTime: a.create_at,
                                                        GrpChangeMsg: d,
                                                        showGrpChange: !0,
                                                        showGrpSeeMore: !0
                                                    }
                                                }
                                            }
                                        } else {
                                            b = {
                                                msg_id: a.msg_id,
                                                msgSeq: a.msg_seq,
                                                updateTime: a.create_at,
                                                GrpChangeMsg: d,
                                                showGrpChange: !0
                                            }
                                        }
                                    } else {
                                        if (a.msg_type == NoticeType.ChgTitle) {
                                            var d = GroupNotice.chgName(a.user_name, a.message);
                                            b = {
                                                msg_id: a.msg_id,
                                                msgSeq: a.msg_seq,
                                                updateTime: a.create_at,
                                                GrpChangeMsg: d,
                                                showGrpChange: !0
                                            }
                                        } else {
                                            if (a.msg_type == NoticeType.DismissMultiChat) {
                                                var v = GroupNotice.dismissMultiChat(a.user_id);
                                                b = {
                                                    msg_id: a.msg_id,
                                                    msgSeq: a.msg_seq,
                                                    updateTime: a.create_at,
                                                    GrpChangeMsg: v,
                                                    showGrpChange: !0
                                                }
                                            } else {
                                                if (a.msg_type == NoticeType.RecoverMultiChat) {
                                                    var x = GroupNotice.recoverMultiChat(a.user_id);
                                                    b = {
                                                        msg_id: a.msg_id,
                                                        msgSeq: a.msg_seq,
                                                        updateTime: a.create_at,
                                                        GrpChangeMsg: x,
                                                        showGrpChange: !0
                                                    }
                                                } else {
                                                    if (a.msg_type == NoticeType.JoinERPMultiChat) {
                                                        var A = GroupNotice.joinERPChat(a.user_id);
                                                        b = {
                                                            msg_id: a.msg_id,
                                                            msgSeq: a.msg_seq,
                                                            updateTime: a.create_at,
                                                            GrpChangeMsg: A,
                                                            showGrpChange: !0
                                                        }
                                                    } else {
                                                        if (a.msg_type == NoticeType.RemoveMem) {
                                                            if (User.ownerID == a.user_id || User.ownerID == a.message) {
                                                                var m = GroupNotice.removeMem(a.user_id, a.user_name, a.message, a.message_ex);
                                                                b = {
                                                                    msg_id: a.msg_id,
                                                                    msgSeq: a.msg_seq,
                                                                    updateTime: a.create_at,
                                                                    GrpChangeMsg: m,
                                                                    showGrpChange: !0
                                                                }
                                                            } else {
                                                                b = {
                                                                    msg_id: a.msg_id,
                                                                    msgSeq: a.msg_seq,
                                                                    showGrpChange: !1,
                                                                    notShowGrpChange: !0,
                                                                    updateTime: a.create_at
                                                                }
                                                            }
                                                        } else {
                                                            if (a.msg_type == NoticeType.CrowdSetAdmin) {
                                                                var B = a.message.split(',')[0];
                                                                if (User.ownerID == a.user_id || User.ownerID == B) {
                                                                    var m = GroupNotice.CrowdsetAdmin(a.user_id, a.user_name, a.message);
                                                                    b = {
                                                                        msg_id: a.msg_id,
                                                                        msgSeq: a.msg_seq,
                                                                        updateTime: a.create_at,
                                                                        GrpChangeMsg: m,
                                                                        showGrpChange: !0
                                                                    }
                                                                } else {
                                                                    b = {
                                                                        msg_id: a.msg_id,
                                                                        msgSeq: a.msg_seq,
                                                                        showGrpChange: !1,
                                                                        notShowGrpChange: !0,
                                                                        updateTime: a.create_at
                                                                    }
                                                                }
                                                            } else {
                                                                if (a.msg_type == MsgType.CrowdInFo) {
                                                                    b = {
                                                                        msg_id: a.msg_id,
                                                                        msg_type: a.msg_type,
                                                                        senderID: a.user_id,
                                                                        senderName: a.user_name,
                                                                        sendText: g,
                                                                        updateTime: a.create_at,
                                                                        msgSeq: a.msg_seq
                                                                    }
                                                                } else {
                                                                    if (a.msg_type == NoticeType.HisChange) {
                                                                        if (User.ownerID == a.message) {
                                                                            var k = GroupNotice.changeHisat(a.user_id);
                                                                            b = {
                                                                                msg_id: a.msg_id,
                                                                                msgSeq: a.msg_seq,
                                                                                updateTime: a.create_at,
                                                                                GrpChangeMsg: k,
                                                                                showGrpChange: !0
                                                                            }
                                                                        } else {
                                                                            if (User.ownerID == a.user_id) {
                                                                                var k;
                                                                                if (Config.isPhone || Config.isPad) {
                                                                                    k = '<span class="' + User.userInfos[a.message].user_id + '">您收到一条通知，请于PC端查看</span>'
                                                                                } else {
                                                                                    k = '<span class="' + User.userInfos[a.message].user_id + '">' + User.userInfos[a.message].user_name + '申请查看更多历史消息</span> ' + '     <a>设置</a>'
                                                                                }
                                                                                b = {
                                                                                    msg_id: a.msg_id,
                                                                                    msgSeq: a.msg_seq,
                                                                                    updateTime: a.create_at,
                                                                                    GrpChangeMsg: k,
                                                                                    showGrpChange: !0
                                                                                }
                                                                            } else {
                                                                                b = {
                                                                                    msg_id: a.msg_id,
                                                                                    msgSeq: a.msg_seq,
                                                                                    showGrpChange: !1,
                                                                                    notShowGrpChange: !0,
                                                                                    updateTime: a.create_at
                                                                                }
                                                                            }
                                                                        }
                                                                    } else {
                                                                        if (a.msg_type == NoticeType.ChgManager) {
                                                                            if (User.ownerID == a.user_id || User.ownerID == a.message) {
                                                                                var t = GroupNotice.chgMgr(a.user_id, a.user_name, a.message, a.message_ex);
                                                                                b = {
                                                                                    msg_id: a.msg_id,
                                                                                    msgSeq: a.msg_seq,
                                                                                    updateTime: a.create_at,
                                                                                    GrpChangeMsg: t,
                                                                                    showGrpChange: !0
                                                                                }
                                                                            } else {
                                                                                b = {
                                                                                    msg_id: a.msg_id,
                                                                                    msgSeq: a.msg_seq,
                                                                                    showGrpChange: !1,
                                                                                    notShowGrpChange: !0,
                                                                                    updateTime: a.create_at
                                                                                }
                                                                            }
                                                                        } else {
                                                                            if (a.msg_type == MsgType.Revoke) {
                                                                                g = GroupNotice.getRevokeNotice(a.user_id, a.message);
                                                                                b = {
                                                                                    msg_id: a.msg_id,
                                                                                    msg_type: a.msg_type,
                                                                                    senderID: a.user_id,
                                                                                    senderName: a.user_name,
                                                                                    sendText: g,
                                                                                    ROL: e,
                                                                                    updateTime: a.create_at,
                                                                                    msgSeq: a.msg_seq
                                                                                }
                                                                            } else {
                                                                                if (a.msg_type == MsgType.BigFileMsg) {
                                                                                    var j = p.getBFileNS(g);
                                                                                    b = {
                                                                                        chat_id: a.chat_id,
                                                                                        chatID: a.chat_id,
                                                                                        chat_name: p.getChatnameFromRct(a.chat_id),
                                                                                        msg_id: a.msg_id,
                                                                                        msgSeq: a.msg_seq,
                                                                                        senderID: a.user_id,
                                                                                        senderName: i,
                                                                                        msg_type: MsgType.BigFileMsg,
                                                                                        file_id: a.attach_id,
                                                                                        fileName: j.fileName,
                                                                                        fileSize: j.fileSize,
                                                                                        sendStatus: 0,
                                                                                        fileStatus: 9,
                                                                                        updateTime: a.create_at,
                                                                                        ROL: e
                                                                                    };
                                                                                    if (Config.isPC) {
                                                                                        Utils.getApp().getCefObj().addTransferDownloadItem(JSON.stringify({
                                                                                            chat_id: a.chat_id,
                                                                                            chat_name: p.getChatnameFromRct(a.chat_id),
                                                                                            user_id: a.user_id,
                                                                                            user_name: User.getUserName(a.user_id),
                                                                                            msg_id: a.msg_id,
                                                                                            fetch_id: a.attach_id,
                                                                                            file_id: a.attach_id,
                                                                                            create_at: a.create_at,
                                                                                            extension: FileUtil.getExtension(j.fileName),
                                                                                            file_name: j.fileName,
                                                                                            file_size: j.fileSize,
                                                                                            size: j.fileSize,
                                                                                            file_status: 9,
                                                                                            fileStatus: 9,
                                                                                            owner_id: User.ownerID,
                                                                                            msg_status: 0
                                                                                        }))
                                                                                    }
                                                                                } else {
                                                                                    b = {
                                                                                        chat_id: a.chat_id,
                                                                                        chatID: a.chat_id,
                                                                                        msg_id: a.msg_id,
                                                                                        msgSeq: a.msg_seq,
                                                                                        senderID: a.user_id,
                                                                                        senderName: i,
                                                                                        msg_type: a.msg_type,
                                                                                        updateTime: a.create_at,
                                                                                        ROL: e
                                                                                    }
                                                                                }
                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
                b.reply_count = a.reply_count;
                Ext.applyIf(b, a)
            }
        }
        return b
    },
    getLocalTime: function (b) {
        var a = (new Date()).getTime() - User.difTime;
        if (b) {
            return a
        }
        return new Date(a)
    },
    sortHistory: function (a) {
        var d = a.length;
        for (var c = 0; c < d; c++) {
            for (var b = 0; b < d - 1 - c; b++) {
                if (a[b].updateTime > a[b + 1].updateTime) {
                    var e = a[b + 1];
                    a[b + 1] = a[b];
                    a[b] = e
                }
            }
        }
        return a
    },
    parseIcon: function (a) {
        var b = FileUtil.getExtension(a);
        return FileUtil.getMIMEIcon(b)
    },
    parseDownFile: function (a) {
        DownFileMgr.downFileForA(a);
        return '<div class="fileWait">waiting...</div>'
    },
    parseErpLink: function (f, d) {
        var h = f.split(d).join('');
        var g = /\[(.*?)\]/g;
        var c = h.match(g);
        var a = [];
        for (var b = 0; b < c.length; b++) {
            var e = c[b].substring(1, c[b].length - 1);
            a.push(e)
        }
        return {
            m: a[0],
            objType: parseInt(a[1], 10),
            keyString: a[2],
            n0: a[3],
            title: d,
            type: a[5],
            n1: a[6],
            n2: a[7]
        }
    },
    parseAccID: function (a) {
        if (a) {
            return a.toLowerCase().split('http://').join('').split('https://').join('').replace(/\/api\/v1\//g, '').replace(/\//g, '').replace(/:/g, '.')
        }
    },
    getTimeMStr: function (a) {
        if (!a) {
            return ''
        }
        if (!Ext.isDate(a)) {
            a = new Date(parseInt(a, 10))
        }
        var c = a.getFullYear().toString(),
            b = (a.getMonth() + 1).toString();
        if (b.length == 1) {
            b = '0' + b
        }
        return c + b + '/'
    },
    getTimeYMStr: function (a) {
        if (!a) {
            return ''
        }
        if (!Ext.isDate(a)) {
            a = new Date(parseInt(a, 10))
        }
        var c = a.getFullYear().toString(),
            b = (a.getMonth() + 1).toString();
        if (b.length == 1) {
            b = '0' + b
        }
        return c + '/' + c + b + '/'
    },
    getCFilePath: function (b, a) {
        return this.getCFileDir(a) + b
    },
    getCFileDir: function (a) {
        return ConfigMgr.getDefaultFileDir() + ParseUtil.getTimeYMStr(a)
    },
    getWorkTopFileDir: function (a) {
        return ConfigMgr.getDefaultWorkTopFileDir() + ParseUtil.getTimeYMStr(a)
    },
    getRelativeWorkTopPath: function (b, a) {
        return 'workTop/' + ParseUtil.getTimeYMStr(a) + b
    },
    getRelativeFilePath: function (b, a) {
        return 'files/' + ParseUtil.getTimeYMStr(a) + b
    },
    getCImgDir: function (a) {
        return ConfigMgr.getDefaultImgDir() + ParseUtil.getTimeYMStr(a)
    },
    getCImgPath: function (b, a) {
        return this.getCImgDir(a) + b
    },
    getRelativeImgPath: function (b, a) {
        return 'images/' + ParseUtil.getTimeYMStr(a) + b
    },
    parseRelativePath: function (a) {
        if (a.toLowerCase().startsWith('localfile://')) {
            a = a.replace(/localfile:[\/]+/g, 'file:///')
        }
        if (a.startsWith(ConfigMgr.getDataDirectory())) {
            a = a.replace(ConfigMgr.getDataDirectory(), '')
        }
        if (a.startsWith(ConfigMgr.getSecDefaultDir())) {
            a = a.replace(ConfigMgr.getSecDefaultDir(), '')
        }
        return a
    },
    getAbsolutePath: function (a) {
        if (a) {
            if (a.toLowerCase().startsWith('http://') || a.toLowerCase().startsWith('https://')) {
                return a
            }
            if (a.toLowerCase().startsWith('localfile://')) {
                return a.replace(/localfile:[\/]+/g, 'file:///')
            }
            if (a.toLowerCase().startsWith('file://')) {
                return a
            }
            if (a.startsWith(ConfigMgr.getDataDirectory())) {
                a = a.replace(ConfigMgr.getDataDirectory(), '')
            }
            if (a.startsWith(ConfigMgr.getSecDefaultDir())) {
                a = a.replace(ConfigMgr.getSecDefaultDir(), '')
            }
            return ConfigMgr.getDefaultDir() + a
        }
        return ''
    },
    getMembersByLocalIDs: function (e) {
        var d = [];
        var b = e.split(',');
        for (var a = 0; a < b.length; a++) {
            var c = User.getUserInfoByCache(b[a]);
            if (c) {
                d.push({
                    user_id: b[a],
                    user_name: c.user_name
                })
            }
        }
        return d
    },
    getCrowdMembersByLocalIDs: function (b) {
        var d = [];
        for (var a = 0; a < b.length; a++) {
            var c = User.getUserInfoByCache(b[a].user_id);
            if (c) {
                if (b[a].is_admin != 'Y') {
                    b[a].is_admin = 'N'
                }
                d.push({
                    user_id: b[a].user_id,
                    user_name: c.user_name,
                    isadmin: b[a].is_admin
                })
            }
        }
        return d
    },
    handleShowTime: function (a) {
        if (!a) {
            return ''
        }
        if (!Ext.isDate(a)) {
            a = new Date(a)
        }
        var d = this.getLocalTime();
        var b = this.getZeroTimeOfDay(d);
        var f = b - 1000 * 60 * 60 * 24;
        var e = b - 1000 * 60 * 60 * 24 * 7;
        var c = a.getTime();
        if (c > b) {
            return Ext.util.Format.date(a, Ext.Date.defaultTimeFormat)
        }
        if (c >= f && c < b) {
            return '昨天'
        }
        if (c > e) {
            return this.getWeekDay(a)
        }
        var h = d.getFullYear();
        var g = a.getFullYear();
        if (h == g) {
            return Ext.util.Format.date(a, 'm-d')
        }
        return Ext.util.Format.date(a, 'Y/m/d')
    },
    getWeekDay: function (c) {
        var b = c.getDay();
        var a = ['星期日', '星期一', '星期二', '星期三', '星期四', '星期五', '星期六'];
        return a[b]
    },
    handleMsgShowTime: function (a) {
        if (!a) {
            return ''
        }
        if (!Ext.isDate(a)) {
            a = new Date(a)
        }
        var c = this.getLocalTime();
        var d = a.getTime();
        var b = this.getZeroTimeOfDay(c);
        if (d > b) {
            return Ext.util.Format.date(a, 'H:i')
        }
        return Utils.datetime2Ago(a, !0)
    },
    getLoadedNativePath: function (b) {
        var a = ConfigMgr.getDataDirectory() + ConfigMgr.getSecDefaultDir() + b;
        if (Config.isPC) {
            a = 'local' + a
        }
        return a
    },
    milGrpChgMsg: function (a) {
        var b = a.length;
        if (b > 150) {
            return a.substr(0, 80) + '...' + a.substr(b - 20, 20)
        }
        return a
    },
    getZeroTimeOfDay: function (a) {
        if (!a) {
            return ''
        }
        if (!Ext.isDate(a)) {
            a = new Date(a)
        }
        return (new Date(a.toLocaleDateString())).getTime()
    },
    get24TimeOfDay: function (a) {
        if (!a) {
            return ''
        }
        if (!Ext.isDate(a)) {
            a = new Date(a)
        }
        return this.getZeroTimeOfDay(a) + 60 * 60 * 24 * 1000
    },
    msgShowTime: function (f, g) {
        var c = !0;
        var a = this.getTimeStamp(f);
        var b = this.getTimeStamp(g);
        if (a && b) {
            var e = Math.abs(b - a);
            var d = parseInt(e / (1000 * 60), 10);
            if (d <= 3) {
                c = !1
            }
        }
        return c
    },
    getTimeStamp: function (a) {
        var b = typeof a;
        if (b != 'number') {
            if (a instanceof Date) {
                a = a.getTime()
            }
        }
        return a
    },
    clearRepeated: function (b) {
        var a = [].concat($jscomp.arrayFromIterable(new Set(b)));
        return a
    },
    menuShowAtVisible: function (a, b) {
        a.show();
        var h = document.body.clientWidth,
            g = document.body.clientHeight,
            f = a.bodyElement.dom.offsetWidth,
            e = a.bodyElement.dom.offsetHeight,
            c, d;
        if (a.getFloated() || a.isPositioned()) {
            if (arguments.length === 2) {
                if (b.x) {
                    if (b.x + f >= h) {
                        c = b.x - f
                    } else {
                        c = b.x
                    }
                    if (b.y + e >= g) {
                        d = b.y - e
                    } else {
                        d = b.y
                    }
                }
            }
            if (a.isPositioned()) {
                a.setLeft(c);
                a.setTop(d)
            } else {
                a.setX(c);
                a.setY(d)
            }
        }
        return a
    },
    menuCrowdShowAtVisible: function (a, b, g) {
        if (g) {
            a.show();
            var i = document.body.clientWidth,
                h = document.body.clientHeight,
                f = a.bodyElement.dom.offsetWidth,
                e = a.bodyElement.dom.offsetHeight,
                c, d;
            if (a.getFloated() || a.isPositioned()) {
                if (arguments.length === 3) {
                    if (b.x) {
                        if (b.x + f >= i) {
                            c = b.x - f
                        } else {
                            c = b.x
                        }
                        if (b.y + e >= h) {
                            d = b.y - e
                        } else {
                            d = b.y
                        }
                    }
                }
                if (a.isPositioned()) {
                    a.setLeft(c);
                    a.setTop(d)
                } else {
                    a.setX(c);
                    a.setY(d)
                }
            }
            return a
        }
    },
    objArrReduce: function (b, d) {
        var c = [];
        var e = {};
        for (var a = 0; a < b.length; a++) {
            if (!e[b[a][d]]) {
                c.push(b[a]);
                e[b[a][d]] = !0
            }
        }
        return c
    },
    doEmptyText: function (b) {
        var a = b.emptyTextCmp || b.getEmptyTextCmp();
        if (a) {
            var c = b.getStore();
            if (c.getCount()) {
                a.hide()
            } else {
                a.show()
            }
        }
    },
    doHighLight: function (a, c, b) {
        if (Ext.isEmpty(a)) {
            return a
        }
        if (!Ext.isEmpty(c)) {
            return this.getHighLightHtml(a, c, b)
        }
        a = ParseUtil.parseTextToHtml(a);
        if (b) {
            return a.replace(/<\/?br[^>]*>/g, '&nbsp;')
        }
        return a
    },
    getHighLightHtml: function (g, b, f) {
        var e = g.split(b);
        b = ParseUtil.textToHtmlWithoutEmoji(b);
        var d = [];
        for (var c = 0; c < e.length; c++) {
            d.push(this.textToHtmlWithoutEmoji(e[c]))
        }
        var a = d.join('<span style="background:#c3dbf3;">' + b + '</span>');
        if (Config.isPC) {
            a = window.minEmoji(a)
        }
        a = this.parseHyperLink(a);
        if (f) {
            return a.replace(/<\/?br[^>]*>/g, '&nbsp;')
        }
        return a
    },
    getSelectionText: function () {
        var a = null,
            c = null,
            b = '';
        if (window.getSelection) {
            a = window.getSelection();
            b = a.toString()
        } else {
            if (document.selection) {
                a = document.selection;
                c = a.createRange();
                b = c.text
            }
        }
        return b
    },
    getSelectionHtml: function () {
        var a = null,
            b = null,
            c = '';
        if (window.getSelection) {
            a = window.getSelection();
            b = a.getRangeAt(0);
            var e = b.cloneContents();
            var d = document.createElement('div');
            d.appendChild(e);
            c = d.innerHTML
        } else {
            if (document.selection) {
                a = document.selection;
                b = a.createRange();
                c = b.htmlText
            }
        }
        return c
    },
    selectText: function (c) {
        if (document.body.createTextRange) {
            var a = document.body.createTextRange();
            a.moveToElementText(c);
            a.select()
        } else {
            if (window.getSelection) {
                var b = window.getSelection();
                var a = document.createRange();
                a.selectNodeContents(c);
                b.removeAllRanges();
                b.addRange(a)
            }
        }
    },
    getSureName: function (a, c) {
        if (a == User.ownerID) {
            return '你'
        }
        var b = User.getUserName(a);
        if (!b) {
            return c
        }
        return b
    },
    blobURL: function (a) {
        if (!window.cordova) {
            return a
        }
        if (a.startsWith('file://')) {
            if (Ext.os.is.ios) {
                a = window.cordova.file.dataDirectory + User.accountID + a.split(User.accountID)[1]
            }
        } else {
            a = ConfigMgr.getDefaultDir() + a
        }
        window.resolveLocalFileSystemURL(a, function (b) {
            b.file(function (d) {
                var c = new FileReader();
                c.onloadend = function (f) {
                    var e = f.target.result,
                        c = ImgUtil.dataURLtoBlob(e);
                    return URL.createObjectURL(c)
                };
                c.readAsDataURL(d)
            })
        }, function (b) {
            console.log(b);
            return !1
        })
    },
    getHideRevoke: function (a, b, f) {
        if (!b) {
            return !0
        }
        if (f == 'C') {
            var e = Ext.getStore('rgList').getById(User.ownerID);
            if (e.data.isManager == !0 || e.data.isadmin == 'Y') {
                return !1
            } else {
                if (b != User.ownerID) {
                    return !0
                }
                if (!a) {
                    return !0
                }
                var d = ParseUtil.getLocalTime(!0),
                    c = d - a;
                if (c <= 1000 * 60 * 2) {
                    return !1
                }
                return !0
            }
        } else {
            if (b != User.ownerID) {
                return !0
            }
            if (!a) {
                return !0
            }
            var d = ParseUtil.getLocalTime(!0),
                c = d - a;
            if (c <= 1000 * 60 * 2) {
                return !1
            }
            return !0
        }
    },
    addLaunchDiv: function () {
        var a = document.createElement('div');
        a.id = 'launching_div';
        a.innerHTML = '<div class="launching_div_mask"></div>';
        document.body.appendChild(a)
    },
    removeLaunchDiv: function () {
        var a = document.getElementById('launching_div');
        if (a) {
            a.parentNode.removeChild(a)
        }
    },
    fileExists: function (a) {
        if (Config.isPC) {
            return Utils.getApp().getCefObj().fileExist(a)
        } else {
            if (window.cordova) {
                return !0
            }
        }
        return !0
    },
    getBFileNS: function (e) {
        var a = e.split('|'),
            c = a[0],
            d = a[1] ? parseInt(a[1], 10) : 0,
            b = a[2] ? parseInt(a[2], 10) : 9;
        return {
            fileName: c,
            fileSize: d,
            fileStatus: b
        }
    },
    getChatnameFromRct: function (d) {
        if (window.cefChat) {
            return User.crtChatName
        }
        var c = '',
            b = Ext.getStore('comRct');
        if (b) {
            var a = b.getById(d);
            if (a) {
                c = a.get('name')
            }
        }
        return c
    },
    getSelectedContents: function () {
        if (window.getSelection) {
            var b = window.getSelection().getRangeAt(0);
            var a = document.createElement('div');
            a.appendChild(b.cloneContents());
            return a.innerHTML
        } else {
            if (document.getSelection) {
                var b = window.getSelection().getRangeAt(0);
                var a = document.createElement('div');
                a.appendChild(b.cloneContents());
                return a.innerHTML
            } else {
                if (document.selection) {
                    return document.selection.createRange().htmlText
                }
            }
        }
    },
    objArrRemoveByKey: function (b, d, c) {
        for (var a = 0; a < b.length; a++) {
            if (b[a][d] == c) {
                b.splice(a, 1)
            }
        }
    },
    getPrevMonthStartTime: function (b) {
        var a = b;
        if (!Ext.isDate(b)) {
            a = new Date(b)
        }
        a.setDate(1);
        a.setMonth(a.getMonth() - 1);
        return a.getTime()
    },
    getNextMonthEndTime: function (b) {
        var a = b;
        if (!Ext.isDate(b)) {
            a = new Date(b)
        }
        a.setDate(1);
        a.setMonth(a.getMonth() + 1);
        a.setDate(a.getDate());
        return a.getTime()
    },
    getOriginPicPath: function (a) {
        var d = FileUtil.getFileNameWoExt(a);
        if (!d) {
            return a
        }
        var g = d.lastIndexOf('_preview');
        if (g < 0) {
            return a
        }
        var c = d.substr(0, g);
        if (Ext.isEmpty(c)) {
            return a
        }
        var f = FileUtil.getExtension(a),
            e = FileUtil.splitPath(a)[0],
            b;
        if (!f) {
            b = Utils.joinPath(e, c);
            if (this.fileExists(b)) {
                return b
            }
            return a
        }
        c = c + '.' + f;
        b = Utils.joinPath(e, c);
        if (this.fileExists(b)) {
            return b
        }
        return a
    },
    isRctNoticeType: function (a) {
        return ['G', 'A', 'R', 'M', 'C', 'X', 'H', 'D', 'R'].indexOf(a) >= 0
    },
    getRctNoticeMsg: function (a) {
        var b = this;
        return b.isRctNoticeType(a) ? '[通知]' : '[尚未支持的消息类型]'
    },
    parseFloat: function (a) {
        if (a == User.ownerID) {
            return 'style="float:right;"'
        }
        return 'style="float:left;"'
    },
    parseNewsFromServer: function (e) {
        var d = [];
        for (var b = e.length - 1; b >= 0; b--) {
            var a = e[b],
                c = !0;
            if (b < a.length - 1) {
                if (ParseUtil.inOneMinute(a[b + 1].create_at, a.create_at)) {
                    c = !1
                }
            }
            d.push({
                showTime: c,
                newsID: a.news_id,
                newsType: a.news_type,
                title: a.title,
                desc: a.description,
                updateTime: a.create_at,
                newsSeq: a.news_seq,
                picUrl: a.pic_url,
                desUrl: a.des_url,
                isText: a.is_text,
                extras: a.extras,
                creatorID: a.creator_id
            });
            LocalDataMgr.saveToLocalNews(a)
        }
        return d
    },
    judgeNewsSlice: function (a, d) {
        var c = [],
            f = a.length;
        if (d && a.item(0).NewsSeq + 1 < d) {
            c.push({
                from_seq: a.item(0).NewsSeq + 1,
                to_seq: d
            })
        }
        for (var b = 0; b < f; b++) {
            var e = a.item(b);
            if (b < f - 1) {
                if (a.item(b + 1).NewsSeq + 1 < e.NewsSeq) {
                    c.push({
                        from_seq: a.item(b + 1).NewsSeq + 1,
                        to_seq: e.NewsSeq
                    })
                }
            }
        }
        return c
    },
    parseCrowdGrpListHTML: function (c, g, f) {
        var b = User.getUserInfoByCache(c);
        var a = 'gpl_grey_Female';
        if (b.sex && b.sex == 'M') {
            a = 'gpl_grey_Male'
        }
        if (User.allStatus[c]) {
            var e = User.allStatus[c].pc_online,
                d = User.allStatus[c].mobile_online;
            if (b.sex && b.sex == 'F') {
                if (e == 'Y') {
                    a = 'gpl_ava_Female'
                } else {
                    if (d == 'Y') {
                        a = 'gpl_mobile_ava_Female'
                    }
                }
            } else {
                if (e == 'Y') {
                    a = 'gpl_ava_Male'
                } else {
                    if (d == 'Y') {
                        a = 'gpl_mobile_ava_Male'
                    }
                }
            }
        }
        if (f) {
            return '<div class="gpl_ava ' + a + '"><span class="is_ma"></span></div>'
        } else {
            if (g == 'Y') {
                return '<div class="gpl_ava ' + a + '"><span class="is_ad"></span></div>'
            } else {
                return '<div class="gpl_ava ' + a + '"></div>'
            }
        }
    },
    showMobile: function (d) {
        var a = User.allStatus[d];
        if (a) {
            var c = a.pc_online,
                b = a.mobile_online;
            if (c != 'Y' && b == 'Y') {
                return '<div class="gpl_mobile"></div>'
            }
        }
    },
    parseGrpListHTML: function (a) {
        var e = AvatarMgr.getNavUserAvaUrl(a);
        var b = '';
        if (User.allStatus[a]) {
            var d = User.allStatus[a].pc_online,
                c = User.allStatus[a].mobile_online;
            if (d != 'Y' && c != 'Y') {
                b = 'offline'
            }
        }
        return '<div class="ava-wrapper"><img class="ava ' + b + '" src="' + e + '"  onerror="AvatarMgr.downloadUserAvatar(this)" ava-id="' + a + '"/></div>'
    },
    asyncForEach: function (b, c) {
        var a;
        return $jscomp.asyncExecutePromiseGeneratorProgram(function (d) {
            if (d.nextAddress == 1) {
                a = 0
            }
            if (d.nextAddress != 3) {
                if (!(a < b.length)) {
                    return d.jumpTo(0)
                }
                return d.yield(c(b[a], a, b), 3)
            }
            a++;
            return d.jumpTo(2)
        })
    },
    queueExec: function (e, a, d) {
        var c = this;
        var b;
        return $jscomp.asyncExecutePromiseGeneratorProgram(function (f) {
            b = c;
            b.asyncForEach(a, function (g, c) {
                var b;
                return $jscomp.asyncExecutePromiseGeneratorProgram(function (h) {
                    switch (h.nextAddress) {
                        case 1:
                            h.setCatchFinallyBlocks(2);
                            return h.yield(e(g), 4);
                        case 4:
                            h.leaveTryBlock(3);
                            break;
                        case 2:
                            b = h.enterCatchBlock();
                        case 3:
                            if (c == a.length - 1) {
                                d()
                            };
                            h.jumpToEnd();
                    }
                })
            });
            f.jumpToEnd()
        })
    },
    aio8UserInfoParser: function (a) {
        if (ConfigMgr.isAio8()) {
            var b = a.roles || [];
            if (!a.user_posts) {
                a.user_posts = b.map(function (b) {
                    return b.post_name
                }).filter(function (b) {
                    return b
                }).join(',')
            }
            if (!a.org_ids) {
                a.org_ids = b.map(function (b) {
                    return b.org_id
                }).filter(function (b) {
                    return b
                }).join(',')
            }
            if (!a.def_role_name) {
                a.def_role_name = b.map(function (b) {
                    return b.role_name
                }).filter(function (b) {
                    return b
                }).join(',')
            }
            if (!a.role_ids) {
                a.role_ids = b.map(function (b) {
                    return b.role_id
                }).filter(function (b) {
                    return b
                }).join(',')
            }
            if (!a.role_names) {
                a.role_names = b.map(function (b) {
                    return b.role_name
                }).filter(function (b) {
                    return b
                }).join(',')
            }
        }
        return a
    }
}, 0, 0, 0, 0, 0, 0, [IMCommon.utils, 'ParseUtil', 0, 'ParseUtil'], 0);
Ext.cmd.derive('IMCommon.utils.PushNotification', Ext.Base, {
    alternateClassName: 'PushNotification',
    singleton: !0,
    checkRight: function (a) {
        if (!(window.plugins && plugins.PushNotification)) {
            return
        }
        if (Ext.os.is.Android) {
            plugins.PushNotification.register(function (b) {
                Config._deviceToken = b.channel_id;
                Config._devicePlatform = b.rom_type;
                if (a) {
                    a('Y')
                }
            }, function (b) {
                Utils.toastLong('推送权限异常: ' + b)
            })
        } else {
            if (Ext.os.is.iOS) {
                plugins.PushNotification.register(function (b) {
                    Config._deviceToken = b;
                    if (a) {
                        a('Y')
                    }
                }, function (b) {
                    Utils.toastLong('推送权限异常: ' + b)
                }, {
                    badge: !0,
                    sound: !0,
                    alert: !0,
                    ecb: 'PushNotification.openByLocArgs'
                })
            }
        }
    },
    startBDPushWork: function () {
        plugins.PushNotification.registerbd(function (a) {
            Utils.toastShort(a.push_type + '启用成功');
            Config._deviceToken = a.channel_id;
            var b = {
                user_id: User.ownerID,
                app_id: 'AIO',
                push_channel_id: a.channel_id,
                device_plat_form: 'Android',
                is_receive: 'Y'
            };
            Utils.custAjax('post', 'push/register', {
                params: Ext.encode(b),
                failure: Ext.emptyFn,
                loadTarget: !1
            })
        }, function (a) {
            var b = '推送启用失败';
            if (!Ext.isEmpty(a) && isNaN(a)) {
                b += ', ' + a
            }
            Utils.toastShort(b)
        })
    },
    startPushWork: function () {
        var b = this;
        if (!(window.plugins && plugins.PushNotification)) {
            return
        }
        var a = localStorage.getItem('notify');
        a = Ext.decode(a) || {
            sound: !0,
            alert: !0
        };
        if (Ext.os.is.Android) {
            plugins.PushNotification.register(function (a) {
                Config._deviceToken = a.channel_id;
                Config._devicePlatform = a.rom_type;
                if (Config._deviceToken) {
                    var c = {
                        user_id: User.ownerID,
                        push_channel_id: Config._deviceToken,
                        device_plat_form: Config._devicePlatform,
                        is_receive: 'Y'
                    };
                    Utils.custAjax('post', 'push/register', {
                        params: Ext.encode(c),
                        success: function () {
                            Utils.toastShort('推送启用成功.')
                        },
                        failure: function (d, c) {
                            if (c == 404) {
                                b.startBDPushWork()
                            }
                        }
                    })
                }
            }, function (a) {
                var b = '推送启用失败';
                if (!Ext.isEmpty(a) && isNaN(a)) {
                    b += ', ' + a
                }
                Utils.toastLong(b)
            })
        } else {
            if (Ext.os.is.iOS) {
                plugins.PushNotification.register(function (a) {
                    Utils.toastShort('推送启用成功.');
                    Config._deviceToken = a;
                    PushNotification.regServer('Y')
                }, function (a) {
                    Utils.toastLong('推送启用异常: ' + a)
                }, {
                    badge: !0,
                    sound: a.sound,
                    alert: a.alert,
                    ecb: 'PushNotification.openByLocArgs'
                })
            }
        }
    },
    regServer: function (a) {
        a = a || 'Y';
        if (Config._deviceToken) {
            var b = {
                user_id: User.ownerID,
                push_channel_id: Config._deviceToken,
                device_plat_form: Ext.os.is.iOS ? 'IOS' : Config._devicePlatform,
                is_receive: a
            };
            Utils.custAjax('post', 'push/register', {
                params: Ext.encode(b),
                success: function () {},
                failure: function (b) {
                    Utils.toastLong(b)
                }
            })
        } else {
            if (a == 'Y') {
                PushNotification.checkRight(PushNotification.regServer)
            }
        }
    },
    openByLocArgs: function (b) {
        window.isnotify = !0;
        if (b) {
            var c = this,
                a;
            a = b['loc-args'];
            if (a) {
                if (typeof a == 'object') {
                    if (a.length == 1) {
                        window.tempchatid = a[0]
                    } else {
                        if (a.length > 1) {
                            if (a.includes('commonpush')) {
                                window.pushCacheMsg = {
                                    msg_type: a[0].toLocaleLowerCase(),
                                    msgValues: a.slice(1)
                                }
                            } else {
                                if (a[0] == 'chatid') {
                                    window.tempchatid = a[1]
                                } else {
                                    if (a[0] == 'mail') {
                                        PushNotification.openMailNotify(a[1], a[2], a[3])
                                    } else {
                                        if (a[0] == 'approve' && a.length >= 4) {
                                            try {
                                                window.approveParam = {
                                                    releaseKey: parseInt(a[1], 10),
                                                    isCompleted: parseInt(a[2], 10),
                                                    version: parseInt(a[3], 10)
                                                }
                                            } catch (d) {}
                                        } else {
                                            if (a[1].toLocaleLowerCase() == 'notice') {
                                                window.noticeParam = {
                                                    keystring: a[2]
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }
    },
    openByUrlData: function (a) {
        this.clearBadgeNum()
    },
    clearBadgeNum: function (a) {
        if (window.plugins && plugins.PushNotification) {
            plugins.PushNotification.setApplicationIconBadgeNumber(Ext.emptyFn, null, a || 0)
        }
    },
    resetBadgeNum: function (b) {
        if (window.plugins && plugins.PushNotification) {
            var a = Ext.getStore('comRct');
            if (a) {
                plugins.PushNotification.setApplicationIconBadgeNumber(Ext.emptyFn, null, a.sum('unReadNum') || 0)
            }
        }
    },
    reStartPushNotify: function () {
        if (Config._deviceToken && User.crtUser && User.ownerID) {
            this.regServer('Y')
        }
    },
    stopPushNotify: function () {
        if (!(window.plugins && plugins.PushNotification)) {
            return
        }
        if (Config._deviceToken && User.crtUser && User.ownerID) {
            plugins.PushNotification.unregister(function (a) {
                PushNotification.regServer('N')
            }, function (a) {
                var b = '推送停用异常';
                if (!Ext.isEmpty(a) && isNaN(a)) {
                    b += ': ' + a
                }
                Utils.toastShort(b)
            })
        }
    },
    notifyServerBG: function (b) {
        var a = {
            user_id: User.ownerID,
            device_plat_form: Ext.os.is.Android ? Config._devicePlatform : 'IOS',
            is_bg: b
        };
        Utils.custAjax('post', 'push/bg', {
            params: Ext.encode(a),
            success: function () {},
            failure: function (a) {
                Utils.toastLong(a)
            }
        })
    },
    openMailNotify: function (d, c, a) {
        var b = 'V1/#mail/maillist/' + d + '/' + c + '/?' + a;
        window.mailpath = b
    }
}, 0, 0, 0, 0, 0, 0, [IMCommon.utils, 'PushNotification', 0, 'PushNotification'], 0);
Ext.cmd.derive('IMCommon.utils.SendUtil', Ext.Base, {
    alternateClassName: 'SendUtil',
    singleton: !0,
    doSendAPI: function (c, b, a) {
        Utils.custAjax('post', 'posts/post2', {
            params: JSON.stringify(c),
            success: function (d) {
                if (b) {
                    b(d)
                }
            },
            failure: function (d) {
                Utils.toastShort(d);
                if (a) {
                    a(d)
                }
            }
        })
    },
    doSendReplyAPI: function (c, b, a) {
        Utils.custAjax('post', 'reply', {
            params: JSON.stringify(c),
            success: function (d) {
                if (b) {
                    b(d)
                }
            },
            failure: function (d) {
                if (a) {
                    a(d)
                }
            }
        })
    },
    doSendNewsCommandAPI: function (c, b, a) {
        Utils.custAjax('post', 'news/' + User.ownerID + '/command', {
            params: c,
            success: function (d) {
                if (b) {
                    b(d)
                }
            },
            failure: function (d) {
                if (a) {
                    a(d)
                }
            }
        })
    },
    requestBigFileAPI: function (c, b, a) {
        Utils.custAjax('POST', 'bfiles/request', {
            params: JSON.stringify(c),
            success: function (d) {
                if (b) {
                    b(d)
                }
            },
            failure: function (d) {
                if (a) {
                    a(d)
                }
            }
        })
    },
    notifyIMUpBFileSuc: function (c, b, a) {
        Utils.custAjax('post', 'bfiles/notice', {
            params: JSON.stringify(c),
            success: function (d) {
                if (Ext.isFunction(b)) {
                    b(d)
                }
            },
            failure: function (d) {
                if (Ext.isFunction(a)) {
                    a(d)
                }
            }
        })
    },
    sendMsg: function (e, a, c, d, f) {
        var b = this;
        b.beforeSend(a).then(function () {
            b.doSendMsg1(e, a, c, d, f)
        })
    },
    doSendMsg1: function (a, d, h, i, j) {
        var g = this;
        var e = [],
            b = [],
            c = '';
        if (a) {
            e = a.getMultiValue().ats;
            b = a.getMultiValue().msgs;
            c = a.getMultiValue().pureText
        }
        if (b.length == 0) {
            if (c.trim().length > 0) {
                Utils.toastShort('请不要擅自改动编辑框内的值');
                return
            }
            Utils.toastShort('不能发送空白消息');
            return
        }
        if (!ConfigMgr.lessThanMaxSendLength(c)) {
            Utils.toastShort('字数太多，暂不支持发送');
            return
        }
        if (d != StaticChatID.News) {
            g.sendMsgsByOneAPI(d, b, e)
        } else {
            g.sendNewsCommand(d, b, h, i)
        }
        if (a != null) {
            a.clear();
            var f = a.getPicker();
            if (!f.getHidden()) {
                f.hide()
            }
        }
    },
    sendErpLink: function (c, a) {
        var b = this;
        b.beforeSend(a).then(function () {
            var d = [{
                chat_id: a,
                msg_type: MsgType.LinkErp,
                user_id: User.ownerID,
                user_name: User.crtUser.user_name,
                message: c
            }];
            b.doSendAPI(d, function (b) {}, function (b) {
                Utils.toastShort(b)
            })
        })
    },
    inChat: function (b) {
        if (Ext.isEmpty(b)) {
            return !1
        }
        var d = User.ownerID;
        var c = b.split(',');
        for (var a = 0; a < c.length; a++) {
            if (d == c[a]) {
                return !0
            }
        }
        return !1
    },
    beforeSend: function (a) {
        var b = this;
        return new Ext.Promise(function (c, d) {
            b.addPromise(a).then(function () {
                var e = 'SELECT * FROM IMChat WHERE ChatID=?;';
                LocalDataMgr.cExecSqlWithP(e, [a], function (m, l) {
                    var k = l.rows;
                    if (k.length > 0) {
                        var e = k.item(0);
                        var i = e.ChatType;
                        if (b.inChat(e.UserIDs)) {
                            if (e.Status == '9') {
                                if (i == ChatType.Direct) {
                                    var f = e.UserIDs.split(',');
                                    Utils.custAjax('post', 'chats/iptdirect', {
                                        params: JSON.stringify(f),
                                        success: function (b) {
                                            LocalDataMgr.updateIMOldChat(b);
                                            var e = ParseUtil.getDctIdFromMems(b.members);
                                            User.needUpdateChatAva(e, b.avatar_hash, function () {
                                                if (window.cefMain) {
                                                    ViewGet.getRctView().refresh()
                                                }
                                            });
                                            c(a)
                                        },
                                        failure: function (b) {
                                            d(b)
                                        }
                                    })
                                } else {
                                    if (i == ChatType.Multi) {
                                        var f = e.UserIDs.split(',');
                                        var h = [];
                                        for (var g = 0; g < f.length; g++) {
                                            h.push({
                                                user_id: f[g]
                                            })
                                        }
                                        var j = {
                                            chat_id: a,
                                            header: e.DisplayName,
                                            creator_id: e.CreatorID,
                                            members: h
                                        };
                                        Utils.custAjax('post', 'chats/' + a + '/iptgroup', {
                                            params: JSON.stringify(j),
                                            success: function (b) {
                                                LocalDataMgr.updateIMOldChat(b);
                                                User.needUpdateChatAva(b.chat_id, b.create_at, b.avatar_hash, function () {
                                                    if (window.cefMain) {
                                                        ViewGet.getRctView().refresh()
                                                    }
                                                });
                                                c(a)
                                            },
                                            failure: function (b) {
                                                d(b)
                                            }
                                        })
                                    } else {
                                        if (i == 'C') {
                                            var f = e.UserIDs.split(',');
                                            var h = [];
                                            for (var g = 0; g < f.length; g++) {
                                                h.push({
                                                    user_id: f[g]
                                                })
                                            }
                                            var j = {
                                                chat_id: a,
                                                header: e.DisplayName,
                                                creator_id: e.CreatorID,
                                                members: h
                                            };
                                            Utils.custAjax('post', 'chats/' + a + '/iptgroup', {
                                                params: JSON.stringify(j),
                                                success: function (b) {
                                                    LocalDataMgr.updateIMOldChat(b);
                                                    User.needUpdateCrowdAva(b.chat_id, b.create_at, b.avatar_hash, function () {
                                                        if (window.cefMain) {
                                                            ViewGet.getRctView().refresh()
                                                        }
                                                    });
                                                    c(a)
                                                },
                                                failure: function (b) {
                                                    d(b)
                                                }
                                            })
                                        } else {
                                            Utils.toastShort('导入会话的会话类型不匹配')
                                        }
                                    }
                                }
                            } else {
                                c(a)
                            }
                        } else {
                            if (Config.isPad) {
                                Utils.toastShort('对不起，你已不在讨论组里')
                            } else {
                                Utils.toastShort('对不起，你没有权限在该会话发消息')
                            }
                        }
                    } else {
                        LocalDataMgr.insertIntoChatByAPI(a, '0', function () {
                            b.beforeSend(a)
                        })
                    }
                })
            })
        })
    },
    addPromise: function (a) {
        return new Ext.Promise(function (b, h) {
            if (Config.isPC) {
                var c = Ext.getStore(a);
                if (!c) {
                    b('ok');
                    return
                }
                var d = c.last();
                if (d) {
                    var e;
                    e = AddDataUtil.isMsgViewBottom();
                    if (!e) {
                        var f = d.get('updateTime');
                        var g = 'SELECT M.*,F.*,L.* FROM IMMsg M \n                        LEFT JOIN IMFile F ON M.ID=F.BaseID \n                        LEFT JOIN IMLink L ON M.ID=L.BaseID \n                        WHERE M.ChatID=? AND M.CreateAt>? \n                        ORDER BY M.CreateAt DESC LIMIT 20;';
                        LocalDataMgr.cExecSqlWithP(g, [a, f], function (g, f) {
                            var d = f.rows;
                            if (d.length > 0) {
                                var e = ParseUtil.parseLocalMsg(d);
                                if (d.length == 20) {
                                    c.removeAll()
                                }
                                c.add(e);
                                AddDataUtil.onScrolMsgView()
                            }
                            b('ok')
                        })
                    } else {
                        b('ok')
                    }
                } else {
                    b('ok')
                }
            } else {
                b('ok')
            }
        })
    },
    beforeReSendFileMsg: function (a) {
        var b = ParseUtil.fileExists(a.get('localPath'));
        if (b) {
            return !0
        }
        a.set('failMsg', '文件已失效');
        Utils.toastShort('对不起，您所选择的文件已经不存在')
    },
    sendMsg2: function (a, d, f) {
        var e = this;
        var g = a.ats || [];
        var c = a.msgs || [];
        var b = a.pureText || '';
        if (c.length == 0) {
            if (b.trim().length > 0) {
                c.push({
                    type: 'T',
                    value: b
                })
            } else {
                Utils.toastShort('不能发送空白消息');
                return
            }
        }
        if (!ConfigMgr.lessThanMaxSendLength(b)) {
            Utils.toastShort('字数太多，暂不支持发送');
            return
        }
        e.beforeSend(d).then(function () {
            e.sendMsgsByOneAPI(d, c, g, f)
        })
    },
    sendFileMsgsByOneAPI: function (a) {
        var c = this;
        var b = User.crtChannelId;
        c.beforeSend(b).then(function () {
            var g = a.length;
            if (g <= 0) {
                return
            }
            var e = [],
                f = [];
            for (var d = 0; d < g; d++) {
                if (ParseUtil.fileExists(a[d].path)) {
                    if (ConfigMgr.canUpload(a[d].size)) {
                        e.push({
                            path: a[d].path,
                            size: a[d].size,
                            type: MsgType.FileMsg
                        })
                    } else {
                        f.push(a[d])
                    }
                }
            }
            if (f.length > 0) {
                Ext.Msg.alert('提示', '您选择的文件中大于20兆的文件将不予发送，请通过大文件的方式进行发送');
                return
            }
            if (e.length > 0) {
                c.sendMsgsByOneAPI(b, e)
            } else {
                Utils.toastShort('您所选择的文件太大或已不存在')
            }
        })
    },
    sendMsgsByOneAPI: function (c, a, i, p) {
        var f = Ext.getStore(c);
        if (!f && Config.isPC) {
            return
        }
        if (!i) {
            i = []
        }
        var m = this;
        var g = a.length,
            d = [],
            k = [];
        for (var b = 0; b < g; b++) {
            var j = ParseUtil.getLocalTime(!0),
                l = !1,
                h = LocalDataMgr.newGuid();
            if (b == 0) {
                l = ParseUtil.dataShowTime(f, new Date(j))
            }
            switch (a[b].type) {
                case MsgType.TextMsg:
                    d.push({
                        client_id: h,
                        chatID: c,
                        localMsgID: h,
                        senderID: User.ownerID,
                        senderName: User.crtUser.user_name,
                        sendText: a[b].value,
                        msg_type: MsgType.TextMsg,
                        updateTime: j,
                        sendStatus: 2,
                        ROL: 'right',
                        showTime: l
                    });
                    k.push({
                        chat_id: c,
                        message: a[b].value,
                        msg_type: MsgType.TextMsg,
                        user_id: User.ownerID,
                        user_name: User.crtUser.user_name,
                        ats: i
                    });
                    break;
                case MsgType.ImgMsg:
                    var s = a[b].width,
                        r = a[b].height,
                        t = a[b].path,
                        e = FileUtil.getFileName(t);
                    d.push({
                        client_id: h,
                        localMsgID: h,
                        chat_id: c,
                        chatID: c,
                        localPath: t,
                        fileStatus: 2,
                        isUpload: !0,
                        senderID: User.ownerID,
                        senderName: User.crtUser.user_name,
                        msg_type: MsgType.ImgMsg,
                        updateTime: j,
                        sendStatus: 2,
                        ROL: 'right',
                        showTime: l,
                        width: s,
                        height: r,
                        fileName: e
                    });
                    k.push({
                        chat_id: c,
                        width: s,
                        height: r,
                        msg_type: MsgType.ImgMsg,
                        user_id: User.ownerID,
                        user_name: User.crtUser.user_name,
                        message: e,
                        ats: i
                    });
                    break;
                case MsgType.FileMsg:
                    var e = FileUtil.getFileName(a[b].path);
                    e = ParseUtil.parseName(e);
                    d.push({
                        chatID: c,
                        chat_id: c,
                        localMsgID: h,
                        localPath: a[b].path,
                        fileSize: a[b].size,
                        fileStatus: 3,
                        fileName: e,
                        senderID: User.ownerID,
                        senderName: User.crtUser.user_name,
                        msg_type: MsgType.FileMsg,
                        updateTime: j,
                        sendStatus: 2,
                        ROL: 'right',
                        showTime: l,
                        isUpload: !0,
                        waitMsg: '等待上传...'
                    });
                    k.push({
                        chat_id: c,
                        msg_type: MsgType.FileMsg,
                        user_id: User.ownerID,
                        user_name: User.crtUser.user_name,
                        size: a[b].size,
                        path: a[b].path,
                        message: e
                    });
                    break;
                default:
                    break;
            }
        }
        if (p) {
            f = p(d)
        } else {
            f.add(d);
            AddDataUtil.onScrolMsgView()
        }
        var n = a[g - 1].type == MsgType.TextMsg ? a[g - 1].value : a[g - 1].path,
            q = Ext.getStore('comRct');
        if (q) {
            var o = q.getById(c);
            if (o) {
                o.set({
                    last_post_msg: n,
                    last_msg_type: a[g - 1].type,
                    last_post_at: new Date(j),
                    last_post_id: User.ownerID,
                    last_post_name: User.crtUser.user_name,
                    chat_id: c
                })
            }
        }
        LocalDataMgr.updateRctBySend(n, ParseUtil.getLocalTime(!0), c, a[g - 1].type);
        LocalDataMgr.execSendWrapperMsg(d, i);
        m.doSendAPI(k, function (b) {
            m.doSendMsgsSuccess(d, b, f)
        }, function () {
            m.doSendMsgsFail(d, f)
        })
    },
    doSendMsgsSuccess: function (c, b, d) {
        for (var a = 0; a < b.length; a++) {
            switch (b[a].msg_type) {
                case MsgType.TextMsg:
                    this.doSendTextSuccess(c[a], b[a], d);
                    break;
                case MsgType.ImgMsg:
                    this.doSendImgSuccess(c[a], b[a], d);
                    break;
                case MsgType.FileMsg:
                    this.doSendFileSuccess(c[a], b[a], d);
                    break;
                case MsgType.BigFileMsg:
                    this.doSendBFileSuccess(c[a], b[a], d);
                    break;
                default:
                    break;
            }
        }
    },
    doSendTextSuccess: function (b, a, d) {
        var c = d.findRecord('localMsgID', b.localMsgID);
        if (c) {
            c.set({
                sendStatus: 0,
                updateTime: a.create_at,
                msg_id: a.msg_id,
                msgSeq: a.msg_seq,
                read_count: 0,
                unread_count: a.unread_count
            })
        }
        LocalDataMgr.doSendTextSuccess(b, a)
    },
    doSendImgSuccess: function (b, a, d) {
        var c = d.findRecord('localMsgID', b.localMsgID);
        if (c) {
            c.set({
                sendStatus: 0,
                updateTime: a.create_at,
                msg_id: a.msg_id,
                msgSeq: a.msg_seq,
                attach_id: a.attach_id,
                fileStatus: 3,
                read_count: 0,
                unread_count: a.unread_count
            })
        }
        LocalDataMgr.doSendImgSuccess(b, a)
    },
    doSendFileSuccess: function (b, a, d) {
        var c;
        if (d) {
            c = d.findRecord('localMsgID', b.localMsgID)
        }
        if (c) {
            c.set({
                sendStatus: 0,
                updateTime: a.create_at,
                msg_id: a.msg_id,
                msgSeq: a.msg_seq,
                attach_id: a.attach_id,
                read_count: 0,
                unread_count: a.unread_count
            })
        }
        a.localPath = b.localPath;
        UpFileMgr.pushFileToQue(a);
        LocalDataMgr.doSendFileSuccess(b, a)
    },
    doSendBFileSuccess: function (b, a, d) {
        var c = d.findRecord('localMsgID', b.localMsgID);
        if (c) {
            c.set({
                sendStatus: 0,
                updateTime: a.create_at,
                msg_id: a.msg_id,
                msgSeq: a.msg_seq,
                attach_id: a.attach_id,
                file_id: a.attach_id,
                fileStatus: 4,
                read_count: 0,
                unread_count: a.unread_count
            })
        }
        LocalDataMgr.doSendBFileSuccess(b, a);
        if (Config.isDesktop) {
            User.pushBFileToProgress(a.attach_id);
            Utils.getApp().getCefObj().doTransferUpload(JSON.stringify({
                chat_id: b.chatID,
                chat_name: b.chat_name,
                user_id: b.senderID,
                user_name: b.senderName,
                msg_id: a.msg_id,
                fetch_id: a.attach_id,
                file_id: a.attach_id,
                create_at: a.create_at,
                file_path: b.localPath,
                path: b.localPath,
                extension: FileUtil.getExtension(b.fileName),
                file_name: b.fileName,
                file_size: b.fileSize
            }))
        }
    },
    doSendMsgsFail: function (b, c) {
        for (var a = 0; a < b.length; a++) {
            switch (b[a].msg_type) {
                case MsgType.TextMsg:
                    this.doSendTextFail(b[a], c);
                    break;
                case MsgType.ImgMsg:
                    this.doSendImgFail(b[a], c);
                    break;
                case MsgType.FileMsg:
                    this.doSendFileFail(b[a], c);
                    break;
                case MsgType.BigFileMsg:
                    this.doSendBFileFail(b[a], c);
                    break;
                default:
                    break;
            }
        }
    },
    doSendTextFail: function (b, c) {
        var a = c.findRecord('localMsgID', b.localMsgID);
        if (a) {
            a.set({
                sendStatus: 1
            })
        }
    },
    doSendImgFail: function (b, c) {
        var a = c.findRecord('localMsgID', b.localMsgID);
        if (a) {
            a.set({
                sendStatus: 1
            })
        }
    },
    doSendFileFail: function (b, c) {
        var a = c.findRecord('localMsgID', b.localMsgID);
        if (a) {
            a.set({
                sendStatus: 1,
                fileStatus: 1,
                failMsg: '消息发送失败，<a class="file_re_send">重新发送</a>'
            })
        }
    },
    doSendBFileFail: function (b, c) {
        var a = c.findRecord('localMsgID', b.localMsgID);
        if (a) {
            a.set({
                sendStatus: 1,
                fileStatus: 1,
                failMsg: '消息发送失败，<a class="bfile_re_send">重新发送</a>'
            })
        }
    },
    sendBigFileMsgsByOneAPI: function (b, a) {
        var c = this;
        c.beforeSend(b).then(function () {
            if (a.length > 1) {
                Utils.toastShort('对不起，大文件只能选择一个进行发送');
                return
            }
            c.doSendBFile(b, a)
        })
    },
    doSendBFile: function (a, m) {
        var k = this;
        var b = m[0];
        var c = Ext.getStore(a);
        var l = LocalDataMgr.newGuid(),
            f = ParseUtil.getLocalTime(!0),
            i = FileUtil.getFileName(b.path);
        var g = '',
            e = Ext.getStore('comRct');
        if (window.cefChat) {
            g = User.crtChatName
        } else {
            if (e) {
                var j = e.getById(a);
                if (j) {
                    g = j.get('name')
                }
            }
        }
        var d = {
            chat_id: a,
            chat_name: g,
            chatID: a,
            localMsgID: l,
            localPath: b.path,
            senderID: User.ownerID,
            senderName: User.crtUser.user_name,
            msg_type: MsgType.BigFileMsg,
            fileName: i,
            fileSize: b.size,
            sendStatus: 2,
            fileStatus: 3,
            updateTime: f,
            showTime: ParseUtil.dataShowTime(c, f),
            ROL: 'right'
        };
        if (c) {
            c.add(d);
            AddDataUtil.onScrolMsgView()
        }
        LocalDataMgr.doSendBFileLocal(d);
        if (e) {
            var h = e.getById(a);
            if (h) {
                h.set({
                    last_post_msg: b.path,
                    last_msg_type: MsgType.BigFileMsg,
                    last_post_at: new Date(f),
                    last_post_id: User.ownerID,
                    last_post_name: User.crtUser.user_name
                })
            }
        }
        LocalDataMgr.updateRctBySend(b.path, f, a, MsgType.BigFileMsg);
        this.requestBigFileAPI({
            chat_id: a,
            user_id: User.ownerID,
            file_size: b.size,
            file_name: i
        }, function (b) {
            k.doSendBFileSuccess(d, b, c)
        }, function () {
            k.doSendBFileFail(d, c)
        })
    },
    doSendBigFiles: function (d, c) {
        var e = [],
            i = c.length;
        var g = '',
            f = Ext.getStore('comRct');
        if (f) {
            var h = f.getById(d);
            if (h) {
                g = h.get('name')
            }
        }
        for (var b = 0; b < i; b++) {
            if (ParseUtil.fileExists(c[b].path)) {
                e.push({
                    chat_id: d,
                    chat_name: g,
                    user_id: User.ownerID,
                    user_name: User.crtUser.user_name,
                    file_size: c[b].size,
                    file_name: FileUtil.getFileName(c[b].path),
                    path: c[b].path,
                    extension: FileUtil.getExtension(c[b].path)
                })
            }
        }
        if (e.length == 0) {
            Utils.toastShort('您所选择的文件不存在');
            return
        }
        var a = e[0];
        this.requestBigFileAPI(a, function (e) {
            if (Config.isDesktop) {
                var b = ParseUtil.getLocalTime(!0);
                a.fetch_id = e.fetch_id;
                a.msg_id = e.msg_id;
                a.now_time = b;
                Utils.getApp().getCefObj().doTransferUpload(JSON.stringify(a));
                LocalDataMgr.execSendBFile(a);
                LocalDataMgr.updateRctBySend(a.path, b, d, MsgType.BigFileMsg);
                var f = Ext.getStore(a.chat_id);
                if (f) {
                    var i = {
                        msg_id: e.msg_id,
                        fetch_id: e.fetch_id,
                        senderID: User.ownerID,
                        senderName: User.crtUser.user_name,
                        msg_type: MsgType.BigFileMsg,
                        fileStatus: 2,
                        updateTime: b,
                        showTime: ParseUtil.dataShowTime(f, b),
                        ROL: 'right'
                    };
                    f.add(i);
                    AddDataUtil.onScrolMsgView()
                }
                var h = Ext.getStore('comRct');
                if (!h) {
                    return
                }
                var g = h.getById(d);
                if (!g) {
                    return
                }
                g.set({
                    last_post_msg: a.path,
                    last_msg_type: MsgType.BigFileMsg,
                    last_post_at: new Date(b),
                    last_post_id: User.ownerID,
                    last_post_name: User.crtUser.user_name
                })
            }
        }, function (a) {
            Utils.toastShort('大文件发送失败：' + a)
        })
    },
    MsgStoreAddData: function (c, b) {
        var a = Ext.getStore(c);
        if (!a) {
            return
        }
        a.add(b)
    },
    rctStoreUpdateData: function (a) {},
    resendMsg: function (a, b) {
        SendUtil.sendMsg2({
            msgs: [a.sendText],
            pureText: Utils.htmlToText(a.sendText)
        }, User.crtChannelId, function (c) {
            LocalDataMgr.deleteFailMsg(a.localMsgID);
            return b(c)
        })
    },
    sendMsgWORct: function (d, a, c) {
        var b = this;
        b.beforeSend(a).then(function () {
            b.doSendMsgWORct(d, a, c)
        })
    },
    doSendMsgWORct: function (a, f, h) {
        var g = this;
        var d = [],
            c = [],
            b = '';
        if (a) {
            d = a.getMultiValue().ats;
            c = a.getMultiValue().msgs;
            b = a.getMultiValue().pureText
        }
        if (c.length == 0) {
            if (b.trim().length > 0) {
                Utils.toastShort('请不要擅自改动编辑框内的值');
                return
            }
            Utils.toastShort('不能发送空白消息');
            return
        }
        if (!ConfigMgr.lessThanMaxSendLength(b)) {
            Utils.toastShort('字数太多，暂不支持发送');
            return
        }
        g.sendMsgsByOneAPI(f, c, d);
        if (a != null) {
            a.clear();
            var e = a.getPicker();
            if (!e.getHidden()) {
                e.hide()
            }
        }
    },
    sendReply: function (d, i) {
        if (!i) {
            return
        }
        var h = d.getController().msgid;
        if (!h) {
            return
        }
        var c = d.lookup('reply_editor');
        if (!c) {
            return
        }
        var e = c.getMultiValue(),
            a = e.msgs,
            g = e.pureText;
        if (a.length == 0) {
            if (g.trim().length > 0) {
                Utils.toastShort('请不要擅自改动编辑框内的值');
                return
            }
            Utils.toastShort('不能发送空白消息');
            return
        }
        if (!ConfigMgr.lessThanMaxSendLength(g)) {
            Utils.toastShort('字数太多，暂不支持发送');
            return
        }
        var f = [];
        for (var b = 0; b < a.length; b++) {
            f.push({
                root_id: h,
                chat_id: i,
                content: a[b].value,
                content_type: a[b].type,
                user_id: User.ownerID,
                user_name: User.crtUser.user_name
            })
        }
        var j = this;
        j.doSendReplyAPI(f, function (a) {
            LocalDataMgr.saveReplies(a);
            c.clear();
            var b = d.getController();
            b.bindRemoteReplies(a)
        }, function (a) {
            Utils.toastShort(a)
        })
    },
    sendmsgReply: function (i, h, b) {
        if (!h) {
            return
        }
        if (!b) {
            return
        }
        var d = i.lookup('reply_editor');
        if (!d) {
            return
        }
        var e = d.getMultiValue(),
            a = e.msgs,
            g = e.pureText;
        if (a.length == 0) {
            if (g.trim().length > 0) {
                Utils.toastShort('请不要擅自改动编辑框内的值');
                return
            }
            Utils.toastShort('不能发送空白消息');
            return
        }
        if (!ConfigMgr.lessThanMaxSendLength(g)) {
            Utils.toastShort('字数太多，暂不支持发送');
            return
        }
        var f = [];
        for (var c = 0; c < a.length; c++) {
            f.push({
                root_id: b,
                chat_id: h,
                content: a[c].value,
                content_type: a[c].type,
                user_id: User.ownerID,
                user_name: User.crtUser.user_name
            })
        }
        var j = this;
        j.doSendReplyAPI(f, function (a) {
            LocalDataMgr.saveReplies(a);
            d.clear();
            AddDataUtil.bindMsgReplyList(b);
            LocalDataMgr.viewReply(b)
        }, function (a) {
            Utils.toastShort(a)
        })
    },
    sendNewsCommand: function (j, e, h, a) {
        if (!h) {
            return
        }
        if (!a) {
            return
        }
        if (e.length == 1 && e[0].type == 'T') {} else {
            Utils.toastShort('请发送有效指令');
            return
        }
        var f = e[0].value;
        var b = a.getStore(),
            i = h.getById(j);
        var d = ParseUtil.getLocalTime(!0),
            g = !1,
            c = LocalDataMgr.newGuid();
        g = ParseUtil.dataShowTime(b, new Date(d));
        i.set({
            last_post_at: new Date(d),
            last_post_msg: f
        });
        b.add({
            showTime: g,
            updateTime: d,
            localNewsID: c,
            newsType: 'CMD',
            desc: f,
            isText: 'Y',
            creatorID: User.ownerID,
            sendStatus: 2
        });
        if (Config.isPC) {
            AddDataUtil.onScroll(a)
        } else {
            a.scrollToBottom()
        }
        this.doSendNewsCommandAPI(f, function (d) {
            var f = b.findRecord('localNewsID', c);
            f.set({
                newsID: d.news_id,
                title: d.title,
                updateTime: d.create_at,
                newsSeq: d.news_seq,
                picUrl: d.pic_url,
                desUrl: d.des_url,
                extras: d.extras,
                sendStatus: 0
            });
            d.unReadNum = 0;
            LocalDataMgr.newsToUpdateRct(d);
            LocalDataMgr.saveToLocalNews(d)
        }, function () {
            var d = b.findRecord('localNewsID', c);
            d.set({
                sendStatus: 1
            })
        })
    }
}, 0, 0, 0, 0, 0, 0, [IMCommon.utils, 'SendUtil', 0, 'SendUtil'], 0);
Ext.cmd.derive('IMCommon.utils.SocketEventUtil', Ext.Base, {
    alternateClassName: 'SocketEventUtil',
    singleton: !0,
    handleHello: function (a) {
        if (Object.keys(a.data).length > 0) {
            User.useReceipt = a.data.useReceipt
        }
    },
    handleNewPostEvent: function (b, i, f) {
        var c = this;
        var a = JSON.parse(b.data.message);
        var g = a.chat_id;
        a.user_name = b.data.sender_name;
        if (b.data.iscrowd == 'Y') {
            a.chat_type = 'C'
        } else {
            a.chat_type = b.data.chat_type
        }
        a.chat_name = b.data.chat_name;
        a.header = b.data.header;
        a.device_type = b.device_type;
        a.attach_finish = b.data.attach_finish;
        a.mentions = JSON.parse(b.data.mentions);
        if (User.ownerID != a.user_id) {
            if (Ext.isArray(a.mentions) && a.mentions.length > 0) {
                for (var h = 0; h < a.mentions.length; h++) {
                    if (User.ownerID == a.mentions[h] || a.mentions[h] == 'all_user') {
                        a.hasMention = !0;
                        if (Config.isPC) {
                            if (AtUtil.manualRemoveAt) {
                                a.showMention = !0;
                                c.showMention(a)
                            } else {
                                if (User.crtChannelId != g) {
                                    a.showMention = !0;
                                    c.showMention(a)
                                } else {
                                    if (User.isMainFormActive == 'N') {
                                        a.showMention = !0;
                                        c.showMention(a)
                                    } else {
                                        var e = Ext.getStore('comRct').getById(g);
                                        if (c.autoScrolToEnd(e, ViewGet.getMsgView())) {
                                            LocalDataMgr.addOneReadedMention(a);
                                            AtUtil.removeServerOneMention(g, a.msg_id)
                                        } else {
                                            a.showMention = !0;
                                            c.showMention(a)
                                        }
                                    }
                                }
                            }
                        } else {
                            if (Config.isPad || Ext.os.is.tablet) {
                                a.showMention = !0;
                                LocalDataMgr.addOneMention(a);
                                var d = c.inThisChat(f, a.chat_id);
                                if (d) {
                                    d.addNewAt(a.msg_id, a.msg_seq)
                                }
                            } else {
                                LocalDataMgr.addOneMention(a);
                                var e = Ext.getStore('comRct').getById(g),
                                    j = e.get('MentionCount');
                                e.set('MentionCount', ++j);
                                var d = c.inThisChat(f, a.chat_id);
                                if (d) {
                                    d.addNewAt(a.msg_id, a.msg_seq)
                                }
                            }
                        }
                        break
                    }
                }
            }
        }
        if (a.msg_type == MsgType.LinkErp) {
            c.doErpLink(a, b.data.link, i)
        } else {
            if (a.user_id != User.ownerID) {
                c.doWsPost(a, i, f)
            } else {
                if (a.device_type != User.devType) {
                    c.doWsPost(a, i, f, 'Y')
                }
            }
        }
    },
    showMention: function (c) {
        LocalDataMgr.addOneMention(c);
        if (c.chat_id == User.crtChannelId) {
            var a;
            if (window.cefMain) {
                a = ViewGet.getMsgView()
            } else {
                if (window.cefChat) {
                    a = Utils.getCmp('desktopChat_list')
                }
            }
            if (!a) {
                return
            }
            var b = a.getViewModel().get('atCount');
            if (b > 0) {
                b += 1
            } else {
                b = 1
            }
            AtUtil.showAtBtnNew(a, b)
        }
    },
    doErpLink: function (a, c, g) {
        if (a.attach_finish == 'Y' && User.ownerID == a.user_id) {
            return
        }
        c = JSON.parse(c);
        LocalDataMgr.addErpLinkByWS(a, c);
        var b = this;
        if (window.cefChat) {
            var h = this.getChatNameByWS(a);
            LocalDataMgr.updateRctByWsPost(a, h);
            var d = b.inThisChat('', a.chat_id);
            if (d) {
                var e = d.getStore();
                if (!e) {
                    return
                }
                if (a.user_id == User.ownerID) {
                    b.addErpLinkMsg(e, a, c);
                    AddDataUtil.onScroll(d)
                } else {
                    var f = !1;
                    if (AddDataUtil.isViewBottom(d)) {
                        f = !0
                    } else {
                        b.showUnreadMsg(d)
                    }
                    b.addErpLinkMsg(e, a, c);
                    if (f) {
                        AddDataUtil.onScroll(d)
                    }
                }
            }
            b.notifyWrapper(a);
            return
        }
        b.afterHandleRct(b, a, g).then(function (e) {
            var f;
            var d;
            if (Config.isPC) {
                f = Ext.getStore(a.chat_id);
                d = ViewGet.getMsgView()
            } else {
                if (Config.isPad || Ext.os.is.Tablet) {
                    f = Ext.getStore(a.chat_id);
                    d = Ext.Viewport.lookup('IMPad').down('talkcontent')
                } else {
                    var h = Ext.Viewport.lookup('IMMobile').down('#chatview');
                    if (h) {
                        d = h.down('#msgView')
                    }
                    if (d && User.crtChannelId == a.chat_id) {
                        f = d.getStore()
                    }
                }
            }
            if (f) {
                if (User.crtChannelId == a.chat_id) {
                    f.add({
                        msg_id: a.msg_id,
                        msg_type: MsgType.LinkErp,
                        ROL: a.user_id == User.ownerID ? 'right' : '',
                        linkName: c.link_title,
                        linkObjType: c.link_obj_type,
                        linkKeyString: c.link_key_string,
                        content: a.message,
                        linkLinkType: c.link_type,
                        updateTime: a.create_at,
                        senderID: a.user_id,
                        senderName: a.user_name,
                        msgSeq: a.msg_seq,
                        read_count: a.read_count,
                        unread_count: a.unread_count < 0 ? 0 : a.unread_count
                    });
                    var i = function () {
                        if (Config.isPC) {
                            AddDataUtil.onScrolMsgView()
                        } else {
                            if (d) {
                                d.scrollToBottom()
                            }
                        }
                    };
                    if (User.ownerID == a.user_id) {
                        i()
                    } else {
                        b.autoScrolToEnd(e, d)
                    }
                }
            }
            b.doRctUnread(e, a);
            if (User.ownerID == a.user_id && User.devType == a.device_type) {
                return
            }
            if (!e) {
                e = Ext.getStore('comRct').getById(a.chat_id)
            }
            if (e) {
                a.isMute = e.get('IsMute')
            }
            b.notifyWrapper(a)
        })
    },
    doRctUnread: function (a, b) {
        if (!a) {
            return
        }
        if (User.crtChannelId == b.chat_id) {
            a.set({
                isUnRead: !1,
                unReadNum: a.get('unReadNum') + 1
            })
        } else {
            a.set({
                isUnRead: !0,
                unReadNum: a.get('unReadNum') + 1
            })
        }
    },
    doWsPost: function (a, g, e, d) {
        var b = this;
        b.doSaveMsgByWS(a);
        if (Config.isDesktop) {
            if (a.msg_type == MsgType.BigFileMsg) {
                this.doAddCefTransfer(a)
            }
        }
        if (window.cefChat) {
            var h = this.getChatNameByWS(a);
            LocalDataMgr.updateRctByWsPost(a, h);
            var c = b.inThisChat(e, a.chat_id);
            if (c) {
                var f = !1;
                if (AddDataUtil.isViewBottom(c)) {
                    f = !0
                } else {
                    b.showUnreadMsg(c)
                }
                b.addMsgByWsPost(c, a);
                if (f) {
                    AddDataUtil.onScroll(c)
                }
            }
            b.notifyWrapper(a);
            return
        }
        b.afterHandleRct(b, a, g).then(function (c) {
            var f = b.inThisChat(e, a.chat_id),
                h = g.getStore();
            if (f) {
                b.addMsgByWsPost(f, a);
                if (Config.isPC) {
                    if (d != 'Y') {
                        b.promptUnRead(a, h)
                    }
                    b.autoScrolToEnd(c, f)
                } else {
                    if (Config.isPad || Ext.os.is.tablet) {
                        f.unReadDatas()
                    } else {
                        f.onAddDatas(1);
                        Utils.custAjax('post', 'chats/members/' + User.ownerID + '/view', {
                            params: JSON.stringify({
                                chat_id: User.crtChannelId
                            })
                        })
                    }
                }
            } else {
                if (c) {
                    if (d != 'Y') {
                        b.promptUnRead(a, h)
                    }
                }
                if (User.crtChannelId == a.chat_id) {
                    var i = Ext.getStore(a.chat_id);
                    if (i) {
                        b.storeAddMsg(i, a)
                    }
                }
            }
            if (!c) {
                c = h.getById(a.chat_id)
            }
            if (c) {
                a.isMute = c.get('IsMute')
            }
            b.notifyWrapper(a)
        })['catch'](function (b) {
            console.log('ws收到通知后，Rct相关出错了', b)
        })
    },
    autoScrolToEnd: function (b, a, d) {
        if (!a) {
            return
        }
        if (window.cefChat) {
            if (d) {
                AddDataUtil.onScroll(a)
            } else {
                this.showUnreadMsg(a)
            }
            return
        } else {
            if (window.cefMain) {
                if (a.getHidden()) {
                    this.showUnreadMsg(a);
                    return
                }
            }
        }
        if (b) {
            var e = this,
                c = b.get('msgToLatest');
            if (c) {
                AddDataUtil.onScroll(a)
            } else {
                e.showUnreadMsg(a)
            }
        }
    },
    showUnreadMsg: function (b) {
        if (Config.isPC) {
            var a = b.getViewModel(),
                c = a.get('msgNum');
            a.set({
                hideMoreMsg: !1,
                msgNum: c + 1
            })
        }
    },
    doSaveMsgByWS: function (a) {
        LocalDataMgr.addMsgByWS(a)
    },
    afterHandleRct: function (b, a, c) {
        return new Ext.Promise(function (e, f) {
            var d = b.hasRct(c, a.chat_id);
            if (d) {
                b.chgRctByWsPost(d, a);
                e(d)
            } else {
                b.addRctByWsPost(c.getStore(), a, e)
            }
        })
    },
    inThisChat: function (b, c) {
        var a = '';
        if (window.cefMain) {
            if (b && b.lookup('im-main')) {
                if (b.lookup('im-main').down('#chatView')) {
                    a = b.lookup('im-main').down('#chatView');
                    if (a.getStore()) {
                        if (a.getStore().storeId == c) {
                            return a
                        }
                    }
                }
            }
        } else {
            if (Config.isPhone) {
                if (b && b.down('#chatview')) {
                    if (b.down('#chatview').down('#msgView')) {
                        a = b.down('#chatview').down('#msgView');
                        if (a.getStore() && a.getStore().chatID == c) {
                            return a
                        }
                    }
                }
            } else {
                if (Config.isPad || Ext.os.is.Tablet) {
                    if (b && b.down('talkcontent')) {
                        a = b.down('talkcontent');
                        if (a.getStore() && a.getStore().storeId == c) {
                            return a
                        }
                    }
                } else {
                    if (window.cefChat) {
                        return AddDataUtil.getCefMsgView()
                    }
                }
            }
        }
        return !1
    },
    hasRct: function (b, c) {
        var d = b.getStore(),
            a = d.getById(c);
        if (a) {
            return a
        }
        return !1
    },
    chgRctByWsPost: function (c, a) {
        var d = this.getChatNameByWS(a),
            b = c.get('MentionCount');
        if (a.showMention && User.ownerID != a.user_id) {
            b = b + 1
        }
        c.set({
            name: d,
            type: a.chat_type,
            last_msg_type: a.msg_type,
            last_post_msg: a.message,
            last_post_at: new Date(a.create_at),
            last_post_id: a.user_id,
            last_post_name: a.user_name,
            MentionCount: b
        });
        LocalDataMgr.updateRctByWsPost(a, d)
    },
    addRctByHisWsPost: function (d, a, e) {
        var b = this,
            c = a.chat_id;
        LocalDataMgr.beforeDoChat(c, function (j, f) {
            var g = f.IsMute,
                h = ParseUtil.getMembersByLocalIDs(f.UserIDs);
            var i = b.doAddHisRctToPage(d, a, g, h, f);
            b.doAddHisRctToDB(c, a, g, f);
            e()
        }, function () {
            ChatUtil.getChat(c, function (g) {
                var f = b.getMuteByRemote(g.members);
                var h = b.doAddRctToPage(d, a, f, g.members);
                b.doAddRctToDB(c, a, f);
                e()
            })
        })
    },
    addRctReplyWsPost: function (e, c, a, f) {
        var b = this,
            d = 'eeeeeeeebbbbbbbbbfffffffff';
        LocalDataMgr.beforeDoChat(d, function (h, i) {
            var g = b.doAddReplyRctToPage(e, a, c);
            b.doAddRePlyRctToDB(d, a, c);
            f()
        }, function () {
            var g = b.doAddReplyRctToPage(e, a, c);
            b.doAddRePlyRctToDB(d, a, c);
            b.doAddRePlyChatToDB(a, d);
            f()
        })
    },
    addRctReplytomeWsPost: function (d, f, a, e) {
        var b = this,
            c = 'eeeeeeeebbbbbbbbbfffffffff';
        LocalDataMgr.beforeDoChat(c, function (h, i) {
            var g = b.doAddReplyRctTomyPage(d, a);
            b.doAddRePlyRctTomyDB(c, a);
            e()
        }, function () {
            var g = b.doAddReplyRctTomyPage(d, a);
            b.doAddRePlyRctTomyDB(c, a);
            b.doAddRePlyChatToDB(a, c);
            e()
        })
    },
    addRctByWsPost: function (d, a, e) {
        var b = this,
            c = a.chat_id;
        a.avaID = b.getAvaIDByWS(a);
        a.name = b.getChatNameByWS(a);
        a.MentionCount = 0;
        if (a.showMention) {
            a.MentionCount = 1
        }
        LocalDataMgr.beforeDoChat(c, function (j, g) {
            var f = g.IsMute,
                h = ParseUtil.getMembersByLocalIDs(g.UserIDs);
            var i = b.doAddRctToPage(d, a, f, h);
            b.doAddRctToDB(c, a, f);
            e()
        }, function () {
            if (a.chat_type == 'C') {
                ChatUtil.getChatc(c, function (c) {
                    var f = b.getMuteByRemote(c.members);
                    var g = b.doAddRctToPage(d, a, f, c.members);
                    LocalDataMgr.openCrowdyByChatNotHave(a, a.update_at);
                    e()
                })
            } else {
                ChatUtil.getChat(c, function (g) {
                    var f = b.getMuteByRemote(g.members);
                    var h = b.doAddRctToPage(d, a, f, g.members);
                    b.doAddRctToDB(c, a, f);
                    e()
                })
            }
        })
    },
    doAddRctToPage: function (b, a, d, c) {
        return b.insert(0, {
            chat_id: a.chat_id,
            name: a.name,
            type: a.chat_type,
            chat_name: a.chat_name,
            last_post_at: new Date(a.create_at),
            last_post_msg: a.message,
            last_post_id: a.user_id,
            last_post_name: a.user_name,
            last_msg_type: a.msg_type,
            isUnRead: !0,
            unReadNum: 1,
            avaHash: a.avatar_hash,
            avaID: a.avaID,
            avaRefresh: (new Date()).getTime(),
            create_at: a.chat_create_at,
            IsMute: d,
            members: c,
            MentionCount: a.MentionCount
        })
    },
    doAddHisRctToPage: function (c, a, e, d, b) {
        return c.insert(0, {
            chat_id: a.chat_id,
            name: b.DisplayName,
            type: b.ChatType,
            last_post_at: new Date(a.create_at),
            last_post_msg: '通知',
            last_post_id: a.user_id,
            last_post_name: User.userInfos[a.user_id].user_name,
            last_msg_type: a.msg_type,
            isUnRead: !0,
            unReadNum: 1,
            avaHash: b.AvatarHash,
            avaID: a.chat_id,
            avaRefresh: (new Date()).getTime(),
            create_at: b.CreateAt,
            IsMute: e,
            members: d
        })
    },
    doAddReplyRctToPage: function (d, b, e) {
        var c = !1;
        var a = 0;
        if (e == User.ownerID) {
            c = !0;
            a = 1;
            SocketEventUtil.notifyWrapper(b)
        }
        return d.insert(0, {
            chat_id: 'eeeeeeeebbbbbbbbbfffffffff',
            name: '消息回复',
            type: 'P',
            last_post_at: new Date(b.update_at),
            last_post_msg: '',
            last_msg_type: 'P',
            isUnRead: c,
            unReadNum: a,
            avaHash: '',
            avaID: '',
            avaRefresh: (new Date()).getTime()
        })
    },
    doAddReplyRctTomyPage: function (a, b) {
        return a.insert(0, {
            chat_id: 'eeeeeeeebbbbbbbbbfffffffff',
            name: '消息回复',
            type: 'P',
            last_post_at: new Date(b.update_at),
            last_post_msg: '',
            last_msg_type: 'P',
            isUnRead: !1,
            unReadNum: 0,
            avaHash: '',
            avaID: '',
            avaRefresh: (new Date()).getTime()
        })
    },
    doAddHisRctToDB: function (b, a, d, c) {
        LocalDataMgr.beforeDoRct(b, function (e, g) {
            var f = 'UPDATE IMRct SET \n            DisplayName=?, UnreadCount=?, LastPostAt=?, LastUserID=?, LastUserName=?, \n             LastMsgType=?,IsMute=? WHERE ChatID=?;';
            e.executeSql(f, [g.DisplayName, 1, a.create_at, a.user_id, User.userInfos[a.user_id].user_name, MsgType.RePly, d, b])
        }, function (e) {
            var f = 'INSERT INTO IMRct \n                (ChatID, DisplayName, ChatType, UnreadCount, LastPostAt, LastUserID, LastUserName, \n                LastMessage, LastMsgType, CreateAt, UserID, IsMute) VALUES \n            (?,?,?,?,?,?,?,?,?,?,?,?);';
            e.executeSql(f, [b, c.DisplayName, c.ChatType, 1, a.create_at, a.user_id, User.userInfos[a.user_id].user_name, '通知', a.msg_type, c.CreateAt, a.user_id, d])
        })
    },
    doAddRePlyRctToDB: function (b, c, d) {
        var e = !1;
        var a = 0;
        if (d == User.ownerID) {
            e = !0;
            a = 1
        }
        LocalDataMgr.beforeDoRct(b, function (e, g) {
            var f = 'UPDATE IMRct SET \n            DisplayName=?, UnreadCount=?, LastPostAt=?,\n             LastMsgType=? WHERE ChatID=?;';
            e.executeSql(f, ['消息回复', a, c.update_at, 'P', b])
        }, function (e) {
            var f = 'INSERT INTO IMRct \n                (ChatID, DisplayName, ChatType, UnreadCount, LastPostAt,  \n                LastMsgType) VALUES \n            (?,?,?,?,?,?);';
            e.executeSql(f, [b, '消息回复', 'P', a, c.update_at, 'P'])
        })
    },
    doAddRePlyRctTomyDB: function (a, b) {
        LocalDataMgr.beforeDoRct(a, function (c, e) {
            var d = 'UPDATE IMRct SET \n            DisplayName=?, UnreadCount=?, LastPostAt=?,\n             LastMsgType=? WHERE ChatID=?;';
            c.executeSql(d, ['消息回复', 0, b.update_at, 'P', a])
        }, function (c) {
            var d = 'INSERT INTO IMRct \n                (ChatID, DisplayName, ChatType, UnreadCount, LastPostAt,  \n                LastMsgType) VALUES \n            (?,?,?,?,?,?);';
            c.executeSql(d, [a, '消息回复', 'P', 0, b.update_at, 'P'])
        })
    },
    doAddRctToDB: function (b, a, c) {
        LocalDataMgr.beforeDoRct(b, function (d, f) {
            var e = 'UPDATE IMRct SET \n            ChatType=?, DisplayName=?, UnreadCount=?, LastPostAt=?, LastUserID=?, LastUserName=?, \n            LastMessage=?, LastMsgType=?, UserID=?, CreateAt=?, MentionCount=?, IsMute=? WHERE ChatID=?;';
            d.executeSql(e, [a.chat_type, a.name, 1, a.create_at, a.user_id, a.user_name, a.message, a.msg_type, a.avaID, a.chat_create_at, a.MentionCount, c, b])
        }, function (d) {
            var e = 'INSERT INTO IMRct \n                (ChatID, DisplayName, ChatType, UnreadCount, LastPostAt, LastUserID, LastUserName, \n                LastMessage, LastMsgType, UserID, CreateAt, MentionCount, IsMute) VALUES \n            (?,?,?,?,?,?,?,?,?,?,?,?,?);';
            d.executeSql(e, [b, a.name, a.chat_type, 1, a.create_at, a.user_id, a.user_name, a.message, a.msg_type, a.avaID, a.chat_create_at, a.MentionCount, c])
        })
    },
    doAddChatToDB: function (a, c) {
        var e = LocalDataMgr.getUsersMsg(a.members),
            d = e.ids;
        var b = '';
        if (a.chat_type == ChatType.Direct) {
            b = ParseUtil.getDctNameFromMems(a.members)
        } else {
            if (a.chat_type == ChatType.Multi) {
                b = a.header
            }
        }
        var f = 'INSERT INTO IMChat \n        (ChatID, ChatType, DisplayName, CreatorID, ManagerID, Status, CreateAt, UpdateAt, Remarks, UserIDs, AvatarHash, IsMute) VALUES \n        (?,?,?,?,?,?,?,?,?,?,?,?);';
        LocalDataMgr.cExecSqlWithP(f, [a.chat_id, a.chat_type, b, a.creator_id, a.manager_id, '0', a.create_at, a.update_at, a.purpose, d, a.avatar_hash, c])
    },
    doAddRePlyChatToDB: function (a, b) {
        var c = 'replace INTO IMChat \n        (ChatID, ChatType, DisplayName, Status, UpdateAt) VALUES \n        (?,?,?,?,?);';
        LocalDataMgr.cExecSqlWithP(c, [b, 'P', '消息回复', '0', a.update_at])
    },
    getMuteByRemote: function (b) {
        for (var a = 0; a < b.length; a++) {
            if (User.ownerID == b[a].user_id) {
                if (!b[a].isMute) {
                    return 'N'
                }
                return b[a].isMute
            }
        }
        return 'N'
    },
    getAvaIDByWS: function (a) {
        var b = a.chat_id;
        if (a.chat_type == ChatType.Direct) {
            b = a.chat_name.split('__')[0] == User.ownerID ? a.chat_name.split('__')[1] : a.chat_name.split('__')[0]
        }
        return b
    },
    getChatNameByWS: function (a) {
        var b = '';
        if (a.chat_type == ChatType.Direct) {
            var c = a.chat_name.split('__')[0] == User.ownerID ? a.chat_name.split('__')[1] : a.chat_name.split('__')[0];
            b = User.getUserName(c)
        } else {
            if (a.chat_type == ChatType.Multi) {
                b = a.header
            } else {
                if (a.chat_type == 'C') {
                    b = a.header
                }
            }
        }
        return b
    },
    addMsgByWsPost: function (a, c) {
        var d = this,
            b = a.getStore();
        d.storeAddMsg(b, c)
    },
    storeAddMsg: function (b, a) {
        a.showTime = ParseUtil.dataShowTime(b, a.update_at);
        var c = this;
        switch (a.msg_type) {
            case MsgType.TextMsg:
                c.addTextMsg(b, a);
                break;
            case MsgType.ImgMsg:
                c.addImgMsg(b, a);
                break;
            case MsgType.FileMsg:
                c.addFileMsg(b, a);
                break;
            case MsgType.BigFileMsg:
                c.addBFileMsg(b, a);
                break;
            default:
                alert('ws暂未支持该类型：', a.msg_type);
        }
    },
    addTextMsg: function (c, a) {
        var b = c.add({
            chat_id: a.chat_id,
            msg_id: a.msg_id,
            msgSeq: a.msg_seq,
            msg_type: MsgType.TextMsg,
            senderName: a.user_name,
            sendText: a.message,
            updateTime: a.create_at,
            showTime: a.showTime,
            ROL: a.user_id == User.ownerID ? 'right' : '',
            senderID: a.user_id,
            read_count: a.read_count,
            unread_count: a.unread_count < 0 ? 0 : a.unread_count
        });
        return b[0]
    },
    addImgMsg: function (e, a) {
        var b = '';
        var d = a.attach_finish;
        if (d == 'Y') {
            b = ImgMgr.parsePic(a.attach_id, a.has_preview, a.height, a.width, '1', a.chat_id, a.create_at, FileUtil.getExtension(a.message), a.message, a.has_preview)
        } else {
            b = ImgMgr.setPicIndex(a.width, a.height)
        }
        var c = e.add({
            chat_id: a.chat_id,
            msg_id: a.msg_id,
            msgSeq: a.msg_seq,
            msg_type: MsgType.ImgMsg,
            senderName: a.user_name,
            sendText: b,
            showTime: a.showTime,
            updateTime: a.create_at,
            ROL: a.user_id == User.ownerID ? 'right' : '',
            fileName: a.message,
            senderID: a.user_id,
            fileID: a.attach_id,
            width: a.width,
            height: a.height,
            hasPreview: a.has_preview,
            read_count: a.read_count,
            unread_count: a.unread_count < 0 ? 0 : a.unread_count
        });
        return c[0]
    },
    addFileMsg: function (e, a) {
        var b = 3;
        var d = a.attach_finish;
        if (d == 'Y') {
            b = 4;
            if (ConfigMgr.autoLoad(a.size) && Config.isPC) {
                b = 5
            }
        }
        var c = e.add({
            chat_id: a.chat_id,
            msg_id: a.msg_id,
            msgSeq: a.msg_seq,
            msg_type: a.msg_type,
            attach_id: a.attach_id,
            fileName: a.message,
            fileSize: a.size,
            fileStatus: b,
            senderName: a.user_name,
            updateTime: a.create_at,
            showTime: a.showTime,
            ROL: a.user_id == User.ownerID ? 'right' : '',
            senderID: a.user_id,
            waitMsg: '等待对方上传成功...',
            read_count: a.read_count,
            unread_count: a.unread_count < 0 ? 0 : a.unread_count
        });
        return c[0]
    },
    addBFileMsg: function (i, a) {
        var h = this.getChatNameByWS(a);
        var b = ParseUtil.getBFileNS(a.message),
            d = b.fileName,
            f = b.fileSize,
            c = b.fileStatus;
        var e = {
            chatID: a.chat_id,
            chat_id: a.chat_id,
            chat_name: h,
            msg_id: a.msg_id,
            msgSeq: a.msg_seq,
            msg_type: MsgType.BigFileMsg,
            file_id: a.attach_id,
            attach_id: a.attach_id,
            fileName: d,
            fileSize: f,
            fileStatus: c,
            senderID: a.user_id,
            senderName: a.user_name,
            updateTime: a.create_at,
            showTime: a.showTime,
            ROL: a.user_id == User.ownerID ? 'right' : '',
            extension: FileUtil.getExtension(d),
            read_count: a.read_count,
            unread_count: a.unread_count < 0 ? 0 : a.unread_count
        };
        var g = i.add(e);
        if (parseInt(c, 10) == 8) {
            User.pushBFileToWait(a.attach_id)
        }
        return g[0]
    },
    doAddCefTransfer: function (a) {
        if (!Config.isDesktop) {
            return
        }
        var g = this.getChatNameByWS(a);
        var b = ParseUtil.getBFileNS(a.message),
            c = b.fileName,
            d = b.fileSize,
            e = b.fileStatus;
        var f = {
            chat_id: a.chat_id,
            chat_name: g,
            msg_id: a.msg_id,
            file_id: a.attach_id,
            fetch_id: a.attach_id,
            file_name: c,
            file_size: d,
            size: d,
            fileStatus: e,
            user_id: a.user_id,
            user_name: a.user_name,
            create_at: a.create_at,
            extension: FileUtil.getExtension(c)
        };
        Utils.getApp().getCefObj().addTransferDownloadItem(JSON.stringify(f))
    },
    addErpLinkMsg: function (d, a, b) {
        var c = d.add({
            msg_id: a.msg_id,
            msg_type: MsgType.LinkErp,
            ROL: a.user_id == User.ownerID ? 'right' : '',
            linkName: b.link_title,
            linkObjType: b.link_obj_type,
            linkKeyString: b.link_key_string,
            content: a.message,
            linkLinkType: b.link_type,
            updateTime: a.create_at,
            senderID: a.user_id,
            senderName: a.user_name,
            msgSeq: a.msg_seq,
            read_count: a.read_count,
            unread_count: a.unread_count < 0 ? 0 : a.unread_count
        });
        return c[0]
    },
    promptUnRead: function (b, c) {
        var a = c.getById(b.chat_id);
        if (!a) {
            return
        }
        a.set({
            isUnRead: !0,
            unReadNum: a.get('unReadNum') + 1,
            last_post_at: new Date(b.update_at)
        });
        if (Config.isPhone) {
            PushNotification.resetBadgeNum()
        }
    },
    promptFakeRead: function (b, c) {
        var a = c.getById(b.chat_id);
        if (!a) {
            return
        }
        a.set({
            isUnRead: !1,
            unReadNum: a.get('unReadNum') + 1,
            last_post_at: new Date(b.update_at)
        })
    },
    notifyWrapper: function (b) {
        if (Config.isPC) {
            DesktopChatUtil.addNotice(b)
        } else {
            if (Config.isPhone && b.user_id != User.ownerID) {
                var a = User.NewMsgCount || 0;
                a++;
                User.NewMsgCount = a;
                var d = Ext.Viewport.lookup('IMMobile');
                var c = d.getActiveItem();
                if (c.xtype == 'chatview' && b.chat_id != User.crtChannelId) {
                    c.setNewMsgCount(a)
                }
            }
        }
    },
    handleGetFile: function (d, g) {
        var e = this,
            b = JSON.parse(d.data.response),
            c = d.broadcast.chat_id,
            h = d.device_type;
        var f = e.hasFileStore(g, c);
        for (var a = 0; a < b.files.length; a++) {
            if (User.ownerID != b.files[a].creator_id) {
                b.files[a].chat_id = c;
                e.doSetPic(b.files[a], f)
            } else {
                if (h != User.devType) {
                    b.files[a].chat_id = c;
                    e.doSetPic(b.files[a], f)
                }
            }
        }
    },
    hasFileStore: function (a, c) {
        var b = '';
        if (window.cefMain) {
            if (a && a.down('#chatView') && a.down('#chatView').getStore()) {
                b = a.down('#chatView').getStore()
            }
        } else {
            if (Config.isPhone) {
                if (a && a.down('#chatview') && a.down('#chatview').down('#msgView') && a.down('#chatview').down('#msgView').getStore()) {
                    b = a.down('#chatview').down('#msgView').getStore()
                }
            } else {
                if (Config.isPad) {
                    if (a && a.down('talkcontent') && a.down('talkcontent').getStore()) {
                        b = a.down('talkcontent').getStore()
                    }
                } else {
                    if (window.cefChat) {
                        b = Ext.getStore(c)
                    }
                }
            }
        }
        return b
    },
    doSetPic: function (b, c) {
        if (Ext.os.is.Cordova) {}
        if (c) {
            var a = c.getById(b.msg_id);
            if (a && a.get('msg_type') == MsgType.ImgMsg) {
                a.set({
                    'sendText': ImgMgr.parsePic(b.file_id, a.get('hasPreview'), b.height, b.width, '1', b.chat_id, b.create_at, b.extension, b.file_name, a.get('hasPreview')),
                    'fileSize': b.size
                })
            }
            if (a && a.get('msg_type') == MsgType.FileMsg) {
                if (ConfigMgr.autoLoad(a.get('fileSize')) && Config.isPC) {
                    a.set('fileStatus', 5)
                } else {
                    a.set('fileStatus', 4)
                }
            }
        } else {}
    },
    handleUnreadPic: function (b) {
        for (var a = 0; a < User.unReadPic.length; a++) {
            if (b.file_id == User.unReadPic[a].attach_id) {
                User.unReadPic[a].width = b.width;
                User.unReadPic[a].height = b.height;
                User.unReadPic[a].extension = b.extension;
                User.unReadPic[a].file_name = b.file_name
            }
        }
    },
    handleGrpAddEvent: function (a) {
        if (a.data.creator_id == User.ownerID && a.device_type == User.devType) {
            return
        }
        var c = {
            content: JSON.parse(a.data.user_ids),
            content_ex: JSON.parse(a.data.user_names),
            operator_id: a.data.creator_id,
            operator_name: a.data.creator_name
        };
        var b = JSON.parse(a.data.message);
        b.message = ParseUtil.getCreateNotice(c);
        LocalDataMgr.addMsgByWS(b);
        LocalDataMgr.addChatByWSGrpAdd(a)
    },
    handleMemAddEvent: function (e) {
        var y = this;
        var h;
        var l = !1;
        var c = e.data;
        if (c.operator_id == User.ownerID && User.devType == e.device_type) {
            return
        }
        var b = JSON.parse(e.data.message);
        var g = GroupNotice.cAddMemsByWS(c);
        for (var a = 0; a < JSON.parse(e.data.user_ids).length; a++) {
            if (JSON.parse(e.data.user_ids)[a] == User.ownerID) {
                l = !0;
                break
            }
        }
        if (l) {
            h = '99'
        } else {
            h = '0'
        }
        var p = Ext.getStore('comRct');
        if (p) {
            var m = p.getById(b.chat_id);
            if (m) {
                m.set({
                    name: c.chat_name,
                    last_msg_type: MsgType.GroupNotice,
                    last_post_at: new Date(b.create_at),
                    last_post_msg: g
                })
            }
        }
        var d;
        var k = !1;
        if (Config.isPC) {
            d = Ext.getStore(b.chat_id)
        } else {
            var i;
            var n = Ext.Viewport.lookup('IMMobile').down('#chatview');
            if (n) {
                i = n.down('#msgView')
            }
            if (i && User.crtChannelId == b.chat_id) {
                d = i.getStore()
            }
        }
        var o = !1;
        if (Config.isPC) {
            o = AddDataUtil.isMsgViewBottom()
        }
        if (d) {
            for (var a = 0; a < JSON.parse(e.data.user_ids).length; a++) {
                if (JSON.parse(e.data.user_ids)[a] == User.ownerID) {
                    k = !0;
                    break
                }
            }
            if (k) {
                d.add({
                    msg_id: b.msg_id,
                    msgSeq: b.msg_seq,
                    showTime: ParseUtil.dataShowTime(d, b.create_at),
                    updateTime: b.create_at,
                    GrpChangeMsg: g,
                    showGrpChange: !0,
                    showGrpSeeMore: !0,
                    status: '99'
                })
            } else {
                d.add({
                    msg_id: b.msg_id,
                    msgSeq: b.msg_seq,
                    showTime: ParseUtil.dataShowTime(d, b.create_at),
                    updateTime: b.create_at,
                    GrpChangeMsg: g,
                    showGrpChange: !0,
                    status: '0'
                })
            }
        }
        if (User.crtChannelId == b.chat_id) {
            if (Config.isPC) {
                var q = AddDataUtil.getCefMsgView();
                if (o) {
                    AddDataUtil.onScroll(q)
                } else {
                    y.showUnreadMsg(q)
                }
            }
            var f = JSON.parse(c.user_ids),
                s = JSON.parse(c.user_names);
            var j = [];
            for (var a = 0; a < f.length; a++) {
                if (window.cefChat) {
                    var w = DesktopChatUtil.showMobile(f[a]),
                        u = DesktopChatUtil.parseGrpListCls(f[a]);
                    j.push({
                        user_id: f[a],
                        user_name: s[a],
                        showMobile: w,
                        resCls: u.cls,
                        isOnline: u.isOnline
                    })
                } else {
                    if (window.cefMain) {
                        j.push({
                            user_id: f[a],
                            user_name: s[a]
                        })
                    }
                }
            }
            if (Config.isPC) {
                var r = Ext.getStore('rgList');
                if (r) {
                    r.add(j)
                }
            }
            var v = Ext.Viewport.lookup('IM');
            if (v) {
                v.getViewModel().set({
                    sendToName: c.chat_name
                })
            }
            if (window.cefChat) {
                var t = Utils.getCmp('desktopChatView');
                if (t) {
                    var x = t.getViewModel();
                    x.set({
                        displayname: c.chat_name
                    })
                }
            }
        }
        LocalDataMgr.wsAddMemMsg(g, c, h)
    },
    pushMemsToArray: function (c, e, f) {
        var b = JSON.parse(e),
            d = JSON.parse(f);
        for (var a = 0; a < b.length; a++) {
            c.push({
                user_id: b[a],
                user_name: d[a]
            })
        }
        return c
    },
    handleChgChatHeader: function (f, g) {
        var b = f.data;
        if (b.operator_id == User.ownerID && User.devType == f.device_type) {
            return
        }
        var a = JSON.parse(b.message);
        var c = GroupNotice.chgName(b.operator_name, a.message);
        var e = Ext.getStore('comRct').getById(a.chat_id);
        if (e) {
            e.set({
                name: a.message,
                last_post_at: new Date(a.create_at),
                last_post_msg: c,
                last_msg_type: MsgType.GroupNotice,
                last_post_name: b.operator_name
            })
        }
        var j = AddDataUtil.isMsgViewBottom();
        var d = Ext.getStore(a.chat_id);
        if (d) {
            d.add({
                msg_id: a.msg_id,
                msgSeq: a.msg_seq,
                showTime: ParseUtil.dataShowTime(d, a.create_at),
                updateTime: a.create_at,
                GrpChangeMsg: c,
                showGrpChange: !0
            })
        }
        if (User.crtChannelId == a.chat_id) {
            if (j) {
                AddDataUtil.onScrolMsgView()
            }
            var h = Ext.Viewport.lookup('IM');
            if (h) {
                h.getViewModel().set({
                    sendToName: a.message
                })
            }
            User.rightTitle = a.message;
            if (Ext.isObject(g)) {
                var i = g.callback;
                if (Ext.isFunction(i)) {
                    i(a.message)
                }
            }
        }
        LocalDataMgr.updateChatName(c, a, b.operator_name)
    },
    toggleDismissMultChat: function (b, e) {
        if (b.data.operator_id == User.ownerID && b.device_type == User.devType) {
            return
        }
        var a = JSON.parse(b.data.message);
        var c = b.data.chat_id;
        var j = b.data.header;
        var d = GroupNotice.dismissMultiChat(a.user_id);
        if (!e) {
            d = GroupNotice.recoverMultiChat(a.user_id)
        }
        var f = Ext.getStore('comRct').getById(c);
        if (f) {
            f.set({
                last_msg_type: MsgType.GroupNotice,
                last_post_at: new Date(a.create_at),
                last_post_msg: d,
                last_post_name: b.data.operator_name
            })
        }
        var g = e ? '2' : '0';
        LocalDataMgr.updateChatStatus(c, g);
        LocalDataMgr.insertNotice({
            msg_id: a.msg_id,
            msg_seq: a.msg_seq,
            chat_id: c,
            msg_type: MsgType.GroupNotice,
            content: d,
            create_at: a.create_at,
            sender_id: a.user_id,
            sender_name: b.data.operator_name,
            status: '0'
        });
        if (User.crtChannelId == a.chat_id) {
            var i = Ext.Viewport.lookup('IM');
            if (i != null) {
                ChatHelper.updateRctChatStatus(a.chat_id, g);
                ChatHelper.updateUIForMultiChatHeader(e, User.crtUser.user_id == b.data.operator_id);
                ChatHelper.updateUIForRecent(c, j, d, a.msg_type, a.create_at, b.data.operator_name);
                ChatHelper.updateUIWithNotice(c, a.msg_seq, a.msg_id, d, a.create_at)
            } else {
                var h = Ext.Viewport.lookup('cefOneChat');
                if (h != null) {
                    DesktopChatUtil.updateUIForMultiChatHeader(e, User.crtUser.user_id == b.data.operator_id);
                    DesktopChatUtil.updateUIWithNotice(c, a.msg_seq, a.msg_id, d, a.create_at)
                }
            }
        }
    },
    handleDismissMultiChat: function (a) {
        var b = this;
        b.toggleDismissMultChat(a, !0)
    },
    handleRecoverMultiChat: function (a) {
        var b = this;
        b.toggleDismissMultChat(a, !1)
    },
    handleJoinERPMultiChat: function (b) {
        if (b.data.user_id == User.ownerID && b.device_type == User.devType) {
            return
        }
        var a = JSON.parse(b.data.message);
        var c = b.data.chat_id;
        var j = b.data.header;
        var d = GroupNotice.joinERPChat(b.data.user_id);
        var g = Ext.getStore('comRct').getById(c);
        if (g) {
            g.set({
                last_msg_type: MsgType.GroupNotice,
                last_post_at: new Date(a.create_at),
                last_post_msg: d,
                last_post_name: b.data.user_name
            })
        }
        LocalDataMgr.insertNotice({
            msg_id: a.msg_id,
            msg_seq: a.msg_seq,
            chat_id: c,
            msg_type: MsgType.GroupNotice,
            content: d,
            create_at: a.create_at,
            sender_id: a.user_id,
            sender_name: b.data.user_name,
            status: '0'
        });
        if (User.crtChannelId == a.chat_id) {
            var i = Ext.Viewport.lookup('IM');
            if (i != null) {
                ChatHelper.updateUIForRecent(c, j, d, a.msg_type, a.create_at, b.data.user_name);
                ChatHelper.updateUIWithNotice(c, a.msg_seq, a.msg_id, d, a.create_at)
            } else {
                var h = Ext.Viewport.lookup('cefOneChat');
                if (h != null) {
                    DesktopChatUtil.updateUIWithNotice(c, a.msg_seq, a.msg_id, d, a.create_at)
                }
            }
            if (Config.isPC) {
                var e = {
                    user_id: b.data.user_id,
                    user_name: b.data.user_name
                };
                if (window.cefChat) {
                    e.showMobile = DesktopChatUtil.showMobile(b.data.user_id);
                    e.resCls = DesktopChatUtil.parseGrpListCls(b.data.user_id).cls;
                    e.isOnline = DesktopChatUtil.parseGrpListCls(b.data.user_id).isOnline
                }
                var f = Ext.getStore('rgList');
                if (f) {
                    f.add(e)
                }
            }
        }
    },
    handleViewChat: function (c) {
        var e = c.device_type,
            d = c.data.chat_id;
        if (e != User.devType) {
            var b = Ext.getStore('comRct');
            if (b) {
                var a = b.getById(d);
                if (a) {
                    a.set({
                        isUnRead: !1,
                        unReadNum: 0
                    })
                }
            }
            LocalDataMgr.rctSetUnreadToRead(d);
            if (Config.isPhone) {
                PushNotification.resetBadgeNum()
            }
        }
    },
    handleMemRemoveEvent: function (c) {
        var b = this;
        var a = c.data;
        if (a.remover_id == User.ownerID) {
            if (c.device_type == User.devType) {
                return
            }
            b.doMemRemoveAboutMe(a)
        } else {
            if (a.user_id == User.ownerID) {
                b.doMemRemoveAboutMe(a)
            } else {
                b.doMemRemoveWithoutMe(a)
            }
        }
    },
    doMemRemoveAboutMe: function (a) {
        var b = JSON.parse(a.message);
        var c = GroupNotice.removeMem(a.remover_id, a.remover_name, a.user_id, a.user_name);
        var h = Ext.getStore('comRct');
        if (h) {
            var g = h.getById(a.chat_id);
            if (g) {
                g.set({
                    last_msg_type: MsgType.GroupNotice,
                    last_post_msg: c,
                    last_post_at: new Date(b.create_at)
                })
            }
        }
        if (User.crtChannelId == a.chat_id) {
            var d = Ext.getStore(a.chat_id);
            if (d) {
                var i = ParseUtil.dataShowTime(d, b.create_at);
                d.add({
                    showTime: i,
                    msg_id: b.msg_id,
                    msgSeq: b.msg_seq,
                    updateTime: b.create_at,
                    GrpChangeMsg: c,
                    showGrpChange: !0
                })
            }
            if (Config.isPC) {
                var f = Ext.getStore('rgList'),
                    e = f.getById(a.user_id);
                if (e) {
                    f.remove(e)
                }
            }
        }
        LocalDataMgr.doChatAfterRemoveUserByWS(a.chat_id, a.user_id);
        LocalDataMgr.doMsgAfterRemoveUserByWS(a.chat_id, b, c)
    },
    doMemRemoveWithoutMe: function (a) {
        var b = JSON.parse(a.message);
        var f = GroupNotice.removeMem(a.remover_id, a.remover_name, a.user_id, a.user_name);
        if (User.crtChannelId == a.chat_id) {
            if (Config.isPC) {
                var d = Ext.getStore('rgList'),
                    c = d.getById(a.user_id);
                if (c) {
                    d.remove(c)
                }
            }
            var e = Ext.getStore(a.chat_id);
            if (e) {
                e.add({
                    showTime: !1,
                    notShowGrpChange: !0,
                    msg_id: b.msg_id,
                    msg_seq: b.msg_seq,
                    updateTime: b.create_at
                })
            }
        }
        LocalDataMgr.doChatAfterRemoveUserByWS(a.chat_id, a.user_id);
        LocalDataMgr.doMsgAtrRmUserByWSWOM(a.chat_id, b, f)
    },
    handleMgrChgEvent: function (d, c) {
        var b = this;
        var a = d.data;
        if (a.old_manager == User.ownerID) {
            if (d.device_type == User.devType) {
                return
            }
            b.doChgMgrAboutMe(a, c)
        } else {
            if (a.new_manager == User.ownerID) {
                b.doChgMgrAboutMe(a, c)
            } else {
                b.doChgMgrWithoutMe(a)
            }
        }
    },
    doChgMgrAboutMe: function (a, i) {
        var b = JSON.parse(a.message);
        var c = GroupNotice.chgMgr(a.old_manager, a.old_manager_name, a.new_manager, a.new_manager_name);
        var g = Ext.getStore('comRct').getById(a.chat_id);
        if (g) {
            g.set({
                last_msg_type: MsgType.GroupNotice,
                last_post_msg: c,
                last_post_at: new Date(b.create_at)
            })
        }
        if (User.crtChannelId == a.chat_id) {
            var h = Ext.getStore(a.chat_id);
            if (h) {
                var k = AddDataUtil.isMsgViewBottom();
                h.add({
                    msg_id: b.msg_id,
                    msgSeq: b.msg_seq,
                    updateTime: b.create_at,
                    GrpChangeMsg: c,
                    showGrpChange: !0
                });
                if (k) {
                    AddDataUtil.onScrolMsgView()
                }
            }
            if (Config.isPC) {
                var e = Ext.getStore('rgList'),
                    d = e.getById(a.new_manager);
                if (d) {
                    d.set({
                        isManager: !0
                    })
                }
                var f = e.getById(a.old_manager);
                if (f) {
                    f.set({
                        isManager: !1
                    })
                }
                if (Ext.isObject(i)) {
                    var j = i.callback;
                    if (Ext.isFunction(j)) {
                        j(a.new_manager)
                    }
                }
            }
        }
        LocalDataMgr.doChatAfterChgMgrByWS(a.chat_id, a.new_manager);
        LocalDataMgr.doMsgAfterChgMgrByWS(a.chat_id, b, c)
    },
    doChgMgrWithoutMe: function (a) {
        var b = JSON.parse(a.message);
        var g = GroupNotice.chgMgr(a.old_manager, a.old_manager_name, a.new_manager, a.new_manager_name);
        if (User.crtChannelId == a.chat_id) {
            if (Config.isPC) {
                var d = Ext.getStore('rgList'),
                    c = d.getById(a.new_manager);
                if (c) {
                    c.set({
                        isManager: !0
                    })
                }
                var e = d.getById(a.old_manager);
                if (e) {
                    e.set({
                        isManager: !1
                    })
                }
            }
            var f = Ext.getStore(a.chat_id);
            if (f) {
                f.add({
                    showTime: !1,
                    notShowGrpChange: !0,
                    msg_id: b.msg_id,
                    msg_seq: b.msg_seq,
                    updateTime: b.create_at
                })
            }
        }
        LocalDataMgr.doChatAfterChgMgrByWS(a.chat_id, a.new_manager);
        LocalDataMgr.doMsgAfterChgMgrByWSWOM(a.chat_id, b, g)
    },
    handleRevokeEvent: function (a, d) {
        var e = a.data.user_id,
            l = a.device_type;
        if (User.ownerID == e && l == User.devType) {
            return
        }
        var c = a.broadcast.chat_id;
        var f = a.data.msg_id;
        var h = '撤销了一条消息,' + a.data.messager_id;
        var k = GroupNotice.getRevokeNotice(a.data.user_id, h);
        LocalDataMgr.revokeUpdateRct(c, f, a.data.user_id, h, function () {
            var e = Ext.getStore('comRct'),
                b = e.getById(c);
            if (b) {
                b.set({
                    last_msg_type: MsgType.Revoke,
                    last_post_id: a.data.user_id,
                    last_post_name: User.userInfos[a.data.user_id].user_name,
                    last_post_msg: k
                })
            }
        });
        LocalDataMgr.doWebSocketRevoke(c, f, a.data.user_id, h, function () {
            if (Config.isPC) {
                if (Ext.isObject(d)) {
                    if (Ext.isFunction(d.asyncCallback)) {
                        d.asyncCallback(c)
                    }
                }
            }
        });
        if (Config.isPC) {
            if (Ext.isObject(d)) {
                if (Ext.isFunction(d.callback)) {
                    d.callback(c, f, e, h)
                }
            }
        } else {
            if (Config.isPad || Ext.os.is.tablet) {
                var g = Ext.getStore(c);
                if (!g) {
                    return
                }
                var b = g.findRecord('msg_id', f);
                if (b) {
                    b.set('msg_type', MsgType.Revoke);
                    b.set('senderID', e);
                    b.set('senderName', User.userInfos[e].user_name)
                }
            } else {
                if (User.crtChannelId == c) {
                    var i;
                    var j = Ext.Viewport.lookup('IMMobile').down('#chatview');
                    if (j) {
                        i = j.down('#msgView')
                    }
                    if (i) {
                        var g = i.getStore();
                        var b = g.findRecord('msg_id', f);
                        if (b) {
                            b.set('msg_type', MsgType.Revoke);
                            b.set('senderID', e);
                            b.set('senderName', User.userInfos[e].user_name);
                            b.set('sendText', k)
                        }
                    }
                }
            }
        }
    },
    handleGetBigFile: function (a) {
        var h = a.broadcast.user_id || a.data.user_id,
            g = a.data.chat_id,
            f = a.data.msg_id,
            e = a.device_type,
            b = a.data.file_id,
            i = parseInt(a.data.status, 10);
        if (h == User.ownerID && e == User.devType) {
            return
        }
        LocalDataMgr.getBigFileByWS({
            file_id: b,
            status: 9
        });
        User.removeBFileFromWait(b);
        if (Config.isDesktop) {
            Utils.getApp().getCefObj().notifyCanDownload(b);
            var d = Ext.getStore(g);
            if (d) {
                var c = d.getById(f);
                if (c) {
                    c.set({
                        fileStatus: 9
                    })
                }
            }
        }
    },
    handleMute: function (c) {
        var h = c.broadcast.user_id;
        if (h != User.ownerID) {
            return
        }
        var g = c.device_type;
        if (User.devType == g) {
            return
        }
        var f = c.data,
            b = f.chat_id,
            a = f.is_mute;
        if (Ext.isEmpty(b)) {
            return
        }
        if (Ext.isEmpty(a)) {
            a = 'N'
        }
        var e = Ext.getStore('comRct');
        if (e) {
            var d = e.getById(b);
            if (d) {
                d.set({
                    IsMute: a
                })
            }
        }
        LocalDataMgr.updateMute(b, a)
    },
    handleNap: function (d) {
        var f = d.broadcast.user_id;
        if (f != User.ownerID) {
            return
        }
        var e = d.device_type;
        if (User.devType == e) {
            return
        }
        var c = d.data;
        if (!Ext.isObject(c)) {
            return
        }
        var b = c.nap_type,
            a = c.nap_end;
        if (Ext.isEmpty(b)) {
            b = '0'
        }
        if (Ext.isEmpty(a)) {
            a = 0
        }
        a = parseInt(a, 10);
        User.settings.extras = {
            nap_type: b,
            nap_end: a
        };
        switch (b) {
            case '3':
                Ext.fireEvent('restShow', a);
                break;
            case '2':
                Ext.fireEvent('restShow', a);
                break;
            case '0':
            default:
                Ext.fireEvent('restHide');
                break;
        }
    },
    handleViewAt: function (f) {
        var j = f.broadcast.user_id;
        if (j != User.ownerID) {
            return
        }
        var i = f.device_type;
        if (User.devType == i) {
            return
        }
        var e = f.data;
        if (!Ext.isObject(e)) {
            return
        }
        var c = e.msg_id,
            b = e.chat_id;
        if (Ext.isEmpty(c)) {
            return
        }
        var a;
        if (Config.isPC) {
            a = ViewGet.getMsgView()
        } else {
            if (Config.isPad || Ext.os.is.tablet) {
                a = Ext.Viewport.down('IMPad').down('talkcontent')
            } else {
                a = Ext.Viewport.down('IMMobile').down('msgview')
            }
        }
        if (c.toLowerCase() === 'all') {
            LocalDataMgr.clearMentions(b);
            if (a) {
                AtUtil.doPageClearMention(b, a)
            }
        } else {
            LocalDataMgr.removeOneMention(b, c);
            if (a) {
                AtUtil.doPageRemoveMention(b, a);
                if (Config.isPad || Ext.os.is.tablet) {
                    a.getAtBtn().doBtnArray(b, c)
                } else {
                    if (Config.isPhone && User.crtChannelId == b) {
                        a.removeOneAt(c)
                    }
                }
            } else {
                if (Config.isPhone || Config.isPad || Ext.os.is.tablet) {
                    var g = Ext.getStore('comRct');
                    if (g) {
                        var d = g.getById(b),
                            h = d.get('MentionCount') - 1;
                        if (d) {
                            d.set({
                                MentionCount: h > 0 ? h : 0
                            })
                        }
                    }
                }
            }
        }
    },
    handlehisRange: function (d, i) {
        var h = this;
        var a = JSON.parse(d.data.message);
        var b;
        if (a.message == User.ownerID) {
            b = '你可以查看更多历史消息';
            var c;
            var g = 'SELECT * FROM IMChat WHERE ChatID=?';
            LocalDataMgr.cExecSqlWithP(g, [a.chat_id], function (e, f) {
                c = f.rows.item(0).CreateAt;
                var g = 'INSERT INTO IMMsg (MsgID, ChatID, MsgType, Content, CreateAt, Status, MsgSeq) VALUES (?,?,?,?,?,?,?);';
                e.executeSql(g, [a.msg_id, d.broadcast.chat_id, MsgType.GroupNotice, b, a.update_at, '0', a.msg_seq]);
                var h = 'UPDATE IMRct SET LastMessage=?,LastMsgType=?,LastPostAt=?,CreateAt=? WHERE ChatID=? ';
                console.log('当前的时间为：', c);
                e.executeSql(h, [b, MsgType.GroupNotice, a.update_at, c, d.broadcast.chat_id])
            });
            if (!window.cefMsgMgr) {
                var e = Ext.getStore('comRct').getById(a.chat_id);
                if (e) {
                    e.set({
                        last_msg_type: MsgType.GroupNotice,
                        last_post_msg: '通知',
                        last_post_at: new Date(a.create_at)
                    })
                } else {
                    h.addRctByHisWsPost(Ext.getStore('comRct'), a, function () {})
                }
            }
            if (User.crtChannelId == a.chat_id) {
                var f = Ext.getStore(a.chat_id);
                if (f) {
                    f.add({
                        msg_id: a.msg_id,
                        msgSeq: a.msg_seq,
                        updateTime: a.update_at,
                        GrpChangeMsg: b,
                        showGrpChange: !0
                    })
                }
                AddDataUtil.onScrolMsgView()
            }
        }
    },
    handleSeeHis: function (d, i) {
        var g = this;
        var a = JSON.parse(d.data.message);
        var b;
        if (a.user_id == User.ownerID) {
            b = '<span class="' + User.userInfos[a.message].user_id + '">' + User.userInfos[a.message].user_name + '申请查看更多历史消息</span> ' + '     <a>设置</a>';
            var c;
            var h = 'SELECT * FROM IMChat WHERE ChatID=?';
            LocalDataMgr.cExecSqlWithP(h, [a.chat_id], function (e, f) {
                c = f.rows.item(0).CreateAt;
                var g = 'INSERT INTO IMMsg (MsgID, ChatID, MsgType, Content, CreateAt, Status, MsgSeq) VALUES (?,?,?,?,?,?,?);';
                e.executeSql(g, [a.msg_id, d.broadcast.chat_id, MsgType.GroupNotice, b, a.update_at, '0', a.msg_seq]);
                var h = 'UPDATE IMRct SET LastMessage=?,LastMsgType=?,LastPostAt=?,CreateAt=? WHERE ChatID=? ';
                console.log('当前的时间为：', c);
                e.executeSql(h, [b, MsgType.GroupNotice, a.update_at, c, d.broadcast.chat_id])
            });
            if (!window.cefMsgMgr) {
                var e = Ext.getStore('comRct').getById(a.chat_id);
                if (e) {
                    e.set({
                        last_msg_type: MsgType.GroupNotice,
                        last_post_msg: '通知',
                        last_post_at: new Date(a.create_at)
                    })
                } else {
                    g.addRctByHisWsPost(Ext.getStore('comRct'), a, function () {})
                }
            }
            if (User.crtChannelId == a.chat_id) {
                var f = Ext.getStore(a.chat_id);
                if (f) {
                    f.add({
                        msg_id: a.msg_id,
                        msgSeq: a.msg_seq,
                        updateTime: a.update_at,
                        GrpChangeMsg: b,
                        showGrpChange: !0
                    })
                }
                AddDataUtil.onScrolMsgView()
            }
            g.notifyWrapper(a)
        }
    },
    handleReplied: function (a) {},
    handleNewsMessage: function (j) {
        if (ConfigMgr.isAio8()) {
            return
        }
        if (j.device_type == User.devType) {
            return
        }
        var i = j.data,
            a = JSON.parse(i.message);
        a.news_seq = i.news_seq;
        a.chat_id = StaticChatID.News;
        a.chat_type = ChatType.News;
        a.msg_type = ChatType.News;
        var f = Ext.getStore('comRct'),
            b;
        if (Config.isPC) {
            b = ViewGet.getNewstView() ? ViewGet.getNewstView().down('newsviewlist') : ''
        } else {
            b = Ext.Viewport.lookup('IMMobile').down('newsviewlist')
        }
        if (f) {
            var e = f.getById(StaticChatID.News);
            if (!e) {
                f.add({
                    chat_id: a.chat_id,
                    name: '消息中心',
                    type: ChatType.News,
                    last_post_at: new Date(a.create_at),
                    last_post_msg: a.title || a.description,
                    last_post_name: '系统',
                    last_msg_type: a.news_type,
                    isUnRead: !0,
                    unReadNum: 1,
                    create_at: a.create_at
                })
            } else {
                var c = e.get('unReadNum') + 1;
                if (b && User.crtChannelId == StaticChatID.News) {
                    c = 0;
                    if (Config.isPhone) {
                        ChatUtil.viewNews()
                    }
                }
                a.unReadNum = c;
                e.set({
                    last_post_at: new Date(a.create_at),
                    last_post_msg: a.title || a.description,
                    isUnRead: c > 0 ? !0 : !1,
                    unReadNum: c
                })
            }
            LocalDataMgr.newsToLocalChat(a);
            LocalDataMgr.newsToLocalRct(a)
        }
        if (b && User.crtChannelId == StaticChatID.News) {
            var h = b.getStore(),
                d = h.last(),
                g = !0,
                k;
            if (d) {
                k = d.get('updateTime')
            }
            if (ParseUtil.inOneMinute(d, a.create_at)) {
                g = !1
            }
            h.add({
                newsID: a.news_id,
                newsType: a.news_type,
                title: a.title,
                desc: a.description,
                updateTime: a.create_at,
                newsSeq: a.news_seq,
                picUrl: a.pic_url,
                desUrl: a.des_url,
                isText: a.is_text,
                extras: a.extras,
                creatorID: a.creator_id,
                showTime: g
            });
            if (Config.isPC) {
                AddDataUtil.onScroll(b)
            } else {
                b.scrollToBottom()
            }
            LocalDataMgr.saveToLocalNews(a)
        }
        this.notifyWrapper(a)
    },
    handlePushMail: function (b) {
        var e = 'mail',
            d = b.data.total_count || 0,
            c = b.data.mail_count || 0;
        if (Config.isPC) {} else {
            var a = Ext.Viewport.down('IMMobile'),
                f = a.down('IMMobile-WorkDesk');
            f.updateModuleBadge(e, d, c);
            a.push({
                xtype: 'mobile-notice',
                content: '您有新邮件'
            })
        }
    },
    handleUpdateMailBadge: function (g) {
        var h = g.data.total;
        var a = JSON.parse(g.data.details);
        var c, k, j;
        if (Config.isPC) {} else {
            var e = Ext.Viewport.down('IMMobile'),
                i = e.getViewModel(),
                d = e.down('IMMobile-WorkDesk');
            c = d.getViewModel();
            i.setData({
                wkBadgeNum: h
            });
            if (!a || a.length < 1) {
                return
            }
            for (var b = 0; b < a.length; b++) {
                var f = a[b];
                c.getData()['module_' + f.item_type] = f.item_badge
            }
            d.setBadge()
        }
    },
    handlePushNotice: function (a) {
        var b = 'notice',
            e = a.data.total_count || 0,
            d = a.data.notice_count || 0;
        if (a.data.module) {
            b = a.data.module.toLocaleLowerCase()
        }
        if (Config.isPC) {} else {
            var c = Ext.Viewport.down('IMMobile'),
                f = c.down('IMMobile-WorkDesk');
            f.updateModuleBadge(b, e, d);
            c.push({
                xtype: 'mobile-notice',
                content: '您有新公告'
            })
        }
    },
    handleUpdateRead: function (f) {
        var b = f.data;
        if (!IMHelper.canUseReceipt()) {
            return
        }
        if (b.dataStr) {
            b = b.dataStr.split('|');
            var d = b[0],
                e = b[1];
            if (e) {
                LocalDataMgr.updateMsgWithReadCount(e, 1)
            }
            if (!d) {
                return
            }
            var c;
            if (Config.isPC) {
                c = Ext.getStore(d)
            } else {
                if (d == User.crtChannelId) {
                    c = Ext.Viewport.down('msgview').getStore()
                }
            }
            var a = c ? c.findRecord('msg_id', e) : null;
            if (a) {
                a.set('read_count', a.data.read_count + 1);
                a.set('unread_count', a.data.unread_count - 1 < 0 ? 0 : a.data.unread_count - 1)
            }
        }
    },
    handleUpdateCommonPushes: function (d) {
        if (!Utils.isCEF()) {
            var a = d.data;
            var b = Ext.Viewport.down('IMMobile');
            var e = b.down('mainTabPanel');
            var c = b.down('IMMobile-WorkDesk');
            if (a.module === 'approve') {} else {
                c.updateModuleBadge(a.module, a.totalCount, a.moduleCount)
            }
        }
    },
    doAddCrowdToPage: function (c, b, e, d, a) {
        return c.insert(0, {
            chat_id: b.chat_id,
            name: a.DisplayName,
            type: a.ChatType,
            last_post_at: new Date(b.create_at),
            last_post_msg: '[通知]',
            last_msg_type: 'G',
            isUnRead: !0,
            unReadNum: 1,
            avaHash: a.AvatarHash,
            avaID: b.chat_id,
            avaRefresh: (new Date()).getTime(),
            create_at: a.CreateAt,
            IsMute: e,
            members: d
        })
    },
    handleCrowdNoticeMessage: function (e) {
        var a = e.data,
            b;
        if (Config.isPC) {
            if (window.cefChat) {
                b = Utils.getCmp('desktopChatView').lookup('desktopChatList')
            } else {
                b = ViewGet.getMsgView()
            }
        } else {
            b = Ext.Viewport.lookup('IMMobile').down('msgview')
        }
        message = JSON.parse(a.message);
        var d = Ext.getStore('comRct');
        var c;
        var f = this;
        Utils.custAjax('get', 'chatcs/' + message.chat_id, {
            success: function (g) {
                LocalDataMgr.UpdateCrowd(g, function (m, l) {
                    if (d) {
                        var j = d.getById(g.chat_id);
                        if (!j) {
                            d.add({
                                chat_id: a.chat_id,
                                name: g.header,
                                type: 'C',
                                last_post_at: new Date(g.update_at),
                                last_post_msg: '[通知]',
                                avaHash: g.avatar_hash,
                                avaID: a.chat_id,
                                last_msg_type: 'N',
                                last_post_name: User.userInfos[a.user_id].user_name,
                                last_post_id: a.user_id,
                                isUnRead: !0,
                                unReadNum: 1,
                                create_at: g.create_at
                            })
                        } else {
                            c = j.get('unReadNum') + 1;
                            if (User.crtChannelId == a.chat_id) {
                                c = 0;
                                if (Config.isPC) {
                                    if (!window.cefCrowdSetting) {
                                        ChatHelper.setcrowdNotice(g.notice)
                                    }
                                }
                            }
                            j.set({
                                last_post_at: new Date(a.updateat),
                                last_post_name: User.userInfos[a.user_id].user_name,
                                last_post_id: a.user_id,
                                last_post_msg: '[通知]',
                                isUnRead: c > 0 ? !0 : !1,
                                unReadNum: c,
                                last_msg_type: 'N'
                            })
                        }
                    }
                    LocalDataMgr.CrowdInfoToLocalChat(g);
                    LocalDataMgr.CrowdToLocalRct(g, c, a.msg_type, a);
                    if (User.crtChannelId == a.chat_id) {
                        if (Config.isPC) {
                            var i = Ext.getStore(User.crtChannelId),
                                f = i.last(),
                                h = !0,
                                k;
                            if (f) {
                                k = f.get('updateTime')
                            }
                            if (ParseUtil.inOneMinute(f, a.updateat)) {
                                h = !1
                            }
                            if (window.cefChat) {
                                if (!window.cefCrowdSetting) {
                                    ChatUtil.setcrowdNotice(g.notice)
                                }
                            }
                        } else {
                            if (b) {
                                var i = b.getStore(),
                                    f = i.last(),
                                    h = !0,
                                    k;
                                if (f) {
                                    k = f.get('updateTime')
                                }
                                if (ParseUtil.inOneMinute(f, a.updateat)) {
                                    h = !1
                                }
                            }
                        }
                        i.add({
                            msg_id: a.msg_id,
                            msgSeq: a.msgseq,
                            showTime: h,
                            updateTime: a.updateat,
                            senderID: a.user_id,
                            senderName: User.userInfos[a.user_id].user_name,
                            msg_type: a.msg_type,
                            status: '0'
                        });
                        if (Config.isPC) {
                            AddDataUtil.onScroll(b)
                        } else {
                            b.scrollToBottom()
                        }
                    }
                    LocalDataMgr.saveToLocalMsg(a)
                });
                f.notifyWrapper(a)
            },
            failure: function () {}
        })
    },
    handleCrowdSetAdminMessage: function (g) {
        var a = g.data,
            d, b;
        if (Config.isPC) {
            if (window.cefChat) {
                b = Utils.getCmp('desktopChatView').lookup('desktopChatList')
            } else {
                b = ViewGet.getMsgView()
            }
        } else {
            b = Ext.Viewport.lookup('IMMobile').down('msgview')
        }
        var e = Ext.getStore('comRct');
        var c;
        var f = this;
        Utils.custAjax('get', 'chatcs/' + a.chat_id, {
            success: function (h) {
                LocalDataMgr.UpdateCrowd(h, function (u, t) {
                    if (a.admins == null) {
                        var j;
                        if (User.ownerID == a.users[0]) {
                            j = '您被撤销了管理员';
                            d = 'G'
                        } else {
                            if (User.ownerID == a.user_id) {
                                j = '你撤销了' + User.userInfos[a.users[0]].user_name + '的管理员';
                                d = 'G'
                            } else {
                                j = User.userInfos[a.users[0]].user_name + '被撤销了管理员';
                                d = 'S'
                            }
                        }
                        if (User.ownerID == a.users[0] || User.ownerID == a.user_id) {
                            if (e) {
                                var m = e.getById(h.chat_id);
                                if (!m) {
                                    e.add({
                                        chat_id: a.chat_id,
                                        name: h.header,
                                        type: 'C',
                                        last_post_at: new Date(h.update_at),
                                        last_post_msg: '[通知]',
                                        last_post_name: User.userInfos[a.user_id].user_name,
                                        last_post_id: a.user_id,
                                        avaHash: h.avatar_hash,
                                        avaID: a.chat_id,
                                        last_msg_type: 'S',
                                        isUnRead: !0,
                                        unReadNum: 1,
                                        create_at: h.create_at
                                    })
                                } else {
                                    c = m.get('unReadNum') + 1;
                                    if (User.crtChannelId == a.chat_id) {
                                        c = 0;
                                        if (Config.isPC) {
                                            var o = Ext.getStore('rgList').getById(a.users[0]);
                                            o.set('isadmin', 'N')
                                        }
                                    }
                                    m.set({
                                        last_post_at: new Date(a.updateat),
                                        last_post_msg: '[通知]',
                                        last_post_name: User.userInfos[a.user_id].user_name,
                                        last_post_id: a.user_id,
                                        isUnRead: c > 0 ? !0 : !1,
                                        unReadNum: c,
                                        last_msg_type: 'S'
                                    })
                                }
                            }
                            LocalDataMgr.CrowdInfoToLocalChat(h);
                            LocalDataMgr.CrowdToLocalRct(h, c, a.msg_type, a);
                            if (User.crtChannelId == a.chat_id) {
                                if (Config.isPC) {
                                    var l = Ext.getStore(User.crtChannelId),
                                        i = l.last(),
                                        k = !0,
                                        n;
                                    if (i) {
                                        n = i.get('updateTime')
                                    }
                                    if (ParseUtil.inOneMinute(i, a.updateat)) {
                                        k = !1
                                    }
                                } else {
                                    if (b) {
                                        var l = b.getStore(),
                                            i = l.last(),
                                            k = !0,
                                            n;
                                        if (i) {
                                            n = i.get('updateTime')
                                        }
                                        if (ParseUtil.inOneMinute(i, a.updateat)) {
                                            k = !1
                                        }
                                    }
                                }
                                l.add({
                                    msg_id: a.msg_id,
                                    msgSeq: a.msgseq,
                                    showTime: k,
                                    updateTime: a.updateat,
                                    msg_type: d,
                                    GrpChangeMsg: j,
                                    showGrpChange: !0,
                                    status: '0'
                                });
                                if (Config.isPC) {
                                    AddDataUtil.onScroll(b)
                                } else {
                                    b.scrollToBottom()
                                }
                            }
                            f.notifyWrapper(a)
                        }
                        LocalDataMgr.saveCrowdSetMsg(a, j, d);
                        var r = 'UPDATE IMChatCM SET IsAdmin=? WHERE (ChatID=? AND BodyID=?);';
                        LocalDataMgr.cExecSqlWithP(r, ['N', a.chat_id, a.users[0]])
                    } else {
                        var j;
                        var q = [];
                        var s = !1;
                        for (var p = 0; p < a.admins.length; p++) {
                            q.push(User.getUserName(a.admins[p]));
                            if (User.ownerID == a.admins[p]) {
                                s = !0
                            }
                            if (User.crtChannelId == a.chat_id) {
                                if (Config.isPC) {
                                    var o = Ext.getStore('rgList').getById(a.admins[p]);
                                    o.set('isadmin', 'Y')
                                }
                            }
                        }
                        if (s) {
                            j = '您被设置为管理员';
                            d = 'G'
                        } else {
                            if (User.ownerID == a.user_id) {
                                j = '你设置了' + q.join('、') + '为管理员';
                                d = 'G'
                            } else {
                                j = q.join('、') + '被设置为管理员';
                                d = 'S'
                            }
                        }
                        if (User.ownerID == a.admins[0] || User.ownerID == a.user_id) {
                            if (e) {
                                var m = e.getById(h.chat_id);
                                if (!m) {
                                    e.add({
                                        chat_id: a.chat_id,
                                        name: h.header,
                                        type: 'C',
                                        last_post_at: new Date(h.update_at),
                                        last_post_msg: '[通知]',
                                        last_post_name: User.userInfos[a.user_id].user_name,
                                        last_post_id: a.user_id,
                                        avaHash: h.avatar_hash,
                                        avaID: a.chat_id,
                                        last_msg_type: 'S',
                                        isUnRead: !0,
                                        unReadNum: 1,
                                        create_at: h.create_at
                                    })
                                } else {
                                    c = m.get('unReadNum') + 1;
                                    if (User.crtChannelId == a.chat_id) {
                                        c = 0;
                                        if (Config.isPC) {
                                            var o = Ext.getStore('rgList').getById(a.admins[0]);
                                            o.set('isadmin', 'Y')
                                        }
                                    }
                                    m.set({
                                        last_post_at: new Date(a.updateat),
                                        last_post_msg: '[通知]',
                                        last_post_name: User.userInfos[a.user_id].user_name,
                                        last_post_id: a.user_id,
                                        isUnRead: c > 0 ? !0 : !1,
                                        unReadNum: c,
                                        last_msg_type: 'S'
                                    })
                                }
                            }
                            LocalDataMgr.CrowdInfoToLocalChat(h);
                            LocalDataMgr.CrowdToLocalRct(h, c, a.msg_type, a);
                            if (User.crtChannelId == a.chat_id) {
                                if (Config.isPC) {
                                    var l = Ext.getStore(User.crtChannelId),
                                        i = l.last(),
                                        k = !0,
                                        n;
                                    if (i) {
                                        n = i.get('updateTime')
                                    }
                                    if (ParseUtil.inOneMinute(i, a.updateat)) {
                                        k = !1
                                    }
                                } else {
                                    if (b) {
                                        var l = b.getStore(),
                                            i = l.last(),
                                            k = !0,
                                            n;
                                        if (i) {
                                            n = i.get('updateTime')
                                        }
                                        if (ParseUtil.inOneMinute(i, a.updateat)) {
                                            k = !1
                                        }
                                    }
                                }
                                l.add({
                                    msg_id: a.msg_id,
                                    msgSeq: a.msgseq,
                                    showTime: k,
                                    updateTime: a.updateat,
                                    msg_type: d,
                                    GrpChangeMsg: j,
                                    showGrpChange: !0,
                                    status: '0'
                                });
                                if (Config.isPC) {
                                    AddDataUtil.onScroll(b)
                                } else {
                                    b.scrollToBottom()
                                }
                            }
                            f.notifyWrapper(a)
                        }
                        LocalDataMgr.saveCrowdSetMsg(a, j, d);
                        var r = 'UPDATE IMChatCM SET IsAdmin=? WHERE (ChatID=? AND BodyID=?);';
                        LocalDataMgr.cExecSqlWithP(r, ['Y', a.chat_id, a.admins[0]])
                    }
                })
            },
            failure: function () {}
        })
    }
}, 0, 0, 0, 0, 0, 0, [IMCommon.utils, 'SocketEventUtil', 0, 'SocketEventUtil'], 0);
Ext.cmd.derive('IMCommon.utils.UpFileMgr', Ext.Base, {
    alternateClassName: 'UpFileMgr',
    singleton: !0,
    upMap: {},
    pushFileToQue: function (c) {
        var a = c.chat_id,
            b = !1;
        if (!UpFileMgr[a]) {
            UpFileMgr[a] = [];
            b = !0
        }
        UpFileMgr[a].push(c);
        if (b) {
            UpFileMgr.upFile(UpFileMgr[a].shift())
        }
    },
    upFile: function (c) {
        var a = this;
        var b = c.chat_id,
            e = c.localPath,
            f = c.attach_id,
            j = 'Y';
        var d = new FileUploadOptions(),
            i = FileUtil.getExtension(e, !0),
            k = MimeType.getMimeType(i);
        d.fileKey = 'files';
        d.fileName = FileUtil.getFileName(e);
        d.mimeType = k;
        d.params = {
            chat_id: c.chat_id,
            client_ids: c.client_id,
            file_id: f,
            is_origins: j
        };
        var g = c.msg_id;
        var h = new FileTransfer();
        UpFileMgr.upMap[f] = h;
        h.onprogress = function (d) {
            if (d.lengthComputable) {
                var e = (d.loaded / d.total * 100).toFixed(2);
                a.setPageStus(b, g, {
                    fileProgress: e,
                    fileStatus: 2
                })
            }
        };
        var l = e.replace(/file:[\/]+/g, '');
        h.upload(l, encodeURI(Config.httpUrlForGo + 'files?token=' + User.token), function (l) {
            delete UpFileMgr.upMap[f];
            a.setPageStus(b, g, {
                fileStatus: 0
            });
            var h = JSON.parse(l.response);
            for (var d = 0; d < h.files.length; d++) {
                var i = h.files[d];
                i.chat_id = b;
                if (Config.isPhone && a.formOutBox > 0) {
                    a.formOutBox = a.formOutBox - 1;
                    var j = ParseUtil.getCFileDir(h.files[d].create_at),
                        k = h.files[d].file_name;
                    FileMgr.solveDup(null, j, k).then(function (d) {
                        FileMgr.copyTo(null, e, 1, j + d).then(function (e) {
                            a.setPageStus(b, g, {
                                localPath: e
                            });
                            LocalDataMgr.afterDownFileSuc(i, e)
                        })['catch'](function (a) {
                            console.error('UpFileMgr', 'move failed', a)
                        })
                    })['catch'](function (a) {
                        console.error('UpFileMgr', 'solveDup failed', a)
                    })
                } else {
                    LocalDataMgr.afterUpFileSucNew(i)
                }
                a.doQueueUp(b)
            }
        }, function (d) {
            delete UpFileMgr.upMap[f];
            console.error('UpFileMgr', 'upload err', d);
            a.doQueueUp(b);
            a.setPageStus(b, g, {
                fileStatus: 1,
                failMsg: '文件上传失败，<a class="file_re_upload">重新上传</a>'
            })
        }, d)
    },
    abortUpFile: function (b, c) {
        if (UpFileMgr.upMap.hasOwnProperty(b)) {
            var a = UpFileMgr.upMap[b];
            if (a && a instanceof FileTransfer) {
                a.abort()
            }
        }
        this.doQueueUp(c)
    },
    setPageStus: function (c, e, d) {
        var a = Ext.getStore(c);
        if (Config.isPhone && User.crtChannelId == c) {
            a = Ext.Viewport.lookup('IMMobile').down('msgview').getStore()
        }
        if (!a) {
            return
        }
        var b = a.getById(e);
        if (!b) {
            return
        }
        b.set(d)
    },
    doQueueUp: function (a) {
        if (UpFileMgr[a]) {
            var b = UpFileMgr[a].shift();
            if (b) {
                UpFileMgr.upFile(b)
            } else {
                delete UpFileMgr[a]
            }
        }
    }
}, 0, 0, 0, 0, 0, 0, [IMCommon.utils, 'UpFileMgr', 0, 'UpFileMgr'], 0);
Ext.cmd.derive('IMCommon.utils.UpImgMgr', Ext.Base, {
    alternateClassName: 'UpImgMgr',
    singleton: !0,
    upFileForSrc: function (c) {
        var a = c.chat_id,
            b = !1;
        if (!UpImgMgr[a]) {
            UpImgMgr[a] = [];
            b = !0
        }
        UpImgMgr[a].push(c);
        if (b) {
            UpImgMgr.upFile(UpImgMgr[a].shift())
        }
    },
    upFile: function (c) {
        var f = this;
        var b = c.chat_id,
            a = c.localPath,
            g = c.is_origins;
        if (!c) {
            f.doQueueUp(b);
            return
        }
        if (!g) {
            g = 'Y'
        }
        a = a.replace(/localfile:[\/]+/g, 'file:///');
        if (!/file:[\/]+/g.test(a)) {
            a = 'file://' + a
        }
        var d = new FileUploadOptions();
        d.fileKey = 'files';
        d.fileName = FileUtil.getFileName(a);
        var i = MimeType.getMimeTypeByPath(a);
        d.mimeType = i;
        d.params = {
            chat_id: c.chat_id,
            client_ids: c.client_id,
            file_id: c.attach_id,
            is_origins: g
        };
        var e = c.msg_id;
        var h = new FileTransfer();
        h.onprogress = function (d) {
            if (d.lengthComputable) {
                var i = (d.loaded / d.total * 100).toFixed(2);
                var a;
                if (Config.isPhone) {
                    var g = Ext.Viewport.lookup('IMMobile').getActiveItem();
                    if (g.xtype == 'chatview') {
                        var f = g.down('#msgView');
                        if (f) {
                            a = f.getStore();
                            if (a.chatID != b) {
                                a = null
                            }
                        }
                    }
                } else {
                    a = Ext.getStore(b)
                }
                if (a) {
                    var h = a.getById(e);
                    if (h) {
                        h.set({
                            fileProgress: i,
                            fileStatus: 2
                        })
                    }
                }
            }
        };
        h.upload(a.replace(/file:[\/]+/g, ''), encodeURI(Config.httpUrlForGo + 'files?token=' + User.token), function (m) {
            var g;
            if (Config.isPhone) {
                var k = Ext.Viewport.lookup('IMMobile').getActiveItem();
                if (k.xtype == 'chatview') {
                    var j = k.down('#msgView');
                    if (j) {
                        g = j.getStore();
                        if (g.chatID != b) {
                            g = null
                        }
                    }
                }
            } else {
                g = Ext.getStore(b)
            }
            var i = JSON.parse(m.response);
            for (var h = 0; h < i.files.length; h++) {
                var d = i.files[h];
                d.chat_id = b;
                var l = ParseUtil.getCImgPath(d.file_id + '.' + d.extension, d.create_at);
                FileMgr.copyTo(null, c.fileURL || a, 1, l).then(function (f) {
                    var b = g.getById(e);
                    if (Ext.os.is.iOS) {
                        var h = User.getImageDir() + ParseUtil.getTimeYMStr(d.create_at) + d.file_id + '.' + d.extension;
                        FileMgr.copyTo(null, c.fileURL || a, 0, h).then(function (a) {
                            b.set({
                                localPath: a,
                                fileStatus: 0
                            })
                        })
                    } else {
                        if (b) {
                            b.set({
                                localPath: f,
                                fileStatus: 0
                            })
                        }
                    }
                    LocalDataMgr.afterUploadSuc(d, f, 'N')
                })['catch'](function (d) {
                    f.doQueueUp(b);
                    var a = g.getById(e);
                    if (a) {}
                    console.error('UpImgMgr', 'movePic failed', d)
                })
            }
            f.doQueueUp(b)
        }, function (g) {
            f.doQueueUp(b);
            var d = Ext.getStore(b);
            if (d) {
                var a = d.getById(e);
                if (a) {
                    a.set({
                        fileStatus: 1,
                        failMsg: g
                    })
                }
            }
        }, d)
    },
    doQueueUp: function (a) {
        if (UpImgMgr[a]) {
            var b = UpImgMgr[a].shift();
            if (b) {
                UpImgMgr.upFile(b)
            } else {
                delete UpImgMgr[a]
            }
        }
    }
}, 0, 0, 0, 0, 0, 0, [IMCommon.utils, 'UpImgMgr', 0, 'UpImgMgr'], 0);
Ext.cmd.derive('IMCommon.utils.WebSocketUtil', Ext.Base, {
    alternateClassName: 'WebSocketUtil',
    singleton: !0,
    MAX_WEBSOCKET_FAILS: 7,
    MIN_WEBSOCKET_RETRY_TIME: 3000,
    MAX_WEBSOCKET_RETRY_TIME: 300000,
    conn: null,
    sequence: 1,
    eventSequence: 0,
    connectFailCount: 0,
    eventCallback: null,
    responseCallbacks: {},
    firstConnectCallback: null,
    reconnectCallback: null,
    missedEventCallback: null,
    errorCallback: null,
    closeCallback: null,
    connectionUrl: '',
    connTimeOut: !1,
    initialize: function (c, d) {
        var a = this;
        if (this.conn) {
            return
        }
        if (c == null) {
            return
        }
        this.connectionUrl = c;
        if (this.connectFailCount === 0) {
            if (!Config.isPC) {
                var b = Ext.Viewport.down('IMMobile');
                if (b) {
                    b.down('IMMobile-Chat').down('IMMobile-Navbar').setTitle(b.specialTitle)
                }
            }
        }
        if (!User.token) {
            return
        }
        if (!Config.isPC && window.MobileHelper) {
            window.MobileHelper.calculateWsCntTimeOut()
        }
        this.conn = new WebSocket(this.connectionUrl + '?token=' + User.token);
        this.conn.onopen = function () {
            a.eventSequence = 0;
            if (d) {}
            if (a.connectFailCount > 0) {
                if (a.reconnectCallback) {
                    a.reconnectCallback()
                }
            } else {
                if (a.firstConnectCallback) {
                    a.firstConnectCallback()
                }
            }
            a.connectFailCount = 0;
            a.connTimeOut = !1
        };
        this.conn.onclose = function () {
            a.conn = null;
            a.sequence = 1;
            if (a.connectFailCount === 0) {}
            a.connectFailCount++;
            var b = a.MIN_WEBSOCKET_RETRY_TIME;
            if (a.connectFailCount > a.MAX_WEBSOCKET_FAILS) {
                b = a.MIN_WEBSOCKET_RETRY_TIME * a.connectFailCount * a.connectFailCount;
                if (b > a.MAX_WEBSOCKET_RETRY_TIME) {
                    b = a.MAX_WEBSOCKET_RETRY_TIME
                }
            }
            if (a.closeCallback) {
                a.closeCallback(a.connectFailCount, b)
            }
            setTimeout(function () {
                if (a.conn === null) {
                    a.initialize(a.connectionUrl, d)
                }
            }, b);
            a.connTimeOut = !1
        };
        this.conn.onerror = function (b) {
            if (a.connectFailCount <= 1) {}
            if (a.errorCallback) {
                a.errorCallback(b)
            }
            a.connTimeOut = !1
        };
        this.conn.onmessage = function (e) {
            var b;
            try {
                b = JSON.parse(e.data)
            } catch (f) {
                b = a.simpleToNomal(e.data)
            }
            if (b.seq_reply) {
                if (b.error) {}
                if (a.responseCallbacks[b.seq_reply]) {
                    a.responseCallbacks[b.seq_reply](b);
                    Reflect.deleteProperty(a.reconnectCallback, b.seq_reply)
                }
            } else {
                if (a.eventCallback) {
                    if (b.seq !== a.eventSequence && a.missedEventCallback) {
                        a.missedEventCallback()
                    }
                    a.eventSequence = b.seq + 1;
                    a.eventCallback(b)
                }
            }
        }
    },
    setEventCallback: function (a) {
        this.eventCallback = a
    },
    setFirstConnectCallback: function (a) {
        this.firstConnectCallback = a
    },
    setReconnectCallback: function (a) {
        this.reconnectCallback = a
    },
    setMissedEventCallback: function (a) {
        this.missedEventCallback = a
    },
    setErrorCallback: function (a) {
        this.errorCallback = a
    },
    setCloseCallback: function (a) {
        this.closeCallback = a
    },
    close: function () {
        this.connectFailCount = 0;
        this.sequence = 1;
        this.eventSequence = 0;
        this.eventCallback = null;
        this.reconnectCallback = null;
        this.closeCallback = null;
        this.errorCallback = null;
        if (this.conn && this.conn.readyState === WebSocket.OPEN) {
            this.conn.onclose = function () {};
            this.conn.close();
            this.conn = null
        }
    },
    pause: function () {
        this.connectFailCount = 0;
        this.sequence = 1;
        if (this.conn) {
            this.conn.onclose = function () {};
            this.conn.close();
            this.conn = null
        }
    },
    sendMessage: function (c, d, a) {
        if (!window.VerControll.judgeFn('verReceipt')) {
            return
        }
        var b = {
            action: c,
            seq: this.sequence++,
            data: d
        };
        if (a) {
            this.responseCallbacks[b.seq] = a
        }
        if (this.conn && this.conn.readyState === WebSocket.OPEN) {
            this.conn.send(JSON.stringify(b))
        } else {
            if (!this.conn || this.conn.readyState === WebSocket.CLOSED) {
                this.conn = null;
                this.initialize(this.connectionUrl)
            }
        }
    },
    simpleToNomal: function (b) {
        var a = b.split('|'),
            c = a[0],
            e = a[1];
        a.splice(0, 2);
        var d = {
            event: c,
            seq: e,
            data: a
        };
        return d
    }
}, 0, 0, 0, 0, 0, 0, [IMCommon.utils, 'WebSocketUtil', 0, 'WebSocketUtil'], 0);
Ext.cmd.derive('IMCommon.view.MsgView', Ext.List, {
    itemsFocusable: !1,
    selectable: !1,
    scrollable: !0,
    disableSelection: !0,
    classCls: 'msg-list',
    scrollToTopOnRefresh: !1,
    hoveredCls: 'hovered',
    initialize: function () {
        var a = this;
        Ext.dataview.List.prototype.initialize.apply(this, arguments);
        a.on({
            childtap: 'onTapChild',
            scope: a
        });
        a.getScrollable().on({
            scroll: 'onChgScrol',
            scrollend: 'onChgScrolend',
            scope: a
        });
        var b = a.buildTpl();
        a.setItemTpl(b)
    },
    buildTpl: function () {
        return this.getTpl2()
    },
    getTpl2: function () {
        return ['<tpl if="values.auxiliaryNews"><div class="auxiliaryNews">以下是新消息</div><tpl else><tpl if="values.showTime"><tpl if="values.notShowGrpChange"><tpl else><div class="msgTime">{[ParseUtil.handleMsgShowTime(values.updateTime)]}</div></tpl></tpl><tpl if="values.msg_type == \'B\'"><div class="grpChangeNote"><span>{sendText}&nbsp;<tpl if="values.showRevokeEdit"><a class="revokeEdit">重新编辑</a></tpl></span></div><tpl elseif="values.msg_type == \'N\'"><div class="grpChangeNote"><span>{[ParseUtil.getSureName(values.senderID)]}修改了群公告&nbsp;</span></div><tpl else><tpl if="values.showGrpChange"><div class="grpChangeNote"><span>{[ParseUtil.milGrpChgMsg(values.GrpChangeMsg)]}<tpl if="values.showGrpSeeMore"><a class="seeHistory">申请查看更多历史</a></tpl></span></div><tpl elseif="values.notShowGrpChange"><tpl else><div class="wrapAB {[values.ROL == \'right\'?\'wrapABR\':\'wrapABL\']} {[User.useReceipt == \'Y\' ? \'hasRead\':\'nohasRead\']} {[values.unread_count == 0 && values.read_count == 0 ? \'oldData\':\'newData\']}" style="text-align:{[values.ROL?values.ROL:\'left\']};float:{[values.ROL?values.ROL:\'left\']}"><div class="avatar-wrapper">{[ParseUtil.parseAvatar(values)]}</div><div class="content-wrapper"><tpl if="values.ROL==\'right\'"><div msgID="{msg_id}" msgType="{msg_type}" class="bubble {[values.msg_type == \'I\' ? \'imgmsg\' : \'\']} mine"><tpl else><div class="evAvatar"><span class="evAvatarDetail">{senderName}</span></div><div msgID="{msg_id}" msgType="{msg_type}" class="bubble {[values.msg_type == \'I\' ? \'imgmsg\' : \'\']} others"></tpl><tpl if="values.msg_type==\'F\'">{[ParseUtil.parseFile(values)]}', '<tpl elseif="values.msg_type == \'I\'">{[ParseUtil.parsePic(values)]}<tpl elseif="values.msg_type == \'T\'"><div class="plain">', '<tpl if="values.sendStatus==2">', "<div class=\"loadgif {[values.ROL == 'right' ? 'mineStu' : 'otherStu']}\"></div><tpl elseif=\"values.sendStatus==1\"><div class=\"sendfail {[values.ROL == 'right' ? 'mineStu' : 'otherStu']}\"></div></tpl>", '{[ParseUtil.parseTextToHtml(values.sendText)]}</div><tpl elseif="values.msg_type == \'L\'"><div class="linkMsg"><div class="linkIcon" letter="{linkLinkType}"></div><div class="linkName">{linkName}</div><div class="linkTime" style="display: none;">{linkOwner}</div></div><tpl elseif="values.msg_type == \'E\'">{[ParseUtil.parseBigFile(values)]}<tpl else><div class="plain">[尚未支持的消息类型]</div></tpl></div></div></div><tpl if="values.ROL==\'right\' && User.useReceipt == \'Y\'"><tpl if="values.msg_type == \'T\' ||values.msg_type == \'I\' ||values.msg_type == \'F\'||values.msg_type == \'E\'||values.msg_type == \'L\'"><tpl if="(values.updateTime-new Date().getTime()) < 2592000000"><tpl if="values.read_count == 0 && values.unread_count != 0"><tpl if="User.crtChannelType==\'D\'"><div class="readNumCon" style="color:#5fa2dd;float:right;margin-right:40px;width: 100%;text-align: right;margin-bottom: 0px;font-size: 10px;">未读</div><tpl else><div class="readNumCon" style="color:#5fa2dd;float:right;margin-right:40px;width: 100%;text-align: right;margin-bottom: 0px;font-size: 10px;"><a class="readNum" style="text-decoration: unset">{unread_count}人未读</a></div></tpl><tpl elseif="values.unread_count != 0 && values.read_count != 0"><tpl if="User.crtChannelType==\'D\'"><div class="readNumCon" style="color:#5fa2dd;float:right;margin-right:40px;width: 100%;text-align: right;margin-bottom: 0px;font-size: 10px;">未读</div><tpl else><div class="readNumCon" style="color:#5fa2dd;float:right;margin-right:40px;width: 100%;text-align: right;margin-bottom: 0px;font-size: 10px;"><a class="readNum" style="text-decoration: unset">{unread_count}人未读</a></div></tpl><tpl elseif="values.unread_count == 0 && values.read_count == 0"><div  style="color:#888;float:right;margin-right:40px;width: 100%;text-align: right;margin-bottom: 0px;font-size: 10px;"><span class="readNum"></span></div><tpl elseif="values.unread_count == 0"><tpl if="User.crtChannelType==\'D\'"><div  style="color:#888;float:right;margin-right:40px;width: 100%;text-align: right;margin-bottom: 0px;font-size: 10px;"><span class="readNum">已读</span></div><tpl else><div  style="color:#888;float:right;margin-right:40px;width: 100%;text-align: right;margin-bottom: 0px;font-size: 10px;"><span class="readNum">全部已读</span></div></tpl></tpl></tpl></tpl></tpl></tpl></tpl></tpl>'].join('')
    },
    onTapChild: function (c, l) {
        var a = l.record;
        if (!a) {
            return
        }
        var q = l.event;
        var b = Ext.fly(q.target);
        var k = 'img.viewPic.loaded';
        if (b.hasCls('img-tip-gif') || b.hasCls('img-gif-tip')) {
            var y = ImgMgr.parsePic(a.get('fileID'), !1, a.get('height'), a.get('width'), '2', a.get('chat_id'), a.get('updateTime'), a.get('extension'), a.get('fileName'), !1);
            a.set('sendText', y);
            return
        }
        if (b.is(k)) {
            var w = c.innerElement.dom.querySelectorAll(k),
                h = [],
                j = -1;
            w.forEach(function (a, d) {
                h.push({
                    url: a.src,
                    original: a.getAttribute('data-original'),
                    name: a.getAttribute('fileName'),
                    createAt: a.getAttribute('create_at')
                });
                if (b.dom === a) {
                    j = d
                }
            });
            var m = DesktopChatUtil.getCefObj();
            if (m) {
                h = JSON.stringify(h);
                m.viewImages(h, j)
            } else {
                if (Ext.browser.is.Cordova || !Ext.os.is.Desktop) {
                    ImgMgr.showViewerOfDom(b.dom)
                } else {
                    ImgUtil.viewImgs(c.innerElement.dom, {
                        initialIndex: j,
                        filter: function (a) {
                            return Ext.fly(a).is(k)
                        }
                    })
                }
            }
        }
        if (b.hasCls('fileDone')) {
            DownFileMgr.downFileForA(a.getData())
        }
        if (b.hasCls('fileSuc')) {
            FileMgr.open(a.get('localPath'))['catch'](function (b) {
                if (a.get('msg_type') == MsgType.BigFileMsg) {
                    return
                }
                a.set({
                    fileStatus: 1,
                    failMsg: b
                })
            })
        }
        if (b.hasCls('fileSaveAs')) {
            FileMgr.saveAs(a.get('localPath'), a.get('fileName'))
        }
        if (b.hasCls('fileOpenFolder')) {
            FileMgr.openFolder(a.get('localPath'))
        }
        if (a.get('msg_type') == MsgType.LinkErp) {
            if (b.hasCls('linkMsg') || b.hasCls('linkName') || b.hasCls('linkIcon') || b.hasCls('linkTime')) {
                var t = a.data.linkObjType || a.data.link_stg_guid;
                if (Config.isPC) {
                    if (ConfigMgr.isAio8()) {
                        DesktopChatUtil.openErpLinkInAio8(a.data)
                    } else {
                        DesktopChatUtil.openErpLink(t, a.data.linkKeyString, a.data.linkLinkType)
                    }
                }
            }
        }
        if (b.hasCls('evAvatarDetail')) {
            if (Config.isPC) {
                DesktopChatUtil.showInformation(a.get('senderID'), 2)
            }
        }
        if (b.hasCls('revokeEdit')) {
            if (Config.isDesktop) {
                var s = User.RevokeText;
                c.fireEvent('revokeEdit', s)
            }
        }
        if (b.hasCls('seeHistory')) {
            if (Config.isDesktop) {
                c.fireEvent('seeHistory')
            }
        }
        if (b.dom.innerHTML == '设置') {
            if (Config.isDesktop) {
                var r = b.dom.parentElement.children[0].className;
                c.fireEvent('setoneHistory', r)
            }
        }
        var i = c.getStore();
        if (!i) {
            return
        }
        if (b.hasCls('sendfail')) {
            i.remove(a);
            var p = User.crtChannelId,
                o = '';
            LocalDataMgr.deleteFailMsg(a.get('localMsgID'), function () {
                SendUtil.beforeSend(p).then(function () {
                    o = a.get('sendText');
                    SendUtil.sendMsgsByOneAPI(p, [{
                        type: MsgType.TextMsg,
                        value: o
                    }])
                })
            })
        }
        if (b.is('img.viewPic.sendImgerr')) {}
        if (b.hasCls('file_re_send')) {
            var d = SendUtil.beforeReSendFileMsg(a);
            if (d) {
                LocalDataMgr.deleteFailMsg(a.get('localMsgID'), function () {
                    i.remove(a);
                    SendUtil.sendFileMsgsByOneAPI([{
                        path: a.get('localPath'),
                        size: a.get('fileSize')
                    }])
                })
            }
        }
        if (b.hasCls('file_re_upload')) {
            var d = SendUtil.beforeReSendFileMsg(a);
            if (d) {
                a.set('failMsg', '上传中...');
                UpFileMgr.pushFileToQue({
                    chat_id: a.get('chat_id'),
                    localPath: a.get('localPath'),
                    attach_id: a.get('attach_id'),
                    msg_id: a.get('msg_id')
                })
            }
        }
        if (b.hasCls('file_re_download')) {
            a.set('failMsg', '下载中...');
            DownFileMgr.downFileForA({
                chat_id: a.get('chat_id'),
                attach_id: a.get('attach_id'),
                fileName: a.get('fileName'),
                fileSize: a.get('fileSize'),
                msg_id: a.get('msg_id'),
                updateTime: a.get('updateTime')
            })
        }
        if (b.hasCls('open_bigfile_form')) {
            if (Config.isDesktop) {
                c.doShowTransferFormByType(a)
            }
        }
        if (b.hasCls('bfile_re_send')) {
            var d = SendUtil.beforeReSendFileMsg(a);
            if (d) {
                LocalDataMgr.deleteFailMsg(a.get('localMsgID'), function () {
                    i.remove(a);
                    SendUtil.sendBigFileMsgsByOneAPI([{
                        path: a.get('localPath'),
                        size: a.get('fileSize')
                    }])
                })
            }
        }
        if (b.hasCls('re_upload_BFile')) {
            var d = SendUtil.beforeReSendFileMsg(a);
            if (d) {
                if (Config.isDesktop) {
                    a.set({
                        fileStatus: 4
                    });
                    DesktopChatUtil.getCefObj().doTransferUpload(JSON.stringify({
                        chat_id: a.get('chat_id'),
                        chat_name: a.get('chat_name'),
                        user_id: a.get('senderID'),
                        user_name: a.get('senderName'),
                        msg_id: a.get('msg_id'),
                        fetch_id: a.get('file_id'),
                        file_id: a.get('file_id'),
                        create_at: a.get('updateTime'),
                        path: a.get('localPath'),
                        extension: FileUtil.getExtension(a.get('localPath').fileName),
                        file_name: a.get('fileName'),
                        file_size: a.get('fileSize')
                    }))
                }
            }
        }
        if (b.hasCls('re_download_BFile')) {
            if (Config.isDesktop) {
                DesktopChatUtil.reDownBFile(a)
            }
        }
        if (b.hasCls('bigfile-more')) {
            if (Config.isDesktop) {
                var x = Ext.create('IMCommon.view.menu.HideDestroyMenu', {
                    items: [{
                        text: '文件查看',
                        indented: !1,
                        handler: function () {
                            c.doShowTransferFormByType(a)
                        }
                    }]
                });
                ParseUtil.menuShowAtVisible(x, q.event)
            }
        }
        if (b.hasCls('readNum') && IMHelper.canUseReceipt()) {
            if (!(b.dom.outerText == '全部已读' || b.dom.outerText == '已读' || b.dom.outerText == '未读')) {
                var n = a.get('msg_id');
                var v = User.crtChannelId;
                var g = [];
                var f = [];
                var u = l.child;
                var e = !1;
                Utils.custAjax('post', 'chats/' + v + '/posts/receiptMems', {
                    params: JSON.stringify([n]),
                    success: function (b) {
                        if (b.read_list) {
                            for (var d = 0; d < b.read_list.length; d++) {
                                if (b.read_list[d] != User.ownerID && User.getUserName(b.read_list[d]) != '') {
                                    g.push({
                                        readName: User.getUserName(b.read_list[d]),
                                        user_id: b.read_list[d],
                                        readNum: ''
                                    })
                                }
                            }
                        }
                        if (b.unread_list) {
                            for (var h = 0; h < b.unread_list.length; h++) {
                                if (b.unread_list[h] != User.ownerID && User.getUserName(b.unread_list[h]) != '') {
                                    f.push({
                                        unreadName: User.getUserName(b.unread_list[h]),
                                        unuser_id: b.unread_list[h],
                                        unreadNum: ''
                                    })
                                }
                            }
                        }
                        if (b.read_list) {
                            if (a.data.read_count != g.length) {
                                a.set('read_count', g.length);
                                e = !0
                            }
                        } else {
                            if (a.data.read_count != 0) {
                                a.set('read_count', 0);
                                e = !0
                            }
                        }
                        if (b.unread_list) {
                            if (a.data.unread_count != f.length) {
                                a.set('unread_count', f.length);
                                e = !0
                            }
                        } else {
                            if (a.data.unread_count != 0) {
                                a.set('unread_count', 0);
                                e = !0
                            }
                        }
                        if (e) {
                            LocalDataMgr.updateDeatailsReadCount(g.length, f.length, n)
                        }
                        c.getReadDetails(g, f, u)
                    },
                    failure: function () {}
                })
            }
        }
    },
    doShowTransferFormByType: function (a) {
        var d = a.get('file_id');
        if (!d) {
            return
        }
        var e = a.get('senderID'),
            c = parseInt(a.get('fileStatus'), 10);
        var b = 'C';
        if (c == 0) {
            b = 'C'
        } else {
            if (e == User.ownerID) {
                if (c != 8 && c != 9) {
                    b = 'U'
                } else {
                    b = 'D'
                }
            } else {
                b = 'D'
            }
        }
        LocalDataMgr.showBFileInBFileForm(d);
        DesktopChatUtil.showTransferFormByType(JSON.stringify({
            chat_id: User.crtChannelId,
            chat_name: a.get('chat_name'),
            user_id: a.get('senderID'),
            user_name: a.get('senderName'),
            msg_id: a.get('msg_id'),
            fetch_id: d,
            file_id: d,
            create_at: a.get('updateTime'),
            file_path: a.get('localPath'),
            path: a.get('localPath'),
            extension: FileUtil.getExtension(a.get('fileName')),
            file_name: a.get('fileName'),
            file_size: a.get('fileSize'),
            size: a.get('fileSize'),
            file_status: c,
            owner_id: User.ownerID,
            msg_status: '0'
        }), b)
    },
    onChgScrol: function (l, p, k, n, o) {
        if (k == 0) {
            if (User.isRefresh) {
                return
            }
            if (User.isMsgRemoveAll) {
                User.isMsgRemoveAll = !1;
                return
            }
            if (this.isCodeScrol) {
                return
            }
            if (!User.canScrol[User.crtChannelId]) {
                var j = this;
                var a = j.getStore();
                var e = a.getAt(0);
                var d = a.getStoreId();
                if (!e) {
                    return
                }
                if (!d) {
                    return
                }
                var m = e.get('updateTime');
                if (!m) {
                    Utils.toastShort('程序出错了，没找到时间');
                    return
                }
                User.canScrol[d] = !0;
                var i = 0;
                for (var c = 0; c < a.data.items.length; c++) {
                    if (a.getAt(c).get('msgSeq') && a.getAt(c).get('msgSeq') >= 10000) {
                        i = a.getAt(c).get('msgSeq');
                        break
                    }
                }
                if (i <= 10000) {
                    j.doTimeSearch(d, a, e)
                } else {
                    j.doSeqSearch(d, i, a, e)
                }
            }
        }
        var h = l.getScrollElement().dom,
            g = h.scrollHeight,
            f = h.scrollTop,
            b = h.offsetHeight;
        if (b > 0) {
            this.effectObj = {
                scrollTop: f,
                isBottom: !1,
                clientHeight: b
            };
            if (g <= Math.ceil(f + b)) {
                this.effectObj.isBottom = !0
            }
        }
        if (window.cefMain) {
            if (g <= Math.ceil(f + b)) {
                this.hideUnread();
                this.searchMsgWhereToEnd()
            } else {
                this.showUnread(f, g, b);
                if (!this.abortViewAPI) {
                    this.doUpBtnHide1(k)
                }
            }
            if (this.isAtScrol) {
                return
            }
            if (AtUtil.useDB) {} else {
                AtUtil.doMsgViewAtBtn(User.crtChannelId, this)
            }
        }
        if (Config.isPC && IMHelper.canUseReceipt()) {
            ChatUtil.sendScrollReadDetails()
        }
    },
    doTimeSearch: function (a, c, b) {
        var e = this;
        var d = b.get('updateTime');
        LocalDataMgr.getOldIMMsg(a, d, function (h, f) {
            var g = f.rows;
            var d = ParseUtil.parseLocalMsg(g);
            c.insert(0, d);
            AddDataUtil.msgScrollToRecord(b, e);
            User.canScrol[a] = !1
        })
    },
    doSeqSearch: function (a, e, b, d) {
        var c = this;
        var f = d.get('updateTime');
        LocalDataMgr.getOldIMMsg(a, f, function (j, g) {
            var i = g.rows;
            var f = ParseUtil.parseLocalMsg(i);
            var h = 'select M.*,F.*,L.*,B.* FROM IMMsg M LEFT JOIN IMFile F ON M.ID=F.BaseID LEFT JOIN IMLink L ON M.ID=L.BaseID LEFT JOIN IMBFile B ON M.ID=B.BaseID  WHERE M.ChatID=? and M.MsgSeq<>? AND M.MsgSeq<? ORDER BY M.MsgSeq DESC limit 20;';
            j.executeSql(h, [a, -1, e], function (m, k) {
                if (a != User.crtChannelId) {
                    return
                }
                var i = k.rows,
                    l = ParseUtil.parseLocalMsg(i);
                var h = ParseUtil.judgeSlice(i, e);
                if (h.length > 0) {
                    c.getSliHis(a, h, function (n) {
                        if (a != User.crtChannelId) {
                            return
                        }
                        var h = l.concat(n);
                        h = ParseUtil.sortHistory(h);
                        var i = c.getMixedDataShow(f, h);
                        b.insert(0, i);
                        AddDataUtil.msgScrollToRecord(d, c);
                        User.canScrol[a] = !1;
                        ChatUtil.checkReadInfo(b, i)
                    })
                } else {
                    b.insert(0, f);
                    AddDataUtil.msgScrollToRecord(d, c);
                    User.canScrol[a] = !1;
                    ChatUtil.checkReadInfo(b, f)
                }
            })
        })
    },
    getMixedDataShow: function (b, d) {
        var a = [],
            f = d.length,
            g = b.length;
        if (f > 0) {
            var e = b.concat(d),
                c = ParseUtil.objArrReduce(e, 'updateTime');
            if (c.length > 20) {
                a = c.slice(-20)
            } else {
                a = c
            }
        } else {
            a = b
        }
        return a
    },
    getSliHis: function (c, d, b, a) {
        Utils.custAjax('post', 'chats/' + c + '/posts/unread', {
            params: JSON.stringify(d),
            success: function (h) {
                var e = h.message_list,
                    g = [];
                if (e && e.length > 0) {
                    g = ParseUtil.parseRemoteMsg(e);
                    LocalDataMgr.initAddToMsg(e)
                }
                var f = h.recall_message_list;
                if (f && f.length > 0) {
                    LocalDataMgr.initRevokeMsg(f)
                }
                if (b) {
                    b(g)
                }
            },
            failure: function (e) {
                Utils.toastShort('拉取远端消息失败：' + e + '请检查网络设置');
                if (a) {
                    a()
                }
            },
            callback: function () {
                User.canScrol[c] = !1
            }
        })
    },
    hideUnread: function () {
        var b = Ext.getStore('comRct'),
            c = User.crtChannelId;
        if (b && c) {
            var a = b.getById(c);
            if (a) {
                a.set({
                    msgToLatest: !0,
                    msgScrY: 0
                }, {
                    silent: !0
                });
                if (this.abortViewAPI) {
                    return
                }
                var d = this.getViewModel(),
                    e = d.get('hideMoreMsg');
                if (!e) {
                    d.set({
                        hideMoreMsg: !0,
                        msgNum: 0
                    })
                }
                if (a.get('unReadNum') > 0) {
                    ChatUtil.setUnreadToRead(b, c)
                }
            }
        }
    },
    showUnread: function (b, d, c) {
        var a = Ext.getStore('comRct').getById(User.crtChannelId);
        if (a) {
            a.set({
                msgToLatest: !1,
                msgScrY: b
            }, {
                silent: !0
            })
        }
    },
    searchMsgWhereToEnd: function () {
        if (User.isRefresh) {
            return
        }
        if (User.isMsgRemoveAll) {
            User.isMsgRemoveAll = !1;
            return
        }
        if (this.isCodeScrol) {
            return
        }
        if (!User.canScrolEnd[User.crtChannelId]) {
            var f = this;
            var a = f.getStore();
            var g = a.last();
            var c = a.getStoreId();
            if (!c) {
                return
            }
            if (!g) {
                return
            }
            var d = g.get('updateTime');
            if (!d) {
                return
            }
            User.canScrolEnd[c] = !0;
            var e = 0;
            for (var b = a.data.items.length - 1; b > -1; b--) {
                if (a.getAt(b).get('msgSeq') && a.getAt(b).get('msgSeq') >= 10000) {
                    e = a.getAt(b).get('msgSeq');
                    break
                }
            }
            if (e <= 10000) {
                f.doEndTimeSearch(c, d, a)
            } else {
                f.doEndSeqSearch(c, e, d, a)
            }
        }
    },
    doEndTimeSearch: function (a, c, b) {
        var d = this;
        LocalDataMgr.getMoreEndHistory(a, c, function (i, f) {
            var e = f.rows,
                g = ParseUtil.parseLocalOrderedMsg(e);
            var h = ParseUtil.judgeSlice(e);
            d.doSliData(a, h, g, b)
        })
    },
    doEndSeqSearch: function (b, a, e, c) {
        var d = this;
        LocalDataMgr.getMoreEndHistory(b, e, function (j, i) {
            var h = i.rows,
                g = ParseUtil.parseLocalOrderedMsg(h);
            var f = ParseUtil.judgeSlice(h);
            var k = 'SELECT * FROM IMMsg WHERE ChatID=? AND MsgSeq<>? AND MsgSeq>? ORDER BY MsgSeq ASC limit 1;';
            j.executeSql(k, [b, -1, a], function (o, m) {
                var l = m.rows;
                if (l.length > 0) {
                    var n = l.item(0),
                        h = n.MsgSeq;
                    if (h - a > 1) {
                        var k = h;
                        if (h - a >= 20) {
                            k = a + 20
                        }
                        f.push({
                            from_seq: a,
                            to_seq: k
                        })
                    }
                    d.doSliData(b, f, g, c)
                } else {
                    d.doSliData(b, f, g, c)
                }
            })
        })
    },
    doSliData: function (c, d, a, b) {
        var e = this;
        if (d.length > 0) {
            this.getSliHis(c, d, function (f) {
                var e = a.concat(f);
                e = ParseUtil.sortHistory(e);
                if (e.length > 0) {
                    b.add(e)
                }
                User.canScrolEnd[c] = !1;
                ChatUtil.checkReadInfo(b, e)
            })
        } else {
            if (a.length > 0) {
                b.add(a)
            }
            User.canScrolEnd[c] = !1;
            ChatUtil.checkReadInfo(b, a)
        }
    },
    onChgScrolend: function () {
        var a = this;
        this.isCodeScrol = !1;
        this.doingUpBtn = !1;
        this.isAtScrol = !1;
        if (Config.isPC && IMHelper.canUseReceipt()) {
            ChatUtil.sendScrollReadDetails()
        }
    },
    getReadDetails: function (c, b, e) {
        var d = this;
        var a = Ext.create('Ext.Container', {
            xtype: 'fabcontain',
            cls: 'readcontainer',
            itemId: 'fabcon',
            floated: !0,
            layout: 'hbox',
            style: '\n            -webkit-box-shadow: 0 8px 17px 0 rgba(0, 0, 0, 0.2);\n            -moz-box-shadow: 0 8px 17px 0 rgba(0, 0, 0, 0.2);\n            box-shadow: 0 0px 17px 0 rgba(0, 0, 0, 0.2);\n            background-color:white;\n            border: none;',
            width: 270,
            zIndex: 100,
            items: [{
                xtype: 'button',
                iconCls: 'im-common-close',
                cls: 'msgview-receipt-contain',
                handler: function (a) {
                    try {
                        a.parent.hide()
                    } catch (f) {}
                }
            }, {
                xtype: 'container',
                layout: 'vbox',
                style: 'border-right: 1px solid #e6e6e6;width:135px',
                items: [{
                    xtype: 'component',
                    itemId: 'readlistcom',
                    html: ''
                }, {
                    xtype: 'list',
                    maxHeight: 360,
                    store: {
                        storeId: 'readListStore',
                        sorters: [{
                            property: 'user_id',
                            direction: 'ASC'
                        }],
                        fields: ['readNum', 'readTitle', 'readName', 'user_id']
                    },
                    itemTpl: '<div style="float: left;margin-top: 3.5px;margin-bottom: 3.5px;">{[AvatarMgr.parseUserAva(values.user_id, true)]}</div><div style="float: left;margin-top: 5px;margin-left: 10px;margin-bottom: 5px;" class="read-view"><div uid="{user_id}">{readName}</div></div>',
                    listeners: {
                        childtap: function (g, f) {
                            var a = f.record.data.user_id;
                            var d = f.record.data.readName;
                            if (a && a != '') {
                                if (User.getUserName(a) != '') {
                                    if (window.cefMain) {
                                        ChatHelper.onOpenDirectChat(a, d)
                                    } else {
                                        if (window.cefChat) {
                                            cefChat.createDitChat(a, d)
                                        }
                                    }
                                } else {
                                    Utils.toastShort('用户不存在')
                                }
                                Ext.ComponentQuery.query('#fabcon')[0].hide()
                            }
                        }
                    }
                }]
            }, {
                xtype: 'container',
                layout: 'vbox',
                style: 'width:135px',
                items: [{
                    xtype: 'component',
                    itemId: 'unreadlistcom',
                    html: ''
                }, {
                    xtype: 'list',
                    maxHeight: 360,
                    store: {
                        storeId: 'unreadListStore',
                        sorters: [{
                            property: 'unuser_id',
                            direction: 'ASC'
                        }],
                        fields: ['unreadNum', 'unreadTitle', 'unreadName', 'unuser_id']
                    },
                    itemTpl: '<div style="float: left;margin-top: 3.5px;margin-bottom: 3.5px;">{[AvatarMgr.parseUserAva(values.unuser_id, true)]}</div><div style="float: left;margin-top: 5px;margin-left: 10px;;margin-bottom: 5px;" class="unread-view"><div uid="{unuser_id}" style="color:#358ad4"><a style="text-decoration: unset">{unreadName}</a></div></div>',
                    listeners: {
                        childtap: function (g, f) {
                            var a = f.record.data.unuser_id;
                            var d = f.record.data.unreadName;
                            if (a && a != '') {
                                if (User.getUserName(a) != '') {
                                    if (window.cefMain) {
                                        ChatHelper.onOpenDirectChat(a, d)
                                    } else {
                                        if (window.cefChat) {
                                            cefChat.createDitChat(a, d)
                                        }
                                    }
                                } else {
                                    Utils.toastShort('用户不存在')
                                }
                                Ext.ComponentQuery.query('#fabcon')[0].hide()
                            }
                        }
                    }
                }]
            }]
        });
        Ext.on({
            mousedown: 'onMousedown',
            scope: d
        });
        a.on({
            hide: function () {
                a.destroy();
                Ext.un({
                    mousedown: 'onMousedown',
                    scope: d
                })
            }
        });
        Ext.ComponentQuery.query('#readlistcom')[0].setHtml('<div style="margin-top:15px;margin-bottom: 5px;margin-left: 20px;"><span  style="font-size:20px">' + c.length + '</span>人已读</div>');
        Ext.ComponentQuery.query('#unreadlistcom')[0].setHtml('<div style="margin-top:15px;margin-bottom: 5px;margin-left: 20px;"><span  style="font-size:20px">' + b.length + '</span>人未读</div>');
        Ext.getStore('readListStore').removeAll();
        Ext.getStore('unreadListStore').removeAll();
        Ext.getStore('readListStore').add(c);
        Ext.getStore('unreadListStore').add(b);
        a.showBy(e, 'b25-r');
        a.setTop(50);
        if (User.crtChannelType == 'D') {
            a.setLeft(-80)
        } else {
            a.setLeft(-200)
        }
    },
    onMousedown: function (d) {
        var a = Ext.ComponentQuery.query('#fabcon')[0];
        if (!a) {
            return
        }
        var h = a.el.getTop();
        var e = a.el.getBottom();
        var f = a.el.getRight();
        var g = a.el.getLeft();
        var b = d.parentEvent.clientX;
        var c = d.parentEvent.clientY;
        if (c < h || c > e || b < g || b > f) {
            a.hide()
        }
    }
}, 0, ['msgView'], ['widget', 'component', 'container', 'componentdataview', 'list', 'msgView'], {
    'widget': !0,
    'component': !0,
    'container': !0,
    'componentdataview': !0,
    'list': !0,
    'msgView': !0
}, ['widget.msgView'], 0, [IMCommon.view, 'MsgView'], 0);
Ext.cmd.derive('IMCommon.view.RctChat', Ext.List, {
    store: {
        storeId: 'comRct',
        model: 'IMCommon.model.RctChat',
        sorters: [{
            property: 'toTop',
            direction: 'DESC'
        }, {
            property: 'last_post_at',
            direction: 'DESC'
        }]
    },
    emptyText: '暂无会话',
    scrollToTopOnRefresh: !1,
    userSelectable: !1,
    userCls: 'rctChat',
    initialize: function () {
        var a = this;
        Ext.dataview.List.prototype.initialize.apply(this, arguments);
        a.getStore().on({
            add: 'onStoreChg',
            update: 'onStoreChg',
            clear: 'onStoreChg',
            remove: 'onStoreChg',
            load: 'onStoreChg',
            destroyable: !0,
            scope: a
        })
    },
    onStoreChg: function (a, f, h, g) {
        a.sort();
        if (Config.isPC) {
            var e = ViewGet.getIMViewmodel(),
                d = 0;
            var c = 0;
            for (var b = 0; b < a.getData().length; b++) {
                if (a.getAt(b).data.chat_id != 'eeeeeeeebbbbbbbbbfffffffff') {
                    c = a.getAt(b).get('unReadNum');
                    if (c) {
                        d += c
                    }
                }
            }
            e.set('allUnreadNum', d)
        }
        ParseUtil.doEmptyText(this)
    },
    itemTpl: ["<div class=\"itemRight {[values.toTop?'toTopBgColor':'']}\">", '<div class="wrapAva">', '<tpl if="values.type == \'D\'">', '<a class="avatar link-avatar firstletter loaded">', '<img src="{[AvatarMgr.getNavUserAvaUrlWOCache(values.avaID,values.avaRefresh)]}" onerror="AvatarMgr.doUserAvaErr(this)" ava-id="{avaID}" hash="{avaHash}">', '</a>', '<tpl elseif="values.type == \'G\'">', '{[AvatarMgr.getChatAvaHtml(values.chat_id, values.create_at, values.avaHash)]}', '<tpl elseif="values.type == \'News\'">', '<a class="avatar link-avatar firstletter loaded">', '<img src="' + Ext.getResourcePath('images/xiaoxi.png', null, null) + '" >', '</a>', '<tpl elseif="values.type == \'C\'">', '{[AvatarMgr.getCrowdAvaHtml(values.chat_id, values.create_at, values.avaHash)]}', '<tpl else>', '<a class="avatar link-avatar firstletter loaded">', '<img src="{[Ext.getResourcePath("images/imdefault.png")]}">', '</a>', '</tpl>', '<tpl if="values.type == \'P\'">', '<tpl else>', '<a class="RecentUnRead" unRead="{unReadNum}" style="cursor:default;display:{[values.isUnRead?"block":"none"]}"></a>', '</tpl>', '</div>', '<div class="evt">', '<p style="margin-bottom:10px;">{[ParseUtil.handleShowTime(values.last_post_at)]}</p></br>', '<tpl if="values.IsMute == \'Y\'">', '<p class="evt-dnd x-fa fa-bell-slash-o"></p>', '</tpl>', '</div>', '<div class="displayInfo">', '<div class="displayName" title="{name}">{name}</div>', '<div class="displayMsg">', '<tpl if="values.MentionCount &gt; 0">', '<font color="red">[有人@我]</font>', '</tpl>', '<tpl if="values.last_msg_type == \'Draft\'">', "<tpl elseif=\"values.type == 'G' || values.type == 'C'\">", '<tpl if="values.last_msg_type == \'B\'">', '<tpl if="values.last_post_name!=\'\'">', '</tpl>', "<tpl elseif=\"values.last_msg_type != 'G' && values.last_msg_type != 'A' && values.last_msg_type != 'R' && values.last_msg_type != 'M' && values.last_msg_type != 'C' && values.last_msg_type != 'X' && values.last_msg_type != 'H' && values.last_msg_type != 'S' && values.last_msg_type != 'N' \">", '<tpl if="values.last_post_name!=\'\'">', '{[values.last_post_id==User.ownerID?"":values.last_post_name+"："]}', '</tpl>', '</tpl>', '</tpl>', '<tpl if="values.last_msg_type == \'T\'">', '{[ParseUtil.parseRctText(values.last_post_msg)]}', '<tpl elseif="values.last_msg_type == \'I\'">', '[图片]', '<tpl elseif="values.last_msg_type == \'F\'">', '[文件]', '<tpl elseif="values.last_msg_type == \'L\'">', '[链接]', '<tpl elseif="values.last_msg_type == \'G\'">', '[通知]', '<tpl elseif="values.last_msg_type == \'N\'">', '[通知]', '<tpl elseif="values.last_msg_type == \'H\'">', '[通知]', '<tpl elseif="values.last_msg_type == \'J\'">', '[通知]', '<tpl elseif="values.last_msg_type == \'D\'">', '[通知]', '<tpl elseif="values.last_msg_type == \'V\'">', '[通知]', '<tpl elseif="values.last_msg_type == \'B\'">', '{[ParseUtil.parseRctText(values.last_post_msg)]}', '<tpl elseif="values.last_msg_type == \'S\'">', '[通知]', '<tpl elseif="values.last_msg_type == \'E\'">', '[大文件]', '<tpl elseif="values.last_msg_type == \'P\'">', '<tpl if= "values.isUnRead==true ">', '<span style="color: red;">[有新评论]</span>', '</tpl>', '<tpl elseif="values.chat_id == StaticChatID.News && !ConfigMgr.isAio8()">', '{last_post_msg}', '<tpl elseif="values.last_msg_type == \'Draft\'">', '<font color="red">[草稿]</font>', '{[ParseUtil.parseRctText(values.last_post_msg)]}', '<tpl elseif="values.last_msg_type == \'0\'">', '<tpl else>', '{[ParseUtil.getRctNoticeMsg(values.last_msg_type)]}', '</tpl>', '</div>', '</div>', '</div>'].join('')
}, 0, ['rctChat'], ['widget', 'component', 'container', 'componentdataview', 'list', 'rctChat'], {
    'widget': !0,
    'component': !0,
    'container': !0,
    'componentdataview': !0,
    'list': !0,
    'rctChat': !0
}, ['widget.rctChat'], 0, [IMCommon.view, 'RctChat'], 0);
Ext.cmd.derive('IMCommon.view.RichEditor', MX.field.RichTextArea, {
    scrollable: {
        x: !0,
        y: !1
    },
    clearable: !1,
    constructor: function (a) {
        var c = this;
        a = a || {};
        var b = Ext.getStore('IM-global-mention-store');
        if (!b) {
            b = Ext.factory({
                storeId: 'IM-global-mention-store',
                model: 'IMCommon.model.Mention'
            }, Ext.data.Store)
        }
        a.triggerChars = [{
            trigger: '@',
            minChars: 0,
            store: b,
            itemTpl: Ext.create('Ext.XTemplate', ['<span class="at at-U">{user_name}</span>'].join('')),
            callback: function (b, e) {
                var d = User.crtChannelId;
                var f = AtUtil.canShowAt(d);
                if (f) {
                    if (c._lastTerm == b) {
                        return
                    }
                    AtUtil.doSearchAtMems(d, b, function (f) {
                        if (d != User.crtChannelId) {
                            return
                        }
                        c._lastTerm = b;
                        e(f)
                    })
                }
            }
        }];
        a.regexes = [{
            regex: Utils.regex.url,
            callback: function (c, b) {
                c.replaceWord(b, '<a href="' + b.word + '" target="_blank">' + b.word + '</a>', b.word)
            }
        }];
        MX.field.RichTextArea.prototype.constructor.call(this, a)
    },
    getAtValue: function () {
        var a = [];
        var b = document.createElement('div');
        b.innerHTML = this.inputElement.getHtml();
        Ext.fly(b).query('span.r-at').forEach(function (b) {
            var c = Utils.toKey(b.getAttribute('data-value'), !0);
            a.push(c.user_id)
        });
        return a
    },
    initialize: function () {
        var a = this;
        MX.field.RichTextArea.prototype.initialize.apply(this, arguments);
        a.inputElement.dom.setAttribute('spellcheck', !1);
        a.onclickPic();
        a.preventKeydown();
        a.initDrap()
    },
    initDrap: function () {
        this.target = new Ext.drag.Target({
            element: this.element,
            listeners: {
                scope: this,
                dragenter: this.onDragEnter,
                dragleave: this.onDragLeave,
                drop: this.onDrop
            }
        })
    },
    onDragEnter: function (a, b, c) {},
    onDragLeave: function (a, b, c) {},
    onDrop: function (i, g) {
        if (Config.isPC) {
            if (User.draggingChat) {
                return
            }
            var b = g.files;
            if (!b) {
                return
            }
            var h = b.length;
            var d = DesktopChatUtil.getCefObj().getDropFilePath();
            if (!d) {
                return
            }
            var e = d.split('|');
            var c = [];
            for (var a = 0; a < h; a++) {
                var f = b[a];
                if (f.size > 0) {
                    if (e[a]) {
                        c.push({
                            path: e[a],
                            size: f.size
                        })
                    }
                }
            }
            if (c.length > 0) {
                SendUtil.sendFileMsgsByOneAPI(c)
            }
        }
    },
    preventKeydown: function () {
        if (Config.isPC) {
            if (User.settings) {
                var a = User.settings.send_hot_key;
                if (a == 'Ctrl+Enter') {
                    this.bindDefaultSend('CE')
                } else {
                    this.bindDefaultSend('E')
                }
            } else {
                this.bindDefaultSend()
            }
        } else {
            this.bindDefaultSend('E')
        }
    },
    bindDefaultSend: function (d) {
        if (!d) {
            d = 'CE'
        }
        var a = this,
            b = this.inputElement.dom,
            e = a.getPicker();
        if (Config.isPC) {
            switch (d) {
                case 'E':
                    a.setPlaceholder('Enter发送');
                    break;
                default:
                    a.setPlaceholder('Ctrl+Enter发送');
                    break;
            }
        }
        var c = function (g) {
            if (g.value || g.textContent) {
                if (window.cefMain) {
                    var c = Ext.Viewport.lookup('IM');
                    if (User.crtChannelId != StaticChatID.News) {
                        SendUtil.sendMsg(a, User.crtChannelId, c.down('#recentChat').getStore(), c.lookup('im-main').down('#chatView'))
                    } else {
                        SendUtil.sendMsg(a, User.crtChannelId, c.down('#recentChat').getStore(), c.down('newsview').down('newsviewlist'))
                    }
                } else {
                    if (window.cefChat) {
                        var e = Utils.getCmp('desktopChatView');
                        if (e) {
                            SendUtil.sendMsgWORct(a, User.crtChannelId, e.lookup('desktopChatList'))
                        }
                    } else {
                        var b = a.getParent().getParent();
                        if (b && StaticChatID.News !== User.crtChannelId) {
                            b.onSendMsg()
                        } else {
                            if (b && StaticChatID.News === User.crtChannelId) {
                                var f = b.up('newsview');
                                if (f) {
                                    f.onSend()
                                }
                            }
                        }
                    }
                }
            } else {
                Utils.toastShort('不能发送空白消息')
            }
        };
        $(b).bind('keydown', function (f) {
            if (f.keyCode == 13) {
                if (Config.isPC) {
                    if (!e.getHidden()) {} else {
                        if (Config.isPC) {
                            switch (d) {
                                case 'CE':
                                    a.setPlaceholder('Ctrl+Enter发送');
                                    if (f.ctrlKey) {
                                        c(b)
                                    } else {
                                        a._handleEnter(f)
                                    };
                                    return !1;
                                case 'E':
                                    a.setPlaceholder('Enter发送');
                                    if (f.ctrlKey) {
                                        a._handleEnter(f)
                                    } else {
                                        c(b)
                                    };
                                    return !1;
                                default:
                                    return !1;
                            }
                        }
                    }
                } else {
                    a.setPlaceholder('Enter发送');
                    if (f.ctrlKey) {
                        a._handleEnter(f)
                    } else {
                        c(b)
                    }
                    return !1
                }
            }
            if (Config.isPC) {
                if (f.keyCode == 83) {
                    if (f.altKey) {
                        c(b);
                        return !1
                    }
                }
                if (f.keyCode == 67) {
                    if (f.ctrlKey) {
                        var g = ParseUtil.getSelectedContents();
                        var h = ParseUtil.htmlToText(g);
                        DesktopChatUtil.getCefObj().setCopyPTData(h, g, function (a) {
                            if (!a) {
                                Utils.toastShort('复制出错了')
                            }
                        });
                        return !1
                    }
                }
            }
        })
    },
    onclickPic: function () {
        $(this.inputElement.dom).bind('click', function (a) {
            if (a.target.nodeName == 'IMG') {
                var b = document.createRange();
                b.setStartBefore(a.target);
                b.setEndAfter(a.target);
                var c = window.getSelection();
                c.removeAllRanges();
                c.addRange(b);
                a.preventDefault()
            }
        }).bind('dblclick', function (b) {
            if (b.target.nodeName == 'IMG') {
                var a = b.target.src;
                DesktopChatUtil.getCefObj().viewImages(JSON.stringify([{
                    url: a,
                    original: a,
                    name: FileUtil.getFileName(a),
                    createAt: (new Date()).getTime()
                }]), 0)
            }
        })
    },
    onPickerHide: function () {
        var a = this;
        MX.field.RichTextArea.prototype.onPickerHide.apply(this, arguments);
        delete a._lastTerm
    },
    pasteText: function (a) {
        if (document.queryCommandSupported('insertText')) {
            document.execCommand('insertText', !1, a)
        } else {
            document.execCommand('paste', !1, a)
        }
    },
    pasteHtml: function (a) {
        if (document.queryCommandSupported('insertHTML')) {
            document.execCommand('insertHTML', !1, a)
        } else {
            document.execCommand('paste', !1, a)
        }
    },
    doCefPaste: function () {
        var a = this;
        DesktopChatUtil.getCefObj().getCopyData(function (g) {
            var d = JSON.parse(g);
            var f = d.DataType;
            switch (f) {
                case MsgType.TextMsg:
                    var b = d.TextContent;
                    b = ParseUtil.parseTextToHtml(b);
                    a.pasteHtml(b + '&#8203;');
                    break;
                case MsgType.ImgMsg:
                    var c = d.FileList;
                    var b = '';
                    for (var e = 0; e < c.length; e++) {
                        var h = ParseUtil.getLocalFileURL(c[e].path);
                        b += '<img _width="' + c[e].width + '" _height="' + c[e].height + '" class="ect-img" src="' + h + '" data-url="' + c[e].path + '">&#8203;'
                    };
                    a.inputElement.dom.focus();
                    a.pasteHtml(b);
                    break;
                case MsgType.FileMsg:
                    var c = d.FileList;
                    SendUtil.sendFileMsgsByOneAPI(c);
                    break;
                case MsgType.LinkErp:
                    var b = d.TextContent;
                    SendUtil.sendErpLink(b, User.crtChannelId);
                    break;
                case 'PT':
                    var b = d.TextContent;
                    a.pasteHtml(b + '&#8203;');
                    break;
                default:
                    break;
            }
        })
    },
    privates: {
        handlePaste: function (e) {
            if (Config.isPC) {
                var c = this;
                c.doCefPaste();
                e.preventDefault()
            } else {
                if (Config.isPad) {
                    MX.field.RichTextArea.prototype.handlePaste.apply(this, arguments)
                } else {
                    var c = this,
                        g = c.getInputMask();
                    if (!g) {
                        var d = e.browserEvent,
                            a = '';
                        if (d && d.clipboardData && d.clipboardData.getData) {
                            var f = d.clipboardData.items;
                            if (f.length <= 0) {
                                return
                            }
                            var b = c.getTargetItem(f);
                            if (!b) {
                                return
                            }
                            if (b.kind == 'string') {
                                if (b.typeEx == 'text/plain') {
                                    a = d.clipboardData.getData('text/plain');
                                    if (a.length > 4000) {
                                        a = a.substr(0, 4000)
                                    }
                                    a = a.replace(/\n/g, '<br>');
                                    if (document.queryCommandSupported('insertHTML')) {
                                        document.execCommand('insertHTML', !1, a)
                                    } else {
                                        document.execCommand('paste', !1, a)
                                    }
                                } else {
                                    if (b.typeEx == 'text/html') {
                                        b.getAsString(function (a) {
                                            c.htmlToPlain(a, c).then(function (b) {
                                                if (b.length > 4000) {
                                                    b = b.substr(0, 4000)
                                                }
                                                if (document.queryCommandSupported('insertHTML')) {
                                                    document.execCommand('insertHTML', !1, b)
                                                } else {
                                                    document.execCommand('paste', !1, b)
                                                }
                                            })
                                        })
                                    } else {
                                        if (b.typeEx == 'text/rtf') {
                                            b.getAsString(function (b) {
                                                a = c.rtfhtmlToPlain(b) + '&#8203';
                                                if (document.queryCommandSupported('insertHTML')) {
                                                    document.execCommand('insertHTML', !1, a)
                                                } else {
                                                    document.execCommand('paste', !1, a)
                                                }
                                            })
                                        }
                                    }
                                }
                            } else {
                                if (b.kind == 'file') {
                                    var h = b.getAsFile();
                                    if (!User.fileReader) {
                                        User.fileReader = new FileReader()
                                    }
                                    User.fileReader.readAsDataURL(h);
                                    User.fileReader.onloadend = function () {
                                        var a = User.fileReader.result;
                                        if (Config.isPC) {
                                            cefMain.saveFile(a, function (a) {
                                                a = JSON.parse(a);
                                                var c = a.path.replace(/\\/g, '/'),
                                                    f = a.width,
                                                    d = a.height;
                                                var b = '<img class="ect-img" src="' + ('localfile:///' + c) + '" data-url="' + ('file:///' + c) + '" _width="' + f + '" _height="' + d + '">&#8203;&nbsp;';
                                                if (document.queryCommandSupported('insertHTML')) {
                                                    document.execCommand('insertHTML', !1, b)
                                                } else {
                                                    document.execCommand('paste', !1, b)
                                                }
                                            })
                                        }
                                    }
                                }
                            }
                            c._checkRegexes(e)
                        }
                        e.preventDefault()
                    }
                }
            }
        }
    },
    bindPicToEditor: function (b) {
        var a = new FileReader();
        a.onload = function (c) {
            var a = '<img style="width:40px;height:40px;" src="' + c.target.result + '"/>&#8203';
            setTimeout(function () {
                if (document.queryCommandSupported('insertHTML')) {
                    document.execCommand('insertHTML', !1, a)
                } else {
                    document.execCommand('paste', !1, a)
                }
            })
        };
        a.readAsDataURL(b)
    },
    rtfhtmlToPlain: function (a) {
        var c = '';
        var b = a.indexOf('<!--StartFragment-->');
        var d = a.lastIndexOf('<!--EndFragment-->');
        if (b > -1) {
            a = a.substr(b + 20, d - b - 20)
        } else {
            a = a.replace(/\n/g, '<br>')
        }
        a = a.replace(/<\/p>/g, '<br>').replace(/<\/div>/g, '<br>').replace(/<(?!(v:imagedata|br))[^>]*>/g, '');
        c = a.replace(/<v:imagedata[^>]*src="([^"]*)"[^>]*\/>/g, function () {
            var b = arguments[1];
            var c = b;
            if (Utils.isWeb && window.cefMain) {
                c = 'local' + b
            }
            return '<img class="viewPic" src="' + c + '" data-url="' + b + '">'
        });
        console.log(c);
        return c
    },
    htmlToPlain: function (a, e) {
        var b = '';
        var c = a.indexOf('<!--StartFragment-->');
        var d = a.lastIndexOf('<!--EndFragment-->');
        a = a.substr(c + 20, d - c - 20);
        a = a.replace(/\n/g, '<br>').replace(/<\/p>/g, '<br>').replace(/<\/div>/g, '<br>').replace(/<(?!(img|br))[^>]*>/g, '').replace(/<br[^>]*>/g, '<br>');
        b = a.replace(/<img[^>]*>/g, '');
        console.log(b);
        return Ext.Promise.resolve(b)
    },
    getTargetItem: function (e) {
        var a = null;
        var d = !1;
        for (var c = 0; c < e.length; c++) {
            var b = e[c];
            if (b.kind == 'string') {
                if (b.type == 'text/rtf') {
                    d = !0
                } else {
                    if (b.type == 'text/html') {
                        if (a == null || a.type == 'text/plain') {
                            a = b
                        }
                    } else {
                        if (b.type == 'text/plain') {
                            if (a == null) {
                                a = b
                            }
                        }
                    }
                }
            } else {
                a = b;
                break
            }
        }
        if (d) {
            a.typeEx = 'text/rtf'
        } else {
            if (a) {
                a.typeEx = a.type
            }
        }
        return a
    },
    getMultiValue: function () {
        var f = this;
        if (Config.isPad || Config.isPhone) {
            var h = f.getValue(),
                j;
            if (h && /div/g.test(h)) {
                j = h.replace(/<\/div>|<br>/g, '').replace(/<div>/g, '<br>');
                f.updateValue(j)
            }
        }
        var a = document.createElement('div');
        a.innerHTML = this.inputElement.getHtml();
        Ext.fly(a).query('br').forEach(function (a) {
            Ext.DomHelper.insertBefore(a, '\n', !1);
            a.parentNode.removeChild(a)
        });
        Ext.fly(a).query('a').forEach(function (a) {
            Ext.DomHelper.insertBefore(a, a.innerText, !1);
            a.parentNode.removeChild(a)
        });
        var k = [];
        Ext.fly(a).query('span.r-at').forEach(function (a) {
            var b = Utils.toKey(a.getAttribute('data-value'), !0);
            k.push(b.user_id);
            Ext.DomHelper.insertBefore(a, a.innerText, !1);
            a.parentNode.removeChild(a)
        });
        Ext.fly(a).query('img.emoji').forEach(function (a) {
            Ext.DomHelper.insertBefore(a, a.getAttribute('alt'), !1);
            a.parentNode.removeChild(a)
        });
        a.innerHTML = a.innerHTML.replace(/[\u200B]/gm, '');
        var d = [],
            b, c, e, i = a.childNodes.length;
        for (var g = 0; g < i; g++) {
            b = a.childNodes[g];
            if (b.nodeType == 1) {
                if (b.nodeName == 'IMG') {
                    e = f.getImgParam(b);
                    if (e) {
                        d.push(e)
                    }
                }
            } else {
                if (b.nodeType == 3) {
                    c = b.textContent;
                    if (c.trim().length > 0) {
                        if (i > 1) {
                            c = c.trim()
                        }
                        d.push({
                            type: MsgType.TextMsg,
                            value: c
                        })
                    }
                }
            }
        }
        var l = Utils.htmlToText(a.innerHTML);
        return {
            ats: k,
            msgs: d,
            pureText: l
        }
    },
    getImgParam: function (a) {
        if (a.hasAttribute('data-url')) {
            var e = parseInt(a.getAttribute('_width'), 10),
                d = parseInt(a.getAttribute('_height'), 10),
                b = a.getAttribute('data-url');
            var c = ParseUtil.fileExists(b);
            if (c) {
                return {
                    type: MsgType.ImgMsg,
                    width: e,
                    height: d,
                    path: b
                }
            }
        }
        return
    }
}, 1, ['imCommonEditor'], ['widget', 'component', 'field', 'inputfield', 'textfield', 'richtextareafield', 'imCommonEditor'], {
    'widget': !0,
    'component': !0,
    'field': !0,
    'inputfield': !0,
    'textfield': !0,
    'richtextareafield': !0,
    'imCommonEditor': !0
}, ['widget.imCommonEditor'], 0, [IMCommon.view, 'RichEditor'], 0);
Ext.cmd.derive('IMCommon.view.desktop.DesktopChatViewController', Ext.app.ViewController, {
    init: function () {},
    onShowGrpSel: function () {
        var b = this,
            a = User.crtChatType;
        if (a == ChatType.Multi) {
            ChatformSearch.beforeDoGrpChat(User.crtChannelId, User.ownerID, function (c) {
                var d = c.UserIDs.split(',');
                b.showGrpSel(d, a, c.ManagerID, c.ChatID)
            }, function (a) {
                Utils.toastShort(a)
            })
        } else {
            ChatformSearch.beforeDoDitChat(User.crtChannelId, User.ownerID, function (c) {
                var d = c.UserIDs.split(',');
                b.showGrpSel(d, a, c.ManagerID, c.ChatID)
            }, function (a) {
                Utils.toastShort(a)
            })
        }
    },
    showGrpSel: function (d, c, e, f) {
        var b = !0;
        var a;
        if (c == ChatType.Multi) {
            if (e == User.ownerID) {
                b = !1
            }
            a = {
                defSelUsers: d,
                fromAdd: 'add',
                hideACheckbox: b,
                chatID: f
            }
        } else {
            if (c == ChatType.Direct) {
                a = {
                    defSelUsers: d,
                    fromAdd: 'open',
                    hideACheckbox: b
                }
            }
        }
        if (a) {
            DesktopChatUtil.defaults4UserSelForm(a, {})
        }
    },
    onTextBlur: function (a) {
        var b = a.getValue();
        if (b == '' || b == User.rightTitle) {
            a.setValue(User.rightTitle);
            return
        }
        if (a._xhr) {
            Ext.Ajax.abort(a._xhr)
        }
        if (User.crtChannelType == 'C') {
            Ext.Viewport.down('#btnEdit').setReadOnly(!0)
        } else {
            a._xhr = Utils.custAjax('put', 'chats/' + User.crtChannelId, {
                params: JSON.stringify({
                    chat_id: User.crtChannelId,
                    header: b
                }),
                success: function (c) {
                    if (c) {
                        var e = DesktopChatUtil.chgName(User.crtUser.user_name, b);
                        var d = c.messages[0];
                        User.rightTitle = b;
                        var f = Ext.getStore(c.chat.chat_id);
                        if (f) {
                            var g = AddDataUtil.isMsgViewBottom();
                            f.add({
                                msg_id: c.messages[0].msg_id,
                                msgSeq: d.msg_seq,
                                updateTime: d.create_at,
                                GrpChangeMsg: e,
                                showGrpChange: !0
                            });
                            if (User.crtChannelId == c.chat.chat_id) {
                                if (g) {
                                    AddDataUtil.onScrolMsgView()
                                }
                            }
                        }
                        LocalDataMgr.updateChatName(e, d, User.crtUser.user_name)
                    } else {
                        Utils.toastShort('请求更新失败');
                        a.setValue(User.rightTitle)
                    }
                },
                failure: function () {
                    Utils.toastShort('请求更新失败');
                    a.setValue(User.rightTitle)
                }
            })
        }
    },
    onSend: function () {
        var a = this.getView(),
            c = a.down('#richEditor'),
            b = a.lookup('desktopChatList');
        SendUtil.sendMsgWORct(c, User.crtChannelId, b)
    },
    onsetCrowd: function () {
        var c = User.crtChannelId;
        var a = User.createat;
        var b = User.crtId;
        if (window.cefChat) {
            if (cefChat.showCrowdSettingForm) {
                cefChat.showCrowdSettingForm('crowdfristset', c, a, b)
            }
        }
    }
}, 0, 0, 0, 0, ['controller.desktopchatviewcontroller'], 0, [IMCommon.view.desktop, 'DesktopChatViewController'], 0);
Ext.cmd.derive('IMCommon.view.desktop.group.DesktopChatGroupController', Ext.app.ViewController, {
    onDialogOK: function (e) {
        var d = Ext.Viewport.down('list').uid,
            a = Ext.Viewport.down('list').time,
            c = Ext.Viewport.down('list').origin;
        if (a === '' || a == null) {
            Ext.Msg.alert('温馨提示', '请选择日期或者指定某条消息')
        } else {
            var b = this.getView().chgHisDialog;
            DesktopChatUtil.doSearchHistoryAt(d, a, c, b)
        }
    },
    onDialogCancel: function (b) {
        Ext.Viewport.down('list').time = '';
        var a = this.getView().chgHisDialog;
        a.hide();
        a.down('#groupDialog_list').getStore().removeAll()
    },
    checkHisByNow: function () {
        this.getView().chgHisDialog.down('list').hide();
        this.getView().chgHisDialog.down('calendarset').hide();
        Ext.Viewport.down('list').origin = 'Y';
        Ext.Viewport.down('list').time = 0
    },
    checkHisByAll: function () {
        this.getView().chgHisDialog.down('list').hide();
        this.getView().chgHisDialog.down('calendarset').hide();
        Ext.Viewport.down('list').origin = 'N';
        Ext.Viewport.down('list').time = 0
    },
    checkHisByOne: function () {
        this.getView().chgHisDialog.down('list').show();
        this.getView().chgHisDialog.down('calendarset').hide();
        var a = Ext.getStore('groupDialog_list');
        var b = Ext.Viewport.down('list').uid;
        if (a) {
            a.removeAll();
            Utils.custAjax('get', 'chats/' + User.crtChannelId + ('/joinat/' + b), {
                success: function (c) {
                    var b = c.join_at;
                    LocalDataMgr.getHistoryWhenshow(function (g, f) {
                        var e = f.rows;
                        var d = [];
                        for (var b = 0; b < e.length; b++) {
                            d.push(e.item(b))
                        }
                        a.add(d)
                    }, 0, b, User.crtChannelId)
                }
            })
        }
        Ext.Viewport.down('list').time = ''
    },
    checkHisByDay: function (a) {
        this.getView().chgHisDialog.down('list').hide();
        this.getView().chgHisDialog.down('calendarset').show();
        Ext.Viewport.down('list').origin = 'N'
    },
    onTextNotice: function (b) {
        var a = b.getInputValue();
        if (a == User.CrowdNotice) {
            if (a == '') {
                Ext.ComponentQuery.query('#crowdNullnotice')[0].show();
                Ext.ComponentQuery.query('#crowdNotice')[0].hide()
            } else {
                b.setValue(User.CrowdNotice)
            }
        } else {
            Utils.custAjax('put', 'chatcs/' + User.crtId + '/notice', {
                params: JSON.stringify({
                    chat_id: User.crtChannelId,
                    id: User.crtId,
                    notice: a
                }),
                success: function (d) {
                    User.CrowdNotice = a;
                    var c = 'UPDATE IMChatC SET Notice=? WHERE ChatID=?';
                    LocalDataMgr.cExecSqlWithP(c, [a, User.crtChannelId])
                },
                failure: function () {
                    Utils.toastShort('您无权进行此操作');
                    b.setValue(User.CrowdNotice)
                }
            })
        }
    }
}, 0, 0, 0, 0, ['controller.desktopgroupcontroller'], 0, [IMCommon.view.desktop.group, 'DesktopChatGroupController'], 0);
Ext.cmd.derive('IMCommon.view.search.CalendarSet', Ext.panel.Date, {
    classCls: 'Co-big-calendar',
    initialize: function () {
        var a = this;
        Ext.panel.Date.prototype.initialize.apply(this, arguments);
        a.setShowFooter(!1);
        a.on({
            beforeshow: 'initCalendar',
            scope: a
        })
    },
    initCalendar: function (b, c) {
        var a = Ext.Viewport.down('list').uid;
        Utils.custAjax('get', 'chats/' + User.crtChannelId + ('/joinat/' + a), {
            success: function (d) {
                var a = d.join_at;
                LocalSearchMgr.getShowWhenCalendarDate(User.crtChannelId, a, b)
            }
        })
    },
    onDateClick: function (f) {
        var b = this,
            c = f.getTarget(b.cellSelector, b.bodyElement),
            a = c && c.date,
            e = !0,
            d = c && c.disabled;
        var g = Ext.fly(c);
        if (!g.hasCls('x-special')) {
            return
        }
        if (!a || b.getDisabled()) {
            return
        }
        if (!d) {
            b.setValue(a);
            var a = b.getValue(),
                h = Ext.Date.format(a, 'Y-m-d');
            Ext.Viewport.down('list').time = a.getTime()
        }
        if (e) {
            b.focusDate(a)
        }
    },
    changeS1: function (a) {
        User.durtion = !0
    },
    dragging: function (a) {
        var c = this;
        var b = Math.abs(a.deltaX);
        if (b >= 100) {
            if (User.durtion) {
                c.onMonthToolClick({
                    increment: Math.sign(-a.deltaX)
                });
                User.durtion = !1
            }
        }
    },
    changeS2: function (a) {
        User.durtion = !0
    }
}, 0, ['calendarset'], ['widget', 'component', 'container', 'panel', 'datepanel', 'calendarset'], {
    'widget': !0,
    'component': !0,
    'container': !0,
    'panel': !0,
    'datepanel': !0,
    'calendarset': !0
}, ['widget.calendarset'], 0, [IMCommon.view.search, 'CalendarSet'], 0);
Ext.cmd.derive('IMCommon.view.desktop.group.DesktopChatGroup', Ext.Container, {
    controller: 'desktopgroupcontroller',
    cls: 'desktopChat_group',
    layout: 'vbox',
    viewModel: {
        data: {
            memTotal: 0,
            onlineNum: 0
        }
    },
    items: [{
        xtype: 'container',
        style: 'border-bottom: 1px solid rgb(207, 207, 207)',
        itemId: 'crowdNotice2',
        items: [{
            xtype: 'component',
            html: '群公告',
            cls: 'crowdnotice',
            itemId: 'crowdNoticetitle',
            style: 'margin-top:5px;margin-left:10px'
        }, {
            xtype: 'textareafield',
            height: 120,
            style: 'width:118px;margin-top: 0px;',
            cls: 'noticedatial',
            itemId: 'crowdNotice',
            listeners: {
                blur: 'onTextNotice'
            }
        }, {
            xtype: 'component',
            itemId: 'crowdNullnotice',
            height: 120,
            style: 'width:118px;margin-top: 0px;text-align: center;',
            html: '<img src="' + Ext.getResourcePath('images/nullnotice.png', null, 'IMCommon') + '" class="replymsg" ><div>暂无公告</div>',
            hidden: !0,
            listeners: {
                click: {
                    element: 'element',
                    fn: function (c, b) {
                        var a = Ext.getStore('rgList').getById(User.ownerID);
                        if (a.data.isManager || a.data.isadmin == 'Y') {
                            Ext.ComponentQuery.query('#crowdNullnotice')[0].hide();
                            Ext.ComponentQuery.query('#crowdNotice')[0].show();
                            Ext.ComponentQuery.query('#crowdNotice')[0].setValue('');
                            Ext.ComponentQuery.query('#crowdNotice')[0].getFocusEl().dom.focus()
                        }
                    }
                }
            }
        }]
    }, {
        xtype: 'component',
        itemId: 'groupClick',
        bind: {
            html: '<div class="chatview_group_title">会话成员({onlineNum}/{memTotal})</div>'
        }
    }, {
        xtype: 'component',
        itemId: 'crowdGroupclick',
        bind: {
            html: '<div class="chatview_group_title">群成员({onlineNum}/{memTotal})<span class="opentoclose" style="float: right;margin-right: 10px;"></span></div>'
        },
        hidden: !0,
        listeners: {
            click: {
                element: 'element',
                fn: function (b, a) {
                    if (Ext.fly(a).dom.children.length == 0) {
                        if (Ext.fly(a).dom.className == 'opentoclose') {
                            Ext.Viewport.down('desktopChatView').down('#crowdNotice2').hide();
                            Ext.fly(a).dom.className = 'closetoopen'
                        } else {
                            if (Ext.fly(a).dom.className == 'closetoopen') {
                                Ext.Viewport.down('desktopChatView').down('#crowdNotice2').show();
                                Ext.fly(a).dom.className = 'opentoclose'
                            }
                        }
                    } else {
                        if (Ext.fly(a).dom.children[0].className == 'opentoclose') {
                            Ext.Viewport.down('desktopChatView').down('#crowdNotice2').hide();
                            Ext.fly(a).dom.children[0].className = 'closetoopen'
                        } else {
                            if (Ext.fly(a).dom.children[0].className == 'closetoopen') {
                                Ext.Viewport.down('desktopChatView').down('#crowdNotice2').show();
                                Ext.fly(a).dom.children[0].className = 'opentoclose'
                            }
                        }
                    }
                }
            }
        }
    }, {
        xtype: 'list',
        flex: 1,
        itemId: 'desktopChat_grpList',
        userCls: 'im_groupList',
        store: {
            storeId: 'rgList',
            model: 'IMCommon.model.desktop.DesktopGrpMems',
            sorters: [{
                property: 'isManager',
                direction: 'Desc'
            }, {
                property: 'isadmin',
                direction: 'Desc'
            }]
        },
        itemTpl: '<tpl if="User.crtChannelType==\'C\'"><div style="height: 20px; cursor:default;">{[ParseUtil.parseGrpListHTML(values.user_id)]}{[ParseUtil.showMobile(values.user_id)]}<tpl if="values.isManager"><span style="color:red;">{user_name}</span><tpl elseif="values.isadmin==\'Y\'"><span style="color:#24a7f8">{user_name}</span><tpl else><span class="grp_display_text">{user_name}</span></tpl></div><tpl else><div style="height: 20px;cursor:default;">{[ParseUtil.parseGrpListHTML(values.user_id)]}{[ParseUtil.showMobile(values.user_id)]}<tpl if="values.isManager"><span style="color:red;">{user_name}</span><tpl elseif="values.isadmin==\'Y\'"><span style="">{user_name}</span><tpl else><span class="grp_display_text">{user_name}</span></tpl></div></tpl>',
        listeners: {
            childdoubletap: function (e, d) {
                var b = d.record,
                    a = b.get('user_id'),
                    c = b.get('user_name');
                if (a !== User.ownerID) {
                    if (window.cefMain) {
                        ChatHelper.onOpenDirectChat(a, c)
                    } else {
                        if (window.cefChat) {
                            cefChat.createDitChat(a, c)
                        }
                    }
                }
            },
            childsingletap: function (d, b) {
                var a = b.record;
                if (!a) {
                    return
                }
                var c = a.get('user_id');
                DesktopChatUtil.showInformation(c, 2)
            }
        }
    }],
    initialize: function () {
        var b = this;
        Ext.Container.prototype.initialize.apply(this, arguments);
        var a = b.down('#desktopChat_grpList');
        if (a) {
            a.element.on({
                delegate: '.x-listitem',
                contextmenu: 'onGrpListRightClick',
                scope: b
            });
            a.getStore().on({
                add: 'onGrpAdd',
                remove: 'onGrpRemove',
                clear: 'onGrpClear',
                scope: b
            })
        }
    },
    onGrpAdd: function (h, b, g) {
        var a = this.getViewModel();
        console.log('这是在页面上的');
        console.log(a);
        console.log(b);
        var d = a.get('onlineNum');
        var e = a.get('memTotal');
        for (var c = 0; c < b.length; c++) {
            var f = b[c].get('isOnline');
            if (f) {
                d += 1
            }
        }
        e += b.length;
        a.set({
            onlineNum: d,
            memTotal: e
        })
    },
    onGrpRemove: function (h, d) {
        var c = this.getViewModel();
        var a = c.get('onlineNum');
        var b = c.get('memTotal');
        for (var f = 0; f < d.length; f++) {
            var g = d[f].get('user_id');
            var e = User.allStatus[g];
            if (e) {
                if (e.pc_online == 'Y' || e.mobile_online == 'Y') {
                    a -= 1
                }
            }
        }
        b -= d.length;
        if (a < 0) {
            a = 0
        }
        if (b < 0) {
            b = 0
        }
        c.set({
            onlineNum: a,
            memTotal: b
        })
    },
    onGrpClear: function () {
        this.getViewModel().set({
            onlineNum: 0,
            memTotal: 0
        })
    },
    onGrpListRightClick: function (e, j) {
        var g = this;
        var h = j.getAttribute('data-recordindex'),
            f = Ext.getStore('rgList'),
            c = f.getAt(h),
            b = User.crtChannelId,
            a = c.get('user_id');
        var i = g.getRemoveText(a);
        if (User.crtChannelType != 'C') {
            var d = 'SELECT * FROM IMChat WHERE ChatID=?';
            LocalDataMgr.cExecSqlWithP(d, [b], function (x, t) {
                var p = t.rows;
                if (p.length > 0) {
                    var d = p.item(0);
                    var k = d.UserIDs;
                    if (SendUtil.inChat(k)) {
                        var o = d.ManagerID,
                            n = !0;
                        var h = !0,
                            l = !0,
                            m = !0;
                        if (o == User.ownerID) {
                            h = !1;
                            if (User.ownerID !== a) {
                                n = !1;
                                m = !1
                            }
                        } else {
                            if (a == User.ownerID) {
                                h = !1
                            }
                            if (a == o) {
                                l = !1
                            }
                        }
                        if (n && h && m && l) {
                            return
                        }
                        var r = function () {
                            if (k.indexOf(User.ownerID) > -1) {
                                var d = '确定要移出吗';
                                if (User.ownerID == a) {
                                    d = '确定要退出吗'
                                }
                                Ext.Msg.confirm('移除', d, function (d) {
                                    if (d === 'yes') {
                                        Utils.custAjax('DELETE', 'chats/' + b + '/members/' + a, {
                                            success: function (o) {
                                                f.remove(c);
                                                LocalDataMgr.doChatAfterRemoveUser(b, a, k);
                                                var h = '你已退出该会话';
                                                if (User.ownerID != a) {
                                                    h = '你将' + c.get('user_name') + '移出该会话'
                                                }
                                                var l = Ext.getStore(b);
                                                var g = o.messages[0];
                                                if (l) {
                                                    var m = AddDataUtil.isMsgViewBottom();
                                                    l.add({
                                                        msg_id: g.msg_id,
                                                        msgSeq: g.msg_seq,
                                                        updateTime: g.create_at,
                                                        GrpChangeMsg: h,
                                                        showGrpChange: !0,
                                                        showTime: ParseUtil.dataShowTime(l, new Date(g.create_at))
                                                    });
                                                    if (User.crtChannelId == b) {
                                                        if (m) {
                                                            AddDataUtil.onScrolMsgView()
                                                        }
                                                    }
                                                }
                                                var n = Ext.getStore('comRct'),
                                                    i = n.getById(b);
                                                if (i) {
                                                    i.set({
                                                        last_msg_type: MsgType.GroupNotice,
                                                        last_post_msg: h,
                                                        last_post_at: new Date(g.create_at)
                                                    });
                                                    Utils.custAjax('get', 'users/me/chats/' + b, {
                                                        success: function (a) {
                                                            if (a.chat_type == ChatType.Multi) {
                                                                User.needUpdateChatAva(b, a.create_at, a.avatar_hash, function () {
                                                                    i.set('avaHash', a.avatar_hash)
                                                                })
                                                            }
                                                        }
                                                    })
                                                }
                                                LocalDataMgr.doMsgAfterRemoveUser(b, g, h)
                                            }
                                        })
                                    }
                                })
                            } else {
                                Utils.toastShort('对不起，您已被移出该会话')
                            }
                        };
                        var v = function () {
                            if (k.indexOf(User.ownerID) > -1) {
                                Ext.Msg.confirm('管理员更换', '确认更换管理员？', function (d) {
                                    if (d === 'yes') {
                                        Utils.custAjax('PUT', 'chats/' + b + '/manager', {
                                            params: JSON.stringify([a]),
                                            success: function (q) {
                                                var f = q.messages[0];
                                                var g = '你将管理员转让给"' + c.get('user_name') + '"';
                                                LocalDataMgr.doChatAfterChgMgr(b, a);
                                                LocalDataMgr.doMsgAfterChgMgr(b, f, g);
                                                var h = Ext.getStore(b);
                                                if (h) {
                                                    var n = AddDataUtil.isMsgViewBottom();
                                                    h.add({
                                                        msg_id: f.msg_id,
                                                        msgSeq: f.msg_seq,
                                                        updateTime: f.create_at,
                                                        GrpChangeMsg: g,
                                                        showGrpChange: !0,
                                                        showTime: ParseUtil.dataShowTime(h, new Date(f.create_at))
                                                    });
                                                    if (User.crtChannelId == b) {
                                                        if (n) {
                                                            AddDataUtil.onScrolMsgView()
                                                        }
                                                    }
                                                }
                                                var o = Ext.getStore('comRct'),
                                                    l = o.getById(b);
                                                if (l) {
                                                    l.set({
                                                        last_msg_type: MsgType.GroupNotice,
                                                        last_post_msg: g,
                                                        last_post_at: new Date(f.create_at)
                                                    })
                                                }
                                                var k = ViewGet.getGrpListStore();
                                                var m = k.getById(User.ownerID);
                                                if (m) {
                                                    m.set({
                                                        isManager: !1
                                                    })
                                                }
                                                var i = k.getById(a);
                                                if (i) {
                                                    i.set({
                                                        isManager: !0
                                                    })
                                                }
                                                var p = ViewGet.getIMChatViewContainer().down('#btnEdit');
                                                p.setReadOnly(!0)
                                            }
                                        })
                                    }
                                })
                            } else {
                                Utils.toastShort('对不起，您已被移出该会话')
                            }
                        };
                        var u = function () {
                            var b = g.getChgHisDialog(a);
                            Ext.Viewport.down('list').uid = a;
                            b.down('#userSelDialog_radio_now').setChecked(!0);
                            b.show();
                            Ext.Viewport.down('list').origin = 'Y';
                            Ext.Viewport.down('list').time = 0
                        };
                        var s = function () {
                            var b = Ext.getStore('rgList').data.items;
                            var c = !1;
                            for (var a = 0; a < b.length; a++) {
                                if (b[a].data.user_id == User.ownerID) {
                                    c = !0;
                                    break
                                }
                            }
                            if (c) {
                                Utils.custAjax('post', 'chats/' + User.crtChannelId + '/seehistory', {
                                    params: JSON.stringify({
                                        chat_id: User.crtChannelId,
                                        user_ids: [User.ownerID]
                                    }),
                                    success: function (a) {
                                        var b;
                                        b = '您已经申请了查看更多历史消息';
                                        LocalDataMgr.getDB().transaction(function (b) {});
                                        var f = 'INSERT INTO IMMsg (MsgID, ChatID, MsgType, Content, CreateAt, Status, MsgSeq) VALUES (?,?,?,?,?,?,?);';
                                        LocalDataMgr.cExecSqlWithP(f, [a.msg_id, a.chat_id, MsgType.GroupNotice, b, a.update_at, '0', a.msg_seq], function (c, b) {});
                                        var g = 'UPDATE IMRct SET LastMessage=?,LastMsgType=?,LastPostAt=? WHERE ChatID=?;';
                                        LocalDataMgr.cExecSqlWithP(g, [b, MsgType.GroupNotice, a.update_at, a.chat_id], function (c, b) {});
                                        if (!window.cefMsgMgr) {
                                            var c = Ext.getStore('comRct').getById(a.chat_id);
                                            if (c) {
                                                c.set({
                                                    last_post_at: new Date(a.update_at),
                                                    last_msg_type: 'H',
                                                    last_post_name: ''
                                                })
                                            }
                                        }
                                        if (User.crtChannelId == a.chat_id) {
                                            var d = Ext.getStore(a.chat_id);
                                            if (d) {
                                                d.add({
                                                    msg_id: a.msg_id,
                                                    msgSeq: a.msg_seq,
                                                    updateTime: a.update_at,
                                                    GrpChangeMsg: b,
                                                    showGrpChange: !0,
                                                    showGrpSeeMore: !1
                                                })
                                            }
                                        }
                                        AddDataUtil.onScrolMsgView()
                                    },
                                    failure: function (a) {
                                        console.log('温馨提示', '申请查看更多历史消息失败')
                                    }
                                })
                            } else {
                                Ext.Msg.alert('你已不在此会话中')
                            }
                        };
                        var q = {
                            text: d.Status == '2' ? '恢复会话' : '解散会话',
                            ui: d.Status == '2' ? 'green' : 'red',
                            hidden: d.ManagerID !== User.ownerID || a !== User.ownerID || d.Status === 9 || d.Status === 1 || d.FromERP == 'Y',
                            handler: function () {
                                if (d.Status != '2') {
                                    Ext.Msg.confirm('提示', '确定要解散会话吗?', function (c) {
                                        if (c === 'yes') {
                                            Utils.custAjax('PUT', 'chats/' + b + '/dismiss', {
                                                success: function (g) {
                                                    var d = g.messages[0],
                                                        h = g.chat;
                                                    var f = GroupNotice.dismissMultiChat(a);
                                                    LocalDataMgr.updateChatStatus(b, '2');
                                                    LocalDataMgr.insertNotice({
                                                        msg_id: d.msg_id,
                                                        msg_seq: d.msg_seq,
                                                        chat_id: b,
                                                        msg_type: MsgType.GroupNotice,
                                                        content: f,
                                                        create_at: d.create_at,
                                                        sender_id: d.user_id,
                                                        sender_name: User.crtUser.user_name,
                                                        status: '0'
                                                    });
                                                    DesktopChatUtil.updateUIForMultiChatHeader(!0, h.manager_id == User.crtUser.user_id);
                                                    DesktopChatUtil.updateUIWithNotice(b, d.msg_seq, d.msg_id, f, d.create_at)
                                                }
                                            })
                                        }
                                    })
                                } else {
                                    Ext.Msg.confirm('提示', '确定要恢复会话吗?', function (c) {
                                        if (c === 'yes') {
                                            Utils.custAjax('PUT', 'chats/' + b + '/recover', {
                                                success: function (g) {
                                                    var d = g.messages[0],
                                                        h = g.chat;
                                                    var f = GroupNotice.recoverMultiChat(a);
                                                    LocalDataMgr.updateChatStatus(b, '0');
                                                    LocalDataMgr.insertNotice({
                                                        msg_id: d.msg_id,
                                                        msg_seq: d.msg_seq,
                                                        chat_id: b,
                                                        msg_type: MsgType.GroupNotice,
                                                        content: f,
                                                        create_at: d.create_at,
                                                        sender_id: d.user_id,
                                                        sender_name: User.crtUser.user_name,
                                                        status: '0'
                                                    });
                                                    DesktopChatUtil.updateUIForMultiChatHeader(!1, h.manager_id == User.crtUser.user_id);
                                                    DesktopChatUtil.updateUIWithNotice(b, d.msg_seq, d.msg_id, f, d.create_at)
                                                }
                                            })
                                        }
                                    })
                                }
                            }
                        };
                        var w = Ext.create('IMCommon.view.menu.HideDestroyMenu', {
                            indented: !1,
                            items: [{
                                text: i,
                                hidden: h,
                                handler: r
                            }, {
                                text: '更换管理员',
                                hidden: n,
                                handler: v
                            }, {
                                text: '指定消息查看范围',
                                hidden: m,
                                handler: u
                            }, {
                                text: '申请查看更多历史消息',
                                hidden: l,
                                handler: s
                            }, q]
                        });
                        ParseUtil.menuShowAtVisible(w, e.getPoint())
                    }
                }
            })
        } else {
            var d = 'SELECT * FROM IMChatC WHERE ID=?';
            LocalDataMgr.cExecSqlWithP(d, [User.crtId], function (i, f) {
                var d = f.rows;
                var h = d.item(0);
                var c = h.ManagerID;
                if (d.length > 0) {
                    var g = 'SELECT * FROM IMChatCM WHERE ChatID=?';
                    LocalDataMgr.cExecSqlWithP(g, [b], function (s, o) {
                        var b = o.rows;
                        var l = !0,
                            k = !0;
                        var m = [],
                            n = [];
                        for (var d = 0; d < b.length; d++) {
                            if (b.item(d).IsAdmin == 'Y' && b.item(d).BodyID != a) {} else {
                                if (b.item(d).IsAdmin != 'Y' && b.item(d).BodyID != a) {}
                            }
                        }
                        var h = !1;
                        for (var g = 0; g < b.length; g++) {
                            if (b.item(g).BodyID == a) {
                                if (b.item(g).IsAdmin == 'Y') {
                                    if (c == User.ownerID) {
                                        k = !1;
                                        h = !0
                                    }
                                } else {
                                    if (c == User.ownerID && User.ownerID == a) {} else {
                                        if (c == User.ownerID) {
                                            l = !1;
                                            h = !0
                                        }
                                    }
                                }
                            }
                        }
                        var q = function () {
                            m.push(a);
                            Utils.custAjax('PUT', 'chatcs/' + User.crtId + '/admin', {
                                params: JSON.stringify({
                                    chat_id: User.crtChannelId,
                                    admins: m
                                }),
                                success: function (d) {
                                    var b = Ext.getStore('rgList').getById(a);
                                    if (b.data.isadmin == 'Y') {
                                        b.set('isadmin', 'N');
                                        var c = 'UPDATE IMChatCM SET IsAdmin=? WHERE (ChatID=? AND BodyID=?)';
                                        LocalDataMgr.cExecSqlWithP(c, ['N', User.crtChannelId, a])
                                    } else {
                                        b.set('isadmin', 'Y');
                                        var c = 'UPDATE IMChatCM SET IsAdmin=? WHERE (ChatID=? AND BodyID=?)';
                                        LocalDataMgr.cExecSqlWithP(c, ['Y', User.crtChannelId, a])
                                    }
                                },
                                failure: function () {}
                            })
                        };
                        var p = function () {
                            n.push(a);
                            Utils.custAjax('PUT', 'chatcs/' + User.crtId + '/admin', {
                                params: JSON.stringify({
                                    chat_id: User.crtChannelId,
                                    users: n
                                }),
                                success: function (d) {
                                    var b = Ext.getStore('rgList').getById(a);
                                    if (b.data.isadmin == 'Y') {
                                        b.set('isadmin', 'N');
                                        var c = 'UPDATE IMChatCM SET IsAdmin=? WHERE (ChatID=? AND BodyID=?)';
                                        LocalDataMgr.cExecSqlWithP(c, ['N', User.crtChannelId, a])
                                    } else {
                                        b.set('isadmin', 'Y');
                                        var c = 'UPDATE IMChatCM SET IsAdmin=? WHERE (ChatID=? AND BodyID=?)';
                                        LocalDataMgr.cExecSqlWithP(c, ['Y', User.crtChannelId, a])
                                    }
                                },
                                failure: function () {}
                            })
                        };
                        var r = Ext.create('IMCommon.view.menu.HideDestroyMenu', {
                            indented: !1,
                            items: [{
                                text: '设置管理员',
                                hidden: l,
                                handler: q
                            }, {
                                text: '取消管理员',
                                hidden: k,
                                handler: p
                            }]
                        });
                        ParseUtil.menuCrowdShowAtVisible(r, e.getPoint(), h)
                    })
                }
            })
        }
        e.preventDefault()
    },
    getRemoveText: function (a) {
        if (User.ownerID == a) {
            return '退出会话'
        }
        return '移出会话'
    },
    imitateShowAt: function (a, b, c) {
        if (a.getFloated() || a.isPositioned()) {
            if (arguments.length === 2) {
                if (b.x) {
                    c = b.y;
                    b = b.x - 70
                } else {
                    c = b[1];
                    b = b[0] - 70
                }
            }
            a.show();
            if (a.isPositioned()) {
                a.setLeft(b);
                a.setTop(c)
            } else {
                a.setX(b);
                a.setY(c)
            }
        }
        return a
    },
    getChgHisDialog: function (c) {
        var b = this;
        var a = this.chgHisDialog;
        if (!a) {
            a = Ext.apply({
                ownerCmp: b
            }, b.dialog);
            this.chgHisDialog = a = Ext.create(a);
            a.down('#groupDialog_list').getScrollable().on({
                scroll: 'onChgDialogScrol',
                scope: b
            })
        }
        return a
    },
    dialog: {
        xtype: 'dialog',
        title: '指定消息查看范围',
        height: '90%',
        width: '90%',
        closable: !0,
        defaultFocus: '#ok',
        cls: 'GroupDialog',
        bodyPadding: 20,
        layout: 'vbox',
        items: [{
            xtype: 'container',
            layout: 'hbox',
            items: [{
                xtype: 'radiofield',
                itemId: 'userSelDialog_radio_now',
                name: 'showHistoryat',
                labelWidth: 'auto',
                labelAlign: 'right',
                style: 'margin-right:15px;',
                label: '仅显示加入会话后的信息',
                listeners: {
                    check: 'checkHisByNow'
                }
            }, {
                xtype: 'radiofield',
                itemId: 'userSelDialog_radio_all',
                name: 'showHistoryat',
                labelWidth: 'auto',
                labelAlign: 'right',
                style: 'margin-right:15px;',
                label: '显示全部消息',
                listeners: {
                    check: 'checkHisByAll'
                }
            }, {
                xtype: 'radiofield',
                itemId: 'userSelDialog_radio_one',
                name: 'showHistoryat',
                labelWidth: 'auto',
                labelAlign: 'right',
                style: 'margin-right:15px;',
                label: '选择消息进行展示',
                listeners: {
                    check: 'checkHisByOne'
                }
            }, {
                xtype: 'radiofield',
                itemId: 'userSelDialog_radio_day',
                name: 'showHistoryat',
                labelWidth: 'auto',
                labelAlign: 'right',
                label: '选择日期',
                listeners: {
                    check: 'checkHisByDay'
                }
            }]
        }, {
            xtype: 'combobox',
            itemId: 'groupDialog_search',
            placeholder: '搜索消息内容',
            hidden: !0
        }, {
            xtype: 'calendarset',
            hidden: !0
        }, {
            xtype: 'list',
            itemId: 'groupDialog_list',
            hidden: !0,
            flex: 1,
            cls: 'pcgrouplist',
            itemTpl: ['<div style="left:0;position:absolute">', '<input type="radio"  name="killOrder" value="1" id="setHisRio" class="test-radioInput"/>', '</div>', '<tpl if="values.MsgType == \'R\'">', '<tpl else>', '<div class="msgRecord_imitate_list">', '<tpl if="values.showDate">', '<div class="msgRecord_Date">{[Utils.date2Str(values.CreateAt)]}</div>', '</tpl>', '<div class="msgRecord_title" style="color:{[values.SenderID == User.ownerID ? \'rgb(36, 118, 224)\' : \'\']}">{SenderName} {[Utils.datetime2Ago(values.CreateAt,true)]}</div>', '<div class="msgRecord_content" {[DesktopChatUtil.pushInfoToDom(values)]}>', '<tpl if="values.MsgType == \'T\'">', '{[ParseUtil.parseHisTextToHtml(values.Content)]}', '<tpl elseif="values.MsgType == \'I\'">', '{[DesktopChatUtil.parseLoadedPic(values.Height,values.Width,values.FilePath,values.CreateAt,values.FileName,values.FileID)]}', '<tpl elseif="values.MsgType == \'F\'">', '<div class="msgRecord_file">', '<div class="mrd_fileWrapper">', '<div class="mrd_fileIcon {[ParseUtil.getFileIcon(values.FileName)]}"></div>', '<div class="mrd_fileName">{FileName}</div>', '<div>{[ParseUtil.bytesToSize(values.FileSize)]}</div>', '</div>', '</div>', '<tpl elseif="values.MsgType == \'G\'">', '{Content}', '<tpl elseif="values.MsgType == \'L\'">', '<div class="msgRecord_link">', '<div class="mrd_linkIcon" letter="{LinkType}"></div>', '<div class="mrd_linkName">{LinkTitle}</div>', '</div>', '<tpl elseif="values.MsgType == \'B\'">', '{[GroupNotice.getRevokeNotice(values.SenderID,values.Content)]}', '<tpl elseif="values.MsgType == \'E\'">', '<div class="msgRecord_file">', '<div class="mrd_fileWrapper">', '<div class="mrd_fileIcon {[ParseUtil.getFileIcon(values.BFileName)]}"></div>', '<div class="mrd_fileName">{BFileName}</div>', '<div>{[ParseUtil.bytesToSize(values.BFileSize)]}</div>', '</div>', '<div class="bigfile-special"></div>', '</div>', '<tpl else>', '消息类型未适配：{MsgType}', '</tpl>', '</div>', '</div>', '</tpl>'].join(''),
            deselectable: !1,
            store: {
                storeId: 'groupDialog_list',
                fields: ['MsgID', 'MsgType', 'Content', 'SenderID', 'SenderName', 'CreateAt', 'Height', 'Width', 'FilePath', 'FileName', 'FileID', 'FileSize', 'LinkType', 'LinkTitle', 'BFileName']
            },
            listeners: {
                childtap: function (b, a) {
                    if (Ext.fly(a.event.target).parent('.msgRecord_imitate_list')) {
                        if (Ext.fly(a.event.target).parent().parent().dom.getElementsByClassName('test-radioInput').length == 0) {
                            if (Ext.fly(a.event.target).parent().parent().parent().dom.getElementsByClassName('test-radioInput').length == 0) {
                                if (Ext.fly(a.event.target).parent().parent().parent().parent().dom.getElementsByClassName('test-radioInput').length == 0) {
                                    Ext.fly(a.event.target).parent().parent().parent().parent().parent().dom.getElementsByClassName('test-radioInput')[0].checked = !0
                                } else {
                                    Ext.fly(a.event.target).parent().parent().parent().parent().dom.getElementsByClassName('test-radioInput')[0].checked = !0
                                }
                            } else {
                                Ext.fly(a.event.target).parent().parent().parent().dom.getElementsByClassName('test-radioInput')[0].checked = !0
                            }
                        } else {
                            Ext.fly(a.event.target).parent().parent().dom.getElementsByClassName('test-radioInput')[0].checked = !0
                        }
                    }
                    Ext.Viewport.down('list').time = a.record.data.CreateAt;
                    Ext.Viewport.down('list').origin = 'N'
                }
            }
        }],
        buttons: {
            ok: {
                handler: 'onDialogOK'
            },
            cancel: {
                ui: 'flat',
                handler: 'onDialogCancel'
            }
        }
    },
    onChgDialogScrol: function (h, j, k) {
        var a = h.getScrollElement().dom,
            f = a.scrollHeight,
            g = a.scrollTop,
            e = a.offsetHeight;
        if (f <= Math.ceil(g + e)) {
            var b = Ext.getStore('groupDialog_list');
            if (!b) {
                return
            }
            var d = b.last();
            if (!d) {
                return
            }
            var c = d.get('CreateAt');
            if (!c) {
                return
            }
            var i = 'SELECT M.MsgID,M.ChatID,M.MsgType,M.Content,M.CreateAt,M.SenderID,M.SenderName,M.MsgSeq,M.Status,F.FileID,F.BaseID FileBaseID,F.FilePath,F.FileType,F.FileName,F.MimeType,F.Width,F.Height,F.FileSize,F.Extension,F.FileStatus,F.HasPreview,L.BaseID LinkBaseID,L.Type,L.LinkObjType,L.LinkKeyString,L.LinkID,L.LinkTitle,L.LinkType,L.LinkOpUser,L.LinkDesc,L.LinkStr,L.LinkFromID,L.LinkStepID,L.LinkStepDesc,L.LinkStepStatus,L.LinkStatus,L.LinkStgGuid, B.BaseID BFileBaseID,B.BFileID,B.BFilePath,B.BFileName,B.BFileSize,B.BFileExtension,B.BFileStatus,B.CreateAt BCreateAt,B.ExpireAt FROM IMMsg M LEFT JOIN IMFile F ON M.ID = F.BaseID LEFT JOIN IMLink L ON M.ID = L.BaseID LEFT JOIN IMBFile B ON M.ID = B.BaseID WHERE M.ChatID = ? AND M.MsgType<>? AND M.Status<>? AND M.CreateAt < ? ORDER BY M.CreateAt DESC LIMIT 20;';
            LocalDataMgr.cExecSqlWithP(i, [User.crtChannelId, MsgType.NotShow, '1', c], function (f, e) {
                var d = e.rows;
                var c = [];
                for (var a = 0; a < d.length; a++) {
                    c.push(d.item(a))
                }
                b.add(c)
            })
        }
    }
}, 0, ['desktopChat_group'], ['widget', 'component', 'container', 'desktopChat_group'], {
    'widget': !0,
    'component': !0,
    'container': !0,
    'desktopChat_group': !0
}, ['widget.desktopChat_group'], 0, [IMCommon.view.desktop.group, 'DesktopChatGroup'], 0);
Ext.cmd.derive('IMCommon.view.desktop.list.DesktopChatList', IMCommon.view.MsgView, {
    viewModel: {
        type: 'desktop_chatlist'
    },
    initialize: function () {
        var a = this;
        IMCommon.view.MsgView.prototype.initialize.apply(this, arguments);
        a.element.on({
            delegate: '.bubble',
            contextmenu: 'onRightClickBubble',
            scope: a
        });
        a.on({
            revokeEdit: 'onRevokeEdit',
            childtap: 'doPageTap',
            scope: a
        });
        var c = a.add({
            xtype: 'fabbutton',
            width: 100,
            height: 32,
            top: 24,
            bottom: 0,
            right: 24,
            zIndex: 7,
            draggable: !1,
            bind: {
                hidden: '{hideUpBtn}'
            },
            text: '向上滚动',
            ui: 'action',
            iconCls: 'x-fa fa-angle-double-up',
            handler: 'onTapUpBtn',
            scope: a
        });
        c.setHidden(!0);
        c.render(a.element);
        var d = a.add({
            xtype: 'fabbutton',
            height: 32,
            draggable: !1,
            bind: {
                hidden: '{hideMoreMsg}',
                width: '{msgNum > 0 ? 110:100}',
                text: '{msgNum > 0 ? msgNum+"条新消息":"滚动至最新"}'
            },
            ui: 'action',
            iconCls: 'x-fa fa-angle-double-down',
            handler: 'onTapShowMsg',
            scope: a
        });
        d.setHidden(!0);
        d.render(a.element);
        var b = a.add({
            xtype: 'fabcontainer',
            layout: 'hbox',
            draggable: !1,
            style: '\n            -webkit-box-shadow: 0 8px 17px 0 rgba(0, 0, 0, 0.2);\n            -moz-box-shadow: 0 8px 17px 0 rgba(0, 0, 0, 0.2);\n            box-shadow: 0 8px 17px 0 rgba(0, 0, 0, 0.2);\n            border: none;',
            width: 130,
            height: 32,
            zIndex: 100,
            bind: {
                hidden: '{hideAtBtn}'
            },
            items: [{
                style: 'box-shadow:none;',
                width: 96,
                height: 32,
                right: 33,
                zIndex: 100,
                draggable: !1,
                bind: {
                    text: '{atCount}条@消息'
                },
                ui: 'action',
                handler: 'onTapAtBtnUseDB',
                scope: a
            }, {
                xtype: 'component',
                style: '\n                    position: absolute;\n                    border-left: solid 1px #d8d7d7;\n                    right: 32px;\n                    height: 20px;\n                    margin-top: 7px;\n                '
            }, {
                style: 'box-shadow:none;',
                width: 32,
                height: 32,
                right: 0,
                zIndex: 100,
                draggable: !1,
                iconCls: 'im-common-close',
                ui: 'imCommonTX',
                handler: 'onClearAtBtnUseDB',
                scope: a
            }]
        });
        b.setHidden(!0);
        b.render(a.element);
        a.getScrollable().on({
            scroll: 'doScrolEvent',
            scope: a
        });
        a.on({
            setoneHistory: 'onsetoneHistory',
            scope: a
        });
        a.on({
            seeHistory: 'onSeeHistory',
            scope: a
        })
    },
    doPageTap: function (g, a) {
        var b = a.record;
        if (!b) {
            return
        }
        var d = User.crtChannelId;
        if (!d) {
            return
        }
        var c = User.crtChannelType;
        if (!c) {
            return
        }
        var e = a.event;
        var f = Ext.fly(e.target);
        if (f.hasCls('msgview_reply')) {
            DesktopChatUtil.showReply(b)
        }
    },
    onRevokeEdit: function (c) {
        var a, b = '';
        if (window.cefMain) {
            a = ViewGet.getEditorView();
            b = window.minEmoji(c)
        } else {
            if (window.cefChat) {
                a = Utils.getCmp('cefOneChat').down('#richEditor');
                b = window.minEmoji(c)
            }
        }
        if (a) {
            a.clear();
            a.focus();
            a.pasteHtml(b + '&#8203;')
        }
    },
    onRightClickBubble: function (d, h) {
        var b = this;
        var c = d.currentTarget;
        var g = c.getAttribute('msgType');
        if (!g) {
            return
        }
        var f = c.getAttribute('msgID');
        if (!f) {
            return
        }
        var e = Ext.getStore(User.crtChannelId);
        if (!e) {
            return
        }
        var a = e.getById(f);
        if (!a) {
            return
        }
        LocalDataMgr.getchattype(User.crtChannelId, function (o) {
            var n = a.get('sendStatus');
            if (n == 0) {
                var i = ParseUtil.getHideRevoke(a.get('updateTime'), a.get('senderID'), o);
                var e = null;
                switch (g) {
                    case MsgType.TextMsg:
                        var j = ParseUtil.getSelectedContents();
                        if (!j) {
                            b.selectText(c);
                            j = c.innerHTML
                        };
                        j = j.replace(/&nbsp;/g, ' ');
                        var r = ParseUtil.htmlToText(j);
                        e = b.getTextMenu(r, i, a);
                        break;
                    case MsgType.ImgMsg:
                        var q = Ext.fly(d.currentTarget);
                        var f = q.query('img')[0];
                        if (!f) {
                            return
                        };
                        for (var m = 0; m < f.classList.length; m++) {
                            if (f.classList[m] == 'loaded') {
                                var l = f.getAttribute('src');
                                var k = f.getAttribute('fileName');
                                b.selectText(c);
                                e = b.getImgMenu(l, k, i, a, f);
                                break
                            }
                        };
                        break;
                    case MsgType.FileMsg:
                        if (parseInt(a.get('fileStatus'), 10) == 0) {
                            var l = a.get('localPath').replace(ConfigMgr.getDataDirectory() + User.accountID + '/' + User.ownerID + '/', '');
                            var k = a.get('fileName');
                            e = b.getFileMenu(l, k, i, a)
                        };
                        break;
                    case MsgType.LinkErp:
                        var p = a.get('content');
                        e = b.getLinkMenu(p, i, a);
                        break;
                    case MsgType.BigFileMsg:
                        if (parseInt(a.get('fileStatus'), 10) == 0) {
                            var t = a.get('localPath');
                            var s = a.get('fileName');
                            e = b.getBFileMenu(t, s, i, a)
                        };
                        break;
                    default:
                        break;
                }
                if (e) {
                    ParseUtil.menuShowAtVisible(e, d.getPoint())
                }
            }
            d.preventDefault()
        });
        d.preventDefault()
    },
    getTextMenu: function (e, c, a) {
        var b = this;
        var d = Ext.create('IMCommon.view.menu.HideDestroyMenu', {
            width: 100,
            items: [{
                text: '复制',
                indented: !1,
                handler: function () {
                    b.cefCopyToClipboard(MsgType.TextMsg, e)
                }
            }, {
                text: '撤回',
                hidden: c,
                indented: !1,
                handler: function () {
                    b.doRevoke(a)
                }
            }, {
                text: '转发',
                indented: !1,
                handler: function () {
                    b.doTransmit(a)
                }
            }, {
                text: '回复',
                hidden: !0,
                handler: function () {
                    DesktopChatUtil.showReply(a)
                }
            }]
        });
        return d
    },
    getImgMenu: function (a, e, d, c, g) {
        var b = this;
        a = ParseUtil.getOriginPicPath(a);
        var f = Ext.create('IMCommon.view.menu.HideDestroyMenu', {
            width: 100,
            items: [{
                text: '复制',
                indented: !1,
                handler: function () {
                    b.cefCopyToClipboard(MsgType.ImgMsg, a)
                }
            }, {
                text: '打开',
                indented: !1,
                handler: function () {
                    var i = 'img.viewPic.loaded';
                    var j = b.innerElement.dom.querySelectorAll(i),
                        f = [],
                        h = -1;
                    j.forEach(function (b, i) {
                        f.push({
                            url: b.src,
                            original: b.getAttribute('data-original'),
                            name: b.getAttribute('fileName'),
                            createAt: b.getAttribute('create_at')
                        });
                        if (g === b) {
                            h = i
                        }
                    });
                    if (Config.isPC) {
                        f = JSON.stringify(f);
                        DesktopChatUtil.getCefObj().viewImages(f, h)
                    }
                }
            }, {
                text: '另存为',
                indented: !1,
                handler: function () {
                    FileMgr.saveAs(a, e)
                }
            }, {
                text: '打开文件夹',
                indented: !1,
                handler: function () {
                    FileMgr.openFolder(a)
                }
            }, {
                text: '撤回',
                hidden: d,
                indented: !1,
                handler: function () {
                    b.doRevoke(c)
                }
            }, {
                text: '转发',
                indented: !1,
                handler: function () {
                    b.doTransmit(c)
                }
            }, {
                text: '回复',
                hidden: !0,
                handler: function () {
                    DesktopChatUtil.showReply(c)
                }
            }]
        });
        return f
    },
    getFileMenu: function (a, e, d, b) {
        var c = this;
        var f = Ext.create('IMCommon.view.menu.HideDestroyMenu', {
            width: 100,
            items: [{
                text: '复制',
                indented: !1,
                handler: function () {
                    var f = ParseUtil.getAbsolutePath(a);
                    c.cefCopyToClipboard(MsgType.FileMsg, f)
                }
            }, {
                text: '打开',
                indented: !1,
                handler: function () {
                    FileMgr.open(a)
                }
            }, {
                text: '另存为',
                indented: !1,
                handler: function () {
                    FileMgr.saveAs(a, e)
                }
            }, {
                text: '打开文件夹',
                indented: !1,
                handler: function () {
                    FileMgr.openFolder(a)
                }
            }, {
                text: '撤回',
                hidden: d,
                indented: !1,
                handler: function () {
                    c.doRevoke(b)
                }
            }, {
                text: '转发',
                indented: !1,
                handler: function () {
                    c.doTransmit(b)
                }
            }, {
                text: '回复',
                hidden: !0,
                handler: function () {
                    DesktopChatUtil.showReply(b)
                }
            }]
        });
        return f
    },
    getLinkMenu: function (d, c, a) {
        var b = this;
        var e = Ext.create('IMCommon.view.menu.HideDestroyMenu', {
            width: 100,
            items: [{
                text: '复制',
                indented: !1,
                handler: function () {
                    b.cefCopyToClipboard(MsgType.LinkErp, d)
                }
            }, {
                text: '撤回',
                hidden: c,
                indented: !1,
                handler: function () {
                    b.doRevoke(a)
                }
            }, {
                text: '转发',
                indented: !1,
                handler: function () {
                    b.doTransmit(a)
                }
            }, {
                text: '回复',
                hidden: !0,
                handler: function () {
                    DesktopChatUtil.showReply(a)
                }
            }]
        });
        return e
    },
    getBFileMenu: function (a, d, f, b) {
        var c = this;
        var e = Ext.create('IMCommon.view.menu.HideDestroyMenu', {
            width: 100,
            items: [{
                text: '复制',
                indented: !1,
                handler: function () {
                    var e = ParseUtil.getAbsolutePath(a);
                    c.cefCopyToClipboard(MsgType.FileMsg, e)
                }
            }, {
                text: '打开',
                indented: !1,
                handler: function () {
                    FileMgr.open(a)
                }
            }, {
                text: '另存为',
                indented: !1,
                handler: function () {
                    FileMgr.saveAs(a, d)
                }
            }, {
                text: '打开文件夹',
                indented: !1,
                handler: function () {
                    FileMgr.openFolder(a)
                }
            }, {
                text: '撤回',
                hidden: !0,
                indented: !1,
                handler: function () {
                    c.doRevoke(b)
                }
            }, {
                text: '转发',
                indented: !1,
                hidden: !0,
                handler: function () {
                    c.doTransmit(b)
                }
            }, {
                text: '回复',
                hidden: !0,
                handler: function () {
                    DesktopChatUtil.showReply(b)
                }
            }]
        });
        return e
    },
    getEmojiText: function (b) {
        var a = document.createElement('div');
        var c = Ext.fly(b);
        a.innerHTML = c.getHtml();
        Ext.fly(a).select('span.r-at').removeCls('highlight');
        Ext.fly(a).query('img.emoji').forEach(function (a) {
            Ext.DomHelper.insertBefore(a, a.getAttribute('alt'), !1);
            a.parentNode.removeChild(a)
        });
        a.innerHTML = a.innerHTML.replace(/[\u200B]/gm, '');
        return a.innerText
    },
    selectText: function (c) {
        if (document.body.createTextRange) {
            var a = document.body.createTextRange();
            a.moveToElementText(c);
            a.select()
        } else {
            if (window.getSelection) {
                var b = window.getSelection();
                var a = document.createRange();
                a.selectNodeContents(c);
                b.removeAllRanges();
                b.addRange(a)
            }
        }
    },
    cefCopyToClipboard: function (b, a) {
        if (Config.isPC) {
            DesktopChatUtil.getCefObj().setCopyData(b, a, function (c) {
                if (!c) {
                    Utils.toastShort('复制出错了')
                }
            })
        }
    },
    doRevoke: function (a) {
        var c = User.crtChannelId,
            b = a.get('msg_id');
        ChatUtil.doRevoke(c, [b], function () {
            if (a.get('msg_type') == MsgType.BigFileMsg) {
                if (Config.isPC) {
                    DesktopChatUtil.getCefObj().doBFileRevoke(JSON.stringify([{
                        msg_id: b,
                        file_id: a.get('file_id'),
                        is_mine: !0
                    }]))
                }
            }
            if (a.get('msg_type') == 'T') {
                User.RevokeText = a.data.sendText
            }
            var d = a.get('msg_type') == MsgType.TextMsg;
            var f = '撤销了一条消息,' + Ext.getStore(c).getById(b).data.senderID;
            var e = GroupNotice.getRevokeNotice(User.ownerID, f);
            if (d) {
                User.revokeMsgs[b] = a.get('sendText');
                if (Ext.getStore(c).getById(b).data.senderID != User.ownerID) {
                    d = !1;
                    delete User.revokeMsgs[b]
                }
                a.set({
                    showRevokeEdit: d,
                    msg_type: MsgType.Revoke,
                    senderID: User.ownerID,
                    senderName: User.userInfos[User.ownerID].user_name,
                    sendText: e
                });
                window.setTimeout(function () {
                    if (User.crtChannelId == c) {
                        var d = Ext.getStore(c).getById(b);
                        if (d) {
                            d.set({
                                showRevokeEdit: !1
                            })
                        }
                    }
                    delete User.revokeMsgs[b]
                }, 5 * 60 * 1000)
            } else {
                a.set({
                    msg_type: MsgType.Revoke
                })
            }
        })
    },
    doTransmit: function (a) {
        if (Config.isPC) {
            var b = 'SELECT * FROM IMRct ORDER BY IsTop DESC, LastPostAt DESC, UnreadCount DESC limit 50;';
            LocalDataMgr.cExecSqlWithP(b, [], function (i, g) {
                var e = g.rows;
                var f = [];
                for (var d = 0; d < e.length; d++) {
                    var b = e.item(d);
                    var c;
                    if (b.ChatType == ChatType.Multi || b.ChatType == 'C') {
                        c = b.ChatID
                    } else {
                        if (b.ChatType == ChatType.Direct) {
                            c = b.UserID
                        }
                    }
                    f.push({
                        transmit: !0,
                        chat_id: b.ChatID,
                        user_id: b.ChatID,
                        ava_id: c,
                        create_at: b.CreateAt,
                        chat_type: b.ChatType,
                        leaf: !0,
                        user_name: b.DisplayName,
                        iconCls: 'hide-icon'
                    })
                }
                var h = {
                    fromAdd: 'transmit',
                    rctData: f,
                    msgID: a.get('msg_id')
                };
                DesktopChatUtil.defaults4UserSelForm(h, {})
            })
        }
    },
    doUnread: function () {
        ChatUtil.setUnreadToRead('', User.crtChannelId)
    },
    doFloatedBtn: function (a) {
        this.doMsgUpBtn(a);
        AtUtil.showAtBtnInMsgView(a, this)
    },
    doMsgUpBtn: function (b) {
        if (User.crtChannelId != b) {
            return
        }
        var d = this;
        var c = Ext.getStore(b);
        var a = d.getViewModel();
        if (!c) {
            return
        }
        var f = ChatUtil.firstUnread[b];
        if (!f) {
            a.set('hideUpBtn', !0);
            return
        }
        var e = c.getById(f.msg_id);
        if (!e) {
            a.set('hideUpBtn', !1)
        } else {
            var g = c.indexOf(e),
                h = d.getItemAt(g);
            if (ChatUtil.msgInVisibleArea(h, d)) {
                a.set('hideUpBtn', !0);
                delete ChatUtil.firstUnread[b]
            } else {
                a.set('hideUpBtn', !1)
            }
        }
    },
    onTapUpBtn: function () {
        var c = this,
            d = c,
            f = d.getViewModel(),
            a = d.getStore();
        if (!a) {
            f.set('hideUpBtn', !0);
            return
        }
        var e = a.storeId;
        var b = ChatUtil.firstUnread[e];
        if (Ext.isEmpty(b) || Ext.isEmpty(b.msg_id)) {
            return
        }
        this.doScrolToMsg(b.msg_id, b.msg_seq, function (b) {
            var d = a.indexOf(b);
            c.doClearUpBtnCache(e);
            var f = a.insert(d, {
                auxiliaryNews: !0,
                updateTime: b.get('updateTime')
            });
            c.isCodeScrol = !0;
            c.ensureVisible(f[0], {
                align: {
                    y: 'start'
                }
            })
        })
    },
    doScrolToMsg: function (k, j, b) {
        var m = this,
            a = this.getStore();
        if (!a) {
            return
        }
        var l = a.storeId;
        var c = a.getById(k);
        if (c) {
            if (b) {
                b(c)
            }
        } else {
            var f = 0;
            for (var d = 0; d < a.data.items.length; d++) {
                if (a.getAt(d).get('msgSeq') && a.getAt(d).get('msgSeq') >= 10000) {
                    f = a.getAt(d).get('msgSeq');
                    break
                }
            }
            if (f >= 10000) {
                var e = j,
                    i = f - e,
                    h = [],
                    g;
                if (i > 20) {
                    h.push({
                        from_seq: e - 1,
                        to_seq: e + 19
                    });
                    g = function (d) {
                        a.removeAll();
                        c = a.add(d);
                        if (b) {
                            b(c[0])
                        }
                    }
                } else {
                    if (i > 0) {
                        h.push({
                            from_seq: e - 1,
                            to_seq: f - 1
                        });
                        g = function (d) {
                            c = a.insert(0, d);
                            if (b) {
                                b(c[0])
                            }
                        }
                    }
                }
                m.getSliHis(l, h, g)
            }
        }
    },
    doClearUpBtnCache: function (a) {
        if (a != User.crtChannelId) {
            return
        }
        var b = this.getViewModel();
        b.set('hideUpBtn', !0);
        delete ChatUtil.firstUnread[a]
    },
    onTapShowMsg: function () {
        var a = this,
            b = a.getStore(),
            e = b.storeId;
        User.isMsgRemoveAll = !0;
        b.removeAll();
        var c = a.getViewModel(),
            d = c.get('hideMoreMsg');
        if (!d) {
            c.set({
                hideMoreMsg: !0,
                msgNum: 0
            })
        }
        ChatUtil.handleFirstIn(b, e, a)
    },
    onTapAtBtnUseDB: function () {
        var a = this,
            b = User.crtChannelId;
        if (!b) {
            return
        }
        LocalDataMgr.getMentions(b, function (t, q) {
            var o = q.rows,
                j = o.length;
            if (j > 0) {
                var i = o.item(0);
                AtUtil.removeOneMentionUseDB(i.ChatID, i.MsgID);
                if (User.crtChannelId == b) {
                    var c = a.getStore(),
                        l = c.getById(i.MsgID),
                        m, n, f;
                    if (l) {
                        m = c.indexOf(l);
                        n = a.getItemAt(m);
                        a.doScrollByUpBtn(n, a)
                    } else {
                        var h = 0;
                        for (var k = 0; k < c.data.items.length; k++) {
                            f = c.getAt(k).get('msgSeq');
                            if (f && f >= 10000) {
                                h = f;
                                break
                            }
                        }
                        if (h >= 10000) {
                            var d = i.MsgSeq,
                                p = h - d,
                                g = [],
                                e;
                            if (p > 20) {
                                g.push({
                                    from_seq: d - 1,
                                    to_seq: d + 19
                                });
                                e = function (b) {
                                    c.removeAll();
                                    c.add(b);
                                    a.isCodeScrol = !0;
                                    a.getScrollable().scrollTo(0, 1)
                                };
                                a.getSliHis(b, g, e)
                            } else {
                                if (p > 0) {
                                    g.push({
                                        from_seq: d - 1,
                                        to_seq: h - 1
                                    });
                                    e = function (b) {
                                        c.insert(0, b);
                                        a.isCodeScrol = !0;
                                        a.getScrollable().scrollTo(0, 1)
                                    };
                                    a.getSliHis(b, g, e)
                                }
                            }
                        }
                    }
                    var r = a.getViewModel(),
                        s = j - 1;
                    r.set({
                        hideAtBtn: !1,
                        atCount: s
                    })
                }
                if (j - 1 <= 0) {
                    AtUtil.doPageClearMention(b, a, !0)
                }
            } else {
                AtUtil.doPageClearMention(b, a, !0)
            }
        })
    },
    doScrollByUpBtn: function (d, a) {
        a.isCodeScrol = !0;
        var b = a.getScrollable(),
            c = b.getScrollElement().dom.scrollTop + d.el.getTop() - a.el.getTop();
        b.scrollTo(0, c)
    },
    onClearAtBtnUseDB: function () {
        AtUtil.clearMentionsUseDB(User.crtChannelId, this)
    },
    doScrolEvent: function (e) {
        var a = e.getScrollElement().dom,
            d = a.scrollHeight,
            b = a.scrollTop,
            c = a.offsetHeight;
        if (d <= Math.ceil(b + c)) {
            this.hideUnread();
            this.searchMsgWhereToEnd()
        } else {
            this.showUnread(b)
        }
        if (!this.abortViewAPI) {
            this.doUpBtnHide()
        }
    },
    hideUnread: function () {
        if (this.abortViewAPI) {
            return
        }
        var d = User.crtChannelId;
        var c = this.getStore();
        if (!c) {
            this.doHideUnread(d);
            return
        }
        var g = c.getCount(),
            a, b;
        for (var e = g - 1; e > -1; e--) {
            a = c.getAt(e);
            if (a.get('msgSeq') && a.get('msgSeq') >= 10000) {
                b = a;
                break
            }
        }
        if (!b) {
            return
        }
        var f = b.get('updateTime');
        if (!f) {
            return
        }
        var i = this;
        var h = 'SELECT * FROM IMMsg WHERE CreateAt > ? AND ChatID=?;';
        LocalDataMgr.cExecSqlWithP(h, [f, d], function (e, a) {
            var b = a.rows,
                c = b.length;
            if (c > 0) {
                return
            }
            i.doHideUnread(d)
        })
    },
    doHideUnread: function (b) {
        var a = this.getViewModel(),
            c = a.get('hideMoreMsg');
        if (!c) {
            a.set({
                hideMoreMsg: !0,
                msgNum: 0
            })
        }
        LocalDataMgr.beforeDoRct(b, function (d, c) {
            var a = c.UnreadCount;
            if (a > 0) {
                ChatUtil.setUnreadToRead('', b)
            }
        })
    },
    doUpBtnHide: function () {
        var d = User.crtChannelId,
            e = ChatUtil.firstUnread[d],
            f = this.getViewModel();
        if (Ext.isEmpty(e)) {
            f.set('hideUpBtn', !0);
            return
        }
        var b = this.getStore();
        var a = b.getById(e.msg_id);
        if (a) {
            var c = b.indexOf(a),
                g = this.getItemAt(c);
            if (ChatUtil.msgInVisibleArea(g, this)) {
                b.insert(c, {
                    auxiliaryNews: !0,
                    updateTime: a.get('updateTime')
                });
                this.doClearUpBtnCache(d)
            }
        }
    },
    onsetoneHistory: function (a) {
        var c = Ext.getStore('rgList').data.items;
        var d = !1;
        for (var b = 0; b < c.length; b++) {
            if (c[b].data.user_id == a) {
                d = !0;
                break
            }
        }
        if (d) {
            var e = Ext.Viewport.down('desktopChat_group').getChgHisDialog(a);
            Ext.Viewport.down('list').uid = a;
            e.down('#userSelDialog_radio_now').setChecked(!0);
            e.show();
            Ext.Viewport.down('list').origin = 'Y';
            Ext.Viewport.down('list').time = 0
        } else {
            Utils.toastShort('该用户已不在会话中')
        }
    },
    onSeeHistory: function (f, e) {
        var b = Ext.getStore('rgList').data.items;
        var c = !1;
        for (var a = 0; a < b.length; a++) {
            if (b[a].data.user_id == User.ownerID) {
                c = !0;
                break
            }
        }
        if (c) {
            this.mouseOverItem.getRecord().data.showGrpSeeMore = !1;
            var d = this.mouseOverItem.getRecord().data.msg_id;
            Utils.custAjax('post', 'chats/' + User.crtChannelId + '/seehistory', {
                params: JSON.stringify({
                    chat_id: User.crtChannelId,
                    user_ids: [User.ownerID]
                }),
                success: function (a) {
                    var b;
                    b = '您已经申请了查看更多历史消息';
                    LocalDataMgr.getDB().transaction(function (b) {});
                    var i = 'INSERT INTO IMMsg (MsgID, ChatID, MsgType, Content, CreateAt, Status, MsgSeq) VALUES (?,?,?,?,?,?,?);';
                    LocalDataMgr.cExecSqlWithP(i, [a.msg_id, a.chat_id, MsgType.GroupNotice, b, a.update_at, '0', a.msg_seq], function (c, b) {});
                    var j = 'UPDATE IMRct SET LastMessage=?,LastMsgType=?,LastPostAt=? WHERE ChatID=?;';
                    LocalDataMgr.cExecSqlWithP(j, [b, MsgType.GroupNotice, a.update_at, a.chat_id], function (c, b) {});
                    var h = 'UPDATE IMMsg SET Status=? WHERE MsgID=?;';
                    LocalDataMgr.cExecSqlWithP(h, ['0', d], function (c, b) {});
                    if (!window.cefMsgMgr) {
                        var c = Ext.getStore('comRct').getById(a.chat_id);
                        if (c) {
                            c.set({
                                last_post_at: new Date(a.update_at),
                                last_msg_type: 'H',
                                last_post_name: ''
                            })
                        }
                    }
                    if (User.crtChannelId == a.chat_id) {
                        var g = Ext.getStore(a.chat_id);
                        if (g) {
                            g.add({
                                msg_id: a.msg_id,
                                msgSeq: a.msg_seq,
                                updateTime: a.update_at,
                                GrpChangeMsg: b,
                                showGrpChange: !0,
                                showGrpSeeMore: !1
                            })
                        }
                    }
                    AddDataUtil.onScrolMsgView()
                },
                failure: function (a) {
                    console.log('温馨提示', '申请查看更多历史消息失败')
                }
            })
        } else {
            Utils.toastShort('你已不在此会话中')
        }
    }
}, 0, ['desktopChat_list'], ['widget', 'component', 'container', 'componentdataview', 'list', 'msgView', 'desktopChat_list'], {
    'widget': !0,
    'component': !0,
    'container': !0,
    'componentdataview': !0,
    'list': !0,
    'msgView': !0,
    'desktopChat_list': !0
}, ['widget.desktopChat_list'], 0, [IMCommon.view.desktop.list, 'DesktopChatList'], 0);
Ext.cmd.derive('IMCommon.view.desktop.input.DesktopChatInput', Ext.Container, {
    defaultListenerScope: !0,
    layout: {
        type: 'vbox'
    },
    items: [{
        xtype: 'container',
        minHeight: 36,
        padding: '0 8px',
        layout: {
            type: 'hbox',
            align: 'center'
        },
        defaults: {
            xtype: 'button',
            ui: 'flat'
        },
        items: [{
            iconCls: 'im-common-emoji',
            handler: 'showEmjPanel'
        }, {
            iconCls: 'im-common-shortcut',
            handler: 'onCut',
            userCls: 'bgf_folder'
        }, {
            userCls: 'bgf_down',
            menu: [{
                handler: 'onCutHideForm',
                text: '隐藏窗口截图',
                indented: !1
            }]
        }, {
            itemId: 'btnBrowse',
            iconCls: 'im-common-image',
            handler: 'onSelPic'
        }, {
            itemId: 'btnFile',
            iconCls: 'im-common-file',
            handler: 'onSelFile',
            userCls: 'bgf_folder'
        }, {
            userCls: 'bgf_down',
            menu: [{
                handler: 'onSelBigFile',
                text: '发送大文件',
                indented: !1
            }, {
                handler: 'onOpenBFileForm',
                text: '打开大文件列表',
                indented: !1
            }]
        }, {
            iconCls: 'im-common-link',
            handler: 'handleERPLink'
        }, {
            xtype: 'component',
            flex: 1
        }, {
            itemId: 'chatInput_mrd_btn',
            text: '消息记录',
            handler: 'onShowMsgRecord'
        }]
    }, {
        xtype: 'container',
        flex: 1,
        layout: 'fit',
        scrollable: 'y',
        items: [{
            xtype: 'imCommonEditor',
            userCls: 'rich-editor-Ct',
            itemId: 'richEditor'
        }]
    }],
    initialize: function () {
        var a = this;
        Ext.Container.prototype.initialize.apply(this, arguments);
        a.down('#richEditor').element.on({
            contextmenu: 'onRightClickEditor',
            scope: a
        })
    },
    onRightClickEditor: function (f) {
        var g = Utils.getApp().getCefObj();
        if (g) {
            var c = this,
                d = c.down('#richEditor'),
                b = c.getSelectedContents();
            var a = '',
                e = !0;
            if (b) {
                a = ParseUtil.htmlToText(b);
                e = !1
            }
            var h = Ext.create('IMCommon.view.menu.HideDestroyMenu', {
                width: 100,
                heigth: '100%',
                items: [{
                    text: '复制',
                    disabled: e,
                    indented: !1,
                    handler: function () {
                        DesktopChatUtil.setCopyPTData(a, b, function (a) {
                            if (!a) {
                                Utils.toastShort('复制出错了')
                            } else {
                                d.focusEnd()
                            }
                        })
                    }
                }, {
                    text: '剪切',
                    disabled: e,
                    indented: !1,
                    handler: function () {
                        a = ParseUtil.getTextByPT(a);
                        DesktopChatUtil.setCopyPTData(a, b, function (a) {
                            if (!a) {
                                Utils.toastShort('复制出错了')
                            } else {
                                c.cutText();
                                d.focusEnd()
                            }
                        })
                    }
                }, {
                    text: '全选',
                    indented: !1,
                    handler: function () {
                        c.selectText()
                    }
                }, {
                    text: '粘贴',
                    indented: !1,
                    handler: function () {
                        d.doCefPaste()
                    }
                }]
            });
            ParseUtil.menuShowAtVisible(h, f.getPoint());
            f.preventDefault()
        }
    },
    cutText: function () {
        var a = this.down('#richEditor').inputElement.dom;
        var b = a.innerHTML;
        var c = this.getSelectedContents();
        var d = b.replace(c, '');
        a.innerHTML = d
    },
    getSelectedContents: function () {
        if (window.getSelection) {
            var b = window.getSelection().getRangeAt(0);
            var a = document.createElement('div');
            a.appendChild(b.cloneContents());
            return a.innerHTML
        } else {
            if (document.getSelection) {
                var b = window.getSelection().getRangeAt(0);
                var a = document.createElement('div');
                a.appendChild(b.cloneContents());
                return a.innerHTML
            } else {
                if (document.selection) {
                    return document.selection.createRange().htmlText
                }
            }
        }
    },
    selectText: function () {
        var c = this.down('#richEditor').inputElement.dom;
        if (document.body.createTextRange) {
            var a = document.body.createTextRange();
            a.moveToElementText(c);
            a.select()
        } else {
            if (window.getSelection) {
                var b = window.getSelection();
                var a = document.createRange();
                a.selectNodeContents(c);
                b.removeAllRanges();
                b.addRange(a)
            }
        }
    },
    getSubmitValue: function (b) {
        var a = document.createElement('div');
        a.innerHTML = b;
        Ext.fly(a).select('span.r-at').removeCls('highlight');
        Ext.fly(a).query('img.emoji').forEach(function (a) {
            Ext.DomHelper.insertBefore(a, a.getAttribute('alt'), !1);
            a.parentNode.removeChild(a)
        });
        return a.innerHTML.replace(/[\u200B]/gm, '')
    },
    handleERPLink: function () {
        Ext.Msg.prompt('单据链接', '', function (b, a) {
            if (b === 'ok') {
                SendUtil.sendErpLink(a, User.crtChannelId)
            }
        })
    },
    onCut: function () {
        DesktopChatUtil.capture()
    },
    onCutHideForm: function () {
        DesktopChatUtil.captureNoWindow()
    },
    onSelPic: function () {
        var b = this;
        var a = b.down('#richEditor');
        ImgMgr.chooseImages().then(function (e) {
            var b = e.images;
            var f = b.length;
            if (f <= ConfigMgr.oneSendMaxFileNum) {
                var d = '';
                for (var c = 0; c < b.length; c++) {
                    var g = ParseUtil.getLocalFileURL(b[c].path);
                    d += '<img _width="' + b[c].width + '" _height="' + b[c].height + '" class="ect-img" src="' + g + '" data-url="' + b[c].path + '">&#8203;'
                }
                a.inputElement.dom.focus();
                if (document.queryCommandSupported('insertHTML')) {
                    document.execCommand('insertHTML', !1, d)
                } else {
                    document.execCommand('paste', !1, d)
                }
            } else {
                Utils.toastShort('对不起，您图片的文件过多，请选择少于' + ConfigMgr.oneSendMaxFileNum + '个图片进行发送')
            }
        })
    },
    _insertimg: function (f, e) {
        var c = window.getSelection ? window.getSelection() : document.selection;
        var b = c.createRange ? c.createRange() : c.getRangeAt(0);
        if (!window.getSelection) {
            e.inputElement.dom.focus();
            b.pasteHTML(f);
            b.collapse(!1);
            b.select()
        } else {
            e.inputElement.dom.focus();
            b.collapse(!1);
            var d = b.createContextualFragment(f);
            var a = d.lastChild;
            while (a && a.nodeName.toLowerCase() == 'br' && a.previousSibling && a.previousSibling.nodeName.toLowerCase() == 'br') {
                var g = a;
                a = a.previousSibling;
                d.removeChild(g)
            }
            b.insertNode(d);
            if (a) {
                b.setEndAfter(a);
                b.setStartAfter(a)
            }
            c.removeAllRanges();
            c.addRange(b)
        }
    },
    onSelFile: function () {
        FileMgr.chooseFiles().then(function (c) {
            var a = JSON.parse(c);
            var b = a.length;
            if (b <= ConfigMgr.oneSendMaxFileNum) {
                SendUtil.sendFileMsgsByOneAPI(a)
            } else {
                Utils.toastShort('对不起，您选择的文件过多，请选择少于' + ConfigMgr.oneSendMaxFileNum + '个文件进行发送')
            }
        })
    },
    onSelBigFile: function () {
        if (DesktopChatUtil.supportBigFile()) {
            FileMgr.chooseFiles().then(function (b) {
                var a = JSON.parse(b);
                SendUtil.sendBigFileMsgsByOneAPI(User.crtChannelId, a)
            })
        } else {
            Utils.toastShort('对不起，暂不支持大文件发送')
        }
    },
    onOpenBFileForm: function () {
        DesktopChatUtil.openBFileForm()
    },
    showEmjPanel: function (b) {
        var a = Ext.getCmp('global-emojipanel');
        if (!a) {
            a = Ext.widget('emojipanel', {
                id: 'global-emojipanel'
            })
        }
        a.on({
            ok: 'onChooseEmj',
            hide: 'onHideEmjPanel',
            scope: this
        });
        a.showBy(b, 'tl-bl?')
    },
    onChooseEmj: function (c, a) {
        var b = window.minEmoji(a);
        if (b !== a) {
            this.down('#richEditor').insertObject(window.minEmoji(a), a)
        }
    },
    onHideEmjPanel: function (a) {
        a.un({
            ok: 'onChooseEmj',
            hide: 'onHideEmjPanel',
            scope: this
        })
    },
    onReply: function (a) {
        a.toggle(!0)
    },
    onShowMsgRecord: function (d) {
        var a = User.crtChannelId;
        if (!a) {
            return
        }
        var c = User.crtChannelType;
        if (!c) {
            return
        }
        var b = DtPageCache.rightPages[a];
        if (b) {
            if (b.xtype == 'desktopMrdTabpanel') {
                DesktopChatUtil.toggleHideRightView(a, c, b);
                d.setPressed(!1)
            } else {
                var f = Ext.widget('desktopMrdTabpanel', {
                    style: 'border-left:solid 1px #cfcfcf;'
                });
                DesktopChatUtil.showRightViewWoToggle(a, f, b);
                d.setPressed(!0)
            }
        } else {
            var e = Ext.widget('desktopMrdTabpanel', {
                style: 'border-left:solid 1px #cfcfcf;'
            });
            DesktopChatUtil.toggleShowRightView(a, c, e);
            d.setPressed(!0)
        }
    },
    hideFormToCut: function () {
        DesktopChatUtil.hideFormToCut()
    }
}, 0, ['desktopChat_input'], ['widget', 'component', 'container', 'desktopChat_input'], {
    'widget': !0,
    'component': !0,
    'container': !0,
    'desktopChat_input': !0
}, ['widget.desktopChat_input'], 0, [IMCommon.view.desktop.input, 'DesktopChatInput'], 0);
Ext.cmd.derive('IMCommon.plugin.DraggableHandler', Ext.Base, {
    init: function (a) {
        var b = this;
        a.element.setStyle({
            '-webkit-app-region': 'drag'
        });
        a.element.on({
            doubletap: 'onDoubleTap',
            scope: b
        })
    },
    onDoubleTap: function () {
        var a = Utils.getApp().getCefObj();
        if (a) {
            a.max()
        }
    }
}, 0, 0, 0, 0, ['plugin.draggablehandler'], 0, [IMCommon.plugin, 'DraggableHandler'], 0);
Ext.cmd.derive('IMCommon.view.desktop.DesktopChatView', Ext.Container, {
    controller: 'desktopchatviewcontroller',
    cls: 'desktop_chatview',
    layout: 'vbox',
    viewModel: {
        data: {
            ditStu: '',
            ditInCom: '',
            displayname: ''
        }
    },
    items: [{
        xtype: 'container',
        layout: 'hbox',
        userCls: 'right-title',
        items: [{
            xtype: 'textfield',
            reference: 'desktopTTitle',
            userCls: 'rightTitle',
            flex: 1,
            itemId: 'btnEdit',
            hidden: !0,
            bind: {
                value: '{displayname}'
            },
            listeners: {
                blur: 'onTextBlur'
            }
        }, {
            xtype: 'component',
            itemId: 'directChatHeader',
            reference: 'desktopCTitle',
            flex: 1,
            bind: {
                html: '<div class="ditChatHeaderText"><span class="dittext" onclick="DesktopChatUtil.ditChatHeaderShowPD();">{displayname}</span><span class="{ditStu}"></span><span class="ditInCom">{ditInCom}</span></div>'
            }
        }, {
            xtype: 'button',
            iconCls: 'im-common-adduser',
            ui: 'flat',
            handler: 'onShowGrpSel',
            itemId: 'addMemsButton'
        }, {
            xtype: 'button',
            ui: 'flat',
            iconCls: 'im-common-setting',
            handler: 'onsetCrowd',
            itemId: 'setCrowd'
        }]
    }, {
        xtype: 'container',
        reference: 'desktopChatMainContainer',
        flex: 1,
        layout: 'hbox',
        items: [{
            xtype: 'panel',
            id: 'im-main-minWidth-view',
            flex: 1,
            layout: 'vbox',
            items: [{
                xtype: 'desktopChat_list',
                reference: 'desktopChatList',
                userCls: 'im_chatView',
                flex: 1,
                style: {
                    borderBottom: '1px solid #d6d6d6'
                }
            }, {
                xtype: 'panel',
                resizable: {
                    edges: 'n'
                },
                minHeight: 120,
                maxHeight: '70%',
                height: 180,
                layout: 'vbox',
                items: [{
                    xtype: 'desktopChat_input',
                    userCls: 'editor-Ct',
                    flex: 1
                }, {
                    xtype: 'container',
                    userCls: 'bottomSend',
                    layout: 'hbox',
                    items: [{
                        xtype: 'component',
                        plugins: 'draggablehandler',
                        flex: 1
                    }, {
                        xtype: 'button',
                        text: '发送(<span class="sUnderline">S</span>)',
                        ui: 'send-ui',
                        width: 66,
                        height: 24,
                        handler: 'onSend'
                    }]
                }]
            }]
        }, {
            xtype: 'desktopChat_group',
            reference: 'desktopChatGrp',
            style: {
                borderLeft: 'solid 1px #cfcfcf'
            },
            hidden: !0,
            minWidth: 120
        }]
    }]
}, 0, ['desktopChatView'], ['widget', 'component', 'container', 'desktopChatView'], {
    'widget': !0,
    'component': !0,
    'container': !0,
    'desktopChatView': !0
}, ['widget.desktopChatView'], 0, [IMCommon.view.desktop, 'DesktopChatView'], 0);
Ext.cmd.derive('IMCommon.view.desktop.msgMrd.DesktopMrdTabpanelController', Ext.app.ViewController, {
    init: function () {
        var a = this.getView();
        this.onSearchMsg(a);
        this.onSearchPic(a);
        this.onSearchFile(a);
        this.onSearchReply(a)
    },
    onSearchMsg: function (b) {
        var a = b.down('#msgMrd_all').down('#msgMrd_list_all');
        var c = Ext.getStore('msgMrdListAll');
        LocalDataMgr.getHistoryWoNotShow(function (j, i) {
            var e = i.rows,
                f = e.length;
            if (f > 0) {
                var h = [];
                for (var d = f - 1; d >= 0; d--) {
                    var g = e.item(d);
                    if (d == f - 1) {
                        g.showDate = !0
                    } else {
                        g.showDate = !ParseUtil.inOneDay(g.CreateAt, e.item(d + 1).CreateAt)
                    }
                    h.push(e.item(d))
                }
                c.add(h);
                AddDataUtil.onScroll(a)
            } else {
                ParseUtil.doEmptyText(a)
            }
        }, 0, User.crtChannelId)
    },
    onSearchPic: function (b) {
        var a = User.crtChannelId;
        LocalSearchMgr.searchLastPic(a, function (h, g) {
            var f = b.down('#msgPicTab').getStore();
            var a = g.rows;
            if (a.length > 0) {
                var e = [],
                    d;
                for (var c = 0; c < a.length; c++) {
                    d = a.item(c);
                    if (d.FileStatus == '1') {
                        continue
                    }
                    e.push(d)
                }
                f.add(e)
            }
        })
    },
    onSearchFile: function (a) {
        LocalSearchMgr.searchLastFile(User.crtChannelId, function (h, g) {
            var f = a.down('#msgFileTab').getStore();
            var b = g.rows;
            if (b.length > 0) {
                var e = [],
                    d;
                for (var c = 0; c < b.length; c++) {
                    d = b.item(c);
                    if (d.FileStatus == '1') {
                        continue
                    }
                    e.push(d)
                }
                f.add(e)
            }
        })
    },
    onSearchReply: function (b) {
        var a = User.crtChannelId;
        LocalSearchMgr.searchLastReplyByCid(a, function (j, i) {
            if (a !== User.crtChannelId) {
                return
            }
            var f = b.down('#msgReplyTab'),
                h = f.getStore();
            var c = i.rows;
            if (c.length > 0) {
                var e = [],
                    g;
                for (var d = 0; d < c.length; d++) {
                    g = c.item(d);
                    e.push(g)
                }
                h.add(e)
            }
            ParseUtil.doEmptyText(f)
        })
    }
}, 0, 0, 0, 0, ['controller.desktopmrdtabpanelcontroller'], 0, [IMCommon.view.desktop.msgMrd, 'DesktopMrdTabpanelController'], 0);
Ext.cmd.derive('IMCommon.view.search.SearchField', MX.field.RichTextArea, {
    cls: 'imcommon_search_field',
    userCls: 'focus-clearable',
    height: 30,
    style: '-webkit-user-select:auto;',
    placeholder: '搜索',
    triggers: {
        search: {
            type: 'search',
            side: 'left'
        },
        clear: {
            handler: function () {
                var a = this.getSearchConditions();
                if (Object.keys(a).length !== 0) {
                    a = {};
                    this.doUIRenderBySearch(a)
                }
                this.clearValue();
                var b = this.getSearchView();
                if (!b) {
                    return
                }
                if (!b.getHidden()) {
                    b.hide()
                }
            }
        }
    },
    scrollable: {
        x: !0,
        y: !1
    },
    config: {
        searchDelay: 500,
        searchVal: {
            lazy: !0,
            $value: ''
        },
        searchView: {
            lazy: !0,
            $value: !0
        },
        supportChinese: !0,
        defaultSearchType: !1
    },
    initialize: function () {
        var a = this;
        MX.field.RichTextArea.prototype.initialize.apply(this, arguments);
        a.on({
            change: 'onValChg',
            scope: a
        })
    },
    onValChg: function (a, b, d, e) {
        var c = setTimeout(function () {
            if (a.cpLock) {
                return
            }
            if (a.unlockValue != b) {
                a.doChgSearch()
            }
            clearTimeout(c)
        }, 0)
    },
    doChgSearch: function () {
        var a = this;
        if (!a.getSearchView()) {
            return
        }
        a.doAdvancedPValue();
        a.doExtraAdvancedPValue()
    },
    updateSupportChinese: function (e) {
        var a = this,
            b = a.inputElement.dom,
            d = function () {
                a.cpLock = !0;
                a.lockValue = a.getValue()
            },
            c = function () {
                a.cpLock = !1;
                var b = a.getValue();
                a.unlockValue = b;
                if (b != a.lockValue) {
                    a.doChgSearch()
                }
            };
        if (e) {
            b.addEventListener('compositionstart', d);
            b.addEventListener('compositionend', c)
        } else {
            b.removeEventListener('compositionstart', d);
            b.removeEventListener('compositionend', c)
        }
    },
    applySearchView: function (a, b) {
        if (a) {
            if (a === !0) {
                a = {}
            }
            Ext.applyIf(a, {
                userCls: 'imcommon_search_field_asp',
                store: {
                    data: [{
                        type: SearchType.MsgRecord,
                        val: ''
                    }]
                },
                itemTpl: ['<tpl if="values.type == \'mr\'">', '<div><span class="imcommon_search_field_asp_span">聊天记录：</span>{val}</div>', '<tpl elseif="values.type == \'gn\'">', '<div><span class="imcommon_search_field_asp_span">会话：</span>{val}</div>', '<tpl elseif="values.type == \'sn\'">', '<div><span class="imcommon_search_field_asp_span">发送人：</span>{val}</div>', '<tpl elseif="values.type == \'fn\'">', '<div><span class="imcommon_search_field_asp_span">文件名：</span>{val}</div>', '<tpl elseif="values.type == \'time\'">', '<div><span class="imcommon_search_field_asp_span">时间：</span>{val}</div>', '</tpl>'].join(''),
                width: 300,
                ownerCmp: this,
                ownerField: this,
                loadingHeight: 70,
                floated: !0,
                axisLock: !0,
                hideAnimation: null,
                hidden: !0
            })
        }
        return Ext.factory(a, 'Ext.dataview.DataView', b)
    },
    updateSearchView: function (a) {
        if (a) {
            a.on({
                show: 'onShowSP',
                hide: 'onHideSP',
                childTap: 'onChildTapSP',
                scope: this
            })
        }
    },
    onShowSP: function () {
        var a = this;
        a.showAcp = !0;
        a.touchListeners = Ext.getDoc().on({
            translate: !1,
            touchstart: 'collapseIf',
            scope: a,
            delegated: !1,
            destroyable: !0
        });
        a.hideEventListeners = Ext.on({
            mousedown: 'collapseIf',
            scope: a,
            destroyable: !0
        })
    },
    collapseIf: function (b) {
        var a = this;
        if (!a.destroyed && (!b.within(a.bodyElement, !1, !0) && !a.owns(b.target))) {
            a.collapse()
        }
    },
    collapse: function () {
        if (this.aspNotHide) {
            this.aspNotHide = !1;
            return
        }
        var a = this.getSearchView();
        if (a) {
            a.hide()
        }
    },
    onHideSP: function () {
        var a = this;
        a.showAcp = !1;
        Ext.destroy(a.hideEventListeners, a.touchListeners)
    },
    onChildTapSP: function (f, c) {
        var a = c.record;
        if (!a) {
            return
        }
        var e = this,
            d = a.get('type'),
            b = a.get('val');
        e.doInsertSearchObj(d, b, b)
    },
    updateSearchVal: function (c) {
        var a = this.getSearchView();
        if (!a) {
            return
        }
        if (Ext.isEmpty(c)) {
            a.hide()
        } else {
            this.aspNotHide = !0;
            var d = a.getStore(),
                e = d.getData().length;
            for (var b = 0; b < e; b++) {
                d.getAt(b).set({
                    val: c
                })
            }
            a.showBy(this, 'tl-bl')
        }
    },
    onMouseUp: function (a) {
        this.aspNotHide = !0;
        MX.field.RichTextArea.prototype.onMouseUp.apply(this, arguments)
    },
    onKeyDown: function (a) {
        var b = a.which();
        if (b == Ext.event.Event.ENTER) {
            a.preventDefault();
            return
        }
        MX.field.RichTextArea.prototype.onKeyDown.apply(this, arguments)
    },
    onKeyUp: function (b) {
        if (this.cpLock) {
            return
        }
        var a = this,
            c = b.which();
        if (c == Ext.event.Event.ENTER) {
            a.doEnterAddObj();
            b.preventDefault();
            return
        }
        MX.field.RichTextArea.prototype.onKeyUp.apply(this, arguments);
        if (!a.getSearchView()) {
            return
        }
        switch (c) {
            case Ext.event.Event.UP:
                a.doAdvancedPanelUp();
                break;
            case Ext.event.Event.DOWN:
                a.doAdvancedPanelDown();
                break;
            default:
                break;
        }
    },
    deleteObject: function (a) {
        MX.field.RichTextArea.prototype.deleteObject.apply(this, arguments);
        this.doSearch()
    },
    doDeleteObject: function (d) {
        var c = document.getSelection(),
            b = d.parentNode,
            a = this._getObjectRange(d);
        a.deleteContents();
        a.collapse(!0);
        c.removeAllRanges();
        c.addRange(a);
        if (b !== this.inputElement.dom && b.childNodes.length == 0) {
            a.setStartBefore(b);
            a.setEndAfter(b);
            a.deleteContents();
            a.collapse(!0);
            c.removeAllRanges();
            c.addRange(a)
        }
        this._saveRange();
        this._value = this.inputElement.dom.value = this.inputElement.getHtml();
        return
    },
    doEnterAddObj: function () {
        var b = this.getSearchView();
        if (!b) {
            return
        }
        if (b.getHidden()) {
            this.doSearch()
        }
        var c = b.getStore(),
            a = b.getSelection();
        if (a) {
            this.doInsertSearchObj(a.get('type'), a.get('val'), a.get('val'))
        } else {
            var d = this.getDefaultSearchType();
            if (d) {
                a = c.findRecord('type', d, 0, !1, !0, !0);
                if (!a) {
                    a = c.getAt(0)
                }
            } else {
                a = c.getAt(0)
            }
            this.doInsertSearchObj(a.get('type'), a.get('val'), a.get('val'))
        }
    },
    doAdvancedPValue: function () {
        var a = this.getObjVal();
        this.setSearchVal(a)
    },
    doExtraAdvancedPValue: function () {},
    getObjVal: function () {
        var a = document.createElement('div');
        a.innerHTML = this.inputElement.getHtml();
        Ext.fly(a).query('.search').forEach(function (a) {
            a.parentNode.removeChild(a)
        });
        var b = a.innerText.replace(/[\u200B]/gm, '').trim();
        return b
    },
    deleteSearchVal: function () {
        var b = '',
            a = document.createElement('div');
        a.innerHTML = this.inputElement.getHtml();
        Ext.fly(a).query('.search').forEach(function (a) {
            b += '&#8203;' + a.outerHTML.replace(/[\u200B]/gm, '') + '&#8203;&nbsp;'
        });
        this.setValue(b);
        this.focusEnd()
    },
    getSearchConditions: function () {
        var a = {},
            b = document.createElement('div');
        b.innerHTML = this.inputElement.getHtml();
        var c, d;
        Ext.fly(b).query('.search').forEach(function (b) {
            c = b.getAttribute('type');
            d = b.getAttribute('data-value');
            a[c] = d
        });
        return a
    },
    doAdvancedPanelUp: function () {
        var b = this.getSearchView();
        if (!b) {
            return
        }
        var c = b.getStore(),
            e = b.getSelection(),
            a;
        if (e) {
            var d = c.indexOf(e);
            if (d == 0) {
                a = c.last()
            } else {
                a = c.getAt(d - 1)
            }
            b.setSelection(a)
        } else {
            a = c.last();
            b.setSelection(a)
        }
    },
    doAdvancedPanelDown: function () {
        var c = this.getSearchView();
        if (!c) {
            return
        }
        var b = c.getStore(),
            e = c.getSelection(),
            a;
        if (e) {
            var d = b.indexOf(e);
            if (d >= b.getData().length - 1) {
                a = b.getAt(0)
            } else {
                a = b.getAt(d + 1)
            }
            c.setSelection(a)
        } else {
            a = b.getAt(0);
            c.setSelection(a)
        }
    },
    doInsertSearchObj: function (c, f, d) {
        var a = this,
            e = a.getSpanSearchStr(c, f);
        Ext.fly(a.inputElement.dom).query('.search').forEach(function (b) {
            if (c == b.getAttribute('type')) {
                a.doDeleteObject(b)
            }
        });
        a.insertObject(e, d);
        a.deleteSearchVal();
        var b = a.getSearchView();
        if (b) {
            if (!b.getHidden()) {
                b.hide()
            }
        }
        a.doSearch()
    },
    getSpanSearchStr: function (c, b) {
        var a = '';
        switch (c) {
            case SearchType.MsgRecord:
                a = '<span class="search search_mr" type="mr">聊天记录：' + b + '</span>';
                break;
            case SearchType.SendName:
                a = '<span class="search search_sn" type="sn">发送人：' + b + '</span>';
                break;
            case SearchType.GroupName:
                a = '<span class="search search_gn" type="gn">群名：' + b + '</span>';
                break;
            case SearchType.FileName:
                a = '<span class="search search_fn" type="fn">文件：' + b + '</span>';
                break;
            case SearchType.Time:
                a = '<span class="search search_time" type="time">时间：' + b + '</span>';
                break;
            default:
                break;
        }
        return a
    },
    doSearch: function () {
        var a = this,
            b = a.getSearchConditions();
        setTimeout(function () {
            var c = a.getSearchConditions();
            if (a.isSameConditions(b, c)) {
                a.doUIRenderBySearch(b)
            }
        }, a.getSearchDelay())
    },
    isSameConditions: function (a, c) {
        for (var b in a) {
            if (a[b] != c[b]) {
                return !1
            }
        }
        return !0
    },
    doUIRenderBySearch: function (a) {},
    isShowMsg: function (a) {
        if (a == 'mr') {
            return !0
        }
        return !1
    },
    clear: function () {
        MX.field.RichTextArea.prototype.clear.apply(this, arguments);
        this.doUIRenderBySearch({})
    }
}, 0, ['richSearchfield'], ['widget', 'component', 'field', 'inputfield', 'textfield', 'richtextareafield', 'richSearchfield'], {
    'widget': !0,
    'component': !0,
    'field': !0,
    'inputfield': !0,
    'textfield': !0,
    'richtextareafield': !0,
    'richSearchfield': !0
}, ['widget.richSearchfield'], 0, [IMCommon.view.search, 'SearchField'], 0);
Ext.cmd.derive('IMCommon.view.desktop.msgMrd.tab.AllController', Ext.app.ViewController, {
    init: function () {
        var a = this;
        Ext.app.ViewController.prototype.init.apply(this, arguments);
        var b = this.lookup('msgmrd_richSearchfield');
        b.doUIRenderBySearch = function (b) {
            if (Object.keys(b).length == 0) {
                a.showAllList();
                return
            }
            a.showAllAdvList(b)
        }
    },
    showAllList: function () {
        var c = this.getView(),
            a = c.lookup('msgmrd_list_all'),
            b = c.lookup('msgmrd_listAdv_all');
        if (!a) {
            return
        }
        if (b) {
            b.hide()
        }
        if (a.getHidden()) {
            a.show()
        }
    },
    onSelAllTime: function () {
        var a = this.getView().lookup('msgmrd_richSearchfield');
        a.doInsertSearchObj(SearchType.Time, '不限', 'all')
    },
    onSelOneMonth: function () {
        var a = this.getView().lookup('msgmrd_richSearchfield');
        a.doInsertSearchObj(SearchType.Time, '最近一个月', 'oneMonth')
    },
    onSelThreeMonth: function () {
        var a = this.getView().lookup('msgmrd_richSearchfield');
        a.doInsertSearchObj(SearchType.Time, '最近三个月', 'threeMonth')
    },
    onSelOneYear: function () {
        var a = this.getView().lookup('msgmrd_richSearchfield');
        a.doInsertSearchObj(SearchType.Time, '最近一年', 'oneYear')
    },
    showAllAdvList: function (b) {
        var j = this,
            e = j.getView(),
            i = e.lookup('msgmrd_list_all'),
            a = e.lookup('msgmrd_listAdv_all'),
            d = User.crtChannelId;
        if (!i.getHidden()) {
            i.hide()
        }
        if (!a) {
            a = e.add({
                xtype: 'desktop_all_advlist',
                reference: 'msgmrd_listAdv_all',
                flex: 1
            })
        } else {
            a.show()
        }
        var f = 0,
            c = '';
        for (var h in b) {
            switch (h) {
                case SearchType.MsgRecord:
                    c = b[h];
                    break;
                case SearchType.Time:
                    f = LocalSearchMgr.getSearchTime(b[h]);
                    break;
                case SearchType.SendName:
                    break;
                default:
                    break;
            }
        }
        if (Ext.isEmpty(c)) {
            var g = 'SELECT M.*,\n                F.ID FID,F.FileID,F.BaseID FileBaseID,F.FilePath,F.CreateAt FileCreateAt,F.FileType,F.FileName,F.MimeType,F.Width,F.Height,F.FileSize,F.Extension,F.FileStatus,F.HasPreview,\n                L.ID LID,L.BaseID LinkBaseID,L.Type,L.LinkObjType,L.LinkKeyString,L.LinkID,L.LinkTitle,L.LinkType,L.LinkOpUser,L.LinkDesc,L.LinkStr,L.LinkFromID,L.LinkStepID,L.LinkStepDesc,L.LinkStepStatus,L.LinkStatus,L.LinkStgGuid,\n                B.* \n                FROM \n                (SELECT * FROM IMMsg WHERE ChatID=? AND CreateAt >= ? \n                ORDER BY CreateAt DESC,MsgSeq DESC) M \n                LEFT JOIN IMFile F ON M.ID=F.BaseID \n                LEFT JOIN IMLink L ON M.ID=L.BaseID\n                LEFT JOIN IMBFile B ON M.ID=B.BaseID';
            LocalDataMgr.cExecSqlWithP(g, [d, f], function (l, k) {
                if (User.crtChannelId == d) {
                    var j = k.rows,
                        g = j.length;
                    var i = a.lookup('msgmrd_listAdv_all_title'),
                        f = a.lookup('msgmrd_listAdv_all_list'),
                        c = f.getStore();
                    if (g > 0) {
                        i.setHtml('<div class="allAdvlist-zone">' + g + '条消息</div>');
                        var h = [];
                        c.conditions = b;
                        for (var e = 0; e < g; e++) {
                            if (e == 20) {
                                break
                            }
                            h.unshift(j.item(e))
                        }
                        c.removeAll();
                        c.add(h);
                        AddDataUtil.onScroll(f)
                    } else {
                        i.setHtml('<div class="allAdvlist-zone">没有相关消息</div>');
                        c.removeAll();
                        ParseUtil.doEmptyText(f)
                    }
                }
            })
        } else {
            var g = 'SELECT MsgID,ChatID,MsgType,Content,CreateAt,SenderID,SenderName,MsgSeq,Status FROM IMMsg WHERE ChatID = ? AND CreateAt >= ? AND MsgType = ? AND INSTR(Content,?)>0 ORDER BY CreateAt DESC;';
            LocalDataMgr.cExecSqlWithP(g, [d, f, MsgType.TextMsg, c], function (m, l) {
                if (User.crtChannelId == d) {
                    var h = l.rows,
                        i = h.length;
                    var k = a.lookup('msgmrd_listAdv_all_title'),
                        g = a.lookup('msgmrd_listAdv_all_list'),
                        e = g.getStore();
                    if (i > 0) {
                        k.setHtml('<div class="allAdvlist-zone">' + i + '条消息</div>');
                        var j = [];
                        e.hltext = c;
                        e.conditions = b;
                        for (var f = 0; f < i; f++) {
                            if (f == 20) {
                                break
                            }
                            h.item(f).highlightWord = c;
                            j.unshift(h.item(f))
                        }
                        e.removeAll();
                        e.add(j);
                        AddDataUtil.onScroll(g)
                    } else {
                        k.setHtml('<div class="allAdvlist-zone">没有相关消息</div>');
                        e.removeAll();
                        ParseUtil.doEmptyText(g)
                    }
                }
            })
        }
    },
    destroy: function () {
        var a = Ext.getCmp('msgMrd_all_date');
        if (a) {
            Ext.destroy(a)
        }
        Ext.app.ViewController.prototype.destroy.apply(this, arguments)
    }
}, 0, 0, 0, 0, ['controller.desktop-allcontroller'], 0, [IMCommon.view.desktop.msgMrd.tab, 'AllController'], 0);
Ext.cmd.derive('IMCommon.view.desktop.msgMrd.tab.AllList', Ext.List, {
    deselectable: !1,
    store: {
        storeId: 'msgMrdListAll'
    },
    style: 'border-top: 1px solid #d6d6d6;',
    emptyText: '暂无记录',
    itemTpl: ['<tpl if="values.MsgType == \'R\'">', '<tpl elseif="values.MsgType == \'S\'">', '<tpl else>', '<div class="msgRecord_imitate_list">', '<tpl if="values.showDate">', '<div class="msgRecord_Date">{[Utils.date2Str(values.CreateAt)]}</div>', '</tpl>', '<div class="msgRecord_title" style="color:{[values.SenderID == User.ownerID ? \'rgb(36, 118, 224)\' : \'\']}">{SenderName} {[Utils.datetime2Ago(values.CreateAt,true)]}</div>', '<div class="msgRecord_content" {[DesktopChatUtil.pushInfoToDom(values)]}>', '<tpl if="values.MsgType == \'T\'">', '{[ParseUtil.parseTextToHtml(values.Content)]}', '<tpl elseif="values.MsgType == \'I\'">', '{[DesktopChatUtil.parseLoadedPic(values.Height,values.Width,values.FilePath,values.CreateAt,values.FileName,values.FileID)]}', '<tpl elseif="values.MsgType == \'F\'">', '<div class="msgRecord_file">', '<div class="mrd_fileWrapper">', '<div class="mrd_fileIcon {[ParseUtil.getFileIcon(values.FileName)]}"></div>', '<div class="mrd_fileName">{[ParseUtil.parseName(values.FileName)]}</div>', '<div>{[ParseUtil.bytesToSize(values.FileSize)]}</div>', '</div>', '</div>', '<tpl elseif="values.MsgType == \'G\'">', '{Content}', '<tpl elseif="values.MsgType == \'L\'">', '<div class="msgRecord_link">', '<div class="mrd_linkIcon" letter="{LinkType}"></div>', '<div class="mrd_linkName">{LinkTitle}</div>', '</div>', '<tpl elseif="values.MsgType == \'N\'">', '{[ParseUtil.getSureName(values.SenderID)]}修改了群公告&nbsp;', '<tpl elseif="values.MsgType == \'B\'">', '{[GroupNotice.getRevokeNotice(values.SenderID,values.Content)]}', '<tpl elseif="values.MsgType == \'E\'">', '<div class="msgRecord_file">', '<div class="mrd_fileWrapper">', '<div class="mrd_fileIcon {[ParseUtil.getFileIcon(values.BFileName)]}"></div>', '<div class="mrd_fileName">{BFileName}</div>', '<div>{[ParseUtil.bytesToSize(values.BFileSize)]}</div>', '</div>', '<div class="bigfile-special"></div>', '</div>', '<tpl else>', '消息类型未适配：{MsgType}', '</tpl>', '</div>', '</div>', '</tpl>'].join(''),
    initialize: function () {
        var a = this;
        Ext.dataview.List.prototype.initialize.apply(this, arguments);
        a.on({
            childTap: 'onCT',
            scope: a
        });
        a.getScrollable().on({
            scroll: 'onChgScrol',
            scrollend: 'onChgScrolEnd',
            scope: a
        });
        a.element.on({
            delegate: '.msgRecord_content',
            contextmenu: 'onMrdContextmenu',
            scope: a
        });
        var b = a.add({
            xtype: 'fabbutton',
            iconCls: 'x-fa fa-calendar',
            ui: 'action',
            userCls: 'btn-date',
            handler: 'onTapCalendar',
            scope: a
        });
        b.render(a.element)
    },
    onCT: function (f, a) {
        if (Ext.fly(a.event.target).dom.innerHTML == '设置') {
            var e = Ext.fly(a.event.target).dom.parentElement.children[0].className;
            this.opensetHistory(e)
        } else {
            var b = a.record;
            if (!b) {
                return
            }
            var c = b.get('CreateAt');
            if (!c) {
                return
            }
            var d = User.crtChannelId;
            if (!d) {
                return
            }
            DesktopChatUtil.mainViewOnTapJumpToMsg(d, c)
        }
    },
    opensetHistory: function (c) {
        var b;
        var d = !1;
        if (!Ext.Viewport.down('desktopChat_group')) {
            b = ViewGet.getGrpMemsView().items.items[1].store.data.items;
            for (var a = 0; a < b.length; a++) {
                if (b[a].data.user_id == c) {
                    d = !0;
                    break
                }
            }
        } else {
            b = Ext.Viewport.down('desktopChat_group').innerItems[1].dataItems;
            for (var a = 0; a < b.length; a++) {
                if (b[a].getRecord().id == c) {
                    d = !0;
                    break
                }
            }
        }
        if (d) {
            if (!Ext.Viewport.down('desktopChat_group')) {
                var e = Ext.Viewport.down('chatView_group').getChgHisDialog(c)
            } else {
                var e = Ext.Viewport.down('desktopChat_group').getChgHisDialog(c)
            }
            Ext.Viewport.down('list').uid = c;
            e.down('#userSelDialog_radio_now').setChecked(!0);
            e.show();
            Ext.Viewport.down('list').origin = 'Y';
            Ext.Viewport.down('list').time = 0
        } else {
            Utils.toastShort('该用户已不在会话中')
        }
    },
    opensetHistory: function (c) {
        var b;
        var d = !1;
        if (!Ext.Viewport.down('desktopChat_group')) {
            b = ViewGet.getGrpMemsView().items.items[1].store.data.items;
            for (var a = 0; a < b.length; a++) {
                if (b[a].data.user_id == c) {
                    d = !0;
                    break
                }
            }
        } else {
            b = Ext.Viewport.down('desktopChat_group').innerItems[1].dataItems;
            for (var a = 0; a < b.length; a++) {
                if (b[a].getRecord().id == c) {
                    d = !0;
                    break
                }
            }
        }
        if (d) {
            if (!Ext.Viewport.down('desktopChat_group')) {
                var e = Ext.Viewport.down('chatView_group').getChgHisDialog(c)
            } else {
                var e = Ext.Viewport.down('desktopChat_group').getChgHisDialog(c)
            }
            Ext.Viewport.down('list').uid = c;
            e.down('#userSelDialog_radio_now').setChecked(!0);
            e.show();
            Ext.Viewport.down('list').origin = 'Y';
            Ext.Viewport.down('list').time = 0
        } else {
            Utils.toastShort('该用户已不在会话中')
        }
    },
    onChgScrol: function (b, n, m) {
        if (this.isCodeScrol) {
            return
        }
        if (m === 0) {
            if (User.isMrdMsgTop) {
                return
            }
            if (User.isMrdSearch) {
                return
            }
            if (!b.autoTop) {
                var g = this;
                var d = g.getStore(),
                    a = d.getAt(0);
                if (!a) {
                    return
                }
                b.autoTop = !0;
                var f = a.get('ChatID'),
                    l = a.get('MsgSeq'),
                    c = a.get('CreateAt');
                LocalSearchMgr.getOldMsgWoNotShow(f, c, function (l, k) {
                    var h = k.rows,
                        j = h.length;
                    var i = [],
                        f;
                    for (var e = j - 1; e >= 0; e--) {
                        f = h.item(e);
                        if (e == 0) {
                            if (ParseUtil.inOneDay(f.CreateAt, c)) {
                                a.set({
                                    showDate: !1
                                })
                            }
                        }
                        if (e == j - 1) {
                            f.showDate = !0
                        } else {
                            f.showDate = !ParseUtil.inOneDay(f.CreateAt, h.item(e + 1).CreateAt)
                        }
                        i.push(f)
                    }
                    d.insert(0, i);
                    g.ensureVisible(a, {
                        align: {
                            y: 'start'
                        }
                    });
                    b.autoTop = !1
                }, function () {
                    console.error('向上滚动时，查询数据出错');
                    b.autoTop = !1
                })
            }
        }
        var e = b.getScrollElement().dom,
            i = e.scrollHeight,
            k = e.scrollTop,
            h = e.offsetHeight;
        if (i <= k + h) {
            if (User.isMrdMsgBottom) {
                return
            }
            if (User.isMrdSearch) {
                return
            }
            if (!b.autoBottom) {
                var j = this;
                var d = j.getStore(),
                    a = d.last();
                if (!a) {
                    return
                }
                b.autoBottom = !0;
                var f = a.get('ChatID'),
                    l = a.get('MsgSeq'),
                    c = a.get('CreateAt');
                LocalSearchMgr.getMoreEndHisWoNotShow(f, c, function (j, i) {
                    var f = i.rows,
                        h = f.length;
                    var g = [],
                        a;
                    for (var e = 0; e < h; e++) {
                        a = f.item(e);
                        if (e == 0) {
                            a.showDate = !ParseUtil.inOneDay(a.CreateAt, c)
                        } else {
                            a.showDate = !ParseUtil.inOneDay(a.CreateAt, f.item(e - 1).CreateAt)
                        }
                        g.push(a)
                    }
                    d.add(g);
                    b.autoBottom = !1
                }, function () {
                    console.error('向下滚动时，查询数据出错');
                    b.autoBottom = !1
                })
            }
        }
    },
    onChgScrolEnd: function () {
        this.isCodeScrol = !1
    },
    onMrdContextmenu: function (f) {
        var a = f.currentTarget;
        if (!a) {
            return
        }
        var i = this;
        var c, b, d;
        var g = a.getAttribute('type');
        switch (g) {
            case MsgType.TextMsg:
                var e = ParseUtil.getSelectedContents();
                if (!e) {
                    ParseUtil.selectText(a);
                    e = a.innerHTML
                };
                b = ParseUtil.htmlToText(e);
                c = Ext.create('IMCommon.view.menu.TextContextmenu', {
                    value: b
                });
                break;
            case MsgType.ImgMsg:
                b = a.getAttribute('origin_path');
                d = a.getAttribute('fileName');
                var h = Ext.fly(a).query('img')[0];
                c = Ext.create('IMCommon.view.menu.ImgContextmenu', {
                    createAt: a.getAttribute('createAt'),
                    value: b,
                    path: b,
                    fileName: d,
                    openMore: !0,
                    img: h,
                    selectPlace: i,
                    clsSelector: 'img.msgRecord_img'
                });
                break;
            case MsgType.FileMsg:
                b = a.getAttribute('origin_path');
                d = a.getAttribute('fileName');
                c = Ext.create('IMCommon.view.menu.FileContextmenu', {
                    value: b,
                    path: b,
                    fileName: d
                });
                break;
            case MsgType.LinkErp:
                b = a.getAttribute('content');
                c = Ext.create('IMCommon.view.menu.ErpLinkContextmenu', {
                    value: b,
                    linkObjType: a.getAttribute('linkObjType'),
                    linkStgGuid: a.getAttribute('linkStgGuid'),
                    linkKeyString: a.getAttribute('linkKeyString'),
                    linkType: a.getAttribute('linkType')
                });
                break;
            default:
                break;
        }
        if (c) {
            ParseUtil.menuShowAtVisible(c, f.getPoint())
        }
        f.preventDefault()
    },
    onTapCalendar: function (b) {
        var a = this.getDatePanel();
        if (a.getHidden()) {
            a.showBy(b, 't1-b1')
        }
    },
    getDatePanel: function () {
        var b = this;
        var a = Ext.getCmp('msgMrd_all_date');
        if (!a) {
            a = Ext.widget('msgMrd_all_date');
            b.setHasMsgDate(ParseUtil.getLocalTime(!0), User.crtChannelId, a);
            a.on({
                selDate: 'onDateSearch1',
                chgMonthTool: 'onChgMonthTool',
                scope: b
            })
        }
        return a
    },
    onChgMonthTool: function (b, c, a) {
        if (a != User.crtChannelId) {
            return
        }
        this.setHasMsgDate(c, a, b)
    },
    setHasMsgDate: function (a, e, b) {
        Utils.mask(b);
        if (Ext.isDate(a)) {
            a = a.getTime()
        }
        var c = ParseUtil.getPrevMonthStartTime(a),
            d = ParseUtil.getNextMonthEndTime(a);
        var f = 'SELECT CreateAt FROM IMMsg WHERE MsgType<>? AND ChatID=? AND CreateAt>=? AND CreateAt<=? ORDER BY CreateAt ASC;';
        LocalDataMgr.cExecSqlWithP(f, [MsgType.NotShow, e, c, d], function (i, h) {
            var d = h.rows,
                g = d.length;
            var f = [];
            if (g > 0) {
                for (var c = 0; c < g; c++) {
                    if (c == 0) {
                        f.push(new Date(d.item(c).CreateAt))
                    } else {
                        if (!ParseUtil.inOneDay(d.item(c).CreateAt, d.item(c - 1).CreateAt)) {
                            f.push(new Date(d.item(c).CreateAt))
                        }
                    }
                }
                b.setSpecialDates(f)
            }
            Utils.unMask(b)
        })
    },
    onDateSearch: function (e, c) {
        if (c) {
            var a = this,
                d = User.crtChannelId,
                b = a.getStore();
            LocalSearchMgr.searchMsgByDate(d, c, function (f, h) {
                if (User.crtChannelId == d) {
                    b.removeAll();
                    a.refresh();
                    if (f.length > 0) {
                        b.add(f);
                        var g = b.findRecord('CreateAt', h.CreateAt);
                        if (g) {
                            AddDataUtil.msgScrollToRecord(g, a)
                        }
                    } else {
                        ParseUtil.doEmptyText(a)
                    }
                }
            });
            e.hide()
        } else {}
    },
    onDateSearch1: function (e, a) {
        if (a) {
            var c = this,
                b = User.crtChannelId,
                d = c.getStore();
            var f = 'SELECT M.MsgID,M.ChatID,M.MsgType,M.Content,M.CreateAt,M.SenderID,M.SenderName,M.MsgSeq,M.Status,F.FileID,F.BaseID FileBaseID,F.FilePath,F.FileType,F.FileName,F.MimeType,F.Width,F.Height,F.FileSize,F.Extension,F.FileStatus,F.HasPreview,L.BaseID LinkBaseID,L.Type,L.LinkObjType,L.LinkKeyString,L.LinkID,L.LinkTitle,L.LinkType,L.LinkOpUser,L.LinkDesc,L.LinkStr,L.LinkFromID,L.LinkStepID,L.LinkStepDesc,L.LinkStepStatus,L.LinkStatus,L.LinkStgGuid, B.BaseID BFileBaseID,B.BFileID,B.BFilePath,B.BFileName,B.BFileSize,B.BFileExtension,B.BFileStatus,B.CreateAt BCreateAt,B.ExpireAt FROM IMMsg M LEFT JOIN IMFile F ON M.ID = F.BaseID LEFT JOIN IMLink L ON M.ID = L.BaseID LEFT JOIN IMBFile B ON M.ID = B.BaseID WHERE M.ChatID = ? AND M.CreateAt <= ? AND M.MsgType<>? ORDER BY M.CreateAt DESC LIMIT 10;';
            a = a.getTime();
            LocalDataMgr.cExecSqlWithP(f, [b, a, MsgType.Revoke], function (n, l) {
                if (User.crtChannelId !== b) {
                    return
                }
                var j = l.rows,
                    g = j.length;
                var f = [],
                    i = 10;
                if (g < 10) {
                    i = i + (10 - g)
                }
                var k;
                for (var h = 0; h < g; h++) {
                    k = j.item(h);
                    f.unshift(k)
                }
                var m = 'SELECT M.MsgID,M.ChatID,M.MsgType,M.Content,M.CreateAt,M.SenderID,M.SenderName,M.MsgSeq,M.Status,F.FileID,F.BaseID FileBaseID,F.FilePath,F.FileType,F.FileName,F.MimeType,F.Width,F.Height,F.FileSize,F.Extension,F.FileStatus,F.HasPreview,L.BaseID LinkBaseID,L.Type,L.LinkObjType,L.LinkKeyString,L.LinkID,L.LinkTitle,L.LinkType,L.LinkOpUser,L.LinkDesc,L.LinkStr,L.LinkFromID,L.LinkStepID,L.LinkStepDesc,L.LinkStepStatus,L.LinkStatus,L.LinkStgGuid, B.BaseID BFileBaseID,B.BFileID,B.BFilePath,B.BFileName,B.BFileSize,B.BFileExtension,B.BFileStatus,B.CreateAt BCreateAt,B.ExpireAt FROM IMMsg M LEFT JOIN IMFile F ON M.ID = F.BaseID LEFT JOIN IMLink L ON M.ID = L.BaseID LEFT JOIN IMBFile B ON M.ID = B.BaseID WHERE M.ChatID = ? AND M.CreateAt > ? AND M.MsgType<>? ORDER BY M.CreateAt ASC LIMIT 10;';
                LocalDataMgr.cExecSqlWithP(m, [b, a, MsgType.Revoke], function (o, k) {
                    if (User.crtChannelId !== b) {
                        return
                    }
                    var h = k.rows,
                        m = h.length;
                    var i;
                    for (var g = 0; g < m; g++) {
                        if (g == 0) {
                            i = h.item(g)
                        }
                        f.push(h.item(g))
                    }
                    d.removeAll();
                    c.refresh();
                    if (f.length > 0) {
                        d.add(f);
                        var j = d.findRecord('CreateAt', i.CreateAt);
                        if (j) {
                            AddDataUtil.msgScrollToRecord(j, c)
                        }
                    } else {
                        ParseUtil.doEmptyText(c)
                    }
                })
            });
            e.hide()
        } else {}
    },
    destroy: function () {
        var a = Ext.getCmp('msgMrd_all_date');
        if (a) {
            Ext.destroy(a)
        }
        Ext.dataview.List.prototype.destroy.apply(this, arguments)
    }
}, 0, ['desktop_all_list'], ['widget', 'component', 'container', 'componentdataview', 'list', 'desktop_all_list'], {
    'widget': !0,
    'component': !0,
    'container': !0,
    'componentdataview': !0,
    'list': !0,
    'desktop_all_list': !0
}, ['widget.desktop_all_list'], 0, [IMCommon.view.desktop.msgMrd.tab, 'AllList'], 0);
Ext.cmd.derive('IMCommon.view.desktop.msgMrd.tab.All', Ext.Container, {
    controller: 'desktop-allcontroller',
    layout: 'vbox',
    items: [{
        xtype: 'container',
        layout: 'hbox',
        padding: '8 18',
        items: [{
            xtype: 'richSearchfield',
            reference: 'msgmrd_richSearchfield',
            userCls: 'search',
            height: 28,
            flex: 1,
            searchView: {
                width: 240,
                store: {
                    data: [{
                        type: 'mr'
                    }]
                }
            }
        }, {
            xtype: 'button',
            userCls: 'btn-search',
            iconCls: 'im-common im-common-history',
            arrow: !1,
            menu: [{
                text: '最近一个月',
                handler: 'onSelOneMonth',
                indented: !1
            }, {
                text: '最近三个月',
                handler: 'onSelThreeMonth',
                indented: !1
            }, {
                text: '最近一年',
                handler: 'onSelOneYear',
                indented: !1
            }]
        }]
    }, {
        xtype: 'desktop_all_list',
        reference: 'msgmrd_list_all',
        itemId: 'msgMrd_list_all',
        flex: 1
    }]
}, 0, ['desktop_all'], ['widget', 'component', 'container', 'desktop_all'], {
    'widget': !0,
    'component': !0,
    'container': !0,
    'desktop_all': !0
}, ['widget.desktop_all'], 0, [IMCommon.view.desktop.msgMrd.tab, 'All'], 0);
Ext.cmd.derive('IMCommon.view.desktop.msgMrd.AllDatePanel', Ext.panel.Date, {
    id: 'msgMrd_all_date',
    cls: 'mrdCalendar',
    animation: !1,
    floated: !0,
    width: 252,
    height: 300,
    scrollable: !1,
    hidden: !0,
    buttonToolbar: {
        cls: 'autoHide'
    },
    headerFormat: {
        $value: 'Y年 m月',
        cached: !0
    },
    prevText: '',
    nextText: '',
    tools: {
        previousYear: null,
        nextYear: null
    },
    initialize: function () {
        var a = this;
        Ext.panel.Date.prototype.initialize.apply(this, arguments);
        a.bodyElement.on({
            click: {
                delegate: a.cellSelector,
                fn: 'onDC'
            },
            scope: a
        });
        a.on({
            show: 'onShowPanel',
            hide: 'onHidePanel',
            scope: a
        })
    },
    onDC: function (d) {
        var a = this,
            b = d.getTarget(a.cellSelector, a.bodyElement),
            c = b && b.date;
        var e = Ext.fly(b);
        if (e.hasCls('x-special')) {
            a.fireEvent('selDate', a, c)
        }
    },
    onMonthToolClick: function (b) {
        Ext.panel.Date.prototype.onMonthToolClick.apply(this, arguments);
        var a = this.getFocusableDate();
        this.fireEvent('chgMonthTool', this, a, User.crtChannelId)
    },
    onShowPanel: function (b) {
        var a = this;
        a.touchListeners = Ext.getDoc().on({
            touchstart: a.collapseIf,
            scope: a,
            delegated: !1,
            destroyable: !0
        })
    },
    collapseIf: function (b) {
        var a = this;
        if (!a.destroyed && !a.owns(b.target)) {
            a.hide()
        }
    },
    onHidePanel: function (a) {
        Ext.destroy(this.touchListeners)
    },
    doDestroy: function () {
        Ext.destroy(this.touchListeners);
        Ext.panel.Date.prototype.doDestroy.call(this)
    }
}, 0, ['msgMrd_all_date'], ['widget', 'component', 'container', 'panel', 'datepanel', 'msgMrd_all_date'], {
    'widget': !0,
    'component': !0,
    'container': !0,
    'panel': !0,
    'datepanel': !0,
    'msgMrd_all_date': !0
}, ['widget.msgMrd_all_date'], 0, [IMCommon.view.desktop.msgMrd, 'AllDatePanel'], 0);
Ext.cmd.derive('IMCommon.view.desktop.msgMrd.tab.PicList', Ext.List, {
    store: {
        fields: ['BaseID', 'FileID', 'ChatID', 'CreateAt', 'FilePath']
    },
    itemTpl: ['<div class="msgRecord_pic_frame" {[DesktopChatUtil.getImgDomAttr(values.FilePath,values.CreateAt,values.FileName)]}>', '<div class="msgRecord_pic_block">', '<img class="msgRecord_pic_loaded" src="{[ParseUtil.getLocalFileURL(ParseUtil.getAbsolutePath(values.FilePath))]}" create_at="{CreateAt}" fileID="{FileID}" fileName="{FileName}">', '</div>', '<div style="text-align: center;">{[Utils.date2Str(values.CreateAt)]}</div>', '</div>'].join(''),
    initialize: function () {
        var a = this;
        Ext.dataview.List.prototype.initialize.apply(this, arguments);
        a.element.on({
            delegate: '.msgRecord_pic_frame',
            tap: 'onTapPic',
            contextmenu: 'onContextmenu',
            scope: a
        })
    },
    onTapPic: function (f) {
        var d = f.delegatedTarget;
        if (!d) {
            return
        }
        var c = Ext.fly(d).query('img')[0];
        if (!c) {
            return
        }
        var e = this.innerElement.dom.querySelectorAll('img.msgRecord_pic_loaded'),
            a = [],
            b = -1;
        e.forEach(function (d, e) {
            a.push({
                url: d.src,
                original: ImgMgr.getFullPicUrl(d.getAttribute('fileID')),
                name: d.getAttribute('fileName'),
                createAt: d.getAttribute('create_at')
            });
            if (c === d) {
                b = e
            }
        });
        if (window.cefMain) {
            a = JSON.stringify(a);
            cefMain.viewImages(a, b)
        }
    },
    onContextmenu: function (b) {
        var c = b.delegatedTarget;
        if (!c) {
            return
        }
        var a = Ext.fly(c).query('img')[0];
        if (!a) {
            return
        }
        var e = this;
        var d = Ext.create('IMCommon.view.menu.ImgContextmenu', {
            createAt: a.getAttribute('create_at'),
            value: a.src,
            path: a.src,
            fileName: a.getAttribute('fileName'),
            openMore: !0,
            img: a,
            selectPlace: e,
            clsSelector: 'img.msgRecord_pic_loaded'
        });
        ParseUtil.menuShowAtVisible(d, b.getPoint());
        b.preventDefault()
    }
}, 0, ['desktop_pic_list'], ['widget', 'component', 'container', 'componentdataview', 'list', 'desktop_pic_list'], {
    'widget': !0,
    'component': !0,
    'container': !0,
    'componentdataview': !0,
    'list': !0,
    'desktop_pic_list': !0
}, ['widget.desktop_pic_list'], 0, [IMCommon.view.desktop.msgMrd.tab, 'PicList'], 0);
Ext.cmd.derive('IMCommon.view.desktop.msgMrd.tab.FileList', Ext.List, {
    store: {
        fields: ['BaseID', 'FileID', 'FileName', 'FileSize', 'CreateAt']
    },
    itemTpl: ['<div class="mrd_fileList_fileIcon {[ParseUtil.getFileIcon(values.FileName)]}"></div>', '<div class="mrd_file_font">{[Utils.date2Str(values.CreateAt)]}</div>', '<div>', '<div class="mrd_fileName">{[ParseUtil.parseName(values.FileName)]}</div>', '<div class="mrd_fileSize">{[ParseUtil.bytesToSize(values.FileSize)]}</div>', '</div>'].join(''),
    initialize: function () {
        var a = this;
        Ext.dataview.List.prototype.initialize.apply(this, arguments);
        a.element.on({
            delegate: '.x-listitem',
            contextmenu: 'onFileContextmenu',
            scope: a
        })
    },
    onFileContextmenu: function (c) {
        var d = c.currentTarget;
        if (!d) {
            return
        }
        var i = this;
        var f = i.getStore();
        var e = d.getAttribute('data-recordindex');
        var b = f.getAt(e);
        if (!b) {
            return
        }
        var a = b.get('FilePath');
        var h = /file:[\/]+/g;
        if (!h.test(a)) {
            a = ConfigMgr.getDefaultDir() + a
        }
        var g = Ext.create('IMCommon.view.menu.FileContextmenu', {
            value: a,
            path: a,
            fileName: b.get('FileName')
        });
        ParseUtil.menuShowAtVisible(g, c.getPoint());
        c.preventDefault()
    }
}, 0, ['desktop_file_list'], ['widget', 'component', 'container', 'componentdataview', 'list', 'desktop_file_list'], {
    'widget': !0,
    'component': !0,
    'container': !0,
    'componentdataview': !0,
    'list': !0,
    'desktop_file_list': !0
}, ['widget.desktop_file_list'], 0, [IMCommon.view.desktop.msgMrd.tab, 'FileList'], 0);
Ext.cmd.derive('IMCommon.view.desktop.msgMrd.tab.Reply', Ext.List, {
    emptyText: '暂无数据',
    selectable: !1,
    grouped: !0,
    pinHeaders: !1,
    groupHeader: {
        xtype: 'itemheader',
        userCls: 'reply_itemheader',
        groupField: 'MsgID',
        tpl: '<div style="min-height:40px;">{value}</div><div>(共{count}条回复)</div>'
    },
    store: {
        model: 'IMCommon.model.Reply',
        grouper: {
            direction: 'DESC',
            sortProperty: 'CreateAt',
            property: 'MyValue',
            groupFn: function (a) {
                var c = a.get('MsgType'),
                    b = '';
                switch (c) {
                    case MsgType.TextMsg:
                        b = ParseUtil.parseTextToHtml(a.get('Content'));
                        break;
                    case MsgType.ImgMsg:
                        b = DesktopChatUtil.parseLoadedPic(a.get('Height'), a.get('Width'), a.get('FilePath'), a.get('CreateAt'), a.get('FileName'), a.get('FileID'));
                        break;
                    case MsgType.FileMsg:
                        b = '<div class="msgRecord_file">\n                                        <div class="mrd_fileWrapper">\n                                        <div class="mrd_fileIcon ' + ParseUtil.getFileIcon(a.get('FileName')) + '"></div>\n                                        <div class="mrd_fileName">' + a.get('FileName') + '</div>\n                                        <div>' + ParseUtil.bytesToSize(a.get('FileSize')) + '</div>\n                                        </div>\n                                    </div>';
                        break;
                    case MsgType.LinkErp:
                        b = '<div class="msgRecord_link">\n                                        <div class="mrd_linkIcon" letter="' + a.get('LinkType') + '"></div>\n                                        <div class="mrd_linkName">' + a.get('LinkTitle') + '</div>\n                                    </div>';
                        break;
                    case MsgType.BigFileMsg:
                        b = '<div class="msgRecord_file">\n                                        <div class="mrd_fileWrapper">\n                                        <div class="mrd_fileIcon ' + [ParseUtil.getFileIcon(a.get('BFileName'))] + '"></div>\n                                        <div class="mrd_fileName">' + a.get('BFileName') + '</div>\n                                        <div>' + ParseUtil.bytesToSize(a.get('BFileSize')) + '</div>\n                                        </div>\n                                        <div class="bigfile-special"></div>\n                                    </div>';
                        break;
                    default:
                        break;
                }
                var d = b;
                if (c == MsgType.TextMsg) {
                    d = '\n                    <div class="reply_bubble">\n                        <div class="reply_plain">' + b + '</div>\n                    </div>'
                }
                var e = '\n            <a class="avatar link-avatar firstletter loaded " style="float:left;">\n                <img src="' + AvatarMgr.getNavUserAvaUrlWOCache(a.get('SenderID'), 0) + '" onerror="AvatarMgr.doUserAvaErr(this)" ava-id="' + a.get('SenderID') + '">\n            </a>\n            <div style="overflow: hidden;">\n                <div class="reply_uname inOneline">' + a.get('SenderName') + ' ' + ParseUtil.handleMsgShowTime(a.get('CreateAt')) + '</div>\n                ' + d + '\n            </div>';
                a.set({
                    MyValue: e
                });
                return a.get('MsgID')
            }
        }
    },
    itemTpl: '\n<a class="avatar link-avatar firstletter loaded " style="float:left;">\n    <img src="{[AvatarMgr.getNavUserAvaUrlWOCache(values.SenderID, 0)]}" onerror="AvatarMgr.doUserAvaErr(this)" ava-id="{SenderID}">\n</a>\n<div>\n    <div class="reply_uname inOneline">{SenderName} {[ParseUtil.handleMsgShowTime(values.RCreateAt)]}</div>\n    <div class="reply_bubble">\n        <div class="reply_plain">{[ParseUtil.parseTextToHtml(values.RContent)]}</div>\n    </div>\n</div>'
}, 0, ['desktop_msgmrd_reply'], ['widget', 'component', 'container', 'componentdataview', 'list', 'desktop_msgmrd_reply'], {
    'widget': !0,
    'component': !0,
    'container': !0,
    'componentdataview': !0,
    'list': !0,
    'desktop_msgmrd_reply': !0
}, ['widget.desktop_msgmrd_reply'], 0, [IMCommon.view.desktop.msgMrd.tab, 'Reply'], 0);
Ext.cmd.derive('IMCommon.view.desktop.msgMrd.DesktopMrdTabpanel', Ext.tab.Panel, {
    controller: 'desktopmrdtabpanelcontroller',
    cls: 'msgMrd',
    width: 300,
    defaults: {
        tab: {
            iconAlign: 'top'
        }
    },
    padding: 0,
    tabBar: {
        padding: 0,
        layout: {
            pack: 'left'
        }
    },
    items: [{
        title: '全部',
        xtype: 'desktop_all',
        itemId: 'msgMrd_all',
        cls: 'msgMrd_all'
    }, {
        title: '图片',
        xtype: 'desktop_pic_list',
        itemId: 'msgPicTab',
        cls: 'msgMrd_pic'
    }, {
        title: '文件',
        xtype: 'desktop_file_list',
        itemId: 'msgFileTab',
        cls: 'mrd_fileList'
    }]
}, 0, ['desktopMrdTabpanel'], ['widget', 'component', 'container', 'tabpanel', 'desktopMrdTabpanel'], {
    'widget': !0,
    'component': !0,
    'container': !0,
    'tabpanel': !0,
    'desktopMrdTabpanel': !0
}, ['widget.desktopMrdTabpanel'], 0, [IMCommon.view.desktop.msgMrd, 'DesktopMrdTabpanel'], 0);
Ext.cmd.derive('IMCommon.view.desktop.msgMrd.tab.AllAdvList', Ext.Container, {
    referenceHolder: !0,
    layout: 'vbox',
    items: [{
        xtype: 'container',
        reference: 'msgmrd_listAdv_all_title',
        html: '<div class="allAdvlist-zone">0条消息</div>',
        items: [{
            xtype: 'button',
            itemId: 'msgMrd_listAdv_all_title_back',
            text: '返回',
            hidden: !0,
            docked: 'right'
        }]
    }, {
        xtype: 'list',
        deselectable: !1,
        reference: 'msgmrd_listAdv_all_list',
        flex: 1,
        store: {
            storeId: 'msgMrdListAllAdv'
        },
        emptyText: '暂无记录',
        itemTpl: ['<tpl if="values.MsgType == \'R\'">', '<tpl elseif="values.MsgType == \'S\'">', '<tpl else>', '<div class="msgRecord_imitate_list">', '<div class="msgRecord_title" style="color:{[values.SenderID == User.ownerID ? \'rgb(36, 118, 224)\' : \'\']}">{SenderName} {[Utils.datetime2Ago(values.CreateAt,true)]}</div>', '<div class="msgRecord_content" {[DesktopChatUtil.pushInfoToDom(values)]}>', '<tpl if="values.MsgType == \'T\'">', '{[ParseUtil.doHighLight(values.Content, values.highlightWord)]}', '<tpl elseif="values.MsgType == \'I\'">', '{[DesktopChatUtil.parseLoadedPic(values.Height,values.Width,values.FilePath,values.CreateAt,values.FileName,values.FileID)]}', '<tpl elseif="values.MsgType == \'F\'">', '<div class="msgRecord_file">', '<div class="mrd_fileWrapper">', '<div class="mrd_fileIcon {[ParseUtil.getFileIcon(values.FileName)]}"></div>', '<div class="mrd_fileName">{FileName}</div>', '<div>{[ParseUtil.bytesToSize(values.FileSize)]}</div>', '</div>', '</div>', '<tpl elseif="values.MsgType == \'G\'">', '{Content}', '<tpl elseif="values.MsgType == \'L\'">', '<div class="msgRecord_link">', '<div class="mrd_linkIcon" letter="{LinkType}"></div>', '<div class="mrd_linkName">{LinkTitle}</div>', '</div>', '<tpl elseif="values.MsgType == \'N\'">', '{[ParseUtil.getSureName(values.SenderID)]}修改了群公告&nbsp;', '<tpl elseif="values.MsgType == \'B\'">', '{[GroupNotice.getRevokeNotice(values.SenderID,values.Content)]}', '<tpl elseif="values.MsgType == \'E\'">', '<div class="msgRecord_file">', '<div class="mrd_fileWrapper">', '<div class="mrd_fileIcon {[ParseUtil.getFileIcon(values.BFileName)]}"></div>', '<div class="mrd_fileName">{BFileName}</div>', '<div>{[ParseUtil.bytesToSize(values.BFileSize)]}</div>', '</div>', '<div class="bigfile-special"></div>', '</div>', '<tpl else>', '消息类型未适配：{MsgType}', '</tpl>', '</div>', '</div>', '</tpl>'].join('')
    }],
    initialize: function () {
        var a = this;
        Ext.Container.prototype.initialize.apply(this, arguments);
        a.lookup('msgmrd_listAdv_all_list').on({
            childTap: 'onCT',
            scope: a
        });
        a.lookup('msgmrd_listAdv_all_list').getScrollable().on({
            scroll: 'onChgScrol',
            scrollend: 'onChgScrolEnd',
            scope: a
        });
        a.element.on({
            delegate: '.msgRecord_content',
            contextmenu: 'onMrdContextmenu',
            scope: a
        })
    },
    onCT: function (e, d) {
        var a = d.record;
        if (!a) {
            return
        }
        var b = a.get('CreateAt');
        if (!b) {
            return
        }
        var c = User.crtChannelId;
        if (!c) {
            return
        }
        DesktopChatUtil.mainViewOnTapJumpToMsg(c, b)
    },
    onChgScrol: function (a, s, r) {
        if (a.autoScol) {
            return
        }
        var l = this;
        if (l.isCodeScrol) {
            return
        }
        var j = l.lookup('msgmrd_listAdv_all_list'),
            k = User.crtChannelId;
        if (r == 0) {
            var b = Ext.getStore('msgMrdListAllAdv'),
                c = b.getAt(0);
            if (!c) {
                return
            }
            a.autoScol = !0;
            var h = c.get('CreateAt'),
                o = b.hltext,
                d = b.conditions,
                i = 0,
                e = '';
            for (var g in d) {
                switch (g) {
                    case SearchType.MsgRecord:
                        e = d[g];
                        break;
                    case SearchType.Time:
                        i = LocalSearchMgr.getSearchTime(d[g]);
                        break;
                    case SearchType.SendName:
                        break;
                    default:
                        break;
                }
            }
            if (e) {
                var q = 'SELECT MsgID,ChatID,MsgType,Content,CreateAt,SenderID,SenderName,MsgSeq,Status FROM IMMsg WHERE ChatID = ? AND CreateAt >= ? AND CreateAt < ? AND MsgType = ? AND INSTR(Content,?)>0 ORDER BY CreateAt DESC Limit 20;';
                LocalDataMgr.cExecSqlWithP(q, [k, i, h, MsgType.TextMsg, e], function (k, i) {
                    var g = i.rows,
                        h = g.length;
                    var f = [],
                        e;
                    for (var d = h - 1; d >= 0; d--) {
                        e = g.item(d);
                        e.highlightWord = o;
                        f.push(e)
                    }
                    b.insert(0, f);
                    j.ensureVisible(c, {
                        align: {
                            y: 'start'
                        }
                    });
                    a.autoScol = !1
                }, function () {
                    a.autoScol = !1
                })
            } else {
                LocalSearchMgr.getOldMsgWoNotShow(k, h, function (k, i) {
                    var f = i.rows,
                        h = f.length;
                    var e = [],
                        g;
                    for (var d = h - 1; d >= 0; d--) {
                        g = f.item(d);
                        e.push(g)
                    }
                    b.insert(0, e);
                    j.ensureVisible(c, {
                        align: {
                            y: 'start'
                        }
                    });
                    a.autoScol = !1
                }, function () {
                    a.autoTop = !1
                })
            }
        }
        var f = a.getScrollElement().dom,
            n = f.scrollHeight,
            p = f.scrollTop,
            m = f.offsetHeight;
        if (n <= Math.ceil(p + m)) {}
    },
    onChgScrolEnd: function () {
        this.isCodeScrol = !1
    },
    onMrdContextmenu: function (f) {
        var a = f.currentTarget;
        if (!a) {
            return
        }
        var c, b, d;
        var h = a.getAttribute('type');
        switch (h) {
            case MsgType.TextMsg:
                var e = ParseUtil.getSelectedContents();
                if (!e) {
                    ParseUtil.selectText(a);
                    e = a.innerHTML
                };
                b = ParseUtil.htmlToText(e);
                c = Ext.create('IMCommon.view.menu.TextContextmenu', {
                    value: b
                });
                break;
            case MsgType.ImgMsg:
                b = a.getAttribute('origin_path');
                d = a.getAttribute('fileName');
                var i = Ext.fly(a).query('img')[0],
                    g = this.lookup('msgmrd_listAdv_all_list');
                c = Ext.create('IMCommon.view.menu.ImgContextmenu', {
                    createAt: a.getAttribute('createAt'),
                    value: b,
                    path: b,
                    fileName: d,
                    openMore: !0,
                    img: i,
                    selectPlace: g,
                    clsSelector: 'img.msgRecord_img'
                });
                break;
            case MsgType.FileMsg:
                b = a.getAttribute('origin_path');
                d = a.getAttribute('fileName');
                c = Ext.create('IMCommon.view.menu.FileContextmenu', {
                    value: b,
                    path: b,
                    fileName: d
                });
                break;
            case MsgType.LinkErp:
                b = a.getAttribute('content');
                c = Ext.create('IMCommon.view.menu.ErpLinkContextmenu', {
                    value: b,
                    linkObjType: a.getAttribute('linkObjType'),
                    linkStgGuid: a.getAttribute('linkStgGuid'),
                    linkKeyString: a.getAttribute('linkKeyString'),
                    linkType: a.getAttribute('linkType')
                });
                break;
            default:
                break;
        }
        if (c) {
            ParseUtil.menuShowAtVisible(c, f.getPoint())
        }
        f.preventDefault()
    }
}, 0, ['desktop_all_advlist'], ['widget', 'component', 'container', 'desktop_all_advlist'], {
    'widget': !0,
    'component': !0,
    'container': !0,
    'desktop_all_advlist': !0
}, ['widget.desktop_all_advlist'], 0, [IMCommon.view.desktop.msgMrd.tab, 'AllAdvList'], 0);
Ext.cmd.derive('IMCommon.view.desktop.reply.DesktopReplyController', Ext.app.ViewController, {
    init: function () {
        var a = this;
        var b = a.getView().lookup('reply_list');
        b.getScrollable().on({
            scroll: 'onChgScrol',
            scrollend: 'onChgScrolend',
            scope: a
        })
    },
    scrol: {},
    onChgScrol: function (j, k, g, h, i) {
        var a = this,
            b = a.msgid;
        if (!b) {
            return
        }
        var d = a.getView().lookup('reply_list'),
            e = d.getStore();
        if (d.isCodeScrol) {
            return
        }
        if (g == 0) {
            var c = e.getAt(0);
            if (!c) {
                return
            }
            if (a.scrol[b]) {
                return
            }
            a.scrol[b] = !0;
            var f = 'SELECT * FROM IMReply WHERE CreateAt<? AND RootID=? ORDER By CreateAt DESC;';
            LocalDataMgr.cExecSqlWithP(f, [c.get('CreateAt'), a.msgid], function (f, e) {
                a.bindLocalReplies(e.rows, !0);
                d.ensureVisible(c, {
                    align: {
                        y: 'start'
                    }
                });
                a.scrol[b] = !1
            })
        }
    },
    onChgScrolend: function (d, e, f, b, c) {
        var a = this.getView().lookup('reply_list');
        a.isCodeScrol = !1
    },
    imitateInit: function (c, b) {
        var a = b.get('msg_id');
        if (!a) {
            return
        }
        if (this.msgid == a) {
            return
        }
        this.getView().msgid = a;
        this.msgid = a;
        if (User.ownerID == b.get('senderID')) {
            ChatUtil.viewReply(c, a, function () {
                DesktopChatUtil.clearReplyNotice(a)
            }, function (a) {
                Utils.toastShort(a)
            })
        }
        this.bindChat(c);
        this.bindMsg(b);
        this.bindReplyList(a)
    },
    bindChat: function (b) {
        var a = this;
        LocalDataMgr.beforeDoChat(b, function (g, f) {
            var e = a.getView(),
                c = e.lookup('reply_chat'),
                d = a.getChatHtml(f.DisplayName);
            c.setHtml(d)
        })
    },
    getChatHtml: function (a) {
        return '\n            <div class="reply_chatname inOneline">' + a + '</div>\n        '
    },
    bindMsg: function (a) {
        var b = this.getView().lookup('reply_msg'),
            c = this.getMsgHtml(a);
        b.setHtml(c)
    },
    getMsgHtml: function (a) {
        var b = a.get('senderID'),
            d = '<img src="' + AvatarMgr.getNavUserAvaUrlWOCache(b, (new Date()).getTime()) + '" onerror="AvatarMgr.doUserAvaErr(this)" ava-id="' + b + '">',
            e = a.get('senderName'),
            f = ParseUtil.handleMsgShowTime(a.get('updateTime')),
            c = this.getShowHtml(a);
        return '\n            <div class="reply_msg" style="border-bottom: solid 1px #cfcfcf;">\n                <a class="avatar link-avatar firstletter loaded " style="float:left;">\n                ' + d + '\n                </a>\n                <div class="reply_uname inOneline">' + e + ' ' + f + '</div>\n                <div class="reply_content">' + c + '</div>\n            </div>\n        '
    },
    getShowHtml: function (a) {
        var c = a.get('msg_type'),
            b = '';
        switch (c) {
            case MsgType.TextMsg:
                b = ParseUtil.parseTextToHtml(a.get('sendText'));
                break;
            case MsgType.ImgMsg:
                b = this.getImgHtml(a);
                break;
            case MsgType.FileMsg:
                b = this.getFileHtml(a);
                break;
            case MsgType.LinkErp:
                b = this.getLinkHtml(a);
                break;
            case MsgType.BigFileMsg:
                b = this.getBFileHtml(a);
                break;
            default:
                break;
        }
        return b
    },
    getImgHtml: function (a) {
        var d = a.store,
            c = d.indexOf(a),
            b;
        try {
            if (window.cefMain) {
                b = ViewGet.getMsgView().getItemAt(c).el.query('img.viewPic.loaded')[0].src
            } else {
                if (window.cefChat) {
                    b = Utils.getCmp('desktopChat_list').getItemAt(c).el.query('img.viewPic.loaded')[0].src
                }
            }
        } catch (e) {
            b = ParseUtil.getLocalFileURL(DesktopChatUtil.getImgUrlByTN(a.get('filePath'), a.get('updateTime')));
            console.log(e)
        }
        return '<img class="reply_img" src="' + b + '">'
    },
    getFileHtml: function (a) {
        return ['<div class="msgRecord_file" style="overflow: hidden;">', '<div class="mrd_fileWrapper" style="margin: 0px;">', '<div class="mrd_fileIcon ' + ParseUtil.getFileIcon(a.get('fileName')) + '"></div>', '<div class="mrd_fileName">' + a.get('fileName') + '</div>', '<div>' + ParseUtil.bytesToSize(a.get('fileSize')) + '</div>', '</div>', '</div>'].join('')
    },
    getLinkHtml: function (a) {
        return ['<div class="msgRecord_link">', '<div class="mrd_linkIcon" letter="' + a.get('linkLinkType') + '"></div>', '<div class="mrd_linkName">' + a.get('linkName') + '</div>', '</div>'].join('')
    },
    getBFileHtml: function (a) {
        return ['<div class="msgRecord_file" style="overflow: hidden;">', '<div class="mrd_fileWrapper" style="margin: 0px;">', '<div class="mrd_fileIcon ' + [ParseUtil.getFileIcon(a.get('fileName'))] + '"></div>', '<div class="mrd_fileName">' + a.get('fileName') + '</div>', '<div>' + ParseUtil.bytesToSize(a.get('fileSize')) + '</div>', '</div>', '<div class="bigfile-special"></div>', '</div>'].join('')
    },
    bindReplyList: function (b) {
        var a = this;
        var d = this.getView().lookup('reply_list'),
            c = d.getStore();
        c.removeAll();
        LocalDataMgr.getLatestReply(b, function (g, e) {
            var d = 0,
                c = e.rows,
                f = c.length;
            a.bindLocalReplies(c);
            if (f > 0) {
                d = c.item(0).ReplySeq
            }
            ChatUtil.getUnreadReplyByMsgID(b, d, function (c) {
                a.bindRemoteReplies(c)
            }, function () {
                a.bindRemoteReplies()
            })
        })
    },
    bindLocalReplies: function (d, h) {
        var g = d.length,
            a = [],
            f = this.getView().lookup('reply_list'),
            c = f.getStore(),
            e;
        for (var b = 0; b < g; b++) {
            e = d.item(b);
            a.unshift(e)
        }
        if (h) {
            c.insert(0, a)
        } else {
            c.add(a)
        }
    },
    bindRemoteReplies: function (b) {
        var c = this.getView().lookup('reply_list');
        if (b && b.length > 0) {
            var f = c.getStore(),
                g = b.length,
                e = [],
                a;
            for (var d = 0; d < g; d++) {
                a = b[d];
                e.unshift({
                    ReplyID: a.reply_id,
                    ReplySeq: a.reply_seq,
                    CreateAt: a.create_at,
                    UpdateAt: a.update_at,
                    EditAt: a.edit_at,
                    DeleteAt: a.delete_at,
                    UserID: a.user_id,
                    UserName: a.user_name,
                    RootID: a.root_id,
                    Content: a.content,
                    ContentType: a.content_type,
                    AttachID: a.attach_id,
                    ContentEx: a.content_ex,
                    ChatID: a.chat_id
                })
            }
            f.add(e)
        }
        ParseUtil.doEmptyText(c);
        AddDataUtil.onScroll(c)
    },
    onCloseView: function () {
        DesktopChatUtil.toggleHideRightView(User.crtChannelId, User.crtChannelType, this.getView())
    },
    showEmjPanel: function (b) {
        var a = Ext.getCmp('global-emojipanel');
        if (!a) {
            a = Ext.widget('emojipanel', {
                id: 'global-emojipanel'
            })
        }
        a.on({
            ok: 'onChooseEmj',
            hide: 'onHideEmjPanel',
            scope: this
        });
        a.showBy(b, 'tl-bl?')
    },
    onChooseEmj: function (c, a) {
        var b = window.minEmoji(a);
        if (b !== a) {
            this.getView().lookup('reply_editor').insertObject(window.minEmoji(a), a)
        }
    },
    onHideEmjPanel: function (a) {
        a.un({
            ok: 'onChooseEmj',
            hide: 'onHideEmjPanel',
            scope: this
        })
    },
    onSendReply: function () {
        var a = this.getView();
        SendUtil.sendReply(a, a.cid)
    }
}, 0, 0, 0, 0, ['controller.desktopreplycontroller'], 0, [IMCommon.view.desktop.reply, 'DesktopReplyController'], 0);
Ext.cmd.derive('IMCommon.view.desktop.reply.DesktopReplyEditor', IMCommon.view.RichEditor, {
    initialize: function () {
        var a = this;
        IMCommon.view.RichEditor.prototype.initialize.apply(this, arguments);
        a.setTriggerChars([])
    },
    initDrap: function () {},
    preventKeydown: function () {
        if (Config.isPC) {
            var a = 'Ctrl+Enter';
            if (User.settings) {
                a = User.settings.send_hot_key
            }
            var b = function (c) {
                if (c) {
                    var a = User.crtChannelId,
                        b = DtPageCache.rightPages[a];
                    SendUtil.sendReply(b, a)
                }
            };
            DesktopChatUtil.onChgEditorSendFunc(this, a, b)
        }
    }
}, 0, ['replyEditor'], ['widget', 'component', 'field', 'inputfield', 'textfield', 'richtextareafield', 'imCommonEditor', 'replyEditor'], {
    'widget': !0,
    'component': !0,
    'field': !0,
    'inputfield': !0,
    'textfield': !0,
    'richtextareafield': !0,
    'imCommonEditor': !0,
    'replyEditor': !0
}, ['widget.replyEditor'], 0, [IMCommon.view.desktop.reply, 'DesktopReplyEditor'], 0);
Ext.cmd.derive('IMCommon.view.desktop.reply.DesktopReply', Ext.Container, {
    controller: 'desktopreplycontroller',
    layout: 'vbox',
    cls: 'desktop_reply',
    items: [{
        layout: 'hbox',
        items: [{
            flex: 1,
            reference: 'reply_chat',
            html: '会话名'
        }, {
            xtype: 'button',
            iconCls: 'im-common-close',
            ui: 'flat',
            handler: 'onCloseView'
        }]
    }, {
        reference: 'reply_msg',
        html: '消息主题'
    }, {
        xtype: 'list',
        reference: 'reply_list',
        emptyText: '暂无回复',
        flex: 1,
        selectable: !1,
        itemTpl: '\n            <a class="avatar link-avatar firstletter loaded " style="float:left;">\n                <img src="{[AvatarMgr.getNavUserAvaUrlWOCache(values.UserID, 0)]}" onerror="AvatarMgr.doUserAvaErr(this)" ava-id="{UserID}">\n            </a>\n            <div>\n                <div class="reply_uname inOneline">{UserName} {[ParseUtil.handleMsgShowTime(values.CreateAt)]}</div>\n                <div class="reply_bubble">\n                    <div class="reply_plain">{[ParseUtil.parseTextToHtml(values.Content)]}</div>\n                </div>\n            </div>\n        ',
        store: {
            fields: ['ReplyID']
        }
    }, {
        xtype: 'replyEditor',
        reference: 'reply_editor',
        style: 'height: 50px; border-top: solid 1px #cfcfcf;border-bottom: solid 1px #cfcfcf;'
    }, {
        layout: 'hbox',
        userCls: 'desktop_reply_send',
        items: [{
            xtype: 'button',
            iconCls: 'im-common-smile',
            ui: 'flat',
            handler: 'showEmjPanel'
        }, {
            xtype: 'component',
            flex: 1
        }, {
            xtype: 'button',
            text: '回复(<span style="text-decoration: underline;">S</span>)',
            ui: 'send-ui',
            width: 66,
            height: 24,
            handler: 'onSendReply'
        }]
    }]
}, 0, ['desktopReply'], ['widget', 'component', 'container', 'desktopReply'], {
    'widget': !0,
    'component': !0,
    'container': !0,
    'desktopReply': !0
}, ['widget.desktopReply'], 0, [IMCommon.view.desktop.reply, 'DesktopReply'], 0);
Ext.cmd.derive('IMCommon.view.list.GroupedList', Ext.List, {
    height: '100%',
    cls: 'support-select',
    indexBar: !0,
    itemTpl: ['<div class="{[values.selList ? \'selList\':\'\']}" style="float:left">', '<div class="select"></div>', '</div>', '<div class="Content">', '<a class="avatar link-avatar firstletter " letter="{[AvatarUtil.getFirstLetter(values.user_name)]} " style="float:left;{[AvatarUtil.getColorStyle(values.user_name)]}">', '</a>', '{user_name}', '</div>'].join(''),
    grouped: !0,
    pinHeaders: !1,
    selectable: !1,
    itemsFocusable: !1,
    defaultListenerScope: !0,
    listeners: {
        childTap: 'onSelChild'
    },
    initialize: function () {},
    constructor: function (a) {
        a = Ext.applyIf({
            store: {
                model: 'IMCommon.model.PersonList',
                grouper: {
                    groupFn: function (b) {
                        return pinyinUtil.getFirstLetter(b.get('user_name'))[0]
                    }
                }
            }
        });
        Ext.dataview.List.prototype.constructor.apply(this, arguments)
    },
    onSelChild: function (d, b) {
        var a = b.record;
        if (a) {
            var c = a.data;
            if (c.selList) {
                a.set('selList', !1)
            } else {
                a.set('selList', !0)
            }
        }
    }
}, 1, ['groupedList'], ['widget', 'component', 'container', 'componentdataview', 'list', 'groupedList'], {
    'widget': !0,
    'component': !0,
    'container': !0,
    'componentdataview': !0,
    'list': !0,
    'groupedList': !0
}, ['widget.groupedList'], 0, [IMCommon.view.list, 'GroupedList'], 0);
Ext.cmd.derive('IMCommon.view.list.imitateListPaging', Ext.List, {
    scrollToTopOnRefresh: !1,
    userSelectable: !1,
    deselectable: !1,
    selectable: {
        model: 'single'
    },
    initialize: function () {
        var a = this;
        Ext.dataview.List.prototype.initialize.apply(this, arguments);
        a.on('storechange', 'onStoreChg', a);
        a.doStoreChg(a.getStore())
    },
    destroy: function () {
        Ext.destroy(this._storeListeners);
        Ext.dataview.List.prototype.destroy.apply(this, arguments)
    },
    onStoreChg: function (b, a) {
        this.doStoreChg(a)
    },
    doStoreChg: function (b) {
        var a = this,
            c = {
                add: 'doStoreAdd',
                clear: 'doStoreClear',
                destroyable: !0,
                scope: a
            };
        a._storeListeners = Ext.destroy(a._storeListeners);
        if (b) {
            a._storeListeners = b.on(c)
        }
    },
    doStoreAdd: function (f, e) {
        var a = this,
            d = this.getPageSize();
        if (!Ext.isNumber(d)) {
            d = 20
        }
        var b = a.loadMoreCmp;
        if (!b) {
            return
        }
        if (a.loadMorePage) {
            a.loadMorePage += 1
        } else {
            a.loadMorePage = 1
        }
        var c = a.emptyTextCmp || a.getEmptyTextCmp();
        if (c) {
            if (f.getCount() == 0 && e.length == 0) {
                b.hide();
                c.show();
                return
            }
            c.hide()
        }
        if (d > e.length) {
            b.hide()
        } else {
            b.show()
        }
        a.setLoading(!1)
    },
    doStoreClear: function () {
        var a = this,
            c = a.loadMoreCmp;
        if (!c) {
            return
        }
        a.loadMorePage = 0;
        a.setSearchParams({});
        var b = a.emptyTextCmp || a.getEmptyTextCmp();
        if (b) {
            b.show()
        }
        c.hide();
        a.setLoading(!1)
    },
    config: {
        showLoadMore: {
            scrollDock: 'end'
        },
        pageSize: 20,
        loading: !1,
        searchParams: {}
    },
    updateLoading: function (a) {
        if (!this.loadMoreCmp) {
            return
        }
        this.loadMoreCmp.toggleCls('x-loading', a)
    },
    applyShowLoadMore: function (c) {
        var a = this;
        if (c) {
            if (!a.loadMoreCmp) {
                var d = '<div class="' + 'x-' + 'loading-spinner">\n                    <span class="' + 'x-' + 'loading-top"></span>\n                    <span class="' + 'x-' + 'loading-right"></span>\n                    <span class="' + 'x-' + 'loading-bottom"></span>\n                    <span class="' + 'x-' + 'loading-left"></span>\n                </div>\n                <div class="' + 'x-' + 'message">加载更多...</div>';
                var b = c.scrollDock;
                if (!b) {
                    b = 'end'
                }
                a.loadMoreCmp = Ext.create('Ext.Component', {
                    cls: 'x-listpaging',
                    html: d,
                    scrollDock: b,
                    hidden: !0,
                    inheritUi: !0
                });
                a.loadMoreCmp.el.on({
                    tap: 'onTapLoadMore',
                    scope: a
                });
                a.add(a.loadMoreCmp)
            }
        } else {
            if (a.loadMoreCmp) {
                a.loadMoreCmp.hide()
            }
        }
    },
    doSearchFunc: function (c, a) {
        var b = this.getSearchParams();
        this.fireEvent('ilpSearch', this, c, a, b)
    },
    onTapLoadMore: function () {
        this.doDataAddFunc()
    },
    doDataAddFunc: function () {
        var a = this.getPageSize();
        if (!Ext.isNumber(a)) {
            a = 20
        }
        var c = this,
            b = c.loadMorePage;
        c.setLoading(!0);
        if (!b) {
            b = 0
        }
        c.doSearchFunc(b, a)
    }
}, 0, ['imitateListPaging'], ['widget', 'component', 'container', 'componentdataview', 'list', 'imitateListPaging'], {
    'widget': !0,
    'component': !0,
    'container': !0,
    'componentdataview': !0,
    'list': !0,
    'imitateListPaging': !0
}, ['widget.imitateListPaging'], 0, [IMCommon.view.list, 'imitateListPaging'], 0);
Ext.cmd.derive('IMCommon.view.menu.HideDestroyMenu', Ext.menu.Menu, {
    defaults: {
        indented: !1
    },
    privates: {
        onClick: function (c) {
            var b = this,
                g = c.type,
                a, d, f = g === 'keydown',
                e = c.pointerType === 'touch';
            b.un({
                hide: 'onHideMenu',
                scope: this
            });
            if (b.getDisabled()) {
                return c.stopEvent()
            }
            a = b.getItemFromEvent(c);
            if (a && a.isMenuItem) {
                if (!a.getMenu() || !b.ignoreParentClicks) {
                    d = a.onClick(c)
                } else {
                    c.stopEvent()
                }
                if (b.destroyed) {
                    return
                }
                if (a.getMenu() && d !== !1 && (f || e)) {
                    a.expandMenu(c)
                }
            }
            if (!a || a.getDisabled()) {
                a = undefined
            }
            b.fireEvent('click', b, a, c);
            Ext.destroy(b)
        }
    },
    initialize: function () {
        var a = this;
        Ext.menu.Menu.prototype.initialize.apply(this, arguments);
        a.on({
            show: 'onShowMenu',
            scope: a
        })
    },
    onShowMenu: function () {
        this.on({
            hide: 'onHideMenu',
            scope: this
        })
    },
    onHideMenu: function () {
        this.un({
            show: 'onShowMenu',
            hide: 'onHideMenu',
            scope: this
        });
        Ext.destroy(this)
    }
}, 0, ['hideDestroyMenu'], ['widget', 'component', 'container', 'panel', 'menu', 'hideDestroyMenu'], {
    'widget': !0,
    'component': !0,
    'container': !0,
    'panel': !0,
    'menu': !0,
    'hideDestroyMenu': !0
}, ['widget.hideDestroyMenu'], 0, [IMCommon.view.menu, 'HideDestroyMenu'], 0);
Ext.cmd.derive('IMCommon.view.menu.ErpLinkContextmenu', IMCommon.view.menu.HideDestroyMenu, {
    defaultListenerScope: !0,
    width: 100,
    items: [{
        text: '复制',
        indented: !1,
        handler: 'doCopy'
    }, {
        text: '打开',
        indented: !1,
        handler: 'doOpen'
    }],
    initialize: function () {
        var a = this;
        IMCommon.view.menu.HideDestroyMenu.prototype.initialize.apply(this, arguments)
    },
    doCopy: function () {
        var a = this.value;
        var b = {
            type: MsgType.LinkErp,
            value: a
        };
        if (Config.isDesktop) {
            Utils.getApp().getCefObj().setCopyData(MsgType.LinkErp, a, function (a) {
                if (!a) {
                    Utils.toastShort('复制出错了')
                }
            })
        }
        if (window.cefMsgMgr) {
            cefMsgMgr.exec('doCefCopy', JSON.stringify(b))
        }
    },
    doOpen: function () {
        var a = {
            linkObjType: this.linkObjType,
            linkStgGuid: this.linkStgGuid,
            linkKeyString: this.linkKeyString,
            linkType: this.linkType,
            content: this.value
        };
        if (Config.isPC) {
            if (window.cefMsgMgr) {
                cefMsgMgr.exec('doCefOpenLink', JSON.stringify(a))
            } else {
                if (ConfigMgr.isAio8()) {
                    DesktopChatUtil.openErpLinkInAio8(a)
                } else {
                    var b = a.linkObjType || a.linkStgGuid;
                    DesktopChatUtil.openErpLink(b + '', a.linkKeyString, a.linkType)
                }
            }
        }
    }
}, 0, ['erpLinkContextmenu'], ['widget', 'component', 'container', 'panel', 'menu', 'hideDestroyMenu', 'erpLinkContextmenu'], {
    'widget': !0,
    'component': !0,
    'container': !0,
    'panel': !0,
    'menu': !0,
    'hideDestroyMenu': !0,
    'erpLinkContextmenu': !0
}, ['widget.erpLinkContextmenu'], 0, [IMCommon.view.menu, 'ErpLinkContextmenu'], 0);
Ext.cmd.derive('IMCommon.view.menu.FileContextmenu', IMCommon.view.menu.HideDestroyMenu, {
    defaultListenerScope: !0,
    width: 100,
    items: [{
        text: '复制',
        indented: !1,
        handler: 'doCopy'
    }, {
        text: '打开',
        indented: !1,
        handler: 'doOpen'
    }, {
        text: '另存为',
        indented: !1,
        handler: 'doSaveAs'
    }, {
        text: '打开目录',
        indented: !1,
        handler: 'doOpenFolder'
    }],
    initialize: function () {
        var a = this;
        IMCommon.view.menu.HideDestroyMenu.prototype.initialize.apply(this, arguments)
    },
    doCopy: function () {
        var a = this.value;
        var b = {
            type: MsgType.FileMsg,
            value: a
        };
        if (Config.isDesktop) {
            Utils.getApp().getCefObj().setCopyData(MsgType.FileMsg, a, function (a) {
                if (!a) {
                    Utils.toastShort('复制出错了')
                }
            })
        }
        if (window.cefMsgMgr) {
            cefMsgMgr.exec('doCefCopy', JSON.stringify(b))
        }
    },
    doOpen: function () {
        var a = this.path;
        if (Config.isDesktop) {
            Utils.getApp().getCefObj().open(a, function (a) {}, function (a) {
                Utils.toastShort(a)
            })
        }
        if (window.cefMsgMgr) {
            cefMsgMgr.exec('doCefOpenFile', a)
        }
    },
    doSaveAs: function () {
        if (Config.isDesktop) {
            Utils.getApp().getCefObj().saveAs(this.path, this.fileName, function (a) {}, function (a) {
                Utils.toastShort(a)
            })
        }
        if (window.cefMsgMgr) {
            var a = {
                path: this.path,
                fileName: this.fileName
            };
            cefMsgMgr.exec('doCefSaveAs', JSON.stringify(a))
        }
    },
    doOpenFolder: function () {
        var a = this.path;
        if (Config.isDesktop) {
            Utils.getApp().getCefObj().openFolder(this.path, function (a) {}, function (a) {
                Utils.toastShort(a)
            })
        }
        if (window.cefMsgMgr) {
            cefMsgMgr.exec('doCefOpenFileFolder', a)
        }
    },
    onHideMe: function (a) {
        Ext.destroy(a)
    }
}, 0, ['fileContextmenu'], ['widget', 'component', 'container', 'panel', 'menu', 'hideDestroyMenu', 'fileContextmenu'], {
    'widget': !0,
    'component': !0,
    'container': !0,
    'panel': !0,
    'menu': !0,
    'hideDestroyMenu': !0,
    'fileContextmenu': !0
}, ['widget.fileContextmenu'], 0, [IMCommon.view.menu, 'FileContextmenu'], 0);
Ext.cmd.derive('IMCommon.view.menu.FileMgrContextmenu', IMCommon.view.menu.HideDestroyMenu, {
    defaultListenerScope: !0,
    width: 100,
    items: [{
        text: '复制',
        indented: !1,
        handler: 'doCopy'
    }, {
        text: '打开',
        indented: !1,
        handler: 'doOpen'
    }, {
        text: '另存为',
        indented: !1,
        handler: 'doSaveAs'
    }, {
        text: '打开目录',
        indented: !1,
        handler: 'doOpenFolder'
    }, {
        text: '转发',
        indented: !1,
        handler: 'doTransferFile'
    }, {
        text: '删除',
        indented: !1,
        handler: 'doDelRecord'
    }],
    initialize: function () {
        var a = this;
        IMCommon.view.menu.HideDestroyMenu.prototype.initialize.apply(this, arguments)
    },
    doCopy: function () {
        var a = this.value;
        var b = {
            type: MsgType.FileMsg,
            value: a
        };
        if (window.cefFileMgr) {
            cefFileMgr.exec('doCefCopy', JSON.stringify(b))
        }
    },
    doOpen: function () {
        var a = this.path;
        if (window.cefFileMgr) {
            cefFileMgr.exec('doCefOpenFile', a)
        }
    },
    doSaveAs: function () {
        if (window.cefFileMgr) {
            var a = {
                path: this.path,
                fileName: this.fileName
            };
            cefFileMgr.exec('doCefSaveAs', JSON.stringify(a))
        }
    },
    doOpenFolder: function () {
        var a = this.path;
        if (window.cefFileMgr) {
            cefFileMgr.exec('doCefOpenFileFolder', a)
        }
    },
    doTransferFile: function () {
        var c = this.msg_id;
        var b = this.file_size;
        var a = this.path;
        var d = 'SELECT * FROM IMRct ORDER BY IsTop DESC, LastPostAt DESC, UnreadCount DESC limit 50;';
        LocalDataMgr.cExecSqlWithP(d, [], function (k, i) {
            var g = i.rows;
            var h = [];
            for (var f = 0; f < g.length; f++) {
                var d = g.item(f);
                var e;
                if (d.ChatID != 'eeeeeeeebbbbbbbbbfffffffff') {
                    if (d.ChatType == ChatType.Multi || d.ChatType == 'C') {
                        e = d.ChatID
                    } else {
                        if (d.ChatType == ChatType.Direct) {
                            e = d.UserID
                        } else {
                            if (d.ChatType == ChatType.News) {
                                continue
                            }
                        }
                    }
                    h.push({
                        transmit: !0,
                        chat_id: d.ChatID,
                        user_id: d.ChatID,
                        ava_id: e,
                        create_at: d.CreateAt,
                        chat_type: d.ChatType,
                        leaf: !0,
                        user_name: d.DisplayName,
                        iconCls: 'hide-icon'
                    })
                }
            }
            var j = {
                fromAdd: 'transmit',
                rctData: h,
                msgID: c,
                fileSize: b,
                filePath: a
            };
            DesktopChatUtil.defaults4UserSelForm(j, {})
        })
    },
    doDelRecord: function () {
        var d = this;
        var a = this.base_id;
        var b = this.chose_where;
        var c = (new Date()).getTime();
        Ext.Msg.confirm('温馨提示', '确定要删除吗', function (e) {
            if (e == 'yes') {
                if (b == 'groupms') {
                    var d = 'UPDATE IMFile SET FileStatus=?, DeleteAt = ? WHERE BaseID = ?;';
                    LocalDataMgr.cExecSqlWithP(d, [1, c, a], function (l, k) {
                        var b = Ext.getStore('file_mgrlist').getById(a);
                        var j = Ext.getStore('file_mgrlist');
                        var h = [];
                        var g = b.data.filePath;
                        if (!b.data.filePath.startsWith('file://')) {
                            g = ConfigMgr.getDefaultDir() + b.data.filePath
                        }
                        h.push({
                            path: g
                        });
                        cefFileMgr.exec('doCefDelFile', JSON.stringify(h));
                        j.remove(b);
                        if (User.totalInfo.length > 0) {
                            for (var c = 0; c < User.totalInfo.length; c++) {
                                if (User.totalInfo[c].baseID == a) {
                                    User.totalInfo.splice(c, 1)
                                }
                            }
                            var i = 0;
                            for (var f = 0; f < User.totalInfo.length; f++) {
                                i += User.totalInfo[f].fileSize
                            }
                            if (User.totalInfo.length > 0) {
                                var d = '文件大小： 0MB';
                                Ext.Viewport.down('ceffilemgr').down('#allfilesize').setHtml(d)
                            } else {
                                var d = '文件大小： 0MB';
                                Ext.Viewport.down('ceffilemgr').down('#allfilesize').setHtml(d)
                            }
                        }
                    })
                } else {
                    if (b == 'workfile') {
                        var f = 'UPDATE IMWFile SET DeleteAt = ? WHERE ID = ?;';
                        LocalDataMgr.cExecSqlWithP(f, [c, a], function (k, j) {
                            var g = Ext.getStore('workfile_mgrlist').getById(a);
                            var i = Ext.getStore('workfile_mgrlist');
                            var f = [];
                            f.push({
                                path: 'file:///' + g.data.filePath
                            });
                            cefFileMgr.exec('doCefDelFile', JSON.stringify(f));
                            i.remove(g);
                            if (User.totalInfo.length > 0) {
                                for (var b = 0; b < User.totalInfo.length; b++) {
                                    if (User.totalInfo[b].baseID == a) {
                                        User.totalInfo.splice(b, 1)
                                    }
                                }
                                var h = 0;
                                for (var d = 0; d < User.totalInfo.length; d++) {
                                    h += User.totalInfo[d].fileSize
                                }
                                if (User.totalInfo.length > 0) {
                                    var c = '文件大小： 0MB';
                                    Ext.Viewport.down('ceffilemgr').down('#allfilesize').setHtml(c)
                                } else {
                                    var c = '文件大小： 0MB';
                                    Ext.Viewport.down('ceffilemgr').down('#allfilesize').setHtml(c)
                                }
                            }
                        })
                    }
                }
            }
        })
    },
    onHideMe: function (a) {
        Ext.destroy(a)
    }
}, 0, ['filemgrContextmenu'], ['widget', 'component', 'container', 'panel', 'menu', 'hideDestroyMenu', 'filemgrContextmenu'], {
    'widget': !0,
    'component': !0,
    'container': !0,
    'panel': !0,
    'menu': !0,
    'hideDestroyMenu': !0,
    'filemgrContextmenu': !0
}, ['widget.filemgrContextmenu'], 0, [IMCommon.view.menu, 'FileMgrContextmenu'], 0);
Ext.cmd.derive('IMCommon.view.menu.ImgContextmenu', IMCommon.view.menu.HideDestroyMenu, {
    defaultListenerScope: !0,
    width: 100,
    items: [{
        text: '复制',
        indented: !1,
        handler: 'doCopy'
    }, {
        text: '打开',
        indented: !1,
        handler: 'doOpen'
    }, {
        text: '另存为',
        indented: !1,
        handler: 'doSaveAs'
    }, {
        text: '打开目录',
        indented: !1,
        handler: 'doOpenFolder'
    }],
    doCopy: function () {
        var a = decodeURI(this.value);
        var b = {
            type: MsgType.ImgMsg,
            value: a
        };
        if (Config.isPC) {
            a = ParseUtil.getOriginPicPath(a);
            Utils.getApp().getCefObj().setCopyData(MsgType.ImgMsg, a, function (a) {
                if (!a) {
                    Utils.toastShort('复制出错了')
                }
            })
        }
    },
    doOpen: function () {
        var c = this;
        var e = Utils.getApp().getCefObj();
        var i = c.openMore;
        if (i) {
            var g = c.clsSelector,
                h = c.selectPlace,
                a = c.img,
                j = h.innerElement.dom.querySelectorAll(g),
                d = [],
                f = -1;
            j.forEach(function (b, c) {
                d.push({
                    url: b.src,
                    original: ImgMgr.getFullPicUrl(b.getAttribute('fileID')),
                    name: b.getAttribute('fileName'),
                    createAt: b.getAttribute('create_at')
                });
                if (a === b) {
                    f = c
                }
            });
            if (e) {
                d = JSON.stringify(d);
                e.viewImages(d, f)
            }
            return
        }
        if (e) {
            var b = [],
                a = c.img;
            if (!Ext.isEmpty(a)) {
                b.push({
                    url: a.src,
                    original: ImgMgr.getFullPicUrl(a.getAttribute('fileID')),
                    name: a.getAttribute('fileName'),
                    createAt: a.getAttribute('create_at')
                })
            }
            if (b.length > 0) {
                b = JSON.stringify(b);
                e.viewImages(b, 0)
            }
        }
    },
    doSaveAs: function () {
        var a = decodeURI(this.path);
        if (Config.isPC) {
            a = ParseUtil.getOriginPicPath(a);
            FileMgr.saveAs(a, this.fileName)
        }
    },
    doOpenFolder: function () {
        var a = decodeURI(this.path);
        if (Config.isPC) {
            a = ParseUtil.getOriginPicPath(a);
            Utils.getApp().getCefObj().openFolder(a, function (a) {}, function (a) {
                Utils.toastShort(a)
            })
        }
    }
}, 0, ['imgContextmenu'], ['widget', 'component', 'container', 'panel', 'menu', 'hideDestroyMenu', 'imgContextmenu'], {
    'widget': !0,
    'component': !0,
    'container': !0,
    'panel': !0,
    'menu': !0,
    'hideDestroyMenu': !0,
    'imgContextmenu': !0
}, ['widget.imgContextmenu'], 0, [IMCommon.view.menu, 'ImgContextmenu'], 0);
Ext.cmd.derive('IMCommon.view.menu.TextContextmenu', IMCommon.view.menu.HideDestroyMenu, {
    defaultListenerScope: !0,
    width: 100,
    items: [{
        text: '复制',
        indented: !1,
        handler: 'doCopy'
    }],
    initialize: function () {
        var a = this;
        IMCommon.view.menu.HideDestroyMenu.prototype.initialize.apply(this, arguments)
    },
    doCopy: function () {
        var a = this.value;
        var b = {
            type: MsgType.TextMsg,
            value: a
        };
        if (Config.isDesktop) {
            Utils.getApp().getCefObj().setCopyData(MsgType.TextMsg, a, function (a) {
                if (!a) {
                    Utils.toastShort('复制出错了')
                }
            })
        }
    },
    onHideMe: function (a) {
        Ext.destroy(a)
    }
}, 0, ['textContextmenu'], ['widget', 'component', 'container', 'panel', 'menu', 'hideDestroyMenu', 'textContextmenu'], {
    'widget': !0,
    'component': !0,
    'container': !0,
    'panel': !0,
    'menu': !0,
    'hideDestroyMenu': !0,
    'textContextmenu': !0
}, ['widget.textContextmenu'], 0, [IMCommon.view.menu, 'TextContextmenu'], 0);
Ext.cmd.derive('IMCommon.view.panel.hidePanel', Ext.Panel, {
    initialize: function () {
        var a = this;
        Ext.Panel.prototype.initialize.apply(this, arguments);
        a.on({
            show: 'onShowPanel',
            hide: 'onHidePanel',
            scope: a
        })
    },
    onShowPanel: function (b) {
        var a = this;
        a.touchListeners = Ext.getDoc().on({
            touchstart: a.collapseIf,
            scope: a,
            delegated: !1,
            destroyable: !0
        })
    },
    collapseIf: function (b) {
        var a = this;
        if (!a.destroyed && !a.owns(b.target)) {
            a.hide()
        }
    },
    onHidePanel: function (a) {
        Ext.destroy(this.touchListeners)
    },
    doDestroy: function () {
        Ext.destroy(this.touchListeners);
        Ext.Panel.prototype.doDestroy.call(this)
    }
}, 0, 0, ['widget', 'component', 'container', 'panel'], {
    'widget': !0,
    'component': !0,
    'container': !0,
    'panel': !0
}, 0, 0, [IMCommon.view.panel, 'hidePanel'], 0);
Ext.cmd.derive('PushIM.Webapp.util.User', Ext.Base, {
    alternateClassName: 'User',
    singleton: !0,
    erpSession: '',
    erpToken: '',
    accURL: '',
    accountID: '',
    token: '',
    ownerID: '',
    userInfos: {},
    allUsers: [],
    organization: [],
    allStatus: {},
    allOthers: [],
    crtUser: {},
    allChannels: [],
    preferences: [],
    files: [],
    lastChatId: '',
    crtChannelId: '',
    crtChannelType: '',
    crtChatStatus: 0,
    crtSelUserId: '',
    useReceipt: '',
    crtChatMembers: [],
    isPlus: !0,
    detailByOrg: {},
    grpChgInfo: [],
    rightTitle: '',
    devType: '',
    isFirstCon: !0,
    isFirstConRct: !0,
    canScrol: {},
    canScrolEnd: {},
    unReadPic: [],
    unReadFile: [],
    difTime: 0,
    settings: '',
    StatusIvl: 120,
    statusIDs: [],
    chatCache: {},
    cacheMil: 0,
    favChats: [],
    orgView: !0,
    defSelUsers: [],
    unReadNum: {},
    orgHash: '',
    revokeMsgs: {},
    manualLogin: !1,
    progressBFiles: {},
    waitBFiles: {},
    isMainFormActive: 'Y',
    isWholeRest: !1,
    wholeRestInvl: null,
    popupChat: {},
    draggingChat: !1,
    replyMsg: null,
    firstIntoOrg: !0,
    crtCorpID: null,
    grpOrgs: [],
    PcCacheMidWidth: 242,
    clear: function () {
        var a = LocalDataMgr.getDB();
        if (a) {
            if (a.abortAllPendingTransactions) {
                a.abortAllPendingTransactions();
                a.close(function () {}, function () {
                    console.log('关闭数据库的时候，弹出框有东西锁住了')
                })
            }
        }
        User.erpSession = '';
        User.erpToken = '';
        User.accURL = '';
        User.accountID = '';
        User.token = '';
        User.ownerID = '';
        User.userInfos = {};
        User.allUsers = [];
        User.organization = [];
        User.allStatus = {};
        User.allOthers = [];
        User.crtUser = {};
        User.allChannels = [];
        User.preferences = [];
        User.files = [];
        User.crtChannelId = '';
        User.crtSelUserId = '';
        User.crtChatStatus = 0;
        User.crtChatMembers = [];
        User.isPlus = !0;
        User.detailByOrg = {};
        User.grpChgInfo = [];
        User.rightTitle = '';
        User.isFirstCon = !0;
        User.isFirstConRct = !0;
        User.devType = '';
        User.orgHash = '';
        User.crtChannelType = '';
        User.useReceipt = '';
        User.canScrol = {};
        User.unReadPic = [];
        User.unReadFile = [];
        User.difTime = 0;
        User.settings = '';
        User.StatusIvl = 120;
        User.statusIDs = [];
        User.chatCache = {};
        User.cacheMil = 0;
        User.favChats = [];
        User.orgView = !0;
        User.defSelUsers = [];
        User.unReadNum = {};
        User.revokeMsgs = {};
        User.manualLogin = !1;
        User.progressBFiles = {};
        User.waitBFiles = {};
        User.isMainFormActive = 'Y';
        DesktopChatUtil.setWholeRest(!1);
        User.isWholeRest = !1;
        if (!Ext.isEmpty(User.wholeRestInvl)) {
            clearInterval(User.wholeRestInvl);
            User.wholeRestInvl = null
        }
        User.popupChat = {};
        User.draggingChat = !1;
        User.replyMsg = null;
        User.isOpenFileMgr = !1;
        User.crowdInfo = {};
        User.firstIntoOrg = !0;
        User.PcCacheMidWidth = 242;
        User.crtCorpID = null;
        User.grpOrgs = []
    },
    getComPrefix: function () {
        return this.accountID + '/' + this.ownerID
    },
    getThumbDir: function () {
        if (Ext.isEmpty(this.ownerID)) {
            throw new Error('User.ownerID 为空')
        }
        return this.getComPrefix() + '/thumbs/'
    },
    getUserAvaDir: function () {
        if (Ext.isEmpty(this.ownerID)) {
            throw new Error('User.ownerID 为空')
        }
        return this.getComPrefix() + '/avatars/users/'
    },
    getUserAvaCrowd: function () {
        if (Ext.isEmpty(this.ownerID)) {
            throw new Error('User.ownerID 为空')
        }
        return this.getComPrefix() + '/avatars/chatc/'
    },
    getChatAvaDir: function (a) {
        if (Ext.isEmpty(this.ownerID)) {
            throw new Error('User.ownerID 为空')
        }
        a = Ext.Number.parseInt(a);
        if (Ext.isEmpty(a) || a <= 0) {
            a = (new Date()).getTime()
        }
        var b = ParseUtil.getTimeMStr(a);
        return this.getComPrefix() + '/avatars/' + b
    },
    getImageDir: function () {
        if (Ext.isEmpty(this.ownerID)) {
            throw new Error('User.ownerID 为空')
        }
        return this.getComPrefix() + '/images/'
    },
    getFileDir: function () {
        if (Ext.isEmpty(this.ownerID)) {
            throw new Error('User.ownerID 为空')
        }
        return this.getComPrefix() + '/files/'
    },
    getUserInfo: function (d, b, a, c) {
        var e = this;
        Utils.custAjax('get', 'users/' + d, {
            success: function (f) {
                if (ConfigMgr.isAio8()) {
                    var g = f.roles;
                    try {
                        g = JSON.stringify(f.roles)
                    } catch (h) {}
                    f.organizations = g
                }
                if (b) {
                    b(f)
                }
                LocalDataMgr.updateUserInfo(f);
                User.userInfos[f.user_id] = f;
                e.needUpdateUserAva(f.user_id, f.avatar_hash, c)
            },
            failure: function (e) {
                if (a) {
                    a(e)
                }
            }
        })
    },
    doUpdateUserAva: function (a, c, b) {
        var d = User.getUserAvaDir() + a + '.png';
        FileMgr.exists(null, d).then(function (e) {
            if (e) {
                FileMgr.remove(null, d).then(function () {
                    User.doDownUserAva(a, c, b)
                })['catch'](function (d) {
                    console.error('doUpdateUserAva', 'remove failed', d)
                })
            } else {
                User.doDownUserAva(a, c, b)
            }
        })
    },
    needUpdateUserAva: function (a, c, b) {
        LocalDataMgr.needUpdateUserAva(a, c, function (f) {
            if (f) {
                var d = User.getUserAvaDir() + a + '.png';
                FileMgr.exists(null, d).then(function (e) {
                    if (e) {
                        FileMgr.remove(null, d).then(function () {
                            User.doDownUserAva(a, c, b)
                        })['catch'](function (d) {
                            console.error('needUpdateUserAva', 'remove failed', d)
                        })
                    } else {
                        User.doDownUserAva(a, c, b)
                    }
                })
            } else {
                User.cacheMil = (new Date()).getTime();
                var e = AvatarMgr.getNavUserAvaUrl(a);
                if (b) {
                    b(e)
                }
            }
        })
    },
    doDownUserAva: function (a, b, c) {
        var d = this;
        AvatarMgr.downUserAva(a, 0, b, function (e) {
            if (Config.isPC) {
                e = ParseUtil.getLocalFileURL(e)
            } else {
                User.cacheMil = (new Date()).getTime()
            }
            if (window.cefMain) {
                d.refreshRct(a);
                d.refreshOrg(a);
                if (a == User.ownerID) {
                    if (window.reloadAva) {
                        window.reloadAva(b)
                    } else {
                        User.cacheMil = (new Date()).getTime();
                        User.crtUser.avatar_hash = b;
                        ViewGet.getIMViewmodel().set({
                            'avatar': ['<div style="padding-left: 12px;margin-bottom: 24px;">', AvatarMgr.getUserAvaHtml(User.ownerID, b, !1, !0), '</div>'].join('')
                        })
                    }
                }
            }
            e = e + '?' + User.cacheMil;
            if (c) {
                c(e)
            }
        })
    },
    refreshRct: function (b) {
        var a = Ext.getStore('comRct').findRecord('avaID', b, 0, !1, !0, !0);
        if (a) {
            a.set({
                avaRefresh: (new Date()).getTime()
            })
        }
    },
    refreshOrg: function (a) {
        User.cacheMil = (new Date()).getTime();
        ViewGet.getSecOrgView().refresh()
    },
    needUpdateChatAva: function (a, d, c, b) {
        LocalDataMgr.needUpdateChatAva(a, c, function (g) {
            if (g) {
                var e = User.getChatAvaDir(d) + a + '.png';
                FileMgr.exists(null, e).then(function (f) {
                    if (f) {
                        FileMgr.remove(null, e).then(function () {
                            User.doDownChatAva(a, d, c, b)
                        })
                    } else {
                        User.doDownChatAva(a, d, c, b)
                    }
                })
            } else {
                User.cacheMil = (new Date()).getTime();
                var f = AvatarMgr.getNavChatAvaUrl(a);
                if (b) {
                    b(f)
                }
            }
        })
    },
    doDownChatAva: function (d, c, b, a) {
        AvatarMgr.downChatAva(d, c, b, function (e) {
            User.cacheMil = (new Date()).getTime();
            if (Config.isPC) {
                e = ParseUtil.getLocalFileURL(e)
            }
            e = e + '?' + User.cacheMil;
            if (a) {
                a(e)
            }
        })
    },
    needUpdateCrowdAva: function (a, d, c, b) {
        LocalDataMgr.needUpdateChatAva(a, c, function (h) {
            if (h) {
                var e = User.getUserAvaCrowd() + a + '.png';
                FileMgr.exists(null, e).then(function (f) {
                    if (f) {
                        FileMgr.remove(null, e).then(function () {
                            User.doDownCrowdAva(a, d, c, b)
                        })
                    } else {
                        User.doDownCrowdAva(a, d, c, b)
                    }
                })
            } else {
                User.cacheMil = (new Date()).getTime();
                var g = AvatarMgr.getNavCrowdUrl(a, d);
                var f = !1;
                if (b) {
                    b(g, f)
                }
            }
        })
    },
    doDownCrowdAva: function (d, c, b, a) {
        AvatarMgr.downCrowdAva(d, c, b, function (e) {
            User.cacheMil = (new Date()).getTime();
            if (Config.isPC) {
                e = ParseUtil.getLocalFileURL(e)
            }
            e = e + '?' + User.cacheMil;
            var f = !0;
            if (a) {
                a(e, f)
            }
        })
    },
    getUserInfoByCache: function (a) {
        return User.userInfos[a]
    },
    getUserName: function (b) {
        var a = '';
        if (User.userInfos[b]) {
            a = User.userInfos[b].user_name
        }
        return a
    },
    pushUserInfo: function (b) {
        User.userInfos = {};
        for (var a = 0; a < b.length; a++) {
            var c = b[a].user_id;
            User.userInfos[c] = b[a]
        }
    },
    getFavChat: function (c) {
        var b = User.favChats;
        for (var a = 0; a < b.length; a++) {
            if (b[a].chat_id == c) {
                return b[a]
            }
        }
    },
    updateUserCache: function (c, b) {
        User.userInfos[c] = b;
        for (var a = 0; a < User.allUsers.length; a++) {
            if (c == User.allUsers[a].user_id) {
                User.allUsers[a] = b;
                break
            }
        }
    },
    getServiceInfo: function (a) {
        return {
            avatar_hash: a.AvatarHash,
            custom_mark: a.CustomMark,
            def_role_id: a.DefRoleID,
            def_role_name: a.DefRoleName,
            email: a.Email,
            mobile: a.Mobile,
            notes: a.Notes,
            phone: a.Phone,
            org_ids: a.OrgIDs,
            role_ids: a.RoleIDs,
            role_names: a.RoleNames,
            sex: a.Sex,
            user_id: a.UserID,
            user_name: a.UserName,
            org_names: a.OrgNames || ''
        }
    },
    hasProgressBFile: function (a) {
        var b = User.progressBFiles;
        if (b[a]) {
            return !0
        }
        return !1
    },
    pushBFileToProgress: function (a) {
        User.progressBFiles[a] = !0
    },
    removeBFileFromProgress: function (a) {
        delete User.progressBFiles[a]
    },
    hasWaitBFile: function (a) {
        if (User.waitBFiles[a]) {
            return !0
        }
        return !1
    },
    pushBFileToWait: function (a) {
        User.waitBFiles[a] = !0
    },
    removeBFileFromWait: function (a) {
        delete User.waitBFiles[a]
    }
}, 0, 0, 0, 0, 0, 0, [PushIM.Webapp.util, 'User', 0, 'User'], 0);
Ext.cmd.derive('PushIM.Webapp.view.login.LoginController', Ext.app.ViewController, {
    isFirst: !0,
    isManual: !1,
    onChgPwd: function (b, a, e, f) {
        if (!this.isManual) {
            this.isManual = !0;
            var c = a.length - e.length;
            var d = c > 0 ? a.substr(-1 * c) : a;
            b.setValue(d);
            b.setInputValue(d)
        }
    },
    init: function () {
        var a = this;
        Ext.app.ViewController.prototype.init.apply(this, arguments);
        if (Ext.os.is.Phone) {
            if (!Ext.Viewport.remindUpdate) {
                IMHelper.updateApp(!0);
                Ext.Viewport.remindUpdate = !0
            }
        }
        var b = a.lookup('form');
        var c = new Ext.util.KeyMap({
            target: b.element,
            key: 13,
            handler: function () {
                a.onEnterLogin()
            },
            scope: a
        })
    },
    onEnterLogin: function () {
        var c = this;
        var a = this.lookup('btnLogin');
        var b = a.getDisabled();
        if (!b) {
            c.onLoginTap()
        }
    },
    onLoginTap: function () {
        this.fireEvent('beforeLogin');
        if (!Config.httpUrlForGo) {
            Utils.toastLong('尚未设置账套');
            return !1
        }
        var a = this,
            j = a.lookup('btnLogin'),
            c = a.lookup('form'),
            b = c.getValues();
        a.isFirst = !0;
        if (c.validate()) {
            var d = a.fireEvent('pcIsLogin', b.userId);
            if (d) {
                Utils.toastShort('您已登录，请退出后再登录');
                return
            }
            var h = a.getDevID(),
                e = a.getPlatform(),
                f = a.getDevType(),
                i = a.getPwd(b.userId, b.password),
                g = a.getLocalIp();
            c.setReadOnly(!0);
            Utils.mask(Ext.Viewport, '正在登录');
            a.doLogin({
                user_id: b.userId,
                password: i,
                device_id: h,
                device_type: f,
                platform: e,
                app_id: Config.appID,
                client_version: Utils.getApp().versionName,
                local_ip: g
            }, c)
        }
    },
    doLogin: function (d, e) {
        var a = this;
        var f = e.getValues();
        var g = window.VerControll.getAvailableLogin(),
            b, c;
        if (Config.newLoginWays) {
            if (Config.isPC) {
                b = JSON.parse(cefMain.getCurrentRouteConfigJsonStr());
                c = b.IsDemo;
                a.fromRouteID = b.RouteID;
                if (c == 'Y') {
                    a.fromRouteID = b.DemoRouteID
                }
            } else {
                b = Ext.decode(localStorage.getItem('currentRoute'));
                c = b.isDemo;
                a.fromRouteID = b.routeID;
                if (c == 'Y') {
                    a.fromRouteID = b.demoRouteID
                }
            }
        }
        Utils.custAjax('post', g, {
            params: JSON.stringify(d),
            success: function (b) {
                a.currentRouteID = null;
                User.manualLogin = !0;
                var c = a.fireEvent('compareServerVersion', b.server_version);
                if (c) {
                    a.fireEvent('setMainCache', b);
                    Utils.unMask(Ext.Viewport);
                    if (a.newRoute && Config.newLoginWays) {
                        if (Config.isPC) {
                            cefMain.selectRoute(a.newRoute.routeID, function (a) {
                                console.log(a)
                            })
                        } else {
                            window.RouteList.updateCurRoute(a.newRoute);
                            localStorage.setItem('newServerUrl', a.newRoute.routeUrl)
                        }
                    }
                    if (!0) {
                        if (Config.isPC) {
                            cefMain.addLogin(f.userId, d.password, JSON.stringify(b.session), b.user.user_name, function (a) {})
                        } else {
                            if (Config.isPad || Ext.os.is.Tablet) {
                                localStorage.setItem('r', Ext.encode(b))
                            }
                        }
                        localStorage.setItem('USERID', f.userId);
                        localStorage.setItem('PASSWORD', d.password)
                    }
                    a.fireEvent('initBuildDB')
                } else {
                    Utils.toastShort('服务器版本低，请联系管理员或者切换其他账套')
                }
            },
            failure: function (f) {
                if (Config.newLoginWays) {
                    var b = window.RouteList.nextRoute(a.currentRouteID || a.fromRouteID, c, a.fromRouteID);
                    if (b) {
                        a.currentRouteID = b.routeID;
                        a.newRoute = b;
                        Config.httpUrlForGo = Utils.joinPath(b.routeUrl, 'api/v1/');
                        Config.wsGoUrl = Utils.joinPath(b.routeUrl.replace('http', 'ws'), 'api/v1/websocket');
                        Utils.mask(Ext.Viewport, '切换线路' + a.newRoute.routeID);
                        setTimeout(function () {
                            a.doLogin(d, e)
                        }, 100)
                    }
                } else {
                    a.currentRouteID = null;
                    if (!f) {
                        f = '连接失败，请更换账套或联系管理员'
                    }
                    Utils.toastShort(f);
                    Utils.unMask(Ext.Viewport)
                }
            },
            callback: function () {
                e.setReadOnly(!1)
            },
            needUpdate: function (b) {
                a.fireEvent('needUpdate', b)
            }
        })
    },
    getPwd: function (h, e) {
        var b = '';
        if (Config.isPC) {
            if (this.isManual) {
                b = cefMain.getEncryptPassword(h, e)
            } else {
                var a;
                if (Config.newLoginWays) {
                    var c = JSON.parse(cefMain.getCurrentRouteConfigJsonStr());
                    if (c.IsDemo == 'Y') {
                        a = c.DemoUser
                    } else {
                        a = c.User
                    }
                } else {
                    var f = JSON.parse(cefMain.getLoginConfigJsonStr());
                    a = f.CurrentAccount.User
                }
                if (a) {
                    b = a.Password
                }
            }
        } else {
            if (this.isManual) {
                var d = new JSEncrypt();
                var g = '-----BEGIN PUBLIC KEY-----\n            MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQDOCcYEgKyE/3IVysNo+lI/JdaK\n            /olvVLWx9lDrG2PTbx9iPlnP8DB4AX2g9ATk0hWUzXjZ0xhqvN1onj1/oRneaq4Z\n            8/O7LHGxOzuKc2KbIkZM8dxfGIoHuR4flzhvanmbRicqIH8j5i9ZBP2vkXMREW5i\n            h/Cuqo8HidWmNoBZNwIDAQAB\n            -----END PUBLIC KEY-----';
                d.setPublicKey(g);
                b = d.encrypt(e)
            } else {
                b = localStorage.getItem('PASSWORD')
            }
        }
        return b
    },
    getDevID: function () {
        var a = '';
        if (Config.isPC) {
            a = cefMain.getDeviceID()
        } else {
            if (Ext.browser.is.Cordova) {
                a = device.uuid
            } else {
                a = Utils.getLsItem('deviceuuid')
            }
        }
        return a
    },
    getPlatform: function () {
        var a = 'Phone';
        if (Config.isPC) {
            a = 'PC'
        } else {
            if (Config.isPhone) {
                a = 'Phone'
            } else {
                if (Config.isPad || Ext.os.is.Tablet) {
                    a = 'Pad'
                }
            }
        }
        return a
    },
    getDevType: function () {
        var a = 'M';
        if (Config.isPC) {
            a = 'P'
        } else {
            if (Config.isPhone) {
                a = 'M'
            } else {
                if (Config.isPad || Ext.os.is.Tablet) {
                    a = 'D'
                }
            }
        }
        return a
    },
    getLocalIp: function () {
        var a = '';
        if (Config.isPC) {
            a = DesktopChatUtil.getCefObj().localIP
        }
        return a
    },
    loginClose: function () {
        if (window.cefMain) {
            window.cefMain.close()
        }
    },
    loginMax: function () {
        if (window.cefMain) {
            window.cefMain.max()
        }
    },
    loginMin: function () {
        if (window.cefMain) {
            window.cefMain.min()
        }
    },
    onChangePwd: function () {
        Ext.Viewport.getController().sVWithOutDestroy('changepwd')
    },
    onSet: function () {
        Ext.Viewport.getController().sVWithOutDestroy('acSetting')
    },
    scanAccounts: function () {
        var a = this;
        Config.ChooseFile = 'Y';
        cordova.plugins.barcodeScanner.scan(function (b) {
            Config.ChooseFile = 'N';
            if (b.cancelled) {
                return
            }
            if (b.format == 'QR_CODE') {
                a.parseQRCode(b.text)
            }
        }, function (a) {
            Config.ChooseFile = 'N';
            Utils.alert('扫码错误: ' + a)
        }, {
            'showFlipCameraButton': !0
        })
    },
    parseQRCode: function (h) {
        if (Ext.isEmpty(h)) {
            return
        }
        var k = this,
            m = !1;
        if (h.substr(0, 5).toLowerCase() == 'host|') {
            var g = h.split('|'),
                l = g[1].toLowerCase();
            if (g.length >= 3 && l == 'aio') {
                m = !0;
                var f = [];
                var c = localStorage.getItem('accounts') ? Ext.decode(localStorage.getItem('accounts')) : [];
                for (var a = 2; a < g.length; a++) {
                    var b = g[a];
                    b = b.replace(/\n/g, '');
                    if (!b.startsWith('http')) {
                        b = 'https://' + b
                    }
                    if (b[b.length - 1] != '/') {
                        b = b + '/'
                    }
                    f.push(b)
                }
                if (f.length == 1) {
                    var d = f[0];
                    var e = !1;
                    for (var a = 0; a < c.length; a++) {
                        if (c[a].name == d) {
                            e = !0;
                            break
                        }
                    }
                    if (!e) {
                        c.push({
                            name: d
                        });
                        localStorage.setItem('accounts', Ext.encode(c))
                    }
                    k.changeServerConfig(d)
                } else {
                    var j = '';
                    for (var a = 0; a < f.length; a++) {
                        var d = f[a];
                        var e = !1;
                        for (var i = 0; i < c.length; i++) {
                            if (c[i].name == d) {
                                e = !0;
                                break
                            }
                        }
                        if (!e) {
                            c.push({
                                name: d
                            })
                        }
                        j = d
                    }
                    localStorage.setItem('accounts', Ext.encode(c));
                    k.changeServerConfig(j)
                }
            }
        }
    },
    changeServerConfig: function (a) {
        var b = 'wss';
        if (a) {
            localStorage.setItem('serverUrl', a);
            localStorage.setItem('isdemo', 'N');
            if (a.toLowerCase().startsWith('http://')) {
                b = 'ws'
            }
            var c = a.indexOf(':');
            if (c > -1) {
                Config.wsGoUrl = Utils.joinPath(b + a.substring(c), 'api/v1/websocket')
            } else {
                Config.wsGoUrl = Utils.joinPath(b + '://' + a, 'api/v1/websocket')
            }
            Config.httpUrlForGo = Utils.joinPath(a, 'api/v1/');
            Utils.toastShort('设置账套成功')
        }
    }
}, 0, 0, 0, 0, ['controller.authlogin'], 0, [PushIM.Webapp.view.login, 'LoginController'], 0);
Ext.cmd.derive('PushIM.Webapp.view.login.Login', Ext.Container, {
    controller: 'authlogin',
    viewModel: {
        data: {
            version: 'v1.0.0',
            loginIsHideBrowseTitle: !0,
            isHideLoginSet: !1,
            isHideScan: !0,
            isHideChgPwd: !1
        }
    },
    initialize: function () {
        var i = this.lookup('form');
        var f = '',
            b = '';
        var c = this;
        if (Config.isPC) {
            if (Config.newLoginWays) {
                var d = JSON.parse(cefMain.getCurrentRouteConfigJsonStr());
                var a;
                if (d.IsDemo == 'Y') {
                    a = d.DemoUser
                } else {
                    a = d.User
                }
            } else {
                var g = JSON.parse(cefMain.getLoginConfigJsonStr());
                a = g.CurrentAccount.User
            }
            if (a) {
                f = a.UserID;
                if (a.Password) {
                    b = '********'
                }
            }
        } else {
            f = localStorage.getItem('USERID');
            b = localStorage.getItem('PASSWORD');
            if (b) {
                b = '********'
            }
        }
        i.setValues({
            userId: f,
            password: b,
            remember: !0
        });
        c.lookup('password').onAfter('change', 'onChgPwd', c.getController());
        var h = Utils.getApp().versionName;
        var e = h.split('.');
        if (!Config.isPC && e.length > 3) {
            e.pop()
        }
        this.getViewModel().set('version', e.join('.'));
        if (window.cefMain) {
            this.getViewModel().set('loginIsHideBrowseTitle', !1)
        }
        if (Ext.os.is.Phone && !Config.newLoginWays) {
            this.getViewModel().setData({
                isHideScan: !1
            })
        }
        if (window.cordova) {
            StatusBar.styleDefault()
        }
        c.on({
            painted: 'onShowPage',
            beforehide: function () {
                if (window.cordova) {
                    StatusBar.styleLightContent()
                }
            },
            beforeshow: function () {
                if (window.cordova) {
                    StatusBar.styleDefault()
                }
            },
            scope: c
        })
    },
    onShowPage: function () {
        var a = this;
        window.VerControll.validServerVersion().then(function () {
            if (a) {
                a.getViewModel().setData({
                    isHideChgPwd: !1
                })
            }
        })
    },
    layout: 'hbox',
    cls: 'login-body',
    items: [{
        xtype: 'container',
        width: 500,
        cls: 'login-bg',
        bind: {
            hidden: '{loginIsHideBrowseTitle}'
        }
    }, {
        xtype: 'container',
        flex: 1,
        layout: 'vbox',
        items: [{
            xtype: 'container',
            layout: 'hbox',
            cls: 'loginImitateBrowse',
            bind: {
                hidden: '{loginIsHideBrowseTitle}'
            },
            height: 25,
            items: [{
                xtype: 'component',
                cls: 'loginDrag',
                flex: 1
            }, {
                xtype: 'button',
                ui: 'cefClose',
                docked: 'right',
                iconCls: 'im-common-close',
                handler: 'loginClose'
            }]
        }, {
            flex: 1,
            cls: 'auth-login',
            layout: {
                type: 'vbox',
                align: 'center',
                pack: 'center'
            },
            items: [{
                xtype: 'component',
                cls: 'auth-header',
                padding: '0 0 40 0',
                html: '<div class="login-title">普实AIO8专业版</div>',
                bind: {
                    hidden: '{loginIsHideBrowseTitle}'
                }
            }, {
                xtype: 'component',
                cls: 'mobile-header',
                layout: {
                    align: 'center',
                    pack: 'center'
                },
                html: '\n                <div class="wrapper">\n                    <div class="logo"></div>\n                </div>\n                ',
                bind: {
                    hidden: '{!loginIsHideBrowseTitle}'
                }
            }, {
                xtype: 'formpanel',
                reference: 'form',
                padding: '20px 40px',
                width: '100%',
                layout: 'vbox',
                cls: 'formNoDrag',
                items: [{
                    xtype: 'textfield',
                    reference: 'userId',
                    name: 'userId',
                    placeholder: '请输入用户编号',
                    autoComplete: !1,
                    userCls: 'input',
                    required: !0,
                    triggers: {
                        token: {
                            cls: 'icon-id-before',
                            side: 'left'
                        }
                    }
                }, {
                    xtype: 'passwordfield',
                    reference: 'password',
                    name: 'password',
                    placeholder: '请输入密码',
                    autoComplete: !1,
                    userCls: 'input',
                    required: !0,
                    triggers: {
                        token: {
                            cls: 'icon-pwd-before',
                            side: 'left'
                        }
                    }
                }, {
                    xtype: 'button',
                    reference: 'btnLogin',
                    userCls: 'btnLogin',
                    text: '登录',
                    handler: 'onLoginTap',
                    ui: 'action',
                    bind: {
                        disabled: '{!password.value||!userId.value}'
                    }
                }, {
                    xtype: 'container',
                    layout: 'hbox',
                    items: [{
                        xtype: 'component',
                        flex: 1
                    }, {
                        xtype: 'button',
                        ui: 'flat',
                        userCls: 'modify-password',
                        text: '修改密码',
                        handler: 'onChangePwd'
                    }, {
                        xtype: 'component',
                        userCls: 'seperator'
                    }, {
                        xtype: 'button',
                        ui: 'flat',
                        userCls: 'set-account',
                        text: '账套设置',
                        handler: 'onSet'
                    }, {
                        xtype: 'component',
                        flex: 1
                    }]
                }, {
                    xtype: 'component',
                    name: 'isSignin',
                    html: '您已登录，不能重复登录',
                    hidden: !0
                }]
            }]
        }, {
            xtype: 'component',
            flex: 0
        }, {
            xtype: 'component',
            userCls: 'bottominset login-bottom',
            bind: {
                html: '<div class="slogan">普实沟通办公一体化</div>'
            }
        }]
    }]
}, 0, ['authlogin'], ['widget', 'component', 'container', 'authlogin'], {
    'widget': !0,
    'component': !0,
    'container': !0,
    'authlogin': !0
}, ['widget.authlogin'], 0, [PushIM.Webapp.view.login, 'Login'], 0);
Ext.cmd.derive('PushIM.Webapp.view.viewport.ViewportController', Ext.app.ViewController, {
    listen: {
        controller: {
            '*': {
                needlogin: 'onNeedLogin',
                login: 'onLogin',
                logout: 'onLogout',
                doLogout: 'doLogout',
                onBack: null,
                unauthorized: 'doUnauthorized',
                needUpdate: 'needUpdate'
            },
            'authlogin': {
                pcIsLogin: 'pcIsLogin',
                pcSetIsLogin: 'pcSetIsLogin',
                setMainCache: 'setMainCache',
                initBuildDB: 'initBuildDB',
                compareServerVersion: 'compareServerVersion',
                beforeLogin: 'beforeLogin'
            }
        }
    },
    routes: {
        '': 'mainEntrance',
        'msgMgr': 'showMsgMgr',
        'setting': 'showCSetting',
        'userSelector': 'showUserSelector',
        'useredit': 'showUserEdit',
        'chat': 'showOutChat',
        'crowd': 'crowdShowSet',
        'fileMgr': 'showmyFile'
    },
    showMsgMgr: function () {
        this.showCEFOut('cefMsgMgr')
    },
    showmyFile: function () {
        this.showCEFOut('ceffilemgr')
    },
    showCSetting: function () {
        this.showCEFOut('settingMainView')
    },
    crowdShowSet: function () {
        this.showCEFOut('crowdset')
    },
    showUserEdit: function () {
        this.showCEFOut('useredit')
    },
    showUserSelector: function () {
        this.showCEFOut('userSel')
    },
    showOutChat: function () {
        this.showCEFOut('cefOneChat')
    },
    showCEFOut: function (a) {
        var b = this;
        Ext.Package.load('IMCef').then(function () {
            Ext.getBody().removeCls('launching');
            b.showView(a)
        })['catch'](function (b) {
            console.error(b);
            Utils.toastShort(b)
        })
    },
    onLaunch: function () {
        var a = Ext.History.getToken();
        if (!a) {
            Ext.getBody().removeCls('launching');
            this.mainEntrance()
        }
    },
    mainEntrance: function () {
        var a = this;
        if (Config.isPC) {
            a.showPCWithSession()
        } else {
            var b = this.getView();
            b.add({
                xtype: 'launchpic'
            });
            if (!Ext.Viewport.remindUpdate) {
                IMHelper.updateApp(!0);
                Ext.Viewport.remindUpdate = !0
            }
            a.showPhoneWithSession()
        }
    },
    showPCWithSession: function () {
        var j = this;
        var b, f, e;
        if (Config.newLoginWays) {
            var c = JSON.parse(cefMain.getCurrentRouteConfigJsonStr());
            if (c.IsDemo == 'Y') {
                b = c.DemoUser;
                f = c.DemoRouteUrl
            } else {
                b = c.User;
                f = c.RouteUrl
            }
            var e = c.Folder
        } else {
            var g = JSON.parse(cefMain.getLoginConfigJsonStr());
            b = g.CurrentAccount.User;
            e = g.CurrentAccount.AccountID;
            f = g.CurrentAccount.AccountName
        }
        this.chgConfigUrl(f);
        if (!b) {
            this.onNeedLogin();
            return
        }
        var a = b.Token;
        if (!a || a == 'undefined' || a == 'null') {
            this.onNeedLogin();
            return
        }
        a = JSON.parse(b.Token).token;
        var d = b.UserID,
            i = b.UserName,
            h = b.Password;
        if (!a || a == 'undefined' || a == 'null' || !d || d == 'undefined' || d == 'null' || !h || h == 'undefined' || h == 'null') {
            this.onNeedLogin();
            return
        }
        var k = this.pcIsLogin1(d, e);
        if (k) {
            this.onNeedLogin();
            return
        }
        ParseUtil.addLaunchDiv();
        User.token = a;
        User.ownerID = d;
        User.crtUser.user_name = i;
        User.accountID = e;
        User.devType = 'P';
        cefMain.setUserInfo(JSON.stringify({
            user_id: d,
            user_name: i,
            account_id: e,
            token: a
        }));
        Utils.aioAjax('get', 'version', {
            success: function (a) {
                window.VerControll.clear();
                window.VerControll.compareClientAndServer(a);
                j.onLogin()
            },
            failure: function () {
                if (Config.appID == 'AIO') {
                    window.VerControll.clear();
                    window.VerControll.compareClientAndServer('1.0.0.186')
                }
                j.onLogin()
            }
        })
    },
    pcIsLogin1: function (b, a) {
        if (a && a != 'undefined' && a != 'null') {
            return cefMain.isLogin(a, b)
        }
        return !1
    },
    chgConfigUrl: function (a) {
        if (a && a.indexOf) {
            var b = 'wss';
            if (a.toLowerCase().startsWith('http://')) {
                b = 'ws'
            }
            var c = a.indexOf(':');
            if (c > -1) {
                Config.wsGoUrl = Utils.joinPath(b + a.substring(c), 'api/v1/websocket')
            } else {
                Config.wsGoUrl = Utils.joinPath(b + '://' + a, 'api/v1/websocket')
            }
            Config.httpUrlForGo = Utils.joinPath(a, 'api/v1/')
        } else {
            Config.httpUrlForGo = Config.httpPdcGoUrl;
            Config.wsGoUrl = Config.wsPdcUrl
        }
    },
    showPadWithSession: function () {
        var a = Ext.decode(localStorage.getItem('r')),
            f = localStorage.getItem('AccountID'),
            e = localStorage.getItem('serverUrl'),
            j = localStorage.getItem('isdemo'),
            c = localStorage.getItem('USERID'),
            d = localStorage.getItem('PASSWORD'),
            g = Ext.decode(localStorage.getItem('users'));
        this.chgConfigUrl(e);
        if (!a) {
            this.onNeedLogin();
            return
        }
        var b = a.session.token;
        if (!b || b == 'undefined' || b == 'null' || !c || c == 'undefined' || c == 'null' || !d || d == 'undefined' || d == 'null') {
            this.onNeedLogin();
            return
        }
        this.onNeedLogin();
        User.token = b;
        User.ownerID = c;
        User.crtUser = g;
        User.accountID = f;
        User.allUsers = Ext.decode(localStorage.getItem('allusers'));
        User.organization = Ext.decode(localStorage.getItem('orgs'));
        User.erpSession = a.erp_session;
        User.accURL = a.aio7_url;
        User.devType = a.session.device_type;
        var i = (new Date()).getTime();
        User.difTime = i - a.login_time;
        if (a.status_interval) {
            User.StatusIvl = a.status_interval
        }
        var h = a.user;
        User.crtUser = h;
        this.pushLocalOrgToCache()
    },
    showPhoneWithSession: function () {
        var f = this;
        var d = localStorage.getItem('imSession'),
            g = localStorage.getItem('AccountID'),
            c = localStorage.getItem('serverUrl'),
            b = localStorage.getItem('USERID'),
            e = localStorage.getItem('PASSWORD'),
            h = localStorage.getItem('isdemo');
        if (Config.newLoginWays) {
            c = localStorage.getItem('newServerUrl')
        }
        this.chgConfigUrl(c);
        if (!d) {
            this.onNeedLogin();
            return
        }
        var a = this.getComAutoData(JSON.parse(d), b, e);
        if (!a.token || a.token == 'undefined' || a.token == 'null' || !b || !e) {
            this.onNeedLogin();
            return
        }
        User.token = a.token;
        User.ownerID = b;
        User.accountID = g;
        User.devType = 'M';
        User.son = a;
        Utils.aioAjax('get', 'version', {
            success: function (a) {
                window.VerControll.clear();
                window.VerControll.compareClientAndServer(a);
                f.onLogin()
            },
            failure: function () {
                if (Config.appID == 'AIO') {
                    window.VerControll.clear();
                    window.VerControll.compareClientAndServer('1.0.0.186')
                }
                f.onLogin()
            }
        })
    },
    autoLogin: function () {
        this.beforeLogin();
        var c = '';
        if (Config.isPC) {
            var b;
            if (Config.newLoginWays) {
                var d = JSON.parse(cefMain.getCurrentRouteConfigJsonStr());
                if (d.IsDemo == 'Y') {
                    b = d.DemoUser
                } else {
                    b = d.User
                }
            } else {
                var f = JSON.parse(cefMain.getLoginConfigJsonStr());
                b = f.CurrentAccount.User
            }
            if (b) {
                c = b.UserID
            }
        } else {
            c = localStorage.getItem('USERID')
        }
        var a = this,
            g = a.pcIsLogin(c);
        a.onNeedLogin();
        if (g) {
            return
        }
        if (Config.isPC) {
            a.doPCAutologin()
        } else {
            var e = localStorage.getItem('imSession'),
                c = localStorage.getItem('USERID'),
                h = localStorage.getItem('PASSWORD');
            if (e && e != 'undefined') {
                var i = a.getComAutoData(JSON.parse(e), c, h);
                Utils.mask(Ext.Viewport, '正在登录');
                Utils.custAjax('post', 'users/autologin', {
                    params: JSON.stringify(i),
                    success: function (b) {
                        var c = !0;
                        if (b.server_version) {
                            c = a.compareServerVersion(b.server_version)
                        }
                        if (c) {
                            a.setMainCache(b);
                            a.initBuildDB(b)
                        } else {
                            Utils.toastShort('服务器版本低，请联系管理员或者切换其他账套')
                        }
                    },
                    failure: function (b) {
                        Utils.toastShort(b);
                        a.onNeedLogin()
                    },
                    needUpdate: function (b) {
                        a.needUpdate(b)
                    }
                })
            }
        }
    },
    doPCAutologin: function () {
        var d = this;
        var a;
        if (Config.newLoginWays) {
            var f = JSON.parse(cefMain.getCurrentRouteConfigJsonStr());
            if (f.IsDemo == 'Y') {
                a = f.DemoUser
            } else {
                a = f.User
            }
        } else {
            var g = JSON.parse(cefMain.getLoginConfigJsonStr());
            a = g.CurrentAccount.User
        }
        var e = '',
            c = '',
            b = '';
        if (a) {
            e = a.Token;
            c = a.UserID;
            b = a.Password
        }
        if (!e || e == 'undefined' || e == 'null' || !c || c == 'undefined' || c == 'null' || !b || b == 'undefined' || b == 'null') {
            return
        }
        var h = d.getComAutoData(JSON.parse(e), c, b);
        Utils.mask(Ext.Viewport, '正在登录');
        Utils.custAjax('post', 'users/autologin', {
            params: JSON.stringify(h),
            success: function (a) {
                cefMain.addLogin(c, b, JSON.stringify(a.session), a.user.user_name, function (b) {});
                var e = !0;
                if (a.server_version) {
                    e = d.compareServerVersion(a.server_version)
                }
                if (e) {
                    d.setMainCache(a);
                    d.initBuildDB(a)
                } else {
                    Utils.toastShort('服务器版本低，请联系管理员或者切换其他账套')
                }
            },
            failure: function (a) {
                Utils.toastShort(a);
                d.onNeedLogin()
            },
            needUpdate: function (a) {
                d.needUpdate(a)
            }
        })
    },
    beforeLogin: function () {
        if (Config.isPC) {
            var a = '';
            if (Config.newLoginWays) {
                var c = JSON.parse(cefMain.getCurrentRouteConfigJsonStr());
                if (c.IsDemo == 'Y') {
                    a = c.DemoRouteUrl
                } else {
                    a = c.RouteUrl
                }
            } else {
                var b = JSON.parse(cefMain.getLoginConfigJsonStr());
                if (b.IsDemo == 'Y') {
                    a = b.DemoAccount.AccountName
                } else {
                    a = b.CurrentAccount.AccountName
                }
            }
            this.cefChangeConfig(a)
        }
    },
    cefChangeConfig: function (f) {
        if (!f) {
            Config.httpUrlForGo = Config.httpPdcGoUrl;
            Config.wsGoUrl = Config.wsPdcUrl
        } else {
            var c = 'wss';
            var a;
            if (Config.newLoginWays) {
                var b = JSON.parse(cefMain.getCurrentRouteConfigJsonStr());
                if (b.IsDemo == 'Y') {
                    a = b.DemoRouteUrl
                } else {
                    a = b.RouteUrl
                }
            } else {
                var e = JSON.parse(cefMain.getLoginConfigJsonStr());
                a = e.CurrentAccount.AccountName
            }
            if (a && a.indexOf) {
                if (a.toLowerCase().startsWith('http://')) {
                    c = 'ws'
                }
                var d = a.indexOf(':');
                if (d > -1) {
                    Config.wsGoUrl = Utils.joinPath(c + a.substring(d), 'api/v1/websocket')
                } else {
                    Config.wsGoUrl = Utils.joinPath(c + '://' + a, 'api/v1/websocket')
                }
                Config.httpUrlForGo = Utils.joinPath(a, 'api/v1/')
            }
        }
    },
    getComAutoData: function (a, e, d) {
        var b = '';
        if (Config.isPC) {
            b = DesktopChatUtil.getCefObj().localIP
        }
        var c = {
            user_id: a.user_id,
            device_id: a.device_id,
            device_type: a.device_type,
            app_id: a.app_id,
            token: a.token,
            platform: a.platform
        };
        c.data = JSON.stringify({
            user_id: e,
            password: d,
            client_version: Utils.getApp().versionName,
            local_ip: b
        });
        return c
    },
    compareServerVersion: function (c) {
        if (c) {
            var d = Config.minVersion;
            var b = c.split('.');
            var a = d.split('.');
            if (b[0] != a[0]) {
                return this.compareIntStr(b[0], a[0])
            } else {
                if (b[1] != a[1]) {
                    return this.compareIntStr(b[1], a[1])
                } else {
                    if (b[2] != a[2]) {
                        return this.compareIntStr(b[2], a[2])
                    } else {
                        if (b[3] != a[3]) {
                            return this.compareIntStr(b[3], a[3])
                        }
                    }
                }
            }
        }
        return !1
    },
    compareIntStr: function (a, b) {
        var c = parseInt(a, 10);
        var d = parseInt(b, 10);
        if (c >= d) {
            return !0
        }
        return !1
    },
    needUpdate: function (a) {
        if (Config.isPC) {
            if (window.cefMain) {
                cefMain.showUpdatePrompt()
            }
        } else {
            Utils.toastLong('您的版本太低，请检查升级');
            IMHelper.updateApp(!1)
        }
    },
    setMainCache: function (a) {
        var b, c;
        if (Config.newLoginWays) {
            if (Config.isPC) {
                b = JSON.parse(cefMain.getCurrentRouteConfigJsonStr());
                c = b.Folder
            } else {
                b = JSON.parse(localStorage.getItem('currentRoute'));
                c = b.folder
            }
        }
        localStorage.setItem('imSession', JSON.stringify(a.session));
        User.erpSession = a.erp_session;
        User.erpToken = a.erp_token;
        User.accURL = a.aio7_url;
        User.token = a.session.token;
        User.devType = a.session.device_type;
        User.useReceipt = a.use_receipt;
        ConfigMgr.orgShowRoot = a.show_root_user;
        ConfigMgr.useAio8 = a.use_aio8;
        Config.aErp8Url = a.erp8_url;
        Config.aGrp8Url = a.grp8_url;
        Config.aio8ClientUrl = a.client_url;
        if (Config.newLoginWays) {
            User.accountID = c
        } else {
            User.accountID = window.RouteList.getAccIDByUrl()
        }
        var e = (new Date()).getTime();
        User.difTime = e - a.login_time;
        if (a.status_interval) {
            User.StatusIvl = a.status_interval
        }
        localStorage.setItem('AccountID', User.accountID);
        this.pcSetIsLogin(User.accountID);
        var d = a.user;
        localStorage.setItem('USERID', d.user_id);
        User.crtUser = d;
        User.ownerID = d.user_id;
        User.crtCorpID = a.corp_id;
        if (Config.isPC) {
            cefMain.setUserInfo(JSON.stringify({
                user_id: User.ownerID,
                user_name: User.crtUser.user_name,
                account_id: User.accountID,
                erp_session: User.erpSession,
                erp_token: User.erpToken,
                aio7_url: User.accURL,
                token: User.token,
                file_server: a.file_server,
                file_port: a.file_port,
                erp8_url: a.erp8_url,
                grp8_url: a.grp8_url,
                client_url: a.client_url,
                corp_id: a.corp_id
            }))
        } else {
            User.EAdatas = {
                appId: 'IM',
                userSign: User.ownerID,
                deviceId: Utils.getDeviceID(),
                sessionId: User.erpToken
            }
        }
    },
    initBuildDB: function () {
        var a = this;
        a.doBuildDB()
    },
    doBuildDB: function (b) {
        Utils.mask(Ext.Viewport, '初始化数据库');
        var a = this;
        InitDb.initDB(function () {
            LocalDataMgr.getOrgHash(function (c) {
                User.orgHash = c;
                if (Config.isPhone && !User.focusRefresh) {
                    User.orgHash = 'needRefresh';
                    c = 'needRefresh';
                    User.focusRefresh = !0
                }
                Utils.custAjax('get', 'users/all', {
                    success: function (e, h) {
                        if (h == '304') {
                            a.pushLocalOrgToCache(b)
                        } else {
                            var f = e.organizations,
                                d = e.users,
                                g = e.org_hash;
                            User.orgHash = g;
                            User.pushUserInfo(d);
                            User.allUsers = d;
                            User.organization = f;
                            if (Config.isPC) {
                                a.setCefCache()
                            } else {
                                if (Config.isPad || Ext.os.is.Tablet) {
                                    localStorage.setItem('allusers', Ext.encode(d));
                                    localStorage.setItem('orgs', Ext.encode(f));
                                    a.onLogin()
                                } else {
                                    if (Config.isPhone && User.manualLogin) {
                                        a.onLogin()
                                    }
                                }
                            }
                            if (b) {
                                b()
                            }
                            LocalDataMgr.initUpdateOrg(d, f, g)
                        }
                    },
                    failure: function () {
                        a.pushLocalOrgToCache()
                    },
                    callback: function () {
                        Utils.unMask(Ext.Viewport);
                        User.hasInitOrg = !0
                    }
                }, !1, '&org_hash=' + c)
            })
        })
    },
    doAppLogin: function () {
        var a = this;
        var b = localStorage.getItem('imSession'),
            e = localStorage.getItem('USERID'),
            c = localStorage.getItem('PASSWORD');
        if (b) {
            var d = this.getComAutoData(JSON.parse(b), e, c);
            Utils.custAjax('post', 'users/autologin', {
                params: JSON.stringify(d),
                success: function (b) {
                    var c = !0;
                    if (b.server_version) {
                        c = a.compareServerVersion(b.server_version)
                    }
                    if (c) {
                        a.setMainCache(b);
                        a.initBuildDB(b)
                    } else {
                        a.onNeedLogin();
                        Utils.toastShort('服务器版本低，请联系管理员或者切换其他账套')
                    }
                },
                failure: function (b) {
                    a.onNeedLogin();
                    Utils.toastShort(b)
                },
                needUpdate: function (b) {
                    a.onNeedLogin();
                    a.needUpdate(b)
                }
            })
        } else {
            this.onNeedLogin()
        }
    },
    pushLocalOrgToCache: function (b) {
        var a = this;
        LocalDataMgr.initGetOrg(function (c) {
            if (!c) {
                return
            }
            if (Config.isPC) {
                a.setCefCache()
            } else {
                if (Config.isPad || Ext.os.is.Tablet) {
                    localStorage.setItem('allusers', Ext.encode(User.allUsers));
                    localStorage.setItem('orgs', Ext.encode(User.organization));
                    a.onLogin()
                } else {
                    a.onLogin()
                }
            }
            if (b) {
                b()
            }
        })
    },
    setCefCache: function () {
        var a = this;
        Utils.custAjax('get', 'users/me/info', {
            success: function (b) {
                var f = JSON.stringify({
                    users: User.allUsers,
                    orgs: User.organization
                });
                var c = cefMain.getDataDirectory();
                c = ParseUtil.clearFileOfURL(c);
                b.settings.fileFolder = c;
                var g = ParseUtil.clearFileOfURL(cefMain.getDataDirectory()) + (User.accountID + '/' + User.ownerID + '/Worktop'),
                    a = cefMain.getSettingData(),
                    e, d;
                if (a) {
                    a = JSON.parse(a)
                }
                if (Config.isPC) {
                    e = a && a.work_folder ? a.work_folder.replace(/\\/g, '/') : g;
                    d = a && a.work_folder_show == '' ? 'Y' : a.work_folder_show
                }
                b.settings.work_folder = e;
                b.settings.work_folder_show = d;
                User.settings = b.settings;
                cefMain.setGeneralInfo(JSON.stringify({
                    org_data: f,
                    setting_data: JSON.stringify(b)
                }));
                User.settings = b.settings
            },
            failure: function () {
                var a = JSON.stringify({
                    users: User.allUsers,
                    orgs: User.organization
                });
                cefMain.setGeneralInfo(JSON.stringify({
                    org_data: a,
                    setting_data: ''
                }))
            },
            callback: function () {
                a.onLogin()
            }
        })
    },
    pcSetIsLogin: function (b) {
        if (Config.isPC) {
            var a = localStorage.getItem('cefLoginAcc');
            if (!a) {
                a = new Object()
            } else {
                a = JSON.parse(a)
            }
            a[Config.httpUrlForGo] = b;
            localStorage.setItem('cefLoginAcc', JSON.stringify(a))
        }
    },
    pcIsLogin: function (b, a) {
        if (!b || b == 'undefined' || b == 'null') {
            return !1
        }
        if (Config.isPC) {
            if (!a) {
                a = ParseUtil.parseAccID(Config.httpUrlForGo);
                if (Config.newLoginWays && Config.isPC) {
                    var c = JSON.parse(cefMain.getCurrentRouteConfigJsonStr());
                    a = c.Folder
                }
            }
            return cefMain.isLogin(a, b)
        }
        return !1
    },
    onLogin: function () {
        if (Config.isPC) {
            this.dynamicPkgLoad('IM')
        } else {
            if (Ext.os.is.Phone || Ext.os.is.Tablet) {
                InitDb.doFixVer();
                this.dynamicPkgLoad('IMMobile');
                if (navigator && navigator.connection) {
                    navigator.connection.ontypechange = this.onConnectChange
                }
                if (localStorage.isreceivenotify != 'N') {
                    PushNotification.regServer('Y')
                }
            } else {
                alert('屏幕未适配')
            }
        }
    },
    listenPhoneListeners: function () {
        var a = this;
        document.addEventListener('backbutton', Ext.Function.bind(a.onBackButton, a), !1);
        document.addEventListener('menubutton', Ext.Function.bind(a.onMenuButton, a), !1)
    },
    onBackButton: function () {
        var f = this;
        var d = f.backOneFloating();
        if (d) {
            return
        }
        var c = Ext.Viewport.lookup('IMMobile');
        if (c) {
            var a = c.getActiveItem();
            if (a.xtype == 'mainTabPanel') {
                a = a.getActiveItem()
            }
            if (a.getController) {
                var b = a.getController();
                if (b && b.onBack) {
                    var e = b.onBack();
                    if (!e) {
                        return
                    }
                }
            }
            if (!c.pop()) {
                if (mayflower) {
                    mayflower.moveTaskToBack()
                }
            }
        } else {
            var a = Ext.Viewport.getActiveItem();
            if (a.onBack) {
                a.onBack()
            } else {
                if (a.controller && a.controller.onBack) {
                    a.controller.onBack()
                } else {
                    if (mayflower) {
                        mayflower.moveTaskToBack()
                    }
                }
            }
        }
    },
    backOneFloating: function () {
        var a = !1;
        if (Ext.floatRoot) {
            Ext.each(Ext.floatRoot.query('.x-floated:not(.x-tooltip)'), function (c, d) {
                var b = Ext.getCmp(c.id);
                if (b) {
                    if (b.isHidden && b.isHidden()) {
                        return !1
                    }
                    if (b.onBack) {
                        b.onBack()
                    } else {
                        b.hide()
                    }
                    a = !0;
                    return !1
                }
            })
        }
        Ext.each(Ext.query('.imgcarouselviewer'), function (c, d) {
            var b = Ext.getCmp(c.id);
            if (b) {
                if (b.isHidden && b.isHidden()) {
                    return !1
                }
                if (b.onBack) {
                    b.onBack()
                } else {
                    b.hide()
                }
                a = !0;
                return !1
            }
        });
        return a
    },
    canShowMenu: !1,
    onMenuButton: function () {
        var a = this,
            b = a.actionsheet;
        if (!b.isComponent) {
            b.defaults = {
                handler: a.hideActionSheet,
                scope: a
            };
            b.listeners = {
                beforeshow: {
                    fn: a.onBeforeMenuButtonShow,
                    scope: a
                },
                hide: {
                    fn: a.onHideMenuButton,
                    scope: a
                }
            };
            b = a.actionsheet = Ext.Viewport.add(b)
        }
        a.canShowMenu = !0;
        b.show()
    },
    actionsheet: {
        xtype: 'actionsheet',
        items: [{
            text: '检查更新',
            handler: 'onMenuUpdateApp'
        }, {
            text: '注销',
            handler: 'actLogout',
            style: 'color:#2196f3;'
        }, {
            text: '退出',
            handler: 'onMenuExitApp',
            userCls: 'red',
            style: 'margin-bottom:15px;'
        }, {
            text: '取消'
        }]
    },
    actLogout: function () {
        var a = this;
        a.hideActionSheet();
        a.onLogout()
    },
    hideActionSheet: function () {
        this.actionsheet.hide()
    },
    onHideMenuButton: function () {
        this.canShowMenu = !1
    },
    onBeforeMenuButtonShow: function () {
        if (!this.canShowMenu) {
            return !1
        }
        var a = Ext.Viewport.lookup('IMMobile');
        if (a) {
            return a.getInnerItems().length == 1
        }
        return !0
    },
    onMenuExitApp: function () {
        this.actionsheet.hide();
        Ext.Msg.confirm('退出', '确定要退出AIO吗?', function (a) {
            if (a === 'yes') {
                navigator.app.exitApp()
            }
        })
    },
    onMenuUpdateApp: function () {
        this.actionsheet.hide();
        IMHelper.updateApp(!1)
    },
    onLineSwitch: function () {
        if (WebSocketUtil && !WebSocketUtil.conn || WebSocketUtil.conn.readyState === WebSocket.CLOSED) {
            WebSocketUtil.initialize(Config.wsGoUrl)
        }
    },
    onConnectChange: function () {
        if (Config.Connect == 'none' && navigator.connection.type != 'none') {
            if (WebSocketUtil && !WebSocketUtil.conn || WebSocketUtil.conn.readyState === WebSocket.CLOSED) {
                WebSocketUtil.initialize(Config.wsGoUrl)
            }
        }
        Config.Connect = navigator.connection.type
    },
    dynamicPkgLoad: function (b) {
        var c = this;
        var a = c.getView();
        if (Ext.Package.isLoaded(b)) {
            c.showView(b);
            Utils.unMask(a);
            if (navigator.splashscreen) {
                navigator.splashscreen.hide()
            }
        } else {
            if (window.cefMain) {
                var d = Utils.getCmp('loadmask', !0);
                if (d && !d.getHidden()) {
                    Utils.mask(a, '正在加载模块...')
                }
            } else {
                if (!Config.isPhone) {
                    Utils.mask(a, '正在加载模块...')
                }
            }
            Ext.Package.load(b).then(function () {
                c.showView(b);
                Utils.unMask(a);
                if (navigator.splashscreen) {
                    navigator.splashscreen.hide()
                }
            })['catch'](function (a) {
                if (navigator.splashscreen) {
                    navigator.splashscreen.hide()
                }
                Utils.toastShort('模块加载失败');
                c.doLogout();
                console.error(a)
            })
        }
    },
    onNeedLogin: function () {
        if (navigator.splashscreen) {
            navigator.splashscreen.hide()
        }
        this.showView('authlogin')
    },
    existedView: function (a) {
        var b = this.lookup(a);
        return b
    },
    showView: function (c) {
        var d = this;
        var b = d.getView();
        var a = d.existedView(c);
        if (!a) {
            b.removeAll(!0);
            a = b.add({
                xtype: c,
                reference: c
            })
        }
        ParseUtil.removeLaunchDiv();
        b.setActiveItem(a);
        return a
    },
    sVWithOutDestroy: function (b, f) {
        var c = this;
        var d = c.getView();
        var a = c.existedView(b),
            e = c.existedView(f);
        if (e) {
            e.hide()
        }
        if (!a) {
            a = d.add({
                xtype: b,
                reference: b
            })
        }
        a.show();
        d.setActiveItem(a);
        return a
    },
    bottom_menu: null,
    onLogout: function () {
        var a = this;
        if (Config.isPC) {
            Ext.Msg.show({
                title: '系统提示',
                message: '确定要退出登录吗?',
                buttons: Ext.MessageBox.OKCANCEL,
                defaultFoucs: '#ok',
                prompt: !1,
                cls: 'centered-dialog',
                fn: function (b) {
                    if (b == 'ok') {
                        a.doLogout()
                    }
                }
            })
        } else {
            a.bottom_menu = Ext.create('Ext.ActionSheet', {
                userCls: 'action-bottom bottominset',
                items: [{
                    text: '确定要退出登录吗?',
                    userCls: 'title bottom-border'
                }, {
                    text: '退出登录',
                    userCls: 'action bottom-border red',
                    handler: function () {
                        a.doLogout();
                        a.bottom_menu.destroy()
                    }
                }, {
                    userCls: 'seperator'
                }, {
                    text: '取消',
                    userCls: 'action'
                }],
                defaults: {
                    handler: function () {
                        a.bottom_menu.destroy()
                    },
                    scope: a
                }
            });
            a.bottom_menu.show()
        }
    },
    doLogout: function () {
        Utils.mask(Ext.Viewport, '正在注销');
        var a = this;
        Utils.custAjax('post', 'users/logout', {
            params: JSON.stringify(User.ownerID),
            success: function (a) {},
            failure: function (a) {
                Utils.toastShort(a)
            },
            callback: function () {
                if (window.cefMain) {
                    cefMain.logout(function () {
                        a.doReStart()
                    })
                } else {
                    if (Config.isPad || Ext.os.is.Tablet) {
                        a.doReStart()
                    } else {
                        a.doReStart()
                    }
                }
                try {
                    if (ConfigMgr.isAio8()) {
                        if (window.cordova && window.cordova.InAppBrowser && window.cordova.InAppBrowser.apploginout) {
                            window.cordova.InAppBrowser.apploginout()
                        }
                    }
                } catch (b) {}
            }
        })
    },
    doUnauthorized: function () {
        var a = this;
        Utils.mask(Ext.Viewport);
        if (window.cefMain) {
            cefMain.logout(function () {
                a.doReStart()
            })
        } else {
            if (window.cefChat) {
                console.log('cefChat这边的Unauthorized，还未做')
            } else {
                a.doReStart()
            }
        }
    },
    doReStart: function () {
        WebSocketUtil.close();
        User.clear();
        ChatUtil.clear();
        AtUtil.clear();
        DtPageCache.clear();
        Ext.StoreManager.removeAll();
        localStorage.removeItem('imSession');
        clearInterval(window.statusInterval);
        window.statusInterval = null;
        clearInterval(window.erpSenInterval);
        window.erpSenInterval = null;
        var a = this;
        if (window.cefMain) {
            cefMain.removeLogin(function (c) {
                var b = c.split('|');
                if (b[0] == 'true') {
                    a.onNeedLogin()
                } else {
                    Utils.toastShort(b[1])
                }
                Utils.unMask(Ext.Viewport)
            })
        } else {
            if (window.cefChat) {
                console.log('cefChat这边的Unauthorized，还未做')
            } else {
                if (Config.isPad) {
                    if (window.PageTo) {
                        PageTo.root = {
                            0: [],
                            1: [],
                            2: [],
                            3: [],
                            4: []
                        }
                    }
                    this.onNeedLogin();
                    Utils.unMask(Ext.Viewport)
                } else {
                    this.onNeedLogin();
                    Utils.unMask(Ext.Viewport)
                }
            }
        }
    }
}, 0, 0, 0, 0, ['controller.viewport'], 0, [PushIM.Webapp.view.viewport, 'ViewportController'], 0);
Ext.cmd.derive('PushIM.Webapp.view.viewport.ViewportModel', Ext.app.ViewModel, {
    stores: {},
    data: {}
}, 0, 0, 0, 0, ['viewmodel.viewport'], 0, [PushIM.Webapp.view.viewport, 'ViewportModel'], 0);
Ext.cmd.derive('PushIM.Webapp.util.RouteList', Ext.Base, {
    singleton: !0,
    alternateClassName: 'RouteList',
    demoRouteList: [{
        routeID: 1,
        routeUrl: 'http://218.4.111.6:17001/',
        folder: 'im.pusherp.com',
        isDemo: 'Y'
    }],
    routeList: [{
        routeID: 1,
        routeUrl: 'https://im.aio7.com/',
        folder: 'im.aio7.com',
        isDemo: 'N'
    }, {
        routeID: 2,
        routeUrl: 'http://www.aio7.com:7001/',
        folder: 'im.aio7.com',
        isDemo: 'N'
    }],
    currentRoute: {
        routeID: 1,
        routeUrl: 'https://im.aio7.com/',
        folder: 'im.aio7.com',
        isDemo: 'N',
        demoRouteID: 1,
        demoRouteUrl: 'http://218.4.111.6:17001/'
    },
    saveLocalStorage: function () {
        var a = this,
            i = Ext.decode(localStorage.getItem('currentRoute')),
            d = localStorage.getItem('newServerUrl'),
            c = localStorage.getItem('isdemo'),
            b;
        if (!Config.newLoginWays) {
            return
        }
        if (!c) {
            c = 'Y';
            localStorage.setItem('isdemo', c)
        }
        if (!d) {
            d = a.currentRoute.routeUrl;
            if (c == 'Y') {
                d = a.currentRoute.demoRouteUrl
            }
            localStorage.setItem('newServerUrl', d)
        }
        if (!i) {
            i = a.currentRoute;
            if (c == 'Y') {
                var g = a.demoRouteList;
                for (var e = 0; e < g.length; e++) {
                    if (g[e].routeUrl == d) {
                        b = g[e];
                        a.currentRoute.folder = b.folder;
                        a.currentRoute.demoRouteID = b.routeID;
                        a.currentRoute.demoRouteUrl = b.routeUrl;
                        a.currentRoute.isDemo = c;
                        break
                    }
                }
            } else {
                var h = a.routeList;
                for (var f = 0; f < h.length; f++) {
                    if (h[f].routeUrl == d) {
                        b = h[f];
                        a.currentRoute.folder = b.folder;
                        a.currentRoute.routeID = b.routeID;
                        a.currentRoute.routeUrl = b.routeUrl;
                        a.currentRoute.isDemo = c;
                        break
                    }
                }
            }
            localStorage.setItem('currentRoute', Ext.encode(a.currentRoute))
        }
        localStorage.setItem('newAccounts', Ext.encode(this.routeList))
    },
    updateCurRoute: function (a) {
        var b = this;
        if (!a) {
            a = b.currentRoute
        }
        b.currentRoute.folder = a.folder;
        b.currentRoute.isDemo = a.isDemo;
        if (a.isDemo == 'Y') {
            b.currentRoute.demoRouteID = a.routeID;
            b.currentRoute.demoRouteUrl = a.routeUrl
        } else {
            b.currentRoute.routeID = a.routeID;
            b.currentRoute.routeUrl = a.routeUrl
        }
        localStorage.setItem('currentRoute', Ext.encode(b.currentRoute))
    },
    updateDemoRoute: function (c) {
        var d = this;
        var a = Ext.decode(localStorage.getItem('currentRoute'));
        if (a) {
            serverUrl = a.routeUrl;
            var b = a.routeID - 1;
            a.folder = d.routeList[b].folder;
            if (c == 'Y') {
                b = a.demoRouteID - 1;
                a.folder = d.demoRouteList[b].folder;
                serverUrl = a.demoRouteUrl
            }
            a.isDemo = c;
            localStorage.setItem('currentRoute', Ext.encode(a));
            localStorage.setItem('newServerUrl', serverUrl)
        }
    },
    nextRoute: function (b, c, g) {
        var e = this,
            a = e.routeList;
        if (!b || !c) {
            return null
        }
        if (c == 'Y') {
            a = e.demoRouteList
        }
        var h = a.length,
            d = b % h,
            f = a[d];
        if (d + 1 == g) {
            return null
        }
        return f
    },
    adapteLoginWays: function () {
        var m = this,
            e = Ext.decode(localStorage.getItem('currentRoute')),
            l = localStorage.getItem('isdemo');
        if (!Config.newLoginWays && e) {
            var a = Ext.decode(localStorage.getItem('accounts')) || [],
                j = localStorage.getItem('serverUrl'),
                d = localStorage.getItem('newServerUrl');
            var g = !1;
            var f = Ext.Viewport.down('acSetting'),
                b = f ? f.down('#listAccount') : null;
            if (a && a.length > 0) {
                for (var c = 0; c < a.length; c++) {
                    if (a[c].routeUrl) {
                        a.splice(c, 1);
                        c--;
                        continue
                    }
                    if (a[c].name == d) {
                        g = !0;
                        if (b) {
                            var h = b.getStore().find('name', d);
                            if (h > -1) {
                                b.getSelectable().select(h)
                            }
                        }
                        break
                    }
                }
            }
            if (!g) {
                var i = d || j;
                a.push({
                    name: i
                });
                localStorage.setItem('accounts', Ext.encode(a));
                if (b) {
                    var k = b.getStore().add({
                        name: i
                    });
                    b.getSelectable().select(k)
                }
            }
            if (d) {
                localStorage.setItem('serverUrl', d)
            }
            e = null;
            localStorage.setItem('currentRoute', Ext.encode(e))
        }
    },
    getAccIDByUrl: function () {
        var c = this,
            e = Config.httpUrlForGo.replace('/api/v1', ''),
            d = localStorage.getItem('isdemo'),
            b = c.routeList;
        if (d == 'Y') {
            b = c.demoRouteList
        }
        for (var a = 0; a < b.length; a++) {
            if (e.startsWith(b[a].routeUrl)) {
                return b[a].folder
            }
        }
        return ParseUtil.parseAccID(Config.httpUrlForGo)
    }
}, 0, 0, 0, 0, 0, 0, [PushIM.Webapp.util, 'RouteList', 0, 'RouteList'], 0);
Ext.cmd.derive('PushIM.Webapp.util.VerControll', Ext.Base, {
    alternateClassName: 'VerControll',
    singleton: !0,
    ServerVer: {
        '1.0.2.187': {
            verEditPwd: !0
        },
        '1.0.0.186': {
            verOrgTree: !0,
            verLogin3: !0,
            verReceipt: !0,
            verApprove: !0,
            verNoticePush: !0,
            verMailPush: !0,
            verCrowd: !0
        }
    },
    verLogin2: !0,
    clear: function () {
        var a = this;
        a.verEditPwd = undefined;
        a.verOrgTree = undefined;
        a.verLogin3 = undefined;
        a.verReceipt = undefined;
        a.verApprove = undefined;
        a.verNoticePush = undefined;
        a.verMailPush = undefined;
        a.verCrowd = undefined
    },
    validServerVersion: function () {
        var a = this;
        return new Promise(function (b, c) {
            Utils.aioAjax('get', 'version', {
                success: function (d) {
                    a.clear();
                    a.compareClientAndServer(d);
                    b()
                },
                failure: function () {
                    a.clear();
                    b()
                }
            })
        })
    },
    compareClientAndServer: function (e) {
        var a = this;
        for (var d in a.ServerVer) {
            if (d <= e) {
                var c = a.ServerVer[d];
                for (var b in c) {
                    if (a[b] == undefined) {
                        a[b] = c[b]
                    }
                }
            }
        }
    },
    judgeFn: function (a) {
        var b = this;
        return !!b[a]
    },
    getAvailableLogin: function (b) {
        var d = this;
        var c = 'users/login3',
            a = 'users/autologin3';
        if (b) {
            return a
        }
        return c
    }
}, 0, 0, 0, 0, 0, 0, [PushIM.Webapp.util, 'VerControll', 0, 'VerControll'], 0);
Ext.cmd.derive('PushIM.Webapp.Application', Ext.app.Application, {
    name: 'PushIM.Webapp',
    quickTips: !1,
    platformConfig: {
        desktop: {
            quickTips: !0
        }
    },
    viewport: {
        controller: 'viewport',
        viewModel: 'viewport'
    },
    launch: function (e) {
        var a = this;
        Ext.enableAria = !1;
        Ext.ariaWarn = Ext.emptyFn;
        Ext.event.gesture.LongPress.instance.setMinDuration(600);
        Ext.apply(Ext.Date, {
            defaultTimeFormat: 'H:i'
        });
        Ext.Msg.defaultAllowedConfig.hideAnimation = null;
        Ext.Msg.defaultAllowedConfig.showAnimation = null;
        if (Ext.isiOS) {
            var b = 'input,textarea,[contenteditable="true"],.ignore-keyboard button';
            if (window.cordova) {
                document.body.addEventListener('touchstart', function (a) {
                    if (window.Keyboard && Keyboard.isVisible && !Ext.fly(a.target).is(b)) {
                        Keyboard.hide()
                    }
                })
            } else {
                document.body.addEventListener('touchstart', function (a) {
                    if (document.activeElement && Ext.fly(document.activeElement).is(b) && !Ext.fly(a.target).is(b)) {
                        document.activeElement.blur()
                    }
                })
            }
            var d = function (a) {
                setTimeout(function () {
                    if (a.style.textShadow === '') {
                        a.style.textShadow = 'rgba(0,0,0,0) 0 0 0'
                    } else {
                        a.style.textShadow = ''
                    }
                }, 50)
            };
            Ext.Viewport.on({
                resize: function (g, h, c, f, a) {
                    if (c != a && document.activeElement && Ext.fly(document.activeElement).is(b)) {
                        d(document.activeElement)
                    }
                }
            })
        }
        if (a.getCefObj()) {
            a.setCefConfigUrl();
            Config.isPC = !0;
            Config.needLocal = !0;
            if (window.cefMain || window.cefChat) {
                Config.isDesktop = !0
            }
        } else {
            if (Ext.browser.is.Cordova) {
                window.RouteList.saveLocalStorage();
                window.RouteList.adapteLoginWays();
                a.setConfigUrl();
                Config.isPhone = !0;
                Config.needLocal = !0;
                a.bindPause();
                a.bindResume();
                var c = Ext.Viewport.getController();
                document.addEventListener('backbutton', Ext.Function.bind(c.onBackButton, c), !1);
                if (Ext.os.is.Android) {
                    try {
                        navigator.app.overrideButton('menubutton', !0);
                        document.addEventListener('menubutton', Ext.Function.bind(c.onMenuButton, c), !1)
                    } catch (f) {}
                    setTimeout(function () {
                        a.checkAndShowLegalArgreement()
                    }, 1500)
                }
            } else {
                setTimeout(function () {
                    a.checkAndShowLegalArgreement()
                }, 1500);
                window.RouteList.saveLocalStorage();
                window.RouteList.adapteLoginWays();
                a.setConfigUrl()
            }
        }
        if (!Ext.browser.is.Cordova) {
            a.onDeviceReady()
        } else {
            document.addEventListener('deviceready', Ext.bind(a.onDeviceReady, a, !1))
        }
        Ext.app.Application.prototype.launch.call(this, e)
    },
    checkAndShowLegalArgreement: function () {
        var c = this;
        var b = localStorage.getItem('legal_agreement_version');
        if (b != '1') {
            var a = Ext.widget({
                xtype: 'messagebox',
                destroyOnHide: !0,
                title: '隐私政策',
                cls: 'centered-dialog',
                message: '我们非常重视及保护您的个人隐私。为了更好地保障您的权益，在使用我们的产品前，请阅读<a href="javascript:PushIM.Webapp.app.showUserTermsAgreement();">《用户协议》</a>和<a href="javascript:PushIM.Webapp.app.showPrivacyAgreement();">《隐私政策》</a>。',
                style: {
                    margin: 'auto'
                },
                textAlign: 'left',
                buttons: [{
                    text: '同意',
                    ui: 'action',
                    handler: function () {
                        localStorage.setItem('legal_agreement_version', '1');
                        a.hide()
                    }
                }, {
                    text: '不同意',
                    ui: 'flat',
                    handler: function () {
                        if (navigator.app) {
                            navigator.app.exitApp()
                        }
                    }
                }],
                listeners: {
                    destroy: function (b) {
                        if (b === a) {
                            delete a
                        }
                    }
                }
            });
            a.show();
            return !1
        }
        return !0
    },
    showUserTermsAgreement: function () {
        var b = this;
        var a = Ext.create({
            xtype: 'dialog',
            title: '隐私政策',
            cls: 'app-dialog',
            style: {
                margin: 'auto'
            },
            html: '<iframe src="http://www.pushsoft.cn/UserTerms.html"></iframe>',
            buttons: {
                ok: function () {
                    a.destroy()
                }
            }
        });
        a.show()
    },
    showPrivacyAgreement: function () {
        var b = this;
        var a = Ext.create({
            xtype: 'dialog',
            title: '用户协议',
            cls: 'app-dialog',
            style: {
                margin: 'auto'
            },
            maxHeight: '90%',
            html: '<iframe src="http://www.pushsoft.cn/Privacy.html"></iframe>',
            buttons: {
                ok: function () {
                    a.destroy()
                }
            }
        });
        a.show()
    },
    setCefConfigUrl: function () {
        var a = this.getCefObj();
        if (a) {
            var b = a.getAccountName();
            this.cefChangeConfig(b)
        }
    },
    cefChangeConfig: function (d) {
        if (!d) {
            Config.httpUrlForGo = Config.httpPdcGoUrl;
            Config.wsGoUrl = Config.wsPdcUrl
        } else {
            var b = 'wss';
            var a = d;
            if (a && a.indexOf) {
                if (a.toLowerCase().startsWith('http://')) {
                    b = 'ws'
                }
                var c = a.indexOf(':');
                if (c > -1) {
                    Config.wsGoUrl = Utils.joinPath(b + a.substring(c), 'api/v1/websocket')
                } else {
                    Config.wsGoUrl = Utils.joinPath(b + '://' + a, 'api/v1/websocket')
                }
                Config.httpUrlForGo = Utils.joinPath(a, 'api/v1/')
            }
        }
    },
    getCefObj: function () {
        return window.cefMain || window.cefMsgMgr || window.cefUserSelector || window.cefSetting || window.cefUserEdit || window.cefChat || window.cefCrowdSetting || window.cefFileMgr
    },
    setConfigUrl: function () {
        var a = localStorage.getItem('serverUrl');
        var d = localStorage.getItem('isdemo');
        var e = localStorage.getItem('accounts');
        if (Config.newLoginWays) {
            a = localStorage.getItem('newServerUrl');
            e = localStorage.getItem('newAccounts')
        }
        if (!a && Config.isPC) {
            a = 'https://im.aio7.com/';
            localStorage.setItem('serverUrl', 'https://im.aio7.com/')
        } else {
            if (d == null && e == null) {
                d = 'Y';
                localStorage.setItem('isdemo', 'Y')
            }
        }
        if (d == 'Y' && !Config.newLoginWays) {
            a = 'http://218.4.111.6:17001/';
            localStorage.setItem('serverUrl', a)
        }
        if (a) {
            var c = 'wss';
            var b = a;
            if (b && b.indexOf) {
                if (b.toLowerCase().startsWith('http://')) {
                    c = 'ws'
                }
                var f = b.indexOf(':');
                if (f > -1) {
                    Config.wsGoUrl = Utils.joinPath(c + b.substring(f), 'api/v1/websocket')
                } else {
                    Config.wsGoUrl = Utils.joinPath(c + '://' + b, 'api/v1/websocket')
                }
                Config.httpUrlForGo = Utils.joinPath(b, 'api/v1/')
            }
        }
    },
    bindPause: function () {
        document.addEventListener('pause', function () {
            Config.isPause = 'Y';
            if (WebSocketUtil && Config.ChooseFile != 'Y') {
                WebSocketUtil.pause()
            }
        }, !1)
    },
    bindResume: function () {
        document.addEventListener('resume', function () {
            Config.isPause = 'N';
            if (Config.OpenFile) {
                Config.ChooseFile = 'N';
                Config.OpenFile = !1
            }
            if (WebSocketUtil && !WebSocketUtil.conn || WebSocketUtil.conn.readyState === WebSocket.CLOSED) {
                WebSocketUtil.initialize(Config.wsGoUrl)
            }
        }, !1)
    },
    onDeviceReady: function () {
        var a = this;
        a.pluginReady();
        a.getVersion(function (b) {
            a.versionCode = b.code;
            a.versionName = b.name;
            PushNotification.checkRight();
            Ext.Viewport.getController().onLaunch(b.name);
            if (!Config.isPhone && navigator.splashscreen) {
                navigator.splashscreen.hide()
            }
        });
        if (Config.isPad) {
            StatusBar.styleDefault();
            screen.orientation.lock('landscape')
        } else {
            if (Ext.os.is.iOS) {
                screen.orientation.lock('portrait')
            }
        }
    },
    pluginReady: function () {
        var c = this,
            b = Ext.browser.is.Cordova;
        if (!b) {
            if (Ext.isEmpty(Utils.getLsItem('deviceuuid'))) {
                Utils.setLsItem('deviceuuid', Utils.uuid('web_'))
            }
            return
        }
        c.statusBarHeight = 0;
        if (b) {
            var a = 0;
            if (Ext.os.is.iOS && Ext.os.version.major >= 7) {
                a = 20;
                Ext.util.CSS.createStyleSheet(['.topinset { ', 'padding-top: ' + a + 'px; ', 'padding-top: constant(safe-area-inset-top); ', 'padding-top: env(safe-area-inset-top); ', '}', '.bottominset { ', 'padding-bottom: ' + a + 'px; ', 'padding-bottom: constant(safe-area-inset-bottom); ', 'padding-bottom: env(safe-area-inset-bottom); ', '}'].join(''), 'InsetStyle')
            } else {
                if (Ext.os.is.Android && Ext.os.version.major * 10 + Ext.os.version.minor >= 44) {
                    a = 25;
                    Ext.util.CSS.createStyleSheet(['.topinset { ', 'padding-top: ' + a + 'px; ', 'padding-top: var(--android-inset-top); ', '}'].join(''), 'InsetStyle');
                    if (Ext.os.version.major * 10 + Ext.os.version.minor < 60) {
                        window.addEventListener('native.actionmodeshow', function (a) {
                            Ext.Viewport.element.addCls('actionmode')
                        }, !1);
                        window.addEventListener('native.actionmodehide', function (a) {
                            Ext.Viewport.element.removeCls('actionmode')
                        }, !1)
                    }
                }
            }
            User.statusBarHeight = a;
            c.statusBarHeight = a
        }
    },
    getVersion: function (a) {
        if (window.BuildInfo) {
            a({
                code: BuildInfo.versionCode,
                name: BuildInfo.version
            })
        } else {
            Ext.Ajax.request({
                url: Ext.getResourcePath('appversion.txt', null),
                success: function (f) {
                    var g = f.responseText.trim(),
                        e = g.split('\n'),
                        c = {};
                    for (var d = 0; d < e.length; d++) {
                        var b = e[d].trim().split('=');
                        if (b[0].trim() == 'version.name') {
                            c.name = b[1].trim()
                        } else {
                            if (b[0].trim() == 'version.code') {
                                c.code = b[1].trim()
                            }
                        }
                    }
                    a(c)
                },
                failure: function () {}
            })
        }
    },
    getClientInfo1: function () {
        var e = this,
            b = !!Ext.browser.is.Cordova,
            d = Utils.isDebug();
        var a = {
            '_appid': Ext.manifest.name,
            '_os': Ext.os.name,
            '_version': e.versionCode || 0,
            '_cordova': b,
            '_deviceid': b ? device.uuid : Utils.getLsItem('deviceuuid')
        };
        if (!Ext.isEmpty(User.ownerID)) {
            a['_userid'] = User.ownerID
        }
        var c = Utils.getLsItem('token');
        if (!Ext.isEmpty(c)) {
            a['_token'] = c
        }
        if (d) {
            a['_isdebug'] = !0
        }
        return a
    },
    getClientInfo: function () {
        var b = this;
        var a = {}
    },
    onAppUpdate: function () {
        Ext.Msg.confirm('程序升级', '本应用程序已发布新版本, 是否重新加载?', function (a) {
            if (a === 'yes') {
                window.location.reload()
            }
        })
    }
}, 0, 0, 0, 0, 0, 0, [PushIM.Webapp, 'Application'], 0);
Ext.cmd.derive('PushIM.Webapp.util.LaunchPicture', Ext.Base, {
    singleton: !0,
    alternateClassName: 'LaunchPicture',
    PhoneJson: function () {
        var a = this.getImgRath('IMMobile');
        return [{
            version: '1.0.30',
            imgs: [],
            content2: [{
                label: 'h1',
                text: '1.0.30功能介绍'
            }, {
                label: 'h2',
                text: '改进及缺陷修正'
            }, {
                label: 'h3',
                text: 'AIO8服务功能适配'
            }],
            updateAt: 1.60886E12,
            visiable: !0
        }, {
            version: '1.0.29',
            imgs: [],
            content2: [{
                label: 'h1',
                text: '1.0.29功能介绍'
            }, {
                label: 'h2',
                text: '改进及缺陷修正'
            }, {
                label: 'h3',
                text: '审批附件预览改进'
            }],
            updateAt: 1.606195E12,
            visiable: !0
        }, {
            version: '1.0.28',
            imgs: [],
            content2: [{
                label: 'h1',
                text: '1.0.28功能介绍'
            }, {
                label: 'h2',
                text: '新功能'
            }, {
                label: 'h3',
                text: '服务与隐私条款添加'
            }, {
                label: 'h2',
                text: '改进及缺陷修正'
            }, {
                label: 'h3',
                text: '审批附件预览、单据查看'
            }],
            updateAt: 1.602659E12,
            visiable: !0
        }, {
            version: '1.0.27',
            imgs: [],
            content2: [{
                label: 'h1',
                text: '1.0.27功能介绍'
            }, {
                label: 'h2',
                text: '改进及缺陷修正'
            }, {
                label: 'h3',
                text: '审批正式凭证数据浏览改进'
            }],
            updateAt: 1.601183E12,
            visiable: !0
        }, {
            version: '1.0.26',
            imgs: [],
            content2: [{
                label: 'h1',
                text: '1.0.26功能介绍'
            }, {
                label: 'h2',
                text: '改进及缺陷修正'
            }, {
                label: 'h3',
                text: '页面改进'
            }],
            updateAt: 1.600851E12,
            visiable: !0
        }, {
            version: '1.0.25',
            imgs: [],
            content2: [{
                label: 'h1',
                text: '1.0.25功能介绍'
            }, {
                label: 'h2',
                text: '改进及缺陷修正'
            }, {
                label: 'h3',
                text: '待办审批筛选改进'
            }],
            updateAt: 1.59979E12,
            visiable: !0
        }, {
            version: '1.0.24',
            imgs: [],
            content2: [{
                label: 'h1',
                text: '1.0.24功能介绍'
            }, {
                label: 'h2',
                text: '新功能'
            }, {
                label: 'h3',
                text: '会话中支持草稿记录'
            }, {
                label: 'h2',
                text: '改进及缺陷修正'
            }, {
                label: 'h3',
                text: '工作台优化'
            }],
            updateAt: 1.589181E12,
            visiable: !0
        }, {
            version: '1.0.23',
            imgs: [],
            content2: [{
                label: 'h1',
                text: '1.0.23功能介绍'
            }, {
                label: 'h2',
                text: '新功能'
            }, {
                label: 'h3',
                text: '支持修改密码'
            }, {
                label: 'h2',
                text: '改进及缺陷修正'
            }, {
                label: 'h3',
                text: '基础缺陷改进'
            }],
            updateAt: 1.585534E12,
            visiable: !0
        }, {
            version: '1.0.22',
            imgs: [],
            content2: [{
                label: 'h1',
                text: '1.0.22功能介绍'
            }, {
                label: 'h2',
                text: '改进及缺陷修正'
            }, {
                label: 'h3',
                text: '支持打开会话中的文件'
            }, {
                label: 'h3',
                text: '工作台加载、刷新优化'
            }],
            updateAt: 1.581918E12,
            visiable: !0
        }, {
            version: '1.0.21',
            imgs: [],
            content2: [{
                label: 'h1',
                text: '1.0.21功能介绍'
            }, {
                label: 'h2',
                text: '新功能'
            }, {
                label: 'h3',
                text: '分享功能'
            }, {
                label: 'dsc',
                text: '移动端-年会项目增添分享功能'
            }],
            updateAt: 1.577918E12,
            visiable: !0
        }, {
            version: '1.0.20',
            imgs: [{
                url: a + '1020-01.png'
            }, {
                url: a + '1020-02.png'
            }],
            content2: [{
                label: 'h1',
                text: '1.0.20功能介绍'
            }, {
                label: 'h2',
                text: '新功能'
            }, {
                label: 'h3',
                text: '消息已读未读'
            }, {
                label: 'dsc',
                text: '会话中，自己发的消息可以查看成员阅读情况，并且通过点击未读，查看详情'
            }],
            updateAt: 1.576133E12,
            visiable: !0
        }, {
            version: '1.0.18',
            imgs: [],
            content2: [{
                label: 'h1',
                text: '1.0.18功能介绍'
            }, {
                label: 'h2',
                text: '新功能'
            }, {
                label: 'h3',
                text: '审批'
            }, {
                label: 'dsc',
                text: '添加审批页，可查看、操作与自己有关的审批信息'
            }],
            updateAt: 1.573434E12,
            visiable: !0
        }, {
            version: '1.0.17',
            imgs: [],
            content2: [{
                label: 'h1',
                text: '1.0.17功能介绍'
            }, {
                label: 'h2',
                text: '改进及缺陷修正'
            }, {
                label: 'h3',
                text: '改进账套线路'
            }],
            updateAt: 1.570609E12,
            visiable: !0
        }, {
            version: '1.0.16',
            imgs: [],
            content2: [{
                label: 'h1',
                text: '1.0.16功能介绍'
            }, {
                label: 'h2',
                text: '新功能'
            }, {
                label: 'h3',
                text: '@所有人'
            }, {
                label: 'dsc',
                text: '多人会话及群中，支持管理人员 @所有人'
            }, {
                label: 'h3',
                text: '在线状态查看'
            }, {
                label: 'dsc',
                text: '可在通讯录或单人会话中，查看人员在线状态'
            }, {
                label: 'h3',
                text: '转发改进'
            }, {
                label: 'dsc',
                text: '转发页面中，支持搜索结果选中、能够新建会话进行转发内容'
            }, {
                label: 'h2',
                text: '改进及缺陷修正'
            }, {
                label: 'h3',
                text: '群头像改进'
            }, {
                label: 'h3',
                text: '通知消息显示调整'
            }],
            updateAt: 1.568633E12,
            visiable: !0
        }, {
            version: '1.0.15',
            imgs: [{
                url: a + '1015-01.png'
            }, {
                url: a + '1015-02.png'
            }],
            content2: [{
                label: 'h1',
                text: '1.0.15功能介绍'
            }, {
                label: 'h2',
                text: '新功能'
            }, {
                label: 'h3',
                text: '文件管理'
            }, {
                label: 'dsc',
                text: '我-我的文件中，添加文件管理功能，可方便查看、操作会话及工作台中已下载文件'
            }, {
                label: 'h3',
                text: '工作台附件下载'
            }, {
                label: 'dsc',
                text: '支持了工作台中附件的下载'
            }],
            updateAt: 1.567411E12,
            visiable: !0
        }, {
            version: '1.0.14',
            imgs: [],
            content2: [{
                label: 'h1',
                text: '1.0.14功能介绍'
            }, {
                label: 'h2',
                text: '改进及缺陷修正'
            }, {
                label: 'h3',
                text: '优化邮件推送'
            }],
            updateAt: 1.565568E12,
            visiable: !0
        }, {
            version: '1.0.13',
            imgs: [],
            content2: [{
                label: 'h1',
                text: '1.0.13功能介绍'
            }, {
                label: 'h2',
                text: '改进及缺陷修正'
            }, {
                label: 'h3',
                text: '支持了邮件推送'
            }, {
                label: 'h3',
                text: '改进头像显示'
            }],
            updateAt: 1.5646752E12,
            visiable: !0
        }, {
            version: '1.0.12',
            imgs: [],
            content2: [{
                label: 'h1',
                text: '1.0.12功能介绍'
            }, {
                label: 'h2',
                text: '新功能'
            }, {
                label: 'h3',
                text: '支持了群会话'
            }, {
                label: 'dsc',
                text: '各个部门或组织自主维护的特殊性多人会话'
            }, {
                label: 'h2',
                text: '改进及缺陷修正'
            }, {
                label: 'h3',
                text: '优化头像的更新机制'
            }, {
                label: 'h3',
                text: '样式及其它微小缺陷的调整'
            }],
            updateAt: 1.563427E12,
            visiable: !0
        }, {
            version: '1.0.11',
            imgs: [],
            content2: [{
                label: 'h1',
                text: '1.0.11功能介绍'
            }, {
                label: 'h2',
                text: '新功能'
            }, {
                label: 'h3',
                text: '消息中心'
            }, {
                label: 'dsc',
                text: '可于通讯录中进入消息中心，查看个人相关图文消息'
            }],
            updateAt: 1.560907E12,
            visiable: !0
        }, {
            version: '1.0.10',
            imgs: [],
            content2: [{
                label: 'h1',
                text: '1.0.10功能介绍'
            }, {
                label: 'h2',
                text: '改进及缺陷修正'
            }, {
                label: 'h3',
                text: '修正iOS输入框只能显示4行文本的问题'
            }, {
                label: 'h3',
                text: '修正打开应用时会卡在\u201c初始化数据库\u201d的问题'
            }, {
                label: 'h3',
                text: '修正九宫格输入法输入@时出错的问题'
            }, {
                label: 'h3',
                text: '修正九宫格输入法输入引号后无法弹出键盘的问题'
            }, {
                label: 'h3',
                text: '支持了长按用户头像@该用户'
            }],
            updateAt: 1.5592E12,
            visiable: !0
        }, {
            version: '1.0.9',
            imgs: [],
            content2: [{
                label: 'h1',
                text: '1.0.9功能介绍'
            }, {
                label: 'h2',
                text: '新增功能项'
            }, {
                label: 'h3',
                text: '文件分享'
            }, {
                label: 'dsc',
                text: '可将部分第三方应用的文件分享到AIO'
            }, {
                label: 'h2',
                text: '改进及缺陷修正'
            }, {
                label: 'h3',
                text: '图片查看内存溢出的问题处理'
            }, {
                label: 'dsc',
                text: '优化了会话页面图片查看轮播问题'
            }, {
                label: 'h3',
                text: '支持缩略图缩放'
            }, {
                label: 'h3',
                text: '最近会话列表加载慢的问题处理'
            }],
            updateAt: 1.557973E12,
            visiable: !0
        }, {
            version: '1.0.8',
            imgs: [{
                url: a + '108-01.png'
            }, {
                url: a + '108-02.png'
            }, {
                url: a + '108-03.png'
            }],
            content2: [{
                label: 'h1',
                text: '1.0.8功能介绍'
            }, {
                label: 'h2',
                text: '新增功能项'
            }, {
                label: 'h3',
                text: '支持HEIF/HEIC格式(iOS相册的原图)图片的发送'
            }, {
                label: 'h3',
                text: '会话图片支持滑动查看'
            }, {
                label: 'dsc',
                text: '会话页面中，预览原图支持滑动查看'
            }, {
                label: 'h3',
                text: '更新引导页'
            }, {
                label: 'dsc',
                text: '开启新版应用，即可浏览主要更新事项，并且在关于页面可以查看版本历史'
            }, {
                label: 'h3',
                text: '工作台支持定位'
            }, {
                label: 'dsc',
                text: '在工作台-日程-活动中，添加位置定位'
            }, {
                label: 'h2',
                text: '改进及缺陷修正'
            }, {
                label: 'h3',
                text: '最近会话列表搜索优化'
            }, {
                label: 'dsc',
                text: '优化了最近会话列表搜索搜索内容及显示'
            }, {
                label: 'h3',
                text: '修正了会话中下拉加载时，点击返回会报错的问题'
            }, {
                label: 'h3',
                text: '软键盘粘贴复制'
            }, {
                label: 'dsc',
                text: '修正了使用第三方输入法，粘贴包含换行的消息后，发送只显示第一行内容的问题'
            }, {
                label: 'h3',
                text: '修正了转发消息时，选人框出错的问题'
            }, {
                label: 'h3',
                text: '优化了工作台的打开方式'
            }],
            updateAt: 1.556249E12,
            visiable: !0
        }, {
            version: '1.0.7',
            imgs: [{
                url: a + '108.png'
            }],
            updateAt: (new Date()).getTime(),
            visiable: !1
        }]
    },
    PCJson: function () {
        return [{
            version: '1.0.30',
            imgs: [],
            content2: [{
                label: 'h1',
                text: '1.0.30功能介绍'
            }, {
                label: 'h2',
                text: '改进及缺陷修正'
            }, {
                label: 'h3',
                text: 'AIO8服务功能适配,工作台及消息中心会话隐藏'
            }],
            updateAt: 1.60886E12,
            visiable: !0
        }, {
            version: '1.0.25',
            imgs: [],
            content2: [{
                label: 'h1',
                text: '1.0.25功能介绍'
            }, {
                label: 'h2',
                text: '改进及缺陷修正'
            }, {
                label: 'h3',
                text: '组织结构可拉伸、会话草稿改进'
            }],
            updateAt: 1.59979E12,
            visiable: !0
        }, {
            version: '1.0.24',
            imgs: [],
            content2: [{
                label: 'h1',
                text: '1.0.24功能介绍'
            }, {
                label: 'h2',
                text: '新功能'
            }, {
                label: 'h3',
                text: '最近会话列表支持草稿记录'
            }],
            updateAt: 1.589181E12,
            visiable: !0
        }, {
            version: '1.0.23',
            imgs: [],
            content2: [{
                label: 'h1',
                text: '1.0.23功能介绍'
            }, {
                label: 'h2',
                text: '新功能'
            }, {
                label: 'h3',
                text: '支持修改密码'
            }, {
                label: 'h2',
                text: '改进及缺陷修正'
            }, {
                label: 'h3',
                text: '基础缺陷改进'
            }],
            updateAt: 1.585534E12,
            visiable: !0
        }, {
            version: '1.0.22',
            imgs: [],
            content2: [{
                label: 'h1',
                text: '1.0.22功能介绍'
            }, {
                label: 'h2',
                text: '新功能'
            }, {
                label: 'h3',
                text: '审批通知'
            }, {
                label: 'dsc',
                text: '添加审批通知，并在ERP中直接打开'
            }, {
                label: 'h2',
                text: '改进及缺陷修正'
            }, {
                label: 'h3',
                text: '组织结构改进'
            }, {
                label: 'dsc',
                text: '记录了组织结构节点收缩展开，方便以后查看'
            }],
            updateAt: 1.581918E12,
            visiable: !0
        }, {
            version: '1.0.20',
            imgs: [],
            content2: [{
                label: 'h1',
                text: '1.0.20功能介绍'
            }, {
                label: 'h2',
                text: '新功能'
            }, {
                label: 'h3',
                text: '消息已读未读'
            }, {
                label: 'dsc',
                text: '会话中，自己发的消息可以查看成员阅读情况，并且通过点击未读，查看详情'
            }],
            updateAt: 1.576133E12,
            visiable: !0
        }, {
            version: '1.0.17',
            imgs: [],
            content2: [{
                label: 'h1',
                text: '1.0.17功能介绍'
            }, {
                label: 'h2',
                text: '改进及缺陷修正'
            }, {
                label: 'h3',
                text: '改进账套线路'
            }],
            updateAt: 1.570609E12,
            visiable: !0
        }, {
            version: '1.0.16',
            imgs: [],
            content2: [{
                label: 'h1',
                text: '1.0.16功能介绍'
            }, {
                label: 'h2',
                text: '新功能'
            }, {
                label: 'h3',
                text: '@所有人'
            }, {
                label: 'dsc',
                text: '多人会话及群中，支持管理人员 @所有人'
            }, {
                label: 'h3',
                text: '转发改进'
            }, {
                label: 'dsc',
                text: '转发页面中，支持搜索结果选中、能够新建会话进行转发内容'
            }, {
                label: 'h2',
                text: '改进及缺陷修正'
            }, {
                label: 'h3',
                text: '通知消息显示调整'
            }],
            updateAt: 1.568633E12,
            visiable: !0
        }, {
            version: '1.0.15',
            imgs: [],
            content2: [{
                label: 'h1',
                text: '1.0.15功能介绍'
            }, {
                label: 'h2',
                text: '新功能'
            }, {
                label: 'h3',
                text: '文件管理'
            }, {
                label: 'dsc',
                text: '设置-我的文件中，添加文件管理功能，可方便查看、操作会话及工作台中文件'
            }, {
                label: 'h3',
                text: '工作台附件下载'
            }, {
                label: 'dsc',
                text: '支持了工作台中附件的下载'
            }],
            updateAt: 1.567411E12,
            visiable: !0
        }, {
            version: '1.0.14',
            imgs: [],
            content2: [{
                label: 'h1',
                text: '1.0.14功能介绍'
            }, {
                label: 'h2',
                text: '改进及缺陷修正'
            }, {
                label: 'h3',
                text: '优化邮件推送'
            }, {
                label: 'h3',
                text: '修正选人框搜索问题'
            }],
            updateAt: 1.565568E12,
            visiable: !0
        }, {
            version: '1.0.13',
            imgs: [],
            content2: [{
                label: 'h1',
                text: '1.0.13功能介绍'
            }, {
                label: 'h2',
                text: '改进及缺陷修正'
            }, {
                label: 'h3',
                text: '优化了工作台显示'
            }, {
                label: 'h3',
                text: '支持了邮件推送'
            }, {
                label: 'h3',
                text: '改进头像显示'
            }],
            updateAt: 1.5646752E12,
            visiable: !0
        }, {
            version: '1.0.12',
            imgs: [],
            content2: [{
                label: 'h1',
                text: '1.0.12功能介绍'
            }, {
                label: 'h2',
                text: '新功能'
            }, {
                label: 'h3',
                text: '支持了群会话'
            }, {
                label: 'dsc',
                text: '各个部门或组织自主维护的特殊性多人会话'
            }, {
                label: 'h2',
                text: '改进及缺陷修正'
            }, {
                label: 'h3',
                text: '优化复制功能'
            }, {
                label: 'h3',
                text: '修改组织结构图标显示'
            }],
            updateAt: 1.563427E12,
            visiable: !0
        }, {
            version: '1.0.11',
            content2: [{
                label: 'h1',
                text: '1.0.11功能介绍'
            }, {
                label: 'h2',
                text: '新功能'
            }, {
                label: 'h3',
                text: '消息中心'
            }, {
                label: 'dsc',
                text: '可于通讯录中进入消息中心，查看个人相关图文消息'
            }, {
                label: 'h2',
                text: '改进及缺陷修正'
            }, {
                label: 'h3',
                text: '取消 通讯录-组织 双击创建会话'
            }],
            updateAt: 1.560907E12,
            visiable: !0
        }, {
            version: '1.0.10',
            content2: [{
                label: 'h1',
                text: '1.0.10功能介绍'
            }, {
                label: 'h2',
                text: '改进及缺陷修正'
            }, {
                label: 'h3',
                text: ' 修正小于1KB的文件大小显示不正常的问题'
            }, {
                label: 'h3',
                text: ' 修正消息记录里右键复制报错的问题'
            }],
            updateAt: 1.5592E12,
            visiable: !0
        }, {
            version: '1.0.9',
            content2: [{
                label: 'h1',
                text: '1.0.9功能介绍'
            }, {
                label: 'h2',
                text: '新功能'
            }, {
                label: 'h3',
                text: '更新历史查看'
            }, {
                label: 'dsc',
                text: '可查看pc端历史更新信息'
            }, {
                label: 'h3',
                text: '支持大文件转发'
            }, {
                label: 'h2',
                text: '改进及缺陷修正'
            }, {
                label: 'h3',
                text: '请求设置\u201c查看更多历史消息\u201c的提醒'
            }, {
                label: 'h3',
                text: '更新时会卡住的问题处理'
            }],
            updateAt: 1.557973E12,
            visiable: !0
        }, {
            version: '1.0.8',
            content2: [{
                label: 'h1',
                text: '1.0.8功能介绍'
            }, {
                label: 'h2',
                text: '新功能'
            }, {
                label: 'h3',
                text: '多人会话支持了消息回复功能，右键消息可以进行回复'
            }, {
                label: 'h3',
                text: '支持用户主动请求查看更多历史消息'
            }, {
                label: 'h2',
                text: '改进及缺陷修正'
            }, {
                label: 'h3',
                text: '修正ERP链接包含特殊字符时，无法发送的问题'
            }, {
                label: 'h3',
                text: '修正截图会导致内存溢出的问题'
            }, {
                label: 'h3',
                text: '多人会话标题的清除按钮默认不显示'
            }, {
                label: 'h3',
                text: '处理工作台session过期的问题'
            }],
            updateAt: 1.556249E12,
            visiable: !0
        }]
    },
    getImgRath: function (b) {
        var a = '';
        switch (b) {
            case 'IMMobile':
                a = Ext.getResourcePath('images/launchImgs/');
                break;
            default:
                break;
        }
        return a
    }
}, 0, 0, 0, 0, 0, 0, [PushIM.Webapp.util, 'LaunchPicture', 0, 'LaunchPicture'], 0);
Ext.cmd.derive('PushIM.Webapp.view.luanchcarousel.LaunchPicController', Ext.app.ViewController, {
    onclose: function () {
        var a = this.getView();
        a.destroy()
    }
}, 0, 0, 0, 0, ['controller.launchpic'], 0, [PushIM.Webapp.view.luanchcarousel, 'LaunchPicController'], 0);
Ext.cmd.derive('PushIM.Webapp.view.luanchcarousel.LaunchPic', Ext.Container, {
    controller: 'launchpic',
    floated: !0,
    classCls: 'launch-pic',
    hidden: !0,
    items: [{
        xtype: 'carousel',
        itemId: 'launchCarousel',
        reference: 'launchCarousel'
    }, {
        xtype: 'button',
        cls: 'jump topinset',
        text: '跳过',
        handler: 'onclose'
    }],
    initialize: function () {
        var a = this;
        Ext.Container.prototype.initialize.apply(this, arguments);
        a.addLaunchPics();
        a.isVisible()
    },
    isVisible: function () {
        var b = this;
        var a = localStorage.getItem('version');
        a = Ext.decode(a);
        if (a === this.lastedVer) {
            this.pass = !0
        } else {
            localStorage.setItem('version', Ext.encode(this.lastedVer))
        }
        if (!this.pass) {
            this.show()
        } else {
            try {
                this.timer = setTimeout(function () {
                    b.destroy()
                }, 500)
            } catch (c) {}
        }
    },
    addLaunchPics: function () {
        var d = LaunchPicture.PhoneJson(),
            b = d[0].imgs,
            c = this.down('carousel');
        this.lastedVer = d[0].version;
        c.imgLength = b.length;
        if (b.length == 0) {
            this.pass = !0;
            return
        }
        for (var a = 0; a < b.length; a++) {
            var e = b[a].url;
            if (a == b.length - 1) {
                c.add({
                    xtype: 'container',
                    items: [{
                        html: '<img src="' + e + '" style="width: 100%;" nodeId="' + a + '">'
                    }, {
                        xtype: 'container',
                        itemId: 'comeIn',
                        cls: 'come-in bottominset',
                        items: [{
                            xtype: 'button',
                            text: '立即体验',
                            handler: 'onclose'
                        }]
                    }]
                })
            } else {
                c.add({
                    html: '<img src="' + e + '" style="width: 100%;" nodeId="' + a + '">'
                })
            }
        }
    }
}, 0, ['launchpic'], ['widget', 'component', 'container', 'launchpic'], {
    'widget': !0,
    'component': !0,
    'container': !0,
    'launchpic': !0
}, ['widget.launchpic'], 0, [PushIM.Webapp.view.luanchcarousel, 'LaunchPic'], 0);
Ext.cmd.derive('PushIM.Webapp.view.setting.AccountSettingController', Ext.app.ViewController, {
    onBack: function () {
        var b = this,
            a = this.getView();
        if (Config.isPC) {} else {
            (Ext.getApplication() || Ext.route.Router.application).setConfigUrl()
        }
        Ext.Viewport.getController().sVWithOutDestroy('authlogin');
        Ext.destroy(a)
    },
    onAddAccount: function () {
        var d = this;
        var c = this.getView(),
            b = c.down('#listAccount');
        var a = Ext.Msg.prompt('输入新地址', '', function (c, a) {
            if (c === 'ok') {
                d.doAddAccount(a, b)
            }
        }, null, 55, 'https://', {
            multiline: !0
        });
        a.el.addCls('centered-dialog')
    },
    doAddAccount: function (a, e) {
        if (Config.isPC) {
            a = a.replace(/\n/g, '');
            if (!a.startsWith('http')) {
                a = 'https://' + a
            }
            if (a[a.length - 1] != '/') {
                a = a + '/'
            }
            var f = ParseUtil.parseAccID(a);
            cefMain.addAccount(f, a, function (c) {
                var b = c.split('|');
                if (b[0] == 'true') {
                    e.getStore().add({
                        name: a
                    })
                } else {
                    Utils.toastShort(b[1])
                }
            })
        } else {
            a = a.replace(/\n/g, '');
            if (!a.startsWith('http')) {
                a = 'https://' + a
            }
            if (a[a.length - 1] != '/') {
                a = a + '/'
            }
            var b = Ext.decode(localStorage.getItem('accounts'));
            var d = !1;
            for (var c = 0; c < b.length; c++) {
                if (b[c].name == a) {
                    d = !0;
                    break
                }
            }
            if (!d) {
                b.push({
                    name: a
                });
                localStorage.setItem('accounts', Ext.encode(b));
                e.getStore().add({
                    name: a
                })
            }
        }
    },
    childMenu: {
        xtype: 'actionsheet',
        cls: 'docked-bottom',
        items: [{
            itemId: 'labelUrl',
            disabled: !0
        }, {
            text: '编辑',
            style: 'color:blue',
            handler: 'onEditLine'
        }, {
            text: '删除',
            cls: 'red',
            margin: '0 0 10 0',
            handler: 'onDeleteLine'
        }, {
            text: '取消',
            style: 'color:blue;font-weight:bold'
        }]
    },
    onTapOption: function (e, d, a) {
        var c = this;
        var b = d.data.name;
        if (a === 'delete') {
            c.onDeleteLine(b)
        } else {
            if (a === 'edit') {
                c.onEditLine(b)
            }
        }
    },
    onChildTap: function (g, a, f) {
        if (Config.isPC && !Config.newLoginWays) {
            var e = this;
            var c = a.sourceElement;
            if (c) {
                var d = a.record.data.name;
                var b = c.getAttribute('data');
                if (b == 'edit') {
                    e.onEditLine(d);
                    return !1
                } else {
                    if (b == 'delete') {
                        e.onDeleteLine(d);
                        return !1
                    }
                }
            }
        }
    },
    onSelect: function (h, a, g) {
        if (Config.isPC) {
            var f = this;
            var b = a.get('routeUrl'),
                e = a.get('routeID'),
                d = 'selectRoute';
            if (!Config.newLoginWays) {
                b = a.get('name');
                e = ParseUtil.parseAccID(b);
                d = 'selectAccount'
            }
            cefMain[d](e, function (d) {
                var c = d.split('|');
                if (c[0] == 'true') {
                    f.cefChangeConfig(b)
                } else {
                    Utils.toastShort(c[1])
                }
            })
        } else {
            if (localStorage.getItem('isdemo') == 'N') {
                var c = a.get('name');
                if (Config.newLoginWays) {
                    c = a.get('routeUrl');
                    window.RouteList.updateCurRoute(a.data);
                    localStorage.setItem('newServerUrl', c)
                } else {
                    localStorage.setItem('serverUrl', c)
                }
                this.changeConfig()
            }
        }
    },
    onDeselect: function (c, a, b) {
        if (Config.newLoginWays) {
            return
        }
        if (Config.isPC) {} else {
            localStorage.setItem('serverUrl', '');
            this.changeConfig()
        }
    },
    beforeActionShow: function () {
        return this.selectUrl != null
    },
    onDeleteLine: function (c) {
        if (Config.isPC) {
            var i = this,
                e = this.getView(),
                d = e.down('#listAccount');
            var b = d.getStore();
            var a = -1;
            b.each(function (d, b) {
                if (d.get('name') == c) {
                    a = b;
                    return !1
                }
            });
            if (a > -1) {
                var g = b.getAt(a);
                var h = ParseUtil.parseAccID(g.get('name'));
                cefMain.deleteAccount(h, function (e) {
                    var d = e.split('|');
                    if (d[0] == 'true') {
                        b.removeAt(a)
                    } else {
                        Utils.toastShort(d[1])
                    }
                })
            }
        } else {
            var i = this,
                e = this.getView(),
                d = e.down('#listAccount');
            var b = d.getStore();
            var a = -1;
            b.each(function (d, b) {
                if (d.get('name') == c) {
                    a = b;
                    return !1
                }
            });
            if (a > -1) {
                b.removeAt(a);
                var f = Ext.decode(localStorage.getItem('accounts'));
                f.splice(a, 1);
                localStorage.setItem('accounts', Ext.encode(f));
                if (localStorage.getItem('serverUrl') == c) {
                    localStorage.setItem('serverUrl', '');
                    Config.httpUrlForGo = Config.httpPdcGoUrl;
                    Config.wsGoUrl = Config.wsPdcUrl
                }
            }
        }
    },
    onEditLine: function (b) {
        var a = this,
            e = a.getView(),
            d = e.down('#listAccount');
        var c = Ext.Msg.prompt('输入新地址', '', function (e, c) {
            if (e === 'ok') {
                a.doEditLine(c, d, b)
            }
        }, a, 55, b, {
            multiline: !0
        });
        c.el.addCls('centered-dialog')
    },
    doEditLine: function (a, f, c) {
        if (Config.isPC) {
            var k = this;
            a = a.replace(/\n/g, '');
            if (!a.startsWith('http')) {
                a = 'https://' + a
            }
            if (a[a.length - 1] != '/') {
                a = a + '/'
            }
            var h = ParseUtil.parseAccID(c);
            var g = ParseUtil.parseAccID(a);
            cefMain.updateAccount(h, g, a, function (e) {
                var b = e.split('|');
                if (b[0] == 'true') {
                    var d = f.getStore();
                    d.each(function (b, d) {
                        if (b.get('name') == c) {
                            b.set('name', a);
                            return !1
                        }
                    });
                    k.cefChangeConfig(a)
                } else {
                    Utils.toastShort(b[1])
                }
            })
        } else {
            var i = this;
            a = a.replace(/\n/g, '');
            if (!a.startsWith('http')) {
                a = 'https://' + a
            }
            if (a[a.length - 1] != '/') {
                a = a + '/'
            }
            var b = Ext.decode(localStorage.getItem('accounts'));
            var e = !1;
            for (var d = 0; d < b.length; d++) {
                if (b[d].name == a) {
                    break
                }
                if (b[d].name == c) {
                    b[d].name = a;
                    e = !0;
                    break
                }
            }
            if (e) {
                localStorage.setItem('accounts', Ext.encode(b));
                var j = f.getStore();
                j.each(function (b, d) {
                    if (b.get('name') == c) {
                        b.set('name', a);
                        return !1
                    }
                });
                if (localStorage.getItem('serverUrl') == c) {
                    localStorage.setItem('serverUrl', a);
                    i.changeConfig()
                }
            }
        }
    },
    accountsMenu: {
        xtype: 'actionsheet',
        items: [{
            itemId: 'labelUrl',
            disabled: !0,
            text: '选择一个账套地址'
        }, {
            text: '取消',
            style: 'color:blue;font-weight:bold'
        }]
    },
    scanAccounts: function () {
        var a = this;
        var c = a.getView(),
            b = c.down('#listAccount');
        Config.ChooseFile = 'Y';
        cordova.plugins.barcodeScanner.scan(function (c) {
            Config.ChooseFile = 'N';
            if (c.cancelled) {
                return
            }
            if (c.format == 'QR_CODE') {
                a.parseQRCode(c.text, b)
            }
        }, function (a) {
            Config.ChooseFile = 'N';
            Utils.alert('扫码错误: ' + a)
        }, {
            'showFlipCameraButton': !0
        })
    },
    parseQRCode: function (i, e) {
        if (Ext.isEmpty(i)) {
            return
        }
        var o = this,
            m = !1;
        if (i.substr(0, 5).toLowerCase() == 'host|') {
            var h = i.split('|'),
                l = h[1].toLowerCase();
            if (h.length >= 3 && l == 'aio') {
                m = !0;
                var g = [];
                var c = Ext.decode(localStorage.getItem('accounts'));
                for (var a = 2; a < h.length; a++) {
                    var b = h[a];
                    b = b.replace(/\n/g, '');
                    if (!b.startsWith('http')) {
                        b = 'https://' + b
                    }
                    if (b[b.length - 1] != '/') {
                        b = b + '/'
                    }
                    g.push(b)
                }
                if (g.length == 1) {
                    var d = g[0];
                    var f = !1;
                    for (var a = 0; a < c.length; a++) {
                        if (c[a].name == d) {
                            f = !0;
                            var k = e.getStore().find('name', d);
                            if (k > -1) {
                                e.getSelectable().select(k)
                            }
                            break
                        }
                    }
                    if (!f) {
                        c.push({
                            name: d
                        });
                        localStorage.setItem('accounts', Ext.encode(c));
                        var n = e.getStore().add({
                            name: d
                        });
                        e.getSelectable().select(n)
                    }
                } else {
                    for (var a = 0; a < g.length; a++) {
                        var d = g[a];
                        var f = !1;
                        for (var j = 0; j < c.length; j++) {
                            if (c[j].name == d) {
                                f = !0;
                                break
                            }
                        }
                        if (!f) {
                            c.push({
                                name: d
                            });
                            e.getStore().add({
                                name: d
                            })
                        }
                    }
                    localStorage.setItem('accounts', Ext.encode(c))
                }
                localStorage.setItem('isdemo', 'N');
                e.show()
            }
        }
    },
    changeConfig: function () {
        var b = localStorage.getItem('serverUrl');
        if (Config.newLoginWays) {
            b = localStorage.getItem('newServerUrl')
        }
        if (!b) {
            Config.httpUrlForGo = Config.httpPdcGoUrl;
            Config.wsGoUrl = Config.wsPdcUrl
        } else {
            var c = 'wss';
            var a = b;
            if (a && a.indexOf) {
                if (a.toLowerCase().startsWith('http://')) {
                    c = 'ws'
                }
                var d = a.indexOf(':');
                if (d > -1) {
                    Config.wsGoUrl = Utils.joinPath(c + a.substring(d), 'api/v1/websocket')
                } else {
                    Config.wsGoUrl = Utils.joinPath(c + '://' + a, 'api/v1/websocket')
                }
                Config.httpUrlForGo = Utils.joinPath(a, 'api/v1/')
            }
        }
    },
    cefChangeConfig: function (f) {
        if (!f) {
            Config.httpUrlForGo = Config.httpPdcGoUrl;
            Config.wsGoUrl = Config.wsPdcUrl
        } else {
            var c = 'wss';
            var a;
            if (Config.newLoginWays) {
                var b = JSON.parse(cefMain.getCurrentRouteConfigJsonStr());
                if (b.IsDemo == 'Y') {
                    a = b.DemoRouteUrl
                } else {
                    a = b.RouteUrl
                }
            } else {
                var e = JSON.parse(cefMain.getLoginConfigJsonStr());
                a = e.CurrentAccount.AccountName
            }
            if (a && a.indexOf) {
                if (a.toLowerCase().startsWith('http://')) {
                    c = 'ws'
                }
                var d = a.indexOf(':');
                if (d > -1) {
                    Config.wsGoUrl = Utils.joinPath(c + a.substring(d), 'api/v1/websocket')
                } else {
                    Config.wsGoUrl = Utils.joinPath(c + '://' + a, 'api/v1/websocket')
                }
                Config.httpUrlForGo = Utils.joinPath(a, 'api/v1/')
            }
        }
    },
    onChangeDemo: function (i, g) {
        if (Config.isPC) {
            var c = this,
                d = c.getView();
            var b = d.down('#listAccount');
            var a;
            if (Config.newLoginWays) {
                var f = JSON.parse(cefMain.getCurrentRouteConfigJsonStr());
                a = f.IsDemo
            } else {
                var e = JSON.parse(cefMain.getLoginConfigJsonStr());
                a = e.IsDemo
            }
            if (a == 'Y') {
                cefMain.useDemo('N', function (c) {
                    var a = c.split('|');
                    if (a[0] == 'true') {
                        b.show()
                    } else {
                        Utils.toastShort('更改出错')
                    }
                })
            } else {
                cefMain.useDemo('Y', function (d) {
                    var a = d.split('|');
                    if (a[0] == 'true') {
                        b.hide();
                        c.cefChangeConfig('demourl')
                    } else {
                        Utils.toastShort('更改出错')
                    }
                })
            }
        } else {
            var c = this,
                d = c.getView();
            var b = d.down('#listAccount');
            var a = localStorage.getItem('isdemo');
            var h = a == 'Y' ? !0 : !1;
            if (h == g) {
                return
            }
            if (a == 'Y') {
                localStorage.setItem('isdemo', 'N');
                if (Config.newLoginWays) {
                    window.RouteList.updateDemoRoute('N')
                }
                b.show()
            } else {
                localStorage.setItem('isdemo', 'Y');
                if (Config.newLoginWays) {
                    window.RouteList.updateDemoRoute('Y')
                }
                b.hide()
            }
            if (Config.newLoginWays) {
                c.changeConfig()
            }
        }
    }
}, 0, 0, 0, 0, ['controller.accountsetting'], 0, [PushIM.Webapp.view.setting, 'AccountSettingController'], 0);
Ext.cmd.derive('PushIM.Webapp.view.setting.AccountSetting', Ext.Container, {
    controller: 'accountsetting',
    cls: 'acSetting',
    viewModel: {
        data: {
            isHideScan: !0,
            isPC: !1
        }
    },
    items: [{
        xtype: 'titlebar',
        userCls: 'acSettingTitle topinset',
        docked: 'top',
        items: [{
            text: '返回',
            iconCls: 'far fa-angle-left',
            align: 'left',
            handler: 'onBack'
        }, {
            iconCls: 'im-common-add1',
            align: 'right',
            bind: {
                hidden: '{isHideScan}'
            },
            handler: 'onAddAccount'
        }]
    }, {
        xtype: 'container',
        layout: 'hbox',
        userCls: 'btn-toggle mobile-toggle',
        docked: 'top',
        style: 'margin-top: 20px',
        items: [{
            xtype: 'label',
            html: '启用演示账套',
            flex: 1,
            userCls: 'toggle-label'
        }, {
            xtype: 'togglefield',
            itemId: 'btnDemo'
        }]
    }, {
        xtype: 'list',
        cls: 'support-select',
        itemId: 'listAccount',
        padding: '10 0 0 0',
        itemTpl: ['<div class="item-wrapper">', '<div class="select"></div>', '<tpl if="values.routeID && Config.newLoginWays">', '<div class="Content">线路{routeID}</div>', '<tpl elseif="values.name">', '<div class="Content">', '<div class="name-wrapper">{name}</div>', '<div class="link-wrapper">{[this.buildActionHtml(values)]}</div>', '</div>', '</tpl>', '</div>', {
            buildActionHtml: function (a) {
                if (Config.isPC && !Config.newLoginWays) {
                    return '<a class="link edit" data="edit">编辑</a><a class="link delete" data="delete">删除</a>'
                }
                return ''
            }
        }],
        store: {},
        items: [{
            xtype: 'container',
            docked: 'top',
            style: 'padding-left:10px;padding-top:10px;',
            bind: {
                html: '{isHideScan?"选择线路":"选择账套"}'
            }
        }],
        plugins: {},
        listeners: {
            childtap: 'onChildTap',
            select: 'onSelect',
            deselect: 'onDeselect',
            listoptiontap: 'onTapOption'
        }
    }, {
        xtype: 'container',
        cls: 'bottominset match-child',
        docked: 'bottom',
        itemId: 'btnScanContain',
        bind: {
            hidden: '{isHideScan || isPC}'
        },
        items: [{
            xtype: 'button',
            itemId: 'btnScan',
            iconCls: 'x-fa fa-qrcode',
            height: 45,
            style: 'width:100%',
            text: '扫一扫添加账套',
            handler: 'scanAccounts'
        }]
    }],
    destroy: function () {
        if (this.controller.childMenu) {
            Ext.destroy(this.controller.childMenu)
        }
        Ext.Container.prototype.destroy.call(this)
    },
    initialize: function () {
        var f = this;
        Ext.Container.prototype.initialize.apply(this, arguments);
        if (!Config.newLoginWays && !Config.isPC) {
            var t = f.down('#listAccount');
            var u = {
                type: 'listoptions',
                items: [{
                    text: '编辑',
                    color: 'bg-soft-blue',
                    action: 'edit'
                }, {
                    text: '移除',
                    color: 'bg-soft-red',
                    action: 'delete'
                }]
            };
            t.addPlugin(u)
        }
        if (Config.isPC) {
            var b = f.down('#listAccount'),
                e = b.getStore();
            var d, c, a;
            if (Config.newLoginWays) {
                var s = JSON.parse(cefMain.getRouteConfigJsonStr());
                var g = JSON.parse(cefMain.getCurrentRouteConfigJsonStr());
                d = g.IsDemo;
                var l = s.RouteList;
                var q = [];
                for (var j = 0; j < l.length; j++) {
                    q.push({
                        routeUrl: l[j].RouteUrl,
                        routeID: l[j].RouteID
                    })
                }
                e.add(q);
                c = g.RouteUrl;
                if (g.IsDemo == 'Y') {
                    c = g.DemoRouteUrl
                }
                a = e.find('routeUrl', c)
            } else {
                var k = JSON.parse(cefMain.getLoginConfigJsonStr());
                d = k.IsDemo;
                var n = k.AccountList;
                var h = [];
                for (var m = 0; m < n.length; m++) {
                    h.push({
                        name: n[m].AccountName
                    })
                }
                e.add(h);
                f.getViewModel().setData({
                    isHideScan: !1,
                    isPC: !0
                });
                c = k.CurrentAccount.AccountName;
                a = e.find('name', c)
            }
            if (a > -1) {
                b.getSelectable().select(a)
            }
            if (d == 'Y') {
                b.hide()
            } else {
                b.show()
            }
            var p = f.down('#btnDemo');
            p.setValue(d == 'Y');
            p.on({
                change: 'onChangeDemo'
            })
        } else {
            var b = f.down('#listAccount'),
                e = b.getStore();
            var i = localStorage.getItem('accounts');
            var h = [];
            var c = localStorage.getItem('serverUrl');
            var d = localStorage.getItem('isdemo');
            if (Config.newLoginWays) {
                c = localStorage.getItem('newServerUrl');
                i = localStorage.getItem('newAccounts')
            } else {
                f.getViewModel().setData({
                    isHideScan: !1
                })
            }
            if (d == null && i == null) {
                d = 'Y';
                localStorage.setItem('isdemo', 'Y')
            }
            var o = f.down('#btnDemo');
            o.setValue(d == 'Y');
            o.on({
                change: 'onChangeDemo'
            });
            if (d == 'Y') {
                b.hide()
            } else {
                b.show()
            }
            if (i) {
                h = Ext.decode(i)
            } else {
                localStorage.setItem('accounts', Ext.encode(h))
            }
            e.loadData(h);
            if (c) {
                var a = e.find('routeUrl', c);
                if (!Config.newLoginWays) {
                    a = e.find('name', c)
                }
                if (a > -1) {
                    b.getSelectable().select(a)
                } else {
                    if (Config.newLoginWays) {
                        var g = JSON.parse(localStorage.getItem('currentRoute')),
                            r = g.routeUrl;
                        a = e.find('routeUrl', r);
                        if (a > -1) {
                            b.getSelectable().select(a)
                        }
                    }
                }
            }
        }
    }
}, 0, ['acSetting'], ['widget', 'component', 'container', 'acSetting'], {
    'widget': !0,
    'component': !0,
    'container': !0,
    'acSetting': !0
}, ['widget.acSetting'], 0, [PushIM.Webapp.view.setting, 'AccountSetting'], 0);
Ext.cmd.derive('PushIM.Webapp.view.setting.CEFSetting', Ext.Container, {
    cls: 'CefDrag',
    layout: 'vbox',
    padding: '20 10 0 0',
    items: [{
        xtype: 'titlebar',
        title: '网络设置',
        items: [{
            xtype: 'button',
            ui: 'back',
            docked: 'left',
            text: '返回',
            iconCls: 'x-fa fa-chevron-left',
            handler: function (b) {
                var a = b.up('CEFSetting').down('#netForm').getValues();
                if (a.net == 'in') {
                    localStorage.setItem('inOrOut', 'in')
                } else {
                    if (a.net == 'out') {
                        localStorage.setItem('inOrOut', 'out')
                    }
                }
                Ext.getApplication().setConfigUrl();
                Ext.Viewport.getController().showView('authlogin')
            }
        }, {
            xtype: 'button',
            align: 'right',
            iconCls: 'x-fa fa-plus'
        }]
    }, {
        xtype: 'container',
        itemId: 'imiTitle',
        layout: 'hbox',
        cls: 'loginImitateBrowse',
        hidden: !0,
        height: 25,
        items: [{
            xtype: 'component',
            flex: 1
        }, {
            xtype: 'button',
            cls: 'CefNoDrag',
            ui: 'cefClose',
            docked: 'right',
            iconCls: 'i-im-close',
            handler: function () {
                if (window.cefMain) {
                    window.cefMain.close()
                }
            }
        }]
    }, {
        flex: 1,
        items: [{
            xtype: 'formpanel',
            itemId: 'netForm',
            cls: 'CefNoDrag',
            items: [{
                xtype: 'radiofield',
                name: 'net',
                value: 'in',
                label: '网络',
                boxLabel: '内网',
                checked: !0,
                listeners: {
                    check: function (a, c) {
                        var b = a.up('CEFSetting').down('#txSer');
                        b.setValue(localStorage.getItem('inUrl'));
                        localStorage.setItem('inOrOut', 'in')
                    }
                }
            }, {
                xtype: 'radiofield',
                name: 'net',
                value: 'out',
                label: ' ',
                boxLabel: '外网',
                listeners: {
                    check: function (a, c) {
                        var b = a.up('CEFSetting').down('#txSer');
                        b.setValue(localStorage.getItem('outUrl'));
                        localStorage.setItem('inOrOut', 'out')
                    }
                }
            }]
        }, {
            xtype: 'textfield',
            itemId: 'txSer',
            cls: 'CefNoDrag',
            label: '服务器',
            listeners: {
                blur: function (a) {
                    var b = a.up('CEFSetting').down('#netForm').getValues();
                    if (b.net == 'in') {
                        localStorage.setItem('inUrl', a.getValue())
                    } else {
                        if (b.net == 'out') {
                            localStorage.setItem('outUrl', a.getValue())
                        }
                    }
                }
            }
        }]
    }],
    initialize: function () {
        if (Config.isPC) {
            this.down('#imiTitle').setHidden(!1)
        }
        this.down('#txSer').setValue(localStorage.getItem('inUrl'))
    }
}, 0, ['CEFSetting'], ['widget', 'component', 'container', 'CEFSetting'], {
    'widget': !0,
    'component': !0,
    'container': !0,
    'CEFSetting': !0
}, ['widget.CEFSetting'], 0, [PushIM.Webapp.view.setting, 'CEFSetting'], 0);
Ext.cmd.derive('PushIM.Webapp.view.setting.ChangePwd', Ext.Container, {
    controller: 'accountsetting',
    referenceHolder: !0,
    defaultListenerScope: !0,
    cls: 'setting-chgpwd',
    viewModel: {
        data: {
            account: ''
        }
    },
    items: [{
        xtype: 'titlebar',
        userCls: 'acSettingTitle topinset',
        docked: 'top',
        items: [{
            text: '返回',
            iconCls: 'far fa-angle-left',
            align: 'left',
            handler: 'onBack'
        }]
    }, {
        xtype: 'component',
        cls: 'changepwd-acc',
        bind: {
            html: '当前账套: {account}'
        }
    }, {
        xtype: 'fieldset',
        cls: 'changepwd-field',
        defaults: {
            xtype: 'passwordfield',
            required: !0
        },
        items: [{
            xtype: 'textfield',
            reference: 'userId',
            triggers: {
                token: {
                    cls: 'name-label-before',
                    side: 'left'
                }
            }
        }, {
            reference: 'oldpwd',
            triggers: {
                token: {
                    cls: 'oldpwd-label-before',
                    side: 'left'
                }
            }
        }, {
            reference: 'newpwd',
            triggers: {
                token: {
                    cls: 'newpwd1-label-before',
                    side: 'left'
                }
            }
        }, {
            reference: 'secnewpwd',
            triggers: {
                token: {
                    cls: 'newpwd2-label-before',
                    side: 'left'
                }
            }
        }]
    }, {
        xtype: 'button',
        text: '确认',
        cls: 'chgpwd-btn',
        handler: 'onChgPwd'
    }],
    initialize: function () {
        var a = this;
        Ext.Container.prototype.initialize.apply(this, arguments);
        a.getCurrAccount()
    },
    simpleValid: function () {
        var a = this;
        var e = a.lookupReference('userId')._value;
        var d = a.lookupReference('oldpwd')._value;
        var c = a.lookupReference('newpwd')._value;
        var b = a.lookupReference('secnewpwd')._value;
        if (!e || !d || !c || !b) {
            return !1
        }
        if (c !== b) {
            Ext.Msg.alert('提醒', '两次输入新密码不一致');
            return !1
        }
        return !0
    },
    onChgPwd: function () {
        var a = this;
        var b = a.lookupReference('userId')._value;
        var e = a.lookupReference('oldpwd')._value;
        var d = a.lookupReference('newpwd')._value;
        if (!a.simpleValid()) {
            return
        }
        var c = a.stringifyPwd(b, d);
        a.aioAjax('post', 'users/changepwd', {
            params: JSON.stringify({
                user_id: b,
                password: e,
                new_password: c
            }),
            success: function () {
                a.onBack()
            },
            failure: function (a) {
                Utils.toastShort(a)
            }
        })
    },
    stringifyPwd: function (e, c) {
        var a = '';
        if (Config.isPC) {
            a = cefMain.getEncryptPassword(e, c)
        } else {
            var b = new JSEncrypt();
            var d = '-----BEGIN PUBLIC KEY-----\n    MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQDOCcYEgKyE/3IVysNo+lI/JdaK\n    /olvVLWx9lDrG2PTbx9iPlnP8DB4AX2g9ATk0hWUzXjZ0xhqvN1onj1/oRneaq4Z\n    8/O7LHGxOzuKc2KbIkZM8dxfGIoHuR4flzhvanmbRicqIH8j5i9ZBP2vkXMREW5i\n    h/Cuqo8HidWmNoBZNwIDAQAB\n    -----END PUBLIC KEY-----';
            b.setPublicKey(d);
            a = b.encrypt(c)
        }
        return a
    },
    onBack: function () {
        var a = this;
        Ext.Viewport.getController().sVWithOutDestroy('authlogin');
        Ext.destroy(a)
    },
    getCurrAccount: function () {
        var d = this;
        var c = d.getViewModel();
        var b = 'Y';
        if (Config.isPC) {
            var a;
            if (Config.newLoginWays) {
                a = JSON.parse(cefMain.getCurrentRouteConfigJsonStr())
            } else {
                a = JSON.parse(cefMain.getLoginConfigJsonStr())
            }
            if (a) {
                b = a.IsDemo
            }
        } else {
            b = localStorage.getItem('isdemo')
        }
        if (b == 'Y') {
            c.setData({
                account: '演示账套'
            })
        } else {
            c.setData({
                account: Config.httpUrlForGo.replace('api/v1/', '')
            })
        }
    }
}, 0, ['changepwd'], ['widget', 'component', 'container', 'changepwd'], {
    'widget': !0,
    'component': !0,
    'container': !0,
    'changepwd': !0
}, ['widget.changepwd'], 0, [PushIM.Webapp.view.setting, 'ChangePwd'], 0);
Ext.application({
    extend: PushIM.Webapp.Application,
    name: 'PushIM.Webapp'
});