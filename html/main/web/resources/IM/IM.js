Ext.define(null,{override:'Ext.grid.Grid',show:function(){var a=this;a.callParent(arguments);if(a.getHideHeaders()){a.updateHideHeaders(!0)}}});Ext.define('IM.Model.Attach',{extend:'Ext.data.Model',idProperty:'FileID',fields:['FileID',{name:'AttType',type:'string',defaultValue:'T'},'ID','FileName','Size','Icon',{name:'Progress',type:'float',defaultValue:0},'Status','Error']});Ext.define('IM.model.Chat',{extend:'Ext.data.Model',idProperty:'msg_id',fields:['senderName','sendText',{name:'updateTime',type:'date',convert:function(a){return Utils.datetime2Ago(a,!0)}},'file','ROL',{name:'showTime',type:'bool',defaultValue:!0},'msg_id',{name:'showGrpChange',type:'bool',defaultValue:!1},'GrpChangeMsg','msg_type','file_id','fileID','fileName','fileSize','fileIcon',{name:'fileProgress',type:'float',defaultValue:0},'fileStatus']});Ext.define('IM.model.GroupMembers',{extend:'Ext.data.Model',idProperty:'user_id',fields:['uid','name','mobile','email','isManager',{name:'status',type:'int',defaultValue:-1},{name:'user_id',type:'string'},{name:'user_name',type:'string'},'onlineDev','crowdDsc','isadmin']});Ext.define('IM.model.Mention',{extend:'Ext.data.Model',fields:['user_id','user_name','Type',{name:'TypeDesc',type:'string',convert:function(b,a){switch(a.get('Type')){case 'R':return '岗位';case 'G':return '用户组';case 'O':return '组织';case 'D':return '部门';default:return '用户';}}}]});Ext.define('IM.model.RecentSelMem',{extend:'Ext.data.Model',idProperty:'chat_id',fields:['chat_id','chat_name','userID','type','isUnRead',{name:'status',type:'int',convert:function(a){if(a==0){return '在线'}else {if(a==-1){return '离线'}}return ''}},{name:'name',type:'string'},{name:'last_post_at',convert:function(a){if(a==0||a==undefined||a==null){return ''}return Utils.datetime2Ago(a,!0)}},{name:'unReadNum',type:'int',defaultValue:0},{name:'toTop',type:'boolean',defaultValue:!1},{name:'last_post_name',type:'string'},'last_msg_type','last_post_msg','members']});Ext.define('IM.model.viewModel.ChatViewDetail',{extend:'Ext.app.ViewModel',alias:'viewmodel.chatView_detail',data:{hideMoreMsg:!0,msgNum:0,hideUpBtn:!0,upMsgNum:0,upBtnTime:0,hideAtBtn:!0,atCount:0}});Ext.define('IM.model.viewModel.IMMainBind',{extend:'Ext.app.ViewModel',alias:'viewmodel.mainBind',data:{avatar:'',ditStu:'',ditInCom:'',isHideBrowseTitle:!0,menuGroup:{sendKey:'Ctrl+Enter'},allUnreadNum:0,allReplyCount:0,wkBadgeNum:0},formulas:{wkBadgeNumHtml:function(b){var a=b('wkBadgeNum');if(a==0){return null}if(a>0&&a<=99){return ''+a}if(a>99){return '99+'}}}});Ext.define('IM.model.Organization',{extend:'Ext.app.ViewModel',alias:'viewmodel.organization',stores:{navItems:{fields:['id','name',{name:'iconCls',defaultValue:'hide-icon'}],type:'tree',rootVisible:!0,root:{mtype:'orgTree',expanded:!0,name:'All',iconCls:'hide-icon',children:[{mtype:'orgTree',name:'Home',iconCls:'hide-icon',children:[{mtype:'orgTree',name:'Messages',numItems:231,check:!0,iconCls:'hide-icon',leaf:!0},{mtype:'orgTree',name:'Archive',iconCls:'hide-icon',children:[{mtype:'orgTree',name:'First',numItems:7,check:!1,iconCls:'hide-icon',leaf:!0},{mtype:'orgTree',name:'No Icon',numItems:0,check:!0,iconCls:'hide-icon',leaf:!0}]},{mtype:'orgTree',name:'Music',numItems:3000,iconCls:'hide-icon',leaf:!0},{mtype:'orgTree',name:'Video',numItems:1000,iconCls:'hide-icon',leaf:!0}]},{mtype:'orgTree',name:'Users',iconCls:'hide-icon',children:[{mtype:'orgTree',name:'Tagged',numItems:53,iconCls:'hide-icon',leaf:!0},{mtype:'orgTree',name:'Inactive',numItems:9,iconCls:'hide-icon',leaf:!0}]},{mtype:'orgTree',name:'Groups',numItems:3,iconCls:'hide-icon',leaf:!0},{mtype:'orgTree',name:'Settings',iconCls:'hide-icon',children:[{mtype:'orgTree',name:'Sharing',numItems:4,iconCls:'hide-icon',leaf:!0},{mtype:'orgTree',name:'Notifications',numItems:16,leaf:!0},{mtype:'orgTree',name:'Network',numItems:4,leaf:!0}]}]}}}});Ext.define('IM.plugin.DraggableHandle',{alias:'plugin.draggablehandle',init:function(a){var b=this;a.element.setStyle({'-webkit-app-region':'drag'});a.element.on({doubletap:'onDoubleTap',scope:b})},onDoubleTap:function(){if(window.cefMain){cefMain.max()}}});Ext.define('IM.store.IMOrg',{extend:'Ext.data.TreeStore',alias:'store.IMOrg',root:{name:'loading'},rootVisible:!1,fields:['uid','name','parentID',{name:'iconCls',defaultValue:'hide-icon'},{name:'isSel',type:'bool'},'defRoleID','defRoleName','avaHash','email','mobile','notes','orgIDs','orgNames','phone','roleIDs','roleNames','sex','age'],sorters:[{property:'leaf',direction:'DESC'},{property:'id',direction:'ASC'}]});Ext.define('IM.store.ChatView',{extend:'Ext.data.Store',alias:'store.chatView',model:'IM.model.Chat'});Ext.define('IM.utils.BindHelper',{alternateClassName:'BindHelper',singleton:!0,bindDefaultFav:function(){var a=this;Utils.custAjax('get','users/me/chatfavorites',{success:function(b){User.favChats=b;b=a.sortFav(b);for(var c=0;c<b.length;c++){var d=b[c];a.doExtraFav(d)}}})},sortFav:function(a){var d=a.length;for(var c=0;c<d;c++){for(var b=0;b<d-1-c;b++){if(a[b].fav_index>a[b+1].fav_index){var e=a[b+1];a[b+1]=a[b];a[b]=e}}}return a},doExtraFav:function(a){var c=this;var b=a.chat_id;var d='select * from IMChat WHERE ChatID=?;';LocalDataMgr.cExecSqlWithP(d,[b],function(g,e){var d=e.rows;if(d.length>0){var f=d.item(0);c.parseFavDataL(f,a)}else {c.getChatFromServer(b,a)}},function(){Utils.toastShort('对不起，您的数据已丢失(收藏)')})},parseFavDataL:function(b,a){var f=this;if(a.iscrowd=='Y'){a.chat_type='C'}var d=a.chat_type;if(!d){d=b.ChatType}var c=b.ChatID;if(d==ChatType.Direct){var e=b.UserIDs.split(',');if(e[0]==User.ownerID){c=e[1]}else {c=e[0]}}var g={fav_index:a.fav_index,fav_name:a.fav_name==''?b.DisplayName:a.fav_name,header:b.DisplayName,avaID:c,chat_type:a.chat_type?a.chat_type:b.ChatType,chat_id:a.chat_id,chat_create_at:a.chat_create_at>0?a.chat_create_at:b.CreateAt};f.doBindFavToDragGrid(g);var h={fromFav:!0,leaf:!0,iconCls:'hide-icon',header:b.DisplayName,name:a.fav_name==''?b.DisplayName:a.fav_name,chat_id:a.chat_id,chat_create_at:a.chat_create_at>0?a.chat_create_at:b.CreateAt,fav_index:a.fav_index,chat_type:a.chat_type?a.chat_type:b.ChatType,avaID:c};f.doBindFavToTree(h)},bindCrowdList:function(){var d=this;var b=ViewGet.getSecOrgStore();var c=b.findRecord('uid','crowd');c.childNodes=[];for(var a=0;a<User.crowdInfo.length;a++){var e=User.crowdInfo[a];d.docrowdlist(e)}},docrowdlist:function(a){var c=this;var b={msgCrowdFav:!0,leaf:!0,iconCls:'hide-icon',header:a.header,chat_id:a.chat_id,chat_create_at:a.create_at,chat_type:'C',id:a.id};c.doBindCrowdTree(b)},doBindCrowdTree:function(c){var d=this;var b=ViewGet.getSecOrgStore();var a=b.findRecord('uid','crowd');if(a){console.log('绑定组织结构');a.appendChild(c)}},parseFavDataR:function(a,b){if(a.iscrowd=='Y'){a.chat_type='C'}var d=a.chat_type,c=a.chat_id;if(d==ChatType.Direct){if(a.members[0].user_id==User.ownerID){c=a.members[1].user_id}else {c=a.members[0].user_id}}var e={fav_index:b.fav_index,fav_name:b.fav_name==''?a.header:b.fav_name,header:a.header,avaID:c,chat_type:d,chat_id:b.chat_id,chat_create_at:b.chat_create_at>0?b.chat_create_at:a.create_at};this.doBindFavToDragGrid(e);var f={fromFav:!0,leaf:!0,iconCls:'hide-icon',header:a.header,name:b.fav_name==''?a.header:b.fav_name,chat_id:b.chat_id,chat_create_at:b.chat_create_at>0?b.chat_create_at:a.create_at,fav_index:b.fav_index,chat_type:d,avaID:c};this.doBindFavToTree(f)},doBindFavToDragGrid:function(b){var a=ViewGet.getSecFavGridStore();var c=a.findRecord('chat_id',b.chat_id);if(c){a.remove(c)}a.add(b);a.getSorters().add('fav_index');a.getSorters().remove('fav_index')},doBindFavToTree:function(d){var a=ViewGet.getSecOrgStore();var b=a.findRecord('uid','favPlace');var c=b.findChild('chat_id',d.chat_id,!0);if(b){if(c){c.remove()}b.appendChild(d)}a.getSorters().add('fav_index');a.getSorters().remove('fav_index')},getChatFromServer:function(a,c){var b=this;Utils.custAjax('get','users/me/chats/'+a,{success:function(d){b.parseFavDataR(d,c)}})},getCrtOrgs:function(){var a=User.grpOrgs[0]||{};if(User.crtCorpID){for(var c=0;c<User.grpOrgs.length;c++){var d=User.grpOrgs[c];if(User.crtCorpID==d.corp_id){a=d;break}}}else {User.crtCorpID=a.corp_id}User.orgRootName=a.name||'通讯录';if(!ConfigMgr.showOrgRoot()){var e=[];if(a.children){for(var b=0;b<a.children.length;b++){if(!a.children[b].leaf){e.push(a.children[b])}}}return e}return [a]},bindOrgWithCache:function(a){var b=this;if(!a){return}b.bindOrgWoFav(a);b.bindOthers()},_dbCacheKey:'grpOrganization',bindOrgWoFav:function(d){if(!d){return}var a=this,g=User.organization.concat(),f=User.allUsers.concat();var c=ConfigMgr.isAio8()?a.orgAddUsersForAio8(g,f):a.orgAddUsersForAio75(g,f);var e=a.createRoot(c);User.grpOrgs=[];for(var b=0;b<e.length;b++){var h=a.addOrg(e[b],c);User.grpOrgs.push(h)}var i=a.getCrtOrgs();a._data2Store(d,i)},_data2Store:function(a,d){var c=[{name:'消息中心',uid:'bnewsPlace',leaf:!0},{name:'群',uid:'crowd',msgCrowdFav:!0,iconCls:'hide-icon'},{name:'收藏',uid:'favPlace',fromFav:!0,iconCls:'hide-icon'},{name:User.orgRootName,uid:'orgPlace',iconCls:'hide-icon',children:ConfigMgr.showOrgRoot()?d[0].children:d}];if(ConfigMgr.isAio8()){c.shift()}var b=a.getStore();var e=Ext.create('Ext.data.TreeStore',{root:{name:'loading',children:c},rootVisible:!1,sorters:[{property:'leaf',direction:'DESC'},{property:'defRoleID',direction:'ASC'},{property:'uid',direction:'ASC'}]});a.setStore(e);a.expandAll();if(b){Ext.destroy(b)}BindHelper.treeNodeCollapse(a)},treeNodeCollapse:function(a){if(!a){a=Ext.getCmp('mainOrg')}var e=a.getStore();var d=JSON.parse(cefMain.getUserOrgData());var b=d.orgroot_show;try{b=JSON.parse(b);var c=b[User.crtCorpID]||[];c.forEach(function(c){var b=e.findRecord('uid',c);if(b){a.collapseNode(b)}})}catch(f){}},bindOrg:function(a){if(!a){return}this.bindOrgWoFav(a);this.bindOthers()},bindOthers:function(){this.bindDefaultFav();this.bindGroupChat()},bindGroupChat:function(){Utils.custAjax('get','users/me/chatcs',{success:function(a){User.crowdInfo=a;BindHelper.bindcrodlist()}})},bindcrodlist:function(){this.bindCrowdList()},createRoot:function(b){var c=[];for(var a=0;a<b.length;a++){if(b[a].parent_id===''&&b[a].org_id===''){continue}if(b[a].parent_id.toLowerCase()==='root'||b[a].parent_id===''){var d={uid:b[a].org_id,name:b[a].org_name,leaf:!1,iconCls:'hide-icon',parent_id:b[a].parent_id,org_id:b[a].org_id,corp_id:b[a].corp_id,children:b[a].children};c.push(d)}}return c},addOrg:function(c,a){for(var b=0;b<a.length;b++){if(a[b].parent_id==c.org_id&&a[b].corp_id==c.corp_id){c.children.push({uid:a[b].org_id,name:a[b].org_name,leaf:!1,iconCls:'hide-icon',parent_id:a[b].parent_id,org_id:a[b].org_id,corp_id:a[b].corp_id,children:a[b].children});this.addOrg(a[b],a)}}return c},orgAddUsersForAio8:function(c,b){for(var d=0;d<c.length;d++){c[d].children=[];for(var a=0;a<b.length;a++){var f=b[a].roles;for(var e=0;e<f.length;e++){var g=f[e];if(g.org_id==c[d].org_id&&g.corp_id==c[d].corp_id){var h={uid:b[a].user_id,name:b[a].user_name,defRoleName:b[a].def_role_name,leaf:!0,defRoleID:b[a].def_role_id,sex:b[a].sex,email:b[a].email,mobile:b[a].mobile,notes:b[a].notes,avaHash:b[a].avatar_hash,age:b[a].age,iconCls:'hide-icon',user_posts:b[a].user_posts};c[d].children.push(h);break}}}}return c},orgAddUsersForAio75:function(c,b){for(var d=0;d<c.length;d++){c[d].children=[];for(var a=0;a<b.length;a++){var f=b[a].org_ids.split(',');for(var e=0;e<f.length;e++){var g=f[e];if(g==c[d].org_id){var h={uid:b[a].user_id,name:b[a].user_name,defRoleName:b[a].def_role_name,leaf:!0,defRoleID:b[a].def_role_id,sex:b[a].sex,email:b[a].email,mobile:b[a].mobile,notes:b[a].notes,avaHash:b[a].avatar_hash,age:b[a].age,iconCls:'hide-icon',user_posts:b[a].user_posts};c[d].children.push(h);break}}}}return c},loadOrganization:function(m,k){var i=this,g=m.getStore(),n=g.getRoot(),e=[],c=User.organization.concat(),b=User.allUsers.concat();g.setRootVisible(!1);for(var d=0;d<c.length;d++){if(c[d].parent_id.toLowerCase()==='root'||c[d].parent_id===''){var o=n.appendChild({uid:c[d].org_id,name:c[d].org_name,leaf:!1,iconCls:'x-fa fa-folder',parent_id:c[d].parent_id});i.createNodes(o,c)}}e=i.getNodes(n,e);var l=!1;var h;for(var f=0;f<e.length;f++){for(var a=0;a<b.length;a++){h=b[a].org_ids.split(',');for(var j=0;j<h.length;j++){if(h[j]==e[f].data.uid){if(k){l=i.getIsDef(b[a].user_id,k)}e[f].insertChild(0,{uid:b[a].user_id,name:b[a].user_name,defRoleName:b[a].def_role_name,leaf:!0,isSel:l,defRoleID:b[a].def_role_id,sex:b[a].sex,email:b[a].email,mobile:b[a].mobile,notes:b[a].notes,avaHash:b[a].avatar_hash,age:b[a].age});break}}}}g.sort();m.expandAll()},getIsDef:function(d,b){var c=!1;for(var a=0;a<b.length;a++){if(b[a]==d){c=!0;break}}return c},createNodes:function(c,a){var d=this;for(var b=0;b<a.length;b++){if(a[b].parent_id==c.data.uid){var e=c.appendChild({uid:a[b].org_id,name:a[b].org_name,leaf:!1,iconCls:'x-fa fa-folder'});d.createNodes(e,a)}}},appendUsers:function(e){var b=User.allUsers;for(var a=0;a<b.length;a++){var d=b[a].org_ids.split(',');for(var c=0;c<d.length;c++){if(d[c]==e.data.uid){e.appendChild({uid:b[a].user_id,name:b[a].user_name,def_role_name:b[a].def_role_name,leaf:!0});break}}}},getNodes:function(c,b){var d=this;for(var a=0;a<c.childNodes.length;a++){b.push(c.childNodes[a]);d.getNodes(c.childNodes[a],b)}return b},addChannelToRecent:function(a){var c=Ext.getStore('comRct');var b='';if(a.chat_type==ChatType.Multi){b=a.header;c.insert(0,{chat_id:a.chat_id,name:b,type:a.chat_type,chat_name:a.chat_name,isUnRead:!1,avaHash:a.avatar_hash,members:a.members,last_msg_type:MsgType.GroupNotice,last_post_msg:GroupNotice.createNewGrpNotice(a.creator_id,a.members),last_post_at:ParseUtil.getLocalTime(),avaID:a.chat_id,create_at:a.create_at})}else {if(a.chat_type==ChatType.Direct){b=a.display_name;c.insert(0,{chat_id:a.chat_id,name:b,type:a.chat_type,chat_name:a.chat_name,isUnRead:!1,avaHash:a.avatar_hash,members:a.members,last_post_at:ParseUtil.getLocalTime(),avaID:ParseUtil.getDctIdFromMems(a.members)})}}},addChannelToRecent1:function(a,b,c,e){var d=this;if(e){Utils.custAjax('GET','users/'+b,{success:function(f){a.avaHash=f.avatar_hash;a=ParseUtil.aio8UserInfoParser(a);d.doAddCToR(a,b,c)}})}else {d.doAddCToR(a,b,c)}},doAddCToR:function(a,g,e){var b=Ext.Viewport.down('IM').down('#recentChat');var d=b.getStore();var f='';var c=d.add({avaHash:a.avatar_hash,chat_id:a.chat_id,name:e,type:a.chat_type,last_post_at:new Date(a.update_at),status:f,chat_name:a.chat_name,members:a.members});if(a.creator_id==User.ownerID){b.setSelection(c[0])}return c[0]},getLeafIDFromTree:function(b,a){var f=this;if(!b.data.leaf){for(var d=0;d<b.childNodes.length;d++){f.getLeafIDFromTree(b.childNodes[d],a)}}else {a.push(b.data)}var c=[];if(a.length==1){c.push(a[0])}else {for(var e=0;e<a.length;e++){c.push(a[e].uid)}}return c},getMemsByChatId1:function(b){var c=User.allChannels.length;for(var a=0;a<c;a++){if(User.allChannels[a].chat.chat_id===b){return User.allChannels[a].members}}return ''},getMemsByChatId:function(c){var b=Ext.getStore('comRct'),a=b.getById(c);if(!a){Utils.toastLong('根据chatID获取最近会话数据失败');return []}return a.get('members')},bindAllMsg:function(b,f){if(b.length>0){var e=[];for(var a=0;a<b.length;a++){var d=!0;if(a>0){if(Utils.datetime2Ago(b[a].create_at)==Utils.datetime2Ago(b[a-1].create_at)){d=!1}}var c=ParseHelper.getMsgData(b[a]);c.showTime=d;c.name=c.user_name;e.push(c)}f.add(e)}},bindLastMsg:function(a,e){if(a.length>0){var c=[];for(var b=0;b<a.length;b++){var d=ParseHelper.getMsgData(a[b]);c.push(d)}e.insert(0,c)}},setRightTitle:function(b,c,f,i,h){var g=this;User.rightTitle=b;Ext.Viewport.lookup('IM').getViewModel().set({'sendToName':b});var d=Ext.Viewport.lookup('IM').lookup('im-main');var a=d.down('#btnEdit');var e=d.down('#directChatHeader');if(c==ChatType.Direct){a.setHidden(!0);e.setHidden(!1);if(f){g.setDitChatHeader(f,b)}}else {if(c==ChatType.Multi){}else {if(c==ChatType.Group){e.hide();a.show();a.setReadOnly(!0)}}}},setDitChatHeader:function(c,g){var a='';var b=User.allStatus[c];if(b){var f=b.pc_online,e=b.mobile_online;if(f=='Y'){a='ditChatPC'}else {if(e=='Y'){a='ditChatMobile'}}}var d='';if(!User.userInfos[c]){d='(停用)';a=''}Ext.Viewport.lookup('IM').getViewModel().set({'sendToID':c,'sendToName':g,'ditStu':a,'ditInCom':d})}});Ext.define('IM.utils.CEFHelper',{alternateClassName:'CEFHelper',singleton:!0,addNotice:function(a){if(window.cefMain){var h=Ext.Viewport.lookup('IM').down('#recentChat').getStore();var g=h.getById(a.chat_id);var f=g.get('unReadNum');var b='';if(a.msg_type==MsgType.TextMsg){b=a.message}else {if(a.msg_type==MsgType.ImgMsg){b='[图片]'}else {if(a.msg_type==MsgType.FileMsg){b='[文件]'}else {if(a.msg_type==MsgType.LinkErp){b='[erp链接]'}}}}var c='';var d='';if(a.chat_type==ChatType.Direct){c=a.user_name;d='users/'+a.user_id+'.png'}else {if(a.chat_type==ChatType.Multi){c=a.header+': '+a.user_name;d=ParseUtil.getTimeMStr(a.chat_create_at)+a.chat_id+'.png'}}var e=JSON.stringify({chat_id:a.chat_id,msg_id:a.msg_id,header:c,message:b,badge:f,create_at:a.create_at,chat_type:a.chat_type,sender:a.user_name,image_id:d});if(User.isWholeRest){return}if(a.showMention){if(User.crtChannelId==a.chat_id&&User.isMainFormActive=='Y'){}else {cefMain.showNotice(e)}}else {if(a.isMute=='Y'){return}window.cefMain.addNotice(e)}}},removeMentionNoticeByMsgID:function(a){if(window.cefMain){cefMain.removeMentionNoticeByMsgID(a)}},showInformation:function(b,c){var a=this;Utils.custAjax('get','users/'+b,{success:function(d){if(d){d=ParseUtil.aio8UserInfoParser(d);User.doUpdateUserAva(d.user_id,d.avatar_hash,function(){cefMain.showInformationForm(JSON.stringify(d),c);d.mobile=a.getText(d.mobile);d.notes=a.getText(d.notes);d.email=a.getText(d.email);LocalDataMgr.updateUserInfo(d);User.updateUserCache(b,d)})}else {a.doUserCache(b,c)}},failure:function(){a.doUserCache(b,c)}})},doUserCache:function(c,b){var a=User.getUserInfoByCache(c);if(a){a.mobile=this.getText(a.mobile);a.notes=this.getText(a.notes);a.email=this.getText(a.email);var d=JSON.stringify(a);cefMain.showInformationForm(d,b)}else {}},getText:function(b){var a=document.createElement('div');a.innerHTML=b;return a.innerText},addListeners:function(){this.getScreenshot();this.openChat();this.cefOpenDirectChat();this.setCEFStatus();this.settingLogout();this.settingChgUserInfo();this.settingChgSettingInfo();this.openImporter();this.createChat();this.addChatMems();this.doCefCopy();this.doCefFileCopy();this.doCefViewImg();this.doCefOpenFile();this.doCefOpenFileMgr();this.doCefOpenFileFolder();this.doCefSaveAs();this.doCefOpenLink();this.transmit();this.transbfile();this.upBigFileSuccess();this.upBigFileFailure();this.downBigFileSuccess();this.downBigFileFailure();this.cancelBFile();this.downloadingBigFile();this.hideBFileInBFileForm();this.cefClosePopupChat();this.outChatTransmit();this.replyOpenChat();this.settingCrowdAva();this.cefNotification();this.cefApproveOpen();this.openAppendix();this.completeAppendix();this.transmitforwork();this.openDicChat();this.doCefDelFile();this.creategrouptrans();this.getReceiptData();this.createERPChat();this.openERPChat();this.openERPDirectChat()},getScreenshot:function(){window.getScreenshot=function(f){if(!Ext.Viewport.lookup('IM')){return}var d=ViewGet.getIMChatViewContainer();if(d.getHidden()){return}var e=ViewGet.getEditorView();var b=JSON.parse(f);var c='';for(var a=0;a<b.length;a++){var g=ParseUtil.getLocalFileURL(b[a].path);c+='<img _width="'+b[a].width+'" _height="'+b[a].height+'" class="ect-img" src="'+g+'" data-url="'+b[a].path+'">'+'&#8203;'}e.inputElement.dom.focus();if(document.queryCommandSupported('insertHTML')){document.execCommand('insertHTML',!1,c)}else {document.execCommand('paste',!1,c)}}},openChat:function(){window.cefOpenChat=function(a){ChatHelper.openChat(a)}},openDicChat:function(){window.cefOpenDicChat=function(c){var a=JSON.parse(c);var d=a[0].uid;var b=a[0].uName;ChatHelper.onOpenDirectChat(d,b)}},doCefDelFile:function(){window.doCefDelFile=function(c){var b=JSON.parse(c);for(var a=0;a<b.length;a++){FileMgr.remove(null,b[a].path).then(function(){})}}},cefOpenDirectChat:function(){window.cefOpenDirectChat=function(a){ChatHelper.onOpenDirectChat(a)}},cefNotification:function(){window.cefOpenModule=function(b,d,c,a){ChatHelper.openModule(b,d,c,a)}},cefApproveOpen:function(){window.cefOpenApprove=function(a,b){console.log('OK');if(top.doCefOpenLink){if(a!='undefined'&&b!='undefined'){var c='ReleaseKey='+Utils.toHex(a);top.doCefOpenLink(Ext.encode({linkObjType:b,linkKeyString:c}))}}}},getReceiptData:function(){window.mainSendReceipt=function(c){var d=JSON.parse(c),b=[];for(var a=0;a<d.length;a++){b.push(d[a].msg_id)}WebSocketUtil.sendMessage('setRead',c,function(){LocalDataMgr.chgMsgToRead(b)})}},openAppendix:function(){window.cefOpenAppendix=function(l){var a=JSON.parse(l);var b;var b=a.FileID;var e=a.FilePath,f=a.FileStatus,i=a.FileName,j=a.FileSize,c=(new Date()).getTime(),d=0,h=a.RemoteUrl,k=a.MimeType,g=FileUtil.getExtension(a.FileName);var m='SELECT * FROM IMWFile WHERE FileID=?;';LocalDataMgr.cExecSqlWithP(m,[b],function(o,n){if(n.rows.length==0){var a='INSERT INTO IMWFile (\n                        FileID,\n                        FilePath,\n                        FileStatus,\n                        FileName,\n                        FileSize,\n                        CreateAt,\n                        DeleteAt,\n                        RemoteUrl,\n                        MimeType,\n                        Extension\n                    ) VALUES (?,?,?,?,?,?,?,?,?,?);';LocalDataMgr.cExecSqlWithP(a,[b,e,f,i,j,c,d,h,k,g])}else {var m='UPDATE IMWFile SET FilePath = ?, CreateAt = ?, DeleteAt= ? WHERE FileID = ?';LocalDataMgr.cExecSqlWithP(m,[e,c,d,b])}})}},completeAppendix:function(){window.cefCompleteAppendix=function(f){var b=JSON.parse(f);var a=b.FileID;var c=b.FileStatus,e=b.FilePath,d=(new Date()).getTime();var g='SELECT * FROM IMWFile WHERE FileID=?;';LocalDataMgr.cExecSqlWithP(g,[a],function(h,g){if(g.rows.length>0){var b='UPDATE IMWFile SET FileStatus = ?, FilePath=?, CreateAt = ? WHERE FileID = ?';LocalDataMgr.cExecSqlWithP(b,[c,e,d,a]);if(User.isOpenFileMgr){cefMain.execToFileMgr('changeWorkFilestatus',a)}}})}},setCEFStatus:function(){window.setCEFStatus=function(a){User.isMainFormActive=a;var b=User.crtChannelId;if(Ext.isEmpty(b)){return}CEFHelper.clearCefAtForm(b);if(!AtUtil.manualRemoveAt){if(a=='Y'){try{AtUtil.showAtBtnInMsgView(b,ViewGet.getMsgView())}catch(c){}}}Utils.custAjax('post','push/cefstatus',{params:JSON.stringify({user_id:User.ownerID,is_active:a})});if(Config.isPC&&IMHelper.canUseReceipt()&&a=='Y'){ChatUtil.sendScrollReadDetails()}}},settingLogout:function(){window.settingLogout=function(){Ext.Viewport.getController().doLogout()}},settingChgUserInfo:function(){window.settingChgUserInfo=function(g){var b=JSON.parse(g);if(Ext.isArray(b)){for(var e=0;e<b.length;e++){var f=b[e];var d=f.key;var c=f.value;User.crtUser[d]=c;var a='';switch(d){case 'mobile':a='Mobile';break;case 'email':a='Email';break;case 'notes':a='Notes';break;default:break;}if(a){LocalDataMgr.updateMyInfoByKey(a,c)}}}else {var d=b.key;var c=b.value;User.crtUser[d]=c;var a='';switch(d){case 'mobile':a='Mobile';break;case 'email':a='Email';break;case 'notes':a='Notes';break;default:break;}if(a){LocalDataMgr.updateMyInfoByKey(a,c)}}}},settingChgSettingInfo:function(){var a=this;window.settingChgSettingInfo=function(e){var c=JSON.parse(e);var d=c.key;var b=c.value;User.settings[d]=b;switch(d){case 'send_hot_key':a.doBindSendSetting(b);break;case 'fileFolder':a.doChgFileFolder(b);break;case 'extras':a.doChgExtras(b);break;default:break;}}},doBindSendSetting:function(b){if(!window.cefMain){return}var a=User.popupChat;if(Object.keys(a).length>0){for(var c in a){cefMain.execChatMethod(c,'doBindSendSetting',JSON.stringify({send_hot_key:b}))}}DesktopChatUtil.doBindSendSetting(b)},doChgFileFolder:function(a){},doChgExtras:function(a){if(!Ext.isEmpty(a.nap_type)){this.doChgNap(a.nap_type,a.nap_end)}},doChgNap:function(b,a){if(Ext.isEmpty(a)){a='0'}a=parseInt(a,10);switch(b){case '3':Ext.fireEvent('restShow',a);break;case '2':Ext.fireEvent('restShow',a);break;case '0':default:Ext.fireEvent('restHide');break;}},openImporter:function(){window.openImporter=function(){cefMain.openImporter()}},createChat:function(){window.createGroup=function(c){var a=JSON.parse(c);if(a.length==1){var b=User.getUserName(a[0]);ChatHelper.createDirectChat(a[0],b)}else {ChatHelper.createGroupChat(a)}}},creategrouptrans:function(){var a=this;window.creategrouptrans=function(g){var b=JSON.parse(g);var c=b.user_ids;var d=b.msg_type;var e=b.msg_id;if(c.length==1){var f=User.getUserName(c[0]);a.createDirectChat(c[0],f,d,e,b)}else {a.doCreateGrpChat(c,d,e,b)}}},addChatMems:function(){window.addGroupUsers=function(e){var a=JSON.parse(e);var d=a.userIDs,b=a.chatID,c=a.showAll;if(DesktopChatUtil.hasPopupChatById(b)){cefMain.execChatMethod(b,'addGroupUsers',e);return}if(c=='O'){if(!a.showshowHisMsgID){Utils.toastShort('没有找到msgid');return}ChatHelper.doAddMemToGrpWithHis(b,d,a.showHisMsgID)}else {ChatHelper.doAddMemToGrp(b,d,c)}}},doCefCopy:function(){window.doCefCopy=function(b){var a=JSON.parse(b);cefMain.setCopyData(a.type,a.value,function(a){if(!a){Utils.toastShort('复制出错了')}})}},doCefFileCopy:function(){window.doCefFileCopy=function(a){var b=MsgType.FileMsg;cefMain.setCopyFileMgrData(b,a,function(b){if(!b){Utils.toastShort('复制出错了')}})}},doCefViewImg:function(){var a=this;window.doCefViewImg=function(b){b=JSON.parse(b);a.viewOneImg(b.path,b.fileName,b.createAt)}},viewOneImg:function(a,c,b){cefMain.viewImages(JSON.stringify([{url:a,original:FileUtil.getFileName(a),name:c,createAt:b}]),0)},doCefOpenFile:function(){window.doCefOpenFile=function(a){cefMain.open(a,function(b){},function(b){Utils.toastShort(b)})}},doCefOpenFileMgr:function(){window.doCefOpenFileMgr=function(a){var b=JSON.parse(a);cefMain.open(b[0].path,function(b){},function(b){Utils.toastShort(b);cefMain.execToFileMgr('changeFilestatus',a)})}},doCefOpenFileFolder:function(){window.doCefOpenFileFolder=function(a){cefMain.openFolder(a,function(b){},function(b){Utils.toastShort(b)})}},doCefSaveAs:function(){window.doCefSaveAs=function(b){var a=JSON.parse(b);FileMgr.saveAs(a.path,a.fileName)}},doCefOpenLink:function(){window.doCefOpenLink=function(b){var a=JSON.parse(b);if(ConfigMgr.isAio8()){DesktopChatUtil.openErpLinkInAio8(a)}else {var c=a.linkObjType||a.linkStgGuid;DesktopChatUtil.openErpLink(c+'',a.linkKeyString,a.linkType)}}},transmit:function(){window.transmit=function(d){var a=JSON.parse(d);var c=a.msg_id,b=a.chat_ids;ChatUtil.transMessage(c,b)}},transmitforwork:function(){window.transmitforwork=function(e){var a=JSON.parse(e);var c=a.file_size,b=a.file_path,d=a.chat_ids;ChatUtil.transWorkFile(c,b,d)}},transbfile:function(){window.transbfile=function(d){var a=JSON.parse(d);var c=a.msg_id,b=a.chat_ids;ChatUtil.transBigFile(c,b)}},outChatTransmit:function(){window.outChatTransmit=function(a){if(Ext.isEmpty(a)){return}a=JSON.parse(a);var e=Ext.getStore('comRct');var b;for(var c=0;c<a.length;c++){b=a[c];var d=e.getById(b.chat_id);if(d){d.set({last_post_at:new Date(b.create_at),last_post_id:User.ownerID,last_post_name:User.crtUser.user_name,last_msg_type:b.msg_type,last_post_msg:b.message})}}}},upBigFileSuccess:function(){window.upBigFileSuccess=function(b){if(!window.cefMain){return}var a=JSON.parse(b);var c=a.chat_id;if(User.popupChat[c]){cefMain.execChatMethod(c,'upBigFileSuccess',b);return}LocalDataMgr.upBigFileSuccess(a);SendUtil.notifyIMUpBFileSuc({chat_id:a.chat_id,msg_id:a.msg_id,status:'0',file_id:a.file_id},function(){LocalDataMgr.notifyBFileSuccess(a);CEFHelper.doMsgStoreUpdateFS(a,0);User.removeBFileFromProgress(a.file_id)},function(){CEFHelper.doMsgStoreUpdateFS(a,2)})}},upBigFileFailure:function(){window.upBigFileFailure=function(b){var a=JSON.parse(b);var c=a.chat_id;if(User.popupChat[c]){cefMain.execChatMethod(c,'upBigFileFailure',b);return}User.removeBFileFromProgress(a.file_id);CEFHelper.doMsgStoreUpdateFS(a,1)}},downBigFileSuccess:function(){var a=this;window.downBigFileSuccess=function(c){var b=JSON.parse(c);var d=b.chat_id;if(User.popupChat[d]){cefMain.execChatMethod(d,'downBigFileSuccess',c);return}b.file_path=a.getFileURI(b.file_path);User.removeBFileFromProgress(b.file_id);LocalDataMgr.downBigFileSuccess(b);CEFHelper.doMsgStoreUpdateFS(b,0)}},downBigFileFailure:function(){window.downBigFileFailure=function(b){var a=JSON.parse(b);var c=a.chat_id;if(User.popupChat[c]){cefMain.execChatMethod(c,'downBigFileFailure',b);return}User.removeBFileFromProgress(a.file_id);LocalDataMgr.downBigFileFailure(a);CEFHelper.doMsgStoreUpdateFS(a,1)}},doMsgStoreUpdateFS:function(a,d){var b=Ext.getStore(a.chat_id);if(b){var c=b.getById(a.msg_id);if(c){c.set({fileStatus:d,localPath:a.path||a.file_path})}}},doDownBFile:function(a,d){if(!a){return}var e=this;var c=a.get('start_index');if(!c){c=0}var b=a.get('attach_id')||a.get('file_id');cefMain.doTransferDownload(JSON.stringify({chat_id:a.get('chat_id'),chat_name:a.get('chat_name'),user_id:a.get('senderID'),user_name:a.get('senderName'),msg_id:a.get('msg_id'),fetch_id:b,file_id:b,create_at:a.get('updateTime'),extension:FileUtil.getExtension(a.get('fileName')),file_name:a.get('fileName'),file_size:a.get('fileSize'),size:a.get('fileSize'),start_index:c}),d,function(f){var c=e.getFileURI(f);c=Utils.joinPath(c,a.get('fileName'));a.set({fileStatus:2,localPath:c});User.pushBFileToProgress(b);LocalDataMgr.doDownBigFile({file_id:b,file_path:c})},function(b){Utils.toastShort(b)})},reDownBFile:function(a){if(!a){return}var b=a.get('start_index');if(!b){b=0}var c=a.get('attach_id')||a.get('file_id');cefMain.doTransferReDownload(JSON.stringify({chat_id:a.get('chat_id'),chat_name:a.get('chat_name'),user_id:a.get('senderID'),user_name:a.get('senderName'),msg_id:a.get('msg_id'),fetch_id:c,file_id:c,create_at:a.get('updateTime'),extension:FileUtil.getExtension(a.get('fileName')),file_name:a.get('fileName'),file_size:a.get('fileSize'),size:a.get('fileSize'),start_index:b}),a.get('localPath'))},cancelBFile:function(){window.cancelBFile=function(a){User.removeBFileFromProgress(a)}},supportBigFile:function(){return cefMain.supportBigFile()},downloadingBigFile:function(){window.downloadingBigFile=function(a){var b=JSON.parse(a);LocalDataMgr.downloadingBigFile(b)}},getFileURI:function(b){var a=b.replace(/\\/g,'/');if(!FileUtil.isFileUri(a)){a='file:///'+a}return a},hideBFileInBFileForm:function(){window.hideBFileInBFileForm=function(a){var b=JSON.parse(a);LocalDataMgr.hideBFileInBFileForm(b)}},hideFormToCut:function(){if(window.cefMain){cefMain.captureNoWindow()}},clearCefAtForm:function(a){cefMain.clearNotice(a)},openOutChat:function(b,c,a,d,e){User.popupChat[b]=a;cefMain.popupChatForm(b,c,a,d,e,function(){})},cefClosePopupChat:function(){window.cefClosePopupChat=function(a){delete User.popupChat[a];LocalDataMgr.selectRecentChat(a,function(g){var f=g.rows,h=f.length;if(h>0){var b=f.item(0),d=Ext.getStore('comRct'),e=b.UserID;if(!d){return}if(b.ChatType==ChatType.Multi||b.ChatType==ChatType.Group){e=b.ChatID}var c=b.LastMsgType;if(c=='G'||c=='A'||c=='R'||c=='M'||c=='C'||c=='X'||c=='D'||c=='V'||c=='J'){c=MsgType.GroupNotice}d.add({chat_id:b.ChatID,create_at:b.CreateAt,name:b.DisplayName,chat_status:b.ChatStatus,type:b.ChatType,isUnRead:b.UnreadCount>0,unReadNum:b.UnreadCount,last_post_at:new Date(b.LastPostAt),last_post_id:b.LastUserID,last_post_name:b.LastUserName,last_msg_type:c?c:'0',last_post_msg:b.LastMessage,avaID:e,isLocal:!0,toTop:b.IsTop=='Y',MentionCount:b.MentionCount,IsMute:b.IsMute})}})}},execChatMethod:function(c,a,b){if(window.cefMain){cefMain.execChatMethod(c,a,b)}},imgViewDownPic:function(){window.imgViewDownPic=function(a){if(Ext.isEmpty(a)){return}a=JSON.parse(a);var b=a.file_id,d='images/'+a.file_path;var c='UPDATE IMFile SET FilePath=?, HasPreview=?, FileStatus=? WHERE FileID=?;';LocalDataMgr.cExecSqlWithP(c,[d,'N','0',b])}},switchToChatWindow:function(a){cefMain.switchToChatWindow(a)},switchToMainWindow:function(){cefMain.switchToMainWindow()},initShowReplies:function(d){var e=d.length;if(e<=0){return}var c=[],a;for(var b=0;b<e;b++){a=d[b];c.push({chat_id:a.chat_id,msg_id:a.root_id,message:a.content,sender:a.user_name,image_id:'users/'+a.user_id+'.png',msg_seq:a.msg_seq,create_at:a.create_at})}var f=JSON.stringify(c);DesktopChatUtil.getCefObj().showReplyNoticeList(f)},replyOpenChat:function(){window.replyOpenChat=function(a,c,b){User.replyMsg={chat_id:a,msg_id:c,msg_seq:b};ChatHelper.openChat(a)}},initTree:function(c){var d=this;var a=d.createWorkRoot(c);var b=Ext.create('Ext.data.TreeStore',{root:{name:'trees',children:a},fields:['name']});Ext.Viewport.down('workdesk').setStore(b);Ext.Viewport.down('workdesk').expandAll()},createWorkRoot:function(a){var g=this;var e=[];for(var b=0;b<a.data.length;b++){e.push({GroupID:a.data[b].GroupID,GroupName:a.data[b].GroupName})}var d=g.deteleObject(e);for(var b=0;b<d.length;b++){d[b].children=[];for(var c=0;c<a.data.length;c++){userOrgs=a.data[c].GroupID;var f={};if(userOrgs==d[b].GroupID){f={AppDir:a.data[c].AppDir,ModuleID:a.data[c].ModuleID,ModuleIcon:a.data[c].ModuleIcon,ModuleName:a.data[c].ModuleName,ObjType:a.data[c].ObjType,UseInAIO:a.data[c].UseInAIO,leaf:!0};d[b].children.push(f)}}}return d},deteleObject:function(d){var b=[];var g={};for(var a=0;a<d.length;a++){var c=Object.keys(d[a]);c.sort(function(a,b){return Number(a)-Number(b)});var e='';for(var f=0;f<c.length;f++){e+=JSON.stringify(c[f]);e+=JSON.stringify(d[a][c[f]])}if(!g.hasOwnProperty(e)){b.push(d[a]);g[e]=!0}}b=b;return b},settingCrowdAva:function(){var a=this;window.settingCrowdAva=function(d){var a=JSON.parse(d);var f=a.Path;var g=a.chat_id;var e=Ext.getStore('comRct'),b=e.getById(g);User.cacheMil=(new Date()).getTime();if(b){var c=Ext.Viewport.down('recentChat').mapToItem(b).el.dom.querySelector('.link-avatar').children[0];c.setAttribute('src',f)}}},createDirectChat:function(e,d,a,b,c){var f=this;Utils.custAjax('post','chats/direct',{params:JSON.stringify([User.ownerID,e]),success:function(f){var j=Ext.Viewport.lookup('IM').down('#recentChat');var k=j.getStore().getById(f.chat_id);if(!k){f.last_post_at=f.create_at;if(Config.isPC){f.display_name=d;f.unread_count=0;f.last_sender_id=User.ownerID;f.last_sender_name=User.crtUser.user_name;f.last_message='';LocalDataMgr.createDitChat(f)}BindHelper.addChannelToRecent(f,f.display_name);ChatHelper.openDirectChat(f.chat_id)}else {ChatHelper.openDirectChat(f.chat_id)}var g=[];g.push(f.chat_id);if(a=='M'){ChatUtil.transMessage(b,g)}else {if(a=='E'){ChatUtil.transBigFile(b,g)}else {if(a=='W'){var i=c.file_size;var h=c.file_path;ChatUtil.transWorkFile(i,h,g)}}}},failure:function(f){console.log('创建出错',f)}})},doCreateGrpChat:function(d,a,b,c){var e=this;Utils.custAjax('post','chats/group',{params:JSON.stringify(d),success:function(g){var e=g.chat,h=g.messages;BindHelper.addChannelToRecent(e,e.header);if(Config.isPC){LocalDataMgr.createGrpChat(e,h)}var f=e.chat_id;Utils.custAjax('get','users/me/chats/'+f,{success:function(i){if(i.chat_type=='G'){ChatHelper.openGroupChat(f)}else {var l=ParseUtil.getLocalTime(!0);var n=Ext.getStore('comRct'),m=n.getById(f);LocalDataMgr.updateCrowdtoGroup(i,l);m.set({name:i.header,type:i.chat_type,isUnRead:!1,unReadNum:0});Utils.custAjax('get','chatcs/'+f,{success:function(e){LocalDataMgr.saveCrowdInfo(e,function(){ChatHelper.openCrowdInfo(f)})},failure:function(){}})}var h=[];h.push(e.chat_id);if(a=='M'){ChatUtil.transMessage(b,h)}else {if(a=='E'){ChatUtil.transBigFile(b,h)}else {if(a=='W'){var k=c.file_size;var j=c.file_path;ChatUtil.transWorkFile(k,j,h)}}}},failure:function(){}})},failure:function(e){console.log('创建多人会话失败',e);Utils.toastShort('发起会话失败')}})},createERPChat:function(){window.cefCreateERPChat=function(a,e,d,c,b){ChatHelper.doCreateERPChat(a,e,d,c,function(){SendUtil.sendErpLink(b,a)})}},openERPChat:function(){window.cefOpenERPChat=function(a,b){ChatHelper.doOpenERPChat(a,b,function(c){console.log(c)})}},openERPDirectChat:function(){var a=this;window.cefOpenERPDirectChat=function(d,b,c){var e=a;e.createOrOpenDirectChat(d,b,function(a){SendUtil.sendErpLink(c,a)})}},createOrOpenDirectChat:function(c,b,a){var d=this;Utils.custAjax('POST','chats/direct',{params:JSON.stringify([User.ownerID,c]),success:function(d){var e=Ext.Viewport.lookup('IM').down('#recentChat');var f=e.getStore().getById(d.chat_id);if(!f){d.last_post_at=d.create_at;if(Config.isPC){d.display_name=b;d.unread_count=0;d.last_sender_id=User.ownerID;d.last_sender_name=User.crtUser.user_name;d.last_message='';LocalDataMgr.createDitChat(d)}BindHelper.addChannelToRecent(d,d.display_name);ChatHelper.openDirectChat(d.chat_id)}else {ChatHelper.openDirectChat(d.chat_id)}if(a){a(d.chat_id)}},failure:function(d){console.err(d)}})}});Ext.define('IM.utils.ChatHelper',{alternateClassName:'ChatHelper',singleton:!0,requires:['IMCommon.model.Msg'],orgDblToChat:function(a){var b=this;if(User.ownerID!==a.data.uid){if(!a.data.leaf){Ext.Msg.confirm('提示','确定要发起群聊吗？',function(d){if(d=='yes'){var c=[];c=BindHelper.getLeafIDFromTree(a,c);if(c.length==1){b.createDirectChat(c[0].uid,c[0].name)}else {b.createGroupChat(c)}}})}else {b.createDirectChat(a.get('uid'),a.get('name'))}}else {Utils.toastLong('不能和自己发起会话')}},doubleToIMView:function(){var b=this,a=User.detailByOrg;if(User.ownerID!==a.data.uid){if(!a.data.leaf){Ext.Msg.confirm('提示','确定要发起群聊吗？',function(d){if(d=='yes'){var c=[];c=BindHelper.getLeafIDFromTree(a,c);if(c.length==1){b.createDirectChat(c[0].uid,c[0].name)}else {b.createGroupChat(c)}}})}else {b.onOpenDirectChat(a.get('uid'),a.get('name'))}}else {Utils.toastLong('不能和自己发起会话')}},setRctActive:function(){Ext.Viewport.lookup('IM').query('leftTool')[0].down('#leftTool_tab').setActiveItem('#latestComment')},showSecMid:function(e,d){var a=ViewGet.getSecMidContainer();var c=a.child('#'+e);var b=a.child('#'+d);if(c&&b){b.hide();c.show()}},showSecRight:function(g,f,e,d){var a=ViewGet.getSecRightContainer();var c=a.child(g),b=a.child(f),h=a.child(e);thrV=a.child(d);if(c&&b){b.hide();h.hide();thrV.hide();c.show()}},chgToBlank:function(){var b=this;var a=Ext.Viewport.lookup('IM');var d=a.lookup('pageblank');if(d.getHidden()){var c=a.lookup('details'),e=a.lookup('im-main'),f=a.down('newsview');if(!e.getHidden()){b.showRightView('pageblank','im-main')}if(!c.getHidden()){b.showRightView('pageblank','details')}if(!f.getHidden()){b.showRightView('pageblank','newsview')}}},chgToIMView:function(){var b=this;var a=Ext.Viewport.lookup('IM');var d=a.lookup('im-main');if(d.getHidden()){var c=a.lookup('details'),e=a.lookup('pageblank');if(!e.getHidden()){b.showRightView('im-main','pageblank')}if(!c.getHidden()){b.showRightView('im-main','details')}var f=a.lookup('chatFav');if(!f.getHidden()){b.showRightView('im-main','chatFav')}}b.setRctActive()},chgToDetailView:function(){var b=this;var a=Ext.Viewport.lookup('IM');var d=a.lookup('details');if(d.getHidden()){var c=a.lookup('im-main'),e=a.lookup('pageblank');if(!e.getHidden()){b.showRightView('details','pageblank')}if(!c.getHidden()){b.showRightView('details','im-main')}}},chgToFavView:function(){this.sameChgToView('chatFav')},sameChgToView:function(a){var b=this;var c=Ext.Viewport.lookup('IM');var d=c.down('#leftTool_tab').getActiveItem().getItemId();switch(d){case 'latestComment':var f=c.lookup('pageblank');if(!f.getHidden()){b.showRightView(a,'pageblank')};var e=c.lookup('im-main');if(!e.getHidden()){b.showRightView(a,'im-main')};break;case 'users':b.showRightView(a,'details');break;case 'star':b.showRightView(a,'chatFav');break;default:break;}},showRightView:function(c,a){var d=Ext.Viewport.lookup('IM');if(a){a=d.lookup(a);if(!a.getHidden()){a.hide()}}var b=d.lookup(c);if(!b){b=d.add({flex:1,xtype:c,reference:c})}else {b.show()}return b},getName:function(a){return User.getUserName(a)},getOtherUserID:function(d){var c='';var b=d.split('__');if(b.length===2){for(var a=0;a<2;a++){if(b[a]!==User.ownerID){c=b[a];break}}}return c},onOpenDirectChat:function(a,b){if(User.ownerID==a){Utils.toastShort('对不起，不能和自己发起会话');return}var c=this;b=User.getUserName(a);LocalDataMgr.hasDitChat(a,function(k,d){if(k){if(c.hasPopupChat(d.ChatID)){CEFHelper.switchToChatWindow(d.ChatID);return}var h=ViewGet.getRctStore(),j=h.getById(d.ChatID);if(!j){var f=d.UserIDs.split(',');var i=[];for(var e=0;e<f.length;e++){i.push({user_id:f[e],user_name:User.getUserName(f[e])})}var g=ParseUtil.getLocalTime(!0);h.insert(0,{chat_id:d.ChatID,create_at:d.CreateAt,name:b,type:d.ChatType,isUnRead:!1,unReadNum:0,members:i,last_post_at:new Date(g),avaID:a});LocalDataMgr.openChatByListNotHave(d,g)}c.openDirectChat(d.ChatID)}else {c.createDirectChat(a,b)}})},hasPopupChat:function(a){if(User.popupChat[a]){return !0}return !1},openMsgReply:function(a){if(User.popupChat[a]){ChatUtil.doReplyOpenChat();cefMain.switchToChatWindow(a);return}var d=this;var b=Ext.getStore('comRct'),c=b.getById(a);if(c){ChatHelper.openReply(a)}else {LocalDataMgr.hasChat(a,function(e,c){if(e){var d=ParseUtil.getLocalTime(!0);b.insert(0,{chat_id:c.ChatID,create_at:c.CreateAt,name:c.DisplayName,type:c.ChatType,isUnRead:!1,unReadNum:0,last_post_at:new Date(d),chatStatus:c.Status});LocalDataMgr.openMsgreplyByListNotHave(c,d);ChatHelper.openReply(a)}else {var d=ParseUtil.getLocalTime(!0);b.insert(0,{chat_id:'eeeeeeeebbbbbbbbbfffffffff',name:'消息回复',type:'P',isUnRead:!1,unReadNum:0,last_post_at:new Date(d),chatStatus:'0'});LocalDataMgr.openMsgreplyByChatNotHave(a,d);ChatHelper.openReply(a)}})}},openCrowd:function(a){if(User.popupChat[a.chat_id]){ChatUtil.doReplyOpenChat();cefMain.switchToChatWindow(a.chat_id);return}var e=this;var b=Ext.getStore('comRct'),c=b.getById(a.chat_id);if(c){var d=ParseUtil.getLocalTime(!0);LocalDataMgr.updateCrowdtoGroup(a,d);c.set({create_at:a.chat_create_at,name:a.header,type:a.chat_type});ChatHelper.openCrowdInfo(a.chat_id)}else {LocalDataMgr.hasChat(a.chat_id,function(f,c){if(f){var e=c.ChatID;var d=ParseUtil.getLocalTime(!0);b.insert(0,{chat_id:c.ChatID,create_at:c.CreateAt,name:c.DisplayName,type:c.ChatType,isUnRead:!1,unReadNum:0,last_post_at:new Date(d),chatStatus:c.Status,avaID:e,IsMute:c.IsMute});LocalDataMgr.openChatByListNotHave(c,d);ChatHelper.openCrowdInfo(a.chat_id)}else {var d=ParseUtil.getLocalTime(!0);b.insert(0,{chat_id:a.chat_id,name:a.header,type:a.chat_type,isUnRead:!1,unReadNum:0,last_post_at:new Date(d),chatStatus:'0'});LocalDataMgr.openCrowdyByChatNotHave(a,d);ChatHelper.openCrowdInfo(a.chat_id)}})}},openChat:function(a){if(User.popupChat[a]){ChatUtil.doReplyOpenChat();cefMain.switchToChatWindow(a);return}var d=this;var c=Ext.getStore('comRct'),b=c.getById(a);if(b){if(b.data.type==ChatType.Direct){d.openDirectChat(a)}else {if(b.data.type==ChatType.Multi){Utils.custAjax('get','users/me/chats/'+a,{success:function(b){if(b.chat_type==ChatType.Multi){ChatHelper.openGroupChat(a)}else {var c=ParseUtil.getLocalTime(!0);var e=Ext.getStore('comRct'),d=e.getById(a);LocalDataMgr.updateCrowdtoGroup(b,c);d.set({name:b.header,type:b.chat_type,isUnRead:!1,unReadNum:0});Utils.custAjax('get','chatcs/'+a,{success:function(c){LocalDataMgr.saveCrowdInfo(c,function(){ChatHelper.openCrowdInfo(a)})},failure:function(){}})}},failure:function(){}})}else {if(b.data.type=='C'){Utils.custAjax('get','users/me/chats/'+a,{success:function(b){var c=ParseUtil.getLocalTime(!0);var e=Ext.getStore('comRct'),d=e.getById(a);LocalDataMgr.updateCrowdtoGroup(b,c);d.set({name:b.header,type:b.chat_type,isUnRead:!1,unReadNum:0});Utils.custAjax('get','chatcs/'+a,{success:function(c){LocalDataMgr.saveCrowdInfo(c,function(){ChatHelper.openCrowdInfo(a)})},failure:function(){}})},failure:function(){}})}}}}else {LocalDataMgr.hasChat(a,function(f,b){if(f){var e=b.ChatID;if(b.ChatType==ChatType.Direct){e=ParseUtil.getUserIDByDitChat(b.UserIDs)}var d=ParseUtil.getLocalTime(!0);c.insert(0,{chat_id:b.ChatID,create_at:b.CreateAt,name:b.DisplayName,type:b.ChatType,isUnRead:!1,unReadNum:0,last_post_at:new Date(d),chatStatus:b.Status,avaID:e,IsMute:b.IsMute});LocalDataMgr.openChatByListNotHave(b,d);if(b.ChatType==ChatType.Direct){ChatHelper.openDirectChat(a)}else {if(b.ChatType==ChatType.Multi){ChatHelper.openGroupChat(a)}else {if(b.ChatType=='C'){ChatHelper.openCrowdInfo(a)}}}}else {Utils.custAjax('GET','users/me/chats/'+a,{success:function(d){var g=ParseUtil.getLocalTime(!0);var e='',h=d.chat_id;if(d.chat_type==ChatType.Direct){h=d.members[0].user_id==User.ownerID?d.members[1].user_id:d.members[0].user_id;e=d.members[0].user_id==User.ownerID?d.members[1].user_name:d.members[0].user_name}else {if(d.chat_type==ChatType.Multi){e=d.header}}c.insert(0,{chat_id:d.chat_id,create_at:d.create_at,name:e,type:d.chat_type,isUnRead:!1,unReadNum:0,last_post_at:new Date(g),chatStatus:'0',avaID:h,IsMute:d.is_mute});LocalDataMgr.openChatByChatNotHave(d,g,e);if(d.chat_type==ChatType.Direct){ChatHelper.openDirectChat(a)}else {if(d.chat_type==ChatType.Multi){ChatHelper.openGroupChat(a)}}},failure:function(c){Utils.toastShort(c)}})}})}},openDirectChat:function(b,c){CEFHelper.switchToMainWindow();var a=this;a.doLastChat();a.sameOpen(b,c);a.needUpdateChat(b)},openGroupChat:function(b,c){CEFHelper.switchToMainWindow();var a=this;a.doLastChat();a.sameOpen(b,c);a.needUpdateMultiChat(b)},openCrowdInfo:function(b,c){CEFHelper.switchToMainWindow();var a=this;a.doLastChat();a.sameOpen(b,c);a.needUpdateChat(b)},openReply:function(c,b){CEFHelper.switchToMainWindow();var a=this;a.doLastChat();a.sameOpen(c,b)},openNews:function(b,c){var e=this;var a=ViewGet.getRctView(),d=a.getStore().getById(b);if(!d){LocalDataMgr.getLocalNews((new Date()).getTime(),1,function(i,h){var g=h.rows;if(g.length>0){var d=g.item(0);a.getStore().add({chat_id:StaticChatID.News,name:'消息中心',type:ChatType.News,last_post_at:new Date(d.CreateAt),last_post_msg:d.Title||d.Description,last_post_name:'sys',last_msg_type:d.NewsType});var f=[];f.push({creator_id:d.CreatorID,create_at:d.CreateAt,unReadNum:0,title:d.Title||d.Description,news_type:d.NewsType});LocalDataMgr.newsToLocalChat(f[0]);LocalDataMgr.newsToLocalRct(f[0])}else {a.getStore().add({chat_id:StaticChatID.News,name:'消息中心',type:ChatType.News,last_post_at:new Date(),last_msg_type:'PNS'});var f=[];f.push({creator_id:'',create_at:(new Date()).getTime(),unReadNum:0,title:'',news_type:''});LocalDataMgr.newsToLocalChat(f[0]);LocalDataMgr.newsToLocalRct(f[0])}e.doLastChat();e.sameOpen(b,c)})}else {d.set({isUnRead:!1,unReadNum:0});LocalDataMgr.rctSetUnreadToRead(StaticChatID.News);this.doLastChat();this.sameOpen(b,c)}},setIMMainMinWidth:function(a){ViewGet.getIMMainMinWidthView().setMinWidth(a)},doLastChat:function(){var a=User.crtChannelId;if(a!='eeeeeeeebbbbbbbbbfffffffff'&&a!=StaticChatID.News){if(a){var d=this.isMsgViewBottom();var f=this.getLastRecordTime();var c=this.getEditorPureText();var e=this.getEditorMsg()||'';var b=Ext.getStore(a).last();User.chatCache[a]={lastRecTime:f,isBottom:d,lastEditorMsg:e,lastPureText:c,trueLastRec:b};delete AtUtil.ats[a];delete ChatUtil.firstUnread[a];this.updateLastChatInRct(a)}}},updateLastChatInRct:function(e){var a=User.chatCache[e];var g=Ext.getStore('comRct');var c=g?g.getById(e):null;if(a&&c){if(a.lastEditorMsg&&a.lastEditorMsg.length>0){var d=a.lastEditorMsg;var f=a.lastPureText;if(d.indexOf('<img')>-1&&d.indexOf('ect-img')>-1&&d.indexOf('src')>-1){f=' [图片]'}c.set({last_msg_type:'Draft',last_post_msg:f})}else {var b=a.trueLastRec;if(b&&a.isBottom){c.set({last_msg_type:b.data.msg_type||'G',last_post_msg:b.data.sendText})}}}},getEditorPureText:function(){var a=ViewGet.getEditorView();return a.getMultiValue().pureText},isMsgViewBottom:function(){var c=Ext.Viewport.lookup('IM').lookup('im-main').down('#chatView'),a=c.getScrollable().getScrollElement().dom;var e=a.scrollTop,b=a.offsetHeight,d=a.scrollHeight;if(e+b==d){return !0}return !1},getLastRecordTime:function(){var a=ViewGet.getMsgView(),c=a.getScrollable().getScrollElement().dom;var f=c.scrollTop,e=c.offsetHeight;var b=a.getRecordIndexFromPoint(0,f+e);if(b>-1){var d=a.getStore().getAt(b).get('updateTime');if(d){return d}}return 0},getEditorMsg:function(){var a=ViewGet.getEditorView();var b=a.getValue();a.clear();return b},hideGrpMemsView:function(){var a=ViewGet.getGrpMemsView();if(a&&!a.getHidden()){a.hide()}},showGrpMemsView:function(){var a=ViewGet.getGrpMemsView();if(a&&a.getHidden()){a.show()}},needUpdateChat:function(a){LocalDataMgr.getChatUpTime(a,function(h,f){var d=f.rows,g=d.length;var e=0,b=Ext.getStore('comRct').getById(a);var c=!0;if(g>0){e=d.item(0).UpdateAt||0;if(b&&b.data.type!='C'){Ext.ComponentQuery.query('#crowdNotice2')[0].hide();Ext.ComponentQuery.query('#crowdGroupclick')[0].hide();Ext.ComponentQuery.query('#groupClick')[0].show();c=ChatHelper.doBindNavMems(d,b,c)}if(b.data.type=='C'){LocalDataMgr.CrowdSearchID(b.data.chat_id,function(j,e){if(e.rows.length>0){var i=e.rows.item(0).ID;var g=e.rows.item(0).Hash;User.crtId=i;Utils.custAjax('get','chatcs/'+b.data.chat_id,{success:function(i){User.needUpdateCrowdAva(i.chat_id,i.create_at,i.avatar_hash,function(n,m){if(m){var l=Ext.Viewport.down('recentChat').getSelection();var k=Ext.Viewport.down('recentChat').mapToItem(l).el.dom.querySelector('.link-avatar').children[0];k.setAttribute('src',n);var o='UPDATE IMChatC SET Avahash=? WHERE ChatID=?;';LocalDataMgr.cExecSqlWithP(o,[i.avatar_hash,i.chat_id])}Ext.ComponentQuery.query('#crowdNotice2')[0].show();Ext.ComponentQuery.query('#crowdGroupclick')[0].show();Ext.ComponentQuery.query('#groupClick')[0].hide();ChatHelper.setcrowdNotice(i.notice);User.CrowdNotice=i.notice;ChatHelper.isAdmins(i.members,i.manager_id);ChatHelper.doBindCrowdMems(d,b,c,i);ChatHelper.BindCrowdMems(i);if(g!=i.hash){ChatHelper.doBindChatCM(i)}})},failure:function(){}})}})}}if(DesktopChatUtil.hasPopupChatById(a)){return}if(!c){Utils.custAjax('get','users/me/chats/'+a,{success:function(c,d){if(b){if(d=='304'){}else {if(DesktopChatUtil.hasPopupChatById(a)){return}ChatHelper.doBindRmtMems(c,b,c.creator_id);if(c.chat_type==ChatType.Direct){var e=ParseUtil.getDitUidByArray(c.members);User.needUpdateUserAva(e,c.avatar_hash,function(){ViewGet.getRctView().refresh()})}else {if(c.chat_type==ChatType.Multi){User.needUpdateChatAva(c.chat_id,c.create_at,c.avatar_hash,function(){ViewGet.getRctView().refresh()})}}LocalDataMgr.updateRctAndChat(c)}}},failure:function(){}},!1,'&update_at='+e)}})},needUpdateMultiChat:function(a){var b=this;LocalDataMgr.selectChat(a,function(c){var d=0;if(c.rows.length>0){d=c.rows.item(0).UpdateAt||0;b.updateUIForMultiChatWithLocalData(c.rows.item(0))}Utils.custAjax('get','users/me/chats/'+a,{success:function(d,f){if(f!=304){var e=Ext.getStore('comRct').getById(a);e.set({name:d.header,avaHash:d.avatar_hash,members:d.members,last_post_at:d.last_post_at>0?new Date(d.last_post_at):e.get('last_post_at')});b.updateUIForMultiChatHeader(d.chat_status=='X');User.needUpdateChatAva(d.chat_id,d.create_at,d.avatar_hash,function(){ViewGet.getRctView().refresh()});b.updateUIWithMultiChatMembers(d.members,d.manager_id);LocalDataMgr.updateRctAndChat(d)}}},!1,'&update_at='+d)})},updateUIForMultiChatWithLocalData:function(a){var f=this;var d=Ext.getStore('comRct').getById(a.ChatID);if(Ext.isEmpty(a.UserIDs)){return}var c=ParseUtil.getMembersByLocalIDs(a.UserIDs);d.set({members:c},{silent:!0});if(User.crtChannelId==a.ChatID){var e=a.DisplayName?a.DisplayName:d.get('name');User.rightTitle=e;Ext.Viewport.lookup('IM').getViewModel().set({'sendToName':e});var b=Ext.Viewport.lookup('IM').down('#btnEdit');if(a.ManagerID==User.ownerID&&!b.getReadOnly()){b.setReadOnly(!1)}else {b.setReadOnly(!0)}}f.updateUIWithMultiChatMembers(c,a.ManagerID)},updateUIWithMultiChatMembers:function(d,c){var e=this;var a=Ext.getStore('rgList');a.getSorters().clear();a.setSorters([{property:'isManager',direction:'Desc'},{property:'isadmin',direction:'Desc'}]);var b=[];d.forEach(function(a){a.isManager=a.user_id==c;b.push(a)});a.removeAll();a.add(b)},doBindNavMems:function(h,c,e){var a=h.item(0),g=a.UserIDs;if(Ext.isEmpty(g)){return}var b=ParseUtil.getMembersByLocalIDs(g);for(var d=0;d<b.length;d++){if(b[d].user_id==User.ownerID){e=!1;break}}c.set({members:b},{silent:!0});if(User.crtChannelId==a.ChatID){var f=a.DisplayName?a.DisplayName:c.get('name');if(a.ChatType==ChatType.Multi||a.ChatType==ChatType.Group){ChatHelper.doGrpChatRightMems(b,a.ManagerID,a.ChatType);BindHelper.setRightTitle(f,a.ChatType,c.get('avaID'),User.crtChannelId,a.ManagerID)}else {BindHelper.setRightTitle(f,a.ChatType,c.get('avaID'),User.crtChannelId)}}return e},isAdmins:function(c,d){var b=!0;for(var a=0;a<c.length;a++){if(c[a].user_id==User.ownerID){if(c[a].is_admin=='Y'||d==User.ownerID){Ext.ComponentQuery.query('#crowdNotice')[0].setReadOnly(!1);Ext.Viewport.lookup('IM').down('#setCrowd').show();b=!1}else {Ext.ComponentQuery.query('#crowdNotice')[0].setReadOnly(!0);Ext.Viewport.lookup('IM').down('#setCrowd').hide();b=!1}}}if(b){Ext.ComponentQuery.query('#crowdNotice')[0].setReadOnly(!0);Ext.Viewport.lookup('IM').down('#setCrowd').hide()}},doBindCrowdMems:function(h,d,f,c){var b=h.item(0);var a=ParseUtil.getCrowdMembersByLocalIDs(c.members);for(var e=0;e<a.length;e++){if(a[e].user_id==User.ownerID){f=!1;break}}d.set({members:a},{silent:!0});if(User.crtChannelId==b.ChatID){var g=b.DisplayName?b.DisplayName:d.get('name');ChatHelper.doGrpChatRightMems(a,c.manager_id,'C');BindHelper.setRightTitle(g,b.ChatType,d.get('avaID'),User.crtChannelId,c.manager_id)}},doBindRmtMems:function(a,c,d){var b='';if(a.chat_type==ChatType.Direct){b=ParseUtil.getDctNameFromMems(a.members)}else {if(a.chat_type==ChatType.Multi){b=a.header}}c.set({name:b,avaHash:a.avatar_hash,members:a.members,last_post_at:a.last_post_at>0?new Date(a.last_post_at):c.get('last_post_at')});if(User.crtChannelId==a.chat_id){if(a.chat_type==ChatType.Multi){ChatHelper.doGrpChatRightMems(a.members,d,a.chat_type);BindHelper.setRightTitle(b,a.chat_type,a.chat_id,User.crtChannelId,d)}else {BindHelper.setRightTitle(b,a.chat_type,c.get('avaID'),User.crtChannelId)}}},doGrpChatRightMems:function(c,f,g){var b=Ext.getStore('rgList');if(g=='C'){var d=b.getSorters();d.clear();b.setSorters([{property:'isManager',direction:'Desc'},{property:'isadmin',direction:'Desc'},{property:'user_id',direction:'ASC'}])}else {var d=b.getSorters();d.clear();b.setSorters([{property:'isManager',direction:'Desc'},{property:'isadmin',direction:'Desc'}])}var e=[];for(var a=0;a<c.length;a++){if(c[a].user_id==f){c[a].isManager=!0;e.unshift(c[a])}else {e.push(c[a]);c[a].isManager=!1}}b.removeAll();b.add(e)},sameOpen:function(a,n){CEFHelper.clearCefAtForm(a);this.doRightPage(a);var j=ViewGet.getIMView(),l=j.lookup('pageblank'),h=ViewGet.getIMChatViewContainer(),g=j.lookup('msgreplay'),f=ViewGet.getNewstView();if(!l.getHidden()){l.hide()}var c=this;User.lastChatId=User.crtChannelId;User.crtChannelId=a;c.setRctActive();var e=j.down('#recentChat'),m=e.getStore(),b=m.getById(a),d;if(!n){var i=e.getSelection();if(i&&i.get){if(i.get('chat_id')!==a){e.setSelection(b)}}else {e.setSelection(b)}}if(b){d=User.crtChannelType=b.get('type');e.scrollToRecord(b)}if(User.crtChannelType=='C'){Ext.Viewport.lookup('IM').down('#addMemsButton').hide();Ext.Viewport.lookup('IM').down('#setCrowd').hide();h.show();g.hide();f.hide();c.getHistory(a);c.setEditorLastView(a)}else {c.updateUIForChatRightSection(User.crtChannelType);c.updateUIForChatHeader(User.crtChannelType,b.get('chat_status')=='2',!0)}if(d==ChatType.Direct||d==ChatType.Multi||d==ChatType.Group){h.show();g.hide();f.hide();c.getHistory(a);c.setEditorLastView(a)}else {if(d=='P'){h.hide();g.show();f.hide();AddDataUtil.bindUnreadmsgReply()}else {if(d==ChatType.News){h.hide();g.hide();f.show();var k=f.down('newsviewlist');AddDataUtil.bindNews(k,function(){AddDataUtil.onScroll(k);ChatUtil.viewNews()})}}}return b},doRightPage:function(i){var f=Ext.getStore('comRct');var c=User.crtChannelId,b,j,a=DtPageCache.rightPages[i],d=f.getById(i).get('type');if(c){b=DtPageCache.rightPages[c];var e=f.getById(c);if(e){j=e.get('type')}}if(a&&!b){DesktopChatUtil.setMinWidthWoRight();cefMain.toggleRight('G','Y',function(){DesktopChatUtil.clearMinWidthWoRight()})}else {if(!a&&b){DesktopChatUtil.setMinWidthWoRight();cefMain.toggleRight(d,'N',function(){DesktopChatUtil.clearMinWidthWoRight()})}}var h=ViewGet.getMrdBtn(),g=ViewGet.getGrpMemsView();if(a&&a.xtype=='desktopMrdTabpanel'){h.setPressed(!0)}else {h.setPressed(!1)}if(d==ChatType.Multi&&!a||d==ChatType.Group&&!a){g.show()}else {g.hide()}if(b){b.hide()}if(a){a.show()}},getHistory:function(c){var d=this;var b=ViewGet.getMsgView();var a=Ext.getStore(c);if(!a){a=Ext.factory({storeId:c,model:'IMCommon.model.Msg',sorters:[{property:'updateTime',direction:'ASC'}]},Ext.data.Store);a.on({add:'msgStoreOnAdd',update:'msgStoreOnUpdate',scope:d})}else {User.isMsgRemoveAll=!0;a.removeAll()}b.setStore(a);b.getViewModel().set({hideMoreMsg:!0,msgNum:0});ChatUtil.handleFirstIn(a,c,b)},msgStoreOnAdd:function(h,b,g){if(g>0){var c='';for(var a=0;a<b.length;a++){if(b[a].get('updateTime')){c=b[0]}if(a>0){var d=ParseUtil.msgShowTime(b[a].get('updateTime'),b[a-1].get('updateTime'));if(b[a].get('showTime')!=d){b[a].set({showTime:d})}}}if(!c){return}var e=!0;var f=h.getAt(g-1);if(f){if(c){e=ParseUtil.msgShowTime(c.get('updateTime'),f.get('updateTime'))}else {e=!1}}if(c.get('showTime')!=e){c.set({showTime:e})}}else {for(var a=1;a<b.length;a++){var d=ParseUtil.msgShowTime(b[a].get('updateTime'),b[a-1].get('updateTime'));if(b[a].get('showTime')!=d){b[a].set({showTime:d})}}}},msgStoreOnUpdate:function(d,a){var c=d.indexOf(a);var b=!0;if(c>0){b=ParseUtil.msgShowTime(a.get('updateTime'),d.getAt(c-1).get('updateTime'))}if(b!=a.get('showTime')){a.set({showTime:b})}},setEditorLastView:function(g){var a=User.chatCache[g];var b=ViewGet.getEditorView();b.focus();if(a){var e=a.lastEditorMsg;if(e){b.clearValue();b.pasteHtml(e)}var f=Ext.getStore('comRct');var c=f?f.getById(g):null;if(c){var h=c.get('last_msg_type');if(h=='Draft'&&a.trueLastRec&&a.isBottom){var d=a.trueLastRec;c.set({last_msg_type:d.data.msg_type||'G',last_post_msg:d.data.sendText})}}}},keepLastIndex:function(){var a=ViewGet.getEditorView();a.focusEnd()},createDirectChat:function(c,b){var a=this;Utils.custAjax('post','chats/direct',{params:JSON.stringify([User.ownerID,c]),success:function(d){var e=Ext.Viewport.lookup('IM').down('#recentChat');var f=e.getStore().getById(d.chat_id);if(!f){d.last_post_at=d.create_at;if(Config.isPC){d.display_name=b;d.unread_count=0;d.last_sender_id=User.ownerID;d.last_sender_name=User.crtUser.user_name;d.last_message='';LocalDataMgr.createDitChat(d)}BindHelper.addChannelToRecent(d,d.display_name);a.openDirectChat(d.chat_id)}else {a.openDirectChat(d.chat_id)}},failure:function(a){console.log('创建出错',a)}})},createGroupChat:function(a){var b=this;if(a.length==1){var c=User.getUserName(a[0]);b.onOpenDirectChat(a[0],c)}else {b.doCreateGrpChat(a)}},doCreateGrpChat:function(a){var b=this;Utils.custAjax('post','chats/group',{params:JSON.stringify(a),success:function(d){var c=d.chat,e=d.messages;BindHelper.addChannelToRecent(c,c.header);if(Config.isPC){LocalDataMgr.createGrpChat(c,e)}b.openChat(c.chat_id)},failure:function(b){console.log('创建多人会话失败',b);Utils.toastShort('发起会话失败')}})},doCreateERPChat:function(b,e,d,c,a){var f=this;Utils.custAjax('POST','chats/egroup',{params:JSON.stringify({users:e,sender:d,header:c,chat_id:b}),success:function(h){var g=h.chat,i=h.messages;BindHelper.addChannelToRecent(g,g.header);if(Config.isPC){LocalDataMgr.createGrpChat(g,i)}f.openChat(g.chat_id);if(a){a(g.chat_id)}},failure:function(f){console.log('创建ERP会话失败: ',f);Utils.toastShort('发起ERP会话失败')}})},doOpenERPChat:function(a,c,b){var d=this;Utils.custAjax('GET','chats/egroup/'+a,{success:function(f){var e=f.chat;if(e.message!=null){BindHelper.addChannelToRecent(e,e.header);var g=GroupNotice.joinERPChat(c);LocalDataMgr.InsertNotice({msg_id:message.msg_id,msg_seq:message.msg_seq,chat_id:a,msg_Type:MsgType.GroupNotice,content:g,create_at:message.create_at,sender_id:message.user_id,sender_name:User.crtUser.user_name,status:'0'})}d.openChat(a);if(b){b(f)}},failure:function(d){debugger;console.error(d)}})},addMemToGroup:function(b,a){if(!a){a=User.crtChannelId}var c=ViewGet.getRctStore().getById(a),d=c.get('type');if(d==ChatType.Direct){var e=ParseUtil.getDitUidByArray(c.get('members'));b.push(e);this.doCreateGrpChat(b)}else {this.doAddMemToGrp(a,b)}},doAddMemToGrp:function(c,a,b,e){if(!b){b='N'}var d='&show_all='+b;Utils.custAjax('post','chats/'+c+'/members',{params:JSON.stringify(a),success:function(g){if(g){var d=g.chat,j=g.messages;var i=GroupNotice.cMeAddMems(a,d.members);var l=Ext.getStore('comRct').getById(d.chat_id);if(l){l.set({name:d.header,chat_name:d.chat_name,members:d.members,create_at:d.create_at,avaHash:d.avatar_hash,last_msg_type:MsgType.GroupNotice,last_post_msg:i,last_post_at:new Date(d.update_at)});User.needUpdateChatAva(c,d.create_at,d.avatar_hash,function(){ViewGet.getRctView().refresh()})}if(User.crtChannelId==d.chat_id){var h=Ext.getStore(d.chat_id);if(h){var n=AddDataUtil.isMsgViewBottom();h.add({msg_id:j[0].msg_id,msgSeq:j[0].msg_seq,updateTime:d.update_at,GrpChangeMsg:i,showGrpChange:!0,showTime:ParseUtil.dataShowTime(h,d.update_at)});if(n){AddDataUtil.onScrolMsgView()}}var o=Ext.getStore('rgList');var k=[],m;for(var f=0;f<a.length;f++){m=User.getUserName(a[f]);k.push({user_id:a[f],user_name:m})}o.add(k);ViewGet.getIMViewmodel().set({sendToName:d.header});User.rightTitle=d.header}LocalDataMgr.addMemToGroup(d,i,j)}}},!1,d)},doAddMemToGrpWithHis:function(b,a,c){if(User.popupChat[b]){cefMain.execChatMethod(b,'doAddMemToGrpWithHis',JSON.stringify({memsID:a,cid:b,showHisMsgID:c}));return}Utils.custAjax('post','chats/'+b+'/history',{params:JSON.stringify(a),success:function(f){if(f){var d=f.chat,i=f.messages;var h=GroupNotice.cMeAddMems(a,d.members);var k=Ext.getStore('comRct').getById(d.chat_id);if(k){k.set({name:d.header,chat_name:d.chat_name,members:d.members,create_at:d.create_at,avaHash:d.avatar_hash,last_msg_type:MsgType.GroupNotice,last_post_msg:h,last_post_at:new Date(d.update_at)});User.needUpdateChatAva(b,d.create_at,d.avatar_hash,function(){ViewGet.getRctView().refresh()})}var g=Ext.getStore(d.chat_id);if(g){g.add({msg_id:i[0].msg_id,msgSeq:i[0].msg_seq,updateTime:d.update_at,GrpChangeMsg:h,showGrpChange:!0,showTime:ParseUtil.dataShowTime(g,d.update_at)})}if(User.crtChannelId==d.chat_id){AddDataUtil.onScrolMsgView();var m=Ext.getStore('rgList');var j=[],l;for(var e=0;e<a.length;e++){l=User.getUserName(a[e]);j.push({user_id:a[e],user_name:l})}m.add(j);ViewGet.getIMViewmodel().set({sendToName:d.header});User.rightTitle=d.header}LocalDataMgr.addMemToGroup(d,h,i)}}},!1,'&msg_id='+c)},doSearchHistoryAt:function(d,c,b,a){Utils.custAjax('post','chats/'+User.crtChannelId+'/history',{params:JSON.stringify({chat_id:User.crtChannelId,user_ids:[d],history_at:c,is_origin:b}),success:function(e){var i=User.userInfos[e.message].user_name,f;f='您已经修改了'+i+'可查看消息的时间';LocalDataMgr.getDB().transaction(function(g){var h='INSERT INTO IMMsg (MsgID, ChatID, MsgType, Content, CreateAt, Status, MsgSeq) VALUES (?,?,?,?,?,?,?);';g.executeSql(h,[e.msg_id,e.chat_id,MsgType.GroupNotice,f,e.update_at,'0',e.msg_seq]);var i='UPDATE IMRct SET LastMessage=?,LastMsgType=?,LastPostAt=? WHERE ChatID=?;';g.executeSql(i,[f,MsgType.GroupNotice,e.update_at,e.chat_id])});if(!window.cefMsgMgr){var g=Ext.getStore('comRct').getById(e.chat_id);if(g){g.set({last_post_at:new Date(e.update_at),last_msg_type:'H',last_post_name:''})}}if(User.crtChannelId==e.chat_id){var h=Ext.getStore(e.chat_id);if(h){h.add({msg_id:e.msg_id,msgSeq:e.msg_seq,updateTime:e.update_at,GrpChangeMsg:f,showGrpChange:!0})}}Ext.Viewport.down('list').time='';a.hide();a.down('#groupDialog_list').getStore().removeAll();AddDataUtil.onScrolMsgView()},failure:function(e){Ext.Msg.alert('温馨提示','选择时间有误')}})},onScroll:function(b){var a=b.getScrollable(),c=a.getScrollElement().dom.scrollHeight,d=a.getScrollElement().dom.scrollTop;a.scrollTo(0,c-d)},doBindChatCM:function(a){var d=a.members.length;var b;var e='INSERT OR REPLACE INTO IMChatCM (\n                    ChatID, \n                    BodyID, \n                    IsAdmin\n                ) VALUES (?,?,?);';for(var c=0;c<d;c++){b=a.members[c];LocalDataMgr.cExecSqlWithP(e,[a.chat_id,b.user_id,b.is_admin])}},BindCrowdMems:function(a){ChatUtil.getcrowdChatName(a)},setcrowdNotice:function(a){if(a==''||a==null){var b='<div class="null_notice"></div>';Ext.ComponentQuery.query('#crowdNullnotice')[0].show();Ext.ComponentQuery.query('#crowdNotice')[0].hide()}else {Ext.ComponentQuery.query('#crowdNullnotice')[0].hide();Ext.ComponentQuery.query('#crowdNotice')[0].show();Ext.ComponentQuery.query('#crowdNotice')[0].setValue(a)}},updateUIForMultiChatHeader:function(a,b){var c=this;c.updateUIForChatHeader(ChatType.Multi,a,b)},updateUIForChatRightSection:function(d){var e=this;var c=Ext.Viewport.lookup('IM').down('#groupClick'),b=Ext.Viewport.lookup('IM').down('#crowdGroupclick'),a=Ext.Viewport.lookup('IM').down('#crowdNotice2');c.hide();b.hide();a.hide();if(d==ChatType.Multi){c.show()}else {if(d==ChatType.Group){b.show();a.show()}}},updateUIForChatHeader:function(e,f,g){var d=Ext.Viewport.lookup('IM').down('#addMemsButton'),b=Ext.Viewport.lookup('IM').down('#directChatHeader'),a=Ext.Viewport.lookup('IM').down('#btnEdit'),c=Ext.Viewport.lookup('IM').down('#setCrowd');if(e==ChatType.Direct){a.hide();c.hide();b.show();d.show()}else {if(e==ChatType.Multi){b.hide();c.hide();if(f){d.hide()}else {d.show()}var h=f?'dismiss':'';a.show();a.setUi(h);a.setReadOnly(f||!g)}else {if(e==ChatType.Group){b.hide();a.show();c.show();a.setReadOnly(!0)}}}},updateRctChatStatus:function(b,c){var d=Ext.Viewport.lookup('IM').down('#recentChat').getStore();var a=d.findRecord('chat_id',b);if(a){a.set('chat_status',c)}},updateUIForRecent:function(e,a,d,h,f,c){var g=Ext.Viewport.lookup('IM').down('#recentChat').getStore();var b=g.getById(e);if(b){b.set({name:a,last_post_msg:d,last_msg_type:h,last_post_at:new Date(f),lst_post_name:c});User.rightTitle=a}},updateUIWithNotice:function(a,e,f,d,c){var b=Ext.getStore(a);if(b){b.add({msg_id:f,msgSeq:e,updateTime:c,GrpChangeMsg:d,showGrpChange:!0})}if(User.crtChannelId==a){AddDataUtil.onScrolMsgView()}}});Ext.define('IM.utils.ConnectHelper',{alternateClassName:'ConnectHelper',singleton:!0,getMe:function(a){Utils.custAjax('GET','users/me',{success:function(b){console.log('个人信息：',b);a.set({'ownerName':b.user_name,'avatar':AvatarMgr.getAvatarHtmlByName(b.user_name)})}})},getMembers:function(a){var b=this;Utils.mask(a);Utils.custAjax('GET','users/all',{success:function(d){var e=d.organizations,c=d.users,f=d.version;if(Config.isPC){LocalDataMgr.validOrgV(f,function(g){if(g){LocalDataMgr.initUpdateOrg(c,e,f);b.doBindOrg(a,c,e)}})}else {b.doBindOrg(a,c,e)}},callback:function(){Utils.unMask(a)}})},doBindOrg:function(b,a,c){User.allUsers=a;User.organization=c;BindHelper.bindOrg(b)},getUnreadChats:function(a){var c=this,b=a.down('#recentChat');Utils.custAjax('GET','users/me/chats/unread',{success:function(b){if(b){console.log('未读会话：',b);if(Config.isPC){LocalDataMgr.initUpdateChats(b)}BindHelper.bindUnreadChats(b)}}})},getChannels:function(b){var c=this,a=b.down('#recentChat');Utils.mask(a);Utils.custAjax('get','users/me/chats',{success:function(d){console.log('所有频道：',d);c.pushChatToCache(d);LocalDataMgr.initUpdateChats(d);BindHelper.loadRecentChat(a);Utils.unMask(a)},callback:function(){}})},pushChatToCache:function(b){for(var a=0;a<b.length;a++){if(b[a].chat.chat_type=='D'){b[a].chat.channelname=b[a].chat.last_sender_name;User.allChannels.push(b[a])}else {b[a].chat.channelname=b[a].chat.header;User.allChannels.push(b[a])}}},parseDirectChatName:function(b,c){var a='';if(b.members[0].user_id!==c){a=b.members[0].user_name}else {a=b.members[1].user_name}return a},getStatus:function(a){Utils.custAjax('POST','status/ids',{params:JSON.stringify(a),success:function(b){User.allStatus=b}});StatusHelper.handleRecentList()},initNotify:function(a){}});Ext.define('IM.utils.ErpHelper',{alternateClassName:'ErpHelper',singleton:!0,startSenIvl:function(){if(window.erpSenInterval){return}var a=this;a.renewalERPSession();window.erpSenInterval=window.setInterval(function(){a.renewalERPSession()},60*60*1000)},renewalERPSession:function(){Utils.custAjax('PUT','users/'+User.ownerID+'/erpsession',{success:function(a){},failure:function(a){console.error(a)}})},getERPSession:function(a){Utils.custAjax('GET','users/'+User.ownerID+'/erpsession',{success:function(b){if(Ext.isFunction(a)){a(b)}}})},openAIO7:function(){if(window.cefMain){this.getERPSession(function(a){cefMain.openAIO71(a)})}},openAIO8:function(){if(window.cefMain){this.getERPSession(function(a){cefMain.openAIO8(a)})}}});Ext.define('IM.utils.GroupSelHelper',{alternateClassName:'GroupSelHelper',singleton:!0,handleChatMem:function(){User.crtChatMembers=[];if(User.isPlus){User.crtChatMembers.push(User.ownerID)}else {var b=BindHelper.getMemsByChatId(User.crtChannelId);for(var a=0;a<b.length;a++){User.crtChatMembers.push(b[a].user_id)}}},setDefaultSel:function(c){var a;for(var b=0;b<User.crtChatMembers.length;b++){a=c.query('uid',User.crtChatMembers[b],!1,!1,!0);if(a.items.length>0){this.doSetRecords(a.items,!0)}}},doSetRecords:function(b,c){for(var a=0;a<b.length;a++){b[a].set('isSel',c)}},isDefaultSel:function(b){var c=b.uid;for(var a=0;a<User.crtChatMembers.length;a++){if(c==User.crtChatMembers[a]){return !0}}return !1}});Ext.define('IM.utils.ParseHelper',{alternateClassName:'ParseHelper',singleton:!0,uses:['IMCommon.utils.ParseUtil'],parseWord:function(b){var a=[],c=/<img[^>]*src="([^"]*)"[^>]*>/g;return a},parseURL:function(a){var c=/^(http|https):\/\/(\w+:{0,1}\w*)?(\S+)(:[0-9]+)?(\/|\/([\w#!:.?+=&%!\-\/]))?$/ig;var b=a.replace(c,function(b){return '<a href="'+b+'">'+b+'</a>'});return b},onParseMsg:function(a){var c=/<img[^>]*src="([^"]*)"[^>]*>/g;var b=a.replace(c,function(b){var d='',c=$(b).attr('id');return '['+c+']'});return b},onParseFile:function(b){var a='';return a},parsePic:function(b,a){var d=/\[\w{26}\]/ig;var c=b.replace(d,function(d){var c='',e=d.substring(1,d.length-1);if(a&&a.length>0){for(var f=0;f<a.length;f++){if(a[f]==e){c='<img id="'+e+'" style="/*width:40px;height:40px;*/'+Ext.getResourcePath('images/loading.gif')+') no-repeat center center;" class="viewPic" src="'+Config.httpUrlForGo+'files/'+e+'/thumbnail">';break}else {c=d}}}return c});return c},parseToPic:function(b,a){if(a){return '<img id="'+a+'" style="background:url('+Ext.getResourcePath('images/loading.gif')+') no-repeat center center;" class="viewPic" src="'+Config.httpUrlForGo+'files/'+a+'/thumbnail">'}return b},textToHtml:function(a){return a.replace(/\n/g,'<br/>').replace(/\r/g,'<br/>').replace(/\r\n/g,'<br/>')},htmlToText:function(c){var a=document.createElement('div');a.innerHTML=c;var b=a.innerText;return b},getMsgData:function(c){var h=this;var b={};if(c.wrapper_type==MsgWrapperType.Notice){var g='';g=ParseUtil.getGrpNotice(c.notice);b={updateTime:new Date(c.create_at),GrpChangeMsg:g,showGrpChange:!0}}else {if(c.wrapper_type==MsgWrapperType.Message){var a=c.message,f='',e='',d='';if(a.user_id==User.ownerID){e='right'}f=a.user_name;if(a.msg_type==MsgType.TextMsg){d=a.message;b={msg_id:a.msg_id,senderName:a.user_name,sendText:d,ROL:e,updateTime:new Date(a.update_at)}}else {if(a.msg_type==MsgType.ImgMsg){d=ImgMgr.parsePic(a.attach_id);Utils.custAjax('get','files/'+a.attach_id+'/info',{success:function(d){var b='';if(window.cordova){b=window.cordova.file.dataDirectory}else {if(window.cefMain){b=window.cefMain.getDataDirectory()}}var e=b+User.ownerID+'/images/'+a.attach_id;LocalDataMgr.afterUploadSuc(d,e)}});b={msg_id:a.msg_id,senderName:f,sendText:d,ROL:e,updateTime:new Date(a.update_at)}}else {if(a.msg_type==MsgType.FileMsg){b={msg_id:a.msg_id,msg_type:MsgType.FileMsg,file_id:a.attach_id,fileName:'服务端之后做',fileSize:'服务端之后做',fileStatus:2,senderName:f,ROL:e,updateTime:new Date(a.update_at)}}}}if(b){b.msg_type=a.msg_type}}}return b},getNoticeMemsByContent:function(d,c){var a=c.split(',');for(var b=0;b<a.length;b++){if(a[b]==d){a.splice(b,1);break}}return a},appendFilePrefix:function(a){return Config.httpUrlForGo+'files/'+a},parseGrpListHTML:function(a){var e=AvatarMgr.getNavUserAvaUrl(a);var b='';if(User.allStatus[a]){var d=User.allStatus[a].pc_online,c=User.allStatus[a].mobile_online;if(d!='Y'&&c!='Y'){b='offline'}}return '<div class="ava-wrapper"><img class="ava '+b+'" src="'+e+'"  onerror="AvatarMgr.downloadUserAvatar(this)" ava-id="'+a+'"/></div>'},parseCrowdGrpListHTML:function(c,i,h,g,f){var b=User.getUserInfoByCache(c);var a='gpl_grey_Female';if(b.sex&&b.sex=='M'){a='gpl_grey_Male'}if(User.allStatus[c]){var e=User.allStatus[c].pc_online,d=User.allStatus[c].mobile_online;if(b.sex&&b.sex=='F'){if(e=='Y'){a='gpl_ava_Female'}else {if(d=='Y'){a='gpl_mobile_ava_Female'}}}else {if(e=='Y'){a='gpl_ava_Male'}else {if(d=='Y'){a='gpl_mobile_ava_Male'}}}}if(f){return '<div class="gpl_ava '+a+'"><span class="is_ma"></span></div>'}else {if(g=='Y'){return '<div class="gpl_ava '+a+'"><span class="is_ad"></span></div>'}else {return '<div class="gpl_ava '+a+'"></div>'}}},parseGrpListCls:function(d){var c=User.getUserInfoByCache(d);var a='gpl_grey_Female',b=!1;if(c.sex&&c.sex=='M'){a='gpl_grey_Male'}if(User.allStatus[d]){var f=User.allStatus[d].pc_online,e=User.allStatus[d].mobile_online;if(c.sex&&c.sex=='F'){if(f=='Y'){b=!0;a='gpl_ava_Female'}else {if(e=='Y'){a='gpl_mobile_ava_Female';b=!0}}}else {if(f=='Y'){b=!0;a='gpl_ava_Male'}else {if(e=='Y'){a='gpl_mobile_ava_Male';b=!0}}}}return {cls:a,isOnline:b}},showMobile:function(d){var a=User.allStatus[d];if(a){var c=a.pc_online,b=a.mobile_online;if(c!='Y'&&b=='Y'){return '<div class="gpl_mobile"></div>'}}},getIDsFromMems:function(b){var c=[];for(var a=0;a<b.length;a++){c.push(b[a].user_id)}return c},pushInfoToDom1:function(a){var d=a.msgType;var b='type="'+d+'" ';switch(d){case MsgType.TextMsg:break;case MsgType.ImgMsg:var c=this.getImgUrlByTN(a.filePath,a.updateTime);b+='origin_path="'+c+'" fileName="'+a.fileName+'"';break;case MsgType.FileMsg:var c=ConfigMgr.getDefaultDir()+a.filePath;b+='origin_path="'+c+'" fileName="'+a.fileName+'"';break;case MsgType.LinkErp:b+='content="'+a.content+'" linkObjType="'+a.linkObjType+'" linkStgGuid="'+a.linkStgGuid+'" linkKeyString="'+a.linkKeyString+'" linkType="'+a.linkType+'"';break;default:break;}return b},pushInfoToDom:function(a){var d=a.MsgType;var b='type="'+d+'" ';switch(d){case MsgType.TextMsg:break;case MsgType.ImgMsg:var c=this.getImgUrlByTN(a.FilePath,a.CreateAt);b+='origin_path="'+c+'" fileName="'+a.FileName+'" createAt="'+a.CreateAt+'"';break;case MsgType.FileMsg:var c=ParseUtil.getAbsolutePath(a.FilePath);b+='origin_path="'+c+'" fileName="'+a.FileName+'"';break;case MsgType.LinkErp:b+='content="'+a.Content+'" linkObjType="'+a.LinkObjType+'" linkStgGuid="'+a.LinkStgGuid+'" linkKeyString="'+a.LinkKeyString+'" linkType="'+a.LinkType+'"';break;default:break;}return b},getImgUrlByTN:function(b,c){var e=Utils.regex.url;if(e.test(b)){return b}var a=FileUtil.getFileName(b);var d=FileUtil.getExtension(a);if(!d){a=a+'.png'}var g=ParseUtil.getTimeYMStr(c);var f=ConfigMgr.getDefaultDir()+'images/'+g+a;return f},getImgDomAttr:function(c,a,b){var d=this.getImgUrlByTN(c,a);return 'origin_path="'+d+'" fileName="'+b+'" createAt="'+a+'"'},parseLoadedPic:function(f,g,e,b,d,c){var a=this.getImgUrlByTN(e,b);a=ParseUtil.getLocalFileURL(a);return '<img class="msgRecord_img" src="'+a+'" create_at="'+b+'" fileName="'+d+'" fileID="'+c+'" >'},doHightlight:function(b){var a=Ext.getStore('msgMrdListAllAdv');if(a){var c=a.hltext;return ParseUtil.doHighLight(b,c)}return ParseUtil.parseTextToHtml(b)},fileExists:function(a){if(window.cefMain){return cefMain.fileExist(a)}return !1}});Ext.define('IM.utils.PreferenceHelper',{alternateClassName:'PreferenceHelper',singleton:!0,toTopArray:[],toTop:'1',setRecentTop:function(c,a){var e=this,b=!1;var d=[{user_id:User.ownerID,category:'chat_order',name:c,value:a+''}];Utils.custAjax('PUT','users/me/Preferences',{params:JSON.stringify(d),success:function(d){if(d.status=='OK'){if(a>0){b=!0}}}});return b},toTopAddOne:function(){var a;a=parseInt(PreferenceHelper.toTop);a+=1;PreferenceHelper.toTop=a+'';return a},hideChat:function(a,b){Utils.custAjax('PUT','chats/'+a+'/hide',{success:function(c){if(c.status=='OK'){}},callback:function(){if(b){b()}else {var e=Ext.Viewport.lookup('IM').down('#recentChat'),d=e.getStore(),c=d.getById(a);d.remove(c);Ext.StoreManager.remove(a);if(User.crtChannelId==a){if(d.data.items.length>0){c=d.getAt(0);if(c.data.type=='P'){ViewGet.getGrpMemsView().hide();ChatHelper.openReply('eeeeeeeebbbbbbbbbfffffffff');User.crtChannelId='eeeeeeeebbbbbbbbbfffffffff'}else {if(c.data.type==ChatType.News){e.setSelection(c);ChatHelper.openNews(StaticChatID.News)}else {if(c.data.type=='C'){e.setSelection(c);ChatHelper.openCrowdInfo(c.get('chat_id'))}else {if(c.data.type=='D'){ViewGet.getGrpMemsView().hide()}e.setSelection(c);ChatHelper.openChat(c.get('chat_id'))}}}}else {User.crtChannelId='';ChatHelper.chgToBlank()}}LocalDataMgr.removeRct(a)}}})},hideChatMember:function(b,a,c){var d=this;Ext.Msg.confirm('移除','确定要移出吗',function(e){if(e==='yes'){Utils.custAjax('DELETE','chats/'+b+'/members/'+a,{success:function(g){if(g.status=='OK'){var f=c.getById(a);c.remove(f);d.hChatCheAfterHideChatMem(b,a)}else {Utils.toastShort('你没有权限踢出用户')}}})}})},hChatCheAfterHideChatMem:function(c,d){for(var a=0;a<User.allChannels.length;a++){if(User.allChannels[a].chat.chat_id==c){for(var b=0;b<User.allChannels[a].members.length;b++){if(User.allChannels[a].members[b].user_id==d){User.allChannels[a].members.splice(b,1);break}}break}}},chgManager:function(a,b,d){var c=this;Utils.custAjax('PUT','chats/'+a+'/manager',{params:JSON.stringify([b]),success:function(e){if(e.status=='OK'){console.log('更换管理员成功，处理内存数据');c.cacheChgMgr(a,b)}}})},getManagerFromCache:function(c){var b='';for(var a=0;a<User.allChannels.length;a++){if(User.allChannels[a].chat.chat_id==c){b=User.allChannels[a].chat.manager_id;break}}return b},cacheChgMgr:function(c,d){var e=this.getChatFromCacheByID(c);for(var a=0;a<User.allChannels.length;a++){if(User.allChannels[a].chat.chat_id==c){e.chat.manager_id=d;for(var b=0;b<User.allChannels[a].members.length;b++){if(User.allChannels[a].members[b].user_id==User.ownerID){User.allChannels[a].members.splice(b,1);break}}break}}},isShowAt:function(b){var c=Ext.getStore('comRct');var a=c.getById(b);if(a){if(a.getData().type!=ChatType.Direct){return !0}}return !1},getAllAtChatMems:function(c){var a=[],b=0;a=this.getChatMemsFromCacheByID(c);if(a.length>0){a.unshift({user_id:'all',user_name:'所有人('+b+')'})}return a},getAtMems:function(d,e){var c=[],a=this.getChatMemsFromCacheByID(d);if(a){for(var b=0;b<a.length;b++){if(this.isAtShowName(e,a[b].user_name)){c.push(a[b])}}}return c},getChatFromCacheByID:function(b){for(var a=0;a<User.allChannels.length;a++){if(User.allChannels[a].chat.chat_id==b){return User.allChannels[a]}}return ''},getChatMemsFromCacheByID:function(d){var a=[];for(var b=0;b<User.allChannels.length;b++){if(User.allChannels[b].chat.chat_id==d){a=User.allChannels[b].members;break}}for(var c=0;c<a.length;c++){if(User.ownerID==a[c].user_id){a.splice(c,1);break}}return a},isAtShowName:function(b,a){},preGrpChat:function(){var c=this,b=!0,a='';if(c.isDeleted()){a='对不起，您已被移出该会话'}if(a!==''){c.warnGrpMem(a);b=!1}return b},isDeleted:function(){var b=!1;for(var a=0;a<User.allChannels.length;a++){if(User.allChannels[a].chat.chat_id==User.crtChannelId){if(User.allChannels[a].chat.member_delete_at>0){b=!0}break}}return b},warnGrpMem:function(a){Utils.toastShort(a)},addFavChat:function(a){var c=a.get('chat_id'),b=a.get('name');Utils.custAjax('post','chatfavorite',{params:JSON.stringify({chat_id:c,user_id:User.ownerID,fav_name:b}),success:function(i){if(i){var g=a.get('avaID'),j=a.get('create_at'),h=a.get('type');var d=ViewGet.getSecFavGridViewStore();var e=d.getData().length+1;d.add({chat_id:c,avaID:g,fav_name:b,chat_create_at:j,chat_type:h,header:b,fav_index:e});var k=ViewGet.getSecOrgStore();var f=k.findRecord('uid','favPlace');if(f){f.appendChild({fromFav:!0,leaf:!0,iconCls:'hide-icon',header:b,name:b,chat_id:c,chat_create_at:j,fav_index:e,chat_type:h,avaID:g})}User.favChats.push(i)}},failure:function(b){Utils.toastShort(b)}})},removeFavChat:function(c,b,d){var a=c.get('chat_id');Utils.custAjax('DELETE','chatfavorite',{params:JSON.stringify({user_id:User.ownerID,chat_id:a}),success:function(k){if(b){b()}else {var g=ViewGet.getSecFavGridViewStore();var i=g.findRecord('chat_id',a);if(i){g.remove(i)}var j=ViewGet.getSecOrgStore();var f=j.findRecord('uid','favPlace');if(f){var h=f.findChild('chat_id',a);if(h){f.removeChild(h)}}}for(var e=0;e<User.favChats.length;e++){if(User.favChats[e].chat_id==a){User.favChats.splice(e,1);break}}},failure:function(a){Utils.toastShort(a)}})},updateFavChatName:function(c,b,a){Utils.custAjax('PUT','chatfavorite',{params:JSON.stringify({chat_id:c,user_id:User.ownerID,fav_name:b}),success:function(d){if(a){a(d)}},failure:function(d){Utils.toastShort(d)}})},rankFav:function(c,b,a){Utils.custAjax('post','chatfavorite/rank',{params:JSON.stringify(c),success:function(d){if(d){if(b){b()}}},callback:function(){if(a){a()}}})},handleToTop:function(c,a){var b=[{user_id:User.ownerID,category:'chat_order',name:c,value:!0}];Utils.custAjax('PUT','users/me/preferences',{params:JSON.stringify(b),success:function(b){if(a){a('ok')}}})},cancelToTop:function(c,a){var b=[{user_id:User.ownerID,category:'chat_order',name:c,value:!1}];Utils.custAjax('PUT','users/me/preferences',{params:JSON.stringify(b),success:function(b){if(a){a('cancel')}}})},beforeDoGrpChat:function(a,b){var c=this;return new Ext.Promise(function(e,d){var f='SELECT * From IMChat WHERE ChatID=?;';LocalDataMgr.cExecSqlWithP(f,[a],function(k,h){var f=h.rows;if(f.length>0){var g=f.item(0);var j=g.UserIDs,i=j.split(',');if(c.inThisChat(b,i)){e(g)}else {d('对不起，您没有权限做此操作')}}else {d('对不起，您没有权限做此操作')}},d)})},inThisChat:function(c,b){for(var a=0;a<b.length;a++){if(c==b[a]){return !0}}return !1},remindChat:function(b,a){Utils.custAjax('PUT','chats/'+b+'/mute',{success:function(){if(a){a.set({IsMute:'N'})}LocalDataMgr.remindChat(b)}},!1,'&is_mute=N')},muteChat:function(b,a){Utils.custAjax('PUT','chats/'+b+'/mute',{success:function(){if(a){a.set({IsMute:'Y'})}LocalDataMgr.muteChat(b)}},!1,'&is_mute=Y')}});Ext.define('IM.utils.SocketEventHelper',{alternateClassName:'SocketEventHelper',singleton:!0,requires:['IMCommon.utils.AddDataUtil'],handleNewPostEvent:function(f){var b=this;var a=JSON.parse(f.data.message);if(a.user_id!=User.ownerID){a.user_name=f.data.sender_name;a.chat_type=f.data.chat_type;a.chat_name=f.data.chat_name;var h=Ext.Viewport.lookup('IM');var d=h.down('#recentChat');var g=h.lookup('im-main');if(!g){}if(b.hasRctChat(a.chat_id)){d.getStore().getById(a.chat_id).set({last_msg_type:MsgType.TextMsg,last_post_msg:ParseUtil.replaceBrNbsp(a.message),last_post_at:a.create_at,last_post_name:a.user_name});var e;if(g){e=g.down('#chatView')}if(e&&User.crtChannelId==a.chat_id){LocalDataMgr.addMsgByWS(a);var c=e.getStore();switch(a.msg_type){case MsgType.TextMsg:b.addTextMsg(c,a);break;case MsgType.ImgMsg:b.addImgMsg(c,a);break;case MsgType.FileMsg:b.addFileMsg(c,a);break;default:alert('暂未支持该类型：',a.msg_type);}ChatHelper.onScroll(e);c=d.getStore();b.promptFakeRead(a,c)}else {b.promptUnRead(a,d.getStore())}}else {b.promptUnRead(a,d.getStore())}LocalDataMgr.insertOrUpdateRct(a.chat_id);b.notifyWrapper(a)}},addTextMsg:function(b,a){var c=a.message;b.add({msg_id:a.msg_id,msg_type:MsgType.TextMsg,senderName:a.user_name,sendText:c,updateTime:new Date(a.update_at),last_post_at:new Date(a.update_at),ROL:a.user_id==User.ownerID?'right':''})},addImgMsg:function(b,a){var c=ImgMgr.setPicIndex();b.add({msg_id:a.msg_id,msg_type:MsgType.ImgMsg,senderName:a.user_name,sendText:c,updateTime:new Date(a.update_at),last_post_at:new Date(a.update_at),ROL:a.user_id==User.ownerID?'right':''})},addFileMsg:function(b,a){b.add({msg_id:a.msg_id,msg_type:MsgType.FileMsg,fileID:a.attach_id,fileName:a.name,fileSize:a.size,fileStatus:2,senderName:a.user_name,updateTime:new Date(a.update_at),last_post_at:new Date(a.update_at),ROL:a.user_id==User.ownerID?'right':''})},notifyWrapper:function(a){var b=this;if(a.chat_type==ChatType.Direct){b.notify(a.user_name,a.message);CEFHelper.addNotice(a)}else {if(a.chat_type==ChatType.Multi){b.notify('多人会话：'+a.user_name,a.message);CEFHelper.addNotice(a)}}},notify:function(b,c){if(!window.cefMain){if(!window.Notification){console.log('浏览器不支持通知！')}console.log(window.Notification.permission);if(window.Notification.permission!='granted'){Notification.requestPermission(function(d){console.log('status: '+d);var a=Notification.permission;console.log('permission: '+a)})}if(Notification.permission==='granted'){var a=new Notification(b,{'icon':'resources/images/LOGO1.png','body':c});a.onshow=function(){console.log('显示通知');setTimeout(function(){a.close()},8000)};a.onclick=function(){window.focus();a.close()};a.onclose=function(){console.log('通知关闭')};a.onerror=function(){console.log('产生错误')}}}},showNewMsgByTitle:function(){if(window.newMessageEvent.isNotify){window.newMessageEvent.show()}},promptUnRead:function(b,c){var a=c.getById(b.chat_id);a.set({isUnRead:!0,unReadNum:a.get('unReadNum')+1,last_post_at:new Date(b.update_at)})},promptFakeRead:function(b,c){var a=c.getById(b.chat_id);a.set({isUnRead:!1,unReadNum:a.get('unReadNum')+1,last_post_at:new Date(b.update_at)})},reSortRecentList:function(c,a){var e=c.down('#recentChat'),b=e.getStore(),d=b.getById(a.chat_id);d.set('last_post_at',new Date(a.update_at))},isShowTime:function(a,b){if(a.data.items.length>1){var c=a.data.items[a.data.items.length-2].data.updateTime;if(b[0].data.updateTime==c){b[0].set('showTime',!1)}}else {if(a.data.items.length==1){var c=a.data.items[0].data.updateTime;if(b[0].data.updateTime==c){b[0].set('showTime',!1)}}}},handleGrpAddEvent:function(e){var d=this;var a=e.data;var c=JSON.parse(a.user_ids);var b='';if(a.creator_id==User.ownerID){b=this.createOwnWelcomeMsg(a.creator_id,c)}else {b=d.createOtherWelcomeMsg(a.creator_id,c)}d.addInfoToCache(a.chat_id,b)},hasChat:function(b){for(var a=0;a<User.allChannels.length;a++){if(User.allChannels[a].chat.chat_id==b){return !0}}return !1},hasRctChat:function(a){var c=Ext.Viewport.lookup('IM').down('#recentChat').getStore(),b=c.getById(a);if(b){return !0}return !1},createOwnWelcomeMsg:function(f,d){var e='',b='',c='';for(var a=0;a<d.length;a++){if(User.ownerID!=d[a]){c=ChatHelper.getName(d[a]);if(a==0){b=c}else {b=b+'、'+c}}}e='你邀请'+b+'加入了群聊';return e},createOtherWelcomeMsg:function(e,c){var g=ChatHelper.getName(e),f='',b='',d='';for(var a=0;a<c.length;a++){if(User.ownerID!=c[a]&&e!=c[a]){d=c[a];if(a==0){b=d}else {b=b+'、'+d}}}f=g+'邀请你和'+b+'加入群聊';return f},addInfoToCache:function(c,b){var d=!0;if(User.grpChgInfo.length!==0){for(var a=0;a<User.grpChgInfo.length;a++){if(User.grpChgInfo[a].chatId==c){d=!1;User.grpChgInfo[a].grpMsg.push({msg:b,updateAt:new Date()});break}}}if(d){this.addNewChatIDTogrpInfo(c,b)}},addNewChatIDTogrpInfo:function(c,b){var a=[];a.push({msg:b,updateAt:new Date()});User.grpChgInfo.push({chatId:c,grpMsg:a})},showgrpMsgInChat:function(c,e){var b=Ext.Viewport.lookup('IM').lookup('im-main').down('#chatView');var a=b.getStore();var d=a.add({updateTime:e,GrpChangeMsg:c,showGrpChange:!0});ChatHelper.onScroll(b);this.isShowTime(a,d)},handleMemRemoveEvent:function(d){var b=this;var a=d.data;var c='';if(a.remover_id==User.ownerID){c=b.createMeRemoveSBMsg(a.remover_id,a.user_id);if(User.crtChannelId==a.chat_id){b.showgrpMsgInChat(c,new Date());b.removeChatMem(a.user_id)}}else {if(a.user_id==User.ownerID){c=b.createSBRemoveMeMsg(a.remover_id,a.user_id);if(User.crtChannelId==a.chat_id){b.showgrpMsgInChat(c,new Date());b.removeChatMem(a.user_id)}b.addInfoToCache(a.chat_id,c)}else {if(User.crtChannelId==a.chat_id){b.removeChatMem(a.user_id)}}}b.removeMemFormCache(a.chat_id,a.user_id)},createMeRemoveSBMsg:function(c,b){var a='';if(c==b){a='你退出了群聊'}else {var d=ChatHelper.getName(b);a='你将'+d+'移出了群聊'}return a},createSBRemoveMeMsg:function(b,c){var a=ChatHelper.getName(b),d=ChatHelper.getName(c);return '你被'+a+'移出了群聊'},removeMemFormCache:function(d,c){for(var a=0;a<User.allChannels.length;a++){if(User.allChannels[a].chat.chat_id==d){for(var b=0;b<User.allChannels[a].members.length;b++){if(User.allChannels[a].members[b].user_id==c){User.allChannels[a].members.splice(b,1);break}}break}}},removeChatMem:function(b){var a=Ext.Viewport.lookup('IM').lookup('im-main').down('#groupList').getStore();if(a){var c=a.getById(b);a.remove(c)}},handleMemAddEvent:function(e){var b=this;var a=e.data;var d=JSON.parse(a.user_ids);var c='';if(a.operator_id==User.ownerID){c=b.createMeAddSBMsg(a.operator_id,d)}else {c=b.createSBAddSBMsg(a.operator_id,d)}if(User.crtChannelId==a.chat_id){b.showgrpMsgInChat(c,new Date());b.addChatMems(a.operator_id,d)}b.addInfoToCache(a.chat_id,c);b.addMemsToChatCache(a.chat_id,d)},createMeAddSBMsg:function(f,d){var a='',c='',e='';for(var b=0;b<d.length;b++){c=ChatHelper.getName(d[b]);if(b==0){a+=c}else {a=a+'、'+c}}e='你邀请'+a+'加入了群聊';return e},createSBAddSBMsg:function(f,d){var b='',a='',e='';for(var c=0;c<d.length;c++){a=ChatHelper.getName(d[c]);if(c==0){b+=a}else {b=b+'、'+a}}a=ChatHelper.getName(f);e=a+'邀请'+b+'加入了群聊';return e},addChatMems:function(d,b){var c=Ext.Viewport.lookup('IM').lookup('im-main').down('#groupList').getStore();if(c){for(var a=0;a<b.length;a++){c.add({chat_id:d,user_name:ChatHelper.getName(b[a]),user_id:b[a],status:StatusHelper.getStatus(b[a])})}}},addMemsToChatCache:function(e,b){var d='',f='';for(var c=0;c<User.allChannels.length;c++){if(User.allChannels[c].chat.chat_id==e){for(var a=0;a<b.length;a++){f=StatusHelper.getStatus(b[a]);d=ChatHelper.getName(b[a]);User.allChannels[c].members.push({chat_id:e,status:f,user_id:b[a],user_name:d})}}}},handleMgrChgEvent:function(c){var a=c.data;var b='';if(a.old_manager==User.ownerID){b=this.meChgMgrToSB(a.new_manager);if(User.crtChannelId==a.chat_id){this.showgrpMsgInChat(b,new Date())}}else {if(a.new_manager==User.ownerID){b=this.sbChgMgrToMe(a.old_manager);if(User.crtChannelId==a.chat_id){this.showgrpMsgInChat(b,new Date())}}}this.chgMgrToCahe(a.chat_id,a.new_manager,a.old_manager)},meChgMgrToSB:function(a){var b=ChatHelper.getName(a);return '你将群主转让给'+b},sbChgMgrToMe:function(a){var b=ChatHelper.getName(a);return b+'将群主转让给你'},chgMgrToCahe:function(c,d,e){for(var a=0;a<User.allChannels.length;a++){if(c==User.allChannels[a].chat.chat_id){User.allChannels[a].chat.manager_id==d;for(var b=0;b<User.allChannels[a].members.length;b++){if(User.allChannels[a].members[b].user_id==e){User.allChannels[a].members.splice(b,1);break}}break}}},handleChgChatHeader:function(f){var b=this,d=f.data,e=d.operator_id,a=JSON.stringify(d.chat),c='';if(User.ownerID==e){c=b.createMeChgHeaderMsg(a.header)}else {c=b.createSBChgHeaderMsg(a.header,e)}if(User.crtChannelId==a.chat_id){b.showgrpMsgInChat(c,new Date());Ext.Viewport.lookup('IM').getViewModel().set('sendoName',a.header)}b.chgHeaderToCache(a.chat_id,a.header)},createMeChgHeaderMsg:function(a){return '你修改会话名为:'+a},createSBChgHeaderMsg:function(a,c){var b=ChatHelper.getName(c);return b+'修改会话名为:'+a},chgHeaderToCache:function(b,c){var a=PreferenceHelper.getChatFromCacheByID(b);a.chat.header=c;a.chat.is_manual='Y'},handleGetFile:function(g){var c=JSON.parse(g.data.response);var d='';if(window.cordova){d=window.cordova.file.dataDirectory}else {if(window.cefMain){d=window.cefMain.getDataDirectory()}}var b=Ext.Viewport.lookup('IM').lookup('im-main');if(b&&b.down('#chatView')&&b.down('#chatView').getStore()){for(var a=0;a<c.files.length;a++){if(User.ownerID!==c.files[a].creator_id){var e=b.down('#chatView').getStore().getById(c.files[a].msg_id);if(e){var f=ImgMgr.parsePic(c.files[a].file_id);e.set('sendText',f);AddDataUtil.onScrolMsgView()}}}}}});Ext.define('IM.utils.StatusHelper',{alternateClassName:'StatusHelper',singleton:!0,handleRecentList:function(){var d=Ext.Viewport.down('IM').down('#recentChat'),e=d.getStore(),b=e.getData().items,c;for(var a=0;a<b.length;a++){if(b[a].data.type=='D'){c=this.getStatus(this.getUserIDByChatName(b[a].data.chat_name));b[a].set('status',c)}}},getUserIDByChatName:function(c){var b=c.split('__');for(var a=0;a<b.length;a++){if(b[a]!==User.ownerID){return b[a]}}},setRightStatus:function(b,a){var c=Ext.Viewport.lookup('IM').getViewModel();c.set({showStatus:a,status:b})},startStusIvl:function(){var b=this;User.statusIDs=[];for(var a=0;a<User.allUsers.length;a++){User.statusIDs.push(User.allUsers[a].user_id)}if(User.statusIDs.length>0){b.getStatus(User.statusIDs)}if(window.statusInterval){return}window.statusInterval=window.setInterval(function(){if(User.statusIDs.length>0){b.getStatus(User.statusIDs)}},User.StatusIvl*1000)},getStatus:function(c,a){var b=this;Utils.custAjax('POST','status/ids',{params:JSON.stringify(c),success:function(e){var g=User.crtChannelId;if(g){var i=ViewGet.getRctStore().getById(g),k=i.get('type');if(k==ChatType.Direct){var n=i.get('avaID');for(var d=0;d<e.length;d++){var f=e[d].user_id;User.allStatus[f]=e[d];if(n==f){if(User.crtChannelId==g){b.handleDitStu(e[d])}}}}else {if(k==ChatType.Multi){var j=Ext.getStore('rgList');if(j){var h=0;for(var d=0;d<e.length;d++){var f=e[d].user_id;User.allStatus[f]=e[d];var l=j.getById(f);if(l){var m=e[d].pc_online=='Y'?'p':'m';l.set({status:e[d].user_status,onlineDev:m});if(e[d].pc_online=='Y'||e[d].mobile_online=='Y'){h+=1}}}ViewGet.getchatViewGrpViewModel().set({onlineNum:h})}}}}else {for(var d=0;d<e.length;d++){var f=e[d].user_id;User.allStatus[f]=e[d]}}DesktopChatUtil.setStatus(User.allStatus);b.doOrgStus();if(a){a(e)}},failure:function(){if(a){a(null)}}})},handleDitStu:function(b){var d=ViewGet.getIMViewmodel();var a='';var e=b.pc_online,c=b.mobile_online;if(e=='Y'){a='ditChatPC'}else {if(c=='Y'){a='ditChatMobile'}}d.set({ditStu:a})},doOrgStus:function(){var e=Ext.getCmp('mainOrg');if(!e){return}var c=e.getStore();if(!c){return}var f=c.getData().length,a,b;for(var d=0;d<f;d++){a=c.getAt(d);if(a.get('fromFav')){if(a.get('chat_type')==ChatType.Direct){b=a.get('avaID');this.doChgOrgStu(b,a)}}else {if(a.isLeaf()){b=a.get('uid');this.doChgOrgStu(b,a)}}}},doChgOrgStu:function(d,b){var c=b.get('stu'),a=this.onlineStu(d);if(c!=a){b.set('stu',a)}},pushUnique:function(a,b){a=a.concat(b);a=[].concat($jscomp.arrayFromIterable(new Set(a)));return a},getNoExistStus:function(c){var b=[];for(var a=0;a<User.allStatus.length;a++){b.push(User.allStatus[a].user_id)}return this.findUnique(b,c)},findUnique:function(d,b){var e=d.join(',');var c=[];for(var a=0;a<b.length;a++){if(e.indexOf(b[a]+',')<0){c.push(b[a])}}return c},isOnline:function(b){var a=User.allStatus[b];if(!a){return ''}return a.pc_online=='Y'||a.mobile_online=='Y'},onlineStu:function(b){var a=User.allStatus[b];if(!a){return ''}if(a.pc_online=='Y'){return 'p'}if(a.mobile_online=='Y'){return 'm'}return ''}});Ext.define('IM.utils.ViewGet',{alternateClassName:'ViewGet',singleton:!0,getIMView:function(){return Ext.Viewport.lookup('IM')},getIMViewmodel:function(){return Ext.Viewport.lookup('IM').getViewModel()},getRctView:function(){return Ext.Viewport.lookup('IM').down('#recentChat')},getRctStore:function(){return Ext.getStore('comRct')},getchatViewGrpViewModel:function(){return Ext.Viewport.lookup('IM').lookup('im-main').down('#groupList').getViewModel()},getIMChatViewContainer:function(){return Ext.Viewport.lookup('IM').lookup('im-main')},getNewstView:function(){return Ext.Viewport.lookup('IM').lookup('newsview')},getMrdMainViewContainer:function(){return Ext.getCmp('im-main-bottom-container')},getIMMainMinWidthView:function(){return Ext.getCmp('im-main-minWidth-view')},getEditorView:function(){return this.getIMChatViewContainer().down('#chatInput').down('#richEditor')},getMrdBtn:function(){return this.getIMChatViewContainer().down('#chatInput').down('#chatInput_mrd_btn')},getSecOrgView:function(){return Ext.Viewport.lookup('IM').down('#middleView').down('#secondTabMid').down('#secTabOrg')},getSecOrgStore:function(){return this.getSecOrgView().getStore()},getGrpMemsView:function(){return this.getIMChatViewContainer().down('#groupList')},getGrpListStore:function(){return Ext.getStore('rgList')},getMsgView:function(){return this.getIMChatViewContainer().down('#chatView')},getChatMrdView:function(){var a=User.crtChannelId;return DtPageCache.rightPages[a]},getSecMidContainer:function(){return Ext.Viewport.lookup('IM').down('#middleView').down('#secondTabMid')},getSecFavEditView:function(){return this.getSecMidContainer().down('#secFavEdit')},getSecFavGridView:function(){return this.getSecFavEditView().down('#favSortP_favGrid')},getSecFavGridViewStore:function(){return this.getSecFavGridView().getStore()},getSecFavGridStore:function(){return this.getSecFavGridView().getStore()},getSecRightContainer:function(){return this.getIMView().lookup('secondTabRight')},getSecRightFavView:function(){return this.getSecRightContainer().child('chatFav')},getSecRightCrowdView:function(){return this.getSecRightContainer().child('crowdFav')},getSecRightOrgView:function(){return this.getSecRightContainer().child('details')},getReconnectComponent:function(){return Ext.Viewport.lookup('IM').down('#middleView').down('#disconnectInfo')},getThirdTabMidContainer:function(){return Ext.Viewport.lookup('IM').down('#middleView').down('#thirdTabMid')},getWorkDeskTabPanel:function(){return this.getIMView().down('#iframtab')}});Ext.define('IM.utils.WebSocketHelper',{alternateClassName:'WebSocketHelper',singleton:!0,MAX_WEBSOCKET_FAILS:7,MIN_WEBSOCKET_RETRY_TIME:3000,MAX_WEBSOCKET_RETRY_TIME:300000,conn:null,sequence:1,eventSequence:0,connectFailCount:0,eventCallback:null,responseCallbacks:{},firstConnectCallback:null,reconnectCallback:null,missedEventCallback:null,errorCallback:null,closeCallback:null,initialize:function(b,c){var a=this;console.log('websocket initialize');if(this.conn){return}if(b==null){console.log('connectionUrl 不能为空');return}if(this.connectFailCount===0){console.log('websocket 正在连接 '+b)}this.conn=new WebSocket(b+'?token='+User.token);this.connectionUrl=b;this.conn.onopen=function(){a.eventSequence=0;if(c){}if(a.connectFailCount>0){console.log('websocket 重新创建连接');if(a.reconnectCallback){a.reconnectCallback()}}else {if(a.firstConnectCallback){a.firstConnectCallback()}}a.connectFailCount=0};this.conn.onclose=function(){a.conn=null;a.sequence=1;if(a.connectFailCount===0){console.log('websocket 关闭')}a.connectFailCount++;if(a.closeCallback){a.closeCallback(a.connectFailCount)}var d=a.MIN_WEBSOCKET_RETRY_TIME;if(a.connectFailCount>a.MAX_WEBSOCKET_FAILS){d=a.MIN_WEBSOCKET_RETRY_TIME*a.connectFailCount*a.connectFailCount;if(d>a.MAX_WEBSOCKET_RETRY_TIME){d=a.MAX_WEBSOCKET_RETRY_TIME}}setTimeout(function(){a.initialize(b,c)},d)};this.conn.onerror=function(d){if(a.connectFailCount<=1){console.log('websocket 发生异常');console.log(d)}if(a.errorCallback){a.errorCallback(d)}};this.conn.onmessage=function(e){var d=JSON.parse(e.data);console.log('websocket接收到的信息');console.log(d);if(d.seq_reply){if(d.error){console.log(d)}if(a.responseCallbacks[d.seq_reply]){a.responseCallbacks[d.seq_reply](d);Reflect.deleteProperty(a.reconnectCallback,d.seq_reply)}}else {if(a.eventCallback){if(d.seq!==a.eventSequence&&a.missedEventCallback){console.log('missed websocket event, act_seq='+d.seq+' exp_seq='+a.eventSequence);a.missedEventCallback()}a.eventSequence=d.seq+1;a.eventCallback(d)}}}},setEventCallback:function(a){this.eventCallback=a},setFirstConnectCallback:function(a){this.firstConnectCallback=a},setReconnectCallback:function(a){this.reconnectCallback=a},setMissedEventCallback:function(a){this.missedEventCallback=a},setErrorCallback:function(a){this.errorCallback=a},setCloseCallback:function(a){this.closeCallback=a},close:function(){this.connectFailCount=0;this.sequence=1;if(this.conn&&this.conn.readyState===WebSocket.OPEN){this.conn.onclose=function(){};this.conn.close();this.conn=null;console.log('websocket 关闭')}},sendMessage:function(c,d,a){var b={action:c,seq:this.sequence++,data:d};if(a){this.responseCallbacks[b.seq]=a}if(this.conn&&this.conn.readyState===WebSocket.OPEN){this.conn.send(JSON.stringify(b))}else {if(!this.conn||this.conn.readyState===WebSocket.CLOSED){this.conn=null;this.initialize()}}}});Ext.define('IM.view.IMController',{extend:'Ext.app.ViewController',alias:'controller.IM',requires:['IMCommon.utils.AvatarMgr','IM.utils.WebSocketHelper','IM.utils.BindHelper','MX.util.Utils','IMCommon.utils.SocketEventUtil','IMCommon.utils.WebSocketUtil','IMCommon.utils.ChatUtil'],uses:['IMCommon.local.LocalDataMgr','IMCommon.local.InitDb'],listen:{controller:{'im-right-main':{grpSel:'showGrpSel'}}},init:function(){var a=this;if(User.manualLogin){a.init1()}else {a.init2()}window.watchLargeImg=function(c,b){if(window.cefMain){var a=Ext.create('IMCommon.view.panel.hidePanel',{draggable:!0,bodyPadding:10,width:250,height:250,html:'<img src="'+b+'" height="230px;" width="230px;"/>'});a.showBy(c,'tl-bl?')}};if(AtUtil.useDB){}else {var b=a.getView();b.element.on({tap:'onMainViewTap',scope:a})}a.doMidSupportChinese()},onMainViewTap:function(){var d=this.getView(),c=d.down('#recentChat'),a=c.getSelectable().getLastSelected();if(a){var b=a.data;if(a.length){b=a[0].data}if(b.MentionCount>0){AtUtil.doMsgViewAtBtn(b.chat_id,ViewGet.getMsgView())}}},doTransferForm:function(){LocalDataMgr.getBFiles(function(f,e){var d=[];for(var c=0;c<e.length;c++){var a=e.item(c),b=parseInt(a.BFileStatus,10);if(b==8){if(User.ownerID!=a.UserID){b=9}}d.push({chat_id:a.ChatID,chat_name:a.DisplayName,user_id:a.UserID,user_name:User.getUserName(a.UserID),msg_id:a.MsgID,fetch_id:a.BFileID,file_id:a.BFileID,create_at:a.CreateAt,file_path:a.BFilePath,path:a.BFilePath,extension:FileUtil.getExtension(a.BFileName),file_name:a.BFileName,file_size:a.BFileSize,size:a.BFileSize,file_status:b,owner_id:User.ownerID,msg_status:a.Status})}cefMain.addTransferItem(JSON.stringify(d))})},init1:function(){var a=this,d=a.getView(),c=d.down('#recentChat');User.cacheMil=(new Date()).getTime();StatusHelper.startStusIvl();ErpHelper.startSenIvl();if(Config.isPC){a.getViewModel().set({'ownerName':User.crtUser.user_name,'avatar':['<div style="padding-left: 12px;margin-bottom: 24px;">',AvatarMgr.getUserAvaHtml(User.ownerID,User.crtUser.avatar_hash,!1,!0),'</div>'].join('')});a.handleCEF();a.doTransferForm()}var b=Ext.getCmp('mainOrg');if(User.allUsers.length>0&&User.organization.length>0){BindHelper.bindOrg(b)}else {a.bindLocalOrg(b)}ChatUtil.getLocalRct(c);a.validateSession=!0;a.mounted();window.reloadAva=function(b){a.reloadAva(b)};InitDb.doFixVer();a.doSendPlacehodler()},init2:function(){var a=this;var c=a.getView();var b=c.down('#recentChat');a.handleCEF();User.cacheMil=(new Date()).getTime();window.reloadAva=function(b){a.reloadAva(b)};a.doOwnAva();InitDb.initDB(function(){ChatUtil.getNativeRct(b);a.bindLocalSetting();var c=Ext.getCmp('mainOrg');a.bindLocalOrg(c,function(){a.doValidateSession()});a.mounted();a.doTransferForm();InitDb.doFixVer()})},doSendPlacehodler:function(){if(!User.settings){return}var a=ViewGet.getEditorView();if(a){var b=User.settings.send_hot_key;switch(b){case 'Enter':a.setPlaceholder('Enter发送');break;case 'Ctrl+Enter':default:a.setPlaceholder('Ctrl+Enter发送');break;}}},doOwnAva:function(b){var a=AvatarMgr.parseUserAva(User.ownerID);if(b){a=AvatarMgr.getUserAvaHtml(User.ownerID,User.crtUser.avatar_hash,!1,!0)}this.getViewModel().set({avatar:['<div style="padding-left: 12px;margin-bottom: 24px;">',a,'</div>'].join('')})},bindLocalOrg:function(a,b){var c=this;Utils.mask(a,'加载中');LocalDataMgr.initGetOrg(function(d){if(d){BindHelper.bindOrgWoFav(a)}Utils.unMask(a);c.setOrgData(JSON.stringify({users:User.allUsers,orgs:User.organization}));if(b){b()}})},bindLocalSetting:function(){var b=this;var a=cefMain.getSettingData();LocalDataMgr.getUserInfo(User.ownerID,function(f,e){var d=e.rows;if(d.length>0){var c=User.getServiceInfo(d.item(0));User.crtUser=c;b.setSettingData(JSON.stringify({settings:JSON.parse(a),user:c,user_id:User.ownerID}))}else {b.setSettingData(JSON.stringify({settings:JSON.parse(a),user:User.crtUser,user_id:User.ownerID}))}})},doValidateSession:function(){var b=this;var a;if(Config.newLoginWays){var c=JSON.parse(cefMain.getCurrentRouteConfigJsonStr());if(c.IsDemo=='Y'){a=c.DemoUser}else {a=c.User}}else {var f=JSON.parse(cefMain.getLoginConfigJsonStr());a=f.CurrentAccount.User}var e=a.UserID,d=a.Password,g=a.Token;var h=Ext.Viewport.getController().getComAutoData(JSON.parse(g),e,d);ChatUtil.doAutoLogin(h,function(a){b.validateSession=!0;cefMain.addLogin(e,d,JSON.stringify(a.session),a.user.user_name,function(b){});User.crtUser=a.user;User.erpSession=a.erp_session;User.erpToken=a.erp_token;User.accURL=a.aio7_url;User.token=a.session.token;User.devType=a.session.device_type;User.useReceipt=a.use_receipt;ConfigMgr.orgShowRoot=a.show_root_user;ConfigMgr.useAio8=a.use_aio8;Config.aErp8Url=a.erp8_url;Config.aGrp8Url=a.grp8_url;Config.aio8ClientUrl=a.client_url;var c=(new Date()).getTime();User.difTime=c-a.login_time;User.crtCorpID=a.corp_id;if(a.status_interval){User.StatusIvl=a.status_interval}cefMain.setSession(User.erpToken,User.accURL,User.token);cefMain.setSession8(a.erp8_url,a.grp8_url,a.client_url,a.corp_id);cefMain.setFileServer(a.file_server,parseInt(a.file_port,10));LocalDataMgr.getOrgHash(function(c){User.orgHash=c;Utils.custAjax('get','users/all',{success:function(e,h){if(h=='304'){BindHelper.bindOrgWithCache(Ext.getCmp('mainOrg'));return}var f=e.organizations,d=e.users,g=e.org_hash;User.orgHash=g;User.pushUserInfo(d);User.allUsers=d;User.organization=f;b.setOrgData(JSON.stringify({users:d,orgs:f}),'Y');LocalDataMgr.initUpdateOrg(d,f,g);BindHelper.bindOrg(Ext.getCmp('mainOrg'))},failure:function(){BindHelper.bindOthers()},callback:function(){}},!1,'&org_hash='+c)});Utils.custAjax('get','users/me/info',{success:function(c){User.crtUser=c.user;b.doOwnAva(!0);var d=cefMain.getDataDirectory();d=ParseUtil.clearFileOfURL(d);var i,g;var f;if(Config.isPC){i=ParseUtil.clearFileOfURL(cefMain.getDataDirectory())+(User.accountID+'/'+User.ownerID)+'/Worktop';g=JSON.parse(cefMain.getSettingData()).work_folder?JSON.parse(cefMain.getSettingData()).work_folder.replace(/\\/g,'/'):i;f=JSON.parse(cefMain.getSettingData()).work_folder_show==''?'Y':JSON.parse(cefMain.getSettingData()).work_folder_show}c.settings.fileFolder=d;c.settings.work_folder=g;c.settings.work_folder_show=f;User.settings=c.settings;b.doSendPlacehodler();b.setSettingData(JSON.stringify(c),'Y');CEFHelper.doBindSendSetting(c.settings.send_hot_key);var e=c.settings.extras;if(e){var h=e.nap_type;if(Ext.isEmpty(h)){return}if(h=='0'){return}var j=e.nap_end;Ext.fireEvent('restShow',j,!0)}}});ChatUtil.getUnreadChats();StatusHelper.startStusIvl();ErpHelper.startSenIvl();if(User.crtChannelId){ChatHelper.openChat(User.crtChannelId)}})},setOrgData:function(b,a){if(!cefMain){return}if(!a){a='N'}cefMain.setOrgData(b,a)},setSettingData:function(b,a){if(!cefMain){return}if(!a){a='N'}cefMain.setSettingData(b,a)},reloadAva:function(a){User.cacheMil=(new Date()).getTime();User.crtUser.avatar_hash=a;this.getViewModel().set({'avatar':['<div style="padding-left: 12px;margin-bottom: 24px;">',AvatarMgr.getUserAvaHtml(User.ownerID,User.crtUser.avatar_hash,!1,!0),'</div>'].join('')})},handleCEF:function(){CEFHelper.addListeners();this.getViewModel().set('isHideBrowseTitle',!1);window.setMaxIcon=function(b){if(Ext.Viewport.lookup('IM')){var a=Ext.Viewport.lookup('IM').lookup('cefMainTitle').down('#cefMainMax');if(b=='max'){a.setIconCls('im-common-maximize')}else {a.setIconCls('im-common-restore')}}}},mounted:function(){var a=this;WebSocketUtil.initialize(Config.wsGoUrl);WebSocketUtil.setEventCallback(function(b){switch(b.event){case SocketEventType.hello:SocketEventUtil.handleHello(b);break;case SocketEventType.posted:if(!a.hasPopupChat(b)){SocketEventUtil.handleNewPostEvent(b,Ext.Viewport.lookup('IM').down('#recentChat'),Ext.Viewport.lookup('IM'))};break;case SocketEventType.createGrp:SocketEventUtil.handleGrpAddEvent(b);break;case SocketEventType.memAdd:if(!a.hasPopupChat(b)){SocketEventUtil.handleMemAddEvent(b)};break;case SocketEventType.memRemove:if(!a.hasPopupChat(b)){SocketEventUtil.handleMemRemoveEvent(b)};break;case SocketEventType.chgManager:if(!a.hasPopupChat(b)){SocketEventUtil.handleMgrChgEvent(b,{callback:function(c){debugger;var a=ViewGet.getIMChatViewContainer().down('#btnEdit');if(c==User.ownerID){a.setReadOnly(!1)}else {a.setReadOnly(!0)}}})};break;case SocketEventType.updateChat:if(!a.hasPopupChat(b)){SocketEventUtil.handleChgChatHeader(b)};break;case SocketEventType.dismissMultiChat:if(!a.hasPopupChat(b)){SocketEventUtil.handleDismissMultiChat(b)};break;case SocketEventType.joinERPMultiChat:if(!a.hasPopupChat(b)){SocketEventUtil.handleJoinERPMultiChat(b)};break;case SocketEventType.recoverMultiChat:if(!a.hasPopupChat(b)){SocketEventUtil.handleRecoverMultiChat(b)};break;case SocketEventType.getFile:if(!a.hasPopupChat(b)){SocketEventUtil.handleGetFile(b,Ext.Viewport.lookup('IM'))};break;case SocketEventType.viewChat:SocketEventUtil.handleViewChat(b);break;case SocketEventType.revoke:if(!a.hasPopupChat(b)){SocketEventUtil.handleRevokeEvent(b,{callback:function(f,e,c,h){var d=Ext.getStore(f);var g=GroupNotice.getRevokeNotice(c,h);if(!d){return}var a=d.findRecord('msg_id',e);if(a){a.set('msg_type',MsgType.Revoke);a.set('senderID',c);a.set('senderName',User.userInfos[c].user_name);a.set('sendText',g)}if(b.data.msg_type==MsgType.BigFileMsg){DesktopChatUtil.getCefObj().doBFileRevoke(JSON.stringify([{msg_id:e}]))}},asyncCallback:function(a){AtUtil.doPageRemoveMention(a,ViewGet.getMsgView())}})};break;case SocketEventType.getBigFile:if(!a.hasPopupChat(b)){SocketEventUtil.handleGetBigFile(b)};break;case SocketEventType.updateMute:if(!a.hasPopupChat(b)){SocketEventUtil.handleMute(b)};break;case SocketEventType.updateNap:SocketEventUtil.handleNap(b);break;case SocketEventType.viewAt:if(!a.hasPopupChat(b)){SocketEventUtil.handleViewAt(b)};break;case SocketEventType.hisRange:if(!a.hasPopupChat(b)){SocketEventUtil.handlehisRange(b)};break;case SocketEventType.seeHis:if(!a.hasPopupChat(b)){SocketEventUtil.handleSeeHis(b)};break;case SocketEventType.news:SocketEventUtil.handleNewsMessage(b);break;case SocketEventType.crowdnotice:if(!a.hasPopupChat(b)){SocketEventUtil.handleCrowdNoticeMessage(b)};break;case SocketEventType.crowdsetAdmin:if(!a.hasPopupChat(b)){SocketEventUtil.handleCrowdSetAdminMessage(b)};break;case SocketEventType.updateRead:if(VerControll.judgeFn('verReceipt')){if(!a.hasPopupChat(b)){SocketEventUtil.handleUpdateRead(b)}};break;default:break;}});WebSocketUtil.setReconnectCallback(function(){if(!a.validateSession){a.doValidateSession()}else {User.isFirstCon=!0;ChatUtil.getUnreadChats(function(){});for(var d=0;d<Ext.StoreManager.length;d++){var c=Ext.StoreManager.getAt(d);if(c.storeId!='comRct'&&c.storeId!='rgList'){c.isFirst=!0;c.removeAll()}}var f=ViewGet.getRctView(),b=User.crtChannelId;if(f&&b){if(User.popupChat[b]){ChatUtil.doReplyOpenChat();return}var h=Ext.getStore('comRct'),g=h.getById(b);if(g){ChatHelper.doLastChat();ChatHelper.sameOpen(b,!1);ChatHelper.needUpdateChat(b)}}}var e=ViewGet.getReconnectComponent();if(!e){return}e.hide()});WebSocketUtil.setCloseCallback(function(c,b){if(window.disInterval){return}var a=ViewGet.getReconnectComponent();a.hide();a.retryTime=b;a.show()})},hasPopupChat:function(b){if(Ext.isObject(User.popupChat)&&Object.keys(User.popupChat).length>0){var a=b.chat_id;if(!a&&b.data){try{a=b.data.dataStr.split('|')[0]}catch(c){}}if(a){if(User.popupChat[a]){CEFHelper.execChatMethod(a,'handleWS',JSON.stringify(b));return !0}}}return !1},onShowDisInfo:function(b,d){if(!navigator.onLine){if(window.disInterval){return}window.disInterval=window.setInterval(function(){if(navigator.onLine){WebSocketUtil.initialize(Config.wsGoUrl);clearInterval(window.disInterval);window.disInterval=null}},5*1000);b.setHtml('网络连接异常')}else {if(window.disInterval){return}var c=this.getView();var a=b.retryTime;if(Config.newLoginWays){b.setHtml('<div>连接已断开,'+Math.round(a/1000)+'秒后重连<a class="change-route">[切换线路]</a></div>');c.setDisinfo=setInterval(function(){a=a-1000;if(a>0){b.setHtml('<div>连接已断开,'+Math.round(a/1000)+'秒后重连<a class="change-route">[切换线路]</a></div>')}else {clearInterval(c.setDisinfo);c.setDisinfo=null;b.setHtml('<div>连接已断开,正在尝试连接...<a class="change-route">[切换线路]</a></div>')}},1000)}else {b.setHtml('<div>连接已断开,'+Math.round(a/1000)+'秒后重连</div>');c.setDisinfo=setInterval(function(){a=a-1000;if(a>0){b.setHtml('<div>连接已断开,'+Math.round(a/1000)+'秒后重连</div>')}else {clearInterval(c.setDisinfo);c.setDisinfo=null;b.setHtml('<div>连接已断开,正在尝试连接...</div>')}},1000)}}},onHideDisInfo:function(c,d){var a=this;var b=this.getView();if(b.setDisinfo){clearInterval(b.setDisinfo);b.setDisinfo=null}if(Config.newLoginWays){if(a.newRoute){cefMain.selectRoute(a.newRoute.routeID,function(){});delete a.newRoute;delete a.fromRouteID;delete a.currentRouteID}}},onDisInfoClick:function(a){if(navigator.onLine){if(Config.newLoginWays){ViewGet.getReconnectComponent().setHtml('<div>连接已断开,正在尝试连接...<a class="change-route">[切换线路]</a></div>');var b=Ext.fly(a.target);if(b.is('a')){this.chgRoute()}WebSocketUtil.conn=null;WebSocketUtil.initialize(Config.wsGoUrl)}else {ViewGet.getReconnectComponent().setHtml('连接已断开,正在尝试连接...');WebSocketUtil.initialize(Config.wsGoUrl)}}},chgRoute:function(){var a=this;if(Config.newLoginWays){return}var c=JSON.parse(cefMain.getCurrentRouteConfigJsonStr()),d=c.IsDemo;a.fromRouteID=c.RouteID;if(d=='Y'){a.fromRouteID=c.DemoRouteID}var b=window.RouteList.nextRoute(a.currentRouteID||a.fromRouteID,d,a.fromRouteID);if(b){a.currentRouteID=b.routeID;a.newRoute=b;Config.httpUrlForGo=Utils.joinPath(b.routeUrl,'api/v1/');Config.wsGoUrl=Utils.joinPath(b.routeUrl.replace('http','ws'),'api/v1/websocket')}},onTabChanges:function(h,g,e){var f,d,c,b;var a=this.getView().down('midPanel');if(e.getItemId()=='users'){User.PcCacheMidWidth=a.getWidth()}a.setResizable(null);a.setWidth(242);if(g.getItemId()=='latestComment'){f='recentChat';c='firstTabRight'}else {if(g.getItemId()=='users'){a.setWidth(User.PcCacheMidWidth);a.setResizable({edges:'east'});Utils.custAjax('get','users/me/chatcs',{success:function(a){User.crowdInfo=a;BindHelper.bindcrodlist()}});if(User.firstIntoOrg){User.firstIntoOrg=!1}f='secondTabMid';c='secondTabRight'}}if(e.getItemId()=='latestComment'){d='recentChat';b='firstTabRight'}else {if(e.getItemId()=='users'){d='secondTabMid';b='secondTabRight'}}this.chgMidView(f,d);this.chgRightView(c,b)},chgMidView:function(c,a){var e=this;var d=e.getView().down('#middleView');a=d.down('#'+a);if(a){a.hide()}var b=d.down('#'+c);if(b){if(c=='thirdTabMid'){}else {b.show()}}return b},chgRightView:function(d,a){var e=this;var c=e.getView();if(a){a=c.lookup(a);if(!a.getHidden()){a.hide()}}var b=c.lookup(d);if(b){b.show()}return b},showGrpSel:function(b,a,c,d){if(a==ChatType.Multi){this.onShowAddMemCef(b,c,d)}else {if(a==ChatType.Direct){this.onShowGrpSel('open',b)}}},notAddShowGrpSel:function(){this.onShowGrpSel('open')},onShowGrpSel:function(c,a,d,e){if(!a){a=[User.ownerID]}var b={defSelUsers:a,fromAdd:c,hideACheckbox:!0};DesktopChatUtil.defaults4UserSelForm(b,{})},onShowAddMemCef:function(c,b,e){var a=!0;if(b==User.ownerID){a=!1}var d={defSelUsers:c,fromAdd:'add',hideACheckbox:a,chatID:e};DesktopChatUtil.defaults4UserSelForm(d,{})},onShowMsgManger:function(){if(window.cefMain){cefMain.showMessageManagerForm()}},onShowAbout:function(){if(window.cefMain){if(cefMain.showAboutForm){cefMain.showAboutForm()}}},onShowSetting:function(){if(window.cefMain){if(cefMain.showSettingForm){cefMain.showSettingForm('commonUse')}}},onShowmyFile:function(){if(window.cefMain){if(cefMain.showFileManageForm){User.isOpenFileMgr=!0;cefMain.showFileManageForm()}}},onOpenAIO:function(){if(ConfigMgr.isAio8()){ErpHelper.openAIO8()}else {ErpHelper.openAIO7()}},cefClose:function(){if(window.cefMain){window.cefMain.close()}},cefMax:function(){if(window.cefMain){window.cefMain.max()}},cefMin:function(){if(window.cefMain){window.cefMain.min()}},doMidSupportChinese:function(){var a=this;var f=a.getView();var b=f.lookup('midpanel_searchfield'),c=b.inputElement.dom,e=function(){a.lockMidSF=!0;a.lockValue=b.getValue()},d=function(){a.lockMidSF=!1;var c=b.getValue();a.unlockValue=c;if(c!=a.lockValue){a.doMiddleSearchChg(b,c,a.lockValue)}};c.addEventListener('compositionstart',e);c.addEventListener('compositionend',d)},onMiddleSearchFieldChg:function(d,b,c){var a=this;var e=setTimeout(function(){if(a.lockMidSF){return}if(a.unlockValue!=b){a.doMiddleSearchChg(d,b,c)}window.clearTimeout(e)},1)},doMiddleSearchChg:function(c,a,b){var d=this;User.searchText=a;var e=window.setTimeout(function(){if(User.searchText==a){d.doMiddleSearch(c,a,b)}window.clearTimeout(e)},500)},doMiddleSearch:function(c,a,b){if(a&&a!='undefined'){var e=ViewGet.getRctView(),d=ViewGet.getSecMidContainer();if(!e.getHidden()){this.doFirstTabSearch(c,a,b)}else {if(!d.getHidden()){this.doSecTabSearch(c,a,b)}}}else {if(this.midSearchP&&!this.midSearchP.getHidden()){this.midSearchP.hide()}if(this.midSecSearchP&&!this.midSecSearchP.getHidden()){this.midSecSearchP.hide()}}},doFirstTabSearch:function(e,d,f){var b=this;var c=b.midSearchP;if(!c){b.midSearchP=Ext.create('IM.view.editPanel.FirstAdvSearchP',{id:'editP_fsp'})}var a=[];LocalSearchMgr.localRctSearch(d,function(h,g){if(h.length>0){var i={hasUser:!0};if(h.length>ConfigMgr.recentSearchNum){i.hasMoreUser=!0}a.push(i);var k=[{hasBack:!0,hasUserBack:!0}];for(var c=0;c<h.length;c++){if(c<ConfigMgr.recentSearchNum){a.push(h[c])}k.push(h[c])}var m=b.getUserStore();m.add(k)}if(g.length>0){var i={hasChat:!0};if(g.length>ConfigMgr.recentSearchNum){i.hasMoreChat=!0}a.push(i);var j=[{hasBack:!0}];for(var c=0;c<g.length;c++){if(c<ConfigMgr.recentSearchNum){a.push(g[c])}j.push(g[c])}var l=b.getChatStore();l.add(j)}b.doMidSearchPShow(a,e)})},getUserStore:function(){var a=Ext.getStore('editP_fsp_user');if(!a){a=Ext.create('Ext.data.Store',{id:'editP_fsp_user'})}a.removeAll();return a},getChatStore:function(){var a=Ext.getStore('editP_fsp_chat');if(!a){a=Ext.create('Ext.data.Store',{id:'editP_fsp_chat'})}a.removeAll();return a},doMidSearchPShow:function(c,e){var a=this;if(c.length==0){c.push({hasNoData:!0})}var d=a.midSearchP.down('#editP_fsp_list');d.setItemTpl(a.midSearchP.itemTpl1);var b=a.getMultiStore();d.setStore(b);b.removeAll();b.add(c);a.midSearchP.showBy(e,'t1-b1')},getMultiStore:function(){var a=Ext.getStore('editP_fsp_multi');if(!a){a=Ext.create('Ext.data.Store',{id:'editP_fsp_multi'})}a.removeAll();return a},doSecTabSearch:function(d,c,e){var b=this;var a=b.midSecSearchP;if(!a){a=b.midSecSearchP=Ext.create('IM.view.editPanel.SecAdvSearchP',{id:'editP_sec_fsp'})}LocalSearchMgr.searchUserInfo(c,function(l,k){var f=k.rows;if(f.length>0){var b=[];for(var g=0;g<f.length;g++){b.push(f.item(g))}try{b=b.filter(function(a){return JSON.parse(a.Organizations).map(function(b){return b.corp_id}).indexOf(User.crtCorpID)>-1});if(!ConfigMgr.showOrgRoot()){var j=User.grpOrgs.find(function(a){return a.corp_id==User.crtCorpID});var h=j?j.org_id:null;if(h){b=b.filter(function(a){return JSON.parse(a.Organizations).filter(function(b){return b.corp_id==User.crtCorpID}).map(function(b){return b.org_id}).filter(function(b){return b!==h}).length>0})}}}catch(m){}var i=Ext.getStore('editP_sec_fsp_s');i.removeAll();i.add(b);a.showBy(d,'t1-b1')}})},onLogout:function(){this.fireEvent('logout')},destroy:function(){Ext.destroy(this.midSearchP);Ext.destroy(this.midSecSearchP);Ext.destroy(this.reconMsgComponent);this.callParent()},onTapLeftToolComment:function(a){if(ViewGet.getRctView().getHidden()){return}ViewGet.getRctView().getScrollable().scrollTo(0,0)},onRestOneHour:function(c){if(User.isWholeRest){Ext.fireEvent('restHide',!0)}else {var b=ParseUtil.getLocalTime(!0),a=b+1000*60*60;Ext.fireEvent('restShow',a,!0)}},onCheckUpdate:function(){if(window.cefMain){cefMain.checkUpdate(function(){})}},onIMResize:function(g,f,e,d,c){var a=ViewGet.getMsgView();if(a.effectObj&&a.getScrollable()){var b=a.effectObj.scrollTop;if(a.effectObj.isBottom){b+=a.effectObj.clientHeight}a.getScrollable().scrollTo(0,b)}}});Ext.define('IM.view.leftTab.organization.OrganizationController',{extend:'Ext.app.ViewController',alias:'controller.left-orgController',init:function(){},onContextmenu:function(e,k){var c=this;var j=c.getView();var f=k.getAttribute('data-recordindex'),a=j.getStore().getAt(f);if(a){var b;var h=a.get('fromFav');var l=a.get('msgReplyFav');var i=a.get('uid');var g=a.get('msgCrowdFav');if(h){var d=a.get('uid');if(d!='favPlace'){b=c.getFavContextmenu(a)}}else {if(i==='bnewsPlace'){return}else {if(g){var d=a.get('uid');if(d!='crowd'){b=c.getCrowdContextmenu(a)}}else {b=c.getOrgContextMenu(a)}}}if(b){ParseUtil.menuShowAtVisible(b,e.getPoint())}}else {Utils.toastShort('程序出错了')}e.preventDefault()},getFavContextmenu:function(a){var b=Ext.create('IMCommon.view.menu.HideDestroyMenu',{width:100,items:[{text:'打开会话',indented:!1,handler:function(){ChatHelper.openChat(a.get('chat_id'))}}]});return b},getCrowdContextmenu:function(a){var b=Ext.create('IMCommon.view.menu.HideDestroyMenu',{width:100,items:[{text:'打开会话',indented:!1,handler:function(){Utils.custAjax('get','chatcs/'+a.data.id,{success:function(b){LocalDataMgr.saveCrowdInfo(b,function(){ChatHelper.openCrowd(a.data)})},failure:function(){}})}}]});return b},getOrgContextMenu:function(a){var d=this;var b='发起多人会话';if(a.isLeaf()){b='发起多人会话'}var c=Ext.create('IMCommon.view.menu.HideDestroyMenu',{width:100,items:[{text:b,indented:!1,handler:function(){d.saveReordToCache(a);ChatHelper.doubleToIMView()}}]});return c},saveReordToCache:function(a){User.detailByOrg=a},orgOnTapChild:function(h,c){var a=c.record;if(!a){return}var b=this;var i=c.event;var d=Ext.fly(i.target);if(d.hasCls('org_fav_edit')){ViewGet.getSecFavGridViewStore().getSorters().remove('fav_index');ChatHelper.showSecMid('secFavEdit','secTabOrg')}else {if(d.hasCls('org_refresh')){b.refreshOrg()}else {if(!b.isRoot(a)){this.expandByTap(h,a)}var g=a.get('fromFav');var f=a.get('msgReplyFav');var e=a.get('msgCrowdFav');if(g){b.setFavHtml(a);ChatHelper.showSecRight('chatFav','details','replyfav','crowdFav')}else {if(f){b.setreplyHtml(a);ChatHelper.showSecRight('replyfav','details','chatFav','crowdFav')}else {if(a.data&&a.data.uid==='bnewsPlace'){b.setreplyHtml(a);ChatHelper.showSecRight('replyfav','details','chatFav','crowdFav')}else {if(e){b.setcrowdHtml(a);ChatHelper.showSecRight('crowdFav','details','chatFav','replyfav')}else {b.saveReordToCache(a);b.setOrgHtml(a);ChatHelper.showSecRight('details','chatFav','replyfav','crowdFav')}}}}}}},refreshOrg:function(){var b=this,a=b.getView();User.orgHash='needRefresh';Utils.custAjax('get','users/all',{success:function(d,g){if(g=='304'){}else {var f=d.organizations,c=d.users,e=d.org_hash;LocalDataMgr.initUpdateOrg(c,f,e);User.userInfos={};User.pushUserInfo(c);User.allUsers=c;User.organization=f;User.orgHash=e;if(Config.isPC){b.setCefCache()}BindHelper.bindOrg(a)}},failure:function(a){Utils.toastShort(a)},maskTarget:a},!1,'&org_hash='+User.orgHash);StatusHelper.getStatus(User.statusIDs)},setOrgData:function(b,a){if(!cefMain){return}if(!a){a='N'}cefMain.setOrgData(b,a)},setCefCache:function(){var b=this;var a=JSON.stringify({users:User.allUsers,orgs:User.organization});cefMain.setOrgInfo(JSON.stringify({org_data:a}))},setFavHtml:function(a){var j=this;var f=ViewGet.getSecRightFavView();var h=a.get('uid');if(h=='favPlace'){f.setHtml('<h1 class="chat-fav-blank">会话收藏</h1>')}else {var b=a.get('chat_type');var e=a.get('chat_id'),c,d;if(b==ChatType.Direct){c=AvatarMgr.getNavUserAvaUrl(a.get('avaID'))+(new Date()).getTime();d=a.get('header')}else {var g=a.get('chat_create_at');d=a.get('header');if(b==ChatType.Multi){c=AvatarMgr.getNavChatAvaUrl(e,g)+(new Date()).getTime()}else {if(b=='C'){c=AvatarMgr.getNavCrowdUrl(e,g)}}}var i=j.getFavDetailView(c,d,e,b);f.setHtml(i)}},setreplyHtml:function(c){var d=ViewGet.getSecRightContainer(),e=d.child('replyfav'),f=e.getViewModel();var a,b;if(c.data.msgReplyFav){a='回复消息';b='eeeeeeeebbbbbbbbbfffffffff'}else {if(c.data.uid==='bnewsPlace'){a='消息中心';b=StaticChatID.News}}f.setData({theme:a,cid:b})},setcrowdHtml:function(a){var k=this;var b=ViewGet.getSecRightCrowdView();var i=a.get('uid');if(i=='crowd'){b.setHtml('<h1 class="chat-fav-blank">群会话</h1>')}else {var g=a.get('chat_type');var f=a.get('chat_id'),e,c;var h=a.get('avaHash');var d=a.get('chat_create_at');c=a.get('header');e=AvatarMgr.getCrowdAvaHtml(f,d);User.record_crowd=a.data;var j=k.getCrowdView(e,c,f,g,d,h);b.setHtml(j)}},getFavDetailView:function(b,d,e,c){var a='AvatarMgr.doUserAvaErr(this)';if(c==ChatType.Multi){a='AvatarMgr.doChatAvaErr(this)'}if(c=='C'){a='AvatarMgr.doCrowdAvaErr(this)'}return ['<div><img class="chat-fav-img" src="'+b+'" onerror="'+a+'" onclick="watchLargeImg(this, \''+b+'\');"></div>','<div class="chat-fav-text">'+d+'</div>','<div><input class="chat-fav-button" type="button" value="进入会话" cid="'+e+'" onclick="clickFavInput(this)" /></div>'].join('')},getCrowdView:function(f,c,a,h,b,d,g){var e=AvatarMgr.getNavCrowdUrl(a,b);return ['<div>','<img  class="chat-fav-img"  src="'+e+'"  onerror="AvatarMgr.doCrowdAvaErr(this)" ava-id="'+a+'" create-at="'+b+'" hash="'+d+'">','</div>','<div class="chat-fav-text">'+c+'</div>','<div><input class="chat-fav-button" type="button" value="进入会话" cid="'+a+'" onclick="clickInput(this)" /></div>'].join('')},setOrgHtml:function(a){if(a.data.leaf){this.getUserDetailHtml(a)}else {this.getOrgDetailHtml(a)}},getUserDetailHtml:function(d){var c=this;var a=this.getDep(d);var b=d.get('uid');User.getUserInfo(b,function(b){c.doMakeUsrHtml(b,a)},function(){var e=User.getUserInfoByCache(b);c.doMakeUsrHtml(e,a)},function(){var e=User.getUserInfoByCache(b);c.doMakeUsrHtml(e,a)})},doMakeUsrHtml:function(a,e){var b=ViewGet.getSecRightOrgView();var d=a.sex=='M'?'org_details_man':'org_details_woman';var c=AvatarMgr.getNavUserAvaUrl(a.user_id)+(new Date()).getTime();var f='<div class="org_details_user">\n            <img class="org_details_ava" src="'+c+'" onerror="AvatarMgr.doUserAvaErr(this);"  onclick="watchLargeImg(this,\''+c+'\')" />\n            <div class="org_details_username">\n                <div>'+a.user_name+'<span class="'+d+'"></span></div>\n                <div class="org_details_cm">'+a.notes+'</div>\n            </div>\n        </div>\n        <div class="org_details_ud">\n            <div class="org_details_udt"><span class="org_details_udtt">手机</span>'+a.mobile+'</div>\n            <div class="org_details_udt"><span class="org_details_udtt">邮箱</span>'+a.email+'</div>\n            <div class="org_details_udt"><span class="org_details_udtt">部门</span>'+e+'</div>\n        </div>\n        <div><input class="org_details_button" type="button" value="发消息" uid="'+a.user_id+'" onclick="userOnToChat(this)" /></div>';b.setHtml(f);this.corpSelShow(b,!1)},getOrgDetailHtml:function(a){var e=this.getOrgDep(a);var f=a.get('name');var b=this.getDepN(a,[]);b=ParseUtil.clearRepeated(b);var d=this.getOrgOnline(a);this.saveReordToCache(a);var g='<div class="org_details_orgpname">'+e+'</div>\n            <div class="org_details_orgname">'+f+'</div>\n            <div class="org_details_num">'+d+'/'+b.length+'人</div>\n            <div><input class="org_details_button" type="button" value="发起多人会话" onclick="orgOnToChat(this)" /></div>';var c=ViewGet.getSecRightOrgView();c.setHtml(g);this.corpSelShow(c,this.isRoot(a))},corpSelShow:function(c,a){a=!1;if(a===undefined){a=!1}var b=c.getViewModel();if(b){b.setData({isRoot:a})}},isRoot:function(a){return a.get('parentId').toLocaleLowerCase()==='root'},getDep:function(c){var a=c.parentNode,b=[];while(a){if(a.get('uid')=='orgPlace'||a.get('name')=='loading'){break}b.unshift(a.get('name'));a=a.parentNode}if(b.length>0){return b.join('/')}return ''},getOrgDep:function(d){var a=d.parentNode,b='';while(a){if(a.get('uid')=='orgPlace'||a.get('name')=='loading'){break}b=b+'/'+a.get('name');a=a.parentNode}var c=User.orgRootName;if(b){c=c+b}return c},getDepN:function(b,c){for(var a=0;a<b.childNodes.length;a++){if(b.childNodes[a].isLeaf()){c.push(b.childNodes[a].get('uid'))}else {this.getDepN(b.childNodes[a],c)}}return c},getOrgOnline:function(b){var a=this.getOrgOnlineMems(b,[]);a=ParseUtil.clearRepeated(a);return a.length},getOrgOnlineMems:function(b,d){var e,c;for(var a=0;a<b.childNodes.length;a++){if(b.childNodes[a].isLeaf()){e=b.childNodes[a].get('uid'),c=User.allStatus[e];if(c&&(c.mobile_online=='Y'||c.pc_online=='Y')){d.push(e)}}else {this.getOrgOnlineMems(b.childNodes[a],d)}}return d},expandByTap:function(d,b){if(!b.isLeaf()){var e=JSON.parse(cefMain.getUserOrgData());var a=e.orgroot_show;try{a=JSON.parse(a)}catch(f){a={}}var c=b.get('uid');if(b.isExpanded()){d.collapseNode(b);if(!a[User.crtCorpID]){a[User.crtCorpID]=[]}if(!a[User.crtCorpID].includes(c)){a[User.crtCorpID].push(c)}}else {d.expandNode(b);a[User.crtCorpID]=a[User.crtCorpID].filter(function(a){return a!==c})}cefMain.selectOrgRoot(JSON.stringify(a),function(a){console.log(a)})}},orgOnDblSelMem:function(g,b){var a=b.record;if(!a){return}var e=a.get('fromFav');var d=a.get('msgReplyFav');var c=a.get('msgCrowdFav');if(e){var f=a.get('uid');if(f=='favPlace'){return}ChatHelper.openChat(a.get('chat_id'))}else {if(d){ChatHelper.openMsgReply('eeeeeeeebbbbbbbbbfffffffff')}else {if(a.data&&a.data.uid=='bnewsPlace'){ChatHelper.openNews(StaticChatID.News)}else {if(c){Utils.custAjax('get','chatcs/'+a.data.id,{success:function(c){LocalDataMgr.saveCrowdInfo(c,function(){ChatHelper.openCrowd(a.data)})},failure:function(){}})}else {if(!a.data.leaf){return}else {this.saveReordToCache(b.record);ChatHelper.doubleToIMView()}}}}}},onnodeexpand:function(e,b){var c=JSON.parse(cefMain.getUserOrgData());var a=c.orgroot_show;try{a=JSON.parse(a)}catch(f){a={}}var d=b.data.uid;if(!a[User.crtCorpID]){a[User.crtCorpID]=[]}a[User.crtCorpID]=a[User.crtCorpID].filter(function(a){return a!==d});cefMain.selectOrgRoot(JSON.stringify(a),function(a){console.log(a)})},onnodecollapse:function(e,c){var d=JSON.parse(cefMain.getUserOrgData());var a=d.orgroot_show;try{a=JSON.parse(a)}catch(f){a={}}var b=c.data.uid;if(!a[User.crtCorpID]){a[User.crtCorpID]=[]}if(!a[User.crtCorpID].includes(b)){a[User.crtCorpID].push(b)}cefMain.selectOrgRoot(JSON.stringify(a),function(a){console.log(a)})}});Ext.define('IM.view.leftTab.organization.Organization',{extend:'Ext.grid.Tree',xtype:'left-organization',id:'mainOrg',requires:['IM.view.leftTab.organization.OrganizationController'],selectable:{mode:'single'},controller:'left-orgController',userCls:'IM-org-field',userSelectable:!1,infinite:!0,variableHeights:!1,listeners:{childtap:'orgOnTapChild',childdoubletap:'orgOnDblSelMem',nodeexpand:'onnodeexpand',nodecollapse:'onnodecollapse'},titleBar:null,hideHeaders:!0,columns:[{xtype:'treecolumn',renderer:function(e,a){if(a.data.uid=='bnewsPlace'){return '<div class="news_icon"></div>\n                <div class="org_text">消息中心</div>'}if(a.data.leaf){if(a.data.msgCrowdFav){var d=AvatarMgr.getCrowdAvaHtml(a.data.chat_id,a.data.chat_create_at,a.data.avaHash,!0);return ['<div class="leaf_box">','<div class="leaf_stu"></div>','<div class="leaf_ava">',d,'</div >'+a.data.header+'</div>'].join('')}if(a.data.fromFav){var g=a.data.chat_type;d='';if(g==ChatType.Multi){d=AvatarMgr.getChatAvaHtml(a.data.chat_id,a.data.chat_create_at,a.data.avaHash,!0)}else {if(g=='C'){d=AvatarMgr.getCrowdAvaHtml(a.data.chat_id,a.data.chat_create_at,a.data.avaHash,!0)}else {d=AvatarMgr.getUserAvaHtml(a.data.avaID,a.data.avaHash,!0);var f=a.get('avaID'),c=StatusHelper.onlineStu(f);a.data.stu=c;var b='';if(c=='p'){b='leaf_stu_pc'}else {if(c=='m'){b='leaf_stu_mobile'}}}}return ['<div class="leaf_box">','<div class="leaf_stu '+b+'"></div>','<div class="leaf_ava">',d,'</div>',e,'</div>'].join('')}var f=a.get('uid'),c=StatusHelper.onlineStu(f);a.data.stu=c;var b='';if(c=='p'){b='leaf_stu_pc'}else {if(c=='m'){b='leaf_stu_mobile'}}return ['<div class="leaf_box">','<div class="leaf_stu '+b+'"></div>','<div class="leaf_ava">',AvatarMgr.getUserAvaHtml(a.data.uid,a.data.avaHash,!0),'</div>',e,'</div>'].join('')}if(a.data.uid=='favPlace'){return '<div class="org_fav_edit org_text">编辑</div>\n                <div class="org_fav_icon"></div>\n                <div class="org_text">'+e+'</div>'}if(a.data.uid=='orgPlace'){return '<div class="org_refresh org_text">刷新</div>\n                <div class="org_name_icon"></div>\n                <div class="org_text">'+e+'</div>'}if(a.data.uid=='crowd'){return '\n                                <div class="crowd_icon"></div>\n                                <div class="org_text">'+e+'</div>'}return '<div class="org_file_icon"></div>\n            <div class="org_text" style="padding-top: 2px;">'+e+'</div>'},dataIndex:'name',flex:1}],initialize:function(){var a=this;a.callParent(arguments);a.element.on({contextmenu:'onContextmenu',delegate:'.x-listitem',scope:a.getController()})}});Ext.define('IM.view.leftTab.recentChat.RecentChatController',{extend:'Ext.app.ViewController',alias:'controller.recentChat',requires:['IMCommon.local.LocalDataMgr'],onContextmenu:function(c,g){var b=this;var f=b.getView();var d=g.getAttribute('data-recordindex'),a=f.getStore().getAt(d);if(a){var e=b.getContextMenu(a);ParseUtil.menuShowAtVisible(e,c.getPoint())}else {Utils.toastShort('程序出错了')}c.preventDefault()},getContextMenu:function(a){var b=a.get('chat_id');var j=User.getFavChat(b);var i='收藏',h=PreferenceHelper.addFavChat;if(j){i='取消收藏';h=PreferenceHelper.removeFavChat}var c='置顶',e=a.get('toTop');if(e){c='取消置顶'}var d='消息免打扰',f=a.get('IsMute');if(a.get('type')==ChatType.Multi||a.get('type')=='C'){hideMute=!1}else {hideMute=!0}if(f=='Y'){d='新消息提醒'}if(b=='eeeeeeeebbbbbbbbbfffffffff'||b==StaticChatID.News){var g=Ext.create('IMCommon.view.menu.HideDestroyMenu',{items:[{text:c,handler:function(){if(e){a.set('toTop',!1);LocalDataMgr.cancelToTop(b)}else {a.set('toTop',!0);LocalDataMgr.toTop(b)}}},{text:'移除会话',handler:function(){PreferenceHelper.hideChat(b)}},{text:d,hidden:hideMute,handler:function(){if(f=='Y'){PreferenceHelper.remindChat(b,a)}else {PreferenceHelper.muteChat(b,a)}}}]});return g}else {var g=Ext.create('IMCommon.view.menu.HideDestroyMenu',{items:[{text:c,handler:function(){if(e){a.set('toTop',!1);LocalDataMgr.cancelToTop(b)}else {a.set('toTop',!0);LocalDataMgr.toTop(b)}}},{text:'移除会话',handler:function(){PreferenceHelper.hideChat(b)}},{text:i,handler:function(){h(a)}},{text:d,hidden:hideMute,handler:function(){if(f=='Y'){PreferenceHelper.remindChat(b,a)}else {PreferenceHelper.muteChat(b,a)}}}]});return g}},onSelRecentMem:function(g,b){var f=b.record;if(!f){return}var a=b.record.data;if(User.crtChannelId==a.chat_id){ChatHelper.keepLastIndex();return !1}if(a.type==='D'){ChatHelper.openDirectChat(a.chat_id,!0)}else {if(a.type===ChatType.Multi){Utils.custAjax('get','users/me/chats/'+a.chat_id,{success:function(c){if(c.iscrowd!='Y'){ChatHelper.openGroupChat(a.chat_id,!0)}else {var d=ParseUtil.getLocalTime(!0);var f=Ext.getStore('comRct'),e=f.getById(a.chat_id);LocalDataMgr.updateCrowdtoGroup(c,d);e.set({name:c.header,type:'C'});Utils.custAjax('get','chatcs/'+a.chat_id,{success:function(d){LocalDataMgr.saveCrowdInfo(d,function(){ChatHelper.openCrowdInfo(a.chat_id,!0)})},failure:function(){}})}},failure:function(){}})}else {if(a.type==='P'){ChatHelper.openReply(a.chat_id,!0);var d=b.record.get('unReadNum');var e=Ext.Viewport.lookup('IM').down('#recentChat'),c=e.getStore();if(d>0){ChatUtil.setUnreadToRead(c,'eeeeeeeebbbbbbbbbfffffffff')}}else {if(a.type==='C'){Utils.custAjax('get','users/me/chats/'+a.chat_id,{success:function(c){var d=ParseUtil.getLocalTime(!0);var f=Ext.getStore('comRct'),e=f.getById(a.chat_id);LocalDataMgr.updateCrowdtoGroup(c,d);e.set({name:c.header,type:'C'});Utils.custAjax('get','chatcs/'+a.chat_id,{success:function(d){LocalDataMgr.saveCrowdInfo(d,function(){ChatHelper.openCrowdInfo(a.chat_id,!0)})},failure:function(){}})},failure:function(){}})}else {if(a.type===ChatType.News){ChatHelper.openNews(StaticChatID.News,!0)}}}}}},onSelectMem:function(c,a,b){},onDblTapMem:function(d,b){var a=b.record;if(!a){return}var c=d.getStore();if(!c){return}if(b.record.data.chat_id=='eeeeeeeebbbbbbbbbfffffffff'||a.data.chat_id==StaticChatID.News){return}this.doOpenOutChat(c,a)},doOpenOutChat:function(g,a){if(!a){return}if(!g){return}g.remove(a);ChatHelper.chgToBlank();User.crtChannelId=null;User.crtChannelType=null;var b=a.get('chat_id'),f=a.get('name'),c=a.get('type'),e=a.get('IsMute');var d=DtPageCache.rightPages[b];if(d){DesktopChatUtil.toggleHideRightView(b,c,d)}this.getCefChatCustomData(b,function(d){d=JSON.stringify(d);CEFHelper.openOutChat(b,c,d,e,f)},function(){var d=JSON.stringify({IsStop:!0,OwnerID:User.ownerID,ChatID:b,ChatType:c,DisplayName:a.get('name')});CEFHelper.openOutChat(b,c,d,e,f)})},getCefChatCustomData:function(a,d,c){var b=this;LocalDataMgr.beforeDoChat(a,function(g,e){e.OwnerID=User.ownerID;e.Token=User.token;e.HttpUrlForGo=Config.httpUrlForGo;e.AccountID=User.accountID;e.AllUsers=User.allUsers;e.UserInfos=User.userInfos;e.CrtUser=User.crtUser;e.IsWholeRest=User.isWholeRest;e.Settings=User.settings;e.DevType=User.devType;e.AllStatus=User.allStatus;e.useReceipt=User.useReceipt;e.showOrgRoot=ConfigMgr.orgShowRoot;e.useAio8=ConfigMgr.useAio8;if(e.ChatType==ChatType.Direct){var f=ParseUtil.getUserIDByDitChat(e.UserIDs);e.UserID=f;if(Ext.isEmpty(User.userInfos[f])){e.IsBlock=!0}e.OnlineStu=User.allStatus[f]}else {if(e.ChatType==ChatType.Multi){e.GrpStoreMems=b.getMembersByLocalIDs(e.UserIDs,e.ManagerID)}else {if(e.ChatType=='C'){e.GrpStoreMems=b.getMembersByLocalIDs(e.UserIDs,e.ManagerID)}}}d(e)},function(){LocalDataMgr.insertIntoChatByAPI(a,'0',function(){b.getCefChatCustomData(a,d,c)},function(){c()})})},getMembersByLocalIDs:function(j,i){var f=[],h=j.split(','),a,c=!1,b=!1,d={};for(var e=0;e<h.length;e++){a=h[e];var g=User.getUserInfoByCache(a);if(g){if(i===a){c=!0}else {c=!1}if(DesktopChatUtil.showMobile(a)){b=!0}else {b=!1}d=DesktopChatUtil.parseGrpListCls(a);f.push({user_id:a,user_name:g.user_name,isManager:c,showMobile:b,resCls:d.cls,isOnline:d.isOnline})}}return f},onDragstart:function(g,e,d){var h=this.getView().dragQueryCls,c=Ext.fly(d.delegatedTarget),f=c.query(h);if(f.length>0){var a=f[0],j=a.offsetWidth,i=a.offsetHeight;var b=this.getView().getStore();if(!b){return}if(Ext.fly(d.currentTarget).component.getRecord().data.chat_id=='eeeeeeeebbbbbbbbbfffffffff'){return}if(b.getAt(c.getAttribute('data-recordindex')).data.chat_id==StaticChatID.News){return}e.record=b.getAt(c.getAttribute('data-recordindex'));e.oldEle=a;g.getProxy().setHtml('<div draggable="true" style="width:'+j+'px;height:'+i+'px;background:#eaeaea;opacity:0.8;">'+a.outerHTML+'</div>');User.draggingChat=!0}},onDragend:function(h,e,c){User.draggingChat=!1;var d=this.getView().getStore(),b=e.record;if(!d){return}if(!b){return}ChatHelper.doRightPage(b.get('chat_id'));var a=Ext.dom.Element.fromPagePoint(c.pageX,c.pageY);if(a){if(!a.hasCls('.x-component')){a=a.up('.x-component');if(a){var f=a.query('.itemRight');if(f.length>0){var g=f[0];if(e.oldEle==g){return}}}}}this.doOpenOutChat(d,b)}});Ext.define('IM.view.leftTab.recentChat.RecentChat',{extend:'IMCommon.view.RctChat',xtype:'recentChat',requires:['IM.view.leftTab.recentChat.RecentChatController'],controller:'recentChat',initialize:function(){var a=this;a.callParent(arguments);a.element.on({delegate:'.x-listitem',contextmenu:'onContextmenu',scope:a.getController()});var b=new Ext.drag.Source({xclass:'Ext.drag.Source',element:a.getRenderTarget(),handle:'.x-listitem',listeners:{dragstart:'onDragstart',dragend:'onDragend',scope:a.getController()},proxy:{type:'placeholder'}})},dragQueryCls:'.itemRight',deselectable:!1,listeners:{childdoubletap:'onDblTapMem',select:'onSelectMem',childtap:'onSelRecentMem'}});Ext.define('IM.view.leftTab.favorite.FavListController',{extend:'Ext.app.ViewController',alias:'controller.favlistcontroller',init:function(){var a=this,b=a.getView().down('#favDragChat');a.callParent(arguments);b.setItemTpl(this.dragTpl);a.doDragListRightClick();a.bindDefaultFav()},bindDefaultFav:function(){var a=this,b=a.getView().down('#favDragChat');Utils.custAjax('get','users/me/chatfavorites',{success:function(c){User.favChats=c;c=a.sortFav(c);var e=b.getStore();for(var d=0;d<c.length;d++){var f=c[d];a.doExtraFav(f,e)}}})},doExtraFav:function(a,b){var c=a.chat_id;var d='select * from IMChat WHERE ChatID=?;';LocalDataMgr.cExecSqlWithP(d,[c],function(k,j){var h=j.rows;if(h.length>0){var d=h.item(0);var f=a.chat_type;if(!f){f=d.ChatType}var e=c;if(f==ChatType.Direct){var g=d.UserIDs.split(',');if(g[0]==User.ownerID){e=g[1]}else {e=g[0]}}var i=b.findRecord('chat_id',a.chat_id);if(i){b.remove(i)}b.add({fav_index:a.fav_index,fav_name:a.fav_name==''?d.DisplayName:a.fav_name,avaID:e,chat_type:a.chat_type?a.chat_type:d.ChatType,chat_id:a.chat_id,chat_create_at:a.chat_create_at>0?a.chat_create_at:d.CreateAt})}})},sortFav:function(a){var d=a.length;for(var c=0;c<d;c++){for(var b=0;b<d-1-c;b++){if(a[b].fav_index>a[b+1].fav_index){var e=a[b+1];a[b+1]=a[b];a[b]=e}}}return a},doDragListRightClick:function(){var a=this;a.getView().element.on({delegate:'.x-listitem',contextmenu:'onContextmenu',scope:a})},onContextmenu:function(b,g){var f=this.getView().down('#favDragChat');var d=g.getAttribute('data-recordindex'),c=f.getStore(),a=c.getAt(d);if(a){var e=Ext.create('IMCommon.view.menu.HideDestroyMenu',{width:140,items:[{text:'取消收藏',indented:!1,handler:function(){PreferenceHelper.removeFavChat(a)}},{text:'修改收藏名称',indented:!1,handler:function(){Ext.Msg.prompt('修改收藏名称','请输入新名称',function(d,c){if(d=='ok'){PreferenceHelper.updateFavChatName(a.get('chat_id'),c,function(e){a.set('fav_name',c)})}})}}]});e.showAt(b.getPoint())}else {Utils.toastShort('程序出错了')}b.preventDefault()},toggleDrag:function(a){var j=this;var h=a.getText();var d=this.getView().down('#favDragChat'),c=d.getStore();if(h=='排序'){a.setText('完成');c.getSorters().remove('fav_index');d.removeCls('hideMyStyle')}else {var e=c.getData(),f=e.length;if(f>0){var g=[];for(var b=0;b<f;b++){var i=e.getAt(b);g.push({fav_index:b+1,chat_id:i.get('chat_id'),user_id:User.ownerID})}Utils.custAjax('post','chatfavorite/rank',{params:JSON.stringify(g),success:function(c){if(c){for(var b=0;b<f;b++){e.getAt(b).set('fav_index',b+1)}}},callback:function(){c.getSorters().add('fav_index');a.setText('排序');d.addCls('hideMyStyle')}})}else {a.setText('排序')}}},toggleDragOld:function(c){var g=this;var f=c.getIconCls();var b=this.getView().down('#favDragChat'),a=b.getStore();if(f=='x-fa fa-pencil'){c.setIconCls('x-fa fa-check');a.getSorters().remove('fav_index');b.removeCls('hideMyStyle')}else {var d=a.getData(),e=d.length;if(e>0){Ext.Msg.confirm('修改排序','确定要修改排序？',function(i){if(i=='yes'){var g=[];for(var f=0;f<e;f++){var h=d.getAt(f);g.push({fav_index:f+1,chat_id:h.get('chat_id'),user_id:User.ownerID})}Utils.custAjax('post','chatfavorite/rank',{params:JSON.stringify(g),success:function(b){if(b){for(var a=0;a<e;a++){d.getAt(a).set('fav_index',a+1)}}},callback:function(){a.getSorters().add('fav_index');c.setIconCls('x-fa fa-pencil');b.addCls('hideMyStyle')}})}else {a.getSorters().add('fav_index');c.setIconCls('x-fa fa-pencil');b.addCls('hideMyStyle')}})}}},dragTpl:['<span class="myStyle '+Ext.baseCSSPrefix+'list-sortablehandle"></span>','{fav_name}'].join(''),normalTpl:'{fav_name}',onDragSortChat:function(b,c,a){},toggleShowList:function(e){var a=this.getView();var d=this.getView().down('#favDragChat');var b=Ext.Viewport.lookup('IM').down('#left-organization').down('#orgTreeContainer');var c=a.getFlex();if(c!==1){a.setFlex(1);b.setFlex(0)}else {a.setFlex(0);b.setFlex(1)}},onTapFav:function(c,b){var a=b.record;if(!a){return}User.orgView=!1;ChatHelper.showRightView('chatFav','details');this.setFavDetailView(a)},setFavDetailView:function(a){var c=this;var d=Ext.Viewport.lookup('IM').lookup('chatFav');var f=a.get('chat_type');var b=a.get('chat_id');if(f==ChatType.Direct){var j='select * from IMChat Where ChatID=?;';LocalDataMgr.cExecSqlWithP(j,[b],function(m,g){var e=g.rows,j=e.length;if(j>0){var l=e.item(0);var k=c.getOthID(l);var h=AvatarMgr.getUserAvaUrl(k);var f=a.get('fav_name');var i=c.getFavDetailView(h,f,b);d.setHtml(i)}})}else {var g=a.get('chat_create_at');var e=a.get('fav_name');var h=AvatarMgr.getChatAvaUrl(b,g);var i=c.getFavDetailView(h,e,b);d.setHtml(i)}},getFavDetailView:function(b,a,c){return ['<div><img class="chat-fav-img" src="'+b+"\" onerror=\"this.src=Ext.getResourcePath('images/imdefault.png');this.removeAttribute('onerror');\"></div>",'<div class="chat-fav-text">'+a+'</div>','<div><input class="chat-fav-button" type="button" value="进入会话" cid="'+c+'" onclick="clickInput(this)" /></div>'].join('')},getOthID:function(b){var a=b.UserIDs.split(',');if(a[0]==User.ownerID){return a[1]}return a[0]},onDblTapChild:function(d,b){var a=b.record;if(!a){return}var c=a.get('chat_id');ChatHelper.openChat(c)}});Ext.define('IM.view.leftTab.favorite.AutoHeightFavList',{extend:'Ext.List',mixins:['MX.mixin.AutoHeightList'],xtype:'autoHeightFavList'});Ext.define('IM.view.leftTab.favorite.FavList',{extend:'Ext.Container',xtype:'favlist',controller:'favlistcontroller',requires:['IM.view.leftTab.favorite.FavListController','IM.view.leftTab.favorite.AutoHeightFavList'],layout:'vbox',items:[{xtype:'container',cls:'',items:[{xtype:'button',ui:'flat',text:'收藏',width:'100%',textAlign:'left',handler:'toggleShowList'},{xtype:'button',ui:'flat',text:'排序',docked:'right',handler:'toggleDrag'}]},{xtype:'list',itemId:'favDragChat',cls:'hideMyStyle',infinite:!0,variableHeights:!0,flex:1,store:{storeId:'favListStore',fields:['avaID','fav_name','fav_index','chat_id','chat_create_at','header']},plugins:{sortablelist:!0},listeners:{childtap:'onTapFav',childdoubletap:'onDblTapChild'}}]});Ext.define('IM.view.leftTool.leftTool',{extend:'Ext.Panel',xtype:'leftTool',referenceHolder:!0,layout:'vbox',width:60,items:[{xtype:'component',height:12,cls:'imitateLeftTitle',plugins:'draggablehandle',bind:{hidden:'{isHideBrowseTitle}'}},{xtype:'panel',flex:1,layout:'vbox',userCls:'left_tool',maxWidth:60,minWidth:60,items:[{itemId:'left_avatar',cls:'leftTool-avatar',bind:{html:'{avatar}'}},{xtype:'tabpanel',itemId:'leftTool_tab',listeners:{activeItemchange:'onTabChanges'},tabBar:{defaultTabUI:'leftToolBar-ui',layout:{pack:'center'},docked:'left'},items:[{iconCls:'i-im-message',itemId:'latestComment',tab:{bind:{badgeText:'{allUnreadNum > 0 ? allUnreadNum: null}'},listeners:{tap:'onTapLeftToolComment'}}},{iconCls:'i-im-users',itemId:'users'}]},{xtype:'component',flex:1,cls:'imitateLeftTitle',plugins:'draggablehandle'},{xtype:'button',ui:'leftTool-ui',height:50,iconCls:'i-im-home',handler:'onOpenAIO'},{xtype:'button',ui:'leftTool-ui',iconCls:'i-im-history',height:50,handler:'onShowMsgManger'},{xtype:'button',userCls:'settingBtn',ui:'leftTool-ui',iconCls:'i-im-setting',itemId:'left_setting',arrow:!1,menu:[{text:'我的文件',id:'left_tool_file',indented:!1,handler:'onShowmyFile'},{text:'休息一小时',id:'left_tool_rest',indented:!1,handler:'onRestOneHour'},{text:'设置',indented:!1,handler:'onShowSetting'},{text:'升级到',indented:!1,hidden:!0,itemId:'lefttool_update',handler:'onCheckUpdate'}]}]}],initialize:function(){var a=this;a.callParent(arguments);a.down('#left_avatar').element.on({tap:'onShowBsCard',delegate:'img',scope:a});a.checkVersion();User.firstIntoWorkdesk=!0},checkVersion:function(){var c=cefMain.checkVersion();var b=c.split('|');var e=b[0],d=b[1];if(e=='true'){var f=this.down('#left_setting');f.setBadgeText('1');var a=this.down('#left_setting').getMenu().down('#lefttool_update');a.setText('升级到'+d);a.show()}},onShowBsCard:function(a){if(Config.isPC){cefMain.showSettingForm('personCard')}}});Ext.define('IM.view.editPanel.FavSortPController',{extend:'Ext.app.ViewController',alias:'controller.favsortpcontroller',init:function(){},onShowFavSortP:function(){var a=this.getView().down('#favSortP_favGrid');a.updateHideHeaders(!0)},onFavNameRender:function(b,a){var c=a.get('chat_type');if(c==ChatType.Multi){return ['<div class="favSort_ava">',AvatarMgr.getChatAvaHtml(a.data.chat_id,a.data.chat_create_at,'',!0),'</div>','<div class="favSort_name">'+b+'</div>'].join('')}else {if(c=='C'){return ['<div class="favSort_ava">',AvatarMgr.getCrowdAvaHtml(a.data.chat_id,a.data.chat_create_at,'',!0),'</div>','<div class="favSort_name">'+b+'</div>'].join('')}}return ['<div class="favSort_ava">',AvatarMgr.getUserAvaHtml(a.data.avaID,'',!0),'</div>','<div class="favSort_name">'+b+'</div>'].join('')},editSuc:function(){var d=ViewGet.getSecFavGridViewStore(),b=d.getData(),c=b.length;if(c>0){var e=[];for(var a=0;a<c;a++){var f=b.getAt(a);e.push({fav_index:a+1,chat_id:f.get('chat_id'),user_id:User.ownerID})}PreferenceHelper.rankFav(e,function(){var g=ViewGet.getSecOrgView().getStore();var f=g.findRecord('uid','favPlace');f.removeAll();var e=[];for(var d=0;d<c;d++){var a=b.getAt(d);a.set('fav_index',d+1);e.push({fromFav:!0,leaf:!0,iconCls:'hide-icon',header:a.data.header,name:a.data.fav_name,chat_id:a.data.chat_id,chat_create_at:a.data.chat_create_at,fav_index:d+1,chat_type:a.data.chat_type,avaID:a.data.avaID})}f.appendChild(e)},function(){d.getSorters().add('fav_index')})}ChatHelper.showSecMid('secTabOrg','secFavEdit')},onDelFav:function(c,b){var a=b.record;if(!a){return}PreferenceHelper.removeFavChat(a,function(){c.getStore().remove(a);var e=ViewGet.getSecOrgView().getStore();var d=e.findRecord('uid','favPlace');if(d){var f=d.findChild('avaID',a.get('avaID'));d.removeChild(f)}})},onEditFavName:function(c,a){var b=a.record;if(!b){return}var e=a.tool,d=e.getIconCls();if(d=='x-fa fa-pencil'){var f=c.mapToViewIndex(b);this.startEditForField(1,f)}},onFocusFavName:function(a){var b=a.getValue();this.defV=b},onChgFavName:function(b){var a=b.getValue();if(a==this.defV){return}if(!a){b.setValue(this.defV);return}var e=b.getParent(),c=this.getGridLocation(e);if(!c){return}var d=c.record;var f=d.get('chat_id');PreferenceHelper.updateFavChatName(f,a,function(){var e=ViewGet.getSecOrgView().getStore();var c=e.findRecord('uid','favPlace');if(c){var f=c.findChild('avaID',d.get('avaID'));f.set({name:a})}})},getGridLocation:function(a){var b=null;if(a&&a.isField){a=a.getParent()}if(a&&a.isCellEditor){b=a.getLocation();if(Ext.Object.isEmpty(b)){a=a.getRefOwner()}}if(Ext.Object.isEmpty(b)&&a&&a.isGridCell){var d=a.getRecord();var c=a.getColumn();var e=c.getGrid();b=new Ext.grid.Location(e,{record:d,column:c})}return b},startEditForField:function(a,c){var d=this;var b=d.getView().down('#favSortP_favGrid');if(b){if(Ext.isEmpty(c)){c=b.getSelection()}c=b.mapToItem(c);if(Ext.isString(a)){a=b.getColumnForField(a)}else {if(Ext.isNumber(a)){a=b.getColumns()[a]}}var f=b.mapToCell(c,a);var e=d.getGridLocation(f);d.startEdit(e)}},startEdit:function(a){if(a&&a.isGridLocation){a.activate()}}});Ext.define('IM.view.editPanel.FavSortP',{extend:'Ext.Container',xtype:'favSortP',controller:'favsortpcontroller',requires:['IM.view.editPanel.FavSortPController'],userCls:'editP_favSort',layout:'vbox',listeners:{show:'onShowFavSortP'},items:[{xtype:'container',layout:'hbox',items:[{xtype:'component',flex:1,html:'<div class="editP_favSort_t">收藏（编辑模式）</div>'},{xtype:'button',text:'完成',ui:'flat',handler:'editSuc'}]},{xtype:'grid',itemId:'favSortP_favGrid',flex:1,header:!1,hideHeaders:!0,titleBar:null,userSelectable:!1,infinite:!0,variableHeights:!1,store:{fields:['fav_name']},plugins:{sortablelist:{source:{handle:'.grid-sort-handle'}},gridcellediting:{selectOnEdit:!0,clicksToEdit:1}},columns:[{menuDisabled:!0,align:'center',width:30,cell:{tools:[{userCls:'grid-sort-handle',iconCls:'x-fa fa-reorder',tooltip:'拖'}]}},{dataIndex:'fav_name',flex:1,renderer:'onFavNameRender',editor:{listeners:{focusenter:'onFocusFavName',focusleave:'onChgFavName'}}},{width:60,cell:{tools:[{iconCls:'x-fa fa-pencil',tooltip:'更改收藏名称',handler:'onEditFavName'},{iconCls:'x-fa fa-close',tooltip:'取消收藏',handler:'onDelFav'}]}}]}]});Ext.define('IM.view.rightContainer.fav.ChatFavList',{extend:'Ext.List',xtype:'chatFavList',cls:'chatFavList hideListDrag',store:{storeId:'favListStoreNew',fields:['avaID','chat_id','chat_type','header','chat_create_at','fav_name','fav_index']},infinite:!0,variableHeights:!0,plugins:{sortablelist:!0},itemTpl:['<div class="chatFavList_drag '+Ext.baseCSSPrefix+'list-sortablehandle"></div>','<div class="chatFavList_display">','</div>','{fav_name}'].join(''),initialize:function(){var a=this;a.callParent();a.bindDefaultFav();a.element.on({delegate:'.x-listitem',contextmenu:'onContextmenu',scope:a})},bindDefaultFav:function(){var a=this;Utils.custAjax('get','users/me/chatfavorites',{success:function(b){User.favChats=b;var d=a.getStore();b=a.sortFav(b);for(var c=0;c<b.length;c++){var e=b[c];a.doExtraFav(e,d)}}})},sortFav:function(a){var d=a.length;for(var c=0;c<d;c++){for(var b=0;b<d-1-c;b++){if(a[b].fav_index>a[b+1].fav_index){var e=a[b+1];a[b+1]=a[b];a[b]=e}}}return a},doExtraFav:function(a,b){var c=a.chat_id;var d='select * from IMChat WHERE ChatID=?;';LocalDataMgr.cExecSqlWithP(d,[c],function(k,j){var h=j.rows;if(h.length>0){var d=h.item(0);var f=a.chat_type;if(!f){f=d.ChatType}var e=c;if(f==ChatType.Direct){var g=d.UserIDs.split(',');if(g[0]==User.ownerID){e=g[1]}else {e=g[0]}}var i=b.findRecord('chat_id',a.chat_id);if(i){b.remove(i)}b.add({fav_index:a.fav_index,fav_name:a.fav_name==''?d.DisplayName:a.fav_name,avaID:e,chat_id:a.chat_id,chat_create_at:a.chat_create_at>0?a.chat_create_at:d.CreateAt,header:a.header?a.header:d.DisplayName})}})},onTapChild:function(b,a){},onContextmenu:function(c,g){var f=this;var d=g.getAttribute('data-recordindex'),b=f.getStore(),a=b.getAt(d);if(a){var e=Ext.create('IMCommon.view.menu.HideDestroyMenu',{width:140,items:[{text:'取消收藏',indented:!1,handler:function(){PreferenceHelper.removeFavChat(a,function(){b.remove(a)})}},{text:'修改收藏名称',indented:!1,handler:function(){Ext.Msg.prompt('修改收藏名称','请输入新名称',function(d,b){if(d=='ok'){PreferenceHelper.updateFavChatName(a.get('chat_id'),b,function(e){a.set('fav_name',b)})}})}}]});e.showAt(c.getPoint())}else {Utils.toastShort('程序出错了')}c.preventDefault()}});Ext.define('IM.view.middlePanel.secTab.UserTabController',{extend:'Ext.app.ViewController',alias:'controller.usertabcontroller',init:function(){},onSortFav:function(b){var i=this;var a=i.getView().down('#favList3');var g=a.getStore();var h=b.getText();if(h=='排序'){b.setText('完成');a.removeCls('hideListDrag')}else {var d=g.getData(),e=d.length;if(e>0){var f=[];for(var c=0;c<e;c++){var j=d.getAt(c);f.push({fav_index:c+1,chat_id:j.get('chat_id'),user_id:User.ownerID})}Utils.custAjax('post','chatfavorite/rank',{params:JSON.stringify(f),success:function(c){if(c){for(var a=0;a<e;a++){d.getAt(a).set('fav_index',a+1)}}},callback:function(){b.setText('排序');a.addCls('hideListDrag')}})}else {b.setText('排序');a.addCls('hideListDrag')}}},onTapFavList:function(c,b){var a=b.record;if(!a){return}this.setFavDetailView(a)},setFavDetailView:function(a){var c=this;var d=Ext.Viewport.lookup('IM').lookup('chatFav');var f=a.get('chat_type');var b=a.get('chat_id');if(f==ChatType.Direct){var j='select * from IMChat Where ChatID=?;';LocalDataMgr.cExecSqlWithP(j,[b],function(m,g){var e=g.rows,j=e.length;if(j>0){var l=e.item(0);var k=c.getOthID(l);var h=AvatarMgr.getUserAvaUrl(k);var f=a.get('fav_name');var i=c.getFavDetailView(h,f,b);d.setHtml(i)}})}else {var g=a.get('chat_create_at');var e=a.get('fav_name');var h=AvatarMgr.getChatAvaUrl(b,g);var i=c.getFavDetailView(h,e,b);d.setHtml(i)}},getFavDetailView:function(b,a,c){return ['<div><img class="chat-fav-img" src="'+b+"\" onerror=\"this.src=Ext.getResourcePath('images/imdefault.png');this.removeAttribute('onerror');\"></div>",'<div class="chat-fav-text">'+a+'</div>','<div><input class="chat-fav-button" type="button" value="进入会话" cid="'+c+'" onclick="clickInput(this)" /></div>'].join('')},getOthID:function(b){var a=b.UserIDs.split(',');if(a[0]==User.ownerID){return a[1]}return a[0]}});Ext.define('IM.view.middlePanel.secTab.UserTab',{extend:'Ext.tab.Panel',xtype:'userTab',controller:'usertabcontroller',requires:['IM.view.rightContainer.fav.ChatFavList','IM.view.middlePanel.secTab.UserTabController'],tabBar:{layout:{pack:'center'},docked:'top'},items:[{title:'收藏',xtype:'container',layout:'vbox',items:[{xtype:'button',text:'排序',ui:'flat',handler:'onSortFav'},{xtype:'chatFavList',itemId:'favList3',flex:1,listeners:{childtap:'onTapFavList'}}]},{title:'组织',xtype:'left-organization'}]});Ext.define('IM.view.middlePanel.MiddlePanel',{extend:'Ext.Panel',xtype:'midPanel',requires:['IM.view.editPanel.FavSortP','IM.view.middlePanel.secTab.UserTab'],layout:'vbox',cls:'left_panel',ui:'tab',initialize:function(){var a=this;a.callParent(arguments);a.down('#im_mid_restcmp').element.on({tap:'onTapRestCmp',delegate:'input',scope:a});Ext.on({restHide:'restHideFunc',restShow:'restShowFunc',scope:a});var b=User.settings.extras;if(b){if(b.nap_type=='0'){return}a.restShowFunc(b.nap_end,!0)}},onTapRestCmp:function(){this.restHideFunc(!0)},restHideFunc:function(c){DesktopChatUtil.setWholeRest(!1);User.isWholeRest=!1;clearInterval(User.wholeRestInvl);User.wholeRestInvl=null;var a=this.down('#im_mid_restcmp');if(!a.getHidden()){a.hide()}var b=Ext.getCmp('left_tool_rest');if(b){b.setText('休息一小时')}if(c){Utils.custAjax('PUT','users/me/nap',{params:JSON.stringify({nap_type:'0',nap_end:'0'}),failure:function(){Utils.toastShort('请求更新失败')}})}},restShowFunc:function(a,d){if(Ext.isEmpty(a)){return}if(!Ext.isNumber(a)){a=parseInt(a,10)}var e=ParseUtil.getLocalTime(!0);if(a<=e){Ext.fireEvent('restHide',d)}DesktopChatUtil.setWholeRest(!0);User.isWholeRest=!0;var g=this;var b=g.down('#im_mid_restcmp');if(b.getHidden()){b.show()}var c=Ext.getCmp('left_tool_rest');if(c){c.setText('结束休息')}User.settings.extras={nap_type:'3',nap_end:a};if(User.wholeRestInvl){clearInterval(User.wholeRestInvl)}var f=a-e;User.wholeRestInvl=window.setInterval(function(){Ext.fireEvent('restHide',!0)},f);if(d){Utils.custAjax('PUT','users/me/nap',{params:JSON.stringify({nap_type:'3',nap_end:a+''}),failure:function(){Utils.toastShort('请求更新失败')}})}},destoy:function(){this.callParent(arguments);Ext.un({restHide:'restHideFunc',restShow:'restShowFunc',scope:this})},items:[{xtype:'component',height:23,cls:'imitateMidTitle',plugins:'draggablehandle',bind:{hidden:'{isHideBrowseTitle}'}},{xtype:'panel',layout:'hbox',height:37,cls:'midSearchPlace',items:[{xtype:'formpanel',reference:'searchForm',userCls:'midSearch',flex:1,items:[{xtype:'fieldset',items:[{xtype:'searchfield',reference:'midpanel_searchfield',placeholder:'搜索',name:'query',listeners:{change:'onMiddleSearchFieldChg'}}]}]},{xtype:'button',iconCls:'i-im-add',handler:'notAddShowGrpSel'}]},{xtype:'component',itemId:'im_mid_restcmp',cls:'left_panel_rest',hidden:!0,html:'\n        <div><span style="margin-right: 109px;font-size:12px;">休息中</span><input type="button" value="结束休息" class="left_panel_rest_btn"/></div>'},{xtype:'component',style:'background-color:#ffeeed;text-align:center;color:black;line-height:35px;',width:'100%',height:35,ui:'flat',itemId:'disconnectInfo',hidden:!0,retryTime:0,listeners:{tap:{element:'element',fn:'onDisInfoClick'},show:{fn:'onShowDisInfo'},hide:{fn:'onHideDisInfo'}}},{xtype:'recentChat',itemId:'recentChat',cls:'left_tab',flex:1},{xtype:'container',itemId:'thirdTabMid',cls:'left_tab',flex:1,hidden:!0,layout:'fit',items:[{html:'unnecessary'}]},{xtype:'container',itemId:'secondTabMid',cls:'left_tab',flex:1,hidden:!0,layout:'fit',items:[{xtype:'favSortP',hidden:!0,itemId:'secFavEdit'},{xtype:'left-organization',itemId:'secTabOrg'}]}]});Ext.define('IM.view.rightContainer.IMMainViewController',{extend:'Ext.app.ViewController',alias:'controller.im-right-main',requires:['MX.util.Utils','IMCommon.utils.ChatUtil','IMCommon.local.MsgMgrSearch'],listen:{controller:{}},init:function(){var a=this,c=a.getView();c.element.on({tap:'onViewTap',scope:a});window.ditChatHeaderShowPD=function(){if(Config.isPC){var a=ViewGet.getRctStore().getById(User.crtChannelId).get('avaID');CEFHelper.showInformation(a,2)}};var b=User.settings.send_hot_key;a.getViewModel().set({menuGroup:{sendKey:b}})},getRemoveText:function(a){if(User.ownerID==a){return '退出会话'}return '移出会话'},imitateShowAt:function(a,b,c){if(a.getFloated()||a.isPositioned()){if(arguments.length===2){if(b.x){c=b.y;b=b.x-70}else {c=b[1];b=b[0]-70}}a.show();if(a.isPositioned()){a.setLeft(b);a.setTop(c)}else {a.setX(b);a.setY(c)}}return a},onViewTap:function(){var d=this.getView().up('IM');if(!d){return}var c=d.down('#recentChat'),a=c.getSelectable().getLastSelected();var b='';if(a){b=a.data;if(a.length){b=a[0].data}if(b.unReadNum>0){ChatUtil.setUnreadToRead(c.getStore(),b.chat_id)}}},onShowGrpSel:function(){var c=this;var a=ViewGet.getRctStore().getById(User.crtChannelId);if(a){var b=a.get('type');if(b==ChatType.Multi){PreferenceHelper.beforeDoGrpChat(User.crtChannelId,User.ownerID).then(function(a){var d=a.UserIDs.split(',');c.fireEvent('grpSel',d,b,a.ManagerID,a.ChatID)})['catch'](function(a){Utils.toastShort(a)})}else {var d='SELECT * FROM IMChat WHERE ChatID=?;';LocalDataMgr.cExecSqlWithP(d,[User.crtChannelId],function(g,d){var a=d.rows;if(a.length>0){var b=a.item(0);var f=b.UserIDs;var e=f.split(',');c.fireEvent('grpSel',e,b.ChatType)}else {}})}}},onBtnSend:function(b){var a=this.getView().down('#richEditor');SendUtil.sendMsg(a,User.crtChannelId,Ext.Viewport.lookup('IM').down('#recentChat').getStore(),this.getView().down('#chatView'))},onTextBlur:function(a){var b=a.getValue();if(b==''||b==User.rightTitle){a.setValue(User.rightTitle)}else {var c='';if(c==''){if(a._xhr){Ext.Ajax.abort(a._xhr)}if(User.crtChannelType=='C'){Ext.Viewport.lookup('IM').down('#btnEdit').setReadOnly(!0)}else {a._xhr=Utils.custAjax('put','chats/'+User.crtChannelId,{params:JSON.stringify({chat_id:User.crtChannelId,header:b}),success:function(c){debugger;if(c){var e=GroupNotice.chgName(User.crtUser.user_name,b);var d=c.messages[0];var g=Ext.Viewport.lookup('IM').down('#recentChat').getStore().getById(c.chat.chat_id);if(g){g.set({name:b,last_post_msg:e,last_msg_type:MsgType.GroupNotice,last_post_at:new Date(d.create_at),last_post_name:User.crtUser.user_name});User.rightTitle=b}var f=Ext.getStore(c.chat.chat_id);if(f){f.add({msg_id:c.messages[0].msg_id,msgSeq:d.msg_seq,updateTime:d.create_at,GrpChangeMsg:e,showGrpChange:!0});if(User.crtChannelId==c.chat.chat_id){AddDataUtil.onScrolMsgView()}}if(Config.isPC){LocalDataMgr.updateChatName(e,d,User.crtUser.user_name)}}else {Utils.toastShort('请求更新失败');a.setValue(User.rightTitle)}},failure:function(){Utils.toastShort('请求更新失败');a.setValue(User.rightTitle)}})}}else {a.setValue(User.rightTitle);PreferenceHelper.warnGrpMem(c)}}},onDblToDitChat:function(f,c,e){var a=c.record,b=a.get('user_id'),d=a.get('user_name');if(b!==User.ownerID){ChatHelper.createDirectChat(b,d)}},onsetCrowd:function(){var a=User.crtChannelId;Utils.custAjax('get','chatcs/'+a,{success:function(b){var g='UPDATE IMChat SET CreateAt=? WHERE ChatID=?';LocalDataMgr.cExecSqlWithP(g,[b.create_at,a]);var d=Ext.getStore('comRct');if(d){var c=d.getById(a);if(c){c.set({create_at:b.create_at})}}var e=b.create_at;var f=User.crtId;if(window.cefMain){if(cefMain.showCrowdSettingForm){cefMain.showCrowdSettingForm('crowdfristset',a,e,f)}}},failure:function(){}})},onCESend:function(b){var a=this.getView().down('#chatInput').down('#richEditor')},onESend:function(b){var a=this.getView().down('#chatInput').down('#richEditor')},cefClose:function(){if(window.cefMain){window.cefMain.close()}},cefMax:function(){if(window.cefMain){window.cefMain.max()}},cefMin:function(){if(window.cefMain){window.cefMain.min()}}});Ext.define('IM.view.rightContainer.chatView.GroupController',{extend:'Ext.app.ViewController',alias:'controller.groupcontroller',onDialogOK:function(e){var d=Ext.Viewport.down('list').uid,a=Ext.Viewport.down('list').time,c=Ext.Viewport.down('list').origin;if(a===''||a==null){Ext.Msg.alert('温馨提示','请选择日期或者指定某条消息')}else {var b=this.getView().chgHisDialog;ChatHelper.doSearchHistoryAt(d,a,c,b)}},onDialogCancel:function(b){Ext.Viewport.down('list').time='';var a=this.getView().chgHisDialog;a.hide();a.down('#groupDialog_list').getStore().removeAll()},checkHisByNow:function(){this.getView().chgHisDialog.down('list').hide();this.getView().chgHisDialog.down('calendarset').hide();Ext.Viewport.down('list').origin='Y';Ext.Viewport.down('list').time=0},checkHisByAll:function(){this.getView().chgHisDialog.down('list').hide();this.getView().chgHisDialog.down('calendarset').hide();Ext.Viewport.down('list').origin='N';Ext.Viewport.down('list').time=0},checkHisByOne:function(){this.getView().chgHisDialog.down('list').show();this.getView().chgHisDialog.down('calendarset').hide();var a=Ext.getStore('groupDialog_list');var b=Ext.Viewport.down('list').uid;if(a){a.removeAll();Utils.custAjax('get','chats/'+User.crtChannelId+('/joinat/'+b),{success:function(c){var b=c.join_at;LocalDataMgr.getHistoryWhenshow(function(g,f){var e=f.rows;var d=[];for(var b=0;b<e.length;b++){d.push(e.item(b))}a.add(d)},0,b,User.crtChannelId)}})}Ext.Viewport.down('list').time=''},checkHisByDay:function(a){this.getView().chgHisDialog.down('list').hide();this.getView().chgHisDialog.down('calendarset').show();Ext.Viewport.down('list').origin='N'},getDatePanel:function(){var b=this;var a=Ext.getCmp('msgMrd_all_date');if(!a){a=Ext.widget('msgMrd_all_date');b.setHasMsgDate(ParseUtil.getLocalTime(!0),User.crtChannelId,a)}return a},setHasMsgDate:function(a,e,b){Utils.mask(b);if(Ext.isDate(a)){a=a.getTime()}var c=ParseUtil.getPrevMonthStartTime(a),d=ParseUtil.getNextMonthEndTime(a);var f='SELECT CreateAt FROM IMMsg WHERE MsgType<>? AND ChatID=? AND CreateAt>=? AND CreateAt<=? ORDER BY CreateAt ASC;';LocalDataMgr.cExecSqlWithP(f,[MsgType.NotShow,e,c,d],function(i,h){var d=h.rows,g=d.length;var f=[];if(g>0){for(var c=0;c<g;c++){if(c==0){f.push(new Date(d.item(c).CreateAt))}else {if(!ParseUtil.inOneDay(d.item(c).CreateAt,d.item(c-1).CreateAt)){f.push(new Date(d.item(c).CreateAt))}}}b.setSpecialDates(f)}Utils.unMask(b)})},onDateSearch1:function(e,a){if(a){var c=this,b=User.crtChannelId,d=c.getStore();var f='SELECT M.MsgID,M.ChatID,M.MsgType,M.Content,M.CreateAt,M.SenderID,M.SenderName,M.MsgSeq,M.Status,'+'F.FileID,F.BaseID FileBaseID,F.FilePath,F.FileType,F.FileName,F.MimeType,F.Width,F.Height,F.FileSize,F.Extension,F.FileStatus,F.HasPreview,'+'L.BaseID LinkBaseID,L.Type,L.LinkObjType,L.LinkKeyString,L.LinkID,L.LinkTitle,L.LinkType,'+'L.LinkOpUser,L.LinkDesc,L.LinkStr,L.LinkFromID,L.LinkStepID,L.LinkStepDesc,L.LinkStepStatus,L.LinkStatus,L.LinkStgGuid, '+'B.BaseID BFileBaseID,B.BFileID,B.BFilePath,B.BFileName,B.BFileSize,B.BFileExtension,B.BFileStatus,B.CreateAt BCreateAt,B.ExpireAt '+'FROM IMMsg M '+'LEFT JOIN IMFile F ON M.ID = F.BaseID '+'LEFT JOIN IMLink L ON M.ID = L.BaseID '+'LEFT JOIN IMBFile B ON M.ID = B.BaseID '+'WHERE M.ChatID = ? AND M.CreateAt <= ? AND M.MsgType<>? '+'ORDER BY M.CreateAt DESC LIMIT 10;';a=a.getTime();LocalDataMgr.cExecSqlWithP(f,[b,a,MsgType.Revoke],function(n,l){if(User.crtChannelId!==b){return}var j=l.rows,g=j.length;var f=[],i=10;if(g<10){i=i+(10-g)}var k;for(var h=0;h<g;h++){k=j.item(h);f.unshift(k)}var m='SELECT M.MsgID,M.ChatID,M.MsgType,M.Content,M.CreateAt,M.SenderID,M.SenderName,M.MsgSeq,M.Status,'+'F.FileID,F.BaseID FileBaseID,F.FilePath,F.FileType,F.FileName,F.MimeType,F.Width,F.Height,F.FileSize,F.Extension,F.FileStatus,F.HasPreview,'+'L.BaseID LinkBaseID,L.Type,L.LinkObjType,L.LinkKeyString,L.LinkID,L.LinkTitle,L.LinkType,'+'L.LinkOpUser,L.LinkDesc,L.LinkStr,L.LinkFromID,L.LinkStepID,L.LinkStepDesc,L.LinkStepStatus,L.LinkStatus,L.LinkStgGuid, '+'B.BaseID BFileBaseID,B.BFileID,B.BFilePath,B.BFileName,B.BFileSize,B.BFileExtension,B.BFileStatus,B.CreateAt BCreateAt,B.ExpireAt '+'FROM IMMsg M '+'LEFT JOIN IMFile F ON M.ID = F.BaseID '+'LEFT JOIN IMLink L ON M.ID = L.BaseID '+'LEFT JOIN IMBFile B ON M.ID = B.BaseID '+'WHERE M.ChatID = ? AND M.CreateAt > ? AND M.MsgType<>? '+'ORDER BY M.CreateAt ASC LIMIT 10;';LocalDataMgr.cExecSqlWithP(m,[b,a,MsgType.Revoke],function(o,k){if(User.crtChannelId!==b){return}var h=k.rows,m=h.length;var i;for(var g=0;g<m;g++){if(g==0){i=h.item(g)}f.push(h.item(g))}d.removeAll();c.refresh();if(f.length>0){d.add(f);var j=d.findRecord('CreateAt',i.CreateAt);if(j){AddDataUtil.msgScrollToRecord(j,c)}}else {ParseUtil.doEmptyText(c)}})});e.hide()}else {}},destroy:function(){var a=Ext.getCmp('msgMrd_all_date');if(a){Ext.destroy(a)}this.callParent(arguments)},onTextNotice:function(b){var a=b.getInputValue();if(a==User.CrowdNotice){if(a==''){Ext.ComponentQuery.query('#crowdNullnotice')[0].show();Ext.ComponentQuery.query('#crowdNotice')[0].hide()}else {b.setValue(User.CrowdNotice)}}else {Utils.custAjax('put','chatcs/'+User.crtId+'/notice',{params:JSON.stringify({chat_id:User.crtChannelId,id:User.crtId,notice:a}),success:function(d){User.CrowdNotice=a;var c='UPDATE IMChatC SET Notice=? WHERE ChatID=?';LocalDataMgr.cExecSqlWithP(c,[a,User.crtChannelId])},failure:function(){Utils.toastShort('您无权进行此操作');b.setValue(User.CrowdNotice)}})}}});Ext.define('IM.view.rightContainer.chatView.Group',{extend:'Ext.Container',xtype:'chatView_group',controller:'groupcontroller',requires:['IM.model.GroupMembers','IM.view.rightContainer.chatView.GroupController'],cls:'chatview_group',layout:'vbox',viewModel:{data:{memTotal:0,onlineNum:0}},items:[{xtype:'container',style:'border-bottom: 1px solid rgb(207, 207, 207)',itemId:'crowdNotice2',items:[{xtype:'component',html:'群公告',cls:'crowdnotice',itemId:'crowdNoticetitle',style:'margin-top:5px;margin-left:10px'},{xtype:'textareafield',height:120,style:'margin-top: 0px;',cls:'noticedatial',itemId:'crowdNotice',listeners:{blur:'onTextNotice'}},{xtype:'component',itemId:'crowdNullnotice',height:120,style:'width:118px;margin-top: 0px;text-align: center;',html:'<img src="'+Ext.getResourcePath('images/nullnotice.png',null,'IMCommon')+'" class="replymsg" ><div>暂无公告</div>',hidden:!0,listeners:{click:{element:'element',fn:function(c,b){var a=Ext.getStore('rgList').getById(User.ownerID);if(a.data.isManager||a.data.isadmin=='Y'){Ext.ComponentQuery.query('#crowdNullnotice')[0].hide();Ext.ComponentQuery.query('#crowdNotice')[0].show();Ext.ComponentQuery.query('#crowdNotice')[0].setValue('');Ext.ComponentQuery.query('#crowdNotice')[0].getFocusEl().dom.focus()}}}}}]},{xtype:'component',itemId:'groupClick',bind:{html:'<div class="chatview_group_title">会话成员({onlineNum}/{memTotal})</div>'}},{xtype:'component',itemId:'crowdGroupclick',bind:{html:'<div class="chatview_group_title">群成员({onlineNum}/{memTotal})<span class="opentoclose" style="float: right;margin-right: 10px;"></span></div>'},hidden:!0,listeners:{click:{element:'element',fn:function(b,a){if(Ext.fly(a).dom.children.length==0){if(Ext.fly(a).dom.className=='opentoclose'){Ext.Viewport.down('IM').down('#crowdNotice2').hide();Ext.fly(a).dom.className='closetoopen'}else {if(Ext.fly(a).dom.className=='closetoopen'){Ext.Viewport.down('IM').down('#crowdNotice2').show();Ext.fly(a).dom.className='opentoclose'}}}else {if(Ext.fly(a).dom.children[0].className=='opentoclose'){Ext.Viewport.down('IM').down('#crowdNotice2').hide();Ext.fly(a).dom.children[0].className='closetoopen'}else {if(Ext.fly(a).dom.children[0].className=='closetoopen'){Ext.Viewport.down('IM').down('#crowdNotice2').show();Ext.fly(a).dom.children[0].className='opentoclose'}}}}}}},{xtype:'list',flex:1,itemId:'chatGroupList',userCls:'im_groupList',store:{storeId:'rgList',model:'IM.model.GroupMembers'},itemTpl:'<tpl if="User.crtChannelType==\'C\'">'+'<div style="height: 20px; cursor:default;">'+'{[ParseHelper.parseGrpListHTML(values.user_id, values.status,values.onlineDev)]}'+'{[ParseHelper.showMobile(values.user_id)]}'+'<tpl if="values.isManager">'+'<span style="color:red;">{user_name}</span>'+'<tpl elseif="values.isadmin==\'Y\'">'+'<span style="color:#24a7f8">{user_name}</span>'+'<tpl else>'+'<span class="grp_display_text">{user_name}</span>'+'</tpl>'+'</div>'+'<tpl else>'+'<div style="height: 20px;cursor:default;">'+'{[ParseHelper.parseGrpListHTML(values.user_id, values.status,values.onlineDev)]}'+'{[ParseHelper.showMobile(values.user_id)]}'+'<tpl if="values.isManager">'+'<span style="color:red;">{user_name}</span>'+'<tpl elseif="values.isadmin==\'Y\'">'+'<span style="">{user_name}</span>'+'<tpl else>'+'<span class="grp_display_text">{user_name}</span>'+'</tpl>'+'</div>'+'</tpl>',listeners:{childdoubletap:function(e,c){var a=c.record,b=a.get('user_id'),d=a.get('user_name');if(b!==User.ownerID){ChatHelper.onOpenDirectChat(b,d)}},childsingletap:function(d,b){var a=b.record;if(!a){return}var c=a.get('user_id');CEFHelper.showInformation(c,1)}}}],initialize:function(){var a=this;a.callParent();var b=a.down('#chatGroupList');b.element.on({delegate:'.x-listitem',contextmenu:'onGrpListRightClick',scope:a});b.getStore().on({add:'onGrpAdd',remove:'onGrpRemove',clear:'onGrpClear',scope:a})},onGrpAdd:function(i,b,h){var a=ViewGet.getchatViewGrpViewModel();var e=a.get('onlineNum');var f=a.get('memTotal');for(var d=0;d<b.length;d++){var g=b[d].get('user_id');var c=User.allStatus[g];if(c){if(c.pc_online=='Y'||c.mobile_online=='Y'){e+=1}}}f+=b.length;a.set({onlineNum:e,memTotal:f})},onGrpRemove:function(h,d){var c=ViewGet.getchatViewGrpViewModel();var a=c.get('onlineNum');var b=c.get('memTotal');for(var f=0;f<d.length;f++){var g=d[f].get('user_id');var e=User.allStatus[g];if(e){if(e.pc_online=='Y'||e.mobile_online=='Y'){a-=1}}}b-=d.length;if(a<0){a=0}if(b<0){b=0}c.set({onlineNum:a,memTotal:b})},onGrpClear:function(){ViewGet.getchatViewGrpViewModel().set({onlineNum:0,memTotal:0})},onGrpListRightClick:function(e,j){var g=this;var h=j.getAttribute('data-recordindex'),f=Ext.getStore('rgList'),c=f.getAt(h),a=User.crtChannelId,b=c.get('user_id');var i=g.getRemoveText(b);if(User.crtChannelType!='C'){var d='SELECT * FROM IMChat WHERE ChatID=?';LocalDataMgr.cExecSqlWithP(d,[a],function(x,t){var p=t.rows;if(p.length>0){var d=p.item(0);var k=d.UserIDs;if(SendUtil.inChat(k)){var o=d.ManagerID,n=!0;var h=!0,l=!0,m=!0;if(o==User.ownerID){h=!1;if(User.ownerID!==b){n=!1;m=!1}}else {if(b==User.ownerID){h=!1}if(b==o){l=!1}}if(n&&h&&m&&l){return}var q={text:d.Status=='2'?'恢复会话':'解散会话',ui:d.Status=='2'?'green':'red',hidden:d.ManagerID!==User.ownerID||b!==User.ownerID||d.Status===9||d.Status===1||d.FromERP=='Y',handler:function(){if(d.Status!='2'){Ext.Msg.confirm('提示','确定要解散会话吗?',function(c){if(c==='yes'){Utils.custAjax('PUT','chats/'+a+'/dismiss',{success:function(h){var d=h.messages[0],g=h.chat;var f=GroupNotice.dismissMultiChat(b);LocalDataMgr.updateChatStatus(a,'2');LocalDataMgr.insertNotice({msg_id:d.msg_id,msg_seq:d.msg_seq,chat_id:a,msg_type:MsgType.GroupNotice,content:f,create_at:d.create_at,sender_id:d.user_id,sender_name:User.crtUser.user_name,status:'0'});ChatHelper.updateRctChatStatus(a,'2');ChatHelper.updateUIForMultiChatHeader(!0,g.manager_id==User.crtUser.user_id);ChatHelper.updateUIForRecent(a,g.header,f,d.msg_type,d.create_at,User.crtUser.user_name);ChatHelper.updateUIWithNotice(a,d.msg_seq,d.msg_id,f,d.create_at)}})}})}else {Ext.Msg.confirm('提示','确定要恢复会话吗?',function(c){if(c==='yes'){Utils.custAjax('PUT','chats/'+a+'/recover',{success:function(h){var d=h.messages[0],g=h.chat;var f=GroupNotice.recoverMultiChat(b);LocalDataMgr.updateChatStatus(a,'0');LocalDataMgr.insertNotice({msg_id:d.msg_id,msg_seq:d.msg_seq,chat_id:a,msg_type:MsgType.GroupNotice,content:f,create_at:d.create_at,sender_id:d.user_id,sender_name:User.crtUser.user_name,status:'0'});ChatHelper.updateRctChatStatus(a,'0');ChatHelper.updateUIForMultiChatHeader(!1,g.manager_id==User.crtUser.user_id);ChatHelper.updateUIForRecent(a,g.header,f,d.msg_type,d.create_at,User.crtUser.user_name);ChatHelper.updateUIWithNotice(a,d.msg_seq,d.msg_id,f,d.create_at)}})}})}}};var r=function(){if(k.indexOf(User.ownerID)>-1){var d='确定要移出吗';if(User.ownerID==b){d='确定要退出吗'}Ext.Msg.confirm('移除',d,function(d){if(d==='yes'){Utils.custAjax('DELETE','chats/'+a+'/members/'+b,{success:function(o){f.remove(c);LocalDataMgr.doChatAfterRemoveUser(a,b,k);var h='你已退出该会话';if(User.ownerID!=b){h='你将'+c.get('user_name')+'移出该会话'}var l=Ext.getStore(a);var g=o.messages[0];if(l){var m=AddDataUtil.isMsgViewBottom();l.add({msg_id:g.msg_id,msgSeq:g.msg_seq,updateTime:g.create_at,GrpChangeMsg:h,showGrpChange:!0,showTime:ParseUtil.dataShowTime(l,new Date(g.create_at))});if(User.crtChannelId==a){if(m){AddDataUtil.onScrolMsgView()}}}var n=Ext.getStore('comRct'),i=n.getById(a);if(i){i.set({last_msg_type:MsgType.GroupNotice,last_post_msg:h,last_post_at:new Date(g.create_at)});Utils.custAjax('get','users/me/chats/'+a,{success:function(b){if(b.chat_type==ChatType.Multi){User.needUpdateChatAva(a,b.create_at,b.avatar_hash,function(){i.set('avaHash',b.avatar_hash)})}}})}LocalDataMgr.doMsgAfterRemoveUser(a,g,h)}})}})}else {Utils.toastShort('对不起，您已被移出该会话')}};var v=function(){if(k.indexOf(User.ownerID)>-1){Ext.Msg.confirm('管理员更换','确认更换管理员？',function(d){if(d==='yes'){Utils.custAjax('PUT','chats/'+a+'/manager',{params:JSON.stringify([b]),success:function(q){var f=q.messages[0];var g='你将管理员转让给"'+c.get('user_name')+'"';LocalDataMgr.doChatAfterChgMgr(a,b);LocalDataMgr.doMsgAfterChgMgr(a,f,g);var h=Ext.getStore(a);if(h){var n=AddDataUtil.isMsgViewBottom();h.add({msg_id:f.msg_id,msgSeq:f.msg_seq,updateTime:f.create_at,GrpChangeMsg:g,showGrpChange:!0,showTime:ParseUtil.dataShowTime(h,new Date(f.create_at))});if(User.crtChannelId==a){if(n){AddDataUtil.onScrolMsgView()}}}var o=Ext.getStore('comRct'),l=o.getById(a);if(l){l.set({last_msg_type:MsgType.GroupNotice,last_post_msg:g,last_post_at:new Date(f.create_at)})}var k=ViewGet.getGrpListStore();var m=k.getById(User.ownerID);if(m){m.set({isManager:!1})}var i=k.getById(b);if(i){i.set({isManager:!0})}var p=ViewGet.getIMChatViewContainer().down('#btnEdit');p.setReadOnly(!0)}})}})}else {Utils.toastShort('对不起，您已被移出该会话')}};var u=function(){var a=g.getChgHisDialog(b);Ext.Viewport.down('list').uid=b;a.down('#userSelDialog_radio_now').setChecked(!0);a.show();Ext.Viewport.down('list').origin='Y';Ext.Viewport.down('list').time=0};var s=function(){var b=Ext.getStore('rgList').data.items;var c=!1;for(var a=0;a<b.length;a++){if(b[a].data.user_id==User.ownerID){c=!0;break}}if(c){Utils.custAjax('post','chats/'+User.crtChannelId+'/seehistory',{params:JSON.stringify({chat_id:User.crtChannelId,user_ids:[User.ownerID]}),success:function(a){var b;b='您已经申请了查看更多历史消息';LocalDataMgr.getDB().transaction(function(b){});var f='INSERT INTO IMMsg (MsgID, ChatID, MsgType, Content, CreateAt, Status, MsgSeq) VALUES (?,?,?,?,?,?,?);';LocalDataMgr.cExecSqlWithP(f,[a.msg_id,a.chat_id,MsgType.GroupNotice,b,a.update_at,'0',a.msg_seq],function(c,b){});var g='UPDATE IMRct SET LastMessage=?,LastMsgType=?,LastPostAt=? WHERE ChatID=?;';LocalDataMgr.cExecSqlWithP(g,[b,MsgType.GroupNotice,a.update_at,a.chat_id],function(c,b){});if(!window.cefMsgMgr){var c=Ext.getStore('comRct').getById(a.chat_id);if(c){c.set({last_post_at:new Date(a.update_at),last_msg_type:'H',last_post_name:''})}}if(User.crtChannelId==a.chat_id){var d=Ext.getStore(a.chat_id);if(d){d.add({msg_id:a.msg_id,msgSeq:a.msg_seq,updateTime:a.update_at,GrpChangeMsg:b,showGrpChange:!0,showGrpSeeMore:!1})}}AddDataUtil.onScrolMsgView()},failure:function(a){console.log('温馨提示','申请查看更多历史消息失败')}})}else {Ext.Msg.alert('你已不在此会话中')}};var w=Ext.create('IMCommon.view.menu.HideDestroyMenu',{indented:!1,userCls:'chatview_group',items:[{text:i,hidden:h,handler:r},{text:'更换管理员',hidden:n,handler:v},{text:'指定消息查看范围',hidden:m,handler:u},{text:'申请查看更多历史消息',hidden:l,handler:s},q]});ParseUtil.menuShowAtVisible(w,e.getPoint())}}})}else {var d='SELECT * FROM IMChatC WHERE ID=?';LocalDataMgr.cExecSqlWithP(d,[User.crtId],function(i,f){var d=f.rows;var h=d.item(0);var c=h.ManagerID;if(d.length>0){var g='SELECT * FROM IMChatCM WHERE ChatID=?';LocalDataMgr.cExecSqlWithP(g,[a],function(s,o){var a=o.rows;var l=!0,k=!0;var m=[],n=[];for(var d=0;d<a.length;d++){if(a.item(d).IsAdmin=='Y'&&a.item(d).BodyID!=b){}else {if(a.item(d).IsAdmin!='Y'&&a.item(d).BodyID!=b){}}}var h=!1;for(var g=0;g<a.length;g++){if(a.item(g).BodyID==b){if(a.item(g).IsAdmin=='Y'){if(c==User.ownerID){k=!1;h=!0}}else {if(c==User.ownerID&&User.ownerID==b){}else {if(c==User.ownerID){l=!1;h=!0}}}}}var q=function(){m.push(b);Utils.custAjax('PUT','chatcs/'+User.crtId+'/admin',{params:JSON.stringify({chat_id:User.crtChannelId,admins:m}),success:function(d){var a=Ext.getStore('rgList').getById(b);if(a.data.isadmin=='Y'){a.set('isadmin','N');var c='UPDATE IMChatCM SET IsAdmin=? WHERE (ChatID=? AND BodyID=?)';LocalDataMgr.cExecSqlWithP(c,['N',User.crtChannelId,b])}else {a.set('isadmin','Y');var c='UPDATE IMChatCM SET IsAdmin=? WHERE (ChatID=? AND BodyID=?)';LocalDataMgr.cExecSqlWithP(c,['Y',User.crtChannelId,b])}},failure:function(){}})};var p=function(){n.push(b);Utils.custAjax('PUT','chatcs/'+User.crtId+'/admin',{params:JSON.stringify({chat_id:User.crtChannelId,users:n}),success:function(d){var a=Ext.getStore('rgList').getById(b);if(a.data.isadmin=='Y'){a.set('isadmin','N');var c='UPDATE IMChatCM SET IsAdmin=? WHERE (ChatID=? AND BodyID=?)';LocalDataMgr.cExecSqlWithP(c,['N',User.crtChannelId,b])}else {a.set('isadmin','Y');var c='UPDATE IMChatCM SET IsAdmin=? WHERE (ChatID=? AND BodyID=?)';LocalDataMgr.cExecSqlWithP(c,['Y',User.crtChannelId,b])}},failure:function(){}})};var r=Ext.create('IMCommon.view.menu.HideDestroyMenu',{indented:!1,items:[{text:'设置管理员',hidden:l,handler:q},{text:'取消管理员',hidden:k,handler:p}]});ParseUtil.menuCrowdShowAtVisible(r,e.getPoint(),h)})}})}e.preventDefault()},getRemoveText:function(a){if(User.ownerID==a){return '退出会话'}return '移出会话'},imitateShowAt:function(a,b,c){if(a.getFloated()||a.isPositioned()){if(arguments.length===2){if(b.x){c=b.y;b=b.x-70}else {c=b[1];b=b[0]-70}}a.show();if(a.isPositioned()){a.setLeft(b);a.setTop(c)}else {a.setX(b);a.setY(c)}}return a},getChgHisDialog:function(c){var b=this;var a=this.chgHisDialog;if(!a){a=Ext.apply({ownerCmp:b},b.dialog);this.chgHisDialog=a=Ext.create(a);a.down('#groupDialog_list').getScrollable().on({scroll:'onChgDialogScrol',scope:b})}return a},dialog:{xtype:'dialog',title:'指定消息查看范围',height:'90%',width:'90%',closable:!0,defaultFocus:'#ok',cls:'GroupDialog',bodyPadding:20,layout:'vbox',items:[{xtype:'container',layout:'hbox',items:[{xtype:'radiofield',itemId:'userSelDialog_radio_now',name:'showHistoryat',labelWidth:'auto',labelAlign:'right',style:'margin-right:40px;',label:'仅显示加入会话后的信息',listeners:{check:'checkHisByNow'}},{xtype:'radiofield',itemId:'userSelDialog_radio_all',name:'showHistoryat',labelWidth:'auto',labelAlign:'right',style:'margin-right:40px;',label:'显示全部消息',listeners:{check:'checkHisByAll'}},{xtype:'radiofield',itemId:'userSelDialog_radio_one',name:'showHistoryat',labelWidth:'auto',labelAlign:'right',style:'margin-right:40px;',label:'选择消息进行展示',listeners:{check:'checkHisByOne'}},{xtype:'radiofield',itemId:'userSelDialog_radio_day',name:'showHistoryat',labelWidth:'auto',labelAlign:'right',label:'选择日期',listeners:{check:'checkHisByDay'}}]},{xtype:'combobox',itemId:'groupDialog_search',placeholder:'搜索消息内容',hidden:!0},{xtype:'calendarset',hidden:!0},{xtype:'list',itemId:'groupDialog_list',hidden:!0,flex:1,cls:'pcgrouplist',itemTpl:['<div style="left:0;position:absolute">','<input type="radio"  name="killOrder" value="1" id="setHisRio" class="test-radioInput"/>','</div>','<tpl if="values.MsgType == \'R\'">','<tpl else>','<div class="msgRecord_imitate_list">','<tpl if="values.showDate">','<div class="msgRecord_Date">{[Utils.date2Str(values.CreateAt)]}</div>','</tpl>','<div class="msgRecord_title" style="color:{[values.SenderID == User.ownerID ? \'rgb(36, 118, 224)\' : \'\']}">{SenderName} {[Utils.datetime2Ago(values.CreateAt,true)]}</div>','<div class="msgRecord_content" {[ParseHelper.pushInfoToDom(values)]}>','<tpl if="values.MsgType == \'T\'">','{[ParseUtil.parseHisTextToHtml(values.Content)]}','<tpl elseif="values.MsgType == \'I\'">','{[ParseHelper.parseLoadedPic(values.Height,values.Width,values.FilePath,values.CreateAt,values.FileName,values.FileID)]}','<tpl elseif="values.MsgType == \'F\'">','<div class="msgRecord_file">','<div class="mrd_fileWrapper">','<div class="mrd_fileIcon {[ParseUtil.getFileIcon(values.FileName)]}"></div>','<div class="mrd_fileName">{FileName}</div>','<div>{[ParseUtil.bytesToSize(values.FileSize)]}</div>','</div>','</div>','<tpl elseif="values.MsgType == \'G\'">','{Content}','<tpl elseif="values.MsgType == \'L\'">','<div class="msgRecord_link">','<div class="mrd_linkIcon" letter="{LinkType}"></div>','<div class="mrd_linkName">{LinkTitle}</div>','</div>','<tpl elseif="values.MsgType == \'B\'">','{[GroupNotice.getRevokeNotice(values.SenderID,values.Content)]}','<tpl elseif="values.MsgType == \'E\'">','<div class="msgRecord_file">','<div class="mrd_fileWrapper">','<div class="mrd_fileIcon {[ParseUtil.getFileIcon(values.BFileName)]}"></div>','<div class="mrd_fileName">{BFileName}</div>','<div>{[ParseUtil.bytesToSize(values.BFileSize)]}</div>','</div>','<div class="bigfile-special"></div>','</div>','<tpl else>','消息类型未适配：{MsgType}','</tpl>','</div>','</div>','</tpl>'].join(''),deselectable:!1,store:{storeId:'groupDialog_list',fields:['MsgID','MsgType','Content','SenderID','SenderName','CreateAt','Height','Width','FilePath','FileName','FileID','FileSize','LinkType','LinkTitle','BFileName']},listeners:{childtap:function(b,a){if(Ext.fly(a.event.target).parent('.msgRecord_imitate_list')){if(Ext.fly(a.event.target).parent().parent().dom.getElementsByClassName('test-radioInput').length==0){if(Ext.fly(a.event.target).parent().parent().parent().dom.getElementsByClassName('test-radioInput').length==0){if(Ext.fly(a.event.target).parent().parent().parent().parent().dom.getElementsByClassName('test-radioInput').length==0){Ext.fly(a.event.target).parent().parent().parent().parent().parent().dom.getElementsByClassName('test-radioInput')[0].checked=!0}else {Ext.fly(a.event.target).parent().parent().parent().parent().dom.getElementsByClassName('test-radioInput')[0].checked=!0}}else {Ext.fly(a.event.target).parent().parent().parent().dom.getElementsByClassName('test-radioInput')[0].checked=!0}}else {Ext.fly(a.event.target).parent().parent().dom.getElementsByClassName('test-radioInput')[0].checked=!0}}Ext.Viewport.down('list').time=a.record.data.CreateAt;Ext.Viewport.down('list').origin='N'}}}],buttons:{ok:{handler:'onDialogOK'},cancel:{ui:'flat',handler:'onDialogCancel'}}},onChgDialogScrol:function(h,j,k){var a=h.getScrollElement().dom,f=a.scrollHeight,g=a.scrollTop,e=a.offsetHeight;if(f<=Math.ceil(g+e)){var b=Ext.getStore('groupDialog_list');if(!b){return}var d=b.last();if(!d){return}var c=d.get('CreateAt');if(!c){return}var i='SELECT M.MsgID,M.ChatID,M.MsgType,M.Content,M.CreateAt,M.SenderID,M.SenderName,M.MsgSeq,M.Status,'+'F.FileID,F.BaseID FileBaseID,F.FilePath,F.FileType,F.FileName,F.MimeType,F.Width,F.Height,F.FileSize,F.Extension,F.FileStatus,F.HasPreview,'+'L.BaseID LinkBaseID,L.Type,L.LinkObjType,L.LinkKeyString,L.LinkID,L.LinkTitle,L.LinkType,'+'L.LinkOpUser,L.LinkDesc,L.LinkStr,L.LinkFromID,L.LinkStepID,L.LinkStepDesc,L.LinkStepStatus,L.LinkStatus,L.LinkStgGuid, '+'B.BaseID BFileBaseID,B.BFileID,B.BFilePath,B.BFileName,B.BFileSize,B.BFileExtension,B.BFileStatus,B.CreateAt BCreateAt,B.ExpireAt '+'FROM IMMsg M '+'LEFT JOIN IMFile F ON M.ID = F.BaseID '+'LEFT JOIN IMLink L ON M.ID = L.BaseID '+'LEFT JOIN IMBFile B ON M.ID = B.BaseID '+'WHERE M.ChatID = ? AND M.MsgType<>? AND M.Status<>? AND M.CreateAt < ? '+'ORDER BY M.CreateAt DESC LIMIT 20;';LocalDataMgr.cExecSqlWithP(i,[User.crtChannelId,MsgType.NotShow,'1',c],function(f,e){var d=e.rows;var c=[];for(var a=0;a<d.length;a++){c.push(d.item(a))}b.add(c)})}},destroy:function(){this.callParent(arguments);Ext.destroy(this.chgHisDialog)}});Ext.define('IM.view.chat.ChatView',{extend:'IMCommon.view.MsgView',xtype:'chatView',requires:['IM.model.viewModel.ChatViewDetail','MX.FABButton','MX.fab.Container','IM.view.rightContainer.chatView.Group','IMCommon.view.search.CalendarSet'],uses:['IMCommon.view.desktop.reply.DesktopReply'],viewModel:{type:'chatView_detail'},initialize:function(){var a=this;a.callParent(arguments);var e=a.add({xtype:'fabbutton',height:32,draggable:!1,bind:{hidden:'{hideMoreMsg}',width:'{msgNum > 0 ? 110:100}',text:'{msgNum > 0 ? msgNum+"条新消息":"滚动至最新"}'},ui:'action',iconCls:'x-fa fa-angle-double-down',handler:'onTapShowMsg',scope:a});e.render(a.element);var d=a.add({xtype:'fabbutton',width:100,height:32,top:24,bottom:0,right:24,zIndex:7,draggable:!1,bind:{hidden:'{hideUpBtn}'},text:'向上滚动',ui:'action',iconCls:'x-fa fa-angle-double-up',handler:'onTapUpBtn1',scope:a});d.render(a.element);if(AtUtil.useDB){var b=a.add({xtype:'fabcontainer',layout:'hbox',draggable:!1,style:'\n                -webkit-box-shadow: 0 8px 17px 0 rgba(0, 0, 0, 0.2);\n                -moz-box-shadow: 0 8px 17px 0 rgba(0, 0, 0, 0.2);\n                box-shadow: 0 8px 17px 0 rgba(0, 0, 0, 0.2);\n                border: none;',width:130,height:32,bottom:24,zIndex:100,bind:{hidden:'{hideAtBtn}'},items:[{style:'box-shadow:none;',width:96,height:32,right:33,zIndex:100,draggable:!1,bind:{text:'{atCount}条@消息'},ui:'action',handler:'onTapAtBtnUseDB',scope:a},{xtype:'component',style:'\n                        position: absolute;\n                        border-left: solid 1px #d8d7d7;\n                        right: 32px;\n                        height: 20px;\n                        margin-top: 7px;\n                    '},{style:'box-shadow:none;',width:32,height:32,right:0,zIndex:100,draggable:!1,iconCls:'im-common-close',ui:'imCommonTX',handler:'onClearAtBtnUseDB',scope:a}]});b.render(a.element)}else {var c=a.add({xtype:'fabbutton',width:100,height:32,top:24,bottom:0,right:24,zIndex:100,draggable:!1,bind:{hidden:'{hideAtBtn}',text:'{atCount}条@消息'},ui:'action',handler:'onTapAtBtn',scope:a});c.render(a.element)}a.element.on({delegate:'.bubble',contextmenu:'onRightClickBubble',scope:a});a.on({revokeEdit:'onRevokeEdit',childtap:'doPageTap',scope:a});a.on({seeHistory:'onSeeHistory',scope:a});a.on({setoneHistory:'onsetoneHistory',scope:a})},doPageTap:function(g,a){var b=a.record;if(!b){return}var d=User.crtChannelId;if(!d){return}var c=User.crtChannelType;if(!c){return}var e=a.event;var f=Ext.fly(e.target);if(f.hasCls('msgview_reply')){DesktopChatUtil.showReply(b)}},onSeeHistory:function(f,e){var b=Ext.getStore('rgList').data.items;var c=!1;for(var a=0;a<b.length;a++){if(b[a].data.user_id==User.ownerID){c=!0;break}}if(c){this.mouseOverItem.getRecord().data.showGrpSeeMore=!1;var d=this.mouseOverItem.getRecord().data.msg_id;Utils.custAjax('post','chats/'+User.crtChannelId+'/seehistory',{params:JSON.stringify({chat_id:User.crtChannelId,user_ids:[User.ownerID]}),success:function(a){var b;b='您已经申请了查看更多历史消息';LocalDataMgr.getDB().transaction(function(b){});var i='INSERT INTO IMMsg (MsgID, ChatID, MsgType, Content, CreateAt, Status, MsgSeq) VALUES (?,?,?,?,?,?,?);';LocalDataMgr.cExecSqlWithP(i,[a.msg_id,a.chat_id,MsgType.GroupNotice,b,a.update_at,'0',a.msg_seq],function(c,b){});var j='UPDATE IMRct SET LastMessage=?,LastMsgType=?,LastPostAt=? WHERE ChatID=?;';LocalDataMgr.cExecSqlWithP(j,[b,MsgType.GroupNotice,a.update_at,a.chat_id],function(c,b){});var h='UPDATE IMMsg SET Status=? WHERE MsgID=?;';LocalDataMgr.cExecSqlWithP(h,['0',d],function(c,b){});if(!window.cefMsgMgr){var c=Ext.getStore('comRct').getById(a.chat_id);if(c){c.set({last_post_at:new Date(a.update_at),last_msg_type:'H',last_post_name:''})}}if(User.crtChannelId==a.chat_id){var g=Ext.getStore(a.chat_id);if(g){g.add({msg_id:a.msg_id,msgSeq:a.msg_seq,updateTime:a.update_at,GrpChangeMsg:b,showGrpChange:!0,showGrpSeeMore:!1})}}AddDataUtil.onScrolMsgView()},failure:function(a){console.log('温馨提示','申请查看更多历史消息失败')}})}else {Utils.toastShort('你已不在此会话中')}},onsetoneHistory:function(a){var c=Ext.getStore('rgList').data.items;var d=!1;for(var b=0;b<c.length;b++){if(c[b].data.user_id==a){d=!0;break}}if(d){var e=Ext.Viewport.down('chatView_group').getChgHisDialog(a);Ext.Viewport.down('list').uid=a;e.down('#userSelDialog_radio_now').setChecked(!0);e.show();Ext.Viewport.down('list').origin='Y';Ext.Viewport.down('list').time=0}else {Utils.toastShort('该用户已不在会话中')}},onRevokeEdit:function(c){var a=ViewGet.getEditorView(),b=window.minEmoji(c);a.clear();a.focus();a.pasteHtml(b+'&#8203;')},onTapShowMsg:function(){var a=this,b=a.getStore(),d=b.storeId;User.unReadNum[d];User.isMsgRemoveAll=!0;b.removeAll();var c=a.getViewModel(),e=c.get('hideMoreMsg');if(!e){c.set({hideMoreMsg:!0,msgNum:0})}ChatUtil.handleFirstIn(b,d,a)},onTapUpBtn1:function(){var c=this,d=c,f=d.getViewModel(),a=d.getStore();if(!a){f.set('hideUpBtn',!0);return}var e=a.storeId;var b=ChatUtil.firstUnread[e];if(Ext.isEmpty(b)||Ext.isEmpty(b.msg_id)){return}this.doScrolToMsg(b.msg_id,b.msg_seq,function(b){var d=a.indexOf(b);c.doClearUpBtnCache(e);var f=a.insert(d,{auxiliaryNews:!0,updateTime:b.get('updateTime')});c.isCodeScrol=!0;c.ensureVisible(f[0],{align:{y:'start'}})})},doClearUpBtnCache:function(a){if(a!=User.crtChannelId){return}var b=this.getViewModel();b.set('hideUpBtn',!0);delete ChatUtil.firstUnread[a]},doScrolToMsg:function(k,j,b){var n=this,a=this.getStore();if(!a){return}var l=a.storeId;var c=a.getById(k);if(c){if(b){b(c)}}else {var d=0;for(var e=0;e<a.data.items.length;e++){if(a.getAt(e).get('msgSeq')&&a.getAt(e).get('msgSeq')>=10000){d=a.getAt(e).get('msgSeq');break}}if(d>=10000){var f=j,i=d-f,g=[],h;if(i>20){g.push({from_seq:f-1,to_seq:f+19});h=function(d){a.removeAll();c=a.add(d);if(b){b(c[0])}}}else {if(i>0){g.push({from_seq:f-1,to_seq:d-1});h=function(d){c=a.insert(0,d);if(b){b(c[0])}}}}if(g.length>0){n.getSliHis(l,g,h)}else {var m=a.findRecord('msgSeq',d);if(m&&b){b(c)}}}}},doScrollByUpBtn:function(d,a){a.isCodeScrol=!0;var b=a.getScrollable(),c=b.getScrollElement().dom.scrollTop+d.el.getTop()-a.el.getTop();b.scrollTo(0,c)},doClearUpBtnCache1:function(a){if(a!=User.crtChannelId){return}var b=this.getViewModel();b.set('hideUpBtn',!0);delete ChatUtil.firstUnread[a]},doUpBtnHide1:function(){var d=User.crtChannelId,e=ChatUtil.firstUnread[d],f=this.getViewModel();if(Ext.isEmpty(e)){f.set('hideUpBtn',!0);return}var b=this.getStore();var a=b.getById(e.msg_id);if(a){var c=b.indexOf(a),g=this.getItemAt(c);if(ChatUtil.msgInVisibleArea(g,this)){b.insert(c,{auxiliaryNews:!0,updateTime:a.get('updateTime')});this.doClearUpBtnCache1(d)}}},onTapAtBtn:function(){var a=this,h=User.crtChannelId,j=AtUtil.ats[h].concat();if(!j){AtUtil.clearPageCache(h,a);return}var b=a.getStore();if(!b){return}var k,l,m,c;for(var o in j){c=j[o];if(AtUtil.mentionInVisible(c,a)){AtUtil.removeMentionCache(c,a)}else {k=b.getById(c.msg_id);if(k){l=b.indexOf(k);m=a.getItemAt(l);a.doScrollByUpBtn(m,a);AtUtil.removeMentionCache(c,a)}else {var i=0;for(var d=0;d<b.data.items.length;d++){if(b.getAt(d).get('msgSeq')&&b.getAt(d).get('msgSeq')>=10000){i=b.getAt(d).get('msgSeq');break}}if(i>=10000){var e=c.msg_seq,n=i-e,g=[],f;if(n>20){g.push({from_seq:e-1,to_seq:e+19});f=function(d){b.removeAll();b.add(d);a.isCodeScrol=!0;a.getScrollable().scrollTo(0,1);AtUtil.removeMentionCache(c,a)};a.getSliHis(h,g,f)}else {if(n>0){g.push({from_seq:e-1,to_seq:i-1});f=function(d){b.insert(0,d);a.isCodeScrol=!0;a.getScrollable().scrollTo(0,1);AtUtil.removeMentionCache(c,a)};a.getSliHis(h,g,f)}else {AtUtil.removeMentionCache(c,a)}}}else {AtUtil.removeMentionCache(c,a)}}break}}},onTapAtBtnUseDB:function(){var a=this,b=User.crtChannelId;if(!b){return}LocalDataMgr.getMentions(b,function(t,q){var o=q.rows,j=o.length;if(j>0){var i=o.item(0);AtUtil.removeOneMentionUseDB(i.ChatID,i.MsgID);if(User.crtChannelId==b){var c=a.getStore(),l=c.getById(i.MsgID),m,n,f;if(l){m=c.indexOf(l);n=a.getItemAt(m);a.doScrollByUpBtn(n,a)}else {var h=0;for(var k=0;k<c.data.items.length;k++){f=c.getAt(k).get('msgSeq');if(f&&f>=10000){h=f;break}}if(h>=10000){var d=i.MsgSeq,p=h-d,g=[],e;if(p>20){g.push({from_seq:d-1,to_seq:d+19});e=function(b){c.removeAll();c.add(b);a.isCodeScrol=!0;a.getScrollable().scrollTo(0,1)};a.getSliHis(b,g,e)}else {if(p>0){g.push({from_seq:d-1,to_seq:h-1});e=function(b){c.insert(0,b);a.isCodeScrol=!0;a.getScrollable().scrollTo(0,1)};a.getSliHis(b,g,e)}}}}var r=a.getViewModel(),s=j-1;r.set({hideAtBtn:!1,atCount:s})}if(j-1<=0){AtUtil.doPageClearMention(b,a,!0)}}else {AtUtil.doPageClearMention(b,a,!0)}})},onClearAtBtnUseDB:function(){AtUtil.clearMentionsUseDB(User.crtChannelId,this)},onRightClickBubble:function(d,h){var b=this;var c=d.currentTarget;var g=c.getAttribute('msgType');if(!g){return}var f=c.getAttribute('msgID');if(!f){return}var e=Ext.getStore(User.crtChannelId);if(!e){return}var a=e.getById(f);if(!a){return}LocalDataMgr.getchattype(User.crtChannelId,function(j){var s=a.get('sendStatus');if(s==0){var f=ParseUtil.getHideRevoke(a.get('updateTime'),a.get('senderID'),j);var e=null;switch(g){case MsgType.TextMsg:var l=ParseUtil.getSelectedContents();if(!l){b.selectText(c);l=c.innerHTML};l=l.replace(/&nbsp;/g,' ');var n=ParseUtil.htmlToText(l);if(j=='D'){e=b.getDTextMenu(n,f,a)}else {if(a.data.reply_count>0){e=b.getTextMenu(n,!0,a)}else {e=b.getTextMenu(n,f,a)}};break;case MsgType.ImgMsg:var t=Ext.fly(d.currentTarget);var i=t.query('img')[0];if(!i){return};for(var o=0;o<i.classList.length;o++){if(i.classList[o]=='loaded'){var m=i.getAttribute('src');var k=i.getAttribute('fileName');b.selectText(c);if(j=='D'){e=b.getImgDMenu(m,k,f,a,i)}else {e=b.getImgMenu(m,k,f,a,i)}break}};break;case MsgType.FileMsg:if(parseInt(a.get('fileStatus'),10)==0){var m=a.get('localPath').replace(ConfigMgr.getDataDirectory()+User.accountID+'/'+User.ownerID+'/','');var k=a.get('fileName');if(j=='D'){e=b.getFileDMenu(m,k,f,a)}else {e=b.getFileMenu(m,k,f,a)}};break;case MsgType.LinkErp:var p=a.get('content');if(j=='D'){e=b.getLinkDMenu(p,f,a)}else {e=b.getLinkMenu(p,f,a)};break;case MsgType.BigFileMsg:if(parseInt(a.get('fileStatus'),10)==0){var r=a.get('localPath');var q=a.get('fileName');if(j=='D'){e=b.getBFileDMenu(r,q,f,a)}else {e=b.getBFileMenu(r,q,f,a)}};break;default:break;}if(e){ParseUtil.menuShowAtVisible(e,d.getPoint())}}d.preventDefault()});d.preventDefault()},getTextMenu:function(e,c,a){var b=this;var d=Ext.create('IMCommon.view.menu.HideDestroyMenu',{width:100,items:[{text:'复制',indented:!1,handler:function(){b.cefCopyToClipboard(MsgType.TextMsg,e)}},{text:'撤回',hidden:c,indented:!1,handler:function(){b.doRevoke(a)}},{text:'转发',indented:!1,handler:function(){b.doTransmit(a)}},{text:'回复',hidden:!0,handler:function(){DesktopChatUtil.showReply(a)}}]});return d},getDTextMenu:function(e,c,b){var a=this;var d=Ext.create('IMCommon.view.menu.HideDestroyMenu',{width:100,items:[{text:'复制',indented:!1,handler:function(){a.cefCopyToClipboard(MsgType.TextMsg,e)}},{text:'撤回',hidden:c,indented:!1,handler:function(){a.doRevoke(b)}},{text:'转发',indented:!1,handler:function(){a.doTransmit(b)}}]});return d},getImgMenu:function(a,e,d,c,g){var b=this;a=ParseUtil.getOriginPicPath(a);var f=Ext.create('IMCommon.view.menu.HideDestroyMenu',{width:100,items:[{text:'复制',indented:!1,handler:function(){b.cefCopyToClipboard(MsgType.ImgMsg,a)}},{text:'打开',indented:!1,handler:function(){var i='img.viewPic.loaded';var j=b.innerElement.dom.querySelectorAll(i),f=[],h=-1;j.forEach(function(b,i){f.push({url:b.src,original:b.getAttribute('data-original'),name:b.getAttribute('fileName'),createAt:b.getAttribute('create_at')});if(g===b){h=i}});if(window.cefMain){f=JSON.stringify(f);cefMain.viewImages(f,h)}}},{text:'另存为',indented:!1,handler:function(){FileMgr.saveAs(a,e)}},{text:'打开文件夹',indented:!1,handler:function(){FileMgr.openFolder(a)}},{text:'撤回',hidden:d,indented:!1,handler:function(){b.doRevoke(c)}},{text:'转发',indented:!1,handler:function(){b.doTransmit(c)}},{text:'回复',hidden:!0,handler:function(){DesktopChatUtil.showReply(c)}}]});return f},getImgDMenu:function(a,e,d,c,g){var b=this;a=ParseUtil.getOriginPicPath(a);var f=Ext.create('IMCommon.view.menu.HideDestroyMenu',{width:100,items:[{text:'复制',indented:!1,handler:function(){b.cefCopyToClipboard(MsgType.ImgMsg,a)}},{text:'打开',indented:!1,handler:function(){var i='img.viewPic.loaded';var j=b.innerElement.dom.querySelectorAll(i),f=[],h=-1;j.forEach(function(b,i){f.push({url:b.src,original:b.getAttribute('data-original'),name:b.getAttribute('fileName'),createAt:b.getAttribute('create_at')});if(g===b){h=i}});if(window.cefMain){f=JSON.stringify(f);cefMain.viewImages(f,h)}}},{text:'另存为',indented:!1,handler:function(){FileMgr.saveAs(a,e)}},{text:'打开文件夹',indented:!1,handler:function(){FileMgr.openFolder(a)}},{text:'撤回',hidden:d,indented:!1,handler:function(){b.doRevoke(c)}},{text:'转发',indented:!1,handler:function(){b.doTransmit(c)}}]});return f},getFileMenu:function(a,e,d,b){var c=this;var f=Ext.create('IMCommon.view.menu.HideDestroyMenu',{width:100,items:[{text:'复制',indented:!1,handler:function(){var f=ParseUtil.getAbsolutePath(a);c.cefCopyToClipboard(MsgType.FileMsg,f)}},{text:'打开',indented:!1,handler:function(){FileMgr.open(a)}},{text:'另存为',indented:!1,handler:function(){FileMgr.saveAs(a,e)}},{text:'打开文件夹',indented:!1,handler:function(){FileMgr.openFolder(a)}},{text:'撤回',hidden:d,indented:!1,handler:function(){c.doRevoke(b)}},{text:'转发',indented:!1,handler:function(){c.doTransmit(b)}},{text:'回复',hidden:!0,handler:function(){DesktopChatUtil.showReply(b)}}]});return f},getFileDMenu:function(a,e,d,c){var b=this;var f=Ext.create('IMCommon.view.menu.HideDestroyMenu',{width:100,items:[{text:'复制',indented:!1,handler:function(){var f=ParseUtil.getAbsolutePath(a);b.cefCopyToClipboard(MsgType.FileMsg,f)}},{text:'打开',indented:!1,handler:function(){FileMgr.open(a)}},{text:'另存为',indented:!1,handler:function(){FileMgr.saveAs(a,e)}},{text:'打开文件夹',indented:!1,handler:function(){FileMgr.openFolder(a)}},{text:'撤回',hidden:d,indented:!1,handler:function(){b.doRevoke(c)}},{text:'转发',indented:!1,handler:function(){b.doTransmit(c)}}]});return f},getLinkMenu:function(d,c,a){var b=this;var e=Ext.create('IMCommon.view.menu.HideDestroyMenu',{width:100,items:[{text:'复制',indented:!1,handler:function(){b.cefCopyToClipboard(MsgType.LinkErp,d)}},{text:'撤回',hidden:c,indented:!1,handler:function(){b.doRevoke(a)}},{text:'转发',indented:!1,handler:function(){b.doTransmit(a)}},{text:'回复',hidden:!0,handler:function(){DesktopChatUtil.showReply(a)}}]});return e},getLinkDMenu:function(d,c,b){var a=this;var e=Ext.create('IMCommon.view.menu.HideDestroyMenu',{width:100,items:[{text:'复制',indented:!1,handler:function(){a.cefCopyToClipboard(MsgType.LinkErp,d)}},{text:'撤回',hidden:c,indented:!1,handler:function(){a.doRevoke(b)}},{text:'转发',indented:!1,handler:function(){a.doTransmit(b)}}]});return e},getBFileMenu:function(a,d,f,b){var c=this;var e=Ext.create('IMCommon.view.menu.HideDestroyMenu',{width:100,items:[{text:'复制',indented:!1,handler:function(){var e=ParseUtil.getAbsolutePath(a);c.cefCopyToClipboard(MsgType.FileMsg,e)}},{text:'打开',indented:!1,handler:function(){FileMgr.open(a)}},{text:'另存为',indented:!1,handler:function(){FileMgr.saveAs(a,d)}},{text:'打开文件夹',indented:!1,handler:function(){FileMgr.openFolder(a)}},{text:'撤回',hidden:!0,indented:!1,handler:function(){c.doRevoke(b)}},{text:'转发',indented:!1,handler:function(){c.doTransmit(b)}},{text:'回复',hidden:!0,handler:function(){DesktopChatUtil.showReply(b)}}]});return e},getBFileDMenu:function(a,d,f,c){var b=this;var e=Ext.create('IMCommon.view.menu.HideDestroyMenu',{width:100,items:[{text:'复制',indented:!1,handler:function(){var e=ParseUtil.getAbsolutePath(a);b.cefCopyToClipboard(MsgType.FileMsg,e)}},{text:'打开',indented:!1,handler:function(){FileMgr.open(a)}},{text:'另存为',indented:!1,handler:function(){FileMgr.saveAs(a,d)}},{text:'打开文件夹',indented:!1,handler:function(){FileMgr.openFolder(a)}},{text:'撤回',hidden:!0,indented:!1,handler:function(){b.doRevoke(c)}},{text:'转发',indented:!1,handler:function(){b.doTransmit(c)}}]});return e},getEmojiText:function(b){var a=document.createElement('div');var c=Ext.fly(b);a.innerHTML=c.getHtml();Ext.fly(a).select('span.r-at').removeCls('highlight');Ext.fly(a).query('img.emoji').forEach(function(a){Ext.DomHelper.insertBefore(a,a.getAttribute('alt'),!1);a.parentNode.removeChild(a)});a.innerHTML=a.innerHTML.replace(/[\u200B]/gm,'');return a.innerText},selectText:function(c){if(document.body.createTextRange){var a=document.body.createTextRange();a.moveToElementText(c);a.select()}else {if(window.getSelection){var b=window.getSelection();var a=document.createRange();a.selectNodeContents(c);b.removeAllRanges();b.addRange(a)}}},cefCopyToClipboard:function(b,a){if(window.cefMain){cefMain.setCopyData(b,a,function(c){if(!c){Utils.toastShort('复制出错了')}})}},doRevoke:function(a){var c=User.crtChannelId,b=a.get('msg_id');ChatUtil.doRevoke(c,[b],function(){if(a.get('msg_type')==MsgType.BigFileMsg){if(window.cefMain){cefMain.doBFileRevoke(JSON.stringify([{msg_id:b,file_id:a.get('file_id'),is_mine:!0}]))}}if(a.get('msg_type')=='T'){User.RevokeText=a.data.sendText}var d=a.get('msg_type')==MsgType.TextMsg;var f='撤销了一条消息'+','+Ext.getStore(c).getById(b).data.senderID;var e=GroupNotice.getRevokeNotice(User.ownerID,f);if(d){User.revokeMsgs[b]=a.get('sendText');if(Ext.getStore(c).getById(b).data.senderID!=User.ownerID){d=!1;delete User.revokeMsgs[b]}a.set({showRevokeEdit:d,msg_type:MsgType.Revoke,senderID:User.ownerID,senderName:User.userInfos[User.ownerID].user_name,sendText:e});window.setTimeout(function(){if(User.crtChannelId==c){var d=Ext.getStore(c).getById(b);if(d){d.set({showRevokeEdit:!1})}}delete User.revokeMsgs[b]},5*60*1000)}else {a.set({msg_type:MsgType.Revoke,sendText:e})}})},doTransmit1:function(e){if(Config.isPC){var c=Ext.pluck(Ext.getStore('comRct').data.items,'data');var d=[];for(var b=0;b<c.length;b++){var a=c[b];d.push({transmit:!0,chat_id:a.chat_id,user_id:a.chat_id,ava_id:a.avaID,create_at:a.create_at,chat_type:a.type,leaf:!0,user_name:a.name,iconCls:'hide-icon'})}var f={fromAdd:'transmit',rctData:d,msgID:e.get('msg_id')};DesktopChatUtil.defaults4UserSelForm(f,{})}},doTransmit:function(a){if(Config.isPC){var b='SELECT * FROM IMRct ORDER BY IsTop DESC, LastPostAt DESC, UnreadCount DESC limit 50;';LocalDataMgr.cExecSqlWithP(b,[],function(i,g){var e=g.rows;var f=[];for(var d=0;d<e.length;d++){var b=e.item(d);var c;if(b.ChatID!='eeeeeeeebbbbbbbbbfffffffff'){if(b.ChatType==ChatType.Multi||b.ChatType==ChatType.Group){c=b.ChatID}else {if(b.ChatType==ChatType.Direct){c=b.UserID}else {if(b.ChatType==ChatType.News){continue}}}f.push({transmit:!0,chat_id:b.ChatID,user_id:b.ChatID,ava_id:c,create_at:b.CreateAt,chat_type:b.ChatType,leaf:!0,user_name:b.DisplayName,iconCls:'hide-icon'})}}var h={fromAdd:'transmit',rctData:f,msgID:a.get('msg_id')};DesktopChatUtil.defaults4UserSelForm(h,a.data)})}}});Ext.define('IM.view.chat.ChatInput',{extend:'Ext.Container',xtype:'chatInput',requires:['IMCommon.view.RichEditor','MX.util.FileUtil'],uses:['Common.field.comment.EmojiPanel'],defaultListenerScope:!0,config:{richTextArea:!0,enableUpload:!0},layout:{type:'vbox'},items:[{xtype:'container',minHeight:36,layout:{type:'hbox',align:'center'},defaults:{xtype:'button',ui:'flat'},padding:'0 8px',items:[{iconCls:'i-im-emoji',handler:'showEmjPanel'},{iconCls:'i-im-shortcut',handler:'onCut',userCls:'bgf_folder'},{userCls:'bgf_down',menu:[{handler:'onCutHideForm',text:'隐藏窗口截图',indented:!1}]},{itemId:'btnBrowse',iconCls:'i-im-image',handler:'onSelPic'},{itemId:'btnFile',iconCls:'i-im-file',handler:'onSelFile',userCls:'bgf_folder'},{userCls:'bgf_down',menu:[{handler:'onSelBigFile',text:'发送大文件',indented:!1},{handler:'onOpenBFileForm',text:'打开大文件列表',indented:!1}]},{iconCls:'i-im-link',handler:'handleERPLink'},{iconCls:'x-fa fa-check',hidden:!0,handler:'onReply'},{xtype:'component',flex:1},{itemId:'chatInput_mrd_btn',text:'消息记录',handler:'onShowMsgRecord'}]},{xtype:'container',flex:1,layout:'fit',scrollable:'y',items:[{xtype:'imCommonEditor',userCls:'rich-editor-Ct',itemId:'richEditor'}]}],initialize:function(){var a=this;a.callParent(arguments);a.down('#richEditor').element.on({contextmenu:'onRightClickEditor',scope:a})},onRightClickEditor:function(e){if(window.cefMain){var d=this,b=d.getSelectedContents();var a='',c=!0;if(b){a=ParseUtil.htmlToText(b);c=!1}var f=Ext.create('IMCommon.view.menu.HideDestroyMenu',{width:100,heigth:'100%',items:[{text:'复制',disabled:c,indented:!1,handler:function(){cefMain.setCopyPTData(a,b,function(a){if(!a){Utils.toastShort('复制出错了')}else {ChatHelper.keepLastIndex()}})}},{text:'剪切',disabled:c,indented:!1,handler:function(){a=ParseUtil.getTextByPT(a);cefMain.setCopyPTData(a,b,function(a){if(!a){Utils.toastShort('复制出错了')}else {d.cutText();ChatHelper.keepLastIndex()}})}},{text:'全选',indented:!1,handler:function(){d.selectText()}},{text:'粘贴',indented:!1,handler:function(){ViewGet.getEditorView().doCefPaste()}}]});ParseUtil.menuShowAtVisible(f,e.getPoint());e.preventDefault()}},cutText:function(){var a=ViewGet.getEditorView().inputElement.dom;var b=a.innerHTML;var c=this.getSelectedContents();var d=b.replace(c,'');a.innerHTML=d},getSelectedContents:function(){if(window.getSelection){var b=window.getSelection().getRangeAt(0);var a=document.createElement('div');a.appendChild(b.cloneContents());return a.innerHTML}else {if(document.getSelection){var b=window.getSelection().getRangeAt(0);var a=document.createElement('div');a.appendChild(b.cloneContents());return a.innerHTML}else {if(document.selection){return document.selection.createRange().htmlText}}}},selectText:function(){var c=this.down('#richEditor').inputElement.dom;if(document.body.createTextRange){var a=document.body.createTextRange();a.moveToElementText(c);a.select()}else {if(window.getSelection){var b=window.getSelection();var a=document.createRange();a.selectNodeContents(c);b.removeAllRanges();b.addRange(a)}}},getSubmitValue:function(b){var a=document.createElement('div');a.innerHTML=b;Ext.fly(a).select('span.r-at').removeCls('highlight');Ext.fly(a).query('img.emoji').forEach(function(a){Ext.DomHelper.insertBefore(a,a.getAttribute('alt'),!1);a.parentNode.removeChild(a)});return a.innerHTML.replace(/[\u200B]/gm,'')},handleERPLink:function(){Ext.Msg.prompt('单据链接','',function(b,a){if(b==='ok'){SendUtil.sendErpLink(a,User.crtChannelId)}})},onCut:function(){if(window.cefMain){cefMain.capture()}},onCutHideForm:function(){if(window.cefMain){cefMain.captureNoWindow()}},onSelPic:function(){var b=this;var a=b.down('#richEditor');ImgMgr.chooseImages().then(function(e){var b=e.images;var f=b.length;if(f<=ConfigMgr.oneSendMaxFileNum){var d='';for(var c=0;c<b.length;c++){var g=ParseUtil.getLocalFileURL(b[c].path);d+='<img _width="'+b[c].width+'" _height="'+b[c].height+'" class="ect-img" src="'+g+'" data-url="'+b[c].path+'">'+'&#8203;'}a.inputElement.dom.focus();if(document.queryCommandSupported('insertHTML')){document.execCommand('insertHTML',!1,d)}else {document.execCommand('paste',!1,d)}}else {Utils.toastShort('对不起，您图片的文件过多，请选择少于'+ConfigMgr.oneSendMaxFileNum+'个图片进行发送')}})},_insertimg:function(f,e){var c=window.getSelection?window.getSelection():document.selection;var b=c.createRange?c.createRange():c.getRangeAt(0);if(!window.getSelection){e.inputElement.dom.focus();b.pasteHTML(f);b.collapse(!1);b.select()}else {e.inputElement.dom.focus();b.collapse(!1);var d=b.createContextualFragment(f);var a=d.lastChild;while(a&&a.nodeName.toLowerCase()=='br'&&a.previousSibling&&a.previousSibling.nodeName.toLowerCase()=='br'){var g=a;a=a.previousSibling;d.removeChild(g)}b.insertNode(d);if(a){b.setEndAfter(a);b.setStartAfter(a)}c.removeAllRanges();c.addRange(b)}},onSelFile:function(){FileMgr.chooseFiles().then(function(c){var a=JSON.parse(c);var b=a.length;if(b<=ConfigMgr.oneSendMaxFileNum){SendUtil.sendFileMsgsByOneAPI(a)}else {Utils.toastShort('对不起，您选择的文件过多，请选择少于'+ConfigMgr.oneSendMaxFileNum+'个文件进行发送')}})},onSelBigFile:function(){if(window.cefMain){if(CEFHelper.supportBigFile()){FileMgr.chooseFiles().then(function(b){var a=JSON.parse(b);SendUtil.sendBigFileMsgsByOneAPI(User.crtChannelId,a)})}else {Utils.toastShort('对不起，暂不支持大文件发送')}}},onOpenBFileForm:function(){if(window.cefMain){cefMain.showTransferForm()}},showEmjPanel:function(b){var a=Ext.getCmp('global-emojipanel');if(!a){a=Ext.widget('emojipanel',{id:'global-emojipanel'})}a.on({ok:'onChooseEmj',hide:'onHideEmjPanel',scope:this});a.showBy(b,'tl-bl?')},onChooseEmj:function(c,a){var b=window.minEmoji(a);if(b!==a){this.down('#richEditor').insertObject(window.minEmoji(a),a)}},onHideEmjPanel:function(a){a.un({ok:'onChooseEmj',hide:'onHideEmjPanel',scope:this})},onReply:function(a){a.toggle(!0)},onShowMsgRecord:function(c){var a=User.crtChannelId;if(!a){return}var e=Ext.getStore('comRct').getById(a);if(!e){return}var d=e.get('type'),b=DtPageCache.rightPages[a];if(b){if(b.xtype=='desktopMrdTabpanel'){DesktopChatUtil.toggleHideRightView(a,d,b);c.setPressed(!1)}else {var g=Ext.widget('desktopMrdTabpanel',{style:'border-left:solid 1px #cfcfcf;'});DesktopChatUtil.showRightViewWoToggle(a,g,b);c.setPressed(!0)}}else {var f=Ext.widget('desktopMrdTabpanel',{style:'border-left:solid 1px #cfcfcf;'});DesktopChatUtil.toggleShowRightView(a,d,f);c.setPressed(!0)}},hideFormToCut:function(){CEFHelper.hideFormToCut()}});Ext.define('IM.view.rightContainer.IMMainView',{extend:'Ext.Container',xtype:'im-main',controller:'im-right-main',requires:['IM.view.rightContainer.IMMainViewController','IM.view.chat.ChatView','IM.view.chat.ChatInput','Ext.panel.Resizer','IM.view.rightContainer.chatView.Group'],uses:['IM.view.widget.MrdDatePanel'],layout:'vbox',cls:'right_panel',items:[{xtype:'container',layout:'hbox',userCls:'right-title',items:[{xtype:'textfield',flex:1,itemId:'btnEdit',userCls:'rightTitle',bind:{value:'{sendToName}'},listeners:{blur:'onTextBlur'}},{xtype:'container',itemId:'directChatHeader',flex:1,hidden:!0,bind:{html:'<div class="ditChatHeaderText"><span class="dittext" onclick="ditChatHeaderShowPD();">{sendToName}</span><span class="{ditStu}"></span><span class="ditInCom">{ditInCom}</span></div>'}},{xtype:'button',iconCls:'i-im-adduser',ui:'flat',handler:'onShowGrpSel',itemId:'addMemsButton'},{xtype:'button',ui:'flat',iconCls:'i-im-setting',handler:'onsetCrowd',itemId:'setCrowd'}]},{flex:1,layout:'hbox',id:'im-main-bottom-container',items:[{xtype:'panel',id:'im-main-minWidth-view',minWidth:400,flex:1,layout:'vbox',items:[{xtype:'chatView',itemId:'chatView',userCls:'im_chatView',flex:1,style:{borderBottom:'1px solid #d6d6d6'}},{xtype:'panel',resizable:{edges:'n'},minHeight:120,maxHeight:'70%',height:180,layout:'vbox',items:[{xtype:'chatInput',itemId:'chatInput',userCls:'editor-Ct',flex:1},{xtype:'container',userCls:'bottomSend',layout:'hbox',items:[{xtype:'component',flex:1},{xtype:'button',text:'发送(<span class="sUnderline">S</span>)',ui:'send-ui',width:66,height:24,handler:'onBtnSend'}]}]}]},{xtype:'chatView_group',style:{borderLeft:'solid 1px #cfcfcf'},hidden:!0,minWidth:120,itemId:'groupList'}]}]});Ext.define('IM.view.rightContainer.Details',{extend:'Ext.Container',xtype:'details',defaultListenerScope:!0,referenceHolder:!0,viewModel:{data:{isRoot:!1}},layout:{type:'vbox',pack:'center',align:'center'},cls:'org-details-container',html:'<h1 class="org-details-blank">组织</h1>',items:[{xtype:'selectfield',reference:'corpselector',label:'当前账套',clearable:!1,width:325,docked:'top',style:'margin-left: auto; margin-right: 20px;',bind:{hidden:'{!isRoot}'},listeners:{change:'onSelectCorp'}}],initialize:function(){var a=this;var b=a.getViewModel();a.callParent(arguments);window.userOnToChat=function(b){var a=b.getAttribute('uid');ChatHelper.onOpenDirectChat(a)};window.orgOnToChat=function(){ChatHelper.doubleToIMView()};if(b){b.bind('{isRoot}',function(b,c){if(b){a.loadCorpOpts()}})}},loadCorpOpts:function(){var b=this;var d=b.getViewModel();if(d.get('isRoot')){var a=b.lookup('corpselector');var c=User.grpOrgs.map(function(a){return {value:a.corp_id,text:a.name}});a.setOptions(c);a.setValue(User.crtCorpID)}},onSelectCorp:function(d,c,a){if(a){var b=Ext.getCmp('mainOrg');User.crtCorpID=c;BindHelper.bindOrgWithCache(b)}}});Ext.define('IM.view.rightContainer.BlankPage',{extend:'Ext.panel.Panel',xtype:'pageblank',requires:['Ext.layout.VBox'],defaultListenerScope:!0,layout:{type:'vbox',pack:'center',align:'center'},flex:1,cls:'blank-page-container'});Ext.define('IM.view.rightContainer.ChatFav',{extend:'Ext.Container',xtype:'chatFav',layout:{type:'vbox',pack:'center',align:'center'},cls:'chat-fav-container',html:'<h1 class="chat-fav-blank">会话收藏</h1>',initialize:function(){var a=this;a.callParent(arguments);window.clickFavInput=function(a){var b=a.getAttribute('cid');ChatHelper.openChat(b)}}});Ext.define('IM.view.rightContainer.CrowdFav',{extend:'Ext.Container',xtype:'crowdFav',layout:{type:'vbox',pack:'center',align:'center'},cls:'chat-fav-container',html:'<h1 class="chat-fav-blank">群会话</h1>',initialize:function(){var a=this;a.callParent(arguments);window.clickInput=function(b){var c=b.getAttribute('cid');var a=User.record_crowd;Utils.custAjax('get','chatcs/'+c,{success:function(c){LocalDataMgr.saveCrowdInfo(c,function(){ChatHelper.openCrowd(a)})},failure:function(){}})}}});Ext.define('IM.view.rightContainer.fav.ChatFavView',{extend:'Ext.Container',xtype:'chatFavView',reference:'chatFavView',requires:['IM.view.rightContainer.fav.ChatFavList'],defaultListenerScope:!0,cls:'chatFavView',layout:'vbox',items:[{xtype:'component',html:'<div class="chatFavView_display">收藏</div>'},{xtype:'button',text:'排序',handler:'sortList'},{xtype:'chatFavList',itemId:'chatFavList',flex:1}],sortList:function(b){var h=b.getText(),a=this.down('#chatFavList'),g=a.getStore();if(h=='排序'){b.setText('完成');a.removeCls('hideListDrag')}else {var d=g.getData(),e=d.length;if(e>0){var f=[];for(var c=0;c<e;c++){var i=d.getAt(c);f.push({fav_index:c+1,chat_id:i.get('chat_id'),user_id:User.ownerID})}Utils.custAjax('post','chatfavorite/rank',{params:JSON.stringify(f),success:function(c){if(c){for(var a=0;a<e;a++){d.getAt(a).set('fav_index',a+1)}}},callback:function(){b.setText('排序');a.addCls('hideListDrag')}})}else {b.setText('排序');a.addCls('hideListDrag')}}}});Ext.define('IM.view.leftTab.workDesk.WorkDeskDetails',{extend:'Ext.Container',xtype:'workdeskdetails',controller:'workdeskpccontroller',viewModel:{},cls:'pcworkdetail',layout:'vbox',requires:['Ext.tab.Panel','Ext.layout.overflow.Scroller'],profiles:{defaults:{buttonShadow:!0,cls:'demo-solid-background',shadow:!0}},shadow:!1,autoSize:!0,items:[{xtype:'tabpanel',reference:'tabpanel',itemId:'iframtab',shadow:'true',tabBar:{layout:{pack:'start',overflow:'scroller'}},defaults:{tab:{minWidth:100}},flex:1,items:[{closable:!1,title:'工作台',iconCls:'x-fa fa-laptop',xtype:'deskmain',bind:{datas:'{datas}'},groupProperty:'GroupID',groupName:'GroupName'}]}],initialize:function(){var a=this;a.callParent(arguments);new Ext.drag.Source({xclass:'Ext.drag.Source',element:a.getRenderTarget(),handle:'.deskmain .gridlayoutitem',listeners:{dragstart:'onDragstart',dragend:'onDragend',scope:a.getController()},proxy:{type:'placeholder',cls:'deskmain'}});new Ext.drag.Source({xclass:'Ext.drag.Source',element:a.getRenderTarget(),handle:'.x-tab.x-button',listeners:{dragstart:'onDragstartByTab',dragend:'onDragend',scope:a.getController()},proxy:{type:'placeholder',cls:'pcworkdetail'}});a.el.on({scope:a.getController(),delegate:'.x-tab.x-button',dblclick:'openCEFbyTab'})}});Ext.define('IM.view.leftTab.workDesk.WorkDesk',{extend:'Ext.List',xtype:'workdesk',controller:'workdeskpccontroller',viewModel:{},cls:'pcwork',layout:'vbox',title:'工作台',grouped:!0,deselectable:!1,groupHeader:{tpl:'{name}'},store:{storeId:'workDes',grouper:{property:'GroupID',groupFn:function(a){return a.data.GroupName}},remoteSort:!0},itemTpl:'<div class="div-ct" style="margin-left: 10px;padding: 7px 0px 7px 0px;">\n    <tpl if="Ext.String.startsWith(values.ModuleIcon, \'<svg\', true)">\n    <div class="x-layout-box x-align-center x-pack-center div-icon">{ModuleIcon}</div>\n    <tpl else>\n    <div class="div-icon {ModuleIcon}"></div>\n    </tpl>\n    <div class="div-txt">{ModuleName}</div>\n    </div>',listeners:{childsingletap:'toPCItemPage',childdoubletap:'cefWorkDesk'},initialize:function(){var a=this;a.callParent(arguments);User.pcFirstInto=!0;var b=new Ext.drag.Source({xclass:'Ext.drag.Source',element:a.getRenderTarget(),handle:'.x-listitem',listeners:{dragstart:'onDragstart',dragend:'onDragend',scope:a.getController()},proxy:{type:'placeholder',cls:'pcwork'}})}});Ext.define('IM.view.rightContainer.ReplyFav',{extend:'Ext.Container',xtype:'replyfav',viewModel:{data:{theme:'系统消息',cid:''}},layout:{type:'vbox',pack:'center',align:'center'},cls:'chat-fav-container',bind:{html:'<div class="chat-fav-text">{theme}</div>\n        <div><input class="chat-fav-button" type="button" value="{theme}" cid = "{cid}" onclick="clickReplys(this)" /></div>'},initialize:function(){var a=this;a.callParent(arguments);window.clickReplys=function(b){var a=b.getAttribute('cid');if(a==StaticChatID.News){ChatHelper.openNews(a)}else {if(a=='eeeeeeeebbbbbbbbbfffffffff'){ChatHelper.openMsgReply(a)}}}}});Ext.define('IM.view.IM',{extend:'Ext.Container',xtype:'IM',reference:'IM',controller:'IM',requires:['IM.view.IMController','IM.view.leftTab.organization.Organization','IM.view.leftTab.recentChat.RecentChat','IM.view.leftTab.favorite.FavList','IM.model.viewModel.IMMainBind','Ext.form.FieldSet','Ext.field.Search','Ext.tab.Panel','Ext.panel.Resizer','IM.view.leftTool.leftTool','IM.view.middlePanel.MiddlePanel','IM.plugin.DraggableHandle','IM.view.rightContainer.IMMainView','IM.view.rightContainer.Details','IM.view.rightContainer.BlankPage','IM.view.rightContainer.ChatFav','IM.view.rightContainer.CrowdFav','IM.view.rightContainer.fav.ChatFavView','IMCommon.local.LocalDataMgr','IMCommon.enumType.ChatType','IMCommon.enumType.MsgType','IMCommon.enumType.MsgWrapperType','IMCommon.enumType.NoticeType','IMCommon.enumType.SocketEventType','IMCommon.enumType.SearchType','IMCommon.utils.ImgMgr','IMCommon.utils.DesktopPageCache','IM.view.leftTab.workDesk.WorkDeskDetails','IM.view.leftTab.workDesk.WorkDesk','IM.view.rightContainer.ReplyFav'],uses:['IM.view.editPanel.FirstAdvSearchP','IMCommon.view.search.SearchField'],viewModel:{type:'mainBind'},layout:'hbox',items:[{xtype:'leftTool'},{xtype:'midPanel',itemId:'middleView',minWidth:242,maxWidth:'calc(100vw - 180px)',width:242},{xtype:'container',flex:1,itemId:'rightView',layout:'vbox',items:[{xtype:'container',reference:'cefMainTitle',userCls:'top-box',layout:'hbox',bind:{hidden:'{isHideBrowseTitle}'},height:25,items:[{xtype:'component',cls:'imitateBrowse',flex:1,plugins:'draggablehandle'},{xtype:'button',ui:'cef',iconCls:'im-common-minimize',handler:'cefMin'},{xtype:'button',ui:'cef',itemId:'cefMainMax',iconCls:'im-common-maximize',handler:'cefMax'},{xtype:'button',ui:'cefClose',iconCls:'im-common-close',handler:'cefClose'}]},{xtype:'container',flex:1,reference:'firstTabRight',layout:'fit',items:[{xtype:'pageblank',reference:'pageblank',hidden:!1},{xtype:'im-main',reference:'im-main',hidden:!0},{xtype:'msgreplay',reference:'msgreplay',hidden:!0},{xtype:'newsview',reference:'newsview',hidden:!0}]},{xtype:'container',reference:'secondTabRight',hidden:!0,flex:1,layout:'fit',items:[{xtype:'chatFav'},{xtype:'replyfav',hidden:!0},{xtype:'details',reference:'details',hidden:!0},{xtype:'crowdFav',hidden:!0}]}]}],initialize:function(){var a=this;a.callParent(arguments);a.on({resize:'onIMResize',scope:a.getController()})}});Ext.define('IM.view.editPanel.FirstAdvSearchPController',{extend:'Ext.app.ViewController',alias:'controller.firstadvsearchpcontroller',init:function(){},onfspListSel:function(b,g,i){var h=this.getView();var a=g.data;if(a.hasNoData){return}if(a.hasUser||a.hasChat){if(a.hasMoreUser){var f=Ext.getStore('editP_fsp_user');b.setStore(f)}else {if(a.hasMoreChat){var e=Ext.getStore('editP_fsp_chat');b.setStore(e)}else {return}}}else {if(a.hasBack){var d=Ext.getStore('editP_fsp_multi');b.setStore(d)}else {if(a.UserName){ChatHelper.onOpenDirectChat(a.UserID)}else {if(a.ChatType==ChatType.Multi){Utils.custAjax('get','users/me/chats/'+a.ChatID,{success:function(c){if(c.chat_type==ChatType.Multi){ChatHelper.openChat(a.ChatID)}else {var d=ParseUtil.getLocalTime(!0);LocalDataMgr.updateCrowdtoGroup(c,d);Utils.custAjax('get','chatcs/'+a.ChatID,{success:function(d){LocalDataMgr.saveCrowdInfo(d,function(){ChatHelper.openChat(a.ChatID)})},failure:function(){}})}},failure:function(){}})}else {if(a.ChatType=='C'){Utils.custAjax('get','users/me/chats/'+a.ChatID,{success:function(d){var c=ParseUtil.getLocalTime(!0);LocalDataMgr.updateCrowdtoGroup(d,c);Utils.custAjax('get','chatcs/'+a.ChatID,{success:function(c){LocalDataMgr.saveCrowdInfo(c,function(){ChatHelper.openChat(a.ChatID)})},failure:function(){}})},failure:function(){}})}}}h.hide();var c=ViewGet.getIMView().lookup('midpanel_searchfield');if(c){c.setValue('')}}}}});Ext.define('IM.view.editPanel.FirstAdvSearchP',{extend:'IMCommon.view.panel.hidePanel',xtype:'firstAdvSearchP',controller:'firstadvsearchpcontroller',requires:['IM.view.editPanel.FirstAdvSearchPController'],floated:!0,width:300,scrollable:'y',layout:'fit',bodypadding:5,cls:'editP_fsp',items:[{xtype:'list',itemId:'editP_fsp_list',userSelectable:!1,emptyText:'无相关搜索内容',listeners:{select:'onfspListSel'}}],itemTpl1:'\n    <tpl if="values.hasNoData">\n        <div class="editP_fsp_nodata">无相关搜索内容</div>\n    <tpl else>\n        <tpl if="values.hasUser||values.hasChat">\n            <tpl if="values.hasUser">\n                <div class="editP_fsp_user_title">\n                    <tpl if="values.hasMoreUser">\n                        <div class="editP_fsp_more">显示更多</div>\n                    </tpl>\n                    <div>用户</div>\n                </div>\n            </tpl>\n            <tpl if="values.hasChat">\n                <div class="editP_fsp_title">\n                    <tpl if="values.hasMoreChat">\n                        <div class="editP_fsp_more">显示更多</div>\n                    </tpl>\n                    <div>会话</div>\n                </div>\n            </tpl>\n        <tpl elseif="values.hasBack">\n        <div class="editP_fsp_more">收起</div>\n            <div>{[values.hasUserBack?\'用户\':\'会话\']}</div>\n        <tpl else>\n            <tpl if="values.UserName">\n                <div style="float: left;">\n                {[AvatarMgr.getUserAvaHtml(values.UserID, values.AvatarHash)]}\n                </div>\n                <div class="inOneline">{UserName}({UserID})</div>\n                <div class="inOneline" style="margin-top:4px;font-size: 12px;color:#b4b4b4;">\n                    <tpl if="values.Mobile">手机：{Mobile}</tpl>\n                </div>\n            <tpl else>\n                <div style="float: left;">\n                <tpl if="values.ChatType == \'G\'">\n                {[AvatarMgr.getChatAvaHtml(values.ChatID, values.CreateAt, values.AvatarHash)]}\n                <tpl elseif="values.ChatType == \'C\'">\n                {[AvatarMgr.getCrowdAvaHtml(values.ChatID, values.CreateAt, values.AvatarHash)]}\n                <tpl elseif="values.ChatType == \'News\'">\n                    <a class="avatar link-avatar firstletter loaded">\n                    <img src="'+Ext.getResourcePath('images/xiaoxi.png',null,null)+'">\n                    </a>\n                </tpl>\n                </div>\n                <div>\n                <div class="inOneline">{DisplayName}</div>\n                <tpl if="values.SenderName">\n                <div class="editP_fsp_content inOneline">包含：{SenderName}</div>\n                </tpl>\n                </div>\n            </tpl>\n        </tpl>\n    </tpl>\n    ',itemTpl2:'\n        <tpl if="values.hasBack">\n        <div>用户</div>\n        <div class="editP_fsp_more">收起</div>\n        <tpl else>\n        <div style="float: left;">\n                {[AvatarMgr.getUserAvaHtml(values.UserID, values.AvatarHash)]}\n                </div>\n                <div class="inOneline">{UserName}({UserID})</div>\n                <div class="inOneline" style="margin-top:4px;font-size: 12px;color:#b4b4b4;">\n                    <tpl if="values.Mobile">手机：{Mobile}</tpl>\n                </div>\n        </tpl>\n    ',itemTpl3:'\n        <tpl if="values.hasBack">\n            <div>会话</div>\n            <div class="editP_fsp_more">收起</div>\n        <tpl else>\n        <div style="float: left;">\n        <tpl if="values.ChatType == \'G\'">\n        {[AvatarMgr.getChatAvaHtml(values.ChatID, values.CreateAt, values.AvatarHash)]}\n        <tpl elseif="values.ChatType == \'C\'">\n        {[AvatarMgr.getCrowdAvaHtml(values.ChatID, values.CreateAt, values.AvatarHash)]}\n        </tpl>\n        </div>\n        <div>\n        <div class="inOneline">{DisplayName}</div>\n        <tpl if="values.SenderName">\n        <div class="inOneline">包含：{SenderName}</div>\n        </tpl>\n        </tpl>\n    '});Ext.define('IM.view.editPanel.SecAdvSearchPController',{extend:'Ext.app.ViewController',alias:'controller.secadvsearchpcontroller',init:function(){},onSecfspSel:function(g,e){var f=e.get('UserID');var a=ViewGet.getSecOrgView();var d=ViewGet.getSecOrgStore();a.expandAll();var b=d.findRecord('uid',f,!1,!1,!0);if(b){if(a.getHidden()){ChatHelper.showSecMid('secTabOrg','secFavEdit')}a.ensureVisible(b,{align:{y:'start'}});a.setSelection(b);a.getController().saveReordToCache(b);a.getController().setOrgHtml(b);ChatHelper.showSecRight('details','chatFav','replyfav','crowdFav')}var c=ViewGet.getIMView().lookup('midpanel_searchfield');if(c){c.setValue('')}this.getView().hide()}});Ext.define('IM.view.editPanel.SecAdvSearchP',{extend:'IMCommon.view.panel.hidePanel',xtype:'secAdvSearchP',controller:'secadvsearchpcontroller',requires:['IM.view.editPanel.SecAdvSearchPController'],floated:!0,width:185,maxHeight:200,scrollable:'y',bodypadding:5,layout:'fit',cls:'editP_sec_fsp',items:[{xtype:'list',itemId:'editP_sec_fsp',store:{storeId:'editP_sec_fsp_s'},listeners:{select:'onSecfspSel'},itemTpl:'\n            <div style="float:left">\n            {[AvatarMgr.getUserAvaHtml(values.UserID, values.AvatarHash, true)]} \n            </div>\n            <div>{UserName}</div>\n        '}]});Ext.define('IM.view.leftTab.setting.setting',{extend:'Ext.Container',xtype:'setting',layout:{type:'vbox',align:'center',pack:'center'},html:'暂无内容',items:[]});Ext.define('IM.view.leftTab.workDesk.DeskMain',{extend:'Ext.Container',xtype:'deskmain',cls:'deskmain',config:{datas:[],groupProperty:'',groupName:'',groupId2Name:[],groupDic:[],openModule:null},viewModel:{},referenceHolder:!0,items:[{xtype:'container',height:'100%',reference:'mmask',cls:'mask',html:'<div class="loading-icon"></div><div>请稍等...</div>'}],btn:{xtype:'button',reference:'refreshBtn',iconCls:'x-fa fa-refresh',cls:'refresh-btn',handler:'onRefresh'},updateDatas:function(a){if(!a||a.length===0){return}var b=this.lookup('mmask');if(b){b.destroy()}this.initer();this.groupFn(a);this.createItems();this.badgeManager();this.insert(0,Ext.create(this.btn));if(this.firstIntoMail){ViewGet.getIMView().getController().intoWorkDesk();this.firstIntoMail=!1}},updateOpenModule:function(a){if(a){var b=this;b.setOpenModule(!1);ViewGet.getIMView().getController().intoWorkDesk()}},initer:function(){this.setGroupId2Name([]);this.setGroupDic([]);this.removeAll()},groupFn:function(f){var a=this,e=a.getGroupProperty(),d=a.getGroupName(),c=a.getGroupId2Name(),b=a.getGroupDic();f.forEach(function(g){var h=g[e],a=c[h];if(!a){c[h]=a=g[d]}var i=b[a];if(!i){b[a]=[]}b[a].push(g)});a.setGroupId2Name(c);a.setGroupDic(b)},createItems:function(){var a=this;var b=a.getGroupId2Name(),e=a.getGroupDic();var g=a.createAnchorBtns(b);a.add(g);var d=Ext.create({xtype:'container',reference:'content',cls:'content',scrollable:!0});d.getScrollable().on({scroll:'onChgScroll',scope:a});a.add(d);for(var f in b){var c=b[f];var h=a.createHeaderItems(f,c,e[c].length),i=a.createDataViewItems(e[c]);a.lookup('content').add(h);a.lookup('content').add(i)}},createAnchorBtns:function(b){var a=Ext.create({xtype:'segmentedbutton',reference:'anchorTool',cls:'anchor-item'});for(var c in b){a.add({text:b[c],value:c})}a.innerItems[0].setPressed(!0);a.on({toggle:'scrollToAnchor'});return a},createHeaderItems:function(c,a,d){var b=Ext.create({xtype:'container',cls:'x-item-header',html:'<div class="prefix-icon" id="'+c+'"></div>'+a+'<span>('+d+')</span>'});return b},createDataViewItems:function(a){var b=Ext.create({xtype:'deskgridlayout',datas:a});return b},initialize:function(){var a=this;a.callParent(arguments)},onChgScroll:function(i,j,e,f,g,h){var b=this,a=b.lookup('anchorTool');if(a.tapAnchor){a.tapAnchor=!1;return}if(!b.anchorArr){b.calculatePos()}var c=null;for(var d in b.anchorArr){if(b.anchorArr[d]<=e){c=d}}a.chgByScroll=!0;a.valueMap[c].setPressed(!0);a.chgByScroll=!1},calculatePos:function(){var b=this,e=b.getGroupId2Name();b.anchorArr=[];for(var d in e){var a=Ext.query('#'+d);if(a&&a.length>0){a=a[0];var c=a.getBoundingClientRect().y,f=c-150>0?c-150:0;b.anchorArr[d]=f}}},badgeManager:function(){var e=this,d=e.getViewModel(),b=d.getData();if(Object.keys(b).length>0){for(var a in b){var f=d.getData()[a];if(a.startsWith('module_')){a=a.replace('module_','');var c=Ext.getStore(a);if(c){c.data.items[0].set('badge',f)}}}}}});Ext.define('IM.view.leftTab.workDesk.GridLayout',{extend:'Ext.Container',requires:[],xtype:'deskgridlayout',cls:'desk-gridlayout',config:{w:130,h:130,gapCol:10,gapRow:10,datas:null,defaultType:'gridlayoutitem'},updateDatas:function(b){var e=this;if(!b||b.length==0){return}for(var c=0;c<b.length;c++){var a=b[c],d=e.adaptSize(a.SizeType);var f=Ext.create({xtype:'gridlayoutitem',columnWeight:d.cw,rowWeight:d.rw,bgColor:a.BgColor,foreColor:a.ForeColor,iconColor:a.IconColor,data:a});e.add(f)}},adaptSize:function(a){if(!a){a='M'}a=a.toLocaleUpperCase();var b={};switch(a){case 'B':case 'W':b={cw:2,rw:1};break;case 'S':case 'M':default:b={cw:1,rw:1};break;}return b},initialize:function(){var a=this;a.callParent(arguments);a.bodyElement.setStyle({'display':'grid','grid-auto-flow':'row dense',gridTemplateColumns:'repeat(5, '+a.getW()+'px)',gridTemplateRows:'repeat(1, '+a.getH()+'px)',gridAutoRows:a.getH()+'px',gridRowGap:a.getGapCol()+'px',gridColumnGap:a.getGapRow()+'px'})}});Ext.define('IM.view.leftTab.workDesk.GridLayoutItem',{extend:'Ext.Container',xtype:'gridlayoutitem',cls:'gridlayoutitem',config:{columnWeight:1,rowWeight:1,bgColor:'#f2f3f7',foreColor:'#c5e7ff',iconColor:'#0092fa',data:null},updateColumnWeight:function(a){this.setColumnWeight(a)},updateRowWeight:function(a){this.setRowWeight(a)},updateBgColor:function(a){if(a){this.setBgColor(a)}},updateForeColor:function(a){if(a){this.setForeColor(a)}},updateIconColor:function(a){if(a){this.setIconColor(a)}},updateData:function(c){var a=this;if(c){a.el.setStyle({'grid-column':'span '+a.getColumnWeight(),'grid-row':'span '+a.getRowWeight(),'background-color':a.getBgColor()||'#f2f3f7'});var g=a.getIconColor()||'#0092fa',f=a.getForeColor()||'#c5e7ff';var b=Ext.create({xtype:'dataview',cls:'group-dataview',reference:c.ModuleID,itemTpl:'<div class="div-ct {ModuleID}">\n                <tpl if="Ext.String.startsWith(values.ModuleIcon, \'<svg\', true)">\n                <div class="x-layout-box x-align-center x-pack-center div-icon">{ModuleIcon}</div>\n                <tpl else>\n                <div class="div-icon {ModuleIcon}" style="color:'+g+'"></div>\n                </tpl>\n                <div class="div-txt">{ModuleName}</div>\n                <tpl if="values.badge &gt; 0">\n                <div class="div-unread"><span>{badge}</span> 封未读</div>\n                </tpl>\n                </div>\n                <div class="div-content {SizeType}">\n                <tpl if="Ext.String.startsWith(values.ModuleIcon, \'<svg\', true)">\n                <div class="x-layout-box x-align-center x-pack-center div-icon">{ModuleIcon}</div>\n                <tpl else>\n                <div class="div-icon {ModuleIcon}" style="color:'+f+'"></div>\n                </tpl>\n                </div>\n                ',listeners:{childsingletap:'toPCItemPage',childdoubletap:'cefWorkDesk'}});var d=b.getStore();if(!d){d=Ext.factory({storeId:c.ModuleID},Ext.data.Store);b.setStore(d)}b.getStore().add(c);var e=b.el.query('svg');if(e.length==2){e[0].style.fill=g;e[1].style.fill=f}a.add(b)}}});Ext.define('IM.view.leftTab.workDesk.WorkDeskPcController',{extend:'Ext.app.ViewController',alias:'controller.workdeskpccontroller',toPCItemPage:function(i,a){var g=this.getView(),j=g.getViewModel();if(a.record){var b=a.record.data.ModuleID;var c=a.record.data.ModuleName;var h=a.record.data.AppDir;var e=User.accURL.split('/');e[e.length-1]=h+'#'+b;var d=e.join('/');if(a.record.data.suffix){d=d+a.record.data.suffix;a.record.set({suffix:''})}var f='<iframe id="frameAIO7" module_id = "'+b+'" frameborder="0" class="iframe" src="'+d+'" style="width:100%;height:100%" ></iframe>';cefMain.popupWorkDesk(!1,c,b,d,function(l){if(l=='true'){if(Ext.Viewport.down('#iframtab').innerItems.length==0){var g=c;var h='';Ext.Viewport.down('#iframtab').add({closable:!0,title:g,html:h,moduleID:b});Ext.Viewport.down('#iframtab').innerItems[0].setHtml(f);Ext.Viewport.down('#iframtab').innerItems[0].title=c;var j='canClosed res-'+a.record.data.GroupID+'-'+b;Ext.Viewport.down('#iframtab')._tabBar._activeTab.addCls(j)}else {var d=Ext.Viewport.down('#iframtab').innerItems;var k=!0;for(var e=0;e<d.length;e++){if(c==d[e].title){console.log('此tab已存在');Ext.Viewport.down('#iframtab').setActiveItemIndex(e);k=!1;break}}if(k){var g=c;var h='';Ext.Viewport.down('#iframtab').add({closable:!0,title:g,html:h,moduleID:b});Ext.Viewport.down('#iframtab').setActiveItemIndex(d.length-1);Ext.Viewport.down('#iframtab').innerItems[d.length-1].setHtml(f);Ext.Viewport.down('#iframtab').innerItems[d.length-1].title=c;var j='canClosed res-'+a.record.data.GroupID+'-'+b;Ext.Viewport.down('#iframtab')._tabBar._activeTab.addCls(j)}}}else {Ext.Viewport.down('#iframtab').setActiveItemIndex(0)}})}},cefWorkDesk:function(b,a){if(a.record){var d=a.record.data.ModuleID;var c=a.record.data.ModuleName;var e=this.initUrl(b,a.record);var f=this.tabHaspanel(b,a.record);cefMain.popupWorkDesk(!0,c,d,e,function(){})}},neededParams:function(f){if(!f){return}var a=[];var d=f.className,g=d.indexOf('res');if(g<0){return}var h=d.substring(g).split(' ')[0],b=h.split('-');var e=Ext.getStore(b[2]);if(e){var i=e.findRecord('ModuleID',b[2]);var j=ViewGet.getIMView().getController(),c=[];c.record=i;a.view=j;a.location=c;return a}},openCEFbyTab:function(b){var a=this.neededParams(b.currentTarget);this.cefWorkDesk(a.view,a.location)},onDragstartByTab:function(c,f,d){var b=d.currentTarget,a=this.neededParams(b);if(!a||!a.location.record){return}var e=b.offsetWidth,g=b.offsetHeight;f.record=a.location.record;c.getProxy().setHtml('<div draggable="true" style="text-align:center;font-size:16px;width:'+e+'px;height:23px;line-height:23px;background:#eaeaea;opacity:0.8;">'+a.location.record.data.ModuleName+'</div>')},onDragstart:function(d,i,g){var j=Ext.fly(g.delegatedTarget),c=j.query('.div-ct');var e=c[0].classList[1];var b=Ext.getStore(e);if(!b){return}var a=c[0],h=a.offsetWidth,f=a.offsetHeight;i.record=b.getAt(0);d.getProxy().setHtml('<div draggable="true" style="font-size:13px;width:'+h+'px;height:'+f+'px;background:#eaeaea;opacity:0.8;">'+a.outerHTML+'</div>')},onDragend:function(e,a,g){if(!a.record){return}var c=a.record.data.ModuleID;var b=a.record.data.ModuleName;var d=this.initUrl(this.getView(),a.record);var f=this.tabHaspanel(this.getView(),a.record);cefMain.popupWorkDesk(!0,b,c,d,function(){})},initUrl:function(f,a){var e=a.data.ModuleID,g=a.data.ModuleName,d=a.data.AppDir;var b=User.accURL.split('/'),c;b[b.length-1]='AIOMobile/AIOHomePage2.aspx?';c=b.join('/');c+='userid='+Utils.toHex(User.ownerID)+'&session='+Utils.toHex(f.session)+'&path='+Utils.toHex(d+'#'+e);return c},tabHaspanel:function(g,d){var f=d.data.ModuleID;var e=d.data.ModuleName;var b=Ext.Viewport.down('#iframtab').innerItems;var c=!0;Ext.Viewport.down('#iframtab').setActiveItemIndex(0);for(var a=0;a<b.length;a++){if(e==b[a].title){console.log('此tab已存在');Ext.Viewport.down('#iframtab').remove(Ext.Viewport.down('#iframtab').innerItems[a]);c=!1;break}}return c},onRefresh:function(){ChatUtil.getWorkDeskBadges(function(){ViewGet.getIMView().getController().onActivate()})},scrollToAnchor:function(a){if(a.chgByScroll){return}if(!a.sameFlag){a.sameFlag=!0;a.tapAnchor=!0;var i=this.getView(),b=i.down('deskmain'),f=b.lookup('content'),c=f.getScrollable(),g=c._scrollElement.dom,h=g.scrollTop;if(!b.anchorArr){b.calculatePos()}if(!c){return}var j=a.getValue(),e=Ext.query('#'+j)[0],d=e?e.getBoundingClientRect().y+h:0;var k=d-100>0?d-100:0;c.scrollTo(0,k)}else {a.sameFlag=!1}}});Ext.define('IM.view.middlePanel.SecContainer',{extend:'Ext.Container',xtype:'secContainer',requires:['IM.view.leftTab.organization.Organization'],defaultListenerScope:!0,layout:'vbox',items:[{xtype:'button',text:'收藏',handler:'onTapFavBtn'},{xtype:'container',layout:'vbox',flex:1,items:[{xtype:'button',text:'组织',iconCls:'x-fa fa-caret-down',handler:'onTapOrgBtn'},{xtype:'left-organization',flex:1,itemId:'realOrgView'}]}],onTapFavBtn:function(a){ChatHelper.showRightView('chatFavView','details')},onTapOrgBtn:function(a){var c=a.getIconCls();var b=this.down('#realOrgView');if(c=='x-fa fa-caret-down'){a.setIconCls('x-fa fa-caret-right');b.hide()}else {a.setIconCls('x-fa fa-caret-down');b.show()}}});Ext.define('IM.view.rightContainer.NewsViewController',{extend:'Ext.app.ViewController',alias:'controller.news-view',onBtnZoom:function(){var e=this,d=e.getView(),a=d.getViewModel(),b=a.getData().editViewStatus,c=b===0?1:0;a.setData({editViewStatus:c})},onHelp:function(){var b=this.getView(),a=[];a.push({type:'T',value:'Helper'});SendUtil.sendNewsCommand(User.crtChannelId,a,Ext.getStore('comRct'),b.down('newsviewlist'))},onBtnSend:function(){var a=this.getView();var b=a.down('imCommonEditor');SendUtil.sendMsg(b,User.crtChannelId,Ext.getStore('comRct'),a.down('newsviewlist'))}});Ext.define('IM.view.rightContainer.NewsView',{extend:'Ext.Container',xtype:'newsview',controller:'news-view',requires:['IM.view.rightContainer.NewsViewController'],cls:'right_panel news-contain',layout:'vbox',viewModel:{data:{editViewStatus:1}},items:[{xtype:'container',layout:'hbox',userCls:'right-title',items:[{xtype:'container',html:'<div class="ditChatHeaderText"><span class="dittext">消息中心</span></div>'}]},{xtype:'newsviewlist',flex:1,style:{borderBottom:'1px solid #d6d6d6'}},{xtype:'panel',resizable:{edges:'n'},minHeight:30,maxHeight:30,height:30,layout:'vbox',bind:{hidden:'{editViewStatus == 0}'},items:[{xtype:'container',userCls:'zoom',layout:'hbox',items:[{xtype:'button',iconCls:'x-fa fa-outdent',handler:'onBtnZoom'},{html:'帮助',cls:'helper',flex:1,listeners:{click:{element:'element',fn:'onHelp'}}}]}]},{xtype:'panel',resizable:{edges:'n'},minHeight:120,maxHeight:'70%',height:180,layout:'vbox',bind:{hidden:'{editViewStatus == 1}'},items:[{xtype:'chatInput',userCls:'editor-Ct',flex:1},{xtype:'container',userCls:'bottomSend',layout:'hbox',items:[{xtype:'container',userCls:'zoom',flex:1,items:[{xtype:'button',iconCls:'x-fa fa-outdent',handler:'onBtnZoom'}]},{xtype:'button',itemId:'sendBtn',text:'发送(<span class="sUnderline">S</span>)',ui:'send-ui',width:66,height:24,handler:'onBtnSend'}]}]}],initialize:function(){var a=this;a.callParent(arguments);a.down('chatInput').innerItems[0].hide()}});Ext.define('IM.view.rightContainer.NewsViewList',{extend:'Ext.List',xtype:'newsviewlist',classCls:'msg-list',itemsFocusable:!1,selectable:!1,scrollable:!0,disableSelection:!0,store:{},itemTpl:'<tpl if="values.showTime">'+'<div class="msgTime">{[ParseUtil.handleMsgShowTime(values.updateTime)]}</div>'+'</tpl>'+'<tpl if="values.isText == \'N\'">'+'<div class="content">'+'<div class="news-card">'+'<div class="news-title">'+'{title}'+'</div>'+'<div class="news-pic">'+'{[ImgMgr.parseNewsPic(values)]}'+' '+'</div>'+'<div class="news-desc">'+'{desc}'+'</div>'+'</div>'+'</div>'+'<tpl elseif="creatorID == User.ownerID">'+'<div class="wrapAB wrapABR" style="text-align:right;float:right">'+'<div class="bubble mine">'+'<div class="plain">'+'<tpl if="values.sendStatus==2">'+'<div class="loadgif mineStu"></div>'+'<tpl elseif="values.sendStatus==1">'+'<div class="sendfail mineStu"></div>'+'</tpl>'+'{[ParseUtil.textToHtml(values.desc)]}'+'</div>'+'</div>'+'</div>'+'<tpl else>'+'<div class="wrapAB wrapABL" style="text-align:left;float:left">'+'<div class="evAvatar">'+'<span class="evAvatarDetail">消息中心</span>'+'</div>'+'<div class="bubble others">'+'<div class="plain">'+'{[ParseUtil.textToHtml(values.desc)]}'+'</div>'+'</div>'+'</div>'+'</tpl>',initialize:function(){var a=this;a.callParent(arguments);a.on({scope:a,childtap:'clickNewsCard'});a.getScrollable().on({scroll:'onChgScrol',scope:a})},clickNewsCard:function(i,a){var g=a.sourceElement,h=Ext.fly(g);if(h.findParent('.news-card')){var b=User.accURL.split('/');b.pop();var c=b.join('/'),e=Utils.toHex(a.record.data.newsID),f=Utils.toHex(User.ownerID),d=c+'/News/NewsHtml.ashx?news_id='+e+'&user_id='+f;cefMain.openBrowser(d,a.record.data.title)}},onChgScrol:function(i,n,k,l,m){if(k===0){var d=this;var b=d.getStore();var a=b.getAt(0);if(!a){return}var j=a.get('updateTime'),c=a.get('newsSeq');if(c<=10000){return}LocalDataMgr.getLocalNews(j,20,function(r,q){var f=q.rows,h=[];if(f.length>0){for(var g=f.length-1;g>=0;g--){var e=f.item(g),j=!0;if(g<f.length-1){if(ParseUtil.inOneMinute(f.item(g+1).CreateAt,e.CreateAt)){j=!1}}h.push({showTime:j,updateTime:e.CreateAt,newsSeq:e.NewsSeq,newsID:e.NewsID,newsType:e.NewsType,title:e.Title,desc:e.Description,picUrl:e.PicUrl,desUrl:e.DesCUrl,isText:e.IsText,extras:e.Extras,creatorID:e.CreatorID})}var o=ParseUtil.judgeNewsSlice(f,c);if(o.length>0){ChatUtil.getMissNewsFromServer(o,function(e){var c=h.concat(e);c=ParseUtil.sortHistory(c);b.insert(0,c);d.ensureVisible(a,{align:{y:'start'}})})}else {b.insert(0,h);d.ensureVisible(a,{align:{y:'start'}})}}else {var p=[{from_seq:c-20,to_seq:c}];ChatUtil.getMissNewsFromServer(p,function(c){if(c.length===0){return}b.insert(0,c);d.ensureVisible(a,{align:{y:'start'}})})}})}if(window.cefMain){var e=i.getScrollElement().dom,g=e.scrollHeight,h=e.scrollTop,f=e.offsetHeight;if(g<=Math.ceil(h+f)){ChatUtil.viewNews()}}}});Ext.define('IM.view.rightContainer.msgReplayList',{extend:'Ext.Container',xtype:'msgreplaylist',viewModel:{},layout:'vbox',uses:['IM.view.widget.MrdDatePanel'],cls:'right_panel',items:[{xtype:'list',itemTpl:'<div class="reply_msg" style="border-bottom: solid 1px #cfcfcf;">'+'<a class="avatar link-avatar firstletter loaded " style="float:left;">{avaImg}</a>'+'<div class="reply_uname inOneline">{uname}</div>'+'<div class="reply_content">{content}</div>'+'</div>',data:[{uname:'Demon',avaImg:'',content:'I miss you'}]},{xtype:'list',itemTpl:'\n                    <a class="avatar link-avatar firstletter loaded " style="float:left;">\n                        <img src="{[AvatarMgr.getNavUserAvaUrlWOCache(values.UserID, 0)]}" onerror="AvatarMgr.doUserAvaErr(this)" ava-id="{UserID}">\n                    </a>\n                    <div>\n                        <div class="reply_uname inOneline">{UserName}</div>\n                        <div class="reply_bubble">\n                            <div class="reply_plain">{[ParseUtil.parseTextToHtml(values.Content)]}</div>\n                        </div>\n                    </div>\n                ',data:[{UserName:'Demon',UserID:'',content:'I miss you'},{UserName:'Demon',UserID:'',content:'I miss you'},{UserName:'Demon',UserID:'',content:'I miss you'},{UserName:'Demon',UserID:'',content:'I miss you'}]},{xtype:'replyEditor',reference:'reply_editor',style:'height: 50px; border-top: solid 1px #cfcfcf;'},{layout:'hbox',userCls:'desktop_reply_send',items:[{xtype:'button',iconCls:'im-common-smile',ui:'flat',handler:'showEmjPanel'},{xtype:'component',flex:1},{xtype:'button',text:'回复(<span style="text-decoration: underline;">S</span>)',ui:'send-ui',width:66,height:24,handler:'onSendReply'}]}]});Ext.define('IM.view.rightContainer.msgallReplayController',{extend:'Ext.app.ViewController',alias:'controller.msgallreplycontroller',onSendMsgReply:function(a,c){var b=this.getView();cid=a.parent.parent.innerItems[0].getData()[0].ChatID,msgid=a.parent.parent.innerItems[0].getData()[0].RootID;SendUtil.sendmsgReply(b,cid,msgid)},showEmjPanel:function(b){var a=Ext.getCmp('global-emojipanel');if(!a){a=Ext.widget('emojipanel',{id:'global-emojipanel'})}a.on({ok:'onChooseEmj',hide:'onHideEmjPanel',scope:this});a.showBy(b,'tl-bl?')},onChooseEmj:function(c,a){var b=window.minEmoji(a);if(b!==a){this.getView().lookup('reply_editor').insertObject(window.minEmoji(a),a)}},onHideEmjPanel:function(a){a.un({ok:'onChooseEmj',hide:'onHideEmjPanel',scope:this})},onMsgReplyTabChanges:function(b,a){if(a.title=='关于我的'){LocalDataMgr.getMsgaboutmeReplyhead(User.ownerID,function(h,g){var f=Ext.getStore('msgaboutmeReply'),d=g.rows,e=[];f.removeAll();for(var c=0;c<d.length;c++){if(d.item(c).ChatType=='D'){}else {e.push({chat_id:d.item(c).ChatID,AvaHash:d.item(c).AvatarHash,CreateAt:d.item(c).CreateAt,MsgContent:d.item(c).Content,Sendername:d.item(c).SenderName,Displayname:d.item(c).DisplayName,type:d.item(c).ChatType,create_at:d.item(c).Creatatchat,RootID:d.item(c).MsgID,Newreply:d.item(c).NewReply,MsgType:d.item(c).MsgType,filepath:d.item(c).FilePath,fileid:d.item(c).FileID,filename:d.item(c).FileName,filecreateat:d.item(c).CreatatFile,linkobjtype:d.item(c).LinkObjType,linktype:d.item(c).LinkType,linkkeystring:d.item(c).LinkKeyString,bfilepath:d.item(c).BFilePath,senderid:d.item(c).SenderID})}}f.add(e)})}else {if(a.title=='全部'){LocalDataMgr.getMsgReplyhead(function(h,g){var f=Ext.getStore('msgReply'),d=g.rows,e=[];f.removeAll();for(var c=0;c<d.length;c++){if(d.item(c).ChatType=='D'){}else {e.push({chat_id:d.item(c).ChatID,AvaHash:d.item(c).AvatarHash,CreateAt:d.item(c).CreateAt,MsgContent:d.item(c).Content,Sendername:d.item(c).SenderName,Displayname:d.item(c).DisplayName,type:d.item(c).ChatType,create_at:d.item(c).Creatatchat,RootID:d.item(c).MsgID,Newreply:d.item(c).NewReply,MsgType:d.item(c).MsgType,filepath:d.item(c).FilePath,fileid:d.item(c).FileID,filename:d.item(c).FileName,filecreateat:d.item(c).CreatatFile,linkobjtype:d.item(c).LinkObjType,linktype:d.item(c).LinkType,linkkeystring:d.item(c).LinkKeyString,bfilepath:d.item(c).BFilePath,senderid:d.item(c).SenderID})}}f.add(e)})}}}});Ext.define('IM.view.rightContainer.msgReplayEditor',{extend:'IMCommon.view.RichEditor',xtype:'msgreplyEditor',initialize:function(){var a=this;a.callParent(arguments);a.setTriggerChars([])},initDrap:function(){},preventKeydown:function(c,d,e){if(Config.isPC){var a='Ctrl+Enter';if(User.settings){a=User.settings.send_hot_key}var b=function(g){if(g){var f=Ext.ComponentQuery.query('#replycontentlist')[0].getData()[0].ChatID,b=Ext.ComponentQuery.query('#replycontentlist')[0].getData()[0].RootID,a=Ext.ComponentQuery.query('#replycontentlist')[0].parent;SendUtil.sendmsgReply(a,f,b)}};DesktopChatUtil.onChgEditorSendFunc(this,a,b)}}});Ext.define('IM.view.rightContainer.msgAboutmeReply',{extend:'Ext.List',xtype:'aboutmereply',controller:'msgallreplycontroller',requires:['Ext.panel.Resizer','IM.view.rightContainer.msgReplayList','IMCommon.model.MsgReplay','IM.view.rightContainer.msgallReplayController','IM.view.rightContainer.msgReplayEditor'],cls:'replayhead',store:{storeId:'msgaboutmeReply',model:'IMCommon.model.MsgReplay'},selectable:!1,itemsFocusable:!1,itemTpl:'<div class="msgreply" style="border-bottom: solid 1px #cfcfcf; " >'+'<tpl if="values.type == \'G\'">'+'<a class="avatar link-avatar firstletter loaded">'+'<img src="{[AvatarMgr.getNavUserAvaUrlWOCache(values.senderid, 0)]}" onerror="AvatarMgr.doUserAvaErr(this)" ava-id="{senderid}">'+'</a>'+'</tpl>'+'<tpl if="values.MsgType == \'T\'">'+'<div class="replytitle inOneline">{MsgContent}'+'</div>'+'<tpl if="values.Newreply == \'Y\'">'+'<div class="newreply" style="float: right;">新评论</div>'+'</tpl>'+'<tpl elseif="values.MsgType == \'I\'">'+'<div class="replytitle inOneline"><a>图片</a>'+'</div>'+'<tpl if="values.Newreply == \'Y\'">'+'<div class="newreply" style="float: right;">新评论</div>'+'</tpl>'+'<tpl elseif="values.MsgType == \'F\'">'+'<div class="replytitle inOneline"><a>文件</a>'+'</div>'+'<tpl if="values.Newreply == \'Y\'">'+'<div class="newreply" style="float: right;">新评论</div>'+'</tpl>'+'<tpl elseif="values.MsgType == \'L\'">'+'<div class="replytitle inOneline"><a>链接</a>'+'</div>'+'<tpl if="values.Newreply == \'Y\'">'+'<div class="newreply" style="float: right;">新评论</div>'+'</tpl>'+'<tpl elseif="values.MsgType == \'E\'">'+'<div class="replytitle inOneline"><a>大文件</a>'+'</div>'+'<tpl if="values.Newreply == \'Y\'">'+'<div class="newreply" style="float: right;">新评论</div>'+'</tpl>'+'</tpl>'+'<div class="reply_uname" style="margin-top: 4px;padding: 0px 43px;">{Sendername} 发表于 <a>{Displayname}</a> {[ParseUtil.handleShowTime(values.CreateAt)]}'+'</div>'+'</div>',listeners:{childtap:function(b,a){var h=this;if(Ext.fly(a.event.target).dom.tagName=='A'){var b=a.record.data;switch(Ext.fly(a.event.target).dom.innerHTML){case '图片':var g=ParseUtil.getLocalFileURL(ConfigMgr.getDataDirectory()+User.accountID+'/'+User.ownerID+'/'+b.filepath);var e=Config.httpUrlForGo+'files/'+b.fileid;var c=[];c.push({url:g,original:e,name:b.filename,createAt:b.filecreateat});var d=DesktopChatUtil.getCefObj();if(d){c=JSON.stringify(c);d.viewImages(c,0)};break;case '文件':var f=ConfigMgr.getDataDirectory()+User.accountID+'/'+User.ownerID+'/'+b.filepath;FileMgr.open(b.filepath)['catch'](function(c){FileMgr.open(f)});break;case '链接':DesktopChatUtil.openErpLink(b.linkobjtype+'',b.linkkeystring,b.linktype);break;case '大文件':FileMgr.open(b.bfilepath)['catch'](function(c){});break;case a.record.data.Displayname:ChatHelper.openChat(a.record.data.chat_id);break;default:break;}}else {if(Ext.fly(a.event.target).component){if(Ext.fly(a.event.target).component.getItemId()=='replylisteitor'){Ext.fly(a.event.target).component.el.dom.focus()}}else {LocalDataMgr.getMsgNewreply(a.record.data.RootID,function(g,f){if(f.rows.item(0).NewReply=='Y'){if(Ext.fly(a.event.target).parent().dom.children.length<5&&Ext.fly(a.event.target).parent().dom.className=='msgreply'||Ext.fly(a.event.target).dom.className=='msgreply'&&Ext.fly(a.event.target).dom.children.length<5){var e=Ext.widget('container',{controller:'msgallreplycontroller',requires:['IM.view.rightContainer.msgallReplayController','IM.view.rightContainer.msgReplayEditor'],cls:'wgtcontain',items:[{xtype:'component',itemId:'replycontentlist',scrollable:!0,height:'200px',tpl:'<tpl for="."><div style="margin-top:3px"><a class="avatar link-avatar firstletter loaded " style="float:left;">\n                                                <img src="{[AvatarMgr.getNavUserAvaUrlWOCache(values.UserID, 0)]}" onerror="AvatarMgr.doUserAvaErr(this)" ava-id="{UserID}">\n                                            </a>\n                                            <div style="display: flex;">\n                                                <div class="reply_uname inOneline" style="width: 120px;">{UserName} {[ParseUtil.handleMsgShowTime(values.UpdateAt)]}</div>\n                                                <div class="reply_list">\n                                                    <div class="reply_plain">{[ParseUtil.parseTextToHtml(values.Content)]}</div>\n                                                </div>\n                                            </div></div></tpl>'},{xtype:'msgreplyEditor',reference:'reply_editor',itemId:'replylisteitor',style:'height: 50px; border: solid 1px #cfcfcf;padding-bottom: 0px;'},{layout:'hbox',userCls:'desktop_reply_send',itemId:'replylistsend',items:[{xtype:'button',iconCls:'im-common-smile',ui:'flat',handler:'showEmjPanel'},{xtype:'component',flex:1},{xtype:'button',text:'回复(<span style="text-decoration: underline;">S</span>)',ui:'send-ui',width:66,height:24,handler:'onSendMsgReply'}]}]});var c=a.record.data.RootID;if(Ext.fly(a.event.target).dom.className=='msgreply'){Ext.fly(a.event.target).dom.append(e.el.dom)}else {Ext.fly(a.event.target).parent().dom.append(e.el.dom)}var d=Ext.getStore('msgReply').getById(c);if(d.data.Newreply=='Y'){if(Ext.fly(a.event.target).parent().dom.className=='msgreply'){Ext.fly(a.event.target).parent().dom.querySelector('.newreply').remove();Ext.fly(a.event.target).parent().dom.querySelector('.replytitle').style['-webkit-line-clamp']='unset'}else {Ext.fly(a.event.target).dom.querySelector('.newreply').remove();Ext.fly(a.event.target).dom.querySelector('.replytitle').style['-webkit-line-clamp']='unset'}if(d.data.senderid==User.ownerID){ChatUtil.viewReply(d.data.chat_id,c,function(){},function(c){})}else {LocalDataMgr.viewReply(d.data.RootID)}}if(Ext.ComponentQuery.query('#replycontentlist')[0].getData()!=null){Ext.ComponentQuery.query('#replycontentlist')[0].parent.destroy()}LocalDataMgr.getMsgReplycontent(c,function(j,i){var h=0,d=i.rows,e=d.length;if(e>0){h=d.item(e-1).ReplySeq}ChatUtil.getUnreadMsgReply(c,h,function(c){},function(){})})}}else {if(Ext.fly(a.event.target).parent().dom.children.length<4&&Ext.fly(a.event.target).parent().dom.className=='msgreply'||Ext.fly(a.event.target).dom.className=='msgreply'&&Ext.fly(a.event.target).dom.children.length<4){var e=Ext.widget('container',{controller:'msgallreplycontroller',requires:['IM.view.rightContainer.msgallReplayController','IM.view.rightContainer.msgReplayEditor'],cls:'wgtcontain',items:[{xtype:'component',itemId:'replycontentlist',scrollable:!0,height:'200px',tpl:'<tpl for="."><div style="margin-top:3px"><a class="avatar link-avatar firstletter loaded " style="float:left;">\n                                                <img src="{[AvatarMgr.getNavUserAvaUrlWOCache(values.UserID, 0)]}" onerror="AvatarMgr.doUserAvaErr(this)" ava-id="{UserID}">\n                                            </a>\n                                            <div style="display: flex;">\n                                                <div class="reply_uname inOneline" style="width: 120px;">{UserName} {[ParseUtil.handleMsgShowTime(values.UpdateAt)]}</div>\n                                                <div class="reply_list">\n                                                    <div class="reply_plain">{[ParseUtil.parseTextToHtml(values.Content)]}</div>\n                                                </div>\n                                            </div></div></tpl>'},{xtype:'msgreplyEditor',reference:'reply_editor',itemId:'replylisteitor',style:'height: 50px; border: solid 1px #cfcfcf;padding-bottom: 0px;'},{layout:'hbox',userCls:'desktop_reply_send',itemId:'replylistsend',items:[{xtype:'button',iconCls:'im-common-smile',ui:'flat',handler:'showEmjPanel'},{xtype:'component',flex:1},{xtype:'button',text:'回复(<span style="text-decoration: underline;">S</span>)',ui:'send-ui',width:66,height:24,handler:'onSendMsgReply'}]}]});var c=a.record.data.RootID;if(Ext.fly(a.event.target).dom.className=='msgreply'){Ext.fly(a.event.target).dom.append(e.el.dom)}else {Ext.fly(a.event.target).parent().dom.append(e.el.dom)}var d=Ext.getStore('msgReply').getById(c);if(f.rows.item(0).NewReply=='Y'){if(Ext.fly(a.event.target).parent().dom.className=='msgreply'){Ext.fly(a.event.target).parent().dom.querySelector('.newreply').remove()}else {Ext.fly(a.event.target).dom.querySelector('.newreply').remove()}if(d.data.senderid==User.ownerID){ChatUtil.viewReply(d.data.chat_id,c,function(){},function(c){})}else {LocalDataMgr.viewReply(d.data.RootID)}}if(Ext.fly(a.event.target).parent().dom.className=='msgreply'){Ext.fly(a.event.target).parent().dom.querySelector('.replytitle').style['-webkit-line-clamp']='unset'}else {Ext.fly(a.event.target).dom.querySelector('.replytitle').style['-webkit-line-clamp']='unset'}if(Ext.ComponentQuery.query('#replycontentlist')[0].getData()!=null){Ext.ComponentQuery.query('#replycontentlist')[0].parent.destroy()}LocalDataMgr.getMsgReplycontent(c,function(j,i){var h=0,d=i.rows,e=d.length;if(e>0){h=d.item(e-1).ReplySeq}ChatUtil.getUnreadMsgReply(c,h,function(c){},function(){})})}else {if(Ext.fly(a.event.target).parent().dom.className=='msgreply'||Ext.fly(a.event.target).dom.className=='msgreply'){if(Ext.fly(a.event.target).parent().dom.className=='msgreply'){Ext.fly(a.event.target).parent().dom.querySelector('.replytitle').style['-webkit-line-clamp']='3'}else {Ext.fly(a.event.target).dom.querySelector('.replytitle').style['-webkit-line-clamp']='3'}if(Ext.ComponentQuery.query('#replycontentlist')[0].getData()!=null){Ext.ComponentQuery.query('#replycontentlist')[0].parent.destroy()}}}}})}}}}});Ext.define('IM.view.rightContainer.msgMrdController',{extend:'Ext.app.ViewController',alias:'controller.msgmrdcontroller',msgRecordBeforeShow:function(a){var b=this;b.msgAllShow(a);b.msgPicShow(a);b.msgFileShow(a)},msgRecoredBeforeHide:function(a){var d=a.down('#msgAllTab').getStore();d.removeAll();var c=a.down('#msgPicTab').getStore();c.removeAll();var b=a.down('#msgFileTab').getStore();b.removeAll()},msgAllShow:function(d){var b=this;var a=d.down('#msgAllTab'),c=a.getStore();LocalDataMgr.getHistoryWoNotShow(function(k,j){var h=j.rows,i=h.length;if(i>0){var f=[];for(var g=i-1;g>=0;g--){var e=h.item(g);f.push({chatID:e.ChatID,msgID:e.MsgID,msgType:e.MsgType,senderID:e.SenderID,senderName:e.SenderName,updateTime:e.CreateAt,content:e.Content,width:e.Wdith,height:e.Height,fileName:e.FileName,fileSize:e.FileSize,filePath:e.FilePath,linkObjType:e.LinkObjType,linkTitle:e.LinkTitle,linkType:e.LinkType,linkStgGuid:e.LinkStgGuid,linkKeyString:e.LinkKeyString})}c.add(f);ParseUtil.doEmptyText(a);b.defaultMrdAllData=f;b.msgRecordScrolAll()}},0,User.crtChannelId)},msgPicShow:function(c){var a=c.down('#msgPicTab').getStore();var b='SELECT * FROM IMFile WHERE ChatID=? AND FileType=? ORDER BY CreateAt DESC limit 50;';LocalDataMgr.cExecSqlWithP(b,[User.crtChannelId,'I'],function(h,g){var d=g.rows;if(d.length>0){var f=[];for(var e=0;e<d.length;e++){var b=d.item(e);f.push({baseID:b.BaseID,fileID:b.FileID,chatID:b.ChatID,createAt:b.CreateAt,filePath:b.FilePath,fileName:b.FileName})}a.add(f)}})},msgFileShow:function(c){var a=c.down('#msgFileTab').getStore();var b='SELECT * FROM IMFile WHERE ChatID=? AND FileType=? ORDER BY CreateAt DESC limit 50;';LocalDataMgr.cExecSqlWithP(b,[User.crtChannelId,'F'],function(h,g){var d=g.rows;if(d.length>0){var f=[];for(var e=0;e<d.length;e++){var b=d.item(e);f.push({baseID:b.BaseID,fileID:b.FileID,chatID:b.ChatID,createAt:b.CreateAt,filePath:b.FilePath,fileSize:b.FileSize,fileName:b.FileName})}a.add(f)}})},msgRecordScrolAll:function(){var a=this.getView().down('#msgAllTab');this.doMsgRecordScrol(a)},msgRecordScrolPic:function(){var a=this.getView().down('#msgPicTab');this.doMsgRecordScrol(a)},msgRecordScrolFile:function(){var a=this.getView().down('#msgFileTab');this.doMsgRecordScrol(a)},doMsgRecordScrol:function(d){var a=d.getScrollable();if(a){var b=a.getScrollElement().dom.scrollHeight,c=a.getScrollElement().dom.scrollTop;User.isMrdSearch=!0;a.scrollTo(0,b-c);User.isMrdSearch=!1}},mrdSearch:function(d,c,g){var b=this;var e=b.getView();var a=e.mrdSearchPanel;if(c){if(!a){a=b.getSearchP(c);if(a.getParent()!==Ext.Viewport){Ext.Viewport.add(a)}}else {var f=b.getSearchHTML(c);a.setHtml(f)}a._hidden=!0;a.setHidden(!1);a.showBy(d.element,'tl-bl?')}else {if(a){a.hide()}b.getMrdAllListStore().removeAll();b.getMrdAllListStore().add(b.defaultMrdAllData);b.msgRecordScrolAll()}},getSearchP:function(d){var b=this;var a=b.getView();if(!a.mrdSearchPanel){var c=b.getSearchHTML(d);a.mrdSearchPanel=Ext.create('Ext.Panel',{floated:!0,scrollable:!0,bodyPadding:5,width:277,html:c});a.mrdSearchPanel.element.on({tap:'onTapAP',scope:b})}return a.mrdSearchPanel},getSearchHTML:function(a){return ['<div class="searchP" search_value="'+a+'">','<div class="search_chat_record" search_value="'+a+'"><p class="search_chat_record">聊天记录：</p>'+a+'</div>','</div>'].join('')},onTapAP:function(c){var b=this,a=Ext.fly(c.target);if(a.hasCls('search_chat_record')){b.doCRSearch(a)}},doCRSearch:function(c){var a=this;var d=this.beforeSearch(c);var b='SELECT M.*,F.*,L.* FROM IMMsg M \n        LEFT JOIN IMFile F ON M.ID=F.BaseID \n        LEFT JOIN IMLink L ON M.ID=L.BaseID \n        WHERE M.ChatID=? AND M.MsgType=? AND M.Content LIKE ? \n        ORDER BY M.CreateAt DESC limit 0,20;';LocalDataMgr.cExecSqlWithP(b,[User.crtChannelId,MsgType.TextMsg,'%'+d+'%'],function(j,h){var g=h.rows,i=g.length;var e=[];for(var d=i-1;d>=0;d--){var b=g.item(d);e.push({chatID:b.ChatID,msgID:b.MsgID,msgType:b.MsgType,senderID:b.SenderID,senderName:b.SenderName,updateTime:b.CreateAt,content:b.Content,fileName:b.FileName,fileSize:b.FileSize,filePath:b.FilePath,linkLinkType:b.LinkType,linkName:b.LinkTitle})}User.isMrdSearch=!0;var f=Ext.getStore('mrdMsgAllList');f.removeAll();f.add(e);ParseUtil.doEmptyText(a.getMrdAllList());a.isMrdSearch=!1})},beforeSearch:function(a){this.getView().mrdSearchPanel.hide();var b=a.getParent().getAttribute('search_value');return b},getMrdAllList:function(){return this.getView().down('#msgAllTab')},getMrdAllListStore:function(){return this.getView().down('#msgAllTab').getStore()},onShowCalender:function(b){var c=this;var a=Ext.getCmp('mrdMsg-datePanel');if(!a){a=Ext.widget('mrdDatePanel',{id:'mrdMsg-datePanel'})}a.on({selDate:'onSearchByDate',scope:c});if(a.getHidden()){a.showBy(b,'tl-bl?')}},onSearchByDate:function(d,a){if(a){var f=this;var e=ParseUtil.getZeroTimeOfDay(a),c=ParseUtil.get24TimeOfDay(a);var b=User.crtChannelId;MsgMgrSearch.searchMsgInOneDay(b,e,c,function(l,k){if(b==User.crtChannelId){var h=k.rows;var g=f.getMrdAllList(),e=g.getStore();if(h.length>0){var j=[];for(var i=0;i<h.length;i++){var c=h.item(i);j.push({chatID:c.ChatID,msgID:c.MsgID,msgType:c.MsgType,senderID:c.SenderID,senderName:c.SenderName,updateTime:c.CreateAt,content:c.Content,fileName:c.FileName,fileSize:c.FileSize,filePath:c.FilePath,linkLinkType:c.LinkType,linkName:c.LinkTitle})}User.isMrdSearch=!0;e.removeAll();e.add(j);ParseUtil.doEmptyText(g);User.isMrdSearch=!1}else {e.removeAll();ParseUtil.doEmptyText(g)}d.hide()}})}},init:function(){var a=this.getView();this.onSearchMsg(a);this.onSearchPic(a);this.onSearchFile(a)},onSearchMsg:function(b){var d=this;var a=b.down('#msgMrd_all').down('#msgMrd_list_all');var c=Ext.getStore('msgMrdListAll');LocalDataMgr.getHistoryWoNotShow(function(k,j){var f=j.rows,g=f.length;if(g>0){var i=[];for(var e=g-1;e>=0;e--){var h=f.item(e);if(e==g-1){h.showDate=!0}else {h.showDate=!ParseUtil.inOneDay(h.CreateAt,f.item(e+1).CreateAt)}i.push(f.item(e))}c.add(i);d.doMsgRecordScrol(a)}else {ParseUtil.doEmptyText(a)}},0,User.crtChannelId)},onSearchPic:function(a){var b=User.crtChannelId;LocalSearchMgr.searchLastPic(User.crtChannelId,function(h,g){var f=a.down('#msgPicTab').down('#msgMrd_pic_list').getStore();var b=g.rows;if(b.length>0){var e=[],d;for(var c=0;c<b.length;c++){d=b.item(c);if(d.FileStatus=='1'){continue}e.push(d)}f.add(e)}})},onSearchFile:function(a){LocalSearchMgr.searchLastFile(User.crtChannelId,function(h,g){var f=a.down('#msgFileTab').down('#msgMrd_file_list').getStore();var b=g.rows;if(b.length>0){var e=[],d;for(var c=0;c<b.length;c++){d=b.item(c);if(d.FileStatus=='1'){continue}e.push(d)}f.add(e)}})}});Ext.define('IM.view.rightContainer.msgMrd.AllController',{extend:'Ext.app.ViewController',alias:'controller.allcontroller',init:function(){var a=this;a.callParent(arguments);var b=this.lookup('msgmrd_richSearchfield');b.doUIRenderBySearch=function(b){if(Object.keys(b).length==0){a.showAllList();return}a.showAllAdvList(b)}},showAllList:function(){var c=this.getView(),a=c.lookup('msgmrd_list_all'),b=c.lookup('msgmrd_listAdv_all');if(!a){return}if(b){b.hide()}if(a.getHidden()){a.show()}},onSelAllTime:function(){var a=this.getView().lookup('msgmrd_richSearchfield');a.doInsertSearchObj(SearchType.Time,'不限','all')},onSelOneMonth:function(){var a=this.getView().lookup('msgmrd_richSearchfield');a.doInsertSearchObj(SearchType.Time,'最近一个月','oneMonth')},onSelThreeMonth:function(){var a=this.getView().lookup('msgmrd_richSearchfield');a.doInsertSearchObj(SearchType.Time,'最近三个月','threeMonth')},onSelOneYear:function(){var a=this.getView().lookup('msgmrd_richSearchfield');a.doInsertSearchObj(SearchType.Time,'最近一年','oneYear')},showAllAdvList:function(b){var j=this,e=j.getView(),i=e.lookup('msgmrd_list_all'),a=e.lookup('msgmrd_listAdv_all'),d=User.crtChannelId;if(!i.getHidden()){i.hide()}if(!a){a=e.add({xtype:'msgMrd_listAdv_all',reference:'msgmrd_listAdv_all',flex:1})}else {a.show()}var f=0,c='';for(var h in b){switch(h){case SearchType.MsgRecord:c=b[h];break;case SearchType.Time:f=LocalSearchMgr.getSearchTime(b[h]);break;case SearchType.SendName:break;default:break;}}if(Ext.isEmpty(c)){var g='SELECT M.*,\n                F.ID FID,F.FileID,F.BaseID FileBaseID,F.FilePath,F.CreateAt FileCreateAt,F.FileType,F.FileName,F.MimeType,F.Width,F.Height,F.FileSize,F.Extension,F.FileStatus,F.HasPreview,\n                L.ID LID,L.BaseID LinkBaseID,L.Type,L.LinkObjType,L.LinkKeyString,L.LinkID,L.LinkTitle,L.LinkType,L.LinkOpUser,L.LinkDesc,L.LinkStr,L.LinkFromID,L.LinkStepID,L.LinkStepDesc,L.LinkStepStatus,L.LinkStatus,L.LinkStgGuid,\n                B.* \n                FROM \n                (SELECT * FROM IMMsg WHERE ChatID=? AND CreateAt >= ? \n                ORDER BY CreateAt DESC,MsgSeq DESC) M \n                LEFT JOIN IMFile F ON M.ID=F.BaseID \n                LEFT JOIN IMLink L ON M.ID=L.BaseID\n                LEFT JOIN IMBFile B ON M.ID=B.BaseID';LocalDataMgr.cExecSqlWithP(g,[d,f],function(l,k){if(User.crtChannelId==d){var j=k.rows,g=j.length;var i=a.lookup('msgmrd_listAdv_all_title'),f=a.lookup('msgmrd_listAdv_all_list'),c=f.getStore();if(g>0){i.setHtml('<div class="allAdvlist-zone">'+g+'条消息</div>');var h=[];c.conditions=b;for(var e=0;e<g;e++){if(e==20){break}h.unshift(j.item(e))}c.removeAll();c.add(h);AddDataUtil.onScroll(f)}else {i.setHtml('<div class="allAdvlist-zone">没有相关消息</div>');c.removeAll();ParseUtil.doEmptyText(f)}}})}else {var g='SELECT MsgID,ChatID,MsgType,Content,CreateAt,SenderID,SenderName,MsgSeq,Status '+'FROM IMMsg '+'WHERE ChatID = ? AND CreateAt >= ? AND MsgType = ? AND INSTR(Content,?)>0 '+'ORDER BY CreateAt DESC;';LocalDataMgr.cExecSqlWithP(g,[d,f,MsgType.TextMsg,c],function(m,l){if(User.crtChannelId==d){var h=l.rows,i=h.length;var k=a.lookup('msgmrd_listAdv_all_title'),g=a.lookup('msgmrd_listAdv_all_list'),e=g.getStore();if(i>0){k.setHtml('<div class="allAdvlist-zone">'+i+'条消息</div>');var j=[];e.hltext=c;e.conditions=b;for(var f=0;f<i;f++){if(f==20){break}h.item(f).highlightWord=c;j.unshift(h.item(f))}e.removeAll();e.add(j);AddDataUtil.onScroll(g)}else {k.setHtml('<div class="allAdvlist-zone">没有相关消息</div>');e.removeAll();ParseUtil.doEmptyText(g)}}})}},onTogAdv:function(d){var e=d.getPressed(),a=this.getView(),b=a.down('#msgMrd_all_con');if(e){b.hide();var c=a.down('#msgMrd_listAdv_all');if(c){a.remove(c)}a.down('#msgMrd_list_all').show();a.down('#msgMrd_all_calendar').show()}else {b.show()}d.toggle()},doAdvSearch:function(l){var g=this,a=g.getView(),e=a.down('#msgMrd_all_calendar'),d=a.down('#msgMrd_list_all'),b=a.down('#msgMrd_listAdv_all');var i=a.down('#msgMrd_all_con').down('#msgMrd_all_con_text'),c=i.getValue();if(!c){Utils.toastShort('请输入搜索内容');return}if(!e.getHidden()){e.hide()}if(!d.getHidden()){d.hide()}if(!b){b=a.add({xtype:'msgMrd_listAdv_all',itemId:'msgMrd_listAdv_all',flex:1})}var h=a.down('#msgMrd_all_con').down('#msgMrd_all_con_combo'),j=g.getSearchTime(h.getValue()),f=User.crtChannelId;var k='SELECT MsgID,ChatID,MsgType,Content,CreateAt,SenderID,SenderName,MsgSeq,Status '+'FROM IMMsg '+'WHERE ChatID = ? AND CreateAt >= ? AND MsgType = ? AND INSTR(Content,?)>0 '+'ORDER BY CreateAt DESC ;';LocalDataMgr.cExecSqlWithP(k,[f,j,'T',c],function(m,k){if(User.crtChannelId==f){var j=k.rows,e=j.length;var h=b.down('#msgMrd_listAdv_all_title'),i=b.down('#msgMrd_listAdv_all_list');if(e>0){h.setHtml('<div class="allAdvlist-zone">'+e+'条消息</div>');var d=Ext.getStore('msgMrdListAllAdv'),g=[];d.hltext=c;for(var a=0;a<e;a++){if(a==20){break}g.unshift(j.item(a))}d.removeAll();d.add(g);AddDataUtil.onScroll(i)}else {h.setHtml('<div class="allAdvlist-zone">没有相关消息</div>');ParseUtil.doEmptyText(i)}}})},getSearchTime:function(c){var a=0,b=ParseUtil.getLocalTime(!0);switch(c){case 'oneWeek':a=b-1000*60*60*24*7;break;case 'oneMonth':a=b-1000*60*60*24*30;break;case 'threeMonth':a=b-1000*60*60*24*30*3;break;case 'oneYear':a=b-1000*60*60*24*30*12;break;case 'all':break;default:break;}return a},onShowCalendar:function(a){var b=this.getDatePanel();b.showBy(a,'t1-b1')},getDatePanel:function(){var b=this;var a=Ext.getCmp('msgMrd_all_date');if(!a){a=Ext.widget('msgMrd_all_date');LocalSearchMgr.getCalendarDate(User.crtChannelId,a);a.on({selDate:'onDateSearch',scope:b})}return a},onDateSearch:function(e,c){if(c){var f=this;var d=User.crtChannelId,a=f.getView().down('#msgMrd_list_all'),b=a.getStore();LocalSearchMgr.searchMsgByDate(d,c,function(f,h){if(User.crtChannelId==d){b.removeAll();a.refresh();if(f.length>0){b.add(f);var g=b.findRecord('CreateAt',h.CreateAt);if(g){AddDataUtil.msgScrollToRecord(g,a)}}else {ParseUtil.doEmptyText(a)}}});e.hide()}else {}},destroy:function(){var a=Ext.getCmp('msgMrd_all_date');if(a){Ext.destroy(a)}this.callParent(arguments)}});Ext.define('IM.view.rightContainer.msgMrd.list.AllList',{extend:'Ext.List',xtype:'msgMrd_list_all',store:{storeId:'msgMrdListAll'},style:'border-top: 1px solid #d6d6d6;',emptyText:'暂无记录',selectable:{model:'single'},deselectable:!1,itemTpl:['<tpl if="values.MsgType == \'R\'">','<tpl elseif="values.MsgType == \'S\'">','<tpl else>','<div class="msgRecord_imitate_list">','<tpl if="values.showDate">','<div class="msgRecord_Date">{[Utils.date2Str(values.CreateAt)]}</div>','</tpl>','<div class="msgRecord_title" style="color:{[values.SenderID == User.ownerID ? \'rgb(36, 118, 224)\' : \'\']}">{SenderName} {[Utils.datetime2Ago(values.CreateAt,true)]}</div>','<div class="msgRecord_content" {[ParseHelper.pushInfoToDom(values)]}>','<tpl if="values.MsgType == \'T\'">','{[ParseUtil.parseTextToHtml(values.Content)]}','<tpl elseif="values.MsgType == \'I\'">','{[ParseHelper.parseLoadedPic(values.Height,values.Width,values.FilePath,values.CreateAt,values.FileName,values.FileID)]}','<tpl elseif="values.MsgType == \'F\'">','<div class="msgRecord_file">','<div class="mrd_fileWrapper">','<div class="mrd_fileIcon {[ParseUtil.getFileIcon(values.FileName)]}"></div>','<div class="mrd_fileName">{FileName}</div>','<div>{[ParseUtil.bytesToSize(values.FileSize)]}</div>','</div>','</div>','<tpl elseif="values.MsgType == \'G\'">','{Content}','<tpl elseif="values.MsgType == \'L\'">','<div class="msgRecord_link">','<div class="mrd_linkIcon" letter="{LinkType}"></div>','<div class="mrd_linkName">{LinkTitle}</div>','</div>','<tpl elseif="values.MsgType == \'N\'">','{[ParseUtil.getSureName(values.SenderID)]}修改了群公告&nbsp;','<tpl elseif="values.MsgType == \'B\'">','{[GroupNotice.getRevokeNotice(values.SenderID,values.Content)]}','<tpl elseif="values.MsgType == \'E\'">','<div class="msgRecord_file">','<div class="mrd_fileWrapper">','<div class="mrd_fileIcon {[ParseUtil.getFileIcon(values.BFileName)]}"></div>','<div class="mrd_fileName">{BFileName}</div>','<div>{[ParseUtil.bytesToSize(values.BFileSize)]}</div>','</div>','<div class="bigfile-special"></div>','</div>','<tpl else>','消息类型未适配：{MsgType}','</tpl>','</div>','</div>','</tpl>'].join(''),initialize:function(){var a=this;a.callParent(arguments);a.on({childTap:'onCT',scope:a});a.getScrollable().on({scroll:'onChgScrol',scrollend:'onChgScrolEnd',scope:a});a.element.on({delegate:'.msgRecord_content',contextmenu:'onMrdContextmenu',scope:a});var b=a.add({xtype:'fabbutton',iconCls:'x-fa fa-calendar',ui:'action',handler:'onTapCalendar',scope:a});b.render(a.element)},onCT:function(e,d){var a=d.record;if(!a){return}var b=a.get('CreateAt');if(!b){return}var c=User.crtChannelId;if(!c){return}DesktopChatUtil.mainViewOnTapJumpToMsg(c,b)},onChgScrol:function(b,n,m){if(this.isCodeScrol){return}if(m===0){if(User.isMrdMsgTop){return}if(User.isMrdSearch){return}if(!b.autoTop){var g=this;var d=g.getStore(),a=d.getAt(0);if(!a){return}b.autoTop=!0;var f=a.get('ChatID'),l=a.get('MsgSeq'),c=a.get('CreateAt');LocalSearchMgr.getOldMsgWoNotShow(f,c,function(l,k){var h=k.rows,j=h.length;var i=[],f;for(var e=j-1;e>=0;e--){f=h.item(e);if(e==0){if(ParseUtil.inOneDay(f.CreateAt,c)){a.set({showDate:!1})}}if(e==j-1){f.showDate=!0}else {f.showDate=!ParseUtil.inOneDay(f.CreateAt,h.item(e+1).CreateAt)}i.push(f)}d.insert(0,i);g.ensureVisible(a,{align:{y:'start'}});b.autoTop=!1},function(){console.error('向上滚动时，查询数据出错');b.autoTop=!1})}}var e=b.getScrollElement().dom,i=e.scrollHeight,j=e.scrollTop,h=e.offsetHeight;if(i<=j+h){if(User.isMrdMsgBottom){return}if(User.isMrdSearch){return}if(!b.autoBottom){var k=this;var d=k.getStore(),a=d.last();if(!a){return}b.autoBottom=!0;var f=a.get('ChatID'),l=a.get('MsgSeq'),c=a.get('CreateAt');LocalSearchMgr.getMoreEndHisWoNotShow(f,c,function(j,i){var f=i.rows,h=f.length;var g=[],a;for(var e=0;e<h;e++){a=f.item(e);if(e==0){a.showDate=!ParseUtil.inOneDay(a.CreateAt,c)}else {a.showDate=!ParseUtil.inOneDay(a.CreateAt,f.item(e-1).CreateAt)}g.push(a)}d.add(g);b.autoBottom=!1},function(){console.error('向下滚动时，查询数据出错');b.autoBottom=!1})}}},onChgScrolEnd:function(){this.isCodeScrol=!1},onMrdContextmenu:function(f){var a=f.currentTarget;if(!a){return}var i=this;var c,b,d;var g=a.getAttribute('type');switch(g){case MsgType.TextMsg:var e=ParseUtil.getSelectedContents();if(!e){ParseUtil.selectText(a);e=a.innerHTML};b=ParseUtil.htmlToText(e);c=Ext.create('IMCommon.view.menu.TextContextmenu',{value:b});break;case MsgType.ImgMsg:b=a.getAttribute('origin_path');d=a.getAttribute('fileName');var h=Ext.fly(a).query('img')[0];c=Ext.create('IMCommon.view.menu.ImgContextmenu',{createAt:a.getAttribute('createAt'),value:b,path:b,fileName:d,openMore:!0,img:h,selectPlace:i,clsSelector:'img.msgRecord_img'});break;case MsgType.FileMsg:b=a.getAttribute('origin_path');d=a.getAttribute('fileName');c=Ext.create('IMCommon.view.menu.FileContextmenu',{value:b,path:b,fileName:d});break;case MsgType.LinkErp:b=a.getAttribute('content');c=Ext.create('IMCommon.view.menu.ErpLinkContextmenu',{value:b,linkObjType:a.getAttribute('linkObjType'),linkStgGuid:a.getAttribute('linkStgGuid'),linkKeyString:a.getAttribute('linkKeyString'),linkType:a.getAttribute('linkType')});break;default:break;}if(c){ParseUtil.menuShowAtVisible(c,f.getPoint())}f.preventDefault()},onTapCalendar:function(b){var a=this.getDatePanel();if(a.getHidden()){a.showBy(b,'t1-b1')}},getDatePanel:function(){var b=this;var a=b.aDateP;if(!a){b.aDateP=a=Ext.widget('msgMrd_all_date');b.setHasMsgDate(ParseUtil.getLocalTime(!0),User.crtChannelId,a);a.on({selDate:'onDateSearch1',chgMonthTool:'onChgMonthTool',scope:b})}return a},onChgMonthTool:function(b,c,a){if(a!=User.crtChannelId){return}this.setHasMsgDate(c,a,b)},setHasMsgDate:function(a,e,b){Utils.mask(b);if(Ext.isDate(a)){a=a.getTime()}var c=ParseUtil.getPrevMonthStartTime(a),d=ParseUtil.getNextMonthEndTime(a);var f='SELECT CreateAt FROM IMMsg WHERE MsgType<>? AND ChatID=? AND CreateAt>=? AND CreateAt<=? ORDER BY CreateAt ASC;';LocalDataMgr.cExecSqlWithP(f,[MsgType.NotShow,e,c,d],function(i,h){var d=h.rows,g=d.length;var f=[];if(g>0){for(var c=0;c<g;c++){if(c==0){f.push(new Date(d.item(c).CreateAt))}else {if(!ParseUtil.inOneDay(d.item(c).CreateAt,d.item(c-1).CreateAt)){f.push(new Date(d.item(c).CreateAt))}}}b.setSpecialDates(f)}Utils.unMask(b)})},onDateSearch:function(e,c){if(c){var a=this,d=User.crtChannelId,b=a.getStore();LocalSearchMgr.searchMsgByDate(d,c,function(f,h){if(User.crtChannelId==d){b.removeAll();a.refresh();if(f.length>0){b.add(f);var g=b.findRecord('CreateAt',h.CreateAt);if(g){AddDataUtil.msgScrollToRecord(g,a)}}else {ParseUtil.doEmptyText(a)}}});e.hide()}else {}},onDateSearch1:function(e,a){if(a){var c=this,b=User.crtChannelId,d=c.getStore();var f='SELECT M.MsgID,M.ChatID,M.MsgType,M.Content,M.CreateAt,M.SenderID,M.SenderName,M.MsgSeq,M.Status,'+'F.FileID,F.BaseID FileBaseID,F.FilePath,F.FileType,F.FileName,F.MimeType,F.Width,F.Height,F.FileSize,F.Extension,F.FileStatus,F.HasPreview,'+'L.BaseID LinkBaseID,L.Type,L.LinkObjType,L.LinkKeyString,L.LinkID,L.LinkTitle,L.LinkType,'+'L.LinkOpUser,L.LinkDesc,L.LinkStr,L.LinkFromID,L.LinkStepID,L.LinkStepDesc,L.LinkStepStatus,L.LinkStatus,L.LinkStgGuid, '+'B.BaseID BFileBaseID,B.BFileID,B.BFilePath,B.BFileName,B.BFileSize,B.BFileExtension,B.BFileStatus,B.CreateAt BCreateAt,B.ExpireAt '+'FROM IMMsg M '+'LEFT JOIN IMFile F ON M.ID = F.BaseID '+'LEFT JOIN IMLink L ON M.ID = L.BaseID '+'LEFT JOIN IMBFile B ON M.ID = B.BaseID '+'WHERE M.ChatID = ? AND M.CreateAt <= ? AND M.MsgType<>? '+'ORDER BY M.CreateAt DESC LIMIT 10;';a=a.getTime();LocalDataMgr.cExecSqlWithP(f,[b,a,MsgType.Revoke],function(n,l){if(User.crtChannelId!==b){return}var j=l.rows,g=j.length;var f=[],i=10;if(g<10){i=i+(10-g)}var k;for(var h=0;h<g;h++){k=j.item(h);f.unshift(k)}var m='SELECT M.MsgID,M.ChatID,M.MsgType,M.Content,M.CreateAt,M.SenderID,M.SenderName,M.MsgSeq,M.Status,'+'F.FileID,F.BaseID FileBaseID,F.FilePath,F.FileType,F.FileName,F.MimeType,F.Width,F.Height,F.FileSize,F.Extension,F.FileStatus,F.HasPreview,'+'L.BaseID LinkBaseID,L.Type,L.LinkObjType,L.LinkKeyString,L.LinkID,L.LinkTitle,L.LinkType,'+'L.LinkOpUser,L.LinkDesc,L.LinkStr,L.LinkFromID,L.LinkStepID,L.LinkStepDesc,L.LinkStepStatus,L.LinkStatus,L.LinkStgGuid, '+'B.BaseID BFileBaseID,B.BFileID,B.BFilePath,B.BFileName,B.BFileSize,B.BFileExtension,B.BFileStatus,B.CreateAt BCreateAt,B.ExpireAt '+'FROM IMMsg M '+'LEFT JOIN IMFile F ON M.ID = F.BaseID '+'LEFT JOIN IMLink L ON M.ID = L.BaseID '+'LEFT JOIN IMBFile B ON M.ID = B.BaseID '+'WHERE M.ChatID = ? AND M.CreateAt > ? AND M.MsgType<>? '+'ORDER BY M.CreateAt ASC LIMIT 10;';LocalDataMgr.cExecSqlWithP(m,[b,a,MsgType.Revoke],function(o,k){if(User.crtChannelId!==b){return}var h=k.rows,m=h.length;var i;for(var g=0;g<m;g++){if(g==0){i=h.item(g)}f.push(h.item(g))}d.removeAll();c.refresh();if(f.length>0){d.add(f);var j=d.findRecord('CreateAt',i.CreateAt);if(j){AddDataUtil.msgScrollToRecord(j,c)}}else {ParseUtil.doEmptyText(c)}})});e.hide()}else {}},destroy:function(){var a=this.aDateP;if(a){Ext.destroy(a)}this.callParent(arguments)}});Ext.define('IM.view.rightContainer.msgMrd.All',{extend:'Ext.Container',xtype:'msgMrd_all',controller:'allcontroller',requires:['IM.view.rightContainer.msgMrd.AllController','IM.view.rightContainer.msgMrd.list.AllList'],uses:['IM.view.rightContainer.msgMrd.list.AllAdvList'],layout:'vbox',items:[{xtype:'container',style:'border: 1px solid #e5ecea;margin: 0 10px 10px;',layout:'hbox',items:[{xtype:'richSearchfield',reference:'msgmrd_richSearchfield',height:33,flex:1,searchView:{width:240,store:{data:[{type:'mr'}]}}},{xtype:'button',iconCls:'i-im i-im-history',arrow:!1,menu:[{text:'最近一个月',handler:'onSelOneMonth',indented:!1},{text:'最近三个月',handler:'onSelThreeMonth',indented:!1},{text:'最近一年',handler:'onSelOneYear',indented:!1}]}]},{layout:'vbox',hidden:!0,items:[{xtype:'container',layout:'hbox',items:[{xtype:'button',itemId:'msgMrd_all_calendar',iconCls:'x-fa fa-calendar',handler:'onShowCalendar',text:'日期',ui:'msgMrdCon',flex:1},{xtype:'button',iconCls:'x-fa fa-search',docked:'right',handler:'onTogAdv',ui:'msgMrdCon',pressed:!1}]},{itemId:'msgMrd_all_con',hidden:!0,xtype:'container',cls:'msgMrd_all_con',layout:'hbox',defaults:{labelWidth:'auto',labelCls:'msgMrd_all_label'},items:[{xtype:'combobox',itemId:'msgMrd_all_con_combo',label:'范围',displayField:'name',valueField:'val',queryMode:'local',value:'all',clearable:!1,editable:!1,width:130,options:[{name:'不限',val:'all'},{name:'最近一周',val:'oneWeek'},{name:'最近一个月',val:'oneMonth'},{name:'最近三个月',val:'threeMonth'}]},{xtype:'textfield',itemId:'msgMrd_all_con_text',width:105,label:'内容'},{xtype:'button',width:48,text:'确定',docked:'right',ui:'msgMrdCon',handler:'doAdvSearch'}]}]},{xtype:'msgMrd_list_all',reference:'msgmrd_list_all',itemId:'msgMrd_list_all',flex:1}]});Ext.define('IM.view.rightContainer.msgMrd.AllDatePanel',{extend:'Ext.panel.Date',xtype:'msgMrd_all_date',cls:'mrdCalendar',animation:!1,floated:!0,width:252,height:300,scrollable:!1,hidden:!0,buttonToolbar:{cls:'autoHide'},headerFormat:{$value:'Y年 m月',cached:!0},prevText:'',nextText:'',tools:{previousYear:null,nextYear:null},initialize:function(){var a=this;a.callParent(arguments);a.on({show:'onShowPanel',hide:'onHidePanel',scope:a})},onDateClick:function(d){var a=this,b=d.getTarget(a.cellSelector,a.bodyElement),c=b&&b.date,e=!0,f=b&&b.disabled;var g=Ext.fly(b);if(!g.hasCls(Ext.baseCSSPrefix+'special')){return}a.fireEvent('selDate',a,c);if(!c||a.getDisabled()){return}if(!f){a.setValue(c);if(a.getAutoConfirm()){if(d.pointerType==='touch'){d.preventDefault()}e=!1;a.fireEvent('select',a,c)}}if(e){a.focusDate(c)}},onDC:function(d){var a=this,b=d.getTarget(a.cellSelector,a.bodyElement),c=b&&b.date;var e=Ext.fly(b);if(e.hasCls(Ext.baseCSSPrefix+'special')){a.fireEvent('selDate',a,c)}},onMonthToolClick:function(b){this.callParent(arguments);var a=this.getFocusableDate();this.fireEvent('chgMonthTool',this,a,User.crtChannelId)},onShowPanel:function(b){var a=this;a.touchListeners=Ext.getDoc().on({touchstart:a.collapseIf,scope:a,delegated:!1,destroyable:!0})},collapseIf:function(b){var a=this;if(!a.destroyed&&!a.owns(b.target)){a.hide()}},onHidePanel:function(a){Ext.destroy(this.touchListeners)},doDestroy:function(){Ext.destroy(this.touchListeners);this.callParent()}});Ext.define('IM.view.rightContainer.msgMrd.list.PicList',{extend:'Ext.List',xtype:'msgMrd_list_pic',store:{fields:['BaseID','FileID','ChatID','CreateAt','FilePath']},itemTpl:['<div class="msgRecord_pic_frame" {[ParseHelper.getImgDomAttr(values.FilePath,values.CreateAt,values.FileName)]}>','<div class="msgRecord_pic_block">','<img class="msgRecord_pic_loaded" src="{[ParseUtil.getLocalFileURL(ParseUtil.getAbsolutePath(values.FilePath))]}" create_at="{CreateAt}" fileID="{FileID}" fileName="{FileName}">','</div>','<div style="text-align: center;">{[Utils.date2Str(values.CreateAt)]}</div>','</div>'].join(''),initialize:function(){var a=this;a.callParent(arguments);a.element.on({delegate:'.msgRecord_pic_frame',tap:'onTapPic',contextmenu:'onContextmenu',scope:a})},onTapPic:function(f){var d=f.delegatedTarget;if(!d){return}var c=Ext.fly(d).query('img')[0];if(!c){return}var e=this.innerElement.dom.querySelectorAll('img.msgRecord_pic_loaded'),a=[],b=-1;e.forEach(function(d,e){a.push({url:d.src,original:ImgMgr.getFullPicUrl(d.getAttribute('fileID')),name:d.getAttribute('fileName'),createAt:d.getAttribute('create_at')});if(c===d){b=e}});if(window.cefMain){a=JSON.stringify(a);cefMain.viewImages(a,b)}},onContextmenu:function(b){var c=b.delegatedTarget;if(!c){return}var a=Ext.fly(c).query('img')[0];if(!a){return}var e=this;var d=Ext.create('IMCommon.view.menu.ImgContextmenu',{createAt:a.getAttribute('create_at'),value:a.src,path:a.src,fileName:a.getAttribute('fileName'),openMore:!0,img:a,selectPlace:e,clsSelector:'img.msgRecord_pic_loaded'});ParseUtil.menuShowAtVisible(d,b.getPoint());b.preventDefault()}});Ext.define('IM.view.rightContainer.msgMrd.PicController',{extend:'Ext.app.ViewController',alias:'controller.piccontroller',init:function(){}});Ext.define('IM.view.rightContainer.msgMrd.Pic',{extend:'Ext.Container',xtype:'msgMrd_pic',controller:'piccontroller',requires:['IM.view.rightContainer.msgMrd.list.PicList','IM.view.rightContainer.msgMrd.PicController'],layout:'vbox',items:[{hidden:!0,layout:'vbox',items:[{xtype:'container',layout:'hbox',items:[{xtype:'button',iconCls:'x-fa fa-calendar',flex:1},{xtype:'button',iconCls:'x-fa fa-search',docked:'right'}]},{hidden:!0,xtype:'container',layout:'hbox',defaults:{labelWidth:'auto',height:25},items:[{xtype:'combobox',flex:1,label:'范围',displayField:'name',valueField:'val',queryMode:'local',value:'all',clearable:!1,editable:!1,options:[{name:'不限',val:'all'},{name:'最近一周',val:'oneWeek'},{name:'最近一个月',val:'oneMonth'},{name:'最近三个月',val:'threeMonth'}]},{xtype:'button',width:45,docked:'right',text:'确定'}]}]},{xtype:'msgMrd_list_pic',itemId:'msgMrd_pic_list',flex:1}]});Ext.define('IM.view.rightContainer.msgMrd.list.FileList',{extend:'Ext.List',xtype:'msgMrd_file_list',store:{fields:['BaseID','FileID','FileName','FileSize','CreateAt']},itemTpl:['<div class="mrd_fileList_fileIcon {[ParseUtil.getFileIcon(values.FileName)]}"></div>','<div class="mrd_file_font">{[Utils.date2Str(values.CreateAt)]}</div>','<div>','<div class="mrd_fileName">{FileName}</div>','<div class="mrd_fileSize">{[ParseUtil.bytesToSize(values.FileSize)]}</div>','</div>'].join(''),initialize:function(){var a=this;a.callParent(arguments);a.element.on({delegate:'.x-listitem',contextmenu:'onFileContextmenu',scope:a})},onFileContextmenu:function(c){var d=c.currentTarget;if(!d){return}var i=this;var f=i.getStore();var e=d.getAttribute('data-recordindex');var b=f.getAt(e);if(!b){return}var a=b.get('FilePath');var h=/file:[\/]+/g;if(!h.test(a)){a=ConfigMgr.getDefaultDir()+a}var g=Ext.create('IMCommon.view.menu.FileContextmenu',{value:a,path:a,fileName:b.get('FileName')});ParseUtil.menuShowAtVisible(g,c.getPoint());c.preventDefault()}});Ext.define('IM.view.rightContainer.msgMrd.FileController',{extend:'Ext.app.ViewController',alias:'controller.filecontroller',init:function(){}});Ext.define('IM.view.rightContainer.msgMrd.File',{extend:'Ext.Container',xtype:'msgMrd_file',controller:'filecontroller',requires:['IM.view.rightContainer.msgMrd.list.FileList','IM.view.rightContainer.msgMrd.FileController'],layout:'vbox',items:[{hidden:!0,layout:'vbox',items:[{xtype:'container',layout:'hbox',items:[{xtype:'button',iconCls:'x-fa fa-calendar',flex:1},{xtype:'button',iconCls:'x-fa fa-search',docked:'right'}]},{hidden:!0,xtype:'container',layout:'hbox',defaults:{labelWidth:'auto',width:'40%',height:25},items:[{xtype:'combobox',label:'范围',displayField:'name',valueField:'val',queryMode:'local',value:'all',clearable:!1,editable:!1,options:[{name:'不限',val:'all'},{name:'最近一周',val:'oneWeek'},{name:'最近一个月',val:'oneMonth'},{name:'最近三个月',val:'threeMonth'}]},{xtype:'textfield',label:'文件名'},{xtype:'button',width:45,docked:'right',text:'确定'}]}]},{xtype:'msgMrd_file_list',itemId:'msgMrd_file_list',flex:1}]});Ext.define('IM.view.rightContainer.msgMrdTabpanel',{extend:'Ext.tab.Panel',xtype:'msgMrdTabpanel',controller:'msgmrdcontroller',requires:['IM.view.rightContainer.msgMrdController','IM.view.rightContainer.msgMrd.All','IM.view.rightContainer.msgMrd.Pic','IM.view.rightContainer.msgMrd.File'],cls:'msgMrd',width:300,listeners:{},defaults:{tab:{iconAlign:'top'}},tabBar:{cls:'light-shadow',style:'box-shadow: none;',layout:{pack:'center'}},items:[{title:'全部2',xtype:'msgMrd_all',itemId:'msgMrd_all',cls:'msgMrd_all'},{title:'图片',xtype:'msgMrd_pic',itemId:'msgPicTab'},{title:'文件',xtype:'msgMrd_file',itemId:'msgFileTab',cls:'mrd_fileList'}]});Ext.define('IM.view.rightContainer.msgMrd.list.AllAdvList',{extend:'Ext.Container',xtype:'msgMrd_listAdv_all',referenceHolder:!0,layout:'vbox',items:[{xtype:'container',reference:'msgmrd_listAdv_all_title',html:'<div class="allAdvlist-zone">0条消息</div>',items:[{xtype:'button',itemId:'msgMrd_listAdv_all_title_back',text:'返回',hidden:!0,docked:'right'}]},{xtype:'list',selectable:{model:'single'},deselectable:!1,reference:'msgmrd_listAdv_all_list',flex:1,store:{storeId:'msgMrdListAllAdv'},emptyText:'暂无记录',itemTpl:['<tpl if="values.MsgType == \'R\'">','<tpl elseif="values.MsgType == \'S\'">','<tpl else>','<div class="msgRecord_imitate_list">','<div class="msgRecord_title" style="color:{[values.SenderID == User.ownerID ? \'rgb(36, 118, 224)\' : \'\']}">{SenderName} {[Utils.datetime2Ago(values.CreateAt,true)]}</div>','<div class="msgRecord_content" {[ParseHelper.pushInfoToDom(values)]}>','<tpl if="values.MsgType == \'T\'">','{[ParseUtil.doHighLight(values.Content, values.highlightWord)]}','<tpl elseif="values.MsgType == \'I\'">','{[ParseHelper.parseLoadedPic(values.Height,values.Width,values.FilePath,values.CreateAt,values.FileName,values.FileID)]}','<tpl elseif="values.MsgType == \'F\'">','<div class="msgRecord_file">','<div class="mrd_fileWrapper">','<div class="mrd_fileIcon {[ParseUtil.getFileIcon(values.FileName)]}"></div>','<div class="mrd_fileName">{FileName}</div>','<div>{[ParseUtil.bytesToSize(values.FileSize)]}</div>','</div>','</div>','<tpl elseif="values.MsgType == \'G\'">','{Content}','<tpl elseif="values.MsgType == \'L\'">','<div class="msgRecord_link">','<div class="mrd_linkIcon" letter="{LinkType}"></div>','<div class="mrd_linkName">{LinkTitle}</div>','</div>','<tpl elseif="values.MsgType == \'N\'">','{[ParseUtil.getSureName(values.SenderID)]}修改了群公告&nbsp;','<tpl elseif="values.MsgType == \'B\'">','{[GroupNotice.getRevokeNotice(values.SenderID,values.Content)]}','<tpl elseif="values.MsgType == \'E\'">','<div class="msgRecord_file">','<div class="mrd_fileWrapper">','<div class="mrd_fileIcon {[ParseUtil.getFileIcon(values.BFileName)]}"></div>','<div class="mrd_fileName">{BFileName}</div>','<div>{[ParseUtil.bytesToSize(values.BFileSize)]}</div>','</div>','<div class="bigfile-special"></div>','</div>','<tpl else>','消息类型未适配：{MsgType}','</tpl>','</div>','</div>','</tpl>'].join('')}],initialize:function(){var a=this;a.callParent(arguments);a.lookup('msgmrd_listAdv_all_list').on({childTap:'onCT',scope:a});a.lookup('msgmrd_listAdv_all_list').getScrollable().on({scroll:'onChgScrol',scrollend:'onChgScrolEnd',scope:a});a.element.on({delegate:'.msgRecord_content',contextmenu:'onMrdContextmenu',scope:a})},onCT:function(e,d){var a=d.record;if(!a){return}var b=a.get('CreateAt');if(!b){return}var c=User.crtChannelId;if(!c){return}DesktopChatUtil.mainViewOnTapJumpToMsg(c,b)},onChgScrol:function(a,s,r){if(a.autoScol){return}var l=this;if(l.isCodeScrol){return}var j=l.lookup('msgmrd_listAdv_all_list'),k=User.crtChannelId;if(r==0){var b=Ext.getStore('msgMrdListAllAdv'),c=b.getAt(0);if(!c){return}a.autoScol=!0;var h=c.get('CreateAt'),o=b.hltext,d=b.conditions,i=0,e='';for(var g in d){switch(g){case SearchType.MsgRecord:e=d[g];break;case SearchType.Time:i=LocalSearchMgr.getSearchTime(d[g]);break;case SearchType.SendName:break;default:break;}}if(e){var q='SELECT MsgID,ChatID,MsgType,Content,CreateAt,SenderID,SenderName,MsgSeq,Status '+'FROM IMMsg '+'WHERE ChatID = ? AND CreateAt >= ? AND CreateAt < ? AND MsgType = ? AND INSTR(Content,?)>0 '+'ORDER BY CreateAt DESC Limit 20;';LocalDataMgr.cExecSqlWithP(q,[k,i,h,MsgType.TextMsg,e],function(k,i){var g=i.rows,h=g.length;var f=[],e;for(var d=h-1;d>=0;d--){e=g.item(d);e.highlightWord=o;f.push(e)}b.insert(0,f);j.ensureVisible(c,{align:{y:'start'}});a.autoScol=!1},function(){a.autoScol=!1})}else {LocalSearchMgr.getOldMsgWoNotShow(k,h,function(k,i){var f=i.rows,h=f.length;var e=[],g;for(var d=h-1;d>=0;d--){g=f.item(d);e.push(g)}b.insert(0,e);j.ensureVisible(c,{align:{y:'start'}});a.autoScol=!1},function(){a.autoTop=!1})}}var f=a.getScrollElement().dom,n=f.scrollHeight,p=f.scrollTop,m=f.offsetHeight;if(n<=Math.ceil(p+m)){}},onChgScrolEnd:function(){this.isCodeScrol=!1},onMrdContextmenu:function(f){var a=f.currentTarget;if(!a){return}var c,b,d;var h=a.getAttribute('type');switch(h){case MsgType.TextMsg:var e=ParseUtil.getSelectedContents();if(!e){ParseUtil.selectText(a);e=a.innerHTML};b=ParseUtil.htmlToText(e);c=Ext.create('IMCommon.view.menu.TextContextmenu',{value:b});break;case MsgType.ImgMsg:b=a.getAttribute('origin_path');d=a.getAttribute('fileName');var i=Ext.fly(a).query('img')[0],g=this.lookup('msgmrd_listAdv_all_list');c=Ext.create('IMCommon.view.menu.ImgContextmenu',{createAt:a.getAttribute('createAt'),value:b,path:b,fileName:d,openMore:!0,img:i,selectPlace:g,clsSelector:'img.msgRecord_img'});break;case MsgType.FileMsg:b=a.getAttribute('origin_path');d=a.getAttribute('fileName');c=Ext.create('IMCommon.view.menu.FileContextmenu',{value:b,path:b,fileName:d});break;case MsgType.LinkErp:b=a.getAttribute('content');c=Ext.create('IMCommon.view.menu.ErpLinkContextmenu',{value:b,linkObjType:a.getAttribute('linkObjType'),linkStgGuid:a.getAttribute('linkStgGuid'),linkKeyString:a.getAttribute('linkKeyString'),linkType:a.getAttribute('linkType')});break;default:break;}if(c){ParseUtil.menuShowAtVisible(c,f.getPoint())}f.preventDefault()}});Ext.define('IM.view.rightContainer.msgallReplay',{extend:'Ext.List',xtype:'msgallreply',controller:'msgallreplycontroller',requires:['Ext.panel.Resizer','IM.view.rightContainer.msgReplayList','IMCommon.model.MsgReplay','IM.view.rightContainer.msgallReplayController','IM.view.rightContainer.msgReplayEditor'],cls:'replayhead',store:{storeId:'msgReply',model:'IMCommon.model.MsgReplay'},selectable:!1,itemsFocusable:!1,itemTpl:'<div class="msgreply" style="border-bottom: solid 1px #cfcfcf; " >'+'<tpl if="values.type == \'G\'">'+'<a class="avatar link-avatar firstletter loaded">'+'<img src="{[AvatarMgr.getNavUserAvaUrlWOCache(values.senderid, 0)]}" onerror="AvatarMgr.doUserAvaErr(this)" ava-id="{senderid}">'+'</a>'+'</tpl>'+'<tpl if="values.MsgType == \'T\'">'+'<div class="replytitle ">{MsgContent}'+'</div>'+'<tpl if="values.Newreply == \'Y\'">'+'<div class="newreply" style="float: right;">新评论</div>'+'</tpl>'+'<tpl elseif="values.MsgType == \'I\'">'+'<div class="replytitle inOneline"><a>图片</a>'+'</div>'+'<tpl if="values.Newreply == \'Y\'">'+'<div class="newreply" style="float: right;">新评论</div>'+'</tpl>'+'<tpl elseif="values.MsgType == \'F\'">'+'<div class="replytitle inOneline"><a>文件</a>'+'</div>'+'<tpl if="values.Newreply == \'Y\'">'+'<div class="newreply" style="float: right;">新评论</div>'+'</tpl>'+'<tpl elseif="values.MsgType == \'L\'">'+'<div class="replytitle inOneline"><a>链接</a>'+'</div>'+'<tpl if="values.Newreply == \'Y\'">'+'<div class="newreply" style="float: right;">新评论</div>'+'</tpl>'+'<tpl elseif="values.MsgType == \'E\'">'+'<div class="replytitle inOneline"><a>大文件</a>'+'</div>'+'<tpl if="values.Newreply == \'Y\'">'+'<div class="newreply" style="float: right;">新评论</div>'+'</tpl>'+'</tpl>'+'<div class="reply_uname" style="margin-top: 4px;padding: 0px 43px;">{Sendername} 发表于 <a>{Displayname}</a> {[ParseUtil.handleShowTime(values.CreateAt)]}'+'</div>'+'</div>',listeners:{childtap:function(b,a){var h=this;if(Ext.fly(a.event.target).dom.tagName=='A'){var b=a.record.data;switch(Ext.fly(a.event.target).dom.innerHTML){case '图片':var g=ParseUtil.getLocalFileURL(ConfigMgr.getDataDirectory()+User.accountID+'/'+User.ownerID+'/'+b.filepath);var e=Config.httpUrlForGo+'files/'+b.fileid;var c=[];c.push({url:g,original:e,name:b.filename,createAt:b.filecreateat});var d=DesktopChatUtil.getCefObj();if(d){c=JSON.stringify(c);d.viewImages(c,0)};break;case '文件':var f=ConfigMgr.getDataDirectory()+User.accountID+'/'+User.ownerID+'/'+b.filepath;FileMgr.open(b.filepath)['catch'](function(c){FileMgr.open(f)});break;case '链接':DesktopChatUtil.openErpLink(b.linkobjtype+'',b.linkkeystring,b.linktype);break;case '大文件':FileMgr.open(b.bfilepath)['catch'](function(c){});break;case a.record.data.Displayname:ChatHelper.openChat(a.record.data.chat_id);break;default:break;}}else {if(Ext.fly(a.event.target).component){if(Ext.fly(a.event.target).component.getItemId()=='replylisteitor'){Ext.fly(a.event.target).component.el.dom.focus()}}else {LocalDataMgr.getMsgNewreply(a.record.data.RootID,function(g,f){if(f.rows.item(0).NewReply=='Y'){if(Ext.fly(a.event.target).parent().dom.children.length<5&&Ext.fly(a.event.target).parent().dom.className=='msgreply'||Ext.fly(a.event.target).dom.className=='msgreply'&&Ext.fly(a.event.target).dom.children.length<5){var e=Ext.widget('container',{controller:'msgallreplycontroller',requires:['IM.view.rightContainer.msgallReplayController','IM.view.rightContainer.msgReplayEditor'],cls:'wgtcontain',items:[{xtype:'component',itemId:'replycontentlist',scrollable:!0,height:'200px',tpl:'<tpl for="."><div style="margin-top:3px"><a class="avatar link-avatar firstletter loaded " style="float:left;">\n                                                <img src="{[AvatarMgr.getNavUserAvaUrlWOCache(values.UserID, 0)]}" onerror="AvatarMgr.doUserAvaErr(this)" ava-id="{UserID}">\n                                            </a>\n                                            <div style="display: flex;">\n                                                <div class="reply_uname inOneline" style="width: 120px;">{UserName} {[ParseUtil.handleMsgShowTime(values.UpdateAt)]}</div>\n                                                <div class="reply_list">\n                                                    <div class="reply_plain">{[ParseUtil.parseTextToHtml(values.Content)]}</div>\n                                                </div>\n                                            </div></div></tpl>'},{xtype:'msgreplyEditor',reference:'reply_editor',itemId:'replylisteitor',style:'height: 50px; border: solid 1px #cfcfcf;padding-bottom: 0px;'},{layout:'hbox',userCls:'desktop_reply_send',itemId:'replylistsend',items:[{xtype:'button',iconCls:'im-common-smile',ui:'flat',handler:'showEmjPanel'},{xtype:'component',flex:1},{xtype:'button',text:'回复(<span style="text-decoration: underline;">S</span>)',ui:'send-ui',width:66,height:24,handler:'onSendMsgReply'}]}]});var c=a.record.data.RootID;if(Ext.fly(a.event.target).dom.className=='msgreply'){Ext.fly(a.event.target).dom.append(e.el.dom)}else {Ext.fly(a.event.target).parent().dom.append(e.el.dom)}var d=Ext.getStore('msgReply').getById(c);if(d.data.Newreply=='Y'){if(Ext.fly(a.event.target).parent().dom.className=='msgreply'){Ext.fly(a.event.target).parent().dom.querySelector('.newreply').remove();Ext.fly(a.event.target).parent().dom.querySelector('.replytitle').style['-webkit-line-clamp']='unset'}else {Ext.fly(a.event.target).dom.querySelector('.newreply').remove();Ext.fly(a.event.target).dom.querySelector('.replytitle').style['-webkit-line-clamp']='unset'}if(d.data.senderid==User.ownerID){ChatUtil.viewReply(d.data.chat_id,c,function(){},function(c){})}else {LocalDataMgr.viewReply(d.data.RootID)}}if(Ext.ComponentQuery.query('#replycontentlist')[0].getData()!=null){Ext.ComponentQuery.query('#replycontentlist')[0].parent.destroy()}LocalDataMgr.getMsgReplycontent(c,function(j,i){var h=0,d=i.rows,e=d.length;if(e>0){h=d.item(e-1).ReplySeq}ChatUtil.getUnreadMsgReply(c,h,function(c){},function(){})})}}else {if(Ext.fly(a.event.target).parent().dom.children.length<4&&Ext.fly(a.event.target).parent().dom.className=='msgreply'||Ext.fly(a.event.target).dom.className=='msgreply'&&Ext.fly(a.event.target).dom.children.length<4){var e=Ext.widget('container',{controller:'msgallreplycontroller',requires:['IM.view.rightContainer.msgallReplayController','IM.view.rightContainer.msgReplayEditor'],cls:'wgtcontain',items:[{xtype:'component',itemId:'replycontentlist',scrollable:!0,height:'200px',tpl:'<tpl for="."><div style="margin-top:3px"><a class="avatar link-avatar firstletter loaded " style="float:left;">\n                                                <img src="{[AvatarMgr.getNavUserAvaUrlWOCache(values.UserID, 0)]}" onerror="AvatarMgr.doUserAvaErr(this)" ava-id="{UserID}">\n                                            </a>\n                                            <div style="display: flex;">\n                                                <div class="reply_uname inOneline" style="width: 120px;">{UserName} {[ParseUtil.handleMsgShowTime(values.UpdateAt)]}</div>\n                                                <div class="reply_list">\n                                                    <div class="reply_plain">{[ParseUtil.parseTextToHtml(values.Content)]}</div>\n                                                </div>\n                                            </div></div></tpl>'},{xtype:'msgreplyEditor',reference:'reply_editor',itemId:'replylisteitor',style:'height: 50px; border: solid 1px #cfcfcf;padding-bottom: 0px;'},{layout:'hbox',userCls:'desktop_reply_send',itemId:'replylistsend',items:[{xtype:'button',iconCls:'im-common-smile',ui:'flat',handler:'showEmjPanel'},{xtype:'component',flex:1},{xtype:'button',text:'回复(<span style="text-decoration: underline;">S</span>)',ui:'send-ui',width:66,height:24,handler:'onSendMsgReply'}]}]});var c=a.record.data.RootID;if(Ext.fly(a.event.target).dom.className=='msgreply'){Ext.fly(a.event.target).dom.append(e.el.dom)}else {Ext.fly(a.event.target).parent().dom.append(e.el.dom)}var d=Ext.getStore('msgReply').getById(c);if(f.rows.item(0).NewReply=='Y'){if(Ext.fly(a.event.target).parent().dom.className=='msgreply'){Ext.fly(a.event.target).parent().dom.querySelector('.newreply').remove()}else {Ext.fly(a.event.target).dom.querySelector('.newreply').remove()}if(d.data.senderid==User.ownerID){ChatUtil.viewReply(d.data.chat_id,c,function(){},function(c){})}else {LocalDataMgr.viewReply(d.data.RootID)}}if(Ext.fly(a.event.target).parent().dom.className=='msgreply'){Ext.fly(a.event.target).parent().dom.querySelector('.replytitle').style['-webkit-line-clamp']='unset'}else {Ext.fly(a.event.target).dom.querySelector('.replytitle').style['-webkit-line-clamp']='unset'}if(Ext.ComponentQuery.query('#replycontentlist')[0].getData()!=null){Ext.ComponentQuery.query('#replycontentlist')[0].parent.destroy()}LocalDataMgr.getMsgReplycontent(c,function(j,i){var h=0,d=i.rows,e=d.length;if(e>0){h=d.item(e-1).ReplySeq}ChatUtil.getUnreadMsgReply(c,h,function(c){},function(){})})}else {if(Ext.fly(a.event.target).parent().dom.className=='msgreply'||Ext.fly(a.event.target).dom.className=='msgreply'){if(Ext.fly(a.event.target).parent().dom.className=='msgreply'){Ext.fly(a.event.target).parent().dom.querySelector('.replytitle').style['-webkit-line-clamp']='3'}else {Ext.fly(a.event.target).dom.querySelector('.replytitle').style['-webkit-line-clamp']='3'}if(Ext.ComponentQuery.query('#replycontentlist')[0].getData()!=null){Ext.ComponentQuery.query('#replycontentlist')[0].parent.destroy()}}}}})}}}}});Ext.define('IM.view.rightContainer.msgReplay',{extend:'Ext.Container',xtype:'msgreplay',controller:'msgallreplycontroller',requires:['IM.view.chat.ChatView','IM.view.chat.ChatInput','Ext.panel.Resizer','IM.view.rightContainer.msgReplayList','IMCommon.model.Reply','IM.view.rightContainer.msgallReplay','IM.view.rightContainer.chatView.Group','IM.view.rightContainer.msgallReplayController'],viewModel:{},layout:'vbox',uses:['IM.view.widget.MrdDatePanel'],cls:'rightreply',flex:1,items:[{xtype:'container',layout:'hbox',userCls:'right-title',items:[{xtype:'component',flex:1,html:'消息回复'}]},{xtype:'tabpanel',reference:'tabpanel',flex:1,cls:'msgreplytab',tabBar:{docked:'bottom',layout:{pack:'center'}},items:[{title:'全部',xtype:'msgallreply'},{title:'关于我的',xtype:'aboutmereply'},{title:'我参与的',xtype:'msgmyreply'}],listeners:{activeItemchange:'onMsgReplyTabChanges'}}]});Ext.define('IM.view.rightContainer.msgTab.FileTab',{extend:'Ext.List',xtype:'msg_file_tab',cls:'mrd_fileList',store:{fields:['baseID','fileID','fileName','fileSize','createAt']},itemTpl:['<div class="mrd_fileList_fileIcon {[ParseUtil.getFileIcon(values.fileName)]}"></div>','<div class="mrd_file_font">{[Utils.date2Str(values.createAt)]}</div>','<div>','<div class="mrd_fileName">{fileName}</div>','<div class="mrd_fileSize">{fileSize:fileSize}</div>','</div>'].join(''),initialize:function(){var a=this;a.callParent(arguments);a.element.on({delegate:'.x-listitem',contextmenu:'onFileContextmenu',scope:a})},onFileContextmenu:function(c){var d=c.currentTarget;if(!d){return}var i=this;var f=i.getStore();var e=d.getAttribute('data-recordindex');var b=f.getAt(e);if(!b){return}var a=b.get('filePath');var h=/file:[\/]+/g;if(!h.test(a)){a=ConfigMgr.getDefaultDir()+a}var g=Ext.create('IMCommon.view.menu.FileContextmenu',{value:a,path:a,fileName:b.get('fileName')});ParseUtil.menuShowAtVisible(g,c.getPoint());c.preventDefault()}});Ext.define('IM.view.rightContainer.msgTab.MsgAll',{extend:'Ext.List',xtype:'msg_all_tab',uses:['IMCommon.view.menu.TextContextmenu','IMCommon.view.menu.ImgContextmenu','IMCommon.view.menu.FileContextmenu','IMCommon.view.menu.ErpLinkContextmenu'],cls:'mrd_msgAllList',store:{storeId:'mrdMsgAllList',fields:['msgID',{name:'updateTime',type:'int'},'senderID','senderName','content','msgType','fileName','fileSize','filePath']},emptyText:'暂无记录',itemTpl:['<tpl if="values.msgType == \'R\'">','<tpl elseif="values.msgType == \'S\'">','<tpl else>','<div class="msgRecord_imitate_list">','<div class="msgRecord_title" style="color:{[values.senderID == User.ownerID ? \'blue\' : \'\']}">{senderName} {[Utils.datetime2Ago(values.updateTime,true)]}</div>','<div class="msgRecord_content" {[ParseHelper.pushInfoToDom1(values)]}>','<tpl if="values.msgType == \'T\'">','{[window.minEmoji(values.content)]}','<tpl elseif="values.msgType == \'N\'">','{[ParseUtil.getSureName(values.senderID)]}修改了群公告&nbsp;','<tpl elseif="values.msgType == \'I\'">','<img class="msgRecord_img" src="{[ParseUtil.getLoadedNativePath(values.filePath)]}">','<tpl elseif="values.msgType == \'F\'">','<div class="msgRecord_file">','<div class="mrd_fileWrapper">','<div class="mrd_fileIcon {[ParseUtil.getFileIcon(values.fileName)]}"></div>','<div class="mrd_fileName">{fileName}</div>','<div>{fileSize:fileSize}</div>','</div>','</div>','<tpl elseif="values.msgType == \'G\'">','{content}','<tpl elseif="values.msgType == \'L\'">','<div class="msgRecord_link">','<div class="mrd_linkIcon" letter="{linkType}"></div>','<div class="mrd_linkName">{linkTitle}</div>','</div>','<tpl else>','消息类型未适配：{msgType}','</tpl>','</div>','</div>','</tpl>'].join(''),initialize:function(){var a=this;a.callParent(arguments);a.getScrollable().on({scroll:'onChgScrol',scope:a});a.on({childTap:'onCT',scope:a});a.element.on({delegate:'.msgRecord_content',contextmenu:'onMrdContextmenu',scope:a})},onChgScrol:function(b,o,l,m,n){if(l===0){console.log('滚动到顶部');if(User.isMrdSearch){return}if(!b.autoTop){var h=this;var c=h.getStore(),a=c.getAt(0);if(!a){return}b.autoTop=!0;console.log('查询');var f=a.get('chatID'),d=a.get('updateTime');LocalDataMgr.getOldMsgWoNotShow(f,d,function(k,j){var g=j.rows,i=g.length;var f=[];for(var e=i-1;e>=0;e--){var d=g.item(e);f.push({chatID:d.ChatID,msgID:d.MsgID,msgType:d.MsgType,senderID:d.SenderID,senderName:d.SenderName,updateTime:d.CreateAt,content:d.Content,fileName:d.FileName,fileSize:d.FileSize,filePath:d.FilePath})}c.insert(0,f);h.scrollToRecord(a);b.autoTop=!1},function(){console.error('向上滚动时，查询数据出错');b.autoTop=!1})}}var e=b.getScrollElement().dom,j=e.scrollHeight,k=e.scrollTop,i=e.offsetHeight;if(j<=k+i){if(User.isMrdSearch){return}if(!b.autoBottom){var g=this;var c=g.getStore(),a=c.last();if(!a){return}b.autoBottom=!0;var f=a.get('chatID'),d=a.get('updateTime');LocalDataMgr.getMoreEndHisWoNotShow(f,d,function(k,j){var h=j.rows,i=h.length;var f=[];for(var e=0;e<i;e++){var d=h.item(e);f.push({chatID:d.ChatID,msgID:d.MsgID,msgType:d.MsgType,senderID:d.SenderID,senderName:d.SenderName,updateTime:d.CreateAt,content:d.Content,fileName:d.FileName,fileSize:d.FileSize,filePath:d.FilePath})}c.add(f);g.scrollToRecord(a);b.autoBottom=!1},function(){console.error('向下滚动时，查询数据出错');b.autoBottom=!1})}}},onCT:function(f,e){var d=e.record;if(!d){return}var b=d.get('updateTime');if(!b){return}var c=User.crtChannelId;if(!c){return}var a=Ext.getStore(c);if(!a){return}LocalDataMgr.getHistoryContext(c,b,function(h,i){a.removeAll();User.isMrdSearch=!0;var d=a.add(h);var g;for(var c=0;c<d.length;c++){if(d[c].get('updateTime')==b){g=d[c]}}if(g){ViewGet.getMsgView().scrollToRecord(g)}else {AddDataUtil.onScrolMsgView()}User.isMrdSearch=!1})},onMrdContextmenu:function(e){var a=e.currentTarget;if(!a){return}var c,b,d;var f=a.getAttribute('type');switch(f){case MsgType.TextMsg:b=a.getAttribute('content');c=Ext.create('IMCommon.view.menu.TextContextmenu',{value:b});break;case MsgType.ImgMsg:b=a.getAttribute('origin_path');d=a.getAttribute('fileName');c=Ext.create('IMCommon.view.menu.ImgContextmenu',{value:b,path:b,fileName:d});break;case MsgType.FileMsg:b=a.getAttribute('origin_path');d=a.getAttribute('fileName');c=Ext.create('IMCommon.view.menu.FileContextmenu',{value:b,path:b,fileName:d});break;case MsgType.LinkErp:b=a.getAttribute('content');c=Ext.create('IMCommon.view.menu.ErpLinkContextmenu',{value:b,linkObjType:a.getAttribute('linkObjType'),linkStgGuid:a.getAttribute('linkStgGuid'),linkKeyString:a.getAttribute('linkKeyString'),linkType:a.getAttribute('linkType')});break;default:break;}if(c){ParseUtil.menuShowAtVisible(c,e.getPoint())}e.preventDefault()}});Ext.define('IM.view.rightContainer.msgTab.PicTab',{extend:'Ext.List',xtype:'msg_pic_tab',store:{fields:['baseID','fileID','chatID','createAt','filePath']},itemTpl:['<div class="msgRecord_pic_frame" {[ParseHelper.getImgDomAttr(values.filePath,values.createAt,values.fileName)]}>','<div class="msgRecord_pic_block">','<img src="{[ParseUtil.getLoadedNativePath(values.filePath)]}">','</div>','<div style="text-align: center;">{[Utils.date2Str(values.createAt)]}</div>','</div>'].join(''),initialize:function(){var a=this;a.callParent(arguments);a.element.on({delegate:'.msgRecord_pic_frame',contextmenu:'onContextmenu',scope:a})},onContextmenu:function(b){var a=b.currentTarget;if(!a){return}var c=Ext.create('IMCommon.view.menu.ImgContextmenu',{value:a.getAttribute('origin_path'),path:a.getAttribute('origin_path'),fileName:a.getAttribute('fileName')});ParseUtil.menuShowAtVisible(c,b.getPoint());b.preventDefault()}});Ext.define('IM.view.rightContainer.msgmyReplay',{extend:'Ext.List',xtype:'msgmyreply',controller:'msgallreplycontroller',requires:['Ext.panel.Resizer','IM.view.rightContainer.msgReplayList','IMCommon.model.MsgReplay','IM.view.rightContainer.msgReplayEditor'],cls:'replayhead',store:{storeId:'msgmyReply',model:'IMCommon.model.MsgReplay'},selectable:!1,itemsFocusable:!1,itemTpl:'<div class="msgreply" style="border-bottom: solid 1px #cfcfcf; " >'+'<tpl if="values.type == \'G\'">'+'<a class="avatar link-avatar firstletter loaded">'+'<img src="{[AvatarMgr.getNavUserAvaUrlWOCache(values.senderid, 0)]}" onerror="AvatarMgr.doUserAvaErr(this)" ava-id="{senderid}">'+'</a>'+'</tpl>'+'<tpl if="values.MsgType == \'T\'">'+'<div class="replytitle inOneline">{MsgContent}'+'</div>'+'<tpl elseif="values.MsgType == \'I\'">'+'<div class="replytitle inOneline"><a>图片</a>'+'</div>'+'<tpl elseif="values.MsgType == \'F\'">'+'<div class="replytitle inOneline"><a>文件</a>'+'</div>'+'<tpl elseif="values.MsgType == \'L\'">'+'<div class="replytitle inOneline"><a>链接</a>'+'</div>'+'<tpl elseif="values.MsgType == \'E\'">'+'<div class="replytitle inOneline"><a>大文件</a>'+'</div>'+'</tpl>'+'<div class="reply_uname" style="margin-top: 4px;padding: 0px 43px;">{Sendername} 发表于 <a>{Displayname}</a> {[ParseUtil.handleShowTime(values.CreateAt)]}'+'</div>'+'</div>',listeners:{childtap:function(b,a){var j=this;if(Ext.fly(a.event.target).dom.tagName=='A'){var b=a.record.data;switch(Ext.fly(a.event.target).dom.innerHTML){case '图片':var i=ParseUtil.getLocalFileURL(ConfigMgr.getDataDirectory()+User.accountID+'/'+User.ownerID+'/'+b.filepath);var g=Config.httpUrlForGo+'files/'+b.fileid;var c=[];c.push({url:i,original:g,name:b.filename,createAt:b.filecreateat});var e=DesktopChatUtil.getCefObj();if(e){c=JSON.stringify(c);e.viewImages(c,0)};break;case '文件':var h=ConfigMgr.getDataDirectory()+User.accountID+'/'+User.ownerID+'/'+b.filepath;FileMgr.open(b.filepath)['catch'](function(c){FileMgr.open(h)});break;case '链接':DesktopChatUtil.openErpLink(b.linkobjtype+'',b.linkkeystring,b.linktype);break;case '大文件':FileMgr.open(b.bfilepath)['catch'](function(c){});break;case a.record.data.Displayname:ChatHelper.openChat(a.record.data.chat_id);break;default:break;}}else {if(Ext.fly(a.event.target).component){if(Ext.fly(a.event.target).component.getItemId()=='replylisteitor'){Ext.fly(a.event.target).component.el.dom.focus()}}else {if(Ext.fly(a.event.target).parent().dom.children.length<4&&Ext.fly(a.event.target).parent().dom.className=='msgreply'||Ext.fly(a.event.target).dom.className=='msgreply'&&Ext.fly(a.event.target).dom.children.length<4){var f=Ext.widget('container',{controller:'msgallreplycontroller',requires:['IM.view.rightContainer.msgallReplayController','IM.view.rightContainer.msgReplayEditor'],cls:'wgtcontain',items:[{xtype:'component',itemId:'replycontentlist',scrollable:!0,height:'200px',tpl:'<tpl for="."><div style="margin-top:3px"><a class="avatar link-avatar firstletter loaded " style="float:left;">\n                                                <img src="{[AvatarMgr.getNavUserAvaUrlWOCache(values.UserID, 0)]}" onerror="AvatarMgr.doUserAvaErr(this)" ava-id="{UserID}">\n                                            </a>\n                                            <div style="display: flex;">\n                                                <div class="reply_uname inOneline" style="width: 120px;">{UserName} {[ParseUtil.handleMsgShowTime(values.UpdateAt)]}</div>\n                                                <div class="reply_list">\n                                                    <div class="reply_plain">{[ParseUtil.parseTextToHtml(values.Content)]}</div>\n                                                </div>\n                                            </div></div></tpl>'},{xtype:'msgreplyEditor',reference:'reply_editor',itemId:'replylisteitor',style:'height: 50px; border: solid 1px #cfcfcf;padding-bottom: 0px;'},{layout:'hbox',userCls:'desktop_reply_send',itemId:'replylistsend',items:[{xtype:'button',iconCls:'im-common-smile',ui:'flat',handler:'showEmjPanel'},{xtype:'component',flex:1},{xtype:'button',text:'回复(<span style="text-decoration: underline;">S</span>)',ui:'send-ui',width:66,height:24,handler:'onSendMsgReply'}]}]});var d=a.record.data.RootID;if(Ext.fly(a.event.target).dom.className=='msgreply'){Ext.fly(a.event.target).dom.append(f.el.dom)}else {Ext.fly(a.event.target).parent().dom.append(f.el.dom)}if(Ext.fly(a.event.target).parent().dom.className=='msgreply'){Ext.fly(a.event.target).parent().dom.querySelector('.replytitle').style['-webkit-line-clamp']='unset'}else {Ext.fly(a.event.target).dom.querySelector('.replytitle').style['-webkit-line-clamp']='unset'}if(Ext.ComponentQuery.query('#replycontentlist')[0].getData()!=null){Ext.ComponentQuery.query('#replycontentlist')[0].parent.destroy()}LocalDataMgr.getMsgReplycontent(d,function(h,g){var f=0,c=g.rows,e=c.length;if(e>0){f=c.item(e-1).ReplySeq}ChatUtil.getUnreadMsgReply(d,f,function(c){},function(){})})}else {if(Ext.fly(a.event.target).parent().dom.className=='msgreply'||Ext.fly(a.event.target).dom.className=='msgreply'){if(Ext.ComponentQuery.query('#replycontentlist')[0].getData()!=null){Ext.ComponentQuery.query('#replycontentlist')[0].parent.destroy()}if(Ext.fly(a.event.target).parent().dom.className=='msgreply'){Ext.fly(a.event.target).parent().dom.querySelector('.replytitle').style['-webkit-line-clamp']='3'}else {Ext.fly(a.event.target).dom.querySelector('.replytitle').style['-webkit-line-clamp']='3'}}}}}}}});Ext.define('IM.view.widget.MrdDatePanel',{extend:'Ext.panel.Date',xtype:'mrdDatePanel',cls:'mrdCalendar',animation:!1,floated:!0,width:252,height:340,scrollable:!1,hidden:!0,headerFormat:{$value:'Y M',cached:!0},previousYear:null,nextYear:null,initialize:function(){var a=this,b=a.getValue();a.callParent(arguments);a.on({show:'onShowPanel',hide:'onHidePanel',scope:a});a.bodyElement.on({click:{delegate:a.cellSelector,fn:'onSelDate'},scope:a})},onSelDate:function(d){var a=this,b=d.getTarget(a.cellSelector,a.bodyElement),c=b&&b.date;Ext.fly(b).addCls('mySelectedCls');a.fireEvent('selDate',a,c)},updateValue:function(c,a){this.callParent(arguments);if(a){var b=this.getCellByDate(a);if(b){Ext.fly(b).removeCls('mySelectedCls')}}},onShowPanel:function(b){var a=this;a.touchListeners=Ext.getDoc().on({touchstart:a.collapseIf,scope:a,delegated:!1,destroyable:!0})},collapseIf:function(b){var a=this;if(!a.destroyed&&!a.owns(b.target)){a.hide()}},onHidePanel:function(a){Ext.destroy(this.touchListeners)},doDestroy:function(){Ext.destroy(this.touchListeners);this.callParent()}});