Ext.define(null,{override:'Ext.dataview.NestedList'});Ext.define(null,{override:'Ext.NavigationView',privates:{beforePop:function(a){var f=this,c=f.getInnerItems(),e,b,g,d;if(Ext.isString(a)||Ext.isObject(a)){e=c.length-1;for(b=e;b>=0;b--){if(Ext.isString(a)&&Ext.ComponentQuery.is(c[b],a)||Ext.isObject(a)&&a==c[b]){a=e-b;break}}if(!Ext.isNumber(a)){return !1}}g=c.length;if(!Ext.isNumber(a)||a<1){a=1}a=Math.min(a,g-1);if(a){if(f.getNavigationBar()){f.getNavigationBar().beforePop(a)}d=c.splice(-a,a-1);for(b=0;b<d.length;b++){this.remove(d[b])}return !0}return !1},doResetActiveItem:function(b){var a=this,d=a.getInnerItems(),c=a.getLayout().getAnimation();if(b>0){if(c&&c.isAnimation){c.setReverse(!0)}a.setActiveItem(b-1);if(a.getNavigationBar()){a.getNavigationBar().onViewRemove(a,d[b],b)}}}}});Ext.define('IMMobile.model.ChatOrg',{extend:'Ext.data.Model',fields:[{name:'name',type:'string'}]});Ext.define('IMMobile.model.ChatView',{extend:'Ext.data.Model',fields:['msg_id','wrapper_type',{name:'create_at',type:'date',convert:function(a){return Utils.datetime2Ago(a,!0)}},'user_id','msg_type','att_id','is_receipt','message',{name:'showTime',type:'bool',defaultValue:!0}]});Ext.define('IMMobile.model.RecentChatList',{extend:'Ext.data.Model',idProperty:'chat_id',fields:['chat_id',{name:'create_at',type:'date'},{name:'update_at',type:'date'},{name:'delete_at',type:'date'},{name:'last_post_at',type:'date'},'chat_name','header','purpose','chat_type','is_manual','creator_id','manager_id','chat_status',{name:'unread_count',type:'int',defaultValue:0},'mention_count',{name:'member_delete_at',type:'date'},'user_id',{name:'last_view_at',type:'date'},'is_top','is_hidden']});Ext.define('IMMobile.store.ChatOrg',{extend:'Ext.data.TreeStore',alias:'store.ChatOrg',rootData:[{text:'Groceries',items:[{text:'Drinks',items:[{text:'Water',items:[{text:'Sparkling',leaf:!0},{text:'Still',leaf:!0}]},{text:'Coffee',leaf:!0},{text:'Espresso',leaf:!0},{text:'Redbull',leaf:!0},{text:'Coke',leaf:!0},{text:'Diet Coke',leaf:!0}]},{text:'Fruit',items:[{text:'Bananas',leaf:!0},{text:'Lemon',leaf:!0}]},{text:'Snacks',items:[{text:'Nuts',leaf:!0},{text:'Pretzels',leaf:!0},{text:'Wasabi Peas',leaf:!0}]}]}],defaultRootProperty:'items',fields:[{name:'name',type:'string'}],constructor:function(a){a=Ext.apply({root:Ext.clone(this.rootData)},a);this.callParent([a])}});Ext.define('IMMobile.store.RecentChatList',{extend:'Ext.data.Store',alias:'store.RecentChatList',requires:['IMMobile.model.RecentChatList'],model:'IMMobile.model.RecentChatList',sorters:[{property:'is_top',direction:'DESC'},{property:'last_post_at',direction:'DESC'}]});Ext.define('IMMobile.utils.MobileHelper',{alternateClassName:'MobileHelper',singleton:!0,hashArray:[],openInterval:function(){var a=this;a.getUserState();if(!a.stateInterval){a.stateInterval=setInterval(function(){a.getUserState()},2*60*1000)}},getUserState:function(b,a){var d=this;if(!b){b=[];if(User.allUsers.length==0){return}for(var c=0;c<User.allUsers.length;c++){b.push(User.allUsers[c].user_id)}}Utils.custAjax('POST','status/ids',{params:JSON.stringify(b),success:function(c){d.initHashArray(c);d.changeCurrentChat();if(a){a(c)}},failure:function(c){if(a){a(c)}}})},initHashArray:function(a){var d=this;if(a.length>0){for(var b=0;b<a.length;b++){var c=a[b];d.hashArray[c.user_id]=c}}},changeCurrentChat:function(){var b=User.crtChannelId;if(b){var c=Ext.getStore('comRct').getById(b);if(c&&c.get('type')=='D'){var d=c.get('avaID'),f=MobileHelper.stateConverStr(d),a=Ext.Viewport.down('chatview'),e=a?a.getViewModel():null;if(d&&e&&a.config.chatid==b){e.setData({stateStr:f})}}}},stateConverStr:function(c){var b=this;if(Object.keys(b.hashArray).length>0){var a=b.hashArray[c];if(a['pc_online']=='Y'){return '电脑在线'}else {if(a['mobile_online']=='Y'){return '手机在线'}}}return '离线'},stateByUserIsOnline:function(d,a){var c=this;if(Object.keys(c.hashArray).length>0){var b=c.hashArray[d];if(b['pc_online']=='Y'||b['mobile_online']=='Y'){if(a){return 1}return !0}}if(a){return 0.5}return !1},specialTitleHideTiming:function(){var a=this.getMobile();return a.loadedUnread&&a.logined&&a.wsConned},calculateWsCntTimeOut:function(){var a=this;if(a.timer){clearTimeout(a.timer);WebSocketUtil.connTimeOut=!1}a.timer=setTimeout(function(){var b=a.getMobile();WebSocketUtil.connTimeOut=!0;if(b.down('#disconnectInfo').isHidden()){b.down('#disconnectInfo').show()}},30*1000)},clearWsCntTimeOut:function(){var a=this;clearTimeout(a.timer)},getMobile:function(){return Ext.Viewport.down('IMMobile')},getChatType:function(a){var b='SELECT * FROM IMChat WHERE ChatID=?';LocalDataMgr.cExecSqlWithP(b,[a],function(d,c){var b=c.rows;if(b.length>0){User.crtChannelType=b.item(0).ChatType}})}});Ext.define('IMMobile.utils.OutBoxUpFile',{alternateClassName:'OutBoxUpFile',singleton:!0,upMap:{},pushFileToQue:function(c){var a=c.chat_id,b=!1;if(!OutBoxUpFile[a]){OutBoxUpFile[a]=[];b=!0}OutBoxUpFile[a].push(c);if(b){OutBoxUpFile.upFile(OutBoxUpFile[a].shift())}},upFiles:function(c){var j=c.files,d=c.chat_id,i=c.attach_id,e=c.msg_id;var a=new FormData();a.append('files',j[0]);a.append('client_ids','');a.append('chat_id',d);a.append('file_id',i);a.append('is_origins','Y');var f=encodeURI(Config.httpUrlForGo+'files?token='+User.token);var b=new XMLHttpRequest();b.open('post',f,!0);b.upload.addEventListener('progress',function(a){if(a.lengthComputable){var b=(a.loaded/a.total*100).toFixed(2)}},!1);var h=function(a){UpFileMgr.setPageStus(d,e,{fileStatus:5})};var g=function(){UpFileMgr.setPageStus(d,e,{fileStatus:1,failMsg:'文件上传失败，<a class="file_re_upload">重新上传</a>'})};b.addEventListener('readystatechange',function(){var a=b;if(a.status==201&&a.readyState==4){h()}else {g()}});b.send(a)},doQueueUp:function(a){if(OutBoxUpFile[a]){var b=OutBoxUpFile[a].shift();if(b){OutBoxUpFile.upFile(b)}else {delete OutBoxUpFile[a]}}}});Ext.define('IMMobile.view.IMMobileMain.tabPanel.IMMobileChatController',{extend:'Ext.app.ViewController',alias:'controller.IMMobileChatController',requires:['IMCommon.local.InitDb'],uses:['IMMobile.view.chatView.ChatView','IMMobile.view.group.GroupSelList'],onActivate:function(){},getUnreadChats:function(a){Utils.custAjax('GET','users/me/chats/unread',{success:function(c){if(c){console.log('未读会话',c);LocalDataMgr.initUpdateChats(c);var b,e;for(var d=0;d<c.length;d++){b=c[d].chat,e=b.chat_type==ChatType.Direct?ParseUtil.parseDirectChatName(c[d],User.ownerID):b.header;a.insert(0,{chat_id:b.chat_id,name:e,type:b.chat_type,status:-2,isUnRead:b.unread_count>0,unReadNum:b.unread_count,last_post_at:b.last_post_at,last_post_userName:b.last_sender_name,last_msg_type:b.last_msg_type,last_post_msg:ParseUtil.replaceBrNbsp(b.last_message),members:c[d].members})}}}})},getAllChats:function(){var a=this;var b=a.getView();Utils.mask(b);Utils.custAjax('get','users/me/chats',{success:function(c){console.log('所有频道：',c);a.pushChatToCache(c);a.bindAllChats();Utils.unMask(b)}})},onSelChatList:function(c,a){var b=a.record.data.chat_id;User.lastChatId=User.crtChannelId;User.crtChannelId=b;User.crtChatName=a.record.data.name;if(a.record.data.chat_id==StaticChatID.News){Redirect.redirectTo('newsview',{chatid:StaticChatID.News})}else {if(a.record){MobileHelper.getChatType(b);Redirect.redirectTo('chatview',{chatid:b,chatname:a.record.data.name})}}},setUnReadToRead:function(a){Utils.custAjax('post','chats/members/'+User.ownerID+'/view',{params:JSON.stringify({chat_id:a.data.id}),success:function(b){if(b.Status=='OK'){a.set('isUnRead',!1);a.set('unReadNum',0);PushNotification.resetBadgeNum()}}})},onStartGrpChat:function(){var a=this;Redirect.redirectTo('userselectview',{stype:'A'})},onAllRead:function(){ChatUtil.viewNews();Utils.custAjax('PUT','chats/allread',{success:function(){LocalDataMgr.rctSetAllRead();var a=Ext.StoreMgr.get('comRct');if(a){a.each(function(a){a.set('unReadNum',0);a.set('isUnRead',!1)})}PushNotification.clearBadgeNum()}})},onScan:function(){var a=this,b=a.getView();if(!window.cordova){return}Config.ChooseFile='Y';cordova.plugins.barcodeScanner.scan(function(c){Config.ChooseFile='N';if(c.cancelled){return}if(c.format=='QR_CODE'){var b=c.text;if(Ext.isEmpty(b)){return}var d=!1;if(b.substr(0,4).toLowerCase()=='http'){d=!0;cordova.InAppBrowser.open(b,'_system')}else {if(b.substr(0,5).toLowerCase()=='host|'){}else {if(b.substr(0,2)=='01'&&(b.substr(3,2)=='10'||b.substr(3,2)=='04'||b.substr(3,2)=='01')){a.fireEvent('openModule','piaoju',b)}else {Redirect.redirectTo('errPrompt',{text:b})}}}}},function(a){Config.ChooseFile='N';Utils.alert('扫码错误: '+a)},{'showFlipCameraButton':!0})},onSetRest:function(){var c=this.getView();if(User.restFun){clearTimeout(User.restFun);User.restFun=null}var a=Date.now();var b=a+1000*60*60;Utils.custAjax('PUT','users/me/nap',{params:JSON.stringify({nap_type:'3',nap_end:b+''}),success:function(){var b=c.down('#restInfo');b.show();localStorage.setItem(User.accountID+'_'+User.ownerID+'resttime',a);User.restFun=setTimeout(function(){b.hide();User.restFun=null},600000)},failure:function(a){Utils.toastShort(a)}})},onShowDisInfo:function(b,e){var d=this.getView();var a=b.retryTime;var c='hiding';if(Config.newLoginWays){c=''}if(WebSocketUtil.connTimeOut){b.setHtml('<div>连接超时,正在继续请求连接... <a class="change-route '+c+'">[切换线路]</a></div>')}else {b.setHtml('<div>连接已断开,'+Math.round(a/1000)+'秒后重连 <a class="change-route '+c+'">[切换线路]</a></div>');d.setDisinfo=setInterval(function(){a=a-1000;if(a>0){b.setHtml('<div>连接已断开,'+Math.round(a/1000)+'秒后重连 <a class="change-route '+c+'">[切换线路]</a></div>')}else {clearInterval(d.setDisinfo);d.setDisinfo=null;b.setHtml('连接已断开,正在尝试连接... <a class="change-route '+c+'">[切换线路]</a>')}},1000)}},onHideDisInfo:function(d,e){var a=this;var b=this.getView();if(b.setDisinfo){clearInterval(this.getView().setDisinfo);b.setDisinfo=null}if(a.newRoute){var c=b.up('IMMobile');window.RouteList.updateCurRoute(a.newRoute);localStorage.setItem('serverUrl',a.newRoute.routeUrl);if(c.hasSpecialTitle&&window.MobileHelper.specialTitleHideTiming()){c.hasSpecialTitle=!1;c.down('IMMobile-Chat').down('IMMobile-Navbar').setTitle('消息')}delete a.newRoute;delete a.fromRouteID;delete a.currentRouteID}},onDisInfoClick:function(c){var b=this.getView();var d=Ext.fly(c.target);var a='hiding';if(Config.newLoginWays){a=''}if(d.is('a')){this.chgRoute()}if(WebSocketUtil.connTimeOut){b.down('#disconnectInfo').setHtml('<div>连接超时,正在继续请求连接... <a class="change-route '+a+'">[切换线路]</a></div>')}else {b.down('#disconnectInfo').setHtml('<div>连接已断开,正在尝试连接... <a class="change-route '+a+'">[切换线路]</a></div>')}WebSocketUtil.pause();WebSocketUtil.initialize(Config.wsGoUrl)},chgRoute:function(){var a=this;var c=Ext.decode(localStorage.getItem('currentRoute')),d=c.isDemo;a.fromRouteID=c.routeID;if(d=='Y'){a.fromRouteID=c.demoRouteID}var b=window.RouteList.nextRoute(a.currentRouteID||a.fromRouteID,d,a.fromRouteID);if(b){a.currentRouteID=b.routeID;a.newRoute=b;Config.httpUrlForGo=Utils.joinPath(b.routeUrl,'api/v1/');Config.wsGoUrl=Utils.joinPath(b.routeUrl.replace('http','ws'),'api/v1/websocket')}},onRestClick:function(){var b=this,a=b.getView();Utils.custAjax('PUT','users/me/nap',{params:JSON.stringify({nap_type:'0',nap_end:'0'}),success:function(){var b=a.down('#restInfo');b.hide();localStorage.removeItem(User.accountID+'_'+User.ownerID+'resttime');User.restFun=null;if(User.restFun){User.restFun=null;clearTimeout(User.restFun)}},failure:function(a){Utils.toastShort(a)}})},onRctActions:function(c,b,a){var d=this;if(a=='top'||a=='untop'){d.onSetChatTop(c,b)}else {if(a=='delete'){d.onRemoveChat(c,b)}else {if(a=='keep'){this.onAddFav(c,b)}else {if(a=='unkeep'){this.onRemoveFav(c,b)}}}}},onSetChatKeep:function(b,a){var c=a.data.keep;if(c){this.onRemoveFav(b,a)}else {this.onAddFav(b,a)}},onAddFav:function(c,a){var b=a.get('chat_id');Utils.custAjax('POST','chatfavorite',{params:Ext.encode({chat_id:b,user_id:User.ownerID,fav_name:a.data.name}),success:function(){User.favChanged=!1;User.favChats.push({chat_id:a.data.chat_id,user_id:User.ownerID,fav_name:a.data.name,fav_index:User.favChats.length+1,create_at:a.data.create_at,header:a.data.name,chat_create_at:1.543311103614E12,chat_type:a.data.type,avaID:a.data.avaID})},failure:function(b){Utils.toastLong(b)}})},onRemoveFav:function(c,a){var b=a.get('chat_id');Utils.custAjax('DELETE','chatfavorite',{params:Ext.encode({chat_id:b,user_id:User.ownerID}),success:function(){var d=User.favChats;for(var b=0;b<d.length;b++){if(a.data.chat_id==d[b].chat_id){d.splice(b,1);break}}User.favChanged=!1},failure:function(b){Utils.toastLong(b)}})},onRemoveChat:function(d,b){var c=d.getStore();var a=b.get('chat_id');if(a==StaticChatID.News){LocalDataMgr.removeRct(a);PushNotification.resetBadgeNum()}else {Utils.custAjax('PUT','chats/'+a+'/hide',{success:function(){LocalDataMgr.removeRct(a);PushNotification.resetBadgeNum()},failure:function(a){Utils.toastLong(a)}})}c.remove(b)},onSetChatTop:function(c,a){if(a.data.toTop){a.set('toTop',!1)}else {a.set('toTop',!0)}var b=a.get('chat_id');c.getStore().sort();LocalDataMgr.setRctTop(b,a.data.toTop?'Y':'N')},onSearchChange:function(h,a,f,g){var e=this,d=e.getView(),c=d.down('#ChatList'),b=c.getStore();b.clearFilter();if(a==''){return}b.filter(function(b){return b.data.last_post_id.indexOf(a)>-1||b.data.last_post_name.indexOf(a)>-1||b.data.last_post_msg.indexOf(a)>-1||b.data.name.indexOf(a)>-1})},onSearchAction:function(a,c,b){a.blur()},toSearch:function(c){var a=Ext.Viewport.lookup('IMMobile'),b=a.down('#chatsearch');b.hide();c.preventDefault();a.push({xtype:'chatsearchcontain'});if(Ext.os.is.iOS){$('input').focus()}}});Ext.define('IMMobile.view.widget.Navbar',{extend:'Ext.TitleBar',xtype:'IMMobile-Navbar',config:{backBtn:!0},titleAlign:'left',referenceHolder:!0,constructor:function(a){a=a||{};if(Ext.isEmpty(a.docked)){a.docked='top'}if(!a.items){a.items=[]}this.callParent(arguments)},applyBackBtn:function(a){var b=this;if(a===!0){a={}}if(a){Ext.applyIf(a,{itemId:'back',reference:'backbtn',ui:'back',docked:'left',text:'返回',cls:'back-button',iconCls:'far fa-angle-left',$initParent:b,handler:function(){var b=Ext.Viewport.lookup('IMMobile'),d=b.innerItems,c=d.length;b.layout.setAnimation({type:'reveal',direction:'right',duration:250});b.setActiveItemIndex(c-2);b.timer=setTimeout(function(){b.pop();b.layout.setAnimation({type:'cover',direction:'left',duration:250})},300)}})}return Ext.factory(a,Ext.Button,b.getBackBtn())},updateBackBtn:function(a){var b=this;if(a){Ext.Toolbar.prototype.doInsert.call(b,0,a)}},doBoxRemove:function(a,b){if(a.config.align=='right'){if(a.getParent()===this.rightBox){this.rightBox.remove(a,b)}}else {if(a.getParent()===this.leftBox){this.leftBox.remove(a,b)}}},initialize:function(){this.callParent(arguments);this.addCls(['navbar','topinset','semibold'])}});Ext.define('IMMobile.view.IMMobileMain.tabPanel.IMMobileChat',{extend:'Ext.Panel',xtype:'IMMobile-Chat',reference:'immobile_chat',requires:['IMMobile.view.IMMobileMain.tabPanel.IMMobileChatController','IMMobile.view.widget.Navbar'],controller:'IMMobileChatController',layout:'vbox',cls:'IMMobile-chat-container chatlist',setDisinfo:null,items:[{xtype:'IMMobile-Navbar',backBtn:!1,title:'消息',items:[{iconCls:'im-common-add1',cls:'add-btn',align:'right',arrow:!1,menu:{cls:'rctMenu docked-bottom',items:[{text:'发起多人会话',iconCls:'x-fa fa-user-plus',handler:'onStartGrpChat'},{text:'全部设为已读',iconCls:'x-fa fa-lightbulb-o',handler:'onAllRead'},{text:'扫一扫',iconCls:'im-mobile im-mobile-scan',handler:'onScan'},{text:'休息一小时',iconCls:'x-fa fa-bell-slash-o',handler:'onSetRest'}]}}]},{xtype:'component',style:'background-color:pink;text-align:center;color:#555;line-height:35px;',width:'100%',height:35,docked:'top',ui:'flat',itemId:'disconnectInfo',hidden:!0,retryTime:0,listeners:{tap:{element:'element',fn:'onDisInfoClick'},show:{fn:'onShowDisInfo'},hide:{fn:'onHideDisInfo'}}},{xtype:'component',style:'background-color:rgb(222, 236, 249);text-align:center;color:#555;line-height:35px;',width:'100%',height:35,docked:'top',ui:'flat',itemId:'restInfo',hidden:!0,html:'<div><span class="rest-icon x-fa fa-coffee"></span><span>休息中</span></div>',listeners:{tap:{element:'element',fn:'onRestClick'}}},{xtype:'container',items:[{xtype:'button',itemId:'chatsearch',ui:'flat',text:'搜索',iconCls:'im-mobile im-mobile-glass',iconAlign:'left',cls:'btnSearch',textAlign:'center',dock:'top',width:'100%',listeners:{tap:{element:'element',fn:'toSearch'}}},{xtype:'rctchatlist',itemId:'ChatList',cls:'IMMobile-RecentChat',flex:1,infinity:!0,listeners:{childTap:'onSelChatList'}}]}],listeners:{activate:'onActivate'},initialize:function(){var e=this;e.callParent(arguments);var b=localStorage.getItem(User.accountID+'_'+User.ownerID+'resttime');if(b){if(User.restFun){clearTimeout(User.restFun);User.restFun=null}var a=Date.now();var d=a-parseInt(b,0);if(d>0){var c=e.down('#restInfo');c.show();localStorage.setItem(User.accountID+'_'+User.ownerID+'resttime',a);User.restFun=setTimeout(function(){c.hide();User.restFun=null},d)}}}});Ext.define('IMMobile.view.base.Container',{extend:'Ext.Container',xtype:'baseBackcolor',classCls:'baseBackColor'});Ext.define('IMMobile.view.details.memDetail',{extend:'Ext.Container',xtype:'IMMobile-memDetail',requires:['IMMobile.view.widget.Navbar','IMMobile.view.base.Container'],layout:'vbox',defaultListenerScope:!0,viewModel:{},items:[{xtype:'IMMobile-Navbar',title:'个人信息'},{xtype:'baseBackcolor',flex:1,itemId:'memDetail',layout:{type:'vbox'},items:[{xtype:'component',style:'width:100%;',margin:'15 0 15 0',bind:{html:'<div class="wrapper" style="background-color:#fff;padding:10px;"><image class="avatarPic" src="{tokenAvt}" onload="AvatarMgr.loadAvt2(this,1);" data-hash="{avatar_hash}" data-user="{user_id}" data-type="D" style="right: 20px;top: 20px;border-radius: 5px;"><div class="personalText">{user_name}<div class="sex-{sex}"></div></div><p class="jobText">{stateStr}{def_role_name}</p>'}},{xtype:'baseBackcolor',cls:'userinfo',items:[{xtype:'component',cls:'divButton thin-border',width:'100%',bind:{html:'<div class="float-left btnLabel">编号</div><div class="float-right btnValue">{user_id}</div>&nbsp;'}},{xtype:'component',cls:'divButton thin-border',width:'100%',bind:{html:'<div class="float-left btnLabel">手机</div><div class="float-right btnValue"><a href="tel:{mobile}">{mobile}</a></div>&nbsp;'}},{xtype:'component',cls:'divButton',width:'100%',bind:{html:'<div class="float-left btnLabel">邮箱</div><div class="float-right btnValue">{email}</div>&nbsp;'}}]},{xtype:'button',itemId:'btnSendMsg',ui:'flat',text:'发消息',cls:'sendButton thin-border',margin:'20px 0 0 0',width:'100%',handler:'onSend',bind:{hidden:'{isHidden}'}}]}],initialize:function(){var a=this;a.callParent(arguments);var b={tokenAvt:ImgUtil.onePxImg};Utils.custAjax('get','users/'+a.config.userid,{success:function(c){Ext.apply(b,c);var d='['+MobileHelper.stateConverStr(a.config.userid)+']';b.stateStr=d;b.isHidden=!1;if(User.ownerID==a.config.userid){b.isHidden=!0}if(ConfigMgr.isAio8()){b.org_names=c.user_posts;b.def_role_name=c.roles.filter(function(a){return a.corp_id==User.crtCorpID}).map(function(a){return a.role_name}).join(',')}a.getViewModel().setData(b);a.config.username=b.user_name;if(a.config.record){a.config.record.set({notes:c.notes})}OrgDataHepler.updateCache(c);LocalDataMgr.updateUserInfo(c);if(window.cordova){setTimeout(function(){a.updateUserAva(c)},500)}}})},onSend:function(){var a=this;User.chatMemID=a.config.userid;User.crtChatName=a.config.username;User.lastChatId=a.config.userid;User.crtChannelType='D';Redirect.redirectTo('chatview',{chatType:'D'})},updateUserAva:function(a){var w=this;var b=Ext.Viewport.down('IMMobile'),q=b.down('rctchatlist'),p=b.down('IMMobile-Org');var o=Ext.getStore('comRct'),i=o.findRecord('avaID',a.user_id);if(i){var t=q.mapToItem(i),n=t.el.query('img'),m=n.length>0?n[0]:null,v=m.src;AvatarMgr.setUrl(m,v)}var g=p.getStore(),h=!g?null:g.findRecord('user_id',a.user_id);if(h){h.set('avatar_hash',a.avatar_hash)}var d=b.down('chatinfoview'),k=d?d.down('#memAvas'):null;if(k){var s=k.el.query('img');Ext.each(s,function(b,e){var c=b.getAttribute('data-user'),d=b.src;if(c===a.user_id){AvatarMgr.setUrl(b,d)}})}var c=b.down('chatmember'),e=c?c.getStore():null,f=e?e.findRecord('user_id',a.user_id):null;if(f){var r=c.mapToItem(f),l=r.el.query('img'),j=l.length>0?l[0]:null,u=j.src;AvatarMgr.setUrl(j,u)}}});Ext.define('IMMobile.view.IMMobileMain.tabPanel.IMMobileOrg',{extend:'Ext.dataview.NestedList',xtype:'IMMobile-Org',controller:'mobileorgcontroller',requires:['Ext.dataview.NestedList','IMMobile.view.details.memDetail'],cls:'mobileNestList',itemId:'OrgNestedList',flex:1,displayField:'text',useTitleAsBackText:!1,updateTitleText:!0,emptyText:'无数据',backText:'',backButton:{ui:'back',docked:'left',iconCls:'far fa-angle-left',cls:'back-button'},toolbar:{userCls:'topinset',titleAlign:'left'},listConfig:{items:[{xtype:'button',ui:'flat',text:'搜索',iconCls:'im-mobile im-mobile-glass',iconAlign:'left',cls:'btnSearch',textAlign:'center',docked:'top',handler:'toSearch'}],itemTpl:['<tpl if="values.user_id">','<div class="nested-org">','<img class="nested-user-avatar" style="opacity:{[MobileHelper.stateByUserIsOnline(values.user_id,true)]}" src="{[ImgUtil.onePxImg]}" onload="AvatarMgr.loadAvt2(this,0);" data-hash="{avatar_hash}" data-user="{user_id}" data-type="D" width="30" height="30">','<div class="user-info"><div>{text}</div><div class="user-label">[{[MobileHelper.stateConverStr(values.user_id)]}] {notes}</div></div>','</div>','<tpl elseif="values.orgtype==\'F\'">','<div class="nested-org">','<img class="nested-user-avatar" src="{[ImgUtil.onePxImg]}" onload="AvatarMgr.loadAvt2(this,0);" data-user="{chatid}" data-time="{create_at}" data-type="{chattype}" />','<div>{text}</div>','</div>','<tpl elseif="values.cid==StaticChatID.News">','<div class="nested-org">','<img class="nested-user-avatar news-icon" src="'+Ext.getResourcePath('images/xiaoxi.png',null,null)+'" />','<div>{text}</div>','</div>','<tpl elseif="values.id==\'Favorite\'">','<div class="nested-org">','<div class="fa org-icon im-mobile-favorite"></div>','<div class="name">{text}</div>','<span class="fa fa-angle-right" style="line-height:38px;position: absolute;"></span>','</div>','<tpl elseif="values.id==\'Group\'">','<div class="nested-org">','<div class="fa org-icon im-mobile-users"></div>','<div class="name">{text}</div>','<span class="fa fa-angle-right" style="line-height:38px;position: absolute;"></span>','</div>','<tpl else>','<div class="nested-org">','<div class="fa org-icon im-mobile-organization"></div>','<div class="name">{text}</div>','<span class="fa fa-angle-right" style="line-height:38px;position: absolute;"></span>','</div>','</tpl>'].join('')},initialize:function(){var a=this;a.callParent(arguments);var c=this.getToolbar();var d=a.getBackButton();a.updateBackText('返回');Ext.Toolbar.prototype.doInsert.call(c,0,d);var b=a.getController();a.on('activate',b.initOrgList,b)},listeners:{leafitemtap:{fn:function(b,e,d,c,a){if(a.data.orgtype=='U'){var f=a.data.user_id;Redirect.redirectTo('IMMobile-memDetail',{userid:a.data.user_id,username:a.data.user_name,record:a})}else {if(a.data.orgtype=='F'){}}}}},onChildTap:function(d,a){var b=this,e=b.hasListeners,c=a.record;if(b.onChildInteraction(d,a)===!1){return !1}if(e.childtap){a.list=d;b.fireEvent('childtap',b,a)}if(e.itemtap){b.fireEvent('itemtap',b,d,a.viewIndex,a.child,c,a.event)}if(c.isLeaf()){if(e.leafchildtap){a.list=d;b.fireEvent('leafchildtap',b,a)}if(e.leafitemtap){b.fireEvent('leafitemtap',b,d,a.viewIndex,a.child,c,a.event)}b.goToLeaf(c)}else {if(c.data.foldertype=='F'){Redirect.redirectTo('favview')}else {if(c.data.cid==StaticChatID.News){User.lastChatId=User.crtChannelId;User.crtChannelId=StaticChatID.News;Redirect.redirectTo('newsview',{chatid:StaticChatID.News})}else {if(c.data.crowdtype=='C'){Redirect.redirectTo('crowdview')}else {this.goToNode(c)}}}}}});Ext.define('IMMobile.view.IMMobileMain.tabPanel.IMMobileWorkDesk',{extend:'Ext.List',xtype:'IMMobile-WorkDesk',controller:'workdeskcontroller',requires:['IMMobile.view.widget.Navbar','IMMobile.view.base.Container'],plugins:{pullrefresh:{widget:'pullrefreshspinner',overlay:!0}},userCls:'workdesk',flex:1,layout:'vbox',title:'工作台',grouped:!0,selectable:!1,groupHeader:{tpl:'{name}'},viewModel:{data:{isAio8:!1}},store:{grouper:{property:'GroupID',groupFn:function(a){return a.data.GroupName}},remoteSort:!0},items:[{xtype:'IMMobile-Navbar',backBtn:!1,title:'工作台',items:[{reference:'refreshBtn',iconCls:'fa fa-refresh',align:'right',bind:{hidden:'{!isAio8}'}}]}],itemTpl:'<div class="div-ct">\n    <tpl if="Ext.String.startsWith(values.ModuleIcon, \'<svg\', true)">\n    <div class="x-layout-box x-align-center x-pack-center div-icon">{ModuleIcon}</div>\n    <tpl else>\n    <div class="div-icon {ModuleIcon}"></div>\n    </tpl>\n    <div class="div-txt">{ModuleName}</div>\n    <tpl if="values.badge &gt; 0">\n    <div class="div-unread"><span>{badge}</span> 封未读</div>\n    </tpl>\n    </div>',listeners:{childtap:'toItemPage'},initialize:function(){var a=this;a.callParent(arguments);a.on('activate',a.onWDActivate,a)},onWDActivate:function(e,d,c,b){var a=this;if(ConfigMgr.isAio8()){a.onActivateAIO8(e,d,c,b)}else {if(!a.storeFetched){a.storeFetched=!0;var f=a.getStore();f.fetch=function(){if(window.VerControll.judgeFn('verLogin3')){a.newValidAndGetList(null,!0)}else {a.onPullRefresh()}}}a.onActivateAIO75(e,d,c,b)}},onActivateAIO75:function(f,e,d,c){var a=this;a.hasValid=!1;var b=User.accURL.split('/');a.domin=b[0]+'//'+b[2];a.listUrl=b.join('/');if(window.VerControll.judgeFn('verLogin3')){a.newValidAndGetList(c)}else {a.onValidAndGetList(c)}a.loginUser=User.ownerID},onPullRefreshX:function(b){var a=this;if(a.hasValid){var c=User.accURL.split('/');c[c.length-1]='ApiEntry/Ajax.ashx?class=OA.ModernModule&method=GetModulesForAIO';Utils.ajax(c.join('/'),{success:function(c){a.setData(c.data);a.setBadge();if(b){b()}}})}else {a.onValidAndGetList(b)}},onPullRefresh:function(){var a=this;if(a.hasValid){var b=User.accURL.split('/');b[b.length-1]='ApiEntry/Ajax.ashx?class=OA.ModernModule&method=GetModulesForAIO';Utils.ajax(b.join('/'),{success:function(b){a.setData(b.data);a.setBadge();a._plugins[0].snapBack(!0)}})}else {a.onValidAndGetList()}a._plugins[0].snapBack(!0);return},onValidAndGetList:function(b){var a=this;Utils.custAjax('get','users/'+User.ownerID+'/erpsession',{success:function(d){window.workdesksession=d;var c=User.accURL.split('/');c[c.length-1]='AIOMobile/AIOHomePage2.aspx?';var e=c.join('/')+'userid='+Utils.toHex(User.ownerID)+'&session='+Utils.toHex(d);Utils.ajax(e,{success:function(){a.hasValid=!0;if(!window.VerControll.judgeFn('verLogin3')){a.onPullRefreshX(b)}},failure:function(c){Utils.unMask(a);Utils.toastShort(c)}})}})},newValidAndGetList:function(c,b){var a=this;Utils.ajaxWithSuffix('Ajax/OA.ModernModule/GetModulesForAIO',{success:function(d){a.setData(d.data);a.setBadge();if(c){c()}if(b){a._plugins[0].snapBack(!0)}},failure:function(){Utils.toastShort('获取失败,请重新尝试');if(b){a._plugins[0].snapBack(!0)}}})},Erp8List:[],Grp8List:[],Erp8DbCacheKey:'Erp8Work_Datas',Grp8DbCacheKey:'Grp8Work_Datas',onActivateAIO8:function(h,g,f,d){var a=this;var c=a.getViewModel();if(c){c.setData({isAio8:!0})}if(!a.aio8Fetched){a.aio8Fetched=!0;var e=a.down('IMMobile-Navbar');var b=e.lookup('refreshBtn');if(b){b.on({tap:'onTapRefersh',scope:a})}}a.loadList(d)},loadList:function(b){var a=this;(new Promise(function(c,e){var d=User.crtCorpID=='group'?a.Grp8List:a.Erp8List;if(d.length>0){c(d)}else {a.localDbList().then(function(d){if(d.length>0){c(d)}else {a.remoteList().then(function(a){return c(a)})}})}})).then(function(c){a.setData(c.filter(function(a){return a.CorpID===User.crtCorpID}));a.setBadge();if(b){b()}})},localDbList:function(){var a=this;var b=User.crtCorpID=='group'?a.Grp8DbCacheKey:a.Erp8DbCacheKey;return new Promise(function(a,c){LocalDataMgr.getCache(b,function(b){if(Ext.isArray(b)){a(b)}else {try{a(JSON.parse(b))}catch(d){a([])}}})})},remoteList:function(){var a=this;return new Promise(function(b,c){Utils.aio8Ajax('Suite.ApiModule/GetModulesForAIO',{success:function(e){var d=e.Data;a.Erp8List=d;LocalDataMgr.insertIMCache({cacheKey:a.Erp8DbCacheKey,cacheValue:JSON.stringify(d)});b(d)},failure:function(){Utils.toastShort('远端获取失败,请重新尝试')},maskTarget:a})})},onTapRefersh:function(){var a=this;a.remoteList().then(function(b){a.setData(b.filter(function(a){return a.CorpID===User.crtCorpID}));a.setBadge()})},setBadge:function(){var b=this;var f=b.getViewModel(),d=f.getData();var e=0;if(Object.keys(d).length>0){for(var a in d){var g=f.getData()[a];if(a.startsWith('module_')){a=a.replace('module_','')}var j=b.getStore(),c=j.findRecord('ModuleID',a);if(c){c.set('badge',g);e+=g}}}if(Ext.isArray(b.dataItems)&&b.dataItems.length>0){var i=Ext.Viewport.down('IMMobile');var h=i.getViewModel();h.setData({wkBadgeNum:e})}},updateModuleBadge:function(b,f,a){var i=Ext.Viewport.down('IMMobile'),h=i.getViewModel(),c=this,g=c.getViewModel();h.setData({wkBadgeNum:f});g.getData()['module_'+b]=a;var e=c.getStore(),d=e?e.findRecord('ModuleID',b):null;if(d){d.set({badge:a})}}});Ext.define('IMMobile.view.base.button.ArrowButton',{extend:'Ext.Button',xtype:'arrButton',classCls:'arrButton',config:{arrText:'',leftImg:''},constructor:function(a){a=a||{};a.ui='flat';a.textAlign='left';a.width='100%';if(a.arrText||a.showArrow){a.text='<div>'+(a.arrText||a.text)+'<div style="float:right;">'+'<div class="arrow"></div>'+'</div>'+'</div>'+'</div>'}if(a.arrText&&a.leftImg){a.text='<div><span style="margin-left:5px">'+(a.arrText||a.text)+'</span><div style="float:left;">'+'<div class="'+a.leftImg+'"></div>'+'</div>'+'</div>'+'</div>'}this.callParent(arguments)}});Ext.define('IMMobile.view.IMMobileMain.tabPanel.IMMobileMe',{extend:'Ext.Container',xtype:'IMMobile-Me',controller:'IMMobileMeController',requires:['IMMobile.view.widget.Navbar','IMMobile.view.IMMobileMain.tabPanel.IMMobileChatController','IMMobile.view.base.Container','IMMobile.view.base.button.ArrowButton'],layout:'vbox',viewModel:{},items:[{xtype:'IMMobile-Navbar',backBtn:!1,title:'我'},{xtype:'baseBackcolor',margin:'15 0',items:[{xtype:'button',userCls:'me_Button',width:'100%',bind:{text:'<div class="wrapper">\n                        <image class="avatar" src="{tokenAvt}" onload="AvatarMgr.loadAvt2(this,1);" data-hash="{avatar_hash}" data-type="D" data-user="{user_id}">\n                        <div class="name-wrapper">\n                            <span class="name">{user_name}({user_id})</span>\n                            <span class="post">{org_names}</span>\n                        </div>\n                        <p class="role">{def_role_name}</p>\n                        </div>'},handler:'onOpenUserInfo'}]},{xtype:'baseBackcolor',margin:'0 0 15px',items:[{xtype:'arrButton',style:'color: #0d1114;',arrText:'我的文件',iconCls:'fa-angle-right',handler:'onOpenFileManager'}]},{xtype:'baseBackcolor',items:[{xtype:'arrButton',style:'color: #0d1114;',arrText:'设置',iconCls:'fa-angle-right',handler:'onOpenSetting'}]}],initialize:function(){var a=this;a.callParent(arguments);a.on('activate',a.onActivate,a)},onActivate:function(){var a=this;Utils.custAjax('get','users/'+User.ownerID,{success:function(b){b.tokenAvt=ImgUtil.onePxImg;if(ConfigMgr.isAio8()){b.org_names=b.user_posts;b.def_role_name=b.roles.filter(function(a){return a.corp_id==User.crtCorpID}).map(function(a){return a.role_name}).join(',')}a.getViewModel().setData(b)}})}});Ext.define('IMMobile.view.IMMobileMain.MainTabController',{extend:'Ext.app.ViewController',alias:'controller.maintabcontroller',onTabChanges:function(b,a,c){if(a.xtype=='IMMobile-Org'){if(User.orgStoreRoot&&User.orgStoreRoot.parent_id.toLocaleLowerCase()=='root'&&User.orgStoreRoot.text){a.setTitle(User.orgStoreRoot.text)}}}});Ext.define('IMMobile.view.main.MainTabPanel',{extend:'Ext.tab.Panel',xtype:'mainTabPanel',requires:['IMMobile.view.IMMobileMain.tabPanel.IMMobileChat','IMMobile.view.IMMobileMain.tabPanel.IMMobileOrg','IMMobile.view.IMMobileMain.tabPanel.IMMobileWorkDesk','IMMobile.view.IMMobileMain.tabPanel.IMMobileMe','IMMobile.view.IMMobileMain.MainTabController'],controller:'maintabcontroller',defaults:{scrollable:!0,tab:{flex:1}},cls:'main_tab_panel',tabBar:{docked:'bottom',padding:0,itemId:'btmTabBar',userCls:'bottominset tabbar-bottom',defaults:{iconAlign:'top'}},items:[{title:'消息',iconAlign:'top',iconCls:'im-common-message1',xtype:'IMMobile-Chat',itemId:'IMMobile_Chat',tab:{bind:{badgeText:'{rctBadgeHtml}'}}},{title:'通讯录',iconAlign:'top',iconCls:'im-common-organization2',xtype:'IMMobile-Org',itemId:'IMMobile_Org'},{title:'工作台',iconAlign:'top',iconCls:'im-common-thumbnail',xtype:'IMMobile-WorkDesk',tab:{bind:{badgeText:'{wkBadgeNumHtml}'}}},{title:'我',iconAlign:'top',iconCls:'im-common-user',xtype:'IMMobile-Me',itemId:'tabMe'}],listeners:{activeitemchange:'onTabChanges'},initialize:function(){var a=this;a.callParent(arguments);a.onBefore('activeitemchange','beforeActiveChange',this);a.onAfter('activeitemchange','afterActiveChange',this)},beforeActiveChange:function(b,a,c){if(a.element){a.element.addCls('prevent-pointer-events')}},afterActiveChange:function(b,a,c){setTimeout(function(){if(a.element){a.element.removeCls('prevent-pointer-events')}},100)}});Ext.define('IMMobile.view.IMMobile',{extend:'Ext.NavigationView',xtype:'IMMobile',requires:['Ext.navigation.View','IMMobile.view.main.MainTabPanel','IMCommon.utils.SocketEventUtil','IMCommon.enumType.ChatType','IMCommon.enumType.MsgType','IMCommon.enumType.MsgWrapperType','IMCommon.enumType.NoticeType','IMCommon.enumType.SocketEventType','IMCommon.utils.WebSocketUtil','IMCommon.local.LocalDataMgr','MX.HeadsUp','MX.field.Checkbox','MX.field.Display','MX.field.DisplayAttach','MX.field.DisplayDateTimeField','MX.field.Hidden','MX.field.Location','MX.field.CommonField','MX.BDMap'],uses:['IMCommon.utils.AvatarUtil','IMCommon.utils.ParseUtil'],viewModel:{data:{rctBadge:0,wkBadgeNum:0},formulas:{rctBadgeHtml:function(b){var a=b('rctBadge');if(a==0){return null}if(a>0&&a<=99){return ''+a}if(a>99){return '99+'}},wkBadgeNumHtml:function(b){var a=b('wkBadgeNum');if(a==0){return null}if(a>0&&a<=99){return ''+a}if(a>99){return '99+'}}}},cls:'mobileMain',navigationBar:null,layout:{type:'card',animation:{type:'cover',direction:'left',duration:250}},items:[{xtype:'mainTabPanel',itemId:'mainTab'}],specialTitle:'<div style="display: flex;justify-content: center;align-items: center;"><div class="la-ball-spin-clockwise la-2x">\n                        <div></div>\n                        <div></div>\n                        <div></div>\n                        <div></div>\n                        <div></div>\n                        <div></div>\n                        <div></div>\n                        <div></div>\n                        <div></div>\n                        <div></div>\n                        <div></div>\n                        <div></div>\n                    </div> 连接中...</div>',hasSpecialTitle:!1,loadedUnread:!1,logined:!1,wsConned:!1,initialize:function(){var a=this;a.callParent(arguments);if(window.cordova){StatusBar.styleLightContent()}a.onBefore('activeitemchange','beforeActiveChange',this);a.onAfter('activeitemchange','afterActiveChange',this);if(!User.manualLogin){if(!a.hasSpecialTitle){a.hasSpecialTitle=!0;a.down('IMMobile-Navbar').setTitle(a.specialTitle)}a.doValidateSession()}else {a.logined=!0}MobileHelper.openInterval()},doValidateSession:function(){var a=this,b=Ext.Viewport.getController();ChatUtil.doAutoLogin(User.son,function(c){a.logined=!0;b.setMainCache(c);b.doBuildDB(function(){MobileHelper.openInterval()});if(!a.wsConned){WebSocketUtil.pause();a.afterRctInit()}if(window.MobileHelper.specialTitleHideTiming()){a.hasSpecialTitle=!1;a.down('IMMobile-Chat').down('IMMobile-Navbar').setTitle('消息')}})},afterRctInit:function(){var a=this;User.isFirstConRct=!1;a.openConnection()},openConnection:function(){WebSocketUtil.close();this.setWSEvent();WebSocketUtil.initialize(Config.wsGoUrl)},setWSEvent:function(){var a=this;WebSocketUtil.setFirstConnectCallback(a.firstConnectCallback);WebSocketUtil.setEventCallback(a.eventCallBack);WebSocketUtil.setReconnectCallback(a.reconnectCallback);WebSocketUtil.setCloseCallback(a.closeCallback)},firstConnectCallback:function(){if(!User.isFirstConRct){var a=Ext.Viewport.lookup('IMMobile'),b=a.down('IMMobile-Chat');a.wsConned=!0;window.MobileHelper.clearWsCntTimeOut();if(b&&!a.hasSpecialTitle){a.hasSpecialTitle=!0;b.down('IMMobile-Navbar').setTitle(a.specialTitle)}ChatUtil.getUnreadChats(function(){a.loadedUnread=!0;a.getRctBadge();if(b&&window.MobileHelper.specialTitleHideTiming()){a.hasSpecialTitle=!1;b.down('IMMobile-Navbar').setTitle('消息')}var c;var e=Ext.Viewport.lookup('IMMobile').getActiveItem();if(e&&e.xtype=='chatview'){c=e.down('#msgView')}if(c){if(!window.tempchatid||window.tempchatid&&User.crtChannelId==window.tempchatid){window.tempchatid=null;var h=c.store;var g=h.data.items[h.getCount()-1];var l=g?g.data.msgSeq:10000;ChatUtil.firstGetRemoteHis2(User.crtChannelId,[],l,function(a){if(!c||!c.store){return}c.store.add(a);c.onAddDatas(a.length);ChatUtil.checkReadInfo(c.store,a);LocalDataMgr.getMentions(User.crtChannelId,function(g,f){var b=f.rows;c.atinfos=[];if(b.length>0){for(var d=0;d<b.length;d++){var e=b.item(d);c.atinfos.push({id:e.MsgID,seq:e.MsgSeq})}}c.getViewModel().setData({atCount:b.length})})});var f=Ext.getStore('comRct');var i=f.getById(User.crtChannelId);if(i){var m=i.get('unReadNum');if(m){ChatUtil.setUnreadToRead(f,User.crtChannelId)}}}else {if(window.tempchatid){var d=window.tempchatid;window.tempchatid=null;User.lastChatId=User.crtChannelId;User.crtChannelId=d;if(d===StaticChatID.News){Redirect.redirectTo('newsview',{chatid:StaticChatID.News})}else {MobileHelper.getChatType(d);Redirect.redirectTo('chatview',{chatid:d})}}}}else {if(window.tempchatid){var d=window.tempchatid;window.tempchatid=null;User.lastChatId=User.crtChannelId;User.crtChannelId=d;if(d===StaticChatID.News){Redirect.redirectTo('newsview',{chatid:StaticChatID.News})}else {MobileHelper.getChatType(d);Redirect.redirectTo('chatview',{chatid:d})}}}if(window.mailpath&&VerControll.judgeFn('verMailPush')){var k=window.mailpath;window.mailpath=null;Ext.Viewport.getController().fireEvent('openModule','mail',k)}else {if(window.approveParam&&VerControll.judgeFn('verApprove')){window.approveParam=null}else {if(window.noticeParam&&VerControll.judgeFn('verNoticePush')){var j=window.noticeParam.keystring;var n='notice/view/?DocEntry='+j;Ext.Viewport.getController().fireEvent('openModule','notice',n);window.noticeParam=null}else {if(window.pushCacheMsg){var o=window.pushCacheMsg.msg_type;if(o==='approve'){}else {Ext.Viewport.getController().fireEvent('openModule',window.pushCacheMsg.msg_type,window.pushCacheMsg.msgValues)}window.pushCacheMsg=null;delete window.pushCacheMsg}}}}});var c=a.down('#disconnectInfo');if(c){c.hide()}}},eventCallBack:function(a){switch(a.event){case SocketEventType.posted:SocketEventUtil.handleNewPostEvent(a,Ext.Viewport.lookup('IMMobile').down('#mainTab').down('#IMMobile_Chat').down('#ChatList'),Ext.Viewport.lookup('IMMobile'));break;case SocketEventType.createGrp:break;case SocketEventType.memAdd:SocketEventUtil.handleMemAddEvent(a);break;case SocketEventType.memRemove:SocketEventUtil.handleMemRemoveEvent(a);break;case SocketEventType.chgManager:SocketEventUtil.handleMgrChgEvent(a);break;case SocketEventType.updateChat:SocketEventUtil.handleChgChatHeader(a);break;case SocketEventType.getFile:SocketEventUtil.handleGetFile(a,Ext.Viewport.lookup('IMMobile'));break;case SocketEventType.revoke:SocketEventUtil.handleRevokeEvent(a);break;case SocketEventType.viewChat:SocketEventUtil.handleViewChat(a);break;case SocketEventType.viewAt:SocketEventUtil.handleViewAt(a);break;case SocketEventType.news:SocketEventUtil.handleNewsMessage(a);break;case SocketEventType.crowdnotice:SocketEventUtil.handleCrowdNoticeMessage(a);break;case SocketEventType.crowdsetAdmin:SocketEventUtil.handleCrowdSetAdminMessage(a);break;case SocketEventType.pushMail:if(VerControll.judgeFn('verMailPush')){SocketEventUtil.handlePushMail(a)};break;case SocketEventType.updateMailBadge:if(VerControll.judgeFn('verMailPush')){SocketEventUtil.handleUpdateMailBadge(a)};break;case SocketEventType.pushNotice:if(VerControll.judgeFn('verNoticePush')){SocketEventUtil.handlePushNotice(a)};break;case SocketEventType.updateRead:if(VerControll.judgeFn('verReceipt')){SocketEventUtil.handleUpdateRead(a)};break;case SocketEventType.pushCommon:SocketEventUtil.handleUpdateCommonPushes(a);break;default:break;}},closeCallback:function(c,d){if(c>1){var b=Ext.Viewport.lookup('IMMobile');if(b){var a=b.down('#disconnectInfo');if(a){a.hide();a.retryTime=d;a.show()}b.loadedUnread=!1;b.wsConned=!1}window.MobileHelper.clearWsCntTimeOut()}},reconnectCallback:function(){console.log('reconnectCallback');User.isFirstCon=!0;for(var c=0;c<Ext.StoreManager.length;c++){Ext.StoreManager.getAt(c).isFirst=!0}ChatUtil.getUnreadChats(0);var a;var d=Ext.Viewport.lookup('IMMobile').down('#chatview');if(d){a=d.down('#msgView')}if(a){var g=a.store;var e=g.data.items[g.getCount()-1];var h=e?e.data.msgSeq:10000;ChatUtil.firstGetRemoteHis2(User.crtChannelId,[],h,function(b){if(!a||!a.store){console.log('reconnectCallback:我会出现');return}a.store.add(b);a.onAddDatas(b.length);ChatUtil.checkReadInfo(a.store,b)})}var b=Ext.Viewport.lookup('IMMobile');if(b){var f=b.down('#disconnectInfo');if(f){f.hide()}b.wsConned=!0}window.MobileHelper.clearWsCntTimeOut()},beforeActiveChange:function(b,a,c){if(a.element){a.element.addCls('prevent-pointer-events')}},afterActiveChange:function(b,a,c){setTimeout(function(){if(a.element){a.element.removeCls('prevent-pointer-events')}},100)},getRctBadge:function(){var b=Ext.getStore('comRct');var a=0;b.each(function(c){var b=c.get('unReadNum');b=b>0?b:0;a+=b});this.getViewModel().setData({rctBadge:a})}});Ext.define('IMMobile.view.IMMobileMain.details.About',{extend:'Ext.Container',xtype:'about',viewModel:{},cls:'about bottominset',layout:'vbox',items:[{xtype:'IMMobile-Navbar',title:'关于'},{xtype:'component',docked:'top',height:200,userCls:'logoCT',bind:{html:'<div class="logo"></div>\n                <div class="name">普实AIO8专业版</div>\n                <div class="version">Version {version}<div>'}},{xtype:'baseBackcolor',items:[{xtype:'arrButton',itemId:'updateInfo',hidden:!1,style:'color: #0d1114;',text:'更新日志',iconCls:'fa-angle-right',handler:function(){Redirect.redirectTo('updateInfolist')}}]},{xtype:'baseBackcolor',items:[{xtype:'arrButton',itemId:'btnUpdate',hidden:!0,style:'color: #0d1114;',text:'检查更新',iconCls:'fa-angle-right',handler:function(){IMHelper.updateApp(!1)}}]},{xtype:'baseBackcolor',items:[{xtype:'arrButton',style:'color: #0d1114;',text:'用户协议',iconCls:'fa-angle-right',handler:function(){Redirect.redirectTo('details_userterms')}}]},{xtype:'baseBackcolor',items:[{xtype:'arrButton',style:'color: #0d1114;',text:'隐私政策',iconCls:'fa-angle-right',handler:function(){Redirect.redirectTo('details_privacy')}}]},{xtype:'component',docked:'bottom',html:'<div class="rights-wrapper">\n            <div>普实公司 版权所有</div>\n            <div style="font-size:0.12rem">Copyright © 1999-2021 Pushsoft. All Rights Reserved.</div>\n            </div>'}],initialize:function(){var b=this;b.callParent(arguments);if(Ext.os.is.Android){b.down('#btnUpdate').show()}var c=Utils.getApp().versionName;var a=c.split('.');if(a.length>3){a.pop()}b.getViewModel().setData({version:a.join('.'),address:'苏州国际科技园D504',phone:'0512-67776209',email:'support@pushsoft.com'})}});Ext.define('IMMobile.view.IMMobileMain.details.AvatarView',{extend:'IMMobile.view.base.Container',xtype:'avatarview',controller:'IMMobileMeController',viewModel:{},userCls:'avatarview',items:[{xtype:'IMMobile-Navbar',itemId:'navTop',title:'头像',docked:'top',items:[{xtype:'button',itemId:'menuAddRemove',iconCls:'im-mobile im-mobile-more',style:'position: absolute;right: 0.1rem;bottom:-6px;',arrow:!1,menu:{cls:'rctMenu docked-bottom',indented:!1,items:[{text:'拍照',iconCls:'x-fa fa-camera',handler:'onSelectPhoto'},{text:'从手机相册选择',iconCls:'x-fa fa-photo',handler:'onSelectNewPic'},{text:'保存到本地',iconCls:'x-fa fa-download',value:'download',handler:'onSaveImg'}]}}]},{xtype:'component',fullscreen:!0,userCls:'ava-ct',itemId:'avatar',floated:!1}],initialize:function(){var c=this;c.callParent(arguments);User.crtUser.tokenAvt=ImgUtil.onePxImg;var a=c.down('#avatar');var b=ConfigMgr.getDataDirectory()+User.getUserAvaDir();if(Ext.os.is.iOS){var f=FSUtil.parse(0,User.getUserAvaDir());b=f.full}a.path=b+User.ownerID+'.png';var e=User.cacheMil;var d='<image class="avatarPic" src="'+a.path+'?'+e+'" data-hash="'+User.crtUser.avatar_hash+'" data-type="D" data-user="'+User.ownerID+'"></div>';a.setHtml(d)}});Ext.define('IMMobile.view.IMMobileMain.details.CrowdAvatar',{extend:'IMMobile.view.base.Container',xtype:'crowdavatar',controller:'crowdinfoviewcontroller',viewModel:{},userCls:'avatarview',items:[{xtype:'IMMobile-Navbar',itemId:'navTop',title:'头像',docked:'top',items:[{xtype:'button',itemId:'menuAddRemove',hidden:!0,iconCls:'im-mobile im-mobile-more',style:'position: absolute;right: 0.1rem;bottom:-6px;',arrow:!1,menu:{cls:'rctMenu docked-bottom',indented:!1,items:[{text:'拍照',iconCls:'x-fa fa-camera',handler:'onSelectPhoto'},{text:'从手机相册选择',iconCls:'x-fa fa-photo',handler:'onSelectNewPic'},{text:'保存到本地',iconCls:'x-fa fa-download',value:'download',handler:'onSaveImg'}]}}]},{xtype:'component',fullscreen:!0,userCls:'ava-ct',itemId:'avatar',floated:!1}],initialize:function(){var a=this;a.callParent(arguments);var e=a.down('#avatar');var c=(new Date()).getTime();var b=Config.httpUrlForGo+'chatcs/'+a.config.chatid+'/avatar?token='+User.token+'&create_at='+a.config.create+'&'+c;var d='<image class="avatarPic" src='+b+' ></div>';e.setHtml(d);Utils.custAjax('get','chatcs/'+a.config.chatid,{success:function(b){User.crowd_manager=b.manager_id;User.crtId=b.id;for(var c=0;c<b.members.length;c++){if(b.members[c].is_admin=='Y'&&b.members[c].user_id==User.ownerID){a.down('#menuAddRemove').show()}}if(User.ownerID==b.manager_id){a.down('#menuAddRemove').show()}},failure:function(){}})}});Ext.define('IMMobile.view.IMMobileMain.details.CrowdInfoEdit',{extend:'IMMobile.view.base.Container',xtype:'crowdinfoedit',controller:'crowdinfoviewcontroller',viewModel:{data:{oldValue:'',newValue:''}},userCls:'chatHeaderView',items:[{xtype:'IMMobile-Navbar',itemId:'itemTitle',backBtn:!0,title:'',userCls:'hasRightButton',items:[{text:'确定',handler:'onChangeCrowdInfo',width:60,docked:'right',bind:{disabled:'{oldValue==newValue}'}}]},{margin:'10 0 0 0',xtype:'textareafield',height:135,itemId:'txtValue',bind:{value:'{newValue}'},listeners:{painted:function(a,b){setTimeout(function(){a.focus()},300)}}}],initialize:function(){var a=this;a.callParent(arguments);var c=a.getViewModel();c.setData({oldValue:a.config.oldValue,newValue:a.config.oldValue});var b=a.config.field;if(b=='crowdremark'){title='群描述'}else {if(b=='crowdnotice'){title='群公告'}}a.down('#itemTitle').setTitle(title)}});Ext.define('IMMobile.view.IMMobileMain.details.CrowdView',{extend:'Ext.dataview.List',xtype:'crowdview',cls:'mobileNestList',title:'群',toolbar:{userCls:'topinset',titleAlign:'left'},store:{sorters:'fav_index'},items:[{xtype:'IMMobile-Navbar',itemId:'chatViewNav',userCls:'hasRightButton',cls:'fav-nav',title:'我的群组'}],initialize:function(){var a=this;a.callParent(arguments);a.updateCrowd();a.on({childtap:'onTapChild',scope:a})},itemTpl:['<div class="nested-org">','<image class="nested-user-avatar" src="{[ImgUtil.onePxImg]}" onload="AvatarMgr.loadAvt2(this,0);" data-user="{avaID}" data-time="{create_at}" data-type="{chattype}" cid="{chatid}"/>','<div class="name">{text}</div>','</div>'].join(''),onTapChild:function(e,d){if(this.stopTap){this.stopTap=!1;return}var a=d.record;if(a){var b=a.data.chatid;User.lastChatId=User.crtChannelId;User.crtChannelId=b;User.crtChatName=a.data.text;User.crtId=a.data.crowdid;var c=Ext.getStore('comRct').getById(b);Utils.custAjax('get','chatcs/'+a.data.crowdid,{success:function(f){LocalDataMgr.saveCrowdInfo(f,function(){if(!c){Utils.custAjax('get','users/me/chats/'+User.crtChannelId,{success:function(c){var g=c.chat_id;if(c.iscrowd=='Y'){c.chat_type='C'}Ext.getStore('comRct').add({chat_id:b,name:User.crtChatName,type:c.chat_type,members:c.members,last_post_at:new Date(0),create_at:c.create_at,avaID:g,manager_id:c.creator_id,IsMute:c.is_mute});var h='INSERT OR REPLACE INTO IMChat '+'(ChatID, ChatType, DisplayName, CreatorID, ManagerID, CreateAt, UserIDs, Status, UpdateAt, AvatarHash) VALUES'+'(?,?,?,?,?,?,?,?,?,?);';LocalDataMgr.cExecSqlWithP(h,[c.chat_id,c.chat_type,User.crtChatName,c.creator_id,c.manager_id,c.create_at,c.chat_name,'0',c.update_at,f.avatar_hash]);LocalDataMgr.aboutIMChat(c);MobileHelper.getChatType(b);Redirect.redirectTo('chatview',{chatid:b,chatname:a.data.text})}})}else {MobileHelper.getChatType(b);Redirect.redirectTo('chatview',{chatid:b,chatname:a.data.text})}})},failure:function(){}})}},updateCrowd:function(){var b=this,a=b.getStore();a.removeAll();Utils.custAjax('get','users/me/chatcs',{success:function(e){var f=[];for(var d=0;d<e.length;d++){var b={};var c=e[d];b.text=c.header;b.chatid=c.chat_id;b.chattype='C';b.create_at=c.create_at;b.notice=c.notice;b.remark=c.remark;b.hash=c.hash;b.manager_id=c.manager_id;b.update_at=c.update_at;b.crowdid=c.id;b.leaf=!0;b.parentId='Crowd';b.avaID=c.chat_id;b.fav_index=c.fav_index;f.push(b)}a.add(f)}})}});Ext.define('IMMobile.view.details.FavView',{extend:'Ext.dataview.List',xtype:'favview',requires:['MX.plugin.ListOptions'],cls:'mobileNestList',title:'收藏',toolbar:{userCls:'topinset',titleAlign:'left'},store:{sorters:'fav_index'},items:[{xtype:'IMMobile-Navbar',itemId:'chatViewNav',userCls:'hasRightButton',cls:'fav-nav',title:'收藏'}],plugins:{listoptions:{items:[{text:'编辑',color:'bg-soft-blue',action:'edit'},{text:'移除',color:'bg-soft-red',action:'remove'}]}},initialize:function(){var a=this;a.callParent(arguments);a.updateFav();a.on({childtap:'onTapChild',listoptiontap:'onTapOption',scope:a})},itemTpl:['<div class="nested-org">','<image class="nested-user-avatar" src="{[ImgUtil.onePxImg]}" onload="AvatarMgr.loadAvt2(this,0);" data-user="{avaID}" data-time="{create_at}" data-type="{chattype}" />','<div class="name">{text}</div>','</div>'].join(''),onTapOption:function(f,d,c){var b=this;var a=d.data.chatid;if(c==='remove'){Utils.custAjax('DELETE','chatfavorite',{params:JSON.stringify({user_id:User.ownerID,chat_id:a}),success:function(){var g=b.store.find('chatid',a);if(g>-1){b.store.removeAt(g);b.chatid=null}for(var e=0;e<User.favChats.length;e++){if(User.favChats[e].chat_id==a){User.favChats.splice(e,1)}}}})}else {if(c==='edit'){var e=d.data.text;Redirect.redirectTo('favviewedit',{chatid:a,oldValue:e})}}},onTapChild:function(e,d){if(this.stopTap){this.stopTap=!1;return}var b=d.record;if(b){var a=b.data.chatid;User.lastChatId=User.crtChannelId;User.crtChannelId=a;User.crtChatName=b.data.text;var c=Ext.getStore('comRct').getById(a);if(!c){Utils.custAjax('get','users/me/chats/'+User.crtChannelId,{success:function(c){var g=c.chat_id;if(c.iscrowd=='Y'){c.chat_type='C'}if(c.chat_type=='D'){c.chat_name=c.chat_name.replace(/__/,',');var f=c.chat_name.split(',');g=f[0];if(f[0]==User.ownerID){g=f[1]}}Ext.getStore('comRct').add({chat_id:a,name:User.crtChatName,type:c.chat_type,members:c.members,last_post_at:new Date(0),create_at:c.create_at,avaID:g,manager_id:c.creator_id,IsMute:c.is_mute});var h='INSERT OR REPLACE INTO IMChat '+'(ChatID, ChatType, DisplayName, CreatorID, ManagerID, CreateAt, UserIDs, Status, UpdateAt, AvatarHash) VALUES'+'(?,?,?,?,?,?,?,?,?,?);';LocalDataMgr.cExecSqlWithP(h,[c.chat_id,c.chat_type,User.crtChatName,c.creator_id,c.manager_id,c.create_at,c.chat_name,'0',c.update_at,c.avatar_hash]);LocalDataMgr.aboutIMChat(c);MobileHelper.getChatType(a);Redirect.redirectTo('chatview',{chatid:a,chatname:b.data.text})}})}else {MobileHelper.getChatType(a);Redirect.redirectTo('chatview',{chatid:a,chatname:b.data.text})}}},updateFav:function(){var f=this,c=f.getStore();User.favChanged=!0;c.removeAll();if(User.favChats&&User.favChats.length>0){User.favChanged=!0;var e=[];for(var d=0;d<User.favChats.length;d++){var a={};var b=User.favChats[d];if(b.iscrowd=='Y'){b.chat_type='C'}a.text=b.fav_name||b.header;a.chatid=b.chat_id;a.chattype=b.chat_type;a.create_at=b.create_at;a.leaf=!0;a.orgtype='F';a.parentId='Favorite';a.avaID=b.avaID||b.chat_id;a.fav_index=b.fav_index;e.push(a)}c.add(e)}else {Utils.custAjax('get','users/me/chatfavorites',{success:function(d){User.favChats=d;var f=[];for(var e=0;e<d.length;e++){var a={};var b=d[e];a.text=b.fav_name||b.header;a.chatid=b.chat_id;a.chattype=b.iscrowd=='Y'?'C':b.chat_type;a.create_at=b.create_at;a.leaf=!0;a.orgtype='F';a.parentId='Favorite';a.avaID=b.avaID||b.chat_id;a.fav_index=b.fav_index;f.push(a)}c.add(f)},failure:function(a){User.favChanged=!1;Utils.toastLong(a)}})}},setNewValue:function(a){var d=this;for(var b=0;b<User.favChats.length;b++){if(User.favChats[b].chat_id==a.chat_id){User.favChats[b]=a;break}}var c=d.store.find('chatid',a.chat_id);if(c>-1){var e=d.store.getAt(c);e.set('text',a.fav_name)}}});Ext.define('IMMobile.view.IMMobileMain.details.FavViewEdit',{extend:'IMMobile.view.base.Container',xtype:'favviewedit',controller:'IMMobileMeController',viewModel:{data:{oldValue:'',newValue:''}},userCls:'chatHeaderView',items:[{xtype:'IMMobile-Navbar',itemId:'itemTitle',backBtn:!0,title:'编辑收藏标题',userCls:'hasRightButton',items:[{text:'确定',handler:'onChangeFavTitle',width:60,docked:'right',bind:{disabled:'{oldValue==newValue}'}}]},{margin:'10 0 0 0',xtype:'textfield',itemId:'txtValue',bind:{value:'{newValue}'},listeners:{painted:function(a,b){a.focus()}}}],initialize:function(){var a=this;a.callParent(arguments);var b=a.getViewModel();b.setData({oldValue:a.config.oldValue,newValue:a.config.oldValue})}});Ext.define('IMMobile.view.IMMobileMain.details.NoticeSetting',{extend:'IMMobile.view.base.Container',xtype:'noticesetting',controller:'noticesettingController',padding:'20 0',viewModel:{},userCls:'noticeSetting',items:[{xtype:'IMMobile-Navbar',title:'消息通知'},{xtype:'fieldpanel',items:[{xtype:'container',layout:'hbox',userCls:'btn-toggle mobile-toggle',docked:'top',items:[{xtype:'label',html:'接收消息通知',flex:1,userCls:'toggle-label'},{xtype:'togglefield',itemId:'btnDemo',bind:{value:'{notify ? true : false}'},listeners:{change:'toggleRemoteNotify'}}]}]}],initialize:function(){var b=this;b.callParent(arguments);var a=localStorage.getItem('notify');a=Ext.decode(a)||{notify:!0,sound:!0,alert:!0};var c=b.getViewModel();c.setData(a);localStorage.setItem('notify',Ext.encode(a))}});Ext.define('IMMobile.view.IMMobileMain.details.NoticeSettingController',{extend:'Ext.app.ViewController',alias:'controller.noticesettingController',toggleRemoteNotify:function(c,b){var a=Ext.decode(localStorage.getItem('notify'));if(a.notify==b){return}if(a.notify){a.notify=!1;localStorage.setItem('notify',Ext.encode(a));localStorage.isreceivenotify='N';PushNotification.stopPushNotify()}else {a.notify=!0;localStorage.setItem('notify',Ext.encode(a));localStorage.isreceivenotify='Y';PushNotification.startPushWork()}this.getView().getViewModel().setData({notify:a.notify})},notifyConfigChange:function(d,b){var a=Ext.decode(localStorage.getItem('notify'));var c=d.key;if(a[c]!=b){a[c]=b;localStorage.setItem('notify',Ext.encode(a))}}});Ext.define('IMMobile.view.IMMobileMain.details.Privacy',{extend:'Ext.Container',xtype:'details_privacy',cls:'about bottominset',layout:'vbox',items:[{xtype:'IMMobile-Navbar',title:'隐私协议'},{xtype:'component',flex:1,height:'100%',userCls:'frame-wrapper',html:'<iframe src="http://www.pushsoft.cn/Privacy.html"></iframe>'}],initialize:function(){var a=this;a.callParent(arguments)}});Ext.define('IMMobile.view.IMMobileMain.details.SettingController',{extend:'Ext.app.ViewController',alias:'controller.settingController',execLogout:function(){this.fireEvent('logout')},toAbout:function(){Ext.Viewport.lookup('IMMobile').push({xtype:'about'})},toNoticeSetting:function(){Ext.Viewport.lookup('IMMobile').push({xtype:'noticesetting'})},toggleOutWeb:function(c,b){var a=localStorage.getItem('outWeb');if(b==a){return}a=1;if(!b){a=0}localStorage.setItem('outWeb',a)},toChgPwd:function(){Ext.Viewport.lookup('IMMobile').push({xtype:'IMMobile-ChangePwd'})}});Ext.define('IMMobile.view.IMMobileMain.details.setting',{extend:'IMMobile.view.base.Container',xtype:'IMMobile-Setting',controller:'settingController',requires:['IMMobile.view.IMMobileMain.details.SettingController','IMMobile.view.base.button.ArrowButton','IMMobile.view.widget.Navbar'],viewModel:{data:{outWeb:0}},cls:'noticeSetting',layout:'vbox',items:[{xtype:'IMMobile-Navbar',title:'设置'},{xtype:'component',html:'打开超链接',cls:'component-row-info'},{xtype:'container',layout:'hbox',userCls:'btn-toggle mobile-toggle',items:[{xtype:'label',html:'启用外部浏览器',flex:1,userCls:'toggle-label'},{xtype:'togglefield',itemId:'btnDemo',bind:{value:'{outWeb ? true : false}'},listeners:{change:'toggleOutWeb'}}]},{xtype:'baseBackcolor',padding:'20 0',flex:1,items:[{xtype:'arrButton',arrText:'消息通知',style:'color: #0d1114;',iconCls:'fa-angle-right',handler:'toNoticeSetting',cls:'immb_tongzhi thin-border'},{xtype:'arrButton',arrText:'关于',style:'color: #0d1114;',iconCls:'fa-angle-right',handler:'toAbout',cls:'immb_about'},{xtype:'arrButton',width:'100%',text:'退出登录',style:'color: red;margin-top:20px;text-align: center',handler:'execLogout',cls:'immb_tongzhi'}]}],initialize:function(){var a=this;a.callParent(arguments);a.down('IMMobile-Navbar').getBackBtn().setText('我');a.getOueWeb()},getOueWeb:function(){var b=this,c=b.getViewModel(),a=localStorage.getItem('outWeb');if(!parseInt(a,10)){a=0}c.setData({outWeb:a})}});Ext.define('IMMobile.view.IMMobileMain.details.UpdateDetail',{extend:'IMMobile.view.base.Container',xtype:'updatedetail',viewModel:{},scrollable:!0,items:[{xtype:'IMMobile-Navbar',title:'版本介绍'},{xtype:'container',itemId:'imgContain',bind:{html:'<img src="{url}" style="width: 100%;">'}}],initialize:function(){var a=this;a.callParent(arguments);a.getViewModel().setData({url:a.config.url});a.imgDom=a.down('#imgContain').el.dom;a.imgDom.onerror=Ext.bind(a.onImageError,a)},onImageError:function(){me.imgDom.src=''}});Ext.define('IMMobile.view.IMMobileMain.details.UpdateDetail2',{extend:'IMMobile.view.base.Container',xtype:'updatedetail2',viewModel:{},scrollable:!0,classCls:'update-detail',items:[{xtype:'IMMobile-Navbar',title:'版本介绍'},{xtype:'container',itemId:'itemContain'}],initialize:function(){var a=this;a.callParent(arguments);a.initItems()},initItems:function(){var d=this,e=d.down('#itemContain'),b=d.config.content,a=[],c=1;if(!b||b.length<1){return}b.forEach(function(b){var d='';switch(b.label){case 'h1':case 'h2':d='<div class="'+b.label+'">'+b.text+'</div>';c=1;break;case 'h3':d='<div class="h3">'+c+'.'+b.text+'</div>';c++;break;case 'dsc':d='<div class="dsc">-'+b.text+'</div>';break;case 'url':d='<img src="'+b.text+'">';break;default:break;}a.push(d)},this);a=a.join('');e.add({html:a})}});Ext.define('IMMobile.view.IMMobileMain.details.UpdateDetail3',{extend:'IMMobile.view.base.Container',xtype:'updatedetail3',viewModel:{},scrollable:!0,classCls:'update-detail',items:[{xtype:'IMMobile-Navbar',title:'版本介绍'},{xtype:'container',itemId:'itemContain'}],initialize:function(){var a=this;a.callParent(arguments);a.initItems()},initItems:function(){var c=this,f=c.down('#itemContain'),d=c.config.content,g=c.config.imgs,a,b=[],e=1;if(!d||d.length<1){return}d.forEach(function(a){var c='';switch(a.label){case 'h1':case 'h2':c='<div class="'+a.label+'">'+a.text+'</div>';e=1;break;case 'h3':c='<div class="h3">'+e+'.'+a.text+'</div>';e++;break;case 'dsc':c='<div class="dsc">-'+a.text+'</div>';break;default:break;}b.push(c)},this);b=b.join('');f.add({html:b});if(g.length==0){return}g.forEach(function(b){if(!a){a=Ext.create('Ext.Container',{itemId:'imgContain',scrollable:!0,cls:'img-contain'})}a.add({cls:'img-item',html:'<img src="'+b.url+'" style="width: 100%;">'})},this);f.add(a);if(a){a.el.on({scope:c,tap:'onTapImg'})}},onTapImg:function(h,d){var a=this,g=Ext.fly(d);if(g.is('img')){var f=d.src,c=a.config.imgs,e=0;if(!a.imgCarousel){a.imgCarousel=Ext.create('Ext.carousel.Carousel',{itemId:'imgcarousel',cls:'imgcarouselviewer',fullscreen:!0,style:'background-color: #fff;'})}for(var b=0;b<c.length;b++){a.imgCarousel.add({cls:'img-item',html:'<img src="'+c[b].url+'" style="width: 100%;">'});if(f.endsWith(c[b].url)){e=b}}a.imgCarousel.setActiveItemIndex(e);a.imgCarousel.show();a.imgCarousel.el.on({scope:a,singletap:function(){a.imgCarousel.destroy();a.imgCarousel=''}});a.imgCarousel.onBack=function(){a.imgCarousel.destroy();a.imgCarousel=''}}}});Ext.define('IMMobile.view.IMMobileMain.details.UpdateInfoList',{extend:'IMMobile.view.base.Container',xtype:'updateInfolist',layout:'vbox',items:[{xtype:'IMMobile-Navbar',title:'更新日志'},{xtype:'list',flex:1,userCls:'rctChat',itemsFocusable:!1,selectable:!1,scrollable:!0,disableSelection:!0,store:{fields:[{name:'updateAt',convert:function(a){a=Ext.Date.format(new Date(a),'Y年m月d日');return a}}]},itemTpl:'<tpl if="values.visiable">'+'<div class="itemRight">'+'<div class="displayInfo">'+'<div class="displayName">{version} 版本介绍</div>'+'<div class="displayMsg">{updateAt}</div>'+'</div>'+'<div class="x-fa fa-angle-right"></div>'+'</div>'+'</tpl>'}],initialize:function(){var a=this;a.down('list').on({scope:a,childtap:'onTap'});a.updateInfo()},updateInfo:function(){var a=this;a.down('list').getStore().add(LaunchPicture.PhoneJson())},onTap:function(d,a){var b=a.record.data.content2;var c=a.record.data.imgs;Redirect.redirectTo('updatedetail3',{content:b,imgs:c})}});Ext.define('IMMobile.view.IMMobileMain.details.UserInfoEdit',{extend:'IMMobile.view.base.Container',xtype:'userinfoedit',controller:'IMMobileMeController',viewModel:{data:{oldValue:'',newValue:''}},userCls:'chatHeaderView',items:[{xtype:'IMMobile-Navbar',itemId:'itemTitle',backBtn:!0,title:'',userCls:'hasRightButton',items:[{text:'确定',handler:'onChangeUserInfo',width:60,docked:'right',bind:{disabled:'{oldValue==newValue}'}}]},{margin:'10 0 0 0',xtype:'textfield',itemId:'txtValue',bind:{value:'{newValue}'},listeners:{painted:function(a,b){setTimeout(function(){a.focus()},300)}}}],initialize:function(){var a=this;a.callParent(arguments);var d=a.getViewModel();d.setData({oldValue:a.config.oldValue,newValue:a.config.oldValue});var b='个人信息';var c=a.config.field;if(c=='mobile'){b='电话'}else {if(c=='email'){b='邮箱'}else {if(c=='notes'){b='签名'}}}a.down('#itemTitle').setTitle(b)}});Ext.define('IMMobile.view.IMMobileMain.details.UserInfoView',{extend:'IMMobile.view.base.Container',xtype:'userinfoview',controller:'IMMobileMeController',viewModel:{},userCls:'userinfo',items:[{xtype:'IMMobile-Navbar',title:'个人信息',docked:'top'},{xtype:'button',cls:'immb_meinfoava selfAva',ui:'flat',width:'100%',bind:{text:'<div><div class="float-left btnLabel" style="line-height:55px;">头像</div><div class="float-right" style="line-height:0;"><image class="avatarPic" src="{tokenAvt}"></div><span class="fa fa-angle-right"></span></div>'},handler:'onOpenAvatar'},{xtype:'button',width:'100%',ui:'flat',cls:'immb_meinfoava thin-border',itemId:'btnUserID',bind:{text:'<div><div class="float-left btnLabel">编号</div><div class="float-right btnValue">{user_id}</div></div>'}},{xtype:'button',width:'100%',ui:'flat',cls:'immb_meinfo thin-border',bind:{text:'<div><div class="float-left btnLabel">名称</div><div class="float-right btnValue">{user_name}</div></div>'}},{xtype:'button',width:'100%',ui:'flat',cls:'immb_meinfo thin-border',bind:{text:'<div><div class="float-left btnLabel">性别</div><div class="float-right btnValue">{sex=="F"?"女":"男"}</div></div>'}},{xtype:'button',width:'100%',ui:'flat',cls:'immb_meinfo thin-border',bind:{text:'<div><div class="float-left btnLabel">部门</div><div class="float-right btnValue">{org_names}</div></div>'}},{xtype:'button',width:'100%',ui:'flat',cls:'immb_meinfo ',bind:{text:'<div><div class="float-left btnLabel">职务</div><div class="float-right btnValue">{def_role_name}</div></div>'}},{xtype:'button',width:'100%',ui:'flat',cls:'immb_meinfoava thin-border',itemId:'btnmobile',field:'mobile',handler:'onOpenUserInfoEdit',bind:{text:'<div><div class="float-left btnLabel">手机</div><div class="float-right btnValue">{mobile}</div><span class="fa fa-angle-right"></span></div>'}},{xtype:'button',width:'100%',ui:'flat',cls:'immb_meinfo thin-border',itemId:'btnemail',field:'email',handler:'onOpenUserInfoEdit',bind:{text:'<div><div class="float-left btnLabel">邮箱</div><div class="float-right btnValue">{email}</div><span class="fa fa-angle-right"></span></div>'}},{xtype:'button',width:'100%',ui:'flat',cls:'immb_meinfo',itemId:'btnnotes',field:'notes',handler:'onOpenUserInfoEdit',bind:{text:'<div class="allLabel"><div class="btnLabel">签名</div><div class="middle"><div class="divSign btnValue">{notes}</div></div><span class="fa fa-angle-right"></span></div>'}}],initialize:function(){var b=this;b.callParent(arguments);b.down('IMMobile-Navbar').getBackBtn().setText('我');User.crtUser.tokenAvt=ImgUtil.onePxImg;var a={};Ext.apply(a,User.crtUser);var c=ConfigMgr.getDataDirectory()+User.getUserAvaDir();if(Ext.os.is.iOS){var d=FSUtil.parse(0,User.getUserAvaDir());c=d.full}a.tokenAvt=c+User.ownerID+'.png?'+User.cacheMil;b.getViewModel().setData(a)},setNewValue:function(b,c){User.crtUser[b]=c;var a={};a[b]=c;this.getViewModel().setData(a)}});Ext.define('MMobile.view.IMMobileMain.UserSearch',{extend:'Ext.dataview.List',xtype:'immobile_usersearch',controller:'usersearchcontroller',userCls:'mobileNestList',items:[{xtype:'searchtitlebar',itemId:'searchBar',docked:'top',backButton:{handler:'onBack'},searchText:{listeners:{buffer:500,change:'onSearchChange',action:'onSearchAction',painted:function(a,b){a.focus()}}}}],store:{idProperty:'UserID',fields:['UserID','UserName']},itemTpl:['<div class="icon-select x-fa"></div>','<div class="nested-org">','<image class="nested-user-avatar" src="{[ImgUtil.onePxImg]}" onload="AvatarMgr.loadAvt2(this,0);"  data-user="{UserID}" data-type="D" width="30" height="30">','<div>{UserName}</div>','</div>'].join(''),listeners:{childtap:{fn:function(c,b,e){var a=b.record;var d=a.data.UserID;if(d!==User.ownerID){c.up('sheet').hide();Redirect.redirectTo('IMMobile-memDetail',{userid:a.data.UserID,username:a.data.UserName})}}}},initialize:function(){var a=this;a.callParent(arguments)}});Ext.define('IMMobile.view.chatView.UserSearchContain',{extend:'Ext.Sheet',xtype:'usersearchcontain',hideOnMaskTap:!0,exit:null,stretchX:!0,stretchY:!0,hidden:!1,scrollable:!0,layout:'vbox',cls:'docked-bottom',items:[{xtype:'container',itemId:'holder',cls:'topinset',docked:'top',style:'background-color: #f5f5f5;'},{xtype:'immobile_usersearch'}],initialize:function(){var a=this;var b=a.down('#holder').el.dom.clientHeight;a.callParent(arguments);if(window.cordova){StatusBar.styleDefault()}a.totalHeight=45+b;a.setHeight(a.totalHeight);a.on({beforehide:'onBeforeHide',hide:'onHide',scope:a})},onBeforeHide:function(){if(this.targetBtn){this.targetBtn.show()}},onHide:function(){if(window.cordova){StatusBar.styleLightContent()}this.destroy()}});Ext.define('IMMobile.view.IMMobileMain.UserSearchController',{extend:'Ext.app.ViewController',alias:'controller.usersearchcontroller',onBack:function(){var b=this,a=b.getView();a.up('sheet').hide()},onSearchChange:function(f,c,e,g){var d=this,b=d.getView(),a=b.up('sheet');if(c==''){b.getStore().removeAll();a.setHeight(a.totalHeight);return}LocalDataMgr.searchUsers(c,function(m){var l=m.rows;var d=[];for(var i=0;i<l.length;i++){var h=l.item(i);d.push({UserID:h.UserID,UserName:h.UserName,Organizations:h.Organizations})}try{d=d.filter(function(a){return JSON.parse(a.Organizations).map(function(b){return b.corp_id}).indexOf(User.crtCorpID)>-1});if(!ConfigMgr.showOrgRoot()){var k=User.grpOrgs.find(function(a){return a.corp_id==User.crtCorpID});var j=k?k.org_id:null;if(j){d=d.filter(function(a){return JSON.parse(a.Organizations).filter(function(b){return b.corp_id==User.crtCorpID}).map(function(b){return b.org_id}).filter(function(b){return b!==j}).length>0})}}}catch(n){}b.getStore().loadData(d);a.setHeight(null)})},onSearchAction:function(a,c,b){a.blur()}});Ext.define('IMMobile.view.IMMobileMain.details.Userterms',{extend:'Ext.Container',xtype:'details_userterms',cls:'about bottominset',layout:'vbox',items:[{xtype:'IMMobile-Navbar',title:'用户协议'},{xtype:'component',flex:1,height:'100%',userCls:'frame-wrapper',html:'<iframe src="http://www.pushsoft.cn/UserTerms.html"></iframe>'}],initialize:function(){var a=this;a.callParent(arguments)}});Ext.define('IMMobile.view.IMMobileMain.details.aio8.CorpSelector',{extend:'Ext.List',xtype:'corpselector',defaultListenerScope:!0,scrollable:'y',cls:'corpSelector',items:[{xtype:'IMMobile-Navbar',title:'账套切换'}],store:{},itemTpl:'<div class="corp_body">\n            <tpl if="values.tag == \'Y\'">\n            <span class="corp_body-curr">[当前账套]</span>\n            </tpl>\n            {text}\n            </div>',listeners:{childtap:'onSelCorp'},initialize:function(){var c=this;c.callParent(arguments);var a=User.grpOrgs.map(function(a){return {value:a.corp_id,text:a.name,tag:'N'}});var b=a.filter(function(a){return a.value==User.crtCorpID});if(b.length>0){b[0].tag='Y'}c.getStore().loadData(a)},onSelCorp:function(f,c){var b=this;var e=b.down('IMMobile-Navbar');var d=e.getBackBtn();var a=c.record;if(a){User.crtCorpID=a.get('value');d._handler();b.fireEvent('afterSelCorp')}}});Ext.define('IMMobile.view.IMMobileMain.details.fileManager.CatecotiesController',{extend:'Ext.app.ViewController',alias:'controller.catecotiescontroller',chgSelectOption:function(){var e=this,b=e.getView(),c=b.getViewModel();var d='selectMulti',a=c.getData()[d];c.setData({selectMulti:!a});if(a){b.down('filetpl').resetState()}},onBack:function(){var a=Ext.Viewport.down('IMMobile');a.pop()},onFirstFilter:function(c,a,b){if(a=='outbox'){c.setValue(b);this.openOutBox2();return}var e=this,d=e.getView(),f=d.getViewModel();f.setData({firstFilter:a})},openOutBox2:function(){var f=this,d=f.getView();var e=Ext.Viewport.lookup('IMMobile'),a=e.down('msgview'),b=e.down('IMMobile-Editor');var c=b.down('#MobileEditor').getMultiValue();Config.ChooseFile='Y';if(Ext.os.is.android){window.fileChooser.open(function(c){UpFileMgr.formOutBox=1;Config.ChooseFile='N';d.down('IMMobile-Navbar').down('#back').onClick();if(c.startsWith('content://')){Utils.toastShort('受到未知力量影响，无法发送')}if(!c.startsWith('file://')){c='file://'+c}FileMgr.getFileSize(c).then(function(e){var d=[{path:c,size:e,type:MsgType.FileMsg}];SendUtil.beforeSend(User.crtChannelId).then(function(){SendUtil.sendMsgsByOneAPI(User.crtChannelId,d,[],function(d){return b.bindLocal(a,a.getStore(),d)})})})})}else {ImgMgr.chooseImages().then(function(e){d.down('IMMobile-Navbar').down('#back').onClick();Config.ChooseFile='N';UpFileMgr.formOutBox=e.images.length;e.images.forEach(function(a){var b={type:MsgType.FileMsg,width:a.width,height:a.height,path:a.path,size:a.size};c.msgs.push(b)});SendUtil.sendMsg2(c,User.crtChannelId,function(c){return b.bindLocal(a,a.getStore(),c)})})['catch'](function(a){Config.ChooseFile='N';Utils.toastShort(a)})}},openOutBox:function(){var c=this,b=c.getView(),d=b.down('filetpl');var a=document.createElement('input');a.type='file';window.getOutBox=function(n){var a=n.target.files;var c={};c.chat_id=User.crtChannelId;c.files=a;if(a[0].size>1024*1024*20){Utils.toastShort('选择文件不大于20M');return}var i=ParseUtil.getLocalTime(!0),f=LocalDataMgr.newGuid();var d=[{chatID:User.crtChannelId,chat_id:User.crtChannelId,localMsgID:f,localPath:a[0].name,fileSize:a[0].size,fileStatus:3,fileName:a[0].name,senderID:User.ownerID,senderName:User.crtUser.user_name,msg_type:MsgType.FileMsg,updateTime:i,sendStatus:2,ROL:'right',showTime:!1,waitMsg:'等待上传...'}];b.down('IMMobile-Navbar').down('#back').onClick();var j=Ext.Viewport.lookup('IMMobile'),e=j.down('msgview'),m=j.down('IMMobile-Editor');m.bindLocal(e,e.getStore(),d);LocalDataMgr.updateRctBySend(a[0].name,ParseUtil.getLocalTime(!0),User.crtChannelId,MsgType.FileMsg);LocalDataMgr.doSendFileLocal(d[0]);var k='[文件]',h=Ext.getStore('comRct');if(h){var g=h.getById(User.crtChannelId);if(g){g.set({last_post_msg:k,last_msg_type:MsgType.FileMsg,last_post_at:new Date(i),last_post_id:User.ownerID,last_post_name:User.crtUser.user_name,chat_id:User.crtChannelId})}}var l=[{chat_id:User.crtChannelId,msg_type:MsgType.FileMsg,user_id:User.ownerID,user_name:User.crtUser.user_name,size:a[0].size,path:a[0].path,message:a[0].name}];SendUtil.doSendAPI(l,function(a){var b=e.getStore().findRecord('localMsgID',f);if(b){b.set({sendStatus:0,updateTime:a[0].create_at,msg_id:a[0].msg_id,msgSeq:a[0].msg_seq,attach_id:a[0].attach_id})}c.attach_id=a[0].attach_id;c.msg_id=a[0].msg_id;c.create_at=a[0].create_at;OutBoxUpFile.upFiles(c);LocalDataMgr.doSendFileSuccess(d[0],a[0])})};a.addEventListener('change',window.getOutBox);a.click()},onSecondFilter:function(e,a){var c=this,b=c.getView(),d=b.getViewModel();d.setData({secondFilter:a})},onChildTap:function(a,p){console.log('onChildTap');if(a.longpress){a.longpress=!1;return}var w=this,q=w.getView(),o=q.getViewModel(),b=q.down('filetpl');var y=o.getData()['firstFilter'],s=o.getData()['selectMulti'];var v=p.sourceElement,g=Ext.fly(v);var c=p.record;if(g.is('.item-header')||g.findParent('.item-header')){var j=c.get('children');if(j&&j.length>0){var r=c.get('showChildren');c.set('showChildren',!r)}else {if(j&&j.length==0){var e=c.get('text'),h=b.chooseSqlFn(b.dataId),i=h[1],n=h[2];if(e&&i){LocalDataMgr[i](e,function(l,k){var g=k.rows;if(g.length>0){var f=[];for(var h=0;h<g.length;h++){var d=g.item(h);if(f.length<a.customPageSize){d.leaf=!0;d.parent=e;d.recID=b.dataId.substr(0,1)+d.ID;if(a.selectArray&&a.selectArray.length>0){for(var i=0;i<a.selectArray.length;i++){if(a.selectArray[i].recID==d.recID){d.checked=!0;break}}}f.push(d);b.updateDataArray(b.dataId,d,'A')}else {var j={parent:e,loadTip:!0,recID:'waitload',text:'加载更多...',CreateAt:d.CreateAt};f.push(j);b.updateDataArray(b.dataId,j,'A');break}}c.set('showChildren',!0);c.set('children',f)}},n)}}}}else {if(g.findParent('.item-body')&&s){var k=g.findParent('.item-body').getAttribute('recID'),m=b.getChild(c,k,'checked');if(!m&&a.selectArray.length==9){return}var d=b.setChild(c,k,'checked',!m),f=d.FilePath;a.relevanceData(d,'R');if(!m){if(Config.isPhone){if(!f.toLowerCase().startsWith('file://')){f=ConfigMgr.getDefaultDir()+f}if(f.split(ConfigMgr.getSecDefaultDir())[1]){f=ConfigMgr.getDefaultDir()+f.split(ConfigMgr.getSecDefaultDir())[1]}else {if(d.FilePath.indexOf('Inbox/')>-1){f=window.cordova.file.documentsDirectory+'Inbox/'+d.FilePath.split('Inbox')[1]}}d.FilePath=f}d.path=f;d.dataId=b.dataId;a.selectArray.push(d)}else {if(a.selectArray.length>0){for(var l=0;l<a.selectArray.length;l++){if(a.selectArray[l].recID==d.recID){a.selectArray.splice(l,1);break}}}}o.setData({selFilesLen:a.selectArray.length})}else {if(g.findParent('.item-body')){var k=g.findParent('.item-body').getAttribute('recID'),t=b.getChild(c,k,'All');Redirect.redirectTo('filedetails',{file:t})}else {if(g.is('.waitload')){var u=b.getChild(c,'waitload','All');a.removeChilds(c,['waitload']);a.relevanceData(u,'D');var e=c.get('text'),h=b.chooseSqlFn(b.dataId),i=h[1],n=h[2],x=g.getAttribute('next_createat');if(e&&i){LocalDataMgr[i](e,function(m,l){var g=l.rows;if(g.length>0){var f=[];for(var h=0;h<g.length;h++){var d=g.item(h);if(f.length<a.customPageSize){d.leaf=!0;d.parent=e;d.recID=b.dataId.substr(0,1)+d.ID;if(a.selectArray&&a.selectArray.length>0){for(var i=0;i<a.selectArray.length;i++){if(a.selectArray[i].recID==d.recID){d.checked=!0;break}}}f.push(d);b.updateDataArray(b.dataId,d,'A')}else {var j={parent:e,loadTip:!0,recID:'waitload',text:'加载更多...',CreateAt:d.CreateAt};f.push(j);b.updateDataArray(b.dataId,j,'A');break}}var k=c.get('changeState');c.set('changeState',!k)}},n,x)}}}}}},openOptionMenu:function(c,b){var j=this,h=j.getView(),k=h.getViewModel();var d=k.getData()['selectMulti'];if(d){return}c.longpress=!0;var i=b.sourceElement,a=Ext.fly(i);if(a.is('.item-header')||a.findParent('.item-header')){}else {if(a.findParent('.item-body')){var e=b.record,f=a.findParent('.item-body').getAttribute('recID'),g=c.getChild(e,f,'All');Redirect.redirectTo('alertview',{data:g,'delete':!0,cancel:!0})}}},showOptions:function(){var c=this,b=c.getView(),a=b.config.file;Redirect.redirectTo('alertview',{data:a,transfer:!0,share:!0,cancel:!0})},openFileWithOthers:function(){var d=this,c=d.getView(),b=c.config.file,a=b.FilePath;if(!Config.isPhone){return}if(!a.toLowerCase().startsWith('file://')){a=ConfigMgr.getDefaultDir()+a}FileMgr.open(a)},fileTransfer:function(){var e=this,d=e.getView(),c=d.config.data,a=c.FilePath;var b=[];if(!Config.isPhone){return}if(!a.toLowerCase().startsWith('file://')){a=ConfigMgr.getDefaultDir()+a}b.push({path:a,size:c.FileSize,type:MsgType.FileMsg});Redirect.redirectTo('userselectview',{stype:'E',files:b});d.hide()},batchFileTransfer:function(){var g=this,f=g.getView(),a=f.down('list');var c=[];if(a.selectArray.length>0){for(var b=0;b<a.selectArray.length;b++){var d=a.selectArray[b];var e=d.path;c.push({path:e,size:d.FileSize,type:MsgType.FileMsg})}Redirect.redirectTo('userselectview',{stype:'E',files:c})}},sendFiles:function(){var i=this,f=i.getView(),c=f.down('filetpl');var g=Ext.Viewport.lookup('IMMobile');var a=User.crtChannelId,e=[];if(!a){return}if(c.selectArray.length>0){for(var d=0;d<c.selectArray.length;d++){var b=c.selectArray[d];var h=b.path;e.push({path:h,size:b.FileSize,type:MsgType.FileMsg,fileName:b.fileName})}}SendUtil.beforeSend(a).then(function(){SendUtil.sendMsgsByOneAPI(a,e,[],function(d){if(User.crtChannelId==a){var b=g.down('msgview'),c=g.down('IMMobile-Editor');return c.bindLocal(b,b.getStore(),d)}else {return !1}})});f.down('IMMobile-Navbar').down('#back').onClick()},fileShare:function(){var d=this,b=d.getView(),c=b.config.data,a=c.FilePath;if(!Config.isPhone){return}if(!a.toLowerCase().startsWith('file://')){a=ConfigMgr.getDefaultDir()+a}FileMgr.share(a).then(function(a){})['catch'](function(a){console.log(a)});b.hide()},batchFileShare:function(){var f=this,e=f.getView(),a=e.down('list');var c=[];if(a.selectArray.length>0){for(var b=0;b<a.selectArray.length;b++){var d=a.selectArray[b];c.push(d.path)}FileMgr.share(c).then(function(b){if(b.completed){a.resetState()}})['catch'](function(a){console.log(a)})}},fileDelete:function(){var h=this,f=h.getView(),a=f.config.data;a=Ext.isObject(a)?[a]:Ext.isArray(a)?a:[];var c=Ext.Viewport.down('filetpl'),g=c.getStore();if(a.length>0){for(var b=0;b<a.length;b++){var e=g.findRecord('text',a[b].parent);if(e){c.removeChilds(e,[a[b].recID]);c.relevanceData(a[b],'D')}if(c.dataId.indexOf('chat')>-1){LocalDataMgr.deleteCFile(a[b].ID)}else {LocalDataMgr.deleteWFile(a[b].ID)}var d=a[b].FilePath;if(!d.toLowerCase().startsWith('file://')){d=ConfigMgr.getDefaultDir()+d}}}c.resetState();f.hide()},batchFileDelete:function(){var c=this,b=c.getView(),a=b.down('list');if(a.selectArray&&a.selectArray.length>0){Redirect.redirectTo('alertview',{data:a.selectArray,'delete':!0,cancel:!0})}},onCancel:function(){var b=this,a=b.getView();a.hide()},toSearch:function(){var c=this,b=c.getView(),d=b.getViewModel();var a=d.getData()['firstFilter'];Ext.Viewport.down('IMMobile').layout.setAnimation({type:null});Redirect.redirectTo('filemgr-search',{type:a});if(Ext.os.is.iOS){$('input').focus()}},onCancelSearch:function(){var a=Ext.Viewport.down('IMMobile');a.pop()},onSearchChange:function(h,b,g){var f=this,d=f.getView();var e=d.type,c=d.getStore(),a;if(e=='chat'){a='searchCFile'}else {if(e=='worktop'){a='searchWFile'}}c.removeAll();if(!a||!b){return}d.keyWord=b;LocalDataMgr[a](b,function(f,e){var a=e.rows;if(a.length>0){for(var d=0;d<a.length;d++){c.add(a.item(d))}}else {c.add({isEmpty:!0})}})},onSearchAction:function(a){a.blur()},onTapSearchItem:function(d,c){var b=c.record,a=b?b.data:null;if(!a||a.isEmpty){return}Keyboard.hide();Redirect.redirectTo('filedetails',{file:a})}});Ext.define('IMMobile.view.IMMobileMain.details.fileManager.AlertView',{extend:'Ext.Sheet',xtype:'alertview',controller:'catecotiescontroller',requires:['IMMobile.view.IMMobileMain.details.fileManager.CatecotiesController'],hideOnMaskTap:!0,enter:'bottom',exit:'bottom',bottom:0,layout:'fit',stretchX:!0,hidden:!0,cls:'alert-view bottominset docked-bottom',config:{data:null,transfer:!1,share:!1,'delete':!1,cancel:!1},updateTransfer:function(a){if(!a){return}var b={xtype:'button',cls:'x-transfer',text:'转发',handler:'fileTransfer'};this.add(b)},updateShare:function(a){if(!a){return}var b={xtype:'button',cls:'x-share',text:'分享',handler:'fileShare'};this.add(b)},updateDelete:function(a){if(!a){return}var b={xtype:'button',cls:'x-delete',text:'删除',handler:'fileDelete'};this.add(b)},updateCancel:function(a){if(!a){return}var b={xtype:'button',cls:'x-calcel',text:'取消',handler:'onCancel'};this.add(b)},initialize:function(){var a=this;a.callParent(arguments);a.timer=setTimeout(function(){a.show()},250);a.on({scope:a,hide:'onDestroy'})},onDestroy:function(){var a=this;clearTimeout(a.timer);delete a.timer;this.destroy()}});Ext.define('IMMobile.view.IMMobileMain.details.fileManager.Categories',{extend:'Ext.Panel',xtype:'IMMobile-Catecoties',controller:'catecotiescontroller',requires:['IMMobile.view.IMMobileMain.details.fileManager.CatecotiesController'],cls:'catecoties',referenceHolder:!0,viewModel:{data:{firstFilter:'chat',secondFilter:'all',selectMulti:!1,fromChat:!1,selFilesLen:0}},items:[{xtype:'IMMobile-Navbar',userCls:'hasRightButton',title:'我的文件',items:[{xtype:'button',docked:'right',bind:{text:'{selectMulti ? "取消" : "编辑"}',disabled:'{fromChat}',style:'{fromChat ? "visibility: hidden" : "visibility: visible"}'},handler:'chgSelectOption'}]},{xtype:'container',cls:'catecoties-header',docked:'top',layout:'hbox',items:[{xtype:'segmentedbutton',cls:'catecoties-btns',listeners:{change:'onFirstFilter'},items:[{text:'会话',value:'chat',pressed:!0},{text:'工作台',value:'worktop'},{text:'本机',value:'outbox',bind:{hidden:'{!fromChat}'}}]}]},{xtype:'container',docked:'top',bind:{hidden:'{fromChat}'},items:[{xtype:'button',itemId:'chatsearch',ui:'flat',text:'搜索',iconCls:'im-mobile im-mobile-glass',iconAlign:'left',cls:'btnSearch',textAlign:'center',width:'100%',handler:'toSearch'}]},{xtype:'segmentedbutton',cls:'catecoties-body-btns',docked:'top',listeners:{change:'onSecondFilter'},items:[{text:'全部',value:'all',pressed:!0},{text:'文档',value:'file'},{text:'图片',value:'picture'}]},{xtype:'filetpl',flex:1,bind:{firstFilter:'{firstFilter}',secondFilter:'{secondFilter}',selectMulti:'{selectMulti}'}},{xtype:'container',reference:'operation',cls:'operation-bar bottominset',layout:'hbox',docked:'bottom',bind:{hidden:'{selectMulti ? fromChat ? true : false : true}'},defaults:{xtype:'button',margin:10,flex:1},items:[{iconCls:'x-fa fa-share-square-o',handler:'batchFileTransfer'},{iconCls:'x-fa fa-share-alt',handler:'batchFileShare'},{iconCls:'x-fa fa-trash-o',handler:'batchFileDelete'}]},{xtype:'container',cls:'send-bar bottominset',layout:'hbox',docked:'bottom',bind:{hidden:'{fromChat ? false : true}'},items:[{xtype:'button',margin:10,bind:{text:'发送{selFilesLen == 0 ? "" : "("+selFilesLen+")"}'},handler:'sendFiles'}]}],initialize:function(){var a=this;a.callParent(arguments);if(a.config.fromChat){a.getViewModel().setData({fromChat:!0,selectMulti:!0})}}});Ext.define('IMMobile.view.IMMobileMain.details.fileManager.FileDetails',{extend:'Ext.Container',xtype:'filedetails',controller:'catecotiescontroller',requires:['IMMobile.view.IMMobileMain.details.fileManager.CatecotiesController'],cls:'file-details',referenceHolder:!0,items:[{xtype:'IMMobile-Navbar',userCls:'hasRightButton',title:' ',items:[{xtype:'button',docked:'right',iconCls:'im-mobile im-mobile-more',handler:'showOptions'}]},{xtype:'container',reference:'detail',cls:'content',tpl:'\n        <tpl if="values.FileType == \'I\'">\n        <div style="background-image:url(\'{FilePath}\');width:100vw;height:90vh;background-repeat:no-repeat;background-size:contain;background-position:center;"></div>\n        <tpl else>\n        <div class="file-icon {[ParseUtil.getFileIcon(values.FileName)]}"></div>\n        <div class="file-name">{[ParseUtil.parseName(values.FileName)]}</div>\n        <div class="file-size">文件大小:{[ParseUtil.bytesToSize(values.FileSize)]}</div>\n        </tpl>'},{xtype:'button',reference:'openWithOthers',cls:'open-btn',text:'用其他应用打开',handler:'openFileWithOthers'}],initialize:function(){var d=this;d.callParent(arguments);var a=d.config.file,e=d.lookup('detail');var f='F',c=a.FilePath;if(!c.toLowerCase().startsWith('file://')){c=ConfigMgr.getDefaultDir()+c}else {if(c.indexOf('Inbox/')>-1&&Ext.os.is.ios){c=window.cordova.file.documentsDirectory+'Inbox/'+c.split('Inbox')[1]}}var b=c.split(ConfigMgr.getSecDefaultDir())[1];if(b){d.config.file.FilePath=b}else {d.config.file.FilePath=c}if(['jpg','jpeg','gif','png','bmp','webp'].indexOf(a.Extension)>-1&&c.indexOf('Inbox')<0&&b){d.lookup('openWithOthers').hide();if(b.startsWith('data:image')){e.setData({FileName:a.FileName,FileSize:a.FileSize,FileType:'I',FilePath:b});return}try{b=ConfigMgr.getSecDefaultDir()+decodeURIComponent(b)}catch(g){}FileMgr.exists(1,b).then(function(d){if(d){f='I';if(Ext.os.is.iOS){FileMgr.exists(0,b).then(function(c){if(c){e.setData({FileName:a.FileName,FileSize:a.FileSize,FileType:f,FilePath:c.toURL()})}else {FileMgr.copyTo(1,b,0,b).then(function(b){e.setData({FileName:a.FileName,FileSize:a.FileSize,FileType:f,FilePath:b})})}})}else {e.setData({FileName:a.FileName,FileSize:a.FileSize,FileType:f,FilePath:c})}}})}else {e.setData({FileName:a.FileName,FileSize:a.FileSize,FileType:f})}}});Ext.define('IMMobile.view.IMMobileMain.details.fileManager.FileTpl',{extend:'Ext.List',xtype:'filetpl',cls:'file-tpl',config:{firstFilter:null,secondFilter:null,selectMulti:!1},dataArray:[],selectArray:[],customPageSize:20,updateFirstFilter:function(e){var a=this,c=a.getSecondFilter();if(!c){return}var d=a.dataId=e+'_'+c,b=a.dataArray[d];if(!b||b.length==0){a.initChildNodes(d).then(function(a){if(a=='ok'){}})}else {a.getStore().setData(b)}},updateSecondFilter:function(e){var a=this,c=a.getFirstFilter();if(!c){return}var d=a.dataId=c+'_'+e;var b=a.dataArray[d];if(!b||b.length==0){a.initChildNodes(d).then(function(a){if(a=='ok'){}})}else {a.getStore().setData(b)}},updateSelectMulti:function(b){var a=this;User.fileMgrIsMulti=b;a.getStore().setData(a.dataArray[a.dataId])},scrollable:!0,itemsFocusable:!1,selectable:!1,disableSelection:!0,store:{},itemTpl:['<div class="item-main">','<tpl if="values.isEmpty">','<div style="text-align:center;">{text}</div>','<tpl else>','<div class="item-header">',"<div class=\"icon-el x-fa {[values.showChildren ? 'fa-caret-down' : 'fa-caret-right']}\"></div>",'<div class="title">{text}</div>','</div>','<tpl if="values.showChildren">','<tpl if="User.fileMgrIsMulti">','<tpl for="values.children">','<tpl if="values.loadTip">','<div class="waitload" next_createat="{CreateAt}">{text}</div>','<tpl else>','<div class="item-body" recID="{recID}">','<div class="im-mobile icon-select {[values.checked ? "selectedMan" : ""]}"></div>','<div class="file-icon {[ParseUtil.getFileIcon(values.FileName)]}"></div>','<div class="file-content">','<div class="file-name">{[ParseUtil.parseName(values.FileName)]}</div>','<div class="file-info">',"<div>{[Ext.Date.format(new Date(values.CreateAt), 'm-d')]}</div>",'<tpl if="values.DisplayName">','<tpl if="values.SenderID == User.ownerID">','<div class="from-chat">发给: {DisplayName}</div>','<tpl else>','<div class="from-chat">来自: {DisplayName}</div>','</tpl>','</tpl>','<div>{[ParseUtil.bytesToSize(values.FileSize)]}</div>','</div>','</div>','</div>','</tpl>','</tpl>','<tpl else>','<tpl for="values.children">','<tpl if="values.loadTip">','<div class="waitload" next_createat="{CreateAt}">{text}</div>','<tpl else>','<div class="item-body" recID="{recID}">','<div class="file-icon {[ParseUtil.getFileIcon(values.FileName)]}"></div>','<div class="file-content">','<div class="file-name">{[ParseUtil.parseName(values.FileName)]}</div>','<div class="file-info">',"<div>{[Ext.Date.format(new Date(values.CreateAt), 'm-d')]}</div>",'<tpl if="values.DisplayName">','<tpl if="values.SenderID == User.ownerID">','<div class="from-chat">发给: {DisplayName}</div>','<tpl else>','<div class="from-chat">来自: {DisplayName}</div>','</tpl>','</tpl>','<div>{[ParseUtil.bytesToSize(values.FileSize)]}</div>','</div>','</div>','</div>','</tpl>','</tpl>','</tpl>','</tpl>','</tpl>','</div>'].join(''),listeners:{childtap:'onChildTap',childlongpress:'openOptionMenu'},initialize:function(){var a=this;a.callParent(arguments);a.clearCache();a.on({scope:a,destroy:'clearCache'})},clearCache:function(){var a=this;a.dataArray=[];a.selectArray=[]},chooseSqlFn:function(d){var a,b,c;switch(d){case 'chat_all':a='getCFileYM';b='getCFileByMonth';break;case 'chat_file':a='getCFileYM';b='getCFileByMonthFile';c='F';break;case 'chat_picture':a='getCFileYM';b='getCFileByMonthFile';c='I';break;case 'worktop_all':a='getWFileYM';b='getWFileByMonth';break;case 'worktop_file':a='getWFileYM';b='getWFileByMonthFile';c='F';break;case 'worktop_picture':a='getWFileYM';b='getWFileByMonthFile';c='I';break;default:break;}return [a,b,c]},initChildNodes:function(b){var a=this;return new Promise(function(e,j){var c=[],f=a.getStore();var d=a.chooseSqlFn(b),g=d[0],h=d[1],i=d[2];if(g&&h){LocalDataMgr[g](a.getSecondFilter(),function(o,n){var g=n.rows;if(g&&g.length>0){for(var l=0;l<g.length;l++){var m=g.item(l);if(!m.MyTime){continue}c.push({text:m.MyTime,showChildren:!1,children:[]})}}else {c.push({text:'没有最近文件记录',isEmpty:!0,children:[]})}a.dataArray[b]=c;f.setData(c);var k=f.getAt(0),d=k?k.get('text'):null;if(d){LocalDataMgr[h](d,function(p,m){var g=m.rows;if(g.length>0){var f=[];for(var h=0;h<g.length;h++){var c=g.item(h);if(f.length<a.customPageSize){c.leaf=!0;c.parent=d;c.recID=b.substr(0,1)+c.ID;if(a.selectArray&&a.selectArray.length>0){for(var i=0;i<a.selectArray.length;i++){if(a.selectArray[i].recID==c.recID){c.checked=!0;break}}}f.push(c);a.updateDataArray(b,c,'A')}else {var l={parent:d,loadTip:!0,recID:'waitload',text:'加载更多...',CreateAt:c.CreateAt};f.push(l);a.updateDataArray(b,l,'A');break}}k.set('showChildren',!0);k.set('children',f);e('ok')}},i)}})}else {e(c)}})},updateDataArray:function(h,c,d){var j=this,a=j.dataArray[h],i=c.parent;if(a&&a.length>0){for(var b=0;b<a.length;b++){if(a[b].text==i){if(d=='A'){a[b].children.push(c)}else {if(d=='D'){for(var g=0;g<a[b].children.length;g++){if(a[b].children[g].recID==c.recID){a[b].children.splice(g,1);break}}}else {if(d=='R'){for(var e=0;e<a[b].children.length;e++){if(a[b].children[e].recID==c.recID){a[b].children[e].checked=c.checked;break}}}else {if(d=='C'){for(var f=0;f<a[b].children.length;f++){if(a[b].children[f].recID==c.recID){a[b].children[f].checked=!1;break}}}}}}break}}}},setChild:function(c,h,g,i){var a=c.data.children,f=c.get('changeState');var b='';if(!a||a.length==0){return b}for(var e=0;e<a.length;e++){var d=a[e];if(d.recID==h){d[g]=i;b=d;break}}c.set('changeState',!f);return b},getChild:function(f,g,e){var a=f.data.children;var b;if(!a||a.length==0){return b}for(var d=0;d<a.length;d++){var c=a[d];if(c.recID==g){b=c[e];if(e=='All'){b=c}break}}return b},removeChilds:function(c,f){var b=c.data.children,d=c.get('changeState');if(!b||b.length==0){return}for(var a=0;a<b.length;a++){var e=b[a];if(f.indexOf(e.recID)>-1){b.splice(a,1);a=a-1}}c.set('changeState',!d)},relevanceData:function(b,d,a){var c=this;if(!a){a=c.dataId}if(a.indexOf('all')<0){a=a.split('_')[0]+'_all'}else {if(FileUtil.imageFilter.extensions.indexOf(b.Extension)>-1){a=a.split('_')[0]+'_picture'}else {a=a.split('_')[0]+'_file'}}c.updateDataArray(a,b,d)},resetState:function(){var a=this,i=a.getStore();if(a.selectArray&&a.selectArray.length>0){for(var g=0;g<a.selectArray.length;g++){var b=a.selectArray[g];var h=i.findRecord('text',b.parent);if(h){a.setChild(h,b.recID,'checked',!1)}if(b.dataId!=a.dataId){var f=a.dataArray[b.dataId];for(var c=0;c<f.length;c++){if(b.parent==f[c].text){var e=f[c].children;for(var d=0;d<e.length;d++){if(b.recID==e[d].recID){e[d].checked=!1;break}}break}}}a.relevanceData(b,'C',b.dataId)}a.selectArray=[]}}});Ext.define('IMMobile.view.IMMobileMain.details.fileManager.SearchList',{extend:'Ext.dataview.List',xtype:'filemgr-search',controller:'catecotiescontroller',cls:'file-tpl topinset',items:[{xtype:'searchtitlebar',itemId:'searchBar',docked:'top',backButton:{handler:'onCancelSearch'},searchText:{listeners:{buffer:500,change:'onSearchChange',action:'onSearchAction',painted:function(a){a.focus()}}}}],scrollable:!0,itemsFocusable:!1,selectable:!1,disableSelection:!0,store:{},itemTpl:['<div class="item-main">','<tpl if="values.isEmpty">','<div style="text-align:center;">无搜索结果</div>','<tpl else>','<div class="item-body" style="border:0">','<div class="file-icon {[ParseUtil.getFileIcon(values.FileName)]}"></div>','<div class="file-content">','<div class="file-name">{[ParseUtil.parseName(values.FileName)]}</div>','<div class="file-info">',"<div>{[Ext.Date.format(new Date(values.CreateAt), 'm-d')]}</div>",'<tpl if="values.DisplayName">','<tpl if="values.SenderID == User.ownerID">','<div class="from-chat">发给: {DisplayName}</div>','<tpl else>','<div class="from-chat">来自: {DisplayName}</div>','</tpl>','</tpl>','<div>{[ParseUtil.bytesToSize(values.FileSize)]}</div>','</div>','</div>','</div>','</tpl>','</div>'].join(''),listeners:{childtap:'onTapSearchItem'},initialize:function(){var a=this;a.callParent(arguments);if(window.cordova){StatusBar.styleDefault()}a.currentType=a.config.type;a.getScrollable().on({scroll:'onLoadMore',scope:a});a.on({destroy:function(){if(window.cordova){StatusBar.styleLightContent()}},scope:a})},onLoadMore:function(h,l,m){var a=this,b=a.getStore(),g=b.count(),e=b.getAt(g-1),d;var c=h._scrollElement.dom,j=c.scrollHeight,k=c.scrollTop,i=c.clientHeight,f=j-k-i;if(f<5&&e.data.CreateAt){if(a.type=='chat'){d='searchCFileMore'}else {if(a.type=='worktop'){d='searchWFileMore'}else {return}}LocalDataMgr[d](a.keyWord,e.data.CreateAt,function(e,d){var a=d.rows;if(a.length>0){for(var c=0;c<a.length;c++){b.add(a.item(c))}}})}}});Ext.define('IMMobile.view.IMMobileMain.tapPanel.MapLocation',{singleton:!0,alternateClassName:'MapLocation',browserAK:'4di0zf1SqG9GqpZTZY4YgvIn',geoCoderUrl:'https://api.map.baidu.com/geocoder/v2/?ak={0}&output=json&location={1},{2}&coordtype={3}',mapUrl:'https://api.map.baidu.com/getscript?v=3.0&ak={0}',getPosition:function(f,b,c){var e=this;b=b||Ext.emptyFn;c=c||e;var a=function(d,a){if(a.addr){f.call(c,a.addr)}else {Ext.data.JsonP.request({url:Ext.String.format(e.geoCoderUrl,e.browserAK,a.coords.latitude,a.coords.longitude,d),success:function(e){if(e.status==0){f.call(this,e.result)}else {b.call(this,'error code: '+e.status)}},failure:b,scope:c})}};if(Ext.os.is.iOS){var d=Ext.os.is.iOS;navigator.geolocation.getCurrentPosition(function(d){a('wgs84ll',d)},function(e){navigator.geolocation.getCurrentPosition(function(d){a('wgs84ll',d)},function(a){var d=a.message;switch(a.code){case a.TIMEOUT:d='定位超时, 请重试';break;case a.PERMISSION_DENIED:d='您拒绝了使用位置共享服务';break;case a.POSITION_UNAVAILABLE:d='非常抱歉, 暂时无法为您提供位置服务';break;}Utils.ToastShort(d);b.call(c,d)},{enableHighAccuracy:d?!1:!0,timeout:60*1000*(d?1:2),maximumAge:1000*60*10})},{enableHighAccuracy:d?!0:!1,timeout:60*1000*(d?2:1),maximumAge:1000*60*10})}else {plugins.baiduLocation.getCurrentPosition(function(d){a('bd09ll',d)},function(d){if(d.code==61){a('bd09ll',d);Pnt.ToastShort('GPS定位成功')}else {if(d.code==65){a('bd09ll',d);Pnt.ToastShort('定位缓存的结果')}else {if(d.code==66){a('bd09ll',d);Pnt.ToastShort('离线定位成功')}else {if(d.code==68){a('bd09ll',d);Pnt.ToastShort('网络连接失败时，查找本地离线定位时对应的返回结果')}else {if(d.code==161){a('bd09ll',d);Pnt.ToastShort('网络定位成功')}else {b.call(c,d.message)}}}}}})}},openMap:function(a){var b=Ext.widget('baidumap',{latitude:a.latitude,longitude:a.longitude,address:a.address});b.show()}});Ext.define('IMMobile.view.IMMobileMain.tabPanel.IMMobileMeController',{extend:'Ext.app.ViewController',alias:'controller.IMMobileMeController',uses:['IMMobile.view.IMMobileMain.details.setting'],onOpenSetting:function(){Redirect.redirectTo('IMMobile-Setting')},onOpenFileManager:function(){Redirect.redirectTo('IMMobile-Catecoties')},onOpenUserInfo:function(){Redirect.redirectTo('userinfoview')},onOpenUserInfoEdit:function(a){var c=this,b=c.getView(),d=b.getViewModel();Ext.Viewport.down('IMMobile').layout.setAnimation({type:null});Redirect.redirectTo('userinfoedit',{field:a.field,oldValue:d.getData()[a.field]});if(Ext.os.is.iOS){$('input').focus()}},onChangeUserInfo:function(){var f=this,d=f.getView(),g=d.getViewModel();var e=g.getData(),b=e.newValue;var c=d.config.field;if(c=='mobile'){b=b+''}var a={};Ext.apply(a,User.crtUser);a.user_id=User.ownerID;a[c]=b;Utils.custAjax('put','users/me/info',{params:JSON.stringify(a),success:function(e){var d=Ext.Viewport.lookup('IMMobile');var a=d.pop();if(a.xtype=='userinfoview'){a.setNewValue(c,b)}},failure:function(){Utils.toastShort('请求更新失败')}})},onChangeFavTitle:function(){var e=this,a=e.getView(),f=a.getViewModel();var c=f.getData(),b=c.newValue;var d=a.config.chatid;Utils.custAjax('PUT','chatfavorite',{params:JSON.stringify({chat_id:d,user_id:User.ownerID,fav_name:b}),success:function(b){var c=Ext.Viewport.lookup('IMMobile');var a=c.pop();if(a.xtype=='favview'){a.setNewValue(b)}},failure:function(a){Utils.toastShort(a)}})},onOpenAvatar:function(){Redirect.redirectTo('avatarview')},onSelectNewPic:function(){var a=this;a.getPicture(navigator.camera.PictureSourceType.PHOTOLIBRARY)},onSelectPhoto:function(){var a=this;a.getPicture(navigator.camera.PictureSourceType.CAMERA)},getPicture:function(a){var c=this;Config.ChooseFile='Y';var b=a==navigator.camera.PictureSourceType.CAMERA;navigator.camera.getPicture(function(b){Config.ChooseFile='N';c.onUpload(b)},function(b){Config.ChooseFile='N';Utils.toastShort(b)},{quality:b?50:100,destinationType:navigator.camera.DestinationType.FILE_URI,sourceType:a,allowEdit:!0,targetWidth:250,targetHeight:250,correctOrientation:!0,saveToPhotoAlbum:!0})},onUpload:function(d){var f=this;var c=d;var b=new FileUploadOptions();b.fileKey='files';b.fileName=FileUtil.getFileName(c);b.mimeType='image/png';b.httpMethod='PUT';b.params={};var e=new FileTransfer();var a=f.getView();Utils.mask(a,'正在上传图片');e.upload(c,encodeURI(Config.httpUrlForGo+'users/'+User.ownerID+'/avatar?token='+User.token),function(c){Utils.unMask(a);var b=JSON.parse(c.response);if(b.status=='OK'){User.crtUser.avatar_hash=b.hash;User.needUpdateUserAva(User.ownerID,b.hash,function(b){if(a&&a.xtype=='avatarview'){var h='<image class="avatarPic" src="'+b+'"></div>';var g=a.down('#avatar');g.setHtml(h);g.path=b}var f=Ext.Viewport.lookup('IMMobile');var e=f.down('userinfoview');if(e){e.getViewModel().setData({tokenAvt:b})}f.down('#tabMe').getViewModel().setData({tokenAvt:b})})}else {Utils.unMask(a);Utils.toastShort('上传头像失败')}},function(b){Utils.unMask(a)},b)},onSaveImg:function(){var c=this,a=c.getView(),b=a.down('#avatar');plugins.wizUtils.saveToAlbum(function(){Utils.toastShort('成功保存到相册')},function(a){Utils.toastShort('保存失败: '+a)},b.path)}});Ext.define('IMMobile.view.IMMobileMain.MobileOrgController',{extend:'Ext.app.ViewController',alias:'controller.mobileorgcontroller',initOrgList:function(){var a=this;var b=a.getView(),c=b.getStore();if(!User.hasInitOrg){OrgDataHepler.initOrg(function(){a.createOrg()})}else {a.createOrg()}},createOrg:function(){var e=this,h=e.getView();var a=e.imitateOrgData(User.allUsers,User.organization);var d=a.children.map(function(a){return a.id});var c={id:'Favorite',text:'收藏',org_id:'00000000_Favorite',children:[],parentId:a.id,foldertype:'F'};if(!d.includes(c.id)){a.children.unshift(c)}if(!ConfigMgr.isAio8()){var f={id:'News',text:'消息中心',org_id:'00000000_BNews',children:null,parentId:a.id,cid:StaticChatID.News};a.children.unshift(f)}var b={id:'Group',text:'我的群组',org_id:'00000000_GCrowd',children:[],parentId:a.id,crowdtype:'C'};if(!d.includes(b.id)){a.children.unshift(b)}var g=Ext.create('Ext.data.TreeStore',{root:a,sorters:[{property:'org_id',direction:'ASC'},{property:'user_id',direction:'ASC'}],fields:['text']});h.setStore(g);User.orgStoreRoot=a},imitateOrgData:function(e,f){var a=this;if(User.grpOrgs.length==0){var c=ConfigMgr.isAio8()?a.addUser2OrgForAio8(f,e):a.addUser2OrgForAio75(f,e);var d=a.createRoot(c);User.grpOrgs=[];for(var b=0;b<d.length;b++){var g=a.addOrg(d[b],c);User.grpOrgs.push(g)}}var h=a.getCrtOrgs();return h},getCrtOrgs:function(){var a=User.grpOrgs[0]||{id:'root',text:'通讯录',children:[]};if(User.crtCorpID){for(var c=0;c<User.grpOrgs.length;c++){var d=User.grpOrgs[c];if(User.crtCorpID==d.corp_id){a=d;break}}}else {User.crtCorpID=a.corp_id}User.orgRootName=a.name||'通讯录';if(!ConfigMgr.showOrgRoot()){if(a.children){for(var b=0;b<a.children.length;b++){if(a.children[b].leaf){a.children.splice(b,1);b--}}}}return a},addUser2OrgForAio75:function(a,d){for(var b=0;b<a.length;b++){a[b].children=[];for(var c=0;c<d.length;c++){var f=d[c].org_ids.split(',');for(var e=0;e<f.length;e++){var g=f[e];if(g==a[b].org_id){var h=Ext.apply({text:d[c].user_name,leaf:!0,orgtype:'U'},d[c]);a[b].children.push(h);break}}}}return a},addUser2OrgForAio8:function(a,d){for(var b=0;b<a.length;b++){a[b].children=[];for(var c=0;c<d.length;c++){var f=d[c].roles||[];for(var e=0;e<f.length;e++){var g=f[e];if(g.org_id==a[b].org_id&&g.corp_id==a[b].corp_id){var h=Ext.apply({text:d[c].user_name,leaf:!0,orgtype:'U'},d[c]);a[b].children.push(h);break}}}}return a},createRoot:function(b){var c=[];for(var a=0;a<b.length;a++){if(b[a].parent_id===''&&b[a].org_id===''){continue}if(b[a].parent_id.toLowerCase()==='root'||b[a].parent_id===''){var d={id:b[a].org_id,name:b[a].org_name,text:b[a].org_name,leaf:!1,iconCls:'x-fa fa-folder',parent_id:b[a].parent_id,org_id:b[a].org_id,corp_id:b[a].corp_id,children:b[a].children};c.push(d)}}return c},addOrg:function(c,a){for(var b=0;b<a.length;b++){if(a[b].parent_id==c.org_id&&a[b].corp_id==c.corp_id){c.children.push({id:a[b].org_id,name:a[b].org_name,text:a[b].org_name,leaf:!1,iconCls:'x-fa fa-folder',parent_id:a[b].parent_id,org_id:a[b].org_id,corp_id:a[b].corp_id,children:a[b].children});this.addOrg(a[b],a)}}return c},toSearch:function(a){a.hide();var b=Ext.Viewport.lookup('IMMobile').push({xtype:'usersearchcontain'});b.targetBtn=a;if(Ext.os.is.iOS){$('input').focus()}},toCorpSelector:function(){var a=this;Redirect.redirectTo('corpselector',{listeners:{afterSelCorp:'initOrgList',scope:a}})},onBack:function(){var a=this.getView(),b=a.getDetailCard(),c=a.getLastNode(),d=b&&a.getActiveItem()==b,e=d?c:c.parentNode;if(e){this.getView().onBackTap();return !1}return !0}});Ext.define('IMMobile.view.IMMobileMain.WorkDeskController',{extend:'Ext.app.ViewController',alias:'controller.workdeskcontroller',abortHidden:!1,hideEvent:null,listen:{controller:{'*':{openModule:'openModule',openWebViewAtOnce:'openWebView',openbbcode:'onOpenbbcode'}}},openModule:function(d,f){var b=this;var g=b.getView();var c='',a='';if(ConfigMgr.isAio8()){g.onActivateAIO8(null,null,null,function(){var e=g.getStore();var a=e.findRecord('ModuleID',d);if(a){c=a.get('ModuleUrl');b.aio8InitUrl(d,c,f)}})}else {var e=f;switch(d){case 'receipt':a='receipt/ticket/edit/';a+='?key='+e;break;case 'mail':a=e.replace('V1/#','');break;case 'notice':a=e;break;default:a=d;break;}if(!window.workdesksession){b.getView().onActivate('','','',function(){c=b.initUrl('V1/',a);b.openWebView(c)})}else {c=b.initUrl('V1/',a);b.openWebView(c)}}},onBack:function(){},toItemPage:function(d,c){var b=this;var a=c.record;if(!a){return}if(ConfigMgr.isAio8()){b.aio8Init(a)}else {b.aio75Init(a)}},aio75Init:function(a){var b=a.data.ModuleID;var c=a.data.AppDir;var d=this.initUrl(c,b);this.openWebView(d)},initUrl:function(e,c){var f=this,d=f.getView();var a=User.accURL.split('/');var b='';if(!d.initMidUrl){d.initMidUrl=!0;a[a.length-1]='AIOMobile/AIOHomePage2.aspx?';b=a.join('/');b+='userid='+Utils.toHex(User.ownerID)+'&session='+Utils.toHex(window.workdesksession)+'&path='+Utils.toHex(e+'#'+c)}else {a[a.length-1]=e+'#'+c;b=a.join('/')}return b},aio8Init:function(a){var d=this;var c=a.get('ModuleID');var b=a.get('ModuleUrl');d.aio8InitUrl(c,b)},aio8InitUrl:function(e,a,d){var h=this;var b=Config.aio8ClientUrl;if(!b){if(!Config.aGrp8Url){return}b=Config.aGrp8Url.split('/').slice(0,3).join('/');b=Utils.joinPath(b,'AIO8Client')}var f=!1;if(window.pushCacheMsg){if(window.pushCacheMsg.msg_type===e){d=window.pushCacheMsg.msgValues;f=!0}}else {if(d){f=!0}}if(f){var c,g;if(Ext.isArray(d)&&d.length>0){c=d[1];try{c=JSON.parse(c)}catch(i){}if(Ext.isString(c)){g=c}else {g=Utils.toKeyStr(c)}}if(e==='email'){a=Utils.joinPath(a,'list')}else {if(e==='notice'){a=a.replace('list','view')}else {a=a.replace('home','view')}}a=Utils.joinPath(a,'?'+g)}b=Utils.joinPath(b,'#'+a);h.openWebView(b)},onOpenbbcode:function(c){var b=this;b.lastBBCode=c;var a=Config.aio8ClientUrl;if(!a){if(!Config.aGrp8Url){return}a=Config.aGrp8Url.split('/').slice(0,3).join('/');a=Utils.joinPath(a,'AIO8Client')}b.openWebView(a)},openWebView:function(d,e){var b=this;if(!e){screen.orientation.unlock()}if(typeof cordova!='undefined'){var c='disallowoverscroll=yes,enableViewportScale=no,hideonclose=yes,showscan=yes,keyboardDisplayRequiresUserAction=no,navigationbuttoncolor=#ffffff,closebuttoncolor=#ffffff,toolbarcolor=#5fa2dd,toolbarposition=top,hidenavigationbuttons=yes';if(Ext.os.is.iOS){c+=',usewkwebview=yes,lefttoright=yes,location=no,closebuttoncaption=关闭';if(ConfigMgr.isAio8()){c+=',toolbar=no'}}else {if(Ext.os.is.Android){c+=',hideurlbar=yes';if(ConfigMgr.isAio8()){c+=',location=no'}}}var a;if(e){a=window.cordova.InAppBrowser.open(d,'_system',c)}else {a=cordova.InAppBrowser.open(d,'_blank',c)}if(a.executeScript){a.addEventListener('message',function(t){var f=t.data;var g=f.args;var c;if(f.method=='getApiAgentForInAppBrowser'){c=g[0];if(c){var u=Utils.getAio8Agent();a.executeScript({code:'window.'+c+'('+JSON.stringify(u)+');'});if(b.lastBBCode){var p=JSON.stringify(b.lastBBCode);a.executeScript({code:'if(window.handleOpenBBCode) window.handleOpenBBCode('+p+');'});b.lastBBCode=null;delete b.lastBBCode}}}else {if(f.method=='closeInAppBrowser'){cordova.InAppBrowser.close(a)}else {if(f.method=='getPosition'){c=g[0];MapLocation.getPosition(function(b){a.executeScript({code:'window.'+c+'(true,'+JSON.stringify(b)+');'})},function(b){a.executeScript({code:'window.'+c+'(false,'+JSON.stringify(b)+');'})})}else {if(f.method=='scan'){cordova.plugins.barcodeScanner.scan(function(f){if(f.cancelled){return}if(f.format=='QR_CODE'){var c=f.text;if(Ext.isEmpty(c)){return}var h=!1;if(c.substr(0,4).toLowerCase()=='http'){h=!0;b.openWebView(c,!0)}else {if(c.substr(0,5).toLowerCase()=='host|'){}else {if(c.substr(0,2)=='01'&&(c.substr(3,2)=='10'||c.substr(3,2)=='04'||c.substr(3,2)=='01')){h=!0;var g=b.initUrl('V1/','receipt/ticket/edit/');g=g+'?key='+c;b.openWebView(g)}else {a.executeScript({code:'if(window._scanCallback) _scanCallback(true,'+JSON.stringify(f)+');'})}}}}},function(b){a.executeScript({code:'if(window._scanCallback) _scanCallback(false,'+JSON.stringify(b)+');'})},{showFlipCameraButton:!0})}else {if(f.method=='getScanByQuery'){c=g[0];window.cordova.plugins.barcodeScanner.scan(function(b){a.executeScript({code:'window.'+c+'(true,'+JSON.stringify(b)+');'})},function(b){a.executeScript({code:'window.'+c+'(true,'+JSON.stringify(b)+');'})},{showFlipCameraButton:!0})}else {if(f.method=='getScan'){c=g[0];cordova.plugins.barcodeScanner.scan(function(f){if(f.cancelled){return}if(f.format=='QR_CODE'){var b=f.text;if(b.substr(0,2)=='01'&&(b.substr(3,2)=='10'||b.substr(3,2)=='04'||b.substr(3,2)=='01')){a.executeScript({code:'window.'+c+'(true,'+JSON.stringify(b)+');'})}}},function(b){a.executeScript({code:'window.'+c+'(true,'+JSON.stringify(b)+');'})},{showFlipCameraButton:!0})}else {if(f.method=='openRelease'){var q=g[0],n=g[1];b.openRelease(q,n)}else {if(f.method=='openFile'){var r=g[0],i=g[1];var s=i.id,o=i.name,l=i.url;b.aboutDeskTopFiles(r,s,o,l)}else {if(f.method=='yearDateWXShare'){var j=g[0];var h=g[1];var k={media:{type:window.Wechat.Type.IMAGE,image:h.imgUrl}};if(h.type=='link'){k={title:h.title||'普实年会',thumb:h.thumbUrl,media:{type:window.Wechat.Type.WEBPAGE,webpageUrl:h.webpageUrl}}}window.Wechat.share({message:k,scene:window.Wechat.Scene.TIMELINE},function(){a.executeScript({code:'window.'+j+'(true);'})},function(b){a.executeScript({code:'window.'+j+'(true,'+JSON.stringify(b)+');'})})}else {if(f.method=='motionStart'){c=g[0];var m=g[1];if(c){b.startMotion(c,m)}}else {if(f.method=='motionStop'){b.stopMotion()}}}}}}}}}}}});var f=function(a){if(ConfigMgr.isAio8()){return}var b=JSON.stringify('IM');var c=JSON.stringify(device.uuid);var f=JSON.stringify(User.ownerID);var g=JSON.stringify(User.erpToken);a.executeScript({code:'                        if (!window.initCef) {                            window.initCef = function(a, b, c, d){                                var appID, guid, userID, erptoken;                                try {                                    appID = JSON.parse(a);                                    guid = JSON.parse(b);                                    userID = JSON.parse(c);                                    erptoken = JSON.parse(d);                                } catch(e) {                                    appID = a;                                    guid = b;                                    userID = c;                                    erptoken = d;                                }                                window.cef = {                                    getAppID: function () {return appID;},                                    getDeviceID: function () {return guid;},                                    getUserSign:function () {return userID;},                                    getERPToken:function () {return erptoken;}                                };                            }                        }                        window.initCef('+b+','+c+','+f+','+g+');'})};a.addEventListener('loadstart',function(){f(a)});a.addEventListener('loadstop',function(b){f(a);a.executeScript({code:"                        (function(){                            var topWin = window;                            var isInput = function(node){                                return node && (node.nodeName == 'INPUT' || node.nodeName == 'TEXTAREA');                            };                            var onFocus = function(curWin){                                if (isInput(curWin.document.activeElement)) {                                    topWin.__activeElement = curWin.document.activeElement;                                }                                curWin.document.addEventListener('focus', function(e) {                                    var el = e.target;                                    if (isInput(el)) {                                        topWin.__activeElement = el;                                    }                                }, true);                                curWin.addEventListener('unload', function(e){                                    delete topWin.__activeElement;                                });                            };                            var fireKeyEvent = function(el, evtType, keyCode){                                var doc = el.ownerDocument,                                    win = doc.defaultView || doc.parentWindow,                                    evtObj;                                if(doc.createEvent){                                    if(win.KeyEvent) {                                        evtObj = doc.createEvent('KeyEvents');                                        evtObj.initKeyEvent( evtType, true, true, win, false, false, false, false, keyCode, 0 );                                    }                                    else {                                        evtObj = doc.createEvent('UIEvents');                                        Object.defineProperty(evtObj, 'keyCode', {                                            get: function() { return this.keyCodeVal; }                                        });                                        Object.defineProperty(evtObj, 'which', {                                            get: function() { return this.keyCodeVal; }                                        });                                        evtObj.initUIEvent( evtType, true, true, win, 1 );                                        evtObj.keyCodeVal = keyCode;                                    }                                    el.dispatchEvent(evtObj);                                }                                 else if(doc.createEventObject){                                    evtObj = doc.createEventObject();                                    evtObj.keyCode = keyCode;                                    el.fireEvent('on' + evtType, evtObj);                                }                            };                            var interate = function(curWin){                                try{                                    if(curWin && curWin.document) {                                        var iframes = curWin.document.getElementsByTagName('iframe');                                        for(var i = 0; i < iframes.length; i++){                                            var iframe = iframes[i];                                            iframe.addEventListener('load', function(e){                                                var win = null;                                                if(e.target && (win = e.target.contentWindow)){                                                    interate(win);                                                }                                            });                                        }                                        if(curWin.MutationObserver) {                                            new MutationObserver(function (mutations) {                                                mutations.some(function(m) {                                                    var found = false;                                                    if(m.addedNodes.length){                                                        for(var i = 0; i < m.addedNodes.length; i++){                                                            var n = m.addedNodes.item(i);                                                            if(n.nodeName == 'IFRAME'){                                                                found = true;                                                                n.addEventListener('load', function(e){                                                                    var win = null;                                                                    if(e.target && (win = e.target.contentWindow)){                                                                        interate(win);                                                                    }                                                                });                                                            }                                                        }                                                    }                                                    return found;                                                });                                            }).observe(curWin.document.body, {                                                attributes: false,                                                attributeOldValue: false,                                                characterData: false,                                                characterDataOldValue: false,                                                childList: true,                                                subtree: true                                            });                                        }                                        onFocus(curWin);                                    }                                }                                catch(ex){ }                            };                            interate(topWin);                            topWin._scanCallback = function(successful, obj){                                if(successful && !obj.cancelled) {                                    setTimeout(function(){                                        if(topWin.__activeElement) {                                            topWin.__activeElement.value = obj.text;                                            fireKeyEvent(topWin.__activeElement, 'keydown', 13);                                            topWin.__activeElement.dispatchEvent(new Event('input'));                                            topWin.__activeElement.dispatchEvent(new Event('change'));                                        }                                    }, 400);                                }                            };                            topWin._nfcCallback = function(id){                                if(topWin.__activeElement) {                                    topWin.__activeElement.value = id;                                    fireKeyEvent(topWin.__activeElement, 'keydown', 13);                                    topWin.__activeElement.dispatchEvent(new Event('input'));                                    topWin.__activeElement.dispatchEvent(new Event('change'));                                }                            };                        })();"},function(a){console.log(a)})})}window.InAppBrowserRef=a;a.addEventListener('exit',function(){delete window.InAppBrowserRef;screen.orientation.lock('portrait')});a.addEventListener('ioshide',function(){delete window.InAppBrowserRef;screen.orientation.lock('portrait')})}else {window.open(d)}},updateBadge:function(){var b=this;var a=this.getView();ChatUtil.getWorkDeskBadges(function(){a.setBadge()})},aboutDeskTopFiles:function(c,f,a,b){var g=this;var d=(new Date()).getTime();var e=ParseUtil.getWorkTopFileDir(d)+encodeURIComponent(a);LocalDataMgr.judgeWFileExists(f,function(h){if(!h){window.floatprogress.show(a,decodeURIComponent(e),b);FileMgr.downFile(b,1,e,{downloading:function(d){window.floatprogress.sentProgress(d)},slove:!0}).then(function(i){window.floatprogress.sentProgress(200);var g=[];var e=i.path;FileMgr.exists(1,e).then(function(j){j.getMetadata(function(k){e=e.split(ConfigMgr.getSecDefaultDir())[1];e=decodeURIComponent(e);g.push({fileID:f,fileName:a,fileSize:k.size,filePath:e,extension:FileUtil.getExtension(a).toLowerCase(),createAt:d,remoteUrl:b});LocalDataMgr.saveToLocalWFile(g[0])})})['catch'](function(d){console.log('getFileSize--err',d)})})['catch'](function(d){if(d.body=='downLoadERR'){window.floatprogress.errMsg()}console.log(d)})}else {if(!h.toLowerCase().startsWith('file://')){h=ConfigMgr.getDefaultDir()+h}if(c=='download'){window.floatprogress.show(a,h);g.timer=setTimeout(function(){window.floatprogress.sentProgress(200)},50)}else {if(c=='open'){FileMgr.open(h)}else {if(c=='share'){FileMgr.share(h).then(function(d){if(d.completed){console.log('share file success')}})['catch'](function(d){console.log(d)})}}}}})},openRelease:function(d,c){var e='Loader.aspx?IMObjType='+Utils.toHex(d)+'&ReleaseKey='+Utils.toHex(c);var a=User.accURL.split('/');var b='';a[a.length-1]=''+e;b=a.join('/');this.openWebView(b,!0)},startMotion:function(b,a){var c=this;var d=function(d){c.watchMotion(b,{aX:d.x,aY:d.y,aZ:d.z,timestamp:d.timestamp})};var e=function(){c.watchMotion(b,null)};window.metionOptions={frequency:a&&a.frequency&&typeof a.frequency=='number'?a.frequency:20};window.motionWatchID=navigator.accelerometer.watchAcceleration(d,e,window.metionOptions)},watchMotion:function(b,a){var c=this;if(window.InAppBrowserRef&&a){window.InAppBrowserRef.executeScript({code:'window.'+b+'('+JSON.stringify(a)+');'})}else {c.stopMotion()}},stopMotion:function(){if(window.motionWatchID){navigator.accelerometer.clearWatch(window.motionWatchID)}}});Ext.define('IMMobile.base.OrgDataHepler',{singleton:!0,alternateClassName:'OrgDataHepler',initOrg:function(a){LocalDataMgr.getOrgHash(function(b){User.orgHash=b;if(Config.isPhone&&!User.focusRefresh){User.orgHash='needRefresh';b='needRefresh';User.focusRefresh=!0}Utils.custAjax('get','users/all',{success:function(d,g){if(g=='304'){LocalDataMgr.initGetOrg(function(c){if(!c){return}if(a){a()}})}else {var f=d.organizations,c=d.users,e=d.org_hash;User.orgHash=e;User.pushUserInfo(c);User.allUsers=c;User.organization=f;LocalDataMgr.initUpdateOrg(c,f,e);if(a){a()}}},failure:function(){LocalDataMgr.initGetOrg(function(c){if(!c){return}if(a){a()}})},callback:function(){User.hasInitOrg=!0}},!1,'&org_hash='+b)})},updateCache:function(b){if(User.allUsers.length>0){for(var a=0;a<User.allUsers.length;a++){if(User.allUsers[a].user_id==b.user_id){User.allUsers[a]=b;break}}}}});Ext.define('IMMobile.base.Redirect',{singleton:!0,alternateClassName:'Redirect',redirectTo:function(e,c){var b=Ext.Viewport.lookup('IMMobile');var d=e;if(c&&c.stype){d=d+c.stype}var a=b.down('#'+d);if(a){var j=b.getInnerItems();var i=j.indexOf(a);if(i>0){var l=j.length-i;b.pop(l)}else {if(a.el.dom.className.indexOf('x-floated')>0){a.show();if(c){a.config=c}return}}}a=null;if(e==='chatview'){a=b.down('#newsview')}else {if(e==='newsview'){a=b.down('#chatview')}}if(a){var g=b.getInnerItems();var f=g.indexOf(a);if(f>0){var k=g.length-f;b.pop(k)}}var h={xtype:e,itemId:d};if(c){Ext.apply(h,c)}b.push(h)}});Ext.define('IMMobile.view.chatView.ChatHeader',{extend:'IMMobile.view.base.Container',xtype:'chatheader',controller:'chatinfocontroller',viewModel:{data:{header:'',newHeader:''}},userCls:'chatHeaderView',items:[{xtype:'IMMobile-Navbar',backBtn:!0,title:'会话标题',userCls:'hasRightButton',items:[{text:'确定',handler:'onChangeChatHeader',width:60,docked:'right',bind:{disabled:'{header==newHeader}'}}]},{margin:'10 0 0 0',xtype:'textfield',itemId:'txtHeader',bind:{value:'{newHeader}'},listeners:{painted:function(a,b){setTimeout(function(){a.focus()},300)}}}],initialize:function(){var a=this;a.callParent(arguments);var b=a.getViewModel();b.setData({header:a.config.header,newHeader:a.config.header})}});Ext.define('IMMobile.view.chatView.ChatHistory',{extend:'Ext.dataview.List',controller:'chathistorycontroller',xtype:'chathistory',store:{model:'IMCommon.model.Msg',sorters:[{property:'updatetime',direction:'DESC'}]},userCls:'rctChat search-result',items:[{xtype:'container',cls:'topinset',docked:'top',style:'background-color: rgb(245,245,245);'},{xtype:'searchtitlebar',itemId:'searchBar',docked:'top',backButton:{handler:'onBack'},searchText:{listeners:{buffer:500,change:'onSearchChange',action:'onSearchAction',painted:function(a,b){a.focus()}}}}],itemTpl:['<div class="itemRight">','<div class="wrapAva">','<image class="avatar" src="{[ImgUtil.onePxImg]}" onload="AvatarMgr.loadAvt2(this);" data-user="{senderID}" data-time="{updatetime}" data-type="D" />','</div>','<div class="evt">','<p>{[Utils.datetime2Ago(values.updatetime, true)]}</p></br>','</div>','<div class="displayInfo">','<div class="displayName">{senderName}</div>','<tpl if="values.msg_type == \'T\'">','<div class="displayMsg">{[ParseUtil.parseRctText(values.sendText)]}</div>','<tpl elseif="values.msg_type == \'F\'">','<div  class="displayMsg">[文件]</div>','<tpl elseif="values.msg_type == \'I\'">','<div  class="displayMsg">[图片]</div>','<tpl elseif="values.msg_type == \'L\'">','<div  class="displayMsg">[链接]</div>','</tpl>','</div>','</div>','</div>'].join(''),listeners:{childtap:'onChildTap'},initialize:function(){var a=this;a.callParent(arguments);if(window.cordova){StatusBar.styleDefault()}a.on({destroy:function(){if(window.cordova){StatusBar.styleLightContent()}},scope:a})}});Ext.define('IMMobile.view.chatView.ChatHistoryController',{extend:'Ext.app.ViewController',alias:'controller.chathistorycontroller',onSearchChange:function(f,b,e,g){var d=this,a=d.getView(),c=a.getStore();c.removeAll();if(b){LocalDataMgr.searchHistoryTxt(a.config.chatid,b,function(h){var d=h.rows;var c=ParseUtil.parseLocalMsg(d);a.getStore().add(c)})}},onSearchAction:function(a,c,b){a.blur()},onChildTap:function(a,b,d){var c=b.record;MobileHelper.getChatType(a.config.chatid);Redirect.redirectTo('chatview',{chatid:a.config.chatid,msgseq:c.get('msgSeq')})},onCancelSearch:function(){var b=this,c=b.getView();var a=Ext.Viewport.lookup('IMMobile');var d=a.pop()},onBack:function(){var d=this,e=d.getView();var a=Ext.Viewport.lookup('IMMobile'),c=a.innerItems,b=c.length;a.layout.setAnimation({type:'reveal',direction:'right',duration:250});a.setActiveItemIndex(b-2);a.timer=setTimeout(function(){a.pop();a.layout.setAnimation({type:'cover',direction:'left',duration:250})},300)},onTapImage:function(k,c){var i=this,d=i.getView();var g=c.record;if(!g){return}var j=c.event,a=Ext.fly(j.target),b='img.viewPic.loaded';if(a.is(b)){var h=d.innerElement.dom.querySelectorAll(b),f=[],e=-1;h.forEach(function(b,d){f.push({url:b.src,original:b.getAttribute('src')});if(a.dom===b){e=d}});ImgMgr.showViewerOfDom2(d.down('dataview'),a.dom)}},onTapFile:function(c,b){var a=b.record;if(!a){return}if(a.data.fileStatus==3){return}else {if(a.data.fileStatus==0){var d=a.data.localPath;var e=FileUtil.getExtension(d);if(FileUtil.isImgExtension(e)){ImgMgr.showViewerOfDom2(c,b.sourceElement.closest('.x-listitem'))}else {Config.ChooseFile='Y';Config.OpenFile=!0;window.resolveLocalFileSystemURL(cordova.file.dataDirectory,function(e){var d=e.toURL()+User.getComPrefix()+'/'+a.data.localPath;window.plugins.fileOpener.open(d,function(){},function(a){console.log('Error status: '+a.status+' - Error message: '+a.message);Utils.toastShort('文件打开失败')})},function(a){console.log('Error status: '+a.status+' - Error message: '+a.message);Utils.toastShort('文件打开失败')})}}else {if(a.data.fileStatus==4||a.data.fileStatus==1){DownFileMgr.downFileForA(a.data)}}}},onInitImage:function(){var c=this,a=c.getView();var b=a.config.chatid;LocalDataMgr.getImageHistory(b,function(d){var c=d.rows;var b=ParseUtil.parseLocalMsg(c);a.down('#pagePic').getStore().add(b)})},toggleToFile:function(){var a=this.getView();a.setActiveItem(0)},toggleToImage:function(){var a=this.getView();a.setActiveItem(1)}});Ext.define('IMMobile.view.chatView.ChatHistoryF',{extend:'Ext.tab.Panel',controller:'chathistorycontroller',xtype:'chathistoryf',tabBar:{hidden:!0},items:[{xtype:'IMMobile-Navbar',itemId:'navTop',backBtn:{handler:'onBack'},title:'查看文件与图片',docked:'top'},{xtype:'segmentedbutton',itemId:'tbTop',docked:'top',allowDepress:!0,items:[{pressed:!0,text:'文件',handler:'toggleToFile'},{text:'图片',handler:'toggleToImage'}]},{xtype:'list',title:'文件',itemId:'pageFile',itemTpl:'<div class="img-ct">{[ParseUtil.parseFile(values)]}</div>',itemCls:'view-img-item',userCls:'fileHistory',selectable:!1,grouped:!0,pinHeaders:!1,store:{model:'IMCommon.model.Msg',grouper:{direction:'DESC',sortProperty:'updateTime',groupFn:function(a){return Ext.Date.format(new Date(a.get('updateTime')),'Y年m月')}}},listeners:{childtap:'onTapFile'}},{xtype:'dataview',title:'图片',itemId:'pagePic',itemTpl:'<div class="img-ct">{[ParseUtil.parsePic(values,1)]}</div>',itemCls:'view-img-item',userCls:'imageHistory',padding:1,inline:!0,store:{model:'IMCommon.model.Msg'},listeners:{initialize:'onInitImage',childtap:'onTapImage'}}],initialize:function(){var a=this;a.callParent(arguments);var b=a.config.chatid;LocalDataMgr.getFileHistory(b,function(d){var c=d.rows;var b=ParseUtil.parseLocalMsg(c);a.down('#pageFile').getStore().add(b)})}});Ext.define('IMMobile.view.chatView.ChatHistoryFile',{extend:'Ext.tab.Panel',controller:'chathistorycontroller',xtype:'chathistoryfile',tabBar:{hidden:!0},items:[{xtype:'IMMobile-Navbar',itemId:'navTop',backBtn:{handler:'onBack'},title:'查看文件',docked:'top'},{xtype:'list',title:'文件',itemId:'pageFile',itemTpl:'<div class="img-ct">{[ParseUtil.parseFile(values)]}</div>',itemCls:'view-img-item',userCls:'fileHistory',selectable:!1,grouped:!0,pinHeaders:!1,store:{model:'IMCommon.model.Msg',grouper:{direction:'DESC',sortProperty:'updateTime',groupFn:function(a){return Ext.Date.format(new Date(a.get('updateTime')),'Y年m月')}}},listeners:{childtap:'onTapFile'}}],initialize:function(){var a=this;a.callParent(arguments);var b=a.config.chatid;LocalDataMgr.getFileHistory(b,function(d){var c=d.rows;var b=ParseUtil.parseLocalMsg(c);a.down('#pageFile').getStore().add(b)})}});Ext.define('IMMobile.view.chatView.ChatHistoryImage',{extend:'Ext.tab.Panel',controller:'chathistorycontroller',xtype:'chathistoryimage',tabBar:{hidden:!0},items:[{xtype:'IMMobile-Navbar',itemId:'navTop',backBtn:{handler:'onBack'},title:'查看图片',docked:'top'},{xtype:'dataview',title:'图片',itemId:'pagePic',itemTpl:'<div class="img-ct">{[ParseUtil.parsePic(values,1)]}</div>',itemCls:'view-img-item',userCls:'imageHistory',padding:1,inline:!0,store:{model:'IMCommon.model.Msg'},listeners:{childtap:'onTapImage'}}],initialize:function(){var a=this;a.callParent(arguments);var b=a.config.chatid;LocalDataMgr.getImageHistory(b,function(d){var c=d.rows;var b=ParseUtil.parseLocalMsg(c);a.down('#pagePic').getStore().add(b)})}});Ext.define('IMMobile.view.chatView.ChatInfoController',{extend:'Ext.app.ViewController',alias:'controller.chatinfocontroller',toChatHeader:function(){var b=this,a=b.getView();if(a.isManager){Utils.toastShort('只有管理员可以修改')}else {Ext.Viewport.down('IMMobile').layout.setAnimation({type:null});Redirect.redirectTo('chatheader',{header:a.config.header,chatid:a.config.chatid});if(Ext.os.is.iOS){$('input').focus()}}},onSetChatTop:function(i,e){var g=this,c=g.getView(),h=c.getViewModel();var d=Ext.StoreMgr.get('comRct'),b=d.getById(c.config.chatid);var a=b.data.toTop;var f=a?!0:!1;if(f==e){return}if(a){b.set('toTop',!1)}else {b.set('toTop',!0)}h.setData({toTop:!a});LocalDataMgr.setRctTop(c.config.chatid,a?'N':'Y')},onSetMute:function(i,e){var g=this,b=g.getView(),h=b.getViewModel();var d=Ext.StoreMgr.get('comRct'),c=d.getById(b.config.chatid);var a=c.data.IsMute;var f=a=='Y'?!0:!1;if(f==e){return}if(a=='Y'){a='N'}else {a='Y'}Utils.custAjax('PUT','chats/'+b.config.chatid+'/mute',{success:function(){h.setData({ismute:a=='Y'});if(c){c.set('IsMute',a)}LocalDataMgr.updateMute(b.config.chatid,a)},failure:function(a){Utils.toastLong(a)}},!1,'&is_mute='+a)},onChangeChatHeader:function(){var e=this,c=e.getView(),f=c.getViewModel();var d=f.getData(),b=c.config.chatid,a=d.newHeader;Utils.custAjax('put','chats/'+b,{params:Ext.encode({chat_id:b,header:a,user_id:User.ownerID}),success:function(h){var d=GroupNotice.chgName(User.crtUser.user_name,a);var g=h.messages[0];LocalDataMgr.updateChatName(d,g,User.crtUser.user_name);var e=Ext.StoreMgr.get('comRct');if(e){var f=e.getById(b);if(f){f.set({name:a,last_post_msg:d,last_msg_type:MsgType.GroupNotice,last_post_at:new Date(g.create_at),last_post_name:User.crtUser.user_name})}}var i=Ext.Viewport.lookup('IMMobile');var c=i.pop();if(c&&c.xtype=='chatinfoview'){c.setHeader(a)}},failure:function(a){Utils.toastLong(a)}})},toChatMembers:function(){var b=this,a=b.getView();Redirect.redirectTo('chatmember',{header:a.config.header,chatid:a.config.chatid})},toMembersDetail:function(e){var c=this,b=c.getView(),d=b.getViewModel(),a=d.getData().members;if(a[0]==User.ownerID){Redirect.redirectTo('IMMobile-memDetail',{userid:a[1],username:User.userInfos[a[1]].user_name})}else {Redirect.redirectTo('IMMobile-memDetail',{userid:a[0],username:User.userInfos[a[0]].user_name})}},toSearch:function(){var b=this,a=b.getView();var d=a.down('#navTop'),c=a.down('#searchBar');d.hide();c.show().focusTxt();a.isSearch=!0},showMemberHanders:function(){},changeToSelectable:function(){var e=this,a=this.getView();a.addCls('userSelect');a.canSelect=!0;a.down('#navTop').setTitle('移出成员');a.down('#navTop').down('#menuAddRemove').hide();a.down('#btnRemove').show();if(!a.hasAddHideCls){var c=a.innerItems;for(var b=0;b<c.length;b++){var d=c[b];if(d._record.id==User.ownerID){d.addCls('selfListItem');a.hasAddHideCls=!0;break}}}},onBack:function(){var d=this,a=d.getView();var b=Ext.Viewport.lookup('IMMobile'),g=b.innerItems,e=g.length,c;b.layout.setAnimation({type:'reveal',direction:'right',duration:250});if(a.xtype=='chatmember'){if(a.isSearch){d.onCancelSearch();return}if(a.canSelect){a.removeCls('userSelect');a.canSelect=!1;a.deselectAll();a.down('#navTop').setTitle('会话成员');a.down('#navTop').down('#menuAddRemove').show();a.down('#btnRemove').hide();return}var f=[];a.getStore().each(function(a){f.push(a.data)});b.setActiveItemIndex(e-2);b.timer=setTimeout(function(){c=b.pop();if(d.hasChanged){if(c&&c.xtype=='chatinfoview'){c.setMembers(f)}}b.layout.setAnimation({type:'cover',direction:'left',duration:250})},300)}else {if(a.xtype=='chatinfoview'){MobileHelper.getChatType(User.crtChannelId);Redirect.redirectTo('chatview',{chatid:User.crtChannelId,header:a.config.header});b.timer=setTimeout(function(){b.layout.setAnimation({type:'cover',direction:'left',duration:250})},300)}else {b.setActiveItemIndex(e-2);b.timer=setTimeout(function(){c=b.pop();b.layout.setAnimation({type:'cover',direction:'left',duration:250})},300)}}},onRemoveMember:function(){var d=this,c=d.getView();var a=c.getSelections();var e=c.getStore();for(var b=0;b<a.length;b++){var f=a[b];Utils.custAjax('DELETE','chats/'+c.config.chatid+'/members/'+f.get('user_id'),{params:'',success:function(){e.remove(f)},failure:function(a){Utils.toastLong(a)}})}e.remove(a);d.onBack();d.hasChanged=!0},onCancelSearch:function(){var b=this,a=b.getView();var d=a.down('#navTop'),c=a.down('#searchBar');c.hide().clearSearch();d.show();a.isSearch=!1},onSearchChange:function(f,a,e,g){var d=this,c=d.getView();var b=c.getStore();b.filter('user_name',a)},onSearchAction:function(a,c,b){a.blur()},toAddChatMember:function(){var e=this,b=e.getView(),f=b.getViewModel();var a=f.getData();var c=a.members;var d=a.chat_type=='D'?'A':'B';Redirect.redirectTo('userselectview',{stype:d,members:c,chatid:b.config.chatid})},toSearchHistory:function(){var b=this,a=b.getView();Redirect.redirectTo('chathistory',{chatid:a.config.chatid})},toSearchHistoryFile:function(){var b=this,a=b.getView();Redirect.redirectTo('chathistoryfile',{chatid:a.config.chatid})},toSearchHistoryImage:function(){var b=this,a=b.getView();Redirect.redirectTo('chathistoryimage',{chatid:a.config.chatid})},toSearchFiles:function(){}});Ext.define('IMMobile.view.chatView.ChatInfoView',{extend:'IMMobile.view.base.Container',xtype:'chatinfoview',controller:'chatinfocontroller',viewModel:{},userCls:'chatInfoView',items:[{xtype:'IMMobile-Navbar',backBtn:{handler:'onBack'},title:'会话信息'},{margin:'15 0 0 0',xtype:'arrButton',itemId:'chatTitle',bind:{text:'<div class="float-left">会话标题</div>  <div class="float-right btnValue">{header}<span class="fa fa-angle-right"></span></div>'},handler:'toChatHeader'},{xtype:'button',margin:'0 0 15 0',text:'添加成员',textAlign:'left',width:'100%',ui:'flat',iconCls:'im-common-add1',handler:'toAddChatMember'},{xtype:'container',layout:'hbox',userCls:'btn-toggle thin-border mobile-toggle',items:[{xtype:'label',html:'消息置顶',flex:1,userCls:'toggle-label'},{xtype:'togglefield',itemId:'btnTop',bind:{value:'{toTop ? true : false}'},listeners:{change:'onSetChatTop'}}]},{xtype:'container',layout:'hbox',userCls:'btn-toggle mobile-toggle',items:[{xtype:'label',html:'免打扰',flex:1,userCls:'toggle-label'},{xtype:'togglefield',itemId:'btnMute',bind:{value:'{ismute ? true : false}'},listeners:{change:'onSetMute'}}]},{xtype:'arrButton',text:'查找聊天记录',style:'margin-top:15px;',iconCls:'fa-angle-right',cls:'thin-border',handler:'toSearchHistory'},{xtype:'arrButton',iconCls:'fa-angle-right',text:'查看图片',cls:'thin-border',handler:'toSearchHistoryImage'},{xtype:'arrButton',iconCls:'fa-angle-right',text:'查看文件',cls:'thin-border',handler:'toSearchHistoryFile'}],initialize:function(){var a=this;a.callParent(arguments);var n=a.getViewModel();var m=Ext.StoreMgr.get('comRct'),b=m.getById(a.config.chatid),h=b.get('type'),e=b.get('members'),j=b.get('manager_id');var l='';var i='';var g=[];var f='';var k='';if(h=='D'){a.down('#chatTitle').hide();a.insert(2,{xtype:'button',itemId:'memAvas',ui:'flat',margin:'15 0 0 0',iconCls:'fa-angle-right',cls:'bigButton thin-border',width:'100%',bind:{text:'<div class="avaContainer direct">{memberStr}\n                                <div class="float-left btnLabel" style="flex: 1; display: inline-grid;margin-right: 10px; padding-right: 10px;">\n                                    <div class="name">{DchatName}</div>\n                                    <div class="notes">{notes}</div>\n                                </div>\n                            </div>'},handler:'toMembersDetail'})}else {a.insert(2,{xtype:'button',itemId:'memAvas',ui:'flat',margin:'15 0 0 0',cls:'bigButton thin-border',width:'100%',bind:{text:'<div><div class="float-left">会话成员</div><div class="float-right">{count}人<span class="fa fa-angle-right"></span></div></div><div class="avaContainer">{memberStr}<div class="divToken">{tokenStr}</div></div>'},handler:'toChatMembers'})}for(var d=0;d<e.length;d++){if(d<=10){var c={};Ext.apply(c,e[d]);if(h=='D'&&c.user_id==User.ownerID){}else {l+='<image class="avatarPic" src="'+ImgUtil.onePxImg+'" onload="AvatarMgr.loadAvt2(this,0);" data-user="'+c.user_id+'" data-type="D">';f=User.userInfos[c.user_id].user_name;k=User.userInfos[c.user_id].notes}i+='&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'}g.push(e[d].user_id)}a.isManager=j&&j!=User.ownerID;n.setData({header:a.config.header,chatid:a.config.chatid,toTop:b.get('toTop'),memberStr:l,count:e.length,tokenStr:i,members:g,chat_type:b.data.type,ismute:b.data.IsMute=='Y',DchatName:f,notes:k})},setHeader:function(b){var a=this;a.config.header=b;var c=a.getViewModel();c.setData({'header':b});a.hasChangeHeader=!0},setMembers:function(a){var e=Ext.getStore('comRct').getById(this.config.chatid);if(e){e.set({members:a},{silent:!0})}var f='';var d='';var c=[];for(var b=0;b<a.length;b++){if(b<=10){var g={};Ext.apply(g,a[b]);f+='<image class="avatarPic" src="'+ImgUtil.onePxImg+'" onload="AvatarMgr.loadAvt2(this,0);" data-user="'+g.user_id+'" data-type="D">';d+='&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'}c.push(a[b].user_id)}var h=this.getViewModel();h.setData({memberStr:f,count:a.length,tokenStr:d,members:c})}});Ext.define('IMMobile.view.chatView.ChatMembers',{extend:'Ext.dataview.List',xtype:'chatmember',controller:'chatinfocontroller',cls:'mobileNestList',canSelect:!1,selectable:'multi',store:{idProperty:'user_id',fields:['id','user_id','user_name']},items:[{xtype:'IMMobile-Navbar',itemId:'navTop',backBtn:{handler:'onBack'},title:'会话成员',docked:'top',items:[{xtype:'button',iconCls:'x-fa fa-search',align:'right',handler:'toSearch'},{xtype:'button',itemId:'menuAddRemove',iconCls:'x-fa fa-ellipsis-v',align:'right',arrow:!1,menu:{width:110,indented:!1,items:[{text:'移出成员',iconCls:'x-fa fa-minus-circle red',handler:'changeToSelectable'}]}}]},{xtype:'searchtitlebar',itemId:'searchBar',hidden:!0,docked:'top',backButton:{handler:'onCancelSearch'},searchText:{listeners:{buffer:500,change:'onSearchChange',action:'onSearchAction'}}},{xtype:'button',itemId:'btnRemove',text:'移出',docked:'bottom',handler:'onRemoveMember',hidden:!0,disabled:!0}],itemTpl:['<div class="icon-select x-fa"></div>','<div class="nested-org">','<image class="nested-user-avatar" src="{[ImgUtil.onePxImg]}" onload="AvatarMgr.loadAvt2(this,0);"  data-user="{user_id}" data-type="D" width="30" height="30">','<div class="name">{user_name}</div>','</div>'].join(''),initialize:function(){var c=this;c.callParent(arguments);var f=Ext.StoreMgr.get('comRct'),g=f.getById(c.config.chatid),b=g.get('members');var d=[];for(var a=0;a<b.length;a++){var e={};Ext.apply(e,b[a],{id:b[a].user_id});d.push(e)}c.getStore().setData(d)},listeners:{select:{fn:function(b,d,e){if(this.canSelect){var a=b.getSelections();var c=b.down('#btnRemove');if(a.length==0){c.setText('移出').setDisabled(!0)}else {c.setText('移出 ('+a.length+')').setDisabled(!1)}}}},deselect:{fn:function(b,d,e){var a=b.getSelections();var c=b.down('#btnRemove');if(a.length==0){c.setText('移出').setDisabled(!0)}else {c.setText('移出 ('+a.length+')').setDisabled(!1)}}},childtap:{fn:function(d,b){var a=b.record;if(!this.canSelect){var c=a.data.user_id;if(c!==User.ownerID){Redirect.redirectTo('IMMobile-memDetail',{userid:a.data.user_id,username:a.data.user_name})}return !1}}}}});Ext.define('IMMobile.view.chatView.ChatReadDetailsController',{extend:'Ext.app.ViewController',alias:'controller.chatreaddetailscontroller',onChgRead:function(e,b){var d=this,c=d.getView(),a=c.lookup('tab_panel');a.setActiveItem(b)},onBack:function(){var e=this,f=e.getView();var a=Ext.Viewport.lookup('IMMobile'),c=a.innerItems,b=c.length,d;a.layout.setAnimation({type:'reveal',direction:'right',duration:250});a.setActiveItemIndex(b-2);a.timer=setTimeout(function(){d=a.pop();a.layout.setAnimation({type:'cover',direction:'left',duration:250})},300)}});Ext.define('IMMobile.view.chatView.ChatUnReadMem',{extend:'Ext.List',xtype:'chatunreadmem',requires:['MX.plugin.ListOptions'],canSelect:!1,cls:'mobileNestList',store:{storeId:'chatUnRead',sorters:[{property:'unuser_id',direction:'ASC'}],fields:['unuser_id','unreadName']},itemTpl:['<div class="icon-select x-fa"></div>','<div class="nested-org">','<image class="nested-user-avatar" src="{[ImgUtil.onePxImg]}" onload="AvatarMgr.loadAvt2(this,0);"  data-user="{unuser_id}" data-type="D" width="30" height="30">','<div>{unreadName}</div>','</div>'],listeners:{childtap:{fn:function(d,c){var a=c.record;if(!this.canSelect){var b=a.data.unuser_id;if(b!==User.ownerID){if(User.getUserName(b)!=''){Redirect.redirectTo('IMMobile-memDetail',{userid:a.data.unuser_id,username:a.data.unreadName})}else {Utils.toastShort('用户不存在')}}return !1}}}},initialize:function(){var a=this;a.callParent(arguments)}});Ext.define('IMMobile.view.chatView.ChatReadDetails',{extend:'IMMobile.view.base.Container',xtype:'chatreaddetails',requires:['IMMobile.view.chatView.ChatReadDetailsController','IMMobile.view.chatView.ChatUnReadMem','MX.plugin.ListOptions'],controller:'chatreaddetailscontroller',cls:'chatread',referenceHolder:!0,viewModel:{data:{unreadNum:0,readNum:0},formulas:{unreadCountHtml:function(b){var a=b('unreadNum');if(a==0||a<0){return ''}if(a>0){return ' '+'('+a+')'}},readCountHtml:function(b){var a=b('readNum');if(a==0||a<0){return ''}if(a>0){return ' '+'('+a+')'}}}},layout:'vbox',scrollable:!0,items:[{xtype:'IMMobile-Navbar',itemId:'navTop',backBtn:{handler:'onBack'},title:'消息接收人列表',docked:'top'},{xtype:'container',layout:'hbox',items:[{xtype:'segmentedbutton',reference:'segmentbutton',cls:'segment-style-two',listeners:{change:'onChgRead'},style:'width: 100%;',items:[{bind:{text:'未读<span style="color:#ff5722">{unreadCountHtml}<span>'},style:'width: 50%;',value:0,pressed:!0},{bind:{text:'已读<span style="color:#ff5722">{readCountHtml}<span>'},style:'width: 50%;',value:1}]}]},{xtype:'tabpanel',reference:'tab_panel',flex:1,tabBar:{hidden:!0},defaults:{scrollable:!0},items:[{title:'未读',xtype:'chatunreadmem',reference:'unread'},{title:'已读',xtype:'chatreadmem',reference:'read'}]}],initialize:function(){var c=this;c.callParent(arguments);var i=c.config.msg_id;var j=c.config.chat_id;var h=c.config.readcount;var f=c.config.unreadcount;var d=c.config.record;var b=[];var a=[];var k=location.child;var g=Ext.getStore('chatRead');var e=Ext.getStore('chatUnRead');Utils.custAjax('post','chats/'+j+'/posts/receiptMems',{params:JSON.stringify([i]),success:function(c){var l=!1;if(c.read_list){for(var j=0;j<c.read_list.length;j++){if(c.read_list[j]!=User.ownerID&&User.getUserName(c.read_list[j])!=''){b.push({user_name:User.getUserName(c.read_list[j]),user_id:c.read_list[j]})}}}if(c.unread_list){for(var k=0;k<c.unread_list.length;k++){if(c.unread_list[k]!=User.ownerID&&User.getUserName(c.unread_list[k])!=''){a.push({unreadName:User.getUserName(c.unread_list[k]),unuser_id:c.unread_list[k]})}}}g.removeAll();e.removeAll();g.add(b);e.add(a);var n=Ext.Viewport.down('chatreaddetails'),m=n.getViewModel();if(c.read_list){m.setData({readNum:b.length});if(h!=b.length){d.set('read_count',b.length);l=!0}}else {m.setData({readNum:0});if(h!=0){d.set('read_count',0);l=!0}}if(c.unread_list){m.setData({unreadNum:a.length});if(f!=a.length){d.set('unread_count',a.length);l=!0}}else {m.setData({unreadNum:0});if(f!=0){d.set('unread_count',0);l=!0}}if(l){LocalDataMgr.updateDeatailsReadCount(b.length,a.length,i)}},failure:function(){}})}});Ext.define('IMMobile.view.chatView.ChatReadMem',{extend:'Ext.List',xtype:'chatreadmem',requires:['MX.plugin.ListOptions'],canSelect:!1,cls:'mobileNestList',store:{storeId:'chatRead',sorters:[{property:'user_id',direction:'ASC'}],fields:['user_id','user_name']},itemTpl:['<div class="icon-select x-fa"></div>','<div class="nested-org">','<image class="nested-user-avatar" src="{[ImgUtil.onePxImg]}" onload="AvatarMgr.loadAvt2(this,0);"  data-user="{user_id}" data-type="D" width="30" height="30">','<div>{user_name}</div>','</div>'],listeners:{childtap:{fn:function(d,c){var a=c.record;if(!this.canSelect){var b=a.data.user_id;if(b!==User.ownerID){if(User.getUserName(b)!=''){Redirect.redirectTo('IMMobile-memDetail',{userid:a.data.user_id,username:a.data.user_name})}else {Utils.toastShort('用户不存在')}}return !1}}}},initialize:function(){var a=this;a.callParent(arguments)}});Ext.define('IMMobile.view.chatView.ChatSearch',{extend:'Ext.dataview.List',controller:'chatsearchcontroller',xtype:'chatsearch',cls:'rctChat docked-bottom',config:{enterType:'A'},updateEnterType:function(a){if(a=='A'){}else {if(a=='B'){var b=this.down('searchtitlebar');b.addCls(['topinset']);b.setHeight('auto');if(window.cordova){StatusBar.styleDefault()}}}this.getController().enterType=a},items:[{xtype:'searchtitlebar',itemId:'searchBar',docked:'top',backButton:{handler:'onCancelSearch'},searchText:{listeners:{buffer:500,change:'onSearchChange',action:'onSearchAction',painted:function(a,b){a.focus()}}}}],itemTpl:['<div class="itemRight">','<tpl if="values.hasNoData">','<div class="editP_fsp_nodata">无相关搜索内容</div>','<tpl else>','<tpl if="values.hasUser||values.hasChat">','<tpl if="values.hasUser">','<div class="editP_fsp_user_title">','<tpl if="values.hasMoreUser">','<div class="editP_fsp_more" style="float:right">显示更多</div>','</tpl>','<div>用户</div>','</div>','</tpl>','<tpl if="values.hasChat">','<div class="editP_fsp_title">','<tpl if="values.hasMoreChat">','<div class="editP_fsp_more" style="float:right">显示更多</div>','</tpl>','<div>会话</div>','</div>','</tpl>','<tpl elseif="values.hasBack">','<div class="editP_fsp_more" style="float:right">收起</div>',"<div>{[values.hasUserBack?'用户':'会话']}</div>",'<tpl else>','<tpl if="values.UserName">','<div class="wrapAva">','<tpl if="window.cordova">','<tpl if="Ext.os.is.ios">','<a class="avatar link-avatar">','<img src="{[AvatarMgr.getIOSChatAvaUrl(values.UserID,0,\'D\')]}" onerror="AvatarMgr.doUserAvaErr(this)" ava-id="{UserID}" create-at="0" hash="{AvatarHash}">','</a>','<tpl else>','{[AvatarMgr.getUserAvaHtml(values.UserID, values.AvatarHash)]}','</tpl>','<tpl else>','<image class="avatar" style="float: left;" src="{[ImgUtil.onePxImg]}" onload="AvatarMgr.loadAvt2(this,0);" data-user="{UserID}" data-time="{0}" data-type="D" />','</tpl>','</div>','<div class="displayInfo">','<div class="displayName">{UserName}({UserID})</div>','<div class="displayMsg" style="min-height:0.2rem">','<tpl if="values.Mobile">手机：{Mobile}</tpl>','</div>','</div>','<tpl else>','<div class="wrapAva">','<tpl if="window.cordova">','<tpl if="Ext.os.is.ios">','<a class="avatar link-avatar firstletter loaded">','<tpl if="values.ChatType == \'G\'">','<img src="{[AvatarMgr.getIOSChatAvaUrl(values.ChatID,values.CreateAt,\'G\')]}" onerror="AvatarMgr.doChatAvaErr(this)" ava-id="{ChatID}" create-at="{CreateAt}" hash="{AvatarHash}">','<tpl elseif="values.ChatType == \'C\'">','<img src="{[AvatarMgr.getIOSChatAvaUrl(values.ChatID,values.CreateAt,\'C\')]}" onerror="AvatarMgr.doCrowdAvaErr(this)" ava-id="{ChatID}" create-at="{CreateAt}" hash="{AvatarHash}">','</tpl>','</a>','<tpl else>','<tpl if="values.ChatType == \'G\'">','{[AvatarMgr.getChatAvaHtml(values.ChatID, values.CreateAt, values.AvatarHash)]}','<tpl elseif="values.ChatType == \'C\'">','{[AvatarMgr.getCrowdAvaHtml(values.ChatID, values.CreateAt, values.AvatarHash)]}','</tpl>','</tpl>','<tpl else>','<image class="avatar" src="{[ImgUtil.onePxImg]}" onload="AvatarMgr.loadAvt2(this,0);" data-user="{ChatID}" data-time="{CreateAt}" data-type="\'G\'" hash="{AvatarHash}"/>','</tpl>','</div>','<div>','<div class="displayInfo">','<div class="displayName">{DisplayName}</div>','<div class="displayMsg" style="min-height:0.2rem">','<tpl if="values.SenderName">','包含：{SenderName}','</tpl>','</div>','</div>','</div>','</tpl>','</tpl>','</tpl>','</div>'].join(''),listeners:{childtap:'onChildTap'}});Ext.define('IMMobile.view.chatView.ChatSearchContain',{extend:'Ext.Sheet',xtype:'chatsearchcontain',controller:'chatsearchcontroller',hideOnMaskTap:!0,exit:null,stretchX:!0,stretchY:!0,scrollable:!0,hidden:!1,layout:'vbox',cls:'docked-bottom',items:[{xtype:'container',itemId:'holder',cls:'topinset',docked:'top',style:'background-color: #f5f5f5;'},{xtype:'chatsearch'}],initialize:function(){var a=this;var b=a.down('#holder').el.dom.clientHeight;a.callParent(arguments);if(window.cordova){StatusBar.styleDefault()}a.totalHeight=45+b;a.setHeight(a.totalHeight);a.on({beforehide:'onBeforeHide',hide:'onHide',scope:a})},onBeforeHide:function(){Ext.Viewport.lookup('IMMobile').down('#chatsearch').show()},onHide:function(){if(window.cordova){StatusBar.styleLightContent()}this.destroy()}});Ext.define('IMMobile.view.chatView.ChatSearchController',{extend:'Ext.app.ViewController',alias:'controller.chatsearchcontroller',onSearchChange:function(f,c,e,g){var b=this,d=b.getView(),a=d.up('chatsearchcontain');if(c){LocalSearchMgr.localRctSearch(c,function(k,j){var i=[];if(k.length>0){var m={hasUser:!0};if(k.length>ConfigMgr.recentSearchNum){m.hasMoreUser=!0}i.push(m);var q=[{hasBack:!0,hasUserBack:!0}];for(var h=0;h<k.length;h++){if(h<ConfigMgr.recentSearchNum){i.push(k[h])}q.push(k[h])}var o=Ext.getStore('editP_fsp_user');if(!o){o=Ext.create('Ext.data.Store',{id:'editP_fsp_user'})}o.removeAll();o.add(q)}if(j.length>0){var m={hasChat:!0};if(j.length>ConfigMgr.recentSearchNum){m.hasMoreChat=!0}i.push(m);var p=[{hasBack:!0}];for(var h=0;h<j.length;h++){if(j[h].ChatID==StaticChatID.News){continue}if(h<ConfigMgr.recentSearchNum){i.push(j[h])}p.push(j[h])}var n=Ext.getStore('editP_fsp_chat');if(!n){n=Ext.create('Ext.data.Store',{id:'editP_fsp_chat'})}n.removeAll();n.add(p)}if(b.enterType=='A'){a.setHeight(null)}if(i.length==0){i.push({hasNoData:!0})}var l=Ext.getStore('mixed');if(!l){l=Ext.create('Ext.data.Store',{id:'mixed'})}l.removeAll();l.add(i);d.setStore(l)})}else {if(b.enterType=='A'){a.setHeight(a.totalHeight)}}},onSearchAction:function(a,c,b){a.blur()},onChildTap:function(b,h,k){var a=h.record;var c=this,j=c.getView();if(a.data.rtype==2){}else {if(a.data.hasUser){var g=Ext.getStore('editP_fsp_user');b.setStore(g)}else {if(a.data.hasChat){var f=Ext.getStore('editP_fsp_chat');b.setStore(f)}else {if(a.data.hasBack){var i=Ext.getStore('mixed');b.setStore(i)}else {if(a.data.hasNoData){return}else {if(c.enterType=='A'){j.up('sheet').hide();User.lastChatId=User.crtChannelId;User.crtChannelId=a.data.ChatID;User.crtChatName=a.data.DisplayName;if(a.data.UserName){User.crtChatName=a.data.UserName;User.chatMemID=a.data.UserID}MobileHelper.getChatType(a.data.ChatID);Redirect.redirectTo('chatview',{chatid:a.data.ChatID})}else {if(c.enterType=='B'){var d=Ext.Viewport.down('IMMobile'),e=d.down('userselectview');e.receiveData(a);d.pop()}}}}}}}},onCancelSearch:function(){var a=this,b=a.getView();if(a.enterType=='A'){b.up('chatsearchcontain').hide()}else {if(a.enterType=='B'){var c=Ext.Viewport.down('IMMobile');c.pop();if(window.cordova){StatusBar.styleLightContent()}}}},onBack:function(){var b=this,c=b.getView();var a=Ext.Viewport.lookup('IMMobile');var d=a.pop()}});Ext.define('IMMobile.view.chatView.editor.IMMobileEditor',{extend:'Ext.Container',xtype:'IMMobile-Editor',requires:['IMCommon.view.RichEditor'],uses:['IMMobile.view.chatView.editor.menu.More','IMMobile.view.chatView.editor.emoji.Carousel'],defaultListenerScope:!0,layout:{type:'card'},cls:'chat-editor bottominset',items:[{xtype:'toolbar',docked:'top',layout:{type:'hbox',align:'end'},items:[{iconCls:'im-common-add1',userCls:'round-border ignore-keyboard',handler:'onTapShowMore'},{xtype:'imCommonEditor',itemId:'MobileEditor',userCls:'main-editor',height:36,errorTarget:null,flex:1},{iconCls:'im-mobile-smile',userCls:'round-border ignore-keyboard',handler:'onTapShowEmj',focusable:!1},{xtype:'button',itemId:'sendBtn',userCls:'send-button ignore-keyboard',text:'发送',ui:'action',listeners:{tap:'onSendMsg'}}]},{xtype:'editor_more_menu',data:[{value:'camera',text:'拍照',iconCls:'x-fa fa-camera'},{value:'images',text:'图片',iconCls:'x-fa fa-image'},{value:'files',text:'文件',iconCls:'x-fa fa-file'}],listeners:{tapmenu:'onTapMenuItem'}},{xtype:'emj_carousel'}],initialize:function(){var a=this;a.callParent(arguments);var h=a.down('emj_carousel');h.element.on({delegate:'td',tap:'onChooseEmj',scope:a});if(Ext.browser.is.Cordova){var g=Ext.bind(a.onKeyBoardShow,a),c='keyboardDidShow';window.addEventListener(c,g,!1);var e=Ext.bind(a.keyBoardHide,a),b='keyboardDidHide';window.addEventListener(b,e,!1);a.on({destroy:function(){window.removeEventListener(c,g,!1);window.removeEventListener(b,e,!1)},scope:a})}var i=parseInt(Math.min(window.innerHeight,window.innerWidth)*9/16,10);a.bodyElement.setHeight(i);a.bodyElement.hide();var d=a.down('#MobileEditor');d.inputElement.dom.addEventListener('input',function(b){if(b.data=='@'){d.simulateBackspace();a.onExecAT()}},!1);if(Ext.os.is.ios){var j=a.down('#MobileEditor').el.dom,f=j.querySelector('.x-input-el');if(f){f.style.paddingBottom='6px'}}},keyBoardHide:function(){this.down('#MobileEditor').blur()},onKeyBoardShow:function(a){this.bodyElement.hide()},onKeyBoardWillShow:function(a){if(this.showEmoji){return !1}},onTapShowEmj:function(b){var a=this;if(a.bodyElement.getStyle('display')=='none'||a.innerItems.indexOf(a.getActiveItem())!=1){if(window.Keyboard&&Keyboard.hide){Keyboard.hide()}setTimeout(function(){a.bodyElement.show()},30);a.setActiveItem(1)}else {a.bodyElement.hide()}},onChooseEmj:function(b){var c=Ext.fly(b.target),a=this.down('#MobileEditor');a.setReadOnly(!0);if(c.hasCls('emj')){var d=b.target.textContent;a.appendText(d);if(Ext.os.is.Android44){a.appendText('\u200b')}}else {if(c.hasCls('backspace')){a.simulateBackspace()}}setTimeout(function(){a.setReadOnly(!1)},50);b.stopEvent();b.preventDefault()},onTapShowMore:function(b){var a=this;if(a.bodyElement.getStyle('display')=='none'||a.innerItems.indexOf(a.getActiveItem())!=0){if(window.Keyboard&&Keyboard.hide){Keyboard.hide()}setTimeout(function(){a.bodyElement.show()},30);a.setActiveItem(0)}else {a.bodyElement.hide()}},onTapMenuItem:function(g,d){if(Ext.browser.is.Cordova){var b=this;var c=b.up('chatview').down('#msgView');var f=b.down('#MobileEditor');var e=c.getStore();var a=f.getMultiValue();if(d=='camera'){Config.ChooseFile='Y';ImgMgr.takePhoto().then(function(f){Config.ChooseFile='N';f.images.forEach(function(b){var c={type:MsgType.ImgMsg,width:b.width,height:b.height,path:b.path};a.msgs.push(c)});SendUtil.sendMsg2(a,User.crtChannelId,function(a){return b.bindLocal(c,e,a)})})['catch'](function(a){Config.ChooseFile='N';Utils.toastShort(a)})}else {if(d=='images'){Config.ChooseFile='Y';ImgMgr.chooseImages().then(function(f){Config.ChooseFile='N';f.images.forEach(function(b){var c={type:MsgType.ImgMsg,width:b.width,height:b.height,path:b.path};a.msgs.push(c)});SendUtil.sendMsg2(a,User.crtChannelId,function(a){return b.bindLocal(c,e,a)})})['catch'](function(a){Config.ChooseFile='N';Utils.toastShort(a)})}else {if(d=='files'){Redirect.redirectTo('IMMobile-Catecoties',{fromChat:!0})}}}f.clear()}},onSendMsg:function(){var a=this;var c=a.down('#MobileEditor');var b=a.up('chatview').down('#msgView');var e=b.getStore();var d=c.getMultiValue();SendUtil.sendMsg2(d,User.crtChannelId,function(c){return a.bindLocal(b,e,c)});c.clear()},bindLocal:function(f,a,b){if(b.length>0){var g=ParseUtil.getLocalTime(!0),d=!1;d=ParseUtil.dataShowTime(a,new Date(g));b[0].showTime=d;a.add(b);var c=f.getScrollable();if(c){var e=c.getScrollElement().dom.scrollHeight;c.scrollTo(0,e)}}return a},onExecAT:function(){Redirect.redirectTo('userselectview',{stype:'D',chatid:User.crtChannelId});return !1},afterSelectATUser:function(a){var d='';var c=this.down('#MobileEditor');if(a.length>0){for(var b=0;b<a.length;b++){var e='<span class="r-at">@'+a[b][1]+'</span>';c.insertObject(e,'user_id='+Utils.toHex(a[b][0]))}}else {d='@';c.appendText(d)}}});Ext.define('IMMobile.view.chatView.ChatView',{extend:'Ext.Panel',xtype:'chatview',controller:'chatviewcontroller',requires:['IMMobile.view.base.Container','IMMobile.view.widget.Navbar','Ext.dataview.DataView','IMMobile.view.chatView.editor.IMMobileEditor','IMCommon.model.Msg','IMCommon.utils.AddDataUtil','IMCommon.utils.AvatarUtil','IMMobile.view.chatView.ChatReadDetails'],uses:['MX.util.ImgUtil'],cls:'IMMobile-ChatViewWrp',layout:'vbox',viewModel:{data:{newmsg:0,chatviewIcon:'im-mobile im-mobile-users',stateStr:'离线'}},items:[{xtype:'IMMobile-Navbar',itemId:'chatViewNav',userCls:'hasRightButton',bind:{title:'<div>{title}</div><div class="NavBar-user-state regular">{stateStr != "离线" ? stateStr : null }</div>'},items:[{xtype:'button',bind:{iconCls:'{chatviewIcon}'},handler:'toChatInfo',width:30,docked:'right'}]},{xtype:'component',itemId:'newToken',docked:'top',bind:{html:'<div class="newmsg-token">{newmsg} 条新消息</div>',hidden:'{newmsg==0}'}},{xtype:'msgview',itemId:'msgView',flex:1},{xtype:'pullloaddata'},{xtype:'IMMobile-Editor',itemId:'IMMobile-Editor',docked:'bottom'}],listeners:{destroy:{fn:function(){User.crtChannelId='';User.NewMsgCount=0}}},initialize:function(){var a=this;var c=Ext.getStore('comRct'),b=c.getById(a.config.chatid);a.callParent(arguments);a.down('#newToken').element.on({tap:'popToList',scope:a});a.down('IMMobile-Navbar').getBackBtn().setText('消息');if(b&&b.get('type')=='D'||a.config.chatType=='D'){var e=User.chatMemID||b.get('avaID'),d=MobileHelper.stateConverStr(e);a.getViewModel().setData({chatviewIcon:'im-common-user',stateStr:d})}Utils.custAjax('get','users/me/chats/'+User.crtChannelId,{success:function(a){if(a.iscrowd=='Y'){Utils.custAjax('get','chatcs/'+User.crtChannelId,{success:function(c){ChatUtil.getcrowdChatName(c);if(c){User.needUpdateCrowdAva(User.crtChannelId,c.create_at,c.avatar_hash,function(g,d){if(d){var i='UPDATE IMChatC SET Avahash=? WHERE ChatID=?;';LocalDataMgr.cExecSqlWithP(i,[c.avatar_hash,c.chat_id]);var e=Ext.Viewport.down('rctchatlist').mapToItem(b),h=e.el.query('img'),f=h[0];AvatarMgr.setUrl(f,g)}})}}})}},failure:function(){}});a.down('pullloaddata').setList(a.down('msgview'));a.openChat();a.down('IMMobile-Navbar').lookup('backbtn').on({tap:'onTapBack',scope:a});a.on({painted:'onPainted',scope:a})},onPainted:function(){this.setEditorLastView(User.crtChannelId)},openChat:function(){var a=this;a.setHeader(User.crtChatName)},setHeader:function(a){var b=this;User.crtChatName=a;b.config.chatname=a;b.getViewModel().set({title:a})},popToList:function(){Ext.Viewport.lookup('IMMobile').pop()},setNewMsgCount:function(a){this.getViewModel().setData({newmsg:a})},onTapBack:function(){var a=this;a.noteChatDraft()},noteChatDraft:function(){var b=this;var f=User.crtChannelId;var h=b.down('msgview');var e=b.down('IMMobile-Editor').down('imCommonEditor');var g=h.store.last(),a=e.getMultiValue(),c=a.pureText,d=e.getValue()||'';if(a.msgs&&a.msgs.length==0){c='';d=''}User.chatCache[f]={lastEditorMsg:d,lastPureText:c,trueLastRec:g};b.updateLastChatInRct(f)},updateLastChatInRct:function(c){var a=User.chatCache[c];var e=Ext.getStore('comRct');var b=e?e.getById(c):null;if(a&&b){if(a.lastEditorMsg&&a.lastEditorMsg.length>0){var f=a.lastPureText;b.set({last_msg_type:'Draft',last_post_msg:f})}else {if(a.trueLastRec){var d=a.trueLastRec;b.set({last_msg_type:d.data.msg_type||'G',last_post_msg:d.data.sendText})}}}},setEditorLastView:function(g){var h=this;var a=User.chatCache[g];var c=h.down('IMMobile-Editor').down('imCommonEditor');if(a){var e=a.lastPureText;if(e){h.timer=setTimeout(function(){c.focus();c.pasteHtml(e)},300)}var f=Ext.getStore('comRct');var b=f?f.getById(g):null;if(b){var i=b.get('last_msg_type');if(i=='Draft'&&a.trueLastRec){var d=a.trueLastRec;b.set({last_msg_type:d.data.msg_type||'G',last_post_msg:d.data.sendText})}}}}});Ext.define('IMMobile.view.chatView.ChatViewController',{extend:'Ext.app.ViewController',alias:'controller.chatviewcontroller',toChatInfo:function(){var e=this,a=e.getView(),b=a.getViewModel();var d=Ext.StoreMgr.get('comRct');var c=d.getById(User.crtChannelId).get('type');if(c=='C'){Redirect.redirectTo('crowdinfoview',{header:a.config.chatname||b.getData().title,chatid:User.crtChannelId})}else {if(c='G'){Utils.custAjax('get','users/me/chats/'+User.crtChannelId,{success:function(c){if(c.iscrowd!='Y'){Redirect.redirectTo('chatinfoview',{header:a.config.chatname||b.getData().title,chatid:User.crtChannelId})}else {var d=ParseUtil.getLocalTime(!0);var f=Ext.getStore('comRct'),e=f.getById(User.crtChannelId);LocalDataMgr.updateCrowdtoGroup(c,d);e.set({name:c.header,type:c.chat_type});Utils.custAjax('get','chatcs/'+User.crtChannelId,{success:function(d){LocalDataMgr.saveCrowdInfo(d,function(){Redirect.redirectTo('crowdinfoview',{header:a.config.chatname||b.getData().title,chatid:User.crtChannelId})})},failure:function(){}})}},failure:function(){}})}else {Redirect.redirectTo('chatinfoview',{header:a.config.chatname||b.getData().title,chatid:User.crtChannelId})}}},onDataCopy:function(b,f){var c=b.getParent(),a=c.record;var e=this,g=e.getView();var d=a.get('sendText');if(plugins.wizUtils){plugins.wizUtils.setText(d,function(){Utils.toastShort('AIO:已复制到剪贴板')},function(){Utils.toastShort('AIO:复制失败')})}},onDataTrans:function(b,d){var c=b.getParent(),a=c.record;Redirect.redirectTo('userselectview',{stype:'C',chatid:User.crtChannelId,msgid:a.get('msg_id')})},onDataRevoke:function(b,d){var c=b.getParent(),a=c.record;ChatUtil.doRevoke(User.crtChannelId,[a.get('msg_id')],function(){var e='撤销了一条消息'+','+a.data.senderID;var c=GroupNotice.getRevokeNotice(User.ownerID,e);a.set('msg_type',MsgType.Revoke);a.set('senderID',User.ownerID);a.set('senderName',User.userInfos[User.ownerID].user_name);a.set('sendText',c)})},onDataThirdOpen:function(b){var a=b.targetRecord.data.localPath;Config.ChooseFile='Y';Config.OpenFile=!0;if(!a.toLowerCase().startsWith('file://')){a=ConfigMgr.getDefaultDir()+a}else {if(a.indexOf('Inbox/')>-1){a=window.cordova.file.documentsDirectory+'Inbox/'+a.split('Inbox')[1]}}FileMgr.open(a)}});Ext.define('IMMobile.view.chatView.CrowdAdminView',{extend:'IMMobile.view.base.Container',xtype:'crowdadminview',requires:['MX.plugin.ListOptions'],controller:'crowdinfoviewcontroller',cls:'mobileNestList',canSelect:!1,selectable:'multi',items:[{xtype:'IMMobile-Navbar',itemId:'navTop',backBtn:{handler:'onBack'},title:'群管理员',docked:'top'},{xtype:'list',store:{storeId:'comAdmin',idProperty:'user_id',fields:['user_id','user_name']},itemTpl:['<div class="icon-select x-fa"></div>','<div class="nested-org">','<image class="nested-user-avatar" src="{[ImgUtil.onePxImg]}" onload="AvatarMgr.loadAvt2(this,0);"  data-user="{user_id}" data-type="D" width="30" height="30">','<div>{user_name}</div>','<div class="crowdreduce" style="position: fixed;right: 0.1rem;"><input type="button"  ava-id="{user_id}"style="height: 0.3rem;width: 0.6rem;background-color: #f2f3f5;border: 1px solid #e9e9e9;border-radius:14%;" value="移除" onClick="reduceAdmin(this)" /></div>','</div>'].join('')},{xtype:'button',margin:'0 0 15 0',text:'添加群管理员',textAlign:'left',width:'100%',ui:'flat',iconCls:'im-common-add',handler:'toAddAdmin',style:'color: #0d1114;background-color: #fff;'}],initialize:function(){var b=this;b.callParent(arguments);var a=[];Utils.custAjax('get','chatcs/'+b.config.chatid,{success:function(b){User.crowd_manager=b.manager_id;User.crtId=b.id;for(var c=0;c<b.members.length;c++){if(b.members[c].is_admin=='Y'){a.push({user_id:b.members[c].user_id,user_name:b.members[c].user_name})}}Ext.getStore('comAdmin').setData(a)},failure:function(){}});window.reduceAdmin=function(c){var a=c.getAttribute('ava-id');var b=[];b.push(a);Utils.custAjax('PUT','chatcs/'+User.crtID+'/admin',{params:JSON.stringify({chat_id:User.crtChannelId,users:b}),success:function(e){var d=Ext.getStore('comAdmin').data;for(var b=0;b<d.length;b++){if(d.items[b].data.user_id==a){Ext.getStore('comAdmin').remove(d.items[b])}}},failure:function(){}})}}});Ext.define('IMMobile.view.chatView.CrowdInfoView',{extend:'IMMobile.view.base.Container',xtype:'crowdinfoview',controller:'crowdinfoviewcontroller',viewModel:{},userCls:'chatInfoView',items:[{xtype:'IMMobile-Navbar',backBtn:{handler:'onBack'},title:'群信息'},{xtype:'button',cls:'immb_meinfoava selfAva',ui:'flat',width:'100%',bind:{text:'<div>\n                    <div class="float-left" style="line-height:0;">\n                        <image class="avatarPic" style="width:55px; height:55px" src="{crowdAvt}">\n                    </div>\n                    <div class="float-left btnLabel">\n                        <div>{crowdname}</div>\n                        <div style="text-overflow: ellipsis;white-space: nowrap;overflow: hidden; text-align: right;color: #888;font-size: 15px;">{crowdremark}</div>\n                    </div>\n                    <span class="fa fa-angle-right"></span>\n                    </div>'},handler:'onOpenAvatar'},{xtype:'button',width:'100%',ui:'flat',cls:'immb_meinfoava thin-border',itemId:'btnemail',field:'crowdremark',handler:'onCrowdInfoEdit',bind:{text:'<div><div class="float-left btnLabel">群描述</div><div class="float-right btnValue">{crowdremark}</div><span class="fa fa-angle-right"></span></div>'}},{xtype:'button',width:'100%',ui:'flat',cls:'immb_meinfo thin-border',itemId:'btnnotes',field:'crowdnotice',handler:'onCrowdInfoEdit',bind:{text:'<div class="allLabel">\n                        <div class="btnLabel">群公告</div>\n                        <div class="crowd_middle">\n                            <pre>{crowdnotice}</pre>\n                        </div>\n                        <div style="align-items: center; display: flex">\n                            <span class="fa fa-angle-right"></span>\n                        </div>\n                    </div>'}},{xtype:'arrButton',text:'群管理',itemId:'mangeringCrowd',style:'margin-top:15px;',iconCls:'fa-angle-right',cls:'thin-border',handler:'toManageCrowd',hidden:!0},{xtype:'container',layout:'hbox',style:'margin-top:15px;',userCls:'btn-toggle thin-border mobile-toggle',items:[{xtype:'label',html:'消息置顶',flex:1,userCls:'toggle-label'},{xtype:'togglefield',itemId:'btnTop',bind:{value:'{toTop ? true : false}'},listeners:{change:'onSetChatTop'}}]},{xtype:'container',layout:'hbox',userCls:'btn-toggle mobile-toggle',items:[{xtype:'label',html:'免打扰',flex:1,userCls:'toggle-label'},{xtype:'togglefield',itemId:'btnMute',bind:{value:'{ismute ? true : false}'},listeners:{change:'onSetMute'}}]},{xtype:'arrButton',text:'查找聊天记录',style:'margin-top:15px;',iconCls:'fa-angle-right',cls:'thin-border',handler:'toSearchHistory'},{xtype:'arrButton',iconCls:'fa-angle-right',text:'查看图片',cls:'thin-border',handler:'toSearchHistoryImage'},{xtype:'arrButton',iconCls:'fa-angle-right',text:'查看文件',cls:'thin-border',handler:'toSearchHistoryFile'}],initialize:function(){var a=this;a.callParent(arguments);var l=a.getViewModel();var k=Ext.StoreMgr.get('comRct'),b=k.getById(a.config.chatid),j=b.get('type'),h=b.get('manager_id');var e=b.get('create_at');var i='';var g='';var f='';var d=[];var c='';Utils.custAjax('get','chatcs/'+a.config.chatid,{success:function(k){User.crtID=k.id;var n=k.members;if(User.ownerID==k.manager_id){a.down('#mangeringCrowd').show()}a.insert(5,{xtype:'button',ui:'flat',margin:'15 0 0 0',cls:'bigButton thin-border',width:'100%',bind:{text:'<div><div class="float-left">群成员</div><div class="float-right">{count}人<span class="fa fa-angle-right"></span></div></div><div class="avaContainer">{memberStr}<div class="divToken">{tokenStr}</div></div>'},handler:'toChatMembers'});for(var m=0;m<n.length;m++){if(m<=10){var o={};Ext.apply(o,n[m]);if(j=='D'&&o.user_id==User.ownerID){}else {i+='<image class="avatarPic" src="'+ImgUtil.onePxImg+'" onload="AvatarMgr.loadAvt2(this,0);" data-user="'+o.user_id+'" data-type="D">';c=n[m].user_name}g+='&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'}d.push(n[m].user_id)}var p=(new Date()).getTime();User.create_At=e;f=Config.httpUrlForGo+'chatcs/'+a.config.chatid+'/avatar?token='+User.token+'&create_at='+e+'&'+p;a.isManager=h&&h!=User.ownerID;l.setData({header:a.config.header,chatid:a.config.chatid,toTop:b.get('toTop'),memberStr:i,count:n.length,crowdAvt:f,tokenStr:g,members:d,chat_type:b.data.type,ismute:b.data.IsMute=='Y',DchatName:c,crowdname:k.header,crowdremark:k.remark,crowdnotice:k.notice.trimEnd()})},failure:function(){}})}});Ext.define('IMMobile.view.chatView.CrowdInfoViewController',{extend:'Ext.app.ViewController',alias:'controller.crowdinfoviewcontroller',toManageCrowd:function(){var b=this,a=b.getView();Redirect.redirectTo('crowdmanagerview',{header:a.config.header,chatid:a.config.chatid})},tocrowdadmin:function(){var b=this,a=b.getView();Redirect.redirectTo('crowdadminview',{header:a.config.header,chatid:a.config.chatid})},toAddAdmin:function(){var b=this,a=b.getView();Redirect.redirectTo('crowdselectview',{header:a.config.header,chatid:a.config.chatid})},toChatMembers:function(){var b=this,a=b.getView();Redirect.redirectTo('crowdmembers',{header:a.config.header,chatid:a.config.chatid})},onOpenAvatar:function(){var b=this,a=b.getView();Redirect.redirectTo('crowdavatar',{create:User.create_At,chatid:a.config.chatid})},onCrowdInfoEdit:function(b){var c=this,a=c.getView(),d=a.getViewModel();Ext.Viewport.down('IMMobile').layout.setAnimation({type:null});Redirect.redirectTo('crowdinfoedit',{field:b.field,oldValue:d.getData()[b.field],chatid:a.config.chatid,header:a.config.header});if(Ext.os.is.iOS){$('input').focus()}},onBack:function(){var d=this,a=d.getView();var b=Ext.Viewport.lookup('IMMobile'),g=b.innerItems,e=g.length,c;b.layout.setAnimation({type:'reveal',direction:'right',duration:250});if(a.xtype=='chatmember'){if(a.isSearch){d.onCancelSearch();return}if(a.canSelect){a.removeCls('userSelect');a.canSelect=!1;a.deselectAll();a.down('#navTop').setTitle('会话成员');a.down('#navTop').down('#menuAddRemove').show();a.down('#btnRemove').hide();return}var f=[];a.getStore().each(function(a){f.push(a.data)});b.setActiveItemIndex(e-2);b.timer=setTimeout(function(){c=b.pop();if(d.hasChanged){if(c&&c.xtype=='chatinfoview'){c.setMembers(f)}}b.layout.setAnimation({type:'cover',direction:'left',duration:250})},300)}else {if(a.xtype=='crowdinfoview'){MobileHelper.getChatType(User.crtChannelId);Redirect.redirectTo('chatview',{chatid:User.crtChannelId,header:a.config.header});b.timer=setTimeout(function(){b.layout.setAnimation({type:'cover',direction:'left',duration:250})},300)}else {b.setActiveItemIndex(e-2);b.timer=setTimeout(function(){c=b.pop();b.layout.setAnimation({type:'cover',direction:'left',duration:250})},300)}}},onSelect:function(i,e,h){var g=this,b=g.getView();var a=e.record;var d=b.down('#ctSelected');if(a.data.checked==!1){a.set('checked',!0);var c;var f='<div class="nested-org"><img class="nested-user-avatar" src="'+ImgUtil.onePxImg+'" onload="AvatarMgr.loadAvt2(this,0);" data-type="D"  data-user="'+a.data.user_id+'"  width="30" height="30"></div>';c=Ext.create('Ext.Component',{html:f,itemId:a.data.user_id});d.add(c);b.down('#btnEnter').setDisabled(!1)}else {if(a.data.checked==!0){a.set('checked',!1);var c=d.down('#'+a.data.user_id);d.remove(c);if(b.down('#ctSelected').innerItems.length==0){b.down('#btnEnter').setDisabled(!0)}}}},onAddAdmins:function(){var d=this,a=d.getView();var c=[];for(var b=0;b<a.down('#ctSelected').innerItems.length;b++){c.push(a.down('#ctSelected').innerItems[b].getItemId())}Utils.custAjax('PUT','chatcs/'+User.crtId+'/admin',{params:JSON.stringify({chat_id:User.crtChannelId,admins:c}),success:function(b){Redirect.redirectTo('crowdadminview',{header:a.config.header,chatid:a.config.chatid})},failure:function(){}})},onChangeCrowdInfo:function(){var e=this,a=e.getView(),f=a.getViewModel();var d=f.getData(),c=d.newValue;var b=a.config.field;Utils.custAjax('get','chatcs/'+a.config.chatid,{success:function(d){User.crowd_manager=d.manager_id;User.crtId=d.id;var f=!1;for(var e=0;e<d.members.length;e++){if(d.members[e].is_admin=='Y'&&d.members[e].user_id==User.ownerID){f=!0}}if(User.ownerID==d.manager_id){f=!0}if(f){if(b=='crowdremark'){Utils.custAjax('put','chatcs/'+User.crtID,{params:JSON.stringify({chat_id:a.config.chatid,id:User.crtID,remark:c}),success:function(e){var b='UPDATE IMChatC SET ReMark=? WHERE ChatID=?';LocalDataMgr.cExecSqlWithP(b,[c,a.config.chatid]);Redirect.redirectTo('crowdinfoview',{header:a.config.header,chatid:a.config.chatid})},failure:function(){Utils.toastShort('请求更新失败');b.setValue(User.CrowdNotice)}})}else {if(b=='crowdnotice'){Utils.custAjax('put','chatcs/'+User.crtID+'/notice',{params:JSON.stringify({chat_id:a.config.chatid,id:User.crtID,notice:c}),success:function(e){var b='UPDATE IMChatC SET Notice=? WHERE ChatID=?';LocalDataMgr.cExecSqlWithP(b,[c,a.config.chatid]);Redirect.redirectTo('crowdinfoview',{header:a.config.header,chatid:a.config.chatid})},failure:function(){Utils.toastShort('请求更新失败');b.setValue(User.CrowdNotice)}})}}}else {Utils.toastShort('只有管理员可以修改')}},failure:function(){}})},onSetChatTop:function(i,e){var g=this,c=g.getView(),h=c.getViewModel();var d=Ext.StoreMgr.get('comRct'),b=d.getById(c.config.chatid);var a=b.data.toTop;var f=a?!0:!1;if(f==e){return}if(a){b.set('toTop',!1)}else {b.set('toTop',!0)}h.setData({toTop:!a});LocalDataMgr.setRctTop(c.config.chatid,a?'N':'Y')},onSetMute:function(i,e){var g=this,b=g.getView(),h=b.getViewModel();var d=Ext.StoreMgr.get('comRct'),c=d.getById(b.config.chatid);var a=c.data.IsMute;var f=a=='Y'?!0:!1;if(f==e){return}if(a=='Y'){a='N'}else {a='Y'}Utils.custAjax('PUT','chats/'+b.config.chatid+'/mute',{success:function(){h.setData({ismute:a=='Y'});if(c){c.set('IsMute',a)}LocalDataMgr.updateMute(b.config.chatid,a)},failure:function(a){Utils.toastLong(a)}},!1,'&is_mute='+a)},toSearchHistory:function(){var b=this,a=b.getView();Redirect.redirectTo('chathistory',{chatid:a.config.chatid})},toSearchHistoryFile:function(){var b=this,a=b.getView();Redirect.redirectTo('chathistoryfile',{chatid:a.config.chatid})},toSearchHistoryImage:function(){var b=this,a=b.getView();Redirect.redirectTo('chathistoryimage',{chatid:a.config.chatid})},onSelectPhoto:function(){var a=this;a.getPicture(navigator.camera.PictureSourceType.CAMERA)},onSelectNewPic:function(){var a=this;a.getPicture(navigator.camera.PictureSourceType.PHOTOLIBRARY)},onSaveImg:function(){var c=this,a=c.getView(),b=a.down('#avatar');plugins.wizUtils.saveToAlbum(function(){Utils.toastShort('成功保存到相册')},function(a){Utils.toastShort('保存失败: '+a)},b.path)},getPicture:function(a){var c=this;Config.ChooseFile='Y';var b=a==navigator.camera.PictureSourceType.CAMERA;navigator.camera.getPicture(function(b){Config.ChooseFile='N';c.onUpload(b)},function(b){Config.ChooseFile='N';Utils.toastShort(b)},{quality:b?50:100,destinationType:navigator.camera.DestinationType.FILE_URI,sourceType:a,allowEdit:!0,targetWidth:250,targetHeight:250,correctOrientation:!0,saveToPhotoAlbum:!0})},onUpload:function(e){var h=this;var c=e;var b=new FileUploadOptions();b.fileKey='files';b.fileName=FileUtil.getFileName(c);b.mimeType='image/png';b.httpMethod='PUT';b.params={};var g=new FileTransfer();var a=h.getView();Utils.mask(a,'正在上传图片');var f=(new Date()).getTime();var d=Config.httpUrlForGo+'chatcs/'+a.config.chatid+'/avatar?token='+User.token+'&create_at='+a.config.create+'&'+f;g.upload(c,encodeURI(d),function(c){Utils.unMask(a);var b=JSON.parse(c.response);if(b.status=='OK'){User.crtUser.avatar_hash=b.hash;User.needUpdateCrowdAva(a.config.chatid,a.config.create,b.hash,function(b){if(a&&a.xtype=='crowdavatar'){var h='<image class="avatarPic" src="'+b+'"></div>';var f=a.down('#avatar');f.setHtml(h);f.path=b}var g=Ext.Viewport.lookup('IMMobile');var d=g.down('crowdinfoview');if(d){d.getViewModel().setData({crowdAvt:b})}})}else {Utils.unMask(a);Utils.toastShort('上传头像失败')}},function(b){Utils.unMask(a)},b)}});Ext.define('IMMobile.view.chatView.CrowdManagerView',{extend:'IMMobile.view.base.Container',xtype:'crowdmanagerview',controller:'crowdinfoviewcontroller',viewModel:{},userCls:'chatInfoView',items:[{xtype:'IMMobile-Navbar',backBtn:{handler:'onBack'},title:'群管理'},{xtype:'arrButton',text:'群管理员',style:'margin-top:15px;',iconCls:'fa-angle-right',cls:'thin-border',handler:'tocrowdadmin'}],initialize:function(){var a=this;a.callParent(arguments)}});Ext.define('IMMobile.view.chatView.CrowdMembers',{extend:'IMMobile.view.base.Container',xtype:'crowdmembers',requires:['MX.plugin.ListOptions'],controller:'crowdinfoviewcontroller',cls:'mobileNestList',canSelect:!1,selectable:'multi',layout:'vbox',scrollable:!0,items:[{xtype:'IMMobile-Navbar',itemId:'navTop',backBtn:{handler:'onBack'},title:'群成员',docked:'top'},{xtype:'list',flxe:1,store:{storeId:'crowdAllMems',idProperty:'user_id',sorters:[{property:'isManger',direction:'ASC'},{property:'isAdmin',direction:'ASC'},{property:'user_id',direction:'ASC'}],fields:['user_id','user_name','isManger','isAdmin']},itemTpl:['<div class="icon-select x-fa"></div>','<div class="nested-org">','<image class="nested-user-avatar" src="{[ImgUtil.onePxImg]}" onload="AvatarMgr.loadAvt2(this,0);"  data-user="{user_id}" data-type="D" width="30" height="30">','<div class="name">{user_name}</div>','<div class="remarks">','<tpl if="values.isManger==\'A\'">','<span class="master" >群主</span>','<tpl elseif="values.isAdmin==\'Y\'">','<span class="admin" >管理员</span>','</tpl>','</div>','</div>'].join(''),listeners:{childtap:{fn:function(d,b){var a=b.record;if(!this.canSelect){var c=a.data.user_id;if(c!==User.ownerID){Redirect.redirectTo('IMMobile-memDetail',{userid:a.data.user_id,username:a.data.user_name})}return !1}}}}}],initialize:function(){var a=this;a.callParent(arguments);var b=[];Utils.custAjax('get','chatcs/'+a.config.chatid,{success:function(a){User.crowd_manager=a.manager_id;User.crtId=a.id;for(var b=0;b<a.members.length;b++){if(a.members[b].is_admin=='Y'){Ext.getStore('crowdAllMems').add({user_id:a.members[b].user_id,user_name:a.members[b].user_name,isAdmin:'Y',isManger:'Z'})}else {if(a.members[b].user_id==a.manager_id){Ext.getStore('crowdAllMems').add({user_id:a.members[b].user_id,user_name:a.members[b].user_name,isManger:'A',isAdmin:'Z'})}else {Ext.getStore('crowdAllMems').add({user_id:a.members[b].user_id,user_name:a.members[b].user_name,isAdmin:'Z',isManger:'Z'})}}}},failure:function(){}})}});Ext.define('IMMobile.view.chatView.MsgView',{extend:'Ext.List',xtype:'msgview',requires:['Ext.dataview.pullrefresh.PullRefresh'],itemsFocusable:!1,selectable:!1,scrollable:'y',disableSelection:!0,classCls:'msg-list',hoveredCls:'hovered',viewModel:{data:{unread:0,atCount:0},formulas:{unreadHtml:function(b){var a=b('unread');if(a>=0&&a<=99){return ''+a}if(a>99){return '99+'}}}},store:{model:'IMCommon.model.Msg',notice:[],remoteSeq:0,isFirst:1,sorters:'msgSeq'},itemTpl:'<tpl if="values.showTime==0">'+'<tpl elseif="values.msg_type == \'B\'">'+'<tpl else>'+'<div class="mobile-msgnotice"><div>{[Utils.datetime2Ago(values.updateTime, true)]}</div></div>'+'</tpl>'+'<tpl if="values.showGrpChange">'+'<div class="mobile-msgnotice"><div>{[ParseUtil.milGrpChgMsg(values.GrpChangeMsg)]}</div></div>'+'<tpl elseif="values.notShowGrpChange">'+'<tpl elseif="values.msg_type == \'B\'">'+'<div class="mobile-msgnotice"><div>{sendText}&nbsp;</div>'+'</div>'+'<tpl elseif="values.msg_type == \'N\'">'+'<div class="grpChangeNote">'+'<span>'+'{[ParseUtil.getSureName(values.senderID)]}修改了群公告&nbsp;'+'</span>'+'</div>'+'<tpl else>'+'<tpl if="values.ROL!==\'right\'">'+'<div class="evAvatar">'+'<tpl if="window.cordova">'+'<tpl if="Ext.os.is.ios">'+'<a class="avatar">'+'<img src="{[AvatarMgr.getIOSChatAvaUrl(values.senderID,values.updateTime,\'D\')]}" onerror="AvatarMgr.doUserAvaErr(this)" ava-id="{senderID}" create-at="{updateTime}" hash="{avaHash}">'+'</a>'+'<tpl else>'+'{[AvatarMgr.getUserAvaHtml(values.senderID, values.avaHash)]}'+'</tpl>'+'<tpl else>'+'<image class="avatar" style="float: left;" src="{[ImgUtil.onePxImg]}" onload="AvatarMgr.loadAvt2(this,0);" data-user="{senderID}" data-time="{updateTime}" data-type="D" />'+'</tpl>'+'<div class="sendDesc">{senderName}</div>'+'</div>'+'</tpl>'+'<div style="text-align:{ROL};float:{[values.ROL?values.ROL:\'left\']};max-width:80%;" class="msgtype-{msg_type}">'+'<tpl if="values.ROL==\'right\'">'+"<div class=\"bubble {[values.msg_type == 'I' ? 'imgmsg' : '']} mine\">"+'<tpl else>'+"<div class=\"bubble {[values.msg_type == 'I' ? 'imgmsg' : '']} others\">"+'</tpl>'+'<tpl if="values.msg_type==\'F\'">'+'{[ParseUtil.parseFile(values)]}'+'<tpl elseif="values.msg_type == \'I\'">'+'{[ParseUtil.parsePic(values,1)]}'+'<tpl elseif="values.msg_type == \'E\'">'+'<div class="plain">'+'[对方发送了一份大文件,请登录PC端查看]'+'</div>'+'<tpl elseif="values.msg_type == \'T\'">'+'<div class="plain">'+'<tpl if="values.sendStatus==1">'+"<div class=\"sendfail {[values.ROL == 'right' ? 'mineStu' : 'otherStu']}\"></div>"+'</tpl>'+'{[ParseUtil.parseTextToHtml(values.sendText)]}'+'</div>'+'<tpl elseif="values.msg_type == \'L\'">'+'<div class="linkMsg">'+'<a href="aio5app://{[User.ownerID]}/{linkObjType}/{linkKey}">'+'<div class="linkIcon" letter="{linkLinkType}"></div>'+'<div class="linkName">{linkName}</div>'+'<div class="linkTime" style="display: none;">{linkOwner}</div>'+'</a></div>'+'<tpl else>'+'<div class="plain">'+'[暂未支持的消息,请登录PC端查看]'+'</div>'+'</tpl>'+'</div>'+'</div>'+'</tpl>'+"<tpl if=\"values.ROL=='right' && User.useReceipt == 'Y' && VerControll.verReceipt\">"+"<tpl if=\"values.msg_type == 'T' ||values.msg_type == 'I' ||values.msg_type == 'F'||values.msg_type == 'E'||values.msg_type == 'L'\">"+'<tpl if="(values.updateTime-new Date().getTime()) < 2592000000">'+'<tpl if="values.read_count == 0 && values.unread_count != 0">'+'<tpl if="User.crtChannelType==\'D\'">'+'<div class="readNumCon" style="color:#5fa2dd;float:right;margin-right:12px;width: 100%;text-align: right;margin-bottom: 0px;font-size: 13px;padding-top: 4px;">未读</div>'+'<tpl else>'+'<div class="readNumCon" style="color:#5fa2dd;float:right;margin-right:12px;width: 100%;text-align: right;margin-bottom: 0px;font-size: 13px;padding-top: 4px;"><a class="readNum" style="text-decoration: unset">{unread_count}人未读</a></div>'+'</tpl>'+'<tpl elseif="values.unread_count != 0 && values.read_count != 0">'+'<tpl if="User.crtChannelType==\'D\'">'+'<div class="readNumCon" style="color:#5fa2dd;float:right;margin-right:12px;width: 100%;text-align: right;margin-bottom: 0px;font-size: 13px;padding-top: 4px;">未读</div>'+'<tpl else>'+'<div class="readNumCon" style="color:#5fa2dd;float:right;margin-right:12px;width: 100%;text-align: right;margin-bottom: 0px;font-size: 13px;padding-top: 4px;"><a class="readNum" style="text-decoration: unset">{unread_count}人未读</a></div>'+'</tpl>'+'<tpl elseif="values.unread_count == 0 && values.read_count == 0">'+'<div  style="color:#888;float:right;margin-right:12px;width: 100%;text-align: right;margin-bottom: 0px;font-size: 13px;padding-top: 4px;"><span class="readNum"></span></div>'+'<tpl elseif="values.unread_count == 0">'+'<tpl if="User.crtChannelType==\'D\'">'+'<div  style="color:#888;float:right;margin-right:12px;width: 100%;text-align: right;margin-bottom: 0px;font-size: 13px;padding-top: 4px;"><span class="readNum">已读</span></div>'+'<tpl else>'+'<div  style="color:#888;float:right;margin-right:12px;width: 100%;text-align: right;margin-bottom: 0px;font-size: 13px;padding-top: 4px;"><span class="readNum">全部已读</span></div>'+'</tpl>'+'</tpl>'+'</tpl>'+'</tpl>'+'</tpl>',items:[{xtype:'component',itemId:'unreadToken',docked:'bottom',bind:{html:'<div class="unread-token">{unreadHtml}</div>',hidden:'{unread==0}'}},{xtype:'component',itemId:'atToken',docked:'top',bind:{html:'<div class="at-token"><div class="at-token-clear">X</div><div class="at-token-msg">查看@消息</div></div>',hidden:'{atCount==0}'}},{xtype:'menu',itemId:'menuHandler',width:'80%',indented:!1,cls:'msgMenu',centered:'true',modal:!0,items:[{text:'复制',itemId:'menuCopy',handler:'onDataCopy'},{itemId:'menuCopySplit',xtype:'menuseparator'},{text:'转发',handler:'onDataTrans',itemId:'menuDataTrans'},{xtype:'menuseparator',itemId:'menuTransSplit'},{text:'其他应用打开',hidden:!0,handler:'onDataThirdOpen',itemId:'menuThirdOpen'},{text:'撤回',itemId:'menuRevoke',handler:'onDataRevoke'}]}],initialize:function(){var a=this;a.callParent(arguments);a.on({childtap:'onTapChild',childlongpress:'onLongPress',resize:'onresize',beforehide:'on',scope:a});a.getScrollable().on({scroll:'onChgScrol',scope:a});a.down('#unreadToken').element.on({tap:'scrollToBottom',scope:a});a.down('#atToken').element.on({tap:'scrollToAt',scope:a});var c=a.getStore();if(User.chatMemID){ChatUtil.createDirectChat2(function(d){var f=a.getParent();var e=d.chat_id;f.config.chatid=e;User.crtChannelId=e;c.chatID=e;var g=Ext.getStore('comRct').getById(d.chat_id);a.rctAfterOpenChat(f,e);ChatUtil.getHistory2(e,function(f){if(f.length>0){c.add(f);ChatUtil.checkReadInfo(c,f);var e=f[f.length-1];if(!g){Ext.getStore('comRct').add({chat_id:d.chat_id,name:User.crtChatName,type:d.chat_type,last_msg_type:e.msg_type,last_post_at:new Date(e.updateTime),last_post_msg:e.sendText,chat_name:d.chat_name,members:d.members,create_at:d.create_at,avaID:d.user_id});var h='UPDATE IMRct SET LastPostAt=?, LastUserID=?, LastUserName=?, LastMessage=?, LastMsgType=? WHERE ChatID=?;';LocalDataMgr.cExecSqlWithP(h,[e.updateTime,e.senderID,e.senderName,e.sendText,e.msg_type,d.chat_id])}var i=a.getScrollable();if(i){i.scrollTo(0,Infinity)}}else {if(!g){Ext.getStore('comRct').add({chat_id:d.chat_id,name:User.crtChatName,type:'D',last_msg_type:'T',last_post_at:new Date(),last_post_msg:' ',chat_name:d.chat_name,members:d.members,create_at:d.create_at,avaID:d.user_id});User.crtChannelType='D';var h='UPDATE IMRct SET LastPostAt=?, LastUserID=?, LastUserName=?, LastMessage=?, LastMsgType=? WHERE ChatID=?;';LocalDataMgr.cExecSqlWithP(h,[(new Date()).getTime(),d.user_id,User.crtChatName,' ','T',d.chat_id])}}LocalDataMgr.getMentions(User.crtChannelId,function(j,i){var c=i.rows;a.atinfos=[];if(c.length>0){for(var e=0;e<c.length;e++){var h=c.item(e);a.atinfos.push({id:h.MsgID,seq:h.MsgSeq})}}else {var g=Ext.getStore('comRct').getById(b);if(g){g.set({MentionCount:0})}}a.getViewModel().setData({atCount:c.length})})});if(IMHelper.canUseReceipt()){ChatUtil.sendScrollReadDetails()}})}else {var d=a.getParent(),b=d.config.chatid,e=d.config.msgseq;User.crtChannelId=b;c.chatID=b;a.rctAfterOpenChat(d,b);ChatUtil.getHistory2(b,function(f){if(f.length>0){if(f.length==20){c.removeAll()}c.add(f);ChatUtil.checkReadInfo(c,f);if(!e){var h=a.getScrollable();if(h){h.scrollTo(null,Infinity)}}var g=Ext.getStore('comRct').getById(b),d=f[f.length-1];if(!g){Utils.custAjax('get','users/me/chats/'+User.crtChannelId,{success:function(a){if(a.iscrowd=='Y'){a.chat_type='C'}var c=Ext.getStore('comRct').add({chat_id:b,name:User.crtChatName,type:a.chat_type,last_msg_type:d.msg_type,last_post_at:new Date(d.updateTime),last_post_name:d.senderName,last_post_msg:d.sendText,chat_name:a.chat_name,members:a.members,create_at:a.create_at,avaID:a.chat_id,manager_id:a.creator_id,IsMute:a.is_mute});c.last_post_id=d.senderID;c.last_post_name=d.senderName;c.last_post_at=d.updateTime;c.creator_id=a.creator_id;c.manager_id=a.manager_id;c.create_at=a.create_at;c.update_at=a.update_at;c.avatar_hash=a.avatar_hash}})}else {if(d&&g.get('last_post_at').getTime()<d.updateTime){g.set({last_msg_type:d.msg_type||'G',last_post_at:new Date(d.updateTime),last_post_msg:d.sendText,last_post_id:d.senderID,last_post_name:d.senderName});var i='UPDATE IMRct SET LastPostAt=?, LastUserID=?, LastUserName=?, LastMessage=?, LastMsgType=? WHERE ChatID=?;';LocalDataMgr.cExecSqlWithP(i,[d.updateTime,d.senderID,d.senderName,d.sendText,d.msg_type,b])}}}LocalDataMgr.getMentions(User.crtChannelId,function(i,h){var c=h.rows;a.atinfos=[];if(c.length>0){for(var d=0;d<c.length;d++){var g=c.item(d);a.atinfos.push({id:g.MsgID,seq:g.MsgSeq})}}else {var e=Ext.getStore('comRct').getById(b);if(e){e.set({MentionCount:0})}}a.getViewModel().setData({atCount:c.length})});if(IMHelper.canUseReceipt()){ChatUtil.sendScrollReadDetails()}},e)}MobileHelper.getChatType(User.crtChannelId)},rctAfterOpenChat:function(a,b){if(!User.hasInitOrg){OrgDataHepler.initOrg(function(){ChatUtil.rctAfterOpenChat(b,function(){},function(c){a.setHeader(c)})})}else {ChatUtil.rctAfterOpenChat(b,function(){},function(c){a.setHeader(c)})}},onresize:function(h,j,g,k,b){if(b){var i=b-g;var c=h.getScrollable(),a=c.getScrollElement(),f=a.getScrollTop(),d=a.dom.clientHeight,e=a.dom.scrollHeight;if(Math.abs(f+d-e)>1){c.scrollBy(null,i)}}},onTapChild:function(d,f){if(this.stopTap){this.stopTap=!1;return}var a=f.record;if(!a){return}var e=f.event,b=Ext.fly(e.target),j='img.viewPic.loaded',i='.msgtype-F';if(b.is(j)){ImgMgr.showViewerOfDom2(d,b.dom)}else {if(b.findParent(i)){if(a.data.fileStatus==3){return}else {if(a.data.fileStatus==0){var c=a.data.localPath;var m=FileUtil.getExtension(c);if(FileUtil.isImgExtension(m)){ImgMgr.showViewerOfDom2(d,b.findParent('.x-listitem'))}else {Config.ChooseFile='Y';Config.OpenFile=!0;if(!c.toLowerCase().startsWith('file://')){c=ConfigMgr.getDefaultDir()+c}else {if(c.indexOf('Inbox/')>-1){c=window.cordova.file.documentsDirectory+'Inbox/'+c.split('Inbox')[1]}}FileMgr.open(c)}}else {if(a.data.fileStatus==4||a.data.fileStatus==1){DownFileMgr.downFileForA(a.data)}}}}else {if(b.is('.sendfail')){SendUtil.resendMsg(a.data,function(b){if(b.length>0){var h=ParseUtil.getLocalTime(!0),e=!1;e=ParseUtil.dataShowTime(d.store,new Date(h));b[0].showTime=e;d.store.add(b);var c=d.getScrollable();if(c){var g=c.getScrollElement().dom.scrollHeight;c.scrollTo(0,g)}d.store.remove(a)}return d.store})}else {if(b.is('.avatar')||b.parent().is('.avatar')){var k=a.data.senderID;Redirect.redirectTo('IMMobile-memDetail',{userid:k})}else {if(b.is('a[href]')){if(Config.isPhone&&typeof cordova!='undefined'&&cordova.InAppBrowser){var l=f.sourceElement.href;cordova.InAppBrowser.open(l,'_system');if(e.preventDefault){e.preventDefault()}}}else {if(b.findParentNode('.bubble')&&b.findParentNode('.bubble').querySelector('.linkMsg')){if(ConfigMgr.isAio8()){var g=a.get('content');if(!g.startsWith('[ErpMsg]')){Ext.Viewport.getController().fireEvent('openbbcode',g)}else {Utils.toastShort('请在PC端查看')}}else {var h=b.findParentNode('.bubble').querySelector('a');if(h&&Config.isPhone&&typeof cordova!='undefined'&&cordova.InAppBrowser){cordova.InAppBrowser.open(h.href,'_system')}}if(e.preventDefault){e.preventDefault()}}else {if(b.hasCls('readNum')&&IMHelper.canUseReceipt()){if(!(b.dom.outerText=='全部已读'||b.dom.outerText=='已读'||b.dom.outerText=='未读')){Redirect.redirectTo('chatreaddetails',{chat_id:User.crtChannelId,msg_id:a.data.msg_id,readcount:a.data.read_count,unreadcount:a.data.unread_count,record:a})}}}}}}}}},onLongPress:function(j,b,o){this.stopTap=!0;var k=Ext.fly(b.sourceElement);if(k.is('.avatar')||k.parent().is('.avatar')){var i=b.record,l=j.parent.down('IMMobile-Editor');l.afterSelectATUser([[i.data.senderID,i.data.senderName]]);return}var a=j.down('#menuHandler');a.record=b.record;var d=b.record.get('msg_type');var c=1,g=1,f=1,e=0;if(d=='B'||d=='G'){return}if(d!='F'||d=='F'&&b.record.get('fileStatus')===0){a.down('#menuDataTrans').show()}else {a.down('#menuDataTrans').hide();f=0}if(b.record.get('msg_type')!='T'){a.down('#menuCopy').hide();a.down('#menuCopySplit').hide();g=0}else {a.down('#menuCopy').show();a.down('#menuCopySplit').show()}if(d=='F'&&b.record.get('fileStatus')===0){var h=a.down('#menuThirdOpen');h.show();h.targetRecord=b.record;e=1}var n=Ext.StoreMgr.get('comRct').getById(User.crtChannelId).get('type');if(n=='C'){Utils.custAjax('get','chatcs/'+User.crtChannelId,{success:function(d){for(var e=0;e<d.members.length;e++){if(d.members[e].user_id==User.ownerID){if(d.members[e].is_admin=='Y'||d.members[e].user_id==d.manager_id){a.down('#menuRevoke').show()}else {if(b.record.get('senderID')!=User.ownerID){a.down('#menuRevoke').hide();a.down('#menuTransSplit').hide();c=0}else {var f=(new Date()).getTime()-b.record.data.updateTime-User.difTime;if(f<120000){a.down('#menuRevoke').show()}else {a.down('#menuRevoke').hide();a.down('#menuTransSplit').hide();c=0}}}}}},failure:function(){}})}else {if(b.record.get('senderID')!=User.ownerID){a.down('#menuRevoke').hide();a.down('#menuTransSplit').hide();c=0}else {var m=(new Date()).getTime()-b.record.data.updateTime-User.difTime;if(m<120000){a.down('#menuRevoke').show()}else {a.down('#menuRevoke').hide();a.down('#menuTransSplit').hide();c=0}}}if(!c&&!g&&!f&&!e){return}a.show()},getSliHis:function(d,c,a){var b=this;Utils.custAjax('post','chats/'+d+'/posts/unread',{params:JSON.stringify(c),success:function(g){var b=g.message_list,f=[];if(b&&b.length>0){f=ParseUtil.parseRemoteMsg(b);LocalDataMgr.initAddToMsg(b)}var e=g.recall_message_list;if(e&&e.length>0){LocalDataMgr.initRevokeMsg(e)}if(a){a(f)}},failure:function(e){Utils.toastShort('获取数据出错:'+e);b.canScrol=!1;b._plugins[0].snapBack(!0)}})},onDestroy:function(){User.crtChannelId='';this.callParent(arguments)},onPullRefresh2:function(){var b=this;var c=Ext.Viewport.lookup('IMMobile').down('pullloaddata');var a=b.getStore(),e=a.getAt(0),d=User.crtChannelId;(new Promise(function(h,i){if(!b.canScrol){if(!e){c.setState('loaded');return}b.canScrol=!0;var f=0;for(var g=0;g<a.data.items.length;g++){if(a.getAt(g).get('msgSeq')&&a.getAt(g).get('msgSeq')>=10000){f=a.getAt(g).get('msgSeq');break}}if(f<=10000){c.setState('loaded');Utils.toastShort('没有更多消息了');return}LocalDataMgr.getHistoryBySeq(d,f-20,f,function(j,g){var e=g.rows;var a=ParseUtil.parseLocalMsg(e);var c=ParseUtil.judgeSlice(e,f);if(c.length>0){b.getSliHis(d,c,function(c){var b=a.concat(c);b=ParseUtil.sortHistory(b);h(b)})}else {h(a)}},function(a){Utils.toastShort(a);b.canScrol=!1;c.setState('loaded')})}else {c.setState('loaded');Utils.toastShort('没有更多消息了')}})).then(function(d){return (new Promise(function(f,g){if(d.length==0){Utils.toastShort('没有更多消息了')}else {a.insert(0,d);ChatUtil.checkReadInfo(a,d);b.ensureVisible(e,{align:{y:'start'}});b.canScrol=!1}c.setState('loaded')}))['catch'](function(a){console.log('1th',a)})}).then(function(a){console.log('res',a)})['catch'](function(a){console.log('catch',a)})},onPullRefresh:function(){var a=this;var c=Ext.Viewport.lookup('IMMobile').down('pullloaddata');if(!a.canScrol){var b=a.getStore(),f=b.getAt(0),g=User.crtChannelId;if(!f){c.setState('loaded');return}a.canScrol=!0;var d=0;for(var e=0;e<b.data.items.length;e++){if(b.getAt(e).get('msgSeq')&&b.getAt(e).get('msgSeq')>=10000){d=b.getAt(e).get('msgSeq');break}}if(d<=10000){c.setState('loaded');Utils.toastShort('没有更多消息了');return}LocalDataMgr.getHistoryBySeq(g,d-20,d,function(k,j){var i=j.rows;var e=ParseUtil.parseLocalMsg(i);var h=ParseUtil.judgeSlice(i,d);if(h.length>0){a.getSliHis(g,h,function(g){var d=e.concat(g);d=ParseUtil.sortHistory(d);a.canScrol=!1;b.insert(0,d);ChatUtil.checkReadInfo(b,d);a.ensureVisible(f,{align:{y:'start'}});c.setState('loaded')})}else {if(e.length==0){Utils.toastShort('没有更多消息了')}else {b.insert(0,e);a.ensureVisible(f,{align:{y:'start'}});a.canScrol=!1}c.setState('loaded')}},function(b){Utils.toastShort(b);a.canScrol=!1;c.setState('loaded')})}else {c.setState('loaded');Utils.toastShort('没有更多消息了')}},onAddDatas:function(f){var a=this;var b=a._scrollable._scrollElement.dom,i=b.scrollHeight,j=b.scrollTop,h=b.clientHeight,g=j+h;var d=a.getStore().getCount();var e=a.getRecordIndexFromPoint(0,g-10);if(d-1-e==1){a._scrollable.scrollTo(0,i);a.getViewModel().setData({unread:0})}else {var c=a.getViewModel().getData().unread;c+=f;a.getViewModel().setData({unread:c})}},onChgScrol:function(c,k,l,h,i,j){var d=this;var a=c._scrollElement.dom,f=a.scrollHeight,g=a.scrollTop,e=a.clientHeight,b=f-g-e;if(b<40){d.getViewModel().setData({unread:0})}if(IMHelper.canUseReceipt()){ChatUtil.sendScrollReadDetails()}},scrollToBottom:function(){var c=this,a=c._scrollable,b=a._scrollElement.dom,d=b.scrollHeight;a.scrollTo(0,d)},scrollToAt:function(l,k){var b=this;var g=Ext.fly(k);if(g.is('.at-token-msg')){var j=this.atinfos;var c=j.pop();var d=c.id;var a=this.getStore();var f=a.getById(d);if(f){this.scrollToRecord(f)}else {var i=a.data.items[0];var h=i.data.msgSeq;LocalDataMgr.getHistoryBySeq(User.crtChannelId,c.seq,h,function(j,i){var g=i.rows;var e=ParseUtil.parseLocalMsg(g);var f=ParseUtil.judgeSlice(g,c.seq,c.seq);if(f.length>0){b.getSliHis(User.crtChannelId,f,function(g){var c=e.concat(g);c=ParseUtil.sortHistory(c);a.insert(0,c);ChatUtil.checkReadInfo(a,c);var f=a.getById(d);if(f){b.scrollToRecord(f)}})}else {if(e.length==0){}else {a.insert(0,e);ChatUtil.checkReadInfo(a,e);var h=a.getById(d);if(h){b.scrollToRecord(h)}}}},function(a){Utils.toastShort(a)})}b.removeOneAt(d)}else {if(g.is('.at-token-clear')){AtUtil.clearServerMention(User.crtChannelId,function(){LocalDataMgr.clearMentions(User.crtChannelId)});var e=Ext.getStore('comRct').getById(User.crtChannelId);if(e){e.set('MentionCount',0)}b.getViewModel().setData({atCount:0});b.atinfos=[]}}},removeOneAt:function(a){var b=this;var c=b.atinfos;AtUtil.removeServerOneMention(User.crtChannelId,a,function(){LocalDataMgr.removeOneMention(User.crtChannelId,a);if(c.length==0){var d=Ext.getStore('comRct').getById(User.crtChannelId);if(d){d.set('MentionCount',0)}b.getViewModel().setData({atCount:0})}})},clearAt:function(){AtUtil.clearServerMention(User.crtChannelId,function(){var a=Ext.getStore('comRct').getById(User.crtChannelId);if(a){a.set('MentionCount',0)}this.getViewModel().setData({atCount:0})})},addNewAt:function(b,a){this.atinfos.push({id:b,seq:a});this.getViewModel().setData({atCount:this.atinfos.length})}});Ext.define('IMMobile.view.chatView.NewsView',{extend:'Ext.Container',xtype:'newsview',layout:'vbox',viewModel:{data:{editViewStatus:1}},cls:'IMMobile-ChatViewWrp phone-news-contain',items:[{xtype:'IMMobile-Navbar',itemId:'chatViewNav',userCls:'hasRightButton',title:'消息中心',items:[{xtype:'button',width:30,docked:'right'}]},{xtype:'newsviewlist',flex:1},{xtype:'pullloaddata'},{xtype:'container',cls:'bottominset',bind:{hidden:'{editViewStatus == 0}'},items:[{xtype:'container',cls:'zoom',layout:'hbox',items:[{xtype:'button',itemId:'zoomBtn',iconCls:'x-fa fa-outdent'},{html:'帮助',itemId:'helper',cls:'helper',flex:1}]}]},{xtype:'IMMobile-Editor',bind:{hidden:'{editViewStatus == 1}'},itemId:'IMMobile-Editor',docked:'bottom'}],listeners:{destroy:{fn:function(){User.crtChannelId=''}}},initialize:function(){var a=this;a.callParent(arguments);a.down('IMMobile-Navbar').getBackBtn().setText('消息');a.down('#zoomBtn').on({scope:a,tap:'onZoom'});a.down('#helper').element.on({scope:a,tap:'onHelp'});a.initBottomToolBar();a.down('pullloaddata').setList(a.down('newsviewlist'))},initBottomToolBar:function(){var b=this;var d=b.down('#IMMobile-Editor').down('toolbar'),a=d.innerItems[0],c=d.down('#sendBtn');a.setIconCls('x-fa fa-outdent');a.setHandler('');c.clearListeners();a.on({scope:b,tap:'onZoom'});c.on({scope:b,tap:'onSend'})},onZoom:function(){var d=this,a=d.getViewModel(),b=a.getData().editViewStatus,c=b==0?1:0;a.setData({editViewStatus:c})},onHelp:function(){var b=this,a=[];a.push({type:'T',value:'Helper'});SendUtil.sendNewsCommand(User.crtChannelId,a,Ext.getStore('comRct'),b.down('newsviewlist'))},onSend:function(){var a=this;var b=a.down('imCommonEditor');SendUtil.sendMsg(b,User.crtChannelId,Ext.getStore('comRct'),a.down('newsviewlist'))}});Ext.define('IM.view.rightContainer.NewsViewList',{extend:'Ext.List',xtype:'newsviewlist',classCls:'msg-list',itemsFocusable:!1,selectable:!1,scrollable:!0,disableSelection:!0,hoveredCls:'hovered',store:{},itemTpl:'<tpl if="values.showTime">'+'<div class="msgTime">{[ParseUtil.handleMsgShowTime(values.updateTime)]}</div>'+'</tpl>'+'<tpl if="values.isText == \'N\'">'+'<div class="content">'+'<div class="news-card">'+'<div class="news-title">'+'{title}'+'</div>'+'<div class="news-pic" style="height:{[User.NewsHeight]}px">'+'{[ImgMgr.parseNewsPic(values)]}'+'</div>'+'<div class="news-desc">'+'{desc}'+'</div>'+'</div>'+'</div>'+'<tpl elseif="values.creatorID == User.ownerID">'+'<div style="text-align:right;float:right;max-width:80%;" class="msgtype-T">'+'<div class="bubble mine">'+'<div class="plain">'+'<tpl if="values.sendStatus==2">'+'<div class="loadgif mineStu"></div>'+'<tpl elseif="values.sendStatus==1">'+'<div class="sendfail mineStu"></div>'+'</tpl>'+'{[ParseUtil.textToHtml(values.desc)]}'+'</div>'+'</div>'+'</div>'+'<tpl else>'+'<div class="evAvatar">'+'<a class="avatar">'+('<img src="'+Ext.getResourcePath('images/xiaoxi.png',null,null)+'" >')+'</a>'+'<div class="sendDesc">消息中心</div>'+'</div>'+'<div style="text-align:left;float:left;max-width:80%;" class="msgtype-T">'+'<div class="bubble others">'+'<div class="plain">'+'{[ParseUtil.textToHtml(values.desc)]}'+'</div>'+'</div>'+'</div>'+'</tpl>',initialize:function(){var a=this;a.callParent(arguments);a.on({scope:a,childtap:'clickNewsCard',resize:'onresize'});a.placeHolderImg();a.rctAfterOpenChat()},placeHolderImg:function(){var c=this;var b=Math.floor((window.innerWidth-4-36)*0.95-2),a=Math.round(b*11/24);User.NewsHeight=a},rctAfterOpenChat:function(){var c=this;var a=Ext.getStore('comRct'),b=a.getById(StaticChatID.News);if(!b){LocalDataMgr.getLocalNews((new Date()).getTime(),1,function(g,f){var e=f.rows;if(e.length>0){var b=e.item(0);a.add({chat_id:StaticChatID.News,name:'消息中心',type:ChatType.News,last_post_at:new Date(b.CreateAt),last_post_msg:b.Title||b.Description,last_msg_type:b.NewsType});var d=[];d.push({creator_id:b.CreatorID,create_at:b.CreateAt,unReadNum:0,title:b.Title||b.Description,news_type:b.NewsType});LocalDataMgr.newsToLocalChat(d[0]);LocalDataMgr.newsToLocalRct(d[0])}else {a.add({chat_id:StaticChatID.News,name:'消息中心',type:ChatType.News,last_post_at:new Date(),last_post_msg:' ',last_msg_type:'PNS'});var c=[];c.push({creator_id:'',create_at:(new Date()).getTime(),unReadNum:0,title:' ',news_type:''});LocalDataMgr.newsToLocalChat(c[0]);LocalDataMgr.newsToLocalRct(c[0])}})}else {b.set({isUnRead:!1,unReadNum:0});LocalDataMgr.rctSetUnreadToRead(StaticChatID.News)}AddDataUtil.bindNews(c,function(d){if(d.length===0){return}var b=d[0],e=a.getById(StaticChatID.News);e.set({last_post_at:new Date(b.updateTime),last_post_msg:b.title||b.desc});c.scrollToBottom();ChatUtil.viewNews()})},scrollToBottom:function(){var c=this,a=c._scrollable,b=a._scrollElement.dom,d=b.scrollHeight;a.scrollTo(0,d)},onresize:function(h,j,g,k,b){if(b){var i=b-g;var c=h.getScrollable(),a=c.getScrollElement(),f=a.getScrollTop(),d=a.dom.clientHeight,e=a.dom.scrollHeight;if(Math.abs(f+d-e)>1){c.scrollBy(null,i)}}},clickNewsCard:function(i,a){var g=a.sourceElement,h=Ext.fly(g);if(h.findParent('.news-card')){var c=User.accURL.split('/');c.pop();var d=c.join('/'),e=Utils.toHex(a.record.data.newsID),f=Utils.toHex(User.ownerID),b=d+'/News/NewsHtml.ashx?news_id='+e+'&user_id='+f;console.log('html:',b);Redirect.redirectTo('imbrowser',{title:a.record.data.title,htmlUrl:b})}},onPullRefresh2:function(){var e=this;var a=Ext.Viewport.lookup('IMMobile').down('pullloaddata');var d=e.getStore(),b=d.getAt(0);if(!b){a.setState('loaded');return}var f=b.get('updateTime'),c=b.get('newsSeq');if(c<=10000){a.setState('loaded');return}(new Promise(function(a){LocalDataMgr.getLocalNews(f,20,function(j,i){var d=i.rows,g=[],f=[];if(d.length>0){for(var e=d.length-1;e>=0;e--){var b=d.item(e),h=!0;if(e<d.length-1){if(ParseUtil.inOneMinute(d.item(e+1).CreateAt,b.CreateAt)){h=!1}}g.push({showTime:h,updateTime:b.CreateAt,newsSeq:b.NewsSeq,newsID:b.NewsID,newsType:b.NewsType,title:b.Title,desc:b.Description,picUrl:b.PicUrl,desUrl:b.DesCUrl,isText:b.IsText,extras:b.Extras,creatorID:b.CreatorID})}f=ParseUtil.judgeNewsSlice(d,c);a({datas:g,slice:f})}else {f=[{from_seq:c-20,to_seq:c}];a({datas:g,slice:f})}})})).then(function(d){var c=d.datas,b=d.slice;if(b&&b.length>0){return (new Promise(function(a){ChatUtil.getMissNewsFromServer(b,function(e){var b=c.concat(e);b=ParseUtil.sortHistory(b);a(b)})}))['catch'](function(){a.setState('loaded')})}return (new Promise(function(a){a(c)}))['catch'](function(){a.setState('loaded')})}).then(function(c){return (new Promise(function(a){d.insert(0,c);e.ensureVisible(b,{align:{y:'start'}});a()}))['catch'](function(){a.setState('loaded')})}).then(function(){a.setState('loaded')})['catch'](function(){a.setState('loaded')})}});Ext.define('IMMobile.view.chatView.editor.emoji.CarouselItem',{extend:'Ext.Component',xtype:'emj_carousel_item',config:{cls:'emj-carousel-item',tpl:['<table style="width:100%;height:100%">','<tpl for=".">','<tpl if="xindex % 7 == 1">','<tr>','</tpl>','<td class="emj">{t}</td>','<tpl if="xindex == 20">','<td class="backspace"></td>','</tpl>','<tpl if="xindex % 7 == 0 || xindex == 20">','</tr>','</tpl>','</tpl>','</table>'].join('')}});Ext.define('IMMobile.view.chatView.editor.emoji.Carousel',{extend:'Ext.carousel.Carousel',requires:['IMMobile.view.chatView.editor.emoji.CarouselItem'],xtype:'emj_carousel',innerItemConfig:{xtype:'emj_carousel_item'},pageSize:20,emojis:[{t:'😁'},{t:'😂'},{t:'😃'},{t:'😄'},{t:'😅'},{t:'😆'},{t:'😉'},{t:'😊'},{t:'😋'},{t:'😌'},{t:'😍'},{t:'😏'},{t:'😒'},{t:'😓'},{t:'😔'},{t:'😖'},{t:'😘'},{t:'😚'},{t:'😜'},{t:'😝'},{t:'😞'},{t:'😠'},{t:'😡'},{t:'😢'},{t:'😣'},{t:'😤'},{t:'😥'},{t:'😨'},{t:'😩'},{t:'😪'},{t:'😫'},{t:'😭'},{t:'😰'},{t:'😱'},{t:'😲'},{t:'😳'},{t:'😵'},{t:'😷'},{t:'😸'},{t:'😹'},{t:'😺'},{t:'😻'},{t:'😼'},{t:'😽'},{t:'😾'},{t:'😿'},{t:'🙀'},{t:'🙅'},{t:'🙆'},{t:'🙇'},{t:'🙈'},{t:'🙉'},{t:'🙊'},{t:'🙋'},{t:'🙌'},{t:'🙍'},{t:'🙎'},{t:'🙏'},{t:'✂'},{t:'✅'},{t:'✈'},{t:'✉'},{t:'✊'},{t:'✋'},{t:'✌'},{t:'✏'},{t:'✒'},{t:'✔'},{t:'✖'},{t:'✨'},{t:'✳'},{t:'✴'},{t:'❄'},{t:'❇'},{t:'❌'},{t:'❎'},{t:'❓'},{t:'❔'},{t:'❕'},{t:'❗'},{t:'❤'},{t:'➕'},{t:'➖'},{t:'➗'},{t:'➡'},{t:'➰'},{t:'🚀'},{t:'🚃'},{t:'🚄'},{t:'🚅'},{t:'🚇'},{t:'🚉'},{t:'🚌'},{t:'🚏'},{t:'🚑'},{t:'🚒'},{t:'🚓'},{t:'🚕'},{t:'🚗'},{t:'🚙'},{t:'🚚'},{t:'🚢'},{t:'🚤'},{t:'🚥'},{t:'🚧'},{t:'🚨'},{t:'🚩'},{t:'🚪'},{t:'🚫'},{t:'🚬'},{t:'🚭'},{t:'🚲'},{t:'🚶'},{t:'🚹'},{t:'🚺'},{t:'🚻'},{t:'🚼'},{t:'🚽'},{t:'🚾'},{t:'🛀'}],initialize:function(){var a=this;a.callParent(arguments);var e=a.emojis.length;var c=Math.ceil(e/a.pageSize);for(var b=0;b<c;b++){var d=a.emojis.slice(b*a.pageSize,(b+1)*a.pageSize);a.add({xtype:'emj_carousel_item',data:d})}}});Ext.define('IMMobile.view.chatView.editor.menu.More',{extend:'Ext.Component',xtype:'editor_more_menu',config:{cls:'editor-more-menu media-ajust-menu',tpl:['<tpl for=".">','<div itemid="{value}" class="item x-layout-hbox x-vertical x-align-center">','<div class="square-icon {iconCls}"></div>','<div class="menu-text">{text}</div>','</div>','</tpl>'].join('')},scrollable:'y',initialize:function(){this.callParent(arguments);this.innerElement.on({delegate:'div.item',tap:'onTapMenuItem',touchstart:'onItemTouchStart',touchcancel:'onItemTouchEnd',touchend:'onItemTouchEnd',scope:this})},onItemTouchStart:function(b,a){Ext.fly(a).addCls('pressed')},onItemTouchEnd:function(b,a){Ext.fly(a).removeCls('pressed')},onTapMenuItem:function(c,a){var b=a.getAttribute('itemid');this.fireEvent('tapmenu',this,b)}});Ext.define('IMMobile.view.IMMobileMain.component.CrowdSelectView',{extend:'IMMobile.view.base.Container',xtype:'crowdselectview',requires:['MX.plugin.ListOptions'],controller:'crowdinfoviewcontroller',userCls:'mobileNestList userSelect',scrollable:!0,useTitleAsBackText:!1,updateTitleText:!0,allowDeselect:!0,emptyText:'无数据',clearSelectionOnListChange:!0,selectedData:{},viewModel:{data:{selectedData:{}},formulas:{dataLength:function(b){var a=b('selectedData');return Object.getOwnPropertyNames(a).length}}},layout:'vbox',items:[{xtype:'IMMobile-Navbar',itemId:'navTop',backBtn:{handler:'onBack'},title:'群管理员',docked:'top'},{xtype:'list',flex:1,store:{storeId:'addAdmin',idProperty:'user_id',fields:['user_id','user_name','checked']},selectable:'multi',itemTpl:['<div class="im-mobile {[values.isDefault == "Y" ? "im-mobile-selected" : "icon-select"]} {[values.checked ? "selectedMan" : ""]}"></div>','<div class="nested-org">','<image class="nested-user-avatar" src="{[ImgUtil.onePxImg]}" onload="AvatarMgr.loadAvt2(this,0);"  data-user="{user_id}" data-type="D" width="30" height="30">','<div>{user_name}</div>','</div>'].join(''),listeners:{childtap:'onSelect'}},{xtype:'container',docked:'bottom',style:'background-color: #fff',cls:'bottominset',items:[{xtype:'container',height:50,width:'100%',layout:'hbox',cls:'btnSure-ct',itemId:'ctSelected',scrollable:{x:!0,y:!1},items:[{xtype:'button',itemId:'btnEnter',docked:'right',width:90,cls:'btnSure',bind:{text:'确定',disabled:!0},handler:'onAddAdmins'}]}]}],initialize:function(){var b=this;b.callParent(arguments);var a=[];Utils.custAjax('get','chatcs/'+b.config.chatid,{success:function(b){User.crowd_manager=b.manager_id;User.crtId=b.id;for(var c=0;c<b.members.length;c++){if(b.members[c].is_admin!='Y'&&b.members[c].user_id!=User.crowd_manager){a.push({user_id:b.members[c].user_id,user_name:b.members[c].user_name,checked:!1})}}Ext.getStore('addAdmin').setData(a)},failure:function(){}})}});Ext.define('IMMobile.view.component.RctChatList',{extend:'Ext.List',xtype:'rctchatlist',requires:['IMCommon.model.RctChat','IMCommon.utils.AvatarMgr','MX.plugin.ListOptions'],store:{storeId:'comRct',model:'IMCommon.model.RctChat',sorters:[{property:'toTop',direction:'DESC'},{property:'last_post_at',direction:'DESC'}]},plugins:{listoptions:{borderOffset:2,items:[{handler:'onSetChatTop',color:'action-top',text:'置顶',action:'top'},{handler:'onSetChatTop',color:'action-top',text:'取消置顶',action:'untop'},{handler:'onSetChatKeep',text:'收藏',action:'keep',color:'action-keep'},{handler:'onSetChatKeep',text:'取消收藏',action:'unkeep',color:'action-keep'},{text:'移除',handler:'onRemoveChat',action:'delete',color:'action-delete'}],itemFilter:function(f,a,b){if(b.data.toTop&&a=='top'){return !1}else {if(!b.data.toTop&&a=='untop'){return !1}}if(b.data.chat_id==StaticChatID.News&&(a=='keep'||a=='unkeep')){return !1}var e=User.favChats;var c=!1;for(var d=0;d<e.length;d++){if(b.data.chat_id==e[d].chat_id){c=!0}}if(c&&a=='keep'){return !1}else {if(!c&&a=='unkeep'){return !1}}return !0}}},selectable:!1,userCls:'rctChat',initialize:function(){var a=this;a.callParent(arguments);var b=a.getStore();b.on({add:'onStoreChg',update:'onStoreChg',destroyable:!0,scope:a});Utils.mask(a);ChatUtil.getLocalRct2(function(c){User.cacheMil=(new Date()).getTime();if(c.length>0){a.getStore().add(c)}var b=a.up('IMMobile');if(b.logined&&!b.wsConned){b.afterRctInit()}Utils.unMask(a)})},afterGetLocal:function(a){this.getStore().add(a);Utils.unMask(this)},onStoreChg:function(a,b,d,c){a.sort();Ext.Viewport.lookup('IMMobile').getRctBadge()},itemTpl:['<div class="itemRight {[values.toTop?"toTopBgColor":""]}">','<div class="wrapAva">','<tpl if="values.type == ChatType.News">'+'<a class="avatar link-avatar firstletter loaded">','<img src="'+Ext.getResourcePath('images/xiaoxi.png',null,null)+'" >'+'</a>','<tpl elseif="window.cordova">','<tpl if="Ext.os.is.ios">','<a class="avatar link-avatar firstletter loaded">','<tpl if="values.type == \'D\'">','<img src="{[AvatarMgr.getIOSChatAvaUrl(values.avaID,values.create_at,values.type)]}" onerror="AvatarMgr.doUserAvaErr(this)" ava-id="{avaID}" create-at="{create_at}" hash="{avaHash}">','<tpl elseif="values.type == \'C\'">','<img src="{[AvatarMgr.getIOSChatAvaUrl(values.avaID,values.create_at,values.type)]}" onerror="AvatarMgr.doCrowdAvaErr(this)" ava-id="{avaID}" create-at="{create_at}" hash="{avaHash}">','<tpl else>','<img src="{[AvatarMgr.getIOSChatAvaUrl(values.avaID,values.create_at,values.type)]}" onerror="AvatarMgr.doChatAvaErr(this)" ava-id="{avaID}" create-at="{create_at}" hash="{avaHash}">','</tpl>','</a>','<tpl elseif="values.type == \'D\'">','{[AvatarMgr.getUserAvaHtml(values.avaID, values.avaHash)]}','<tpl elseif="values.type == \'C\'">','{[AvatarMgr.getCrowdAvaHtml(values.chat_id, values.create_at, values.avaHash)]}','<tpl else>','{[AvatarMgr.getChatAvaHtml(values.chat_id, values.create_at, values.avaHash)]}','</tpl>','<tpl else>','<image class="avatar" src="{[ImgUtil.onePxImg]}" onload="AvatarMgr.loadAvt2(this,0);" data-user="{avaID}" data-time="{create_at}" data-type="{type}" hash="{avaHash}" cid="{chat_id}"/>','</tpl>','<a class="RecentUnRead" unRead="{unReadNum}" style="cursor:default;display:{[values.isUnRead?"block":"none"]}"></a>','</div>','<div class="evt">','<p>{[Utils.datetime2Ago(values.last_post_at, true)]}</p></br>','<p style="display:none;">{status}</p>','</div>','<div class="displayInfo">','<div class="displayName">{name}</div>','<tpl if="values.MentionCount &gt; 0"><span class="span-at">[有人@我]</span></tpl>','<tpl if="values.last_msg_type == \'Draft\'">','<font color="red">[草稿]</font>','{[ParseUtil.parseRctText(values.last_post_msg)]}','<tpl elseif="values.type == \'D\'">','<tpl if="values.last_msg_type == \'T\'">','<div class="displayMsg">{[ParseUtil.parseRctText(values.last_post_msg)]}</div>','<tpl elseif="values.last_msg_type == \'F\'">','<div class="displayMsg">[文件]</div>','<tpl elseif="values.last_msg_type == \'I\'">','<div class="displayMsg">[图片]</div>','<tpl elseif="values.last_msg_type == \'L\'">','<div class="displayMsg">[链接]</div>','<tpl elseif="values.last_msg_type == \'E\'">','<div class="displayMsg">[大文件]</div>','<tpl elseif="values.last_msg_type == \'B\'">','<div class="displayMsg">{[ParseUtil.parseRctText(values.last_post_msg)]}</div>','<tpl else>'+'<div class="displayMsg">&nbsp;</div>','</tpl>',"<tpl elseif=\"values.type == 'G'||values.type == 'C'\">",'<tpl if="values.last_msg_type == \'T\'">','<div class="displayMsg">{last_post_name}：{[ParseUtil.parseRctText(values.last_post_msg)]}</div>','<tpl elseif="values.last_msg_type == \'I\'">','<div class="displayMsg">{last_post_name}：[图片]</div>','<tpl elseif="values.last_msg_type == \'F\'">','<div class="displayMsg">{last_post_name}：[文件]</div>',"<tpl elseif=\"values.last_msg_type == 'G'||values.last_msg_type == 'R'||values.last_msg_type == 'M'||values.last_msg_type == 'N'||values.last_msg_type == 'S'||values.last_msg_type == 'A'\">",'<div class="displayMsg">[通知]</div>','<tpl elseif="values.last_msg_type == \'L\'">','<div class="displayMsg">{last_post_name}：[链接]</div>','<tpl elseif="values.last_msg_type == \'E\'">','<div class="displayMsg">[大文件]</div>','<tpl elseif="values.last_msg_type == \'B\'">','<div class="displayMsg">{[ParseUtil.parseRctText(values.last_post_msg)]}</div>','<tpl else>'+'<div class="displayMsg">&nbsp;</div>','</tpl>','<tpl elseif="values.type == ChatType.News">','<div class="displayMsg">{[ParseUtil.parseRctText(values.last_post_msg)]}</div>','</tpl>','</div>','</div>'].join(''),listeners:{listoptiontap:{fn:'onRctActions'}},items:[]});Ext.define('IMMobile.view.IMMobileMain.component.UserSelectView',{extend:'Ext.dataview.NestedList',xtype:'userselectview',requires:['Ext.dataview.NestedList','IMMobile.view.details.memDetail'],controller:'userselectcontroller',userCls:'mobileNestList userSelect',flex:1,config:{stype:'A'},displayField:'text',useTitleAsBackText:!1,updateTitleText:!0,allowDeselect:!0,emptyText:'无数据',backText:'',backButton:{ui:'back',docked:'left',iconCls:'far fa-angle-left',cls:'back-button'},title:'选择联系人',toolbar:{userCls:'topinset',titleAlign:'left'},clearSelectionOnListChange:!0,selectedData:{},viewModel:{data:{selectedData:{},searchBtnIsHidden:!0,neededList:{}},formulas:{dataLength:function(b){var a=b('selectedData');return Object.getOwnPropertyNames(a).length}}},listConfig:{items:[{xtype:'container',docked:'top',cls:'standard-search',bind:{hidden:'{searchBtnIsHidden}'},items:[{xtype:'button',itemId:'chatsearch',ui:'flat',text:'搜索',iconCls:'x-fa fa-search',iconAlign:'left',textAlign:'center',width:'100%',handler:'toUserSelectSearch'}]},{xtype:'baseBackcolor',docked:'top',bind:{hidden:'{searchBtnIsHidden}'},items:[{xtype:'arrButton',text:'创建新会话',style:'color: #0d1114;',iconCls:'fa-angle-right',handler:'createNewChatForTransfer'}]},{xtype:'container',docked:'top',bind:{hidden:'{searchBtnIsHidden}'},html:'最近会话',padding:'5px 11px',style:'background-color:#f5f5f5;'}],itemTpl:['<tpl if="values.user_id">','<div class="im-mobile {[values.isDefault == "Y" ? "im-mobile-selected" : "icon-select"]} {[values.checked ? "selectedMan" : ""]}"></div>','<div class="nested-org">','<image class="nested-user-avatar sel-list" src="{[ImgUtil.onePxImg]}" onload="AvatarMgr.loadAvt2(this,0);" data-type="{dataType}" data-user="{avaID}" width="30" height="30" data-time="{create_at}" data-id="{id}">','<div class="name">{text}</div>','</div>','<tpl else>','<div class="icon-group im-mobile group {[values.checked ? "selectedGroup" : ""]}"></div>','<div class="nested-org">','<div class="fa org-icon im-mobile-organization"></div>','<div class="name">{text}</div>','<span class="fa fa-angle-right" style="line-height:38px;position: absolute;"></span></div>','</tpl>'].join(''),selectable:'multi'},items:[{xtype:'container',docked:'bottom',style:'background-color: #fff',cls:'bottominset',items:[{xtype:'container',height:50,width:'100%',layout:'hbox',cls:'btnSure-ct',itemId:'ctSelected',scrollable:{x:!0,y:!1},items:[{xtype:'button',itemId:'btnEnter',docked:'right',width:100,cls:'btnSure',bind:{text:'确定{dataLength?"("+dataLength+")":""}',disabled:'{dataLength == 0}'},handler:'onCreateChat'}]}]}],listeners:{leafchildtap:{fn:function(g,d,e){var c=this;var a=Ext.apply({},this.getViewModel().getData().selectedData);var h=a[d.record.data.user_id];var b=d.record;var i=c.getActiveItem(),f=i.itemFromRecord(b);if(h==undefined){if(g&&g.config.singleSelect&&Object.keys(a)&&Object.keys(a).length>0){return}if(e!=!1){c.changeSameUid(b,!0)}c.addSelectDiv(a,b);if(f){var j=f.el.dom.getElementsByClassName('icon-select')[0];j.classList.add('selectedMan')}}else {if(e==!0){return}c.removeSelectDiv(b)}}},listchange:function(c,a){var b=Ext.apply({},this.getViewModel().getData().selectedData);$.each(b,function(d,e){var b=a.store.getById('U_'+d);if(b){a.select(b,!0)}})}},addSelectDiv:function(b,a){var f=this,e=this.down('#ctSelected');b[a.data.user_id]=a.data.user_name;var d='<div class="nested-org"><img class="nested-user-avatar" src="'+ImgUtil.onePxImg+'" onload="AvatarMgr.loadAvt2(this,0);" data-type="'+a.data.dataType+'"  data-user="'+a.data.avaID+'" data-time="'+a.data.create_at+'" width="30" height="30"></div>';var c=Ext.create('Ext.Component',{html:d,itemId:a.data.user_id});c.element.on('tap',function(c){f.removeSelectDiv(a)});e.add(c);this.getViewModel().setData({selectedData:b})},removeSelectDiv:function(a){var e=this.down('#ctSelected');var d=e.down('#'+a.data.user_id);if(d){var b=Ext.apply({},this.getViewModel().getData().selectedData);e.remove(d);if(!a.data.waitForCreate){this.groupChange(a);this.changeSameUid(a,!1);var g=this.getActiveItem(),c=g.itemFromRecord(a);if(c){var h=c.el.dom.getElementsByClassName('icon-select')[0];h.classList.remove('selectedMan')}}else {var f=Ext.apply({},this.getViewModel().getData().neededList);delete this.neededList[a.data.user_id];this.getViewModel().setData({neededList:f})}delete b[a.data.user_id];this.getViewModel().setData({selectedData:b})}},initialize:function(){var a=this,d=a.getViewModel();a.callParent(arguments);var e=this.getToolbar();var f=a.getBackButton();a.updateBackText('返回');Ext.Toolbar.prototype.doInsert.call(e,0,f);var b;if(a.config.stype=='A'||a.config.stype=='B'||a.config.stype=='F'){if(!User.hasInitOrg){OrgDataHepler.initOrg(function(){a.createOrg()})}else {a.createOrg()}}else {if(a.config.stype=='C'){a.setTitle('选择会话');b=a.onCreateChatTree();var c=Ext.create('Ext.data.TreeStore',{root:b,fields:['text']});this.setStore(c);d.setData({searchBtnIsHidden:!1})}else {if(a.config.stype=='D'){a.setTitle('选择@成员');a.onCreateATUserTree(function(c){var b=Ext.create('Ext.data.TreeStore',{root:c,fields:['text']});a.setStore(b)})}else {if(a.config.stype=='E'){a.setTitle('选择会话');b=a.onCreateChatTree();var c=Ext.create('Ext.data.TreeStore',{root:b,fields:['text']});this.setStore(c);d.setData({searchBtnIsHidden:!1})}}}}},syncToolbar:function(h){var a=this,d=a.getDetailCard(),b=a.getLastNode(),g=h||d&&a.getActiveItem()==d,e=g?b:b.parentNode,c=a.getBackButton();if(c){var i=a.getToolbar(),f=i.getInitialConfig('splitNavigation');if(f){a.$backButtonContainer[e?'show':'hide']()}c['show']();if(e&&a.getUseTitleAsBackText()){c.setText(a.renderTitleText(b.parentNode,!0))}}if(b){a.setToolbarTitle(a.renderTitleText(b))}},doBack:function(a,c,d,g){var a=this;var f=a.getLayout(),e=f?f.getAnimation():null;if(g&&d){if(e){e.setReverse(!0)}a.setActiveItem(d);a.setLastNode(c.parentNode);a.syncToolbar()}else {if(c.parentNode){a.goToNode(c.parentNode)}else {var b=Ext.Viewport.lookup('IMMobile'),i=b.innerItems,h=i.length;b.layout.setAnimation({type:'reveal',direction:'right',duration:250});b.setActiveItemIndex(h-2);b.timer=setTimeout(function(){var e=b.pop();b.layout.setAnimation({type:'cover',direction:'left',duration:250});if(a.config.stype=='D'&&e.xtype=='chatview'){e.down('#IMMobile-Editor').afterSelectATUser([])}},300)}}},onChildTap:function(d,a){var b=this,e=b.hasListeners,c=a.record;if(c.data.isDefault){return !1}if(b.onChildInteraction(d,a)===!1){return !1}if(e.childtap){a.list=d;b.fireEvent('childtap',b,a)}if(e.itemtap){b.fireEvent('itemtap',b,d,a.viewIndex,a.child,c,a.event)}if(c.isLeaf()){if(e.leafchildtap){a.list=d;b.fireEvent('leafchildtap',b,a)}if(e.leafitemtap){b.fireEvent('leafitemtap',b,d,a.viewIndex,a.child,c,a.event)}b.goToLeaf(c)}else {var f=Ext.fly(a.event.target);if(f.is('.group')){b.selectGroup(b,a);return !0}this.goToNode(c);return !1}},selectGroup:function(e,a,d){var f=this,h=e.getStore(),k=Ext.apply({},this.getViewModel().getData().selectedData),g=a.record,i=g.data.checked,b=g.data.children,l=f.down('#ctSelected');if(!i){if(!d){d=!0}g.set('checked',!0);if(!b||b.length<1){return}for(var c=0;c<b.length;c++){var a={};if(b[c].id.indexOf('O')>-1){a.record=h.byIdMap[b[c].id];f.selectGroup(e,a,d);continue}if(b[c].isDefault!='Y'){var j=b[c].parentId.replace(/O_/,'');a.record=h.byIdMap['U_'+j+'_'+b[c].user_id];if(!a||!a.record){debugger}f.fireEvent('leafchildtap',e,a,d)}}}else {if(d==!0){return}f.celSelectGroup(e,a,!1)}},celSelectGroup:function(f,b,d){var e=this,h=f.getStore(),j=Ext.apply({},this.getViewModel().getData().selectedData),g=b.record,a=g.data.children,k=e.down('#ctSelected');if(!d){d=!1}g.set('checked',!1);if(!a||a.length<1){return}for(var c=0;c<a.length;c++){var b={};if(a[c].id.indexOf('O')>-1){b.record=h.byIdMap[a[c].id];e.celSelectGroup(f,b,d);continue}if(a[c].isDefault!='Y'){var i=a[c].parentId.replace(/O_/,'');b.record=h.byIdMap['U_'+i+'_'+a[c].user_id];e.fireEvent('leafchildtap',f,b,d);e.removeSelectDiv(b.record)}}},groupChange:function(b){var c=this;if(b.data.leaf){if(!b.data.org_ids){return}var e=b.data.org_ids.split(','),f=c.getStore().byIdMap;for(var d=0;d<e.length;d++){var a=f['O_'+e[d]];if(a){a.set('checked',!1);c.groupChange(b.parentNode)}}}else {var a=b.parentNode;if(a.data.parent_id.toLowerCase()!='root'){a.set('checked',!1);c.groupChange(a)}}},changeSameUid:function(a,f){var e=a.data.user_id,d=User.userInfos[e];if(!d){return}var c=d.org_ids.split(','),g=this.getStore().byIdMap;for(var b=0;b<c.length;b++){var a=g['U_'+c[b]+'_'+e];if(a){a.set('checked',f)}}},createOrg:function(){var a=this,c=ConfigMgr.isAio8()?a.getOrgDataForAio8(User.allUsers,User.organization):a.getOrgDataForAio75(User.allUsers,User.organization);var b=Ext.create('Ext.data.TreeStore',{root:c,fields:['text'],sorters:[{property:'id',direction:'ASC'}]});a.setStore(b)},getOrgDataForAio75:function(a,b){return this.imitateOrgData(a,b)},getOrgDataForAio8:function(h,i){var c=this;var e=c.addUser2OrgForAio8(i,h);var f=c.createRoot(e);var a;for(var d=0;d<f.length;d++){var g=c.addOrg(f[d],e);if(User.crtCorpID==g.corp_id){a=g}}if(a){if(!ConfigMgr.showOrgRoot()){if(a.children){for(var b=0;b<a.children.length;b++){if(a.children[b].leaf){a.children.splice(b,1);b--}}}}}return a||{}},imitateOrgData:function(j,e){var l=this;var f=[];var i=[];var k=this.config.members||[];var c;for(var d=0;d<e.length;d++){var b={id:e[d].org_id,text:e[d].org_name,iconCls:'x-fa fa-folder'};Ext.apply(b,e[d]);if(b.parent_id.toLowerCase()=='root'||b.parent_id==''){c=b;if(!c.children){c.children=[]}}if((b.parent_id.toLowerCase()=='root'||b.parent_id=='')&&ConfigMgr.showOrgRoot()||!(b.parent_id.toLowerCase()=='root'||b.parent_id=='')){for(var g=0;g<j.length;g++){var a={};Ext.apply(a,j[g]);f=a.org_ids.split(',');for(var h=0;h<f.length;h++){if(f[h]==b.org_id){a.text=a.user_name;a.leaf=!0;a.id='U_'+b.org_id+'_'+a.user_id;a.dataType='D';a.avaID=a.user_id;if(a.user_id==User.ownerID||k.indexOf(a.user_id)>-1){a.isDefault='Y'}if(!b.children){b.children=[]}b.children.push(a)}}}}i.push(b)}l.createItems(c,i);return c},createItems:function(c,a){var d=this;for(var b=0;b<a.length;b++){if(c.org_id==a[b].parent_id){a[b].text=a[b].org_name;if(!c.children){c.children=[]}a[b].id='O_'+a[b].org_id;c.children.push(a[b]);d.createItems(a[b],a)}}},addUser2OrgForAio8:function(c,b){var i=this.config.members||[];for(var d=0;d<c.length;d++){c[d].children=[];for(var a=0;a<b.length;a++){var h=b[a].roles;for(var g=0;g<h.length;g++){var f=h[g];if(f.org_id==c[d].org_id&&f.corp_id==c[d].corp_id){var e=Ext.apply({text:b[a].user_name,leaf:!0,orgtype:'U',id:'U_'+f.org_id+'_'+b[a].user_id,dataType:'D',avaID:b[a].user_id},b[a]);if(e.user_id==User.ownerID||i.indexOf(e.user_id)>-1){e.isDefault='Y'}c[d].children.push(e);break}}}}return c},createRoot:function(b){var c=[];for(var a=0;a<b.length;a++){if(b[a].parent_id===''&&b[a].org_id===''){continue}if(b[a].parent_id.toLowerCase()==='root'||b[a].parent_id===''){var d={id:'O_'+b[a].org_id,name:b[a].org_name,text:b[a].org_name,leaf:!1,parent_id:b[a].parent_id,org_id:b[a].org_id,corp_id:b[a].corp_id,children:b[a].children};c.push(d)}}return c},addOrg:function(c,a){for(var b=0;b<a.length;b++){if(a[b].parent_id==c.org_id&&a[b].corp_id==c.corp_id){c.children.push({id:'O_'+a[b].org_id,name:a[b].org_name,text:a[b].org_name,leaf:!1,parent_id:a[b].parent_id,org_id:a[b].org_id,corp_id:a[b].corp_id,children:a[b].children});this.addOrg(a[b],a)}}return c},onCreateChatTree:function(){var c=this;var b=Ext.getStore('comRct');var a={id:'Root',text:'最近会话',org_id:'Root',children:[]};b.each(function(d,e){if(c.config.chatid!=d.data.chat_id&&d.data.chat_id!=StaticChatID.News){var b={};b.text=d.get('name');b.id='U_'+d.data.chat_id;b.user_id=d.data.chat_id;b.avaID=d.data.avaID;b.user_name=d.data.name;b.leaf=!0;b.dataType=d.data.type;b.create_at=d.data.create_at;a.children.push(b)}});return a},onCreateATUserTree:function(h){var k=this;var i=Ext.getStore('comRct');var c={id:'Root',text:'会话成员',org_id:'Root',children:[]};var g=k.config.chatid;var d=i.getById(g);if(d){var f=d.get('members');for(var e=0;e<f.length;e++){var b=f[e];if(b.user_id!=User.ownerID){var a={};a.text=b.user_name;a.id='U_'+b.user_id;a.user_id=b.user_id;a.avaID=b.user_id;a.user_name=b.user_name;a.leaf=!0;a.dataType='U';c.children.push(a)}}var j=d.get('type');LocalDataMgr.isAdminInChat(g,User.ownerID,j,function(e){if(e){var b='all_user',d='所有人';var a={};a.text=d;a.id='U_'+b;a.user_id=b;a.avaID=b;a.user_name=d;a.leaf=!0;a.dataType='at';c.children.push(a);h(c)}else {h(c)}})}},receiveData:function(e,f){var b=this,j=Ext.apply({},b.getViewModel().getData().selectedData),d=Ext.apply({},b.getViewModel().getData().neededList),c=e.data;var l=Ext.query('.sel-list');var k={},a={},h,g;if(e.data.ChatType==ChatType.Multi){h=c.ChatID;a.data={dataType:e.data.ChatType,avaID:c.ChatID,create_at:c.CreateAt,user_id:c.ChatID,user_name:c.DisplayName}}else {h=c.UserID;a.data={dataType:'D',avaID:c.UserID,user_name:c.UserName}}for(var i=0;i<l.length;i++){var m=l[i];var n=m.getAttribute('data-user');if(n==h){g=m.getAttribute('data-id');break}}if(g){k.record=b.getStore().byIdMap[g];b.fireEvent('leafchildtap',b,k);if(f){f()}}else {if(e.data.ChatType==ChatType.Multi){a.data.waitForCreate=!0;b.addSelectDiv(j,a);d[a.data.user_id]=a.data;b.getViewModel().setData({neededList:d})}else {Utils.custAjax('post','chats/direct',{params:JSON.stringify([User.ownerID,a.data.avaID]),success:function(c){a.data.waitForCreate=!0;a.data.create_at=c.create_at;a.data.user_id=c.chat_id;b.addSelectDiv(j,a);d[a.data.user_id]=a.data;b.getViewModel().setData({neededList:d});if(f){f()}},failure:function(a){console.log(a)}})}}}});Ext.define('IMMobile.view.group.OrgSelMems',{extend:'Ext.Container',xtype:'IMMobile-orgSelMems',requires:['IMMobile.view.widget.Navbar'],items:[{xtype:'IMMobile-Navbar'},{html:'org'}]});Ext.define('IMMobile.view.component.UserSelectController',{extend:'Ext.app.ViewController',alias:'controller.userselectcontroller',requires:['IMMobile.view.group.OrgSelMems','IMCommon.utils.ChatUtil'],onCreateChat:function(){var a=this;var b=a.getView();if(b.config.stype=='A'){Ext.Msg.show({title:'系统提示',message:'确定要发起多人会话吗?',buttons:Ext.MessageBox.OKCANCEL,defaultFoucs:'#ok',prompt:!1,cls:'centered-dialog',fn:function(b){if(b=='ok'){a.doCreateChat()}}})}else {if(b.config.stype=='B'){a.doAddMembers()}else {if(b.config.stype=='C'){a.doMessageTrans()}else {if(b.config.stype=='D'){a.doUserAT()}else {if(b.config.stype=='E'){a.doShareFile()}else {if(b.config.stype=='F'){a.selectUsers()}}}}}}},doCreateChat:function(){var k=this;var c=k.getView();var o=c.getViewModel();var b=o.getData().selectedData;var e=Object.getOwnPropertyNames(b);var n=e.length;var f=c.config.members||[];var a=[];var l=c.config.forTransfer;if(n>0){$.each(b,function(b){a.push(b)})}if(f.length>0){for(var g=0;g<f.length;g++){var j=f[g];if(j!=User.ownerID){a.push(j)}}}if(l&&a.length==1){var h=Ext.Viewport.lookup('IMMobile'),m=c.config.fromItemId;var d=h.down('#'+m);var i={};i.data={ChatType:'D',UserID:a[0],UserName:b[a[0]]};h.pop();d.getViewModel().setData({selectedData:{}});d.receiveData(i,function(){d.getController().onCreateChat()})}else {if(a.length==1){User.crtChatName=b[e[0]];User.chatMemID=e[0];User.lastChatId=User.chatMemID;User.crtChannelType='D';Redirect.redirectTo('chatview')}else {ChatUtil.createGrpChat(a,k.createChatSuccess)}}},doMessageTrans:function(){var b=this;var a=b.getView();var e=a.getViewModel();var c=e.getData().selectedData;var d=a.config.msgid;b.beforetransfer(function(){$.each(c,function(a){SendUtil.beforeSend(a).then(function(){ChatUtil.doTransmit(d,[a],function(c){var e=Ext.getStore('comRct');for(var b=0;b<c.length;b++){var d=e.getById(c[b].chat_id);if(d){d.set({last_post_at:new Date(c[b].create_at),last_post_id:User.ownerID,last_post_name:User.crtUser.user_name,last_msg_type:c[b].msg_type,last_post_msg:c[b].message})}}})})});MobileHelper.getChatType(a.config.chatid);Redirect.redirectTo('chatview',{chatid:a.config.chatid})})},doShareFile:function(){var f=this;var b=f.getView();var h=b.getViewModel();var g=h.getData().selectedData;var c=[],e=[];var a=Ext.Viewport.lookup('IMMobile');$.each(g,function(a){c.push(a)});if(c.length>0){f.beforetransfer(function(){if(b.config.url){FileMgr.getFileSize(b.config.url).then(function(d){e.push({path:b.config.url,size:d,type:MsgType.FileMsg});c.forEach(function(b){SendUtil.beforeSend(b).then(function(){if(ConfigMgr.canUpload(d)){SendUtil.sendMsgsByOneAPI(b,e,[],function(f){if(User.crtChannelId==b){var c=a.down('msgview'),e=a.down('IMMobile-Editor');return e.bindLocal(c,c.getStore(),f)}else {return !1}})}})});a.pop()})['catch'](function(a){console.log('getFileSize--err',a)})}else {if(b.config.files){var d=b.config.files;c.forEach(function(b){SendUtil.beforeSend(b).then(function(){SendUtil.sendMsgsByOneAPI(b,d,[],function(e){if(User.crtChannelId==b){var c=a.down('msgview'),d=a.down('IMMobile-Editor');return d.bindLocal(c,c.getStore(),e)}else {return !1}})})});a.pop()}}})}var d=a.down('filetpl');if(d){d.resetState()}},createChatSuccess:function(a){var c=Ext.Viewport.lookup('IMMobile');var f=c.getActiveItem(),d=f.config.forTransfer,h=f.config.fromItemId;if(!d){User.crtChannelId=a.chat.chat_id;User.crtChatName=a.chat.header}var i=Ext.getStore('comRct').getById(a.chat_id);if(!i){Ext.getStore('comRct').insert(0,{chat_id:a.chat.chat_id,name:a.chat.header,type:a.chat.chat_type,last_post_at:ParseUtil.getLocalTime(),create_at:a.chat.create_at,chat_name:a.chat.chat_name,members:a.chat.members,avaID:a.chat.chat_id,manager_id:a.chat.manager_id,last_msg_type:'G'})}LocalDataMgr.createGrpChat(a.chat,a.messages);c.pop();if(!d){MobileHelper.getChatType(a.chat.chat_id);Redirect.redirectTo('chatview',{chatid:a.chat.chat_id})}else {var e=c.down('#'+h),g=e.getViewModel(),b=g.getData().selectedData;b={};b[a.chat.chat_id]=a.chat.header;g.setData({selectedData:b});e.getController().onCreateChat()}},reDirectToChatView:function(){Redirect.redirectTo('chatview')},doAddMembers:function(){var f=this;var a=f.getView();var g=a.getViewModel();var c=g.getData().selectedData;var d=Object.getOwnPropertyNames(c);var b=[];var e=d.length;if(e==1){b.push(d[0])}else {$.each(c,function(a,c){b.push(a)})}Utils.custAjax('post','chats/'+a.config.chatid+'/members',{params:Ext.encode(b),success:function(e){var c=e.chat,g=e.messages;var f=GroupNotice.cMeAddMems(b,c.members);LocalDataMgr.addMemToGroup(c,f,g);var d=Ext.getStore('comRct').getById(c.chat_id);if(d){d.set({name:c.header,chat_name:c.chat_name,members:c.members,create_at:c.create_at,avaHash:c.avatar_hash,last_msg_type:MsgType.GroupNotice,last_post_msg:f,last_post_at:new Date(c.update_at),avaLoaded:!0})}MobileHelper.getChatType(a.config.chatid);Redirect.redirectTo('chatview',{chatid:a.config.chatid});var h=Ext.getStore('comRct').getById(a.config.chatid);User.needUpdateChatAva(a.config.chatid,c.create_at,c.avatar_hash,function(f){var b=Ext.Viewport.down('rctchatlist').mapToItem(h),c=b.el.query('img'),a=c[0],d=a.src;AvatarMgr.setUrl(a,d)})},failure:function(a){Utils.toastLong(a)}})},onRemoveGrpMem:function(g,e){var h=g.getStore(),b=e.record;var f=b.data.user_id,d=this.getView().down('groupedList').getStore(),c=d.getById(f);c.set('selList',!1);var a=this.getViewModel();a.set('personNum',a.get('personNum')-1);b.set('selected',!1)},createItems:function(){var c=this,b=this.getView();var a=Ext.create('Ext.data.TreeStore',{root:User.orgStoreRoot,sorters:[{property:'org_id',direction:'ASC'},{property:'user_id',direction:'ASC'}],fields:['text','id','selected','org_id','user_id']});b.down('#grpSelList').setStore(a)},onChildTap:function(d,a,e){var f=this,c=this.getView(),b=c.getViewModel();if(a.node.isLeaf()){if(a.node.data.user_id==User.ownerID){return}if(a.item.getIconCls()){a.item.setIconCls('');b.setData({personNum:b.getData().personNum-1});a.node.data.selected='N'}else {a.item.setIconCls('x-fa fa-check-circle green');b.setData({personNum:b.getData().personNum+1});a.node.data.selected='Y'}}},doUserAT:function(){var f=this;var d=f.getView();var g=d.getViewModel();var c=g.getData().selectedData;var a=[];$.each(c,function(c,b){a.push([c,b])});var e=Ext.Viewport.lookup('IMMobile');var b=e.pop();if(b.xtype=='chatview'){b.down('#IMMobile-Editor').afterSelectATUser(a)}},toUserSelectSearch:function(){var a=this,b=a.getView();Ext.Viewport.down('IMMobile').layout.setAnimation({type:null});Redirect.redirectTo('chatsearch',{enterType:'B'});if(Ext.os.is.iOS){$('input').focus()}},beforetransfer:function(d){var e=this,f=e.getView(),a=f.getViewModel().getData().neededList;var b=[];if(Object.keys(a).length>0){for(var c in a){if(a.hasOwnProperty(c)){b.push(c)}}ParseUtil.queueExec(e.getData,b,d)}else {d()}},getData:function(a){return new Promise(function(b,c){Utils.custAjax('get','users/me/chats/'+a,{success:function(d){var e=d.header,f=d.chat_id;if(d.chat_type==ChatType.Direct){e=ParseUtil.getDctNameFromMems(d.members);f=d.chat_name.split('__')[0]==User.ownerID?d.chat_name.split('__')[1]:d.chat_name.split('__')[0]}d.displayname=e;d.ava=f;Ext.getStore('comRct').add({chat_id:d.chat_id,name:e,type:d.chat_type,last_msg_type:'T',last_post_at:new Date(d.last_post_at),last_post_msg:'',chat_name:d.chat_name,members:d.members,create_at:d.create_at,avaID:f,manager_id:d.manager_id,IsMute:d.is_mute});LocalDataMgr.asyncChatAndRct(d);b()},failure:function(){console.log(a+'getCidERR');c()}})})},createNewChatForTransfer:function(){var c=this,b=c.getView(),a=b.getItemId();Redirect.redirectTo('userselectview',{stype:'A',forTransfer:!0,fromItemId:a})},selectUsers:function(){var g=this;var e=g.getView();var h=e.getViewModel();var d=h.getData().selectedData;var a=[];$.each(d,function(b){a.push({UserID:b,UserName:d[b]})});var f=Ext.Viewport.lookup('IMMobile');var c=f.pop();if(c.isXType('operationsview')){if(c.lookup('listuser')){for(var b=0;b<a.length;b++){a[b].canDel=!0;a[b].UserSource='流程:手选';c.lookup('listuser').getStore().add(a[b])}}}}});Ext.define('IMMobile.view.group.GroupSelListController',{extend:'Ext.app.ViewController',alias:'controller.groupsellistcontroller',requires:['IMMobile.view.group.OrgSelMems','IMCommon.utils.ChatUtil'],onShowOrgMems:function(){Redirect.redirectTo('IMMobile-orgSelMems')},onCreateChat:function(){var a=this;Ext.Msg.show({title:'系统提示',message:'确定要发起多人会话吗?',buttons:Ext.MessageBox.OKCANCEL,defaultFoucs:'#ok',prompt:!1,cls:'centered-dialog',fn:function(b){if(b=='ok'){a.doCreateChat()}}})},doCreateChat:function(){var d=this;var f=d.getView();var e=f.down('#grpSelList').getStore();var a=e.query('selected','Y');if(a.length==1){User.crtChatName=a.items[0].getData().user_name;User.chatMemID=a.items[0].getData().user_id;User.lastChatId=User.chatMemID;User.crtChannelType='D';Redirect.redirectTo('chatview')}else {if(a.length>1){var c=[];for(var b=0;b<a.items.length;b++){c.push(a.items[b].getData().user_id)}ChatUtil.createGrpChat(c,d.createChatSuccess)}}},createChatSuccess:function(a){User.crtChannelId=a.chat.chat_id;User.crtChatName=a.chat.header;var c=Ext.getStore('comRct').getById(a.chat_id);if(!c){Ext.getStore('comRct').insert(0,{chat_id:a.chat.chat_id,name:a.chat.header,type:a.chat.chat_type,last_post_at:ParseUtil.getLocalTime(),create_at:a.chat.create_at,chat_name:a.chat.chat_name,members:a.chat.members,avaID:a.chat.chat_id,manager_id:a.chat.manager_id})}LocalDataMgr.createGrpChat(a.chat,a.messages);var b=Ext.Viewport.lookup('IMMobile');b.pop();MobileHelper.getChatType(a.chat.chat_id);Redirect.redirectTo('chatview',{chatid:a.chat.chat_id})},reDirectToChatView:function(){Redirect.redirectTo('chatview')},onRemoveGrpMem:function(g,e){var h=g.getStore(),b=e.record;var f=b.data.user_id,d=this.getView().down('groupedList').getStore(),c=d.getById(f);c.set('selList',!1);var a=this.getViewModel();a.set('personNum',a.get('personNum')-1);b.set('selected',!1)},createItems:function(){var c=this,b=this.getView();var a=Ext.create('Ext.data.TreeStore',{root:User.orgStoreRoot,sorters:[{property:'org_id',direction:'ASC'},{property:'user_id',direction:'ASC'}],fields:['text','id','selected','org_id','user_id']});b.down('#grpSelList').setStore(a)},onChildTap:function(d,a,e){var f=this,c=this.getView(),b=c.getViewModel();if(a.node.isLeaf()){if(a.node.data.user_id==User.ownerID){return}if(a.item.getIconCls()){a.item.setIconCls('');b.setData({personNum:b.getData().personNum-1});a.node.data.selected='N'}else {a.item.setIconCls('x-fa fa-check-circle green');b.setData({personNum:b.getData().personNum+1});a.node.data.selected='Y'}}}});Ext.define('IMMobile.view.group.GroupSelList',{extend:'IMMobile.view.base.Container',xtype:'IMMobile-grpSelList',requires:['IMCommon.utils.AvatarUtil','IMMobile.view.widget.Navbar','IMCommon.view.list.GroupedList','IMMobile.view.group.GroupSelListController','IMCommon.model.PersonList','IMMobile.view.base.Container'],controller:'groupsellistcontroller',userCls:'group-sel',viewModel:{data:{personNum:0},stores:{}},layout:'vbox',items:[{xtype:'IMMobile-Navbar',title:'创建多人会话'},{xtype:'treelist',style:'background-color:#fff;',itemId:'grpSelList',expanderOnly:!1,scrollable:'y',rootVisible:!1,flex:1,columns:[{xtype:'treecolumn',text:'Name',dataIndex:'text',flex:1},{xtype:'column',width:40,text:'selected',dataIndex:'selected',align:'center',renderer:function(a,b){if(a=='Y'){return '<span class="x-fa fa-check-circle green"></span>'}return ''}}],listeners:{itemclick:{fn:'onChildTap'}}},{xtype:'button',docked:'bottom',ui:'action',bind:{text:'立即创建{personNum?"("+personNum+")":""}',disabled:'{personNum == 0}'},handler:'onCreateChat'}],initialize:function(){var a=this;a.callParent(arguments);a.controller.createItems()},onSelMem:function(g,f){var c=f.record;if(c){var a=c.data;var e=this;var b=e.getViewModel();var d=e.down('#grpMems').getStore();if(a.selList){d.add({user_id:a.user_id,user_name:a.user_name,selList:a.selList});b.set('personNum',b.get('personNum')+1)}else {c=d.getById(a.user_id);d.remove(c);b.set('personNum',b.get('personNum')-1)}}}});Ext.define('IMMobile.view.widget.BrowserComponent',{extend:'Ext.Container',xtype:'imbrowser',viewModel:{data:{title:'wait...',htmlUrl:''}},classCls:'im-browser',style:'background:#f2f3f5',items:[{xtype:'IMMobile-Navbar',itemId:'chatViewNav',userCls:'hasRightButton',bind:{title:'{title}'},items:[{xtype:'button',width:30,docked:'right'}]},{userCls:'browser-iframe',bind:{html:'<div class="container">\n                    <iframe id="content" frameborder="0" class="iframe" src="{htmlUrl}" name="content"></iframe>\n                </div>'}}],initialize:function(){var a=this,b=a.getViewModel();a.callParent(arguments);b.set('title',a.config.title);b.set('htmlUrl',a.config.htmlUrl)}});Ext.define('IMMobile.view.widget.Error',{extend:'Ext.Container',xtype:'errPrompt',viewModel:{},style:'background:#f2f3f5',items:[{xtype:'IMMobile-Navbar',title:' '},{bind:{html:'<div style="text-align: center;margin-top: 40%;font-size: 17px;display: flex;flex-wrap: wrap;">\n                <div style="width:100%;font-weight: 600;">抱歉，无法识别当前二维码！</div>\n                <div style="width:100%;margin: 15px;">二维码内容:{text}</div>\n                <div style="width:100%;display: flex;justify-content: center;">\n                <div style="text-align: left;">可能原因：<br>1、二维码已失效<br>2、二维码不存在<br>3、二维码格式aio不支持</div>\n                </div>\n                </div>'}}],initialize:function(){var a=this,b=a.getViewModel();a.callParent(arguments);b.set('text',a.config.text)}});Ext.define(null,{override:'Ext.panel.Date',getCustomParentController:function(){var c=this.customParent,b=this.up(c),a;if(b){a=b.getController()}return a},onOkButtonClick:function(){var b=this,a=b.getCustomParentController();this.setValue(this.getFocusableDate());if(a&&a.onOkButtonClick){a.onOkButtonClick(b.getFocusableDate())}},onCancelButtonClick:function(){var b=this,a=b.getCustomParentController();if(a&&a.onCancelButtonClick){a.onCancelButtonClick()}}});Ext.define('IMMobile.view.widget.MobileNotice',{extend:'Ext.Container',xtype:'mobile-notice',top:'14vh',left:0,config:{title:null,content:null,sender:null},referenceHolder:!0,showAnimation:'fade',cls:'mobile-notice',hidden:!0,items:[{xtype:'container',reference:'showView',tpl:'<div class="title">{title}</div>\n        <div class="content">\n        <tpl if="values.sender">\n        <span>{sender} : </span>\n        </tpl>\n        {content}\n        </div>\n        '}],updateContent:function(b){var e=Ext.Viewport.down('IMMobile');var a=this.lookup('showView'),c=this.getSender(),d=this.getTitle();a.setData({title:d,sender:c,content:b});if(e._activeItem._activeItem.xtype!='IMMobile-WorkDesk'){this.show()}else {this.hide()}},initialize:function(){var a=this;a.callParent(arguments);a.bodyElement.on({scope:a,touchend:'onTap',hide:'afterHide',destroy:'onClear'});a.afterHide()},onTap:function(){this.destroy()},afterHide:function(){var a=this;this.timer=setTimeout(function(){a.destroy()},3000)},onClear:function(){clearTimeout(this.timer)}});Ext.define('IMMobile.view.widget.PullLoadData',{extend:'Ext.Container',xtype:'pullloaddata',cls:'pull-load',config:{list:'',state:'pulling'},items:[{xtype:'img',src:Ext.getResourcePath('images/loading2.gif',null,'IMMobile'),width:20,height:20}],initialize:function(){var a=this;a.callParent(arguments);a.on({destroy:function(){clearTimeout(a.timer)},scope:a})},updateList:function(a){var b=this;if(!a){return}a.el.on({dragstart:'onDragStart',scope:b})},onDragStart:function(d){var b=this,e=b.el.dom.style,a=this.getList(),c=a.getScrollable().getScrollElement().dom.scrollTop;if(c<=0&&d.deltaY>0&&this.getState()=='pulling'){this.setState('holding');a.el.dom.style.paddingTop='20px';a.el.on({dragend:'onDragEnd',scope:b})}},onDragEnd:function(b){var c=this;var a=this.getList();if(b.deltaY>50&&this.getState()=='holding'){this.setState('loading');this.timer=setTimeout(function(){a.onPullRefresh2()},1000)}else {this.setState('loaded')}a.el.un({dragend:'onDragEnd',scope:this})},updateState:function(b){var d=this,a=this.getList(),c=d.down('img');if(b=='holding'||b=='loading'){c.show()}else {if(b=='loaded'){if(a){a.el.dom.style.paddingTop='0px'}if(a.getScrollable()&&a.getScrollable().getPosition().y>0){a.getScrollable().scrollBy(0,-20)}d.setState('pulling')}else {c.hide()}}},stopDefaultTouch:function(a){a.preventDefault();console.log('preventDefault')}});Ext.define('IMMobile.view.widget.SearchTitleBar',{extend:'Ext.Container',xtype:'searchtitlebar',userCls:'querytitle',config:{backButton:{xtype:'button',itemId:'back',ui:'back',docked:'right',text:'取消'},searchText:{xtype:'textfield',itemId:'txtSearch',align:'center',placeholder:'搜索',triggers:{clear:{iconCls:'im-mobile im-mobile-glass',type:'clear'}}},searchButton:{xtype:'button',itemId:'back',ui:'back',docked:'right',text:'搜索',hidden:!0}},initialize:function(){var a=this;a.callParent(arguments);a.addCls(['navbar','x-titlebar']);a.add([a.getSearchText(),a.getBackButton(),a.getSearchButton()])},focusTxt:function(){this.down('#txtSearch').focus()},clearSearch:function(){var a=this.down('#txtSearch');a.clearValue()}});Ext.define('IMMobile.nestedList',{extend:'Ext.NestedList',xtype:'IMMobile11',requires:['IMMobile.model.ChatOrg'],fullscreen:!0,displayField:'text',constructor:function(a){var b=Ext.create('IMMobile.model.ChatOrg');a=Ext.apply({store:Ext.create('Ext.data.TreeStore',{fields:[{name:'text',type:'string'}],defaultRootProperty:'items',rootVisible:!0,root:{items:[{text:'Groceries',items:[{text:'Drinks',items:[{text:'Water',items:[{text:'Sparkling',leaf:!0},{text:'Still',leaf:!0}]},{text:'Coffee',leaf:!0},{text:'Espresso',leaf:!0},{text:'Redbull',leaf:!0},{text:'Coke',leaf:!0},{text:'Diet Coke',leaf:!0}]},{text:'Fruit',items:[{text:'Bananas',leaf:!0},{text:'Lemon',leaf:!0}]},{text:'Snacks',items:[{text:'Nuts',leaf:!0},{text:'Pretzels',leaf:!0},{text:'Wasabi Peas',leaf:!0}]}]}]}})},a);this.callParent([a])}});