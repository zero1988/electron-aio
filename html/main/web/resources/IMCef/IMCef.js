Ext.define('IMCef.src.MainView',{extend:'Ext.Panel',xtype:'cefMainView',userCls:'cefMainView',tools:[{iconCls:'im-common-close',handler:function(){var b=Utils.getApp().getCefObj();if(b){b.close()}if(window.cefFileMgr){window.cefFileMgr.close()}if(window.cefUserSelector){var a=Ext.getStore('userSel_rctTreeStore');if(a){Ext.destroy(a)}}}}]});Ext.define('IMCef.cefOneChat.cefOneChatController',{extend:'Ext.app.ViewController',alias:'controller.cefOneChatController',requires:['IMCommon.model.Msg','IMCommon.enumType.SocketEventType'],init:function(){this.initListeners()},initPageCache:function(a){if(Ext.isEmpty(a)){return}a=JSON.parse(a);if(Ext.isEmpty(a)){return}var e=a.IsStop;if(e){User.isChatFormStop=!0}this.imitateRctStore();var f=a.OwnerID,b=a.ChatID,c=a.ChatType,d=a.DisplayName;User.ownerID=f;User.crtChannelId=b;User.crtChannelType=c;User.userID=a.UserID;User.crtChatType=c;User.crtChatName=d;User.token=a.Token;User.accountID=a.AccountID;Config.httpUrlForGo=a.HttpUrlForGo;User.allUsers=a.AllUsers;User.userInfos=a.UserInfos;User.crtUser=a.CrtUser;User.IsWholeRest=a.IsWholeRest;User.settings=a.Settings;User.devType=a.DevType;User.allStatus=a.AllStatus;User.createat=a.CreateAt;User.useReceipt=a.useReceipt;ConfigMgr.orgShowRoot=a.showOrgRoot;ConfigMgr.useAio8=a.useAio8;this.doChatHeader(a);DesktopChatUtil.clearCefAtForm(b);this.doHistory(b);this.doCMembers(a);this.handleWS();this.doEditor();this.needUpdateChat(b)},imitateRctStore:function(){var a=Ext.getStore('comRct');if(!a){a=Ext.factory({storeId:'comRct'},Ext.data.Store)}},needUpdateChat:function(b){var a=this;LocalDataMgr.getChatUpTime(b,function(g,e){var c=e.rows,f=c.length;var d=0;if(f>0){d=c.item(0).UpdateAt||0}Utils.custAjax('get','users/me/chats/'+b,{success:function(c,k){if(k!='304'){var d,f='';if(c.iscrowd!='Y'){d=c.chat_type}else {d='C'}if(d==ChatType.Direct){f=ParseUtil.getDctNameFromMems(c.members);var h=ParseUtil.getDitUidByArray(c.members);var j=User.allStatus[h];User.needUpdateUserAva(h,c.avatar_hash,function(){});a.doChatHeader({ChatType:d,DisplayName:f,OnlineStu:j,UserID:h})}else {if(d==ChatType.Multi){f=c.header;User.needUpdateChatAva(c.chat_id,c.create_at,c.avatar_hash,function(){});a.doChatHeader({ChatType:d,DisplayName:f,ManagerID:c.manager_id});var i=a.getGrpDataByRemote(c.members,c.manager_id);a.doCMembers({ChatType:d,GrpStoreMems:i})}}LocalDataMgr.updateRctAndChat(c)}}},!1,'&update_at='+d)})},getGrpDataByRemote:function(c,f){var a,d=[];for(var b=0;b<c.length;b++){a=c[b].user_id;var e=DesktopChatUtil.parseGrpListCls(a);d.push({user_id:a,user_name:c[b].user_name,isManager:a==f,showMobile:DesktopChatUtil.showMobile(a),resCls:e.cls,isOnline:e.isOnline})}return d},doChatHeader:function(a){var g=this.lookup('desktopMain'),h=g.lookup('desktopCTitle'),b=g.lookup('desktopTTitle'),d=g.getViewModel(),i=a.DisplayName;User.rightTitle=i;d.set({displayname:i});var f=a.ChatType;if(f==ChatType.Direct){Ext.Viewport.down('#addMemsButton').show();Ext.Viewport.down('#crowdNotice2').hide();Ext.Viewport.down('#setCrowd').hide();Ext.ComponentQuery.query('#crowdGroupclick')[0].hide();Ext.ComponentQuery.query('#groupClick')[0].show();b.setHidden(!0);h.setHidden(!1);var c='',e=a.OnlineStu;if(e){var l=e.pc_online,k=e.mobile_online;if(l=='Y'){c='ditChatPC'}else {if(k=='Y'){c='ditChatMobile'}}}var j='';if(a.IsBlock){j='(停用)';c=''}d.set({'sendToID':a.UserID,'sendToName':i,'ditStu':c,'ditInCom':j})}else {if(f==ChatType.Multi){if(a.Status=='2'){Ext.Viewport.down('#addMemsButton').hide();b.setUi('dismiss')}else {Ext.Viewport.down('#addMemsButton').show();b.setUi('')}Ext.Viewport.down('#addMemsButton').show();Ext.Viewport.down('#crowdNotice2').hide();Ext.Viewport.down('#setCrowd').hide();Ext.ComponentQuery.query('#crowdGroupclick')[0].hide();Ext.ComponentQuery.query('#groupClick')[0].show();h.setHidden(!0);b.setHidden(!1);if(a.ManagerID==a.OwnerID&&a.Status!='2'){b.setReadOnly(!1)}else {b.setReadOnly(!0)}}else {if(f=='C'){Ext.Viewport.down('#addMemsButton').hide();Ext.Viewport.down('#crowdNotice2').show();Ext.ComponentQuery.query('#crowdGroupclick')[0].show();Ext.ComponentQuery.query('#groupClick')[0].hide();h.setHidden(!0);b.setHidden(!1);if(a.ManagerID==a.OwnerID){b.setReadOnly(!0)}else {b.setReadOnly(!0)}LocalDataMgr.getCrowdheader(User.crtChannelId,function(f,c){var b=c.rows,e=b.length;if(e>0){d.set({displayname:b.item(0).Header})}Ext.Viewport.down('#btnEdit').setReadOnly(!0)})}}}},doCMembers:function(b){var c=this;var h=b.ChatType,i=this.getView().lookup('desktopMain'),a=i.lookup('desktopChatGrp'),e=a.down('#desktopChat_grpList'),f=e.getStore();switch(h){case ChatType.Multi:a.show();var d=Ext.getStore('rgList');var g=d.getSorters();g.clear();d.setSorters([{property:'isManager',direction:'Desc'},{property:'isadmin',direction:'Desc'}]);f.add(b.GrpStoreMems);break;case ChatType.Direct:a.hide();break;case 'C':a.show();Utils.custAjax('get','chatcs/'+b.ChatID,{success:function(a){User.crtId=a.id;User.CrowdNotice=a.notice;c.isAdmins(a.members,a.manager_id);c.doBindCrowdMems(a);c.setcrowdNotice(a.notice)},failure:function(){}});break;default:break;}},doBindCrowdMems:function(c){var d=this;var a=ParseUtil.getCrowdMembersByLocalIDs(c.members);for(var b=0;b<a.length;b++){if(a[b].user_id==User.ownerID){inGroup=!1;break}}d.doGrpChatRightMems(a,c.manager_id,'C')},doGrpChatRightMems:function(b,e,g){var c=Ext.getStore('rgList');if(g=='C'){var f=c.getSorters();f.clear();c.setSorters([{property:'isManager',direction:'Desc'},{property:'isadmin',direction:'Desc'},{property:'user_id',direction:'ASC'}])}var d=[];for(var a=0;a<b.length;a++){if(b[a].user_id==e){b[a].isManager=!0;d.unshift(b[a])}else {d.push(b[a]);b[a].isManager=!1}}c.removeAll();c.add(d)},setcrowdNotice:function(a){if(a==''||a==null){var b='<div class="null_notice"></div>';Ext.ComponentQuery.query('#crowdNullnotice')[0].show();Ext.ComponentQuery.query('#crowdNotice')[0].hide()}else {Ext.ComponentQuery.query('#crowdNullnotice')[0].hide();Ext.ComponentQuery.query('#crowdNotice')[0].show();Ext.ComponentQuery.query('#crowdNotice')[0].setValue(a)}},isAdmins:function(c,d){var b=!0;for(var a=0;a<c.length;a++){if(c[a].user_id==User.ownerID){if(c[a].is_admin=='Y'||d==User.ownerID){Ext.ComponentQuery.query('#crowdNotice')[0].setReadOnly(!1);Ext.Viewport.down('#setCrowd').show();b=!1}else {Ext.ComponentQuery.query('#crowdNotice')[0].setReadOnly(!0);b=!1}}}if(b){Ext.ComponentQuery.query('#crowdNotice')[0].setReadOnly(!0);Ext.Viewport.down('#setCrowd').hide()}},doHistory:function(b){var e=this,a=Ext.getStore(b);if(!a){a=Ext.factory({storeId:b,model:'IMCommon.model.Msg',sorters:[{property:'updateTime',direction:'ASC'}]},Ext.data.Store);a.on({add:'msgStoreOnAdd',update:'msgStoreOnUpdate',scope:e})}var d=this.getView().lookup('desktopMain'),c=d.lookup('desktopChatList');c.setStore(a);ChatUtil.handleFirstIn(a,b,c)},msgStoreOnAdd:function(h,b,g){if(g>0){var c='';for(var a=0;a<b.length;a++){if(b[a].get('updateTime')){c=b[0]}if(a>0){var d=ParseUtil.msgShowTime(b[a].get('updateTime'),b[a-1].get('updateTime'));if(b[a].get('showTime')!=d){b[a].set({showTime:d})}}}var e=!0;var f=h.getAt(g-1);if(f){if(c){e=ParseUtil.msgShowTime(c.get('updateTime'),f.get('updateTime'))}else {e=!1}}if(c.get('showTime')!=e){c.set({showTime:e})}}else {for(var a=1;a<b.length;a++){var d=ParseUtil.msgShowTime(b[a].get('updateTime'),b[a-1].get('updateTime'));if(b[a].get('showTime')!=d){b[a].set({showTime:d})}}}},msgStoreOnUpdate:function(d,a){var c=d.indexOf(a);var b=!0;if(c>0){b=ParseUtil.msgShowTime(a.get('updateTime'),d.getAt(c-1).get('updateTime'))}if(b!=a.get('showTime')){a.set({showTime:b})}},doEditor:function(){var d=User.settings.send_hot_key;if(!d){return}var a=this.getView().down('#richEditor');if(!a){return}switch(d){case 'Ctrl+Enter':a.setPlaceholder('Ctrl+Enter发送');break;case 'Enter':a.setPlaceholder('Enter发送');break;default:a.setPlaceholder('Ctrl+Enter发送');break;}var e=a.getPicker(),b=a.inputElement.dom,c=function(c){if(c){if(window.cefChat){var b=Utils.getCmp('desktopChatView');if(b){SendUtil.sendMsgWORct(a,User.crtChannelId,b.lookup('desktopChatList'))}}}else {Utils.toastShort('不能发送空白消息')}};$(b).unbind('keydown');$(b).bind('keydown',function(f){if(f.keyCode==13){if(!e.getHidden()){}else {if(d=='Ctrl+Enter'){a.setPlaceholder('Ctrl+Enter发送');if(f.ctrlKey){c(b.value)}else {a._handleEnter(f)}}else {a.setPlaceholder('Enter发送');if(f.ctrlKey){a._handleEnter(f)}else {c(b.value)}}return !1}}if(f.keyCode==83){if(f.altKey){c(b.value);return !1}}if(f.keyCode==67){if(f.ctrlKey){var g=ParseUtil.getSelectedContents();var h=ParseUtil.htmlToText(g);DesktopChatUtil.getCefObj().setCopyPTData(h,g,function(a){if(!a){Utils.toastShort('复制出错了')}});return !1}}})},handleWS:function(){var a=this;window.handleWS=function(b){b=JSON.parse(b);switch(b.event){case SocketEventType.posted:SocketEventUtil.handleNewPostEvent(b,'',a);break;case SocketEventType.memAdd:SocketEventUtil.handleMemAddEvent(b);break;case SocketEventType.memRemove:SocketEventUtil.handleMemRemoveEvent(b);break;case SocketEventType.chgManager:SocketEventUtil.handleMgrChgEvent(b,{callback:function(d){var c=a.lookup('desktopMain').lookup('desktopTTitle');if(d==User.ownerID){c.setReadOnly(!1)}else {c.setReadOnly(!0)}}});break;case SocketEventType.updateChat:SocketEventUtil.handleChgChatHeader(b,{callback:function(d){var e=a.lookup('desktopMain'),c=e.getViewModel();c.set({displayname:d})}});break;case SocketEventType.dismissMultiChat:SocketEventUtil.handleDismissMultiChat(b);break;case SocketEventType.joinERPMultiChat:SocketEventUtil.handleJoinERPMultiChat(b);break;case SocketEventType.recoverMultiChat:SocketEventUtil.handleRecoverMultiChat(b);break;case SocketEventType.getFile:SocketEventUtil.handleGetFile(b,a.getView());break;case SocketEventType.revoke:SocketEventUtil.handleRevokeEvent(b,{callback:function(f,e,c,h){var d=Ext.getStore(f);var g=GroupNotice.getRevokeNotice(c,h);if(!d){return}var a=d.findRecord('msg_id',e);if(a){a.set('msg_type',MsgType.Revoke);a.set('senderID',c);a.set('senderName',User.userInfos[c].user_name);a.set('sendText',g)}if(b.data.msg_type==MsgType.BigFileMsg){DesktopChatUtil.getCefObj().doBFileRevoke(JSON.stringify([{msg_id:e}]))}},asyncCallback:function(a){}});break;case SocketEventType.getBigFile:SocketEventUtil.handleGetBigFile(b);break;case SocketEventType.updateMute:SocketEventUtil.handleMute(b);break;case SocketEventType.viewAt:SocketEventUtil.handleViewAt(b);break;case SocketEventType.hisRange:SocketEventUtil.handlehisRange(b);break;case SocketEventType.replied:SocketEventUtil.handleReplied(b);break;case SocketEventType.seeHis:SocketEventUtil.handleSeeHis(b);break;case SocketEventType.crowdnotice:SocketEventUtil.handleCrowdNoticeMessage(b);break;case SocketEventType.crowdsetAdmin:SocketEventUtil.handleCrowdSetAdminMessage(b);break;case SocketEventType.updateRead:SocketEventUtil.handleUpdateRead(b);break;default:break;}}},initListeners:function(){this.onChatShow();this.upBigFileSuccess();this.upBigFileFailure();this.downBigFileSuccess();this.downBigFileFailure();this.cancelBFile();this.downloadingBigFile();this.hideBFileInBFileForm();this.doBindSendSetting();this.trnasmit();this.doAddMemToGrpWithHis();this.doAddMemToGrp();this.setAllStatus();this.getScreenshot();this.onDestroyChat();this.openReply()},openReply:function(){window.openReply=function(d){var b=JSON.parse(d),e=b.msg_id,c=b.msg_seq,a=Utils.getCmp('desktopChat_list');a.doScrolToMsg(e,c,function(b){a.isCodeScrol=!0;a.ensureVisible(b,{align:{y:'start'}});DesktopChatUtil.showReply(b)})}},onChatShow:function(){var a=this;window.onChatShow=function(b){if(User.hasShow){return}User.hasShow=!0;User.customData=b;a.initPageCache(b)}},upBigFileSuccess:function(){var a=this;window.upBigFileSuccess=function(c){var b=JSON.parse(c);LocalDataMgr.upBigFileSuccess(b);SendUtil.notifyIMUpBFileSuc({chat_id:b.chat_id,msg_id:b.msg_id,status:'0',file_id:b.file_id},function(){LocalDataMgr.notifyBFileSuccess(b);a.doMsgStoreUpdateFS(b,0);User.removeBFileFromProgress(b.file_id)},function(){a.doMsgStoreUpdateFS(b,2)})}},upBigFileFailure:function(){var a=this;window.upBigFileFailure=function(c){var b=JSON.parse(c);User.removeBFileFromProgress(b.file_id);a.doMsgStoreUpdateFS(b,1)}},downBigFileSuccess:function(){var a=this;window.downBigFileSuccess=function(c){var b=JSON.parse(c);b.file_path=a.getFileURI(b.file_path);User.removeBFileFromProgress(b.file_id);LocalDataMgr.downBigFileSuccess(b);a.doMsgStoreUpdateFS(b,0)}},downBigFileFailure:function(){var a=this;window.downBigFileFailure=function(c){var b=JSON.parse(c);User.removeBFileFromProgress(b.file_id);LocalDataMgr.downBigFileFailure(b);a.doMsgStoreUpdateFS(b,1)}},doMsgStoreUpdateFS:function(a,d){var b=Ext.getStore(a.chat_id);if(b){var c=b.getById(a.msg_id);if(c){c.set({fileStatus:d,localPath:a.path||a.file_path})}}},getFileURI:function(b){var a=b.replace(/\\/g,'/');if(!FileUtil.isFileUri(a)){a='file:///'+a}return a},downloadingBigFile:function(){window.downloadingBigFile=function(a){var b=JSON.parse(a);LocalDataMgr.downloadingBigFile(b)}},hideBFileInBFileForm:function(){window.hideBFileInBFileForm=function(a){var b=JSON.parse(a);LocalDataMgr.hideBFileInBFileForm(b)}},cancelBFile:function(){window.cancelBFile=function(a){User.removeBFileFromProgress(a)}},doBindSendSetting:function(){window.doBindSendSetting=function(a){if(!a){return}var b=JSON.parse(a).send_hot_key;DesktopChatUtil.doBindSendSetting(b)}},trnasmit:function(){window.transmit=function(c){if(!c){return}var b=JSON.parse(c).msgID;if(!b){return}var a=User.crtChannelId;if(Ext.isEmpty(a)){return}var d=Ext.getStore(a);if(!d){return}SendUtil.beforeSend(a).then(function(a){if(!Ext.isEmpty(a)){ChatUtil.doTransmit(b,[a],function(b){})}})}},doAddMemToGrpWithHis:function(){var a=this;window.doAddMemToGrpWithHis=function(b){if(Ext.isEmpty(b)){return}b=JSON.parse(b);var e=b.cid,c=b.memsID,d=b.showHisMsgID;Utils.custAjax('post','chats/'+e+'/history',{params:JSON.stringify(c),success:function(d){if(d){a.addMemToGroup(d,c)}}},!1,'&msg_id='+d)}},doAddMemToGrp:function(){var a=this;window.addGroupUsers=function(b){if(Ext.isEmpty(b)){return}b=JSON.parse(b);var f=b.chatID,d=b.userIDs,c=b.showAll;if(!c){c='N'}var e='&show_all='+c;Utils.custAjax('post','chats/'+f+'/members',{params:JSON.stringify(d),success:function(c){if(c){a.addMemToGroup(c,d)}}},!1,e)}},addMemToGroup:function(h,d){var q=this;var a=h.chat,e=h.messages;var i=GroupNotice.cMeAddMems(d,a.members);if(User.crtChannelId==a.chat_id){var c=Ext.getStore(a.chat_id);if(c){var m=AddDataUtil.isMsgViewBottom();c.add({msg_id:e[0].msg_id,msgSeq:e[0].msg_seq,updateTime:a.update_at,GrpChangeMsg:i,showGrpChange:!0,showTime:ParseUtil.dataShowTime(c,a.update_at)});if(m){AddDataUtil.onScrolMsgView()}}var o=Ext.getStore('rgList');var g=[],b;for(var f=0;f<d.length;f++){b=d[f];var n=User.getUserName(b),k=DesktopChatUtil.showMobile(b),j=DesktopChatUtil.parseGrpListCls(b);g.push({user_id:b,user_name:n,showMobile:k,resCls:j.cls,isOnline:j.isOnline})}o.add(g);var p=q.lookup('desktopMain'),l=p.getViewModel();l.set({displayname:a.header});User.rightTitle=a.header}LocalDataMgr.addMemToGroup(a,i,e)},setAllStatus:function(){var a=this;window.setAllStatus=function(c){User.allStatus=JSON.parse(c);var b=User.crtChatType;if(b==ChatType.Direct){a.doDitStu()}else {if(b==ChatType.Multi){a.doGrpStu()}else {if(b=='C'){a.doGrpStu();console.log('这边进来了setAllStatus')}}}}},doDitStu:function(){var f=this.lookup('desktopMain'),b=f.getViewModel(),g=b.get('sendToID'),c=User.allStatus[g];var a='';var e=c.pc_online,d=c.mobile_online;if(e=='Y'){a='ditChatPC'}else {if(d=='Y'){a='ditChatMobile'}}b.set({ditStu:a})},doGrpStu:function(){var g=JSON.parse(User.customData);if(!g){return}var c=g.GrpStoreMems;console.log(a);if(!c){return}var d=0;for(var f=0;f<c.length;f++){var b=c[f].user_id,l=User.allStatus[b];var a=Ext.getStore('rgList');console.log(a);if(a){var i=a.getById(b);if(i){var m=l.pc_online=='Y'?'p':'m';var j=DesktopChatUtil.showMobile(b),e=DesktopChatUtil.parseGrpListCls(b);i.set({resCls:e.cls,showMobile:j,isOnline:e.isOnline});if(e.isOnline){d+=1}}}}console.log(d);var h=Utils.getCmp('desktopChat_group');if(h){var k=h.getViewModel();k.set({onlineNum:d})}},getScreenshot:function(){window.getScreenshot=function(f){var d=Utils.getCmp('cefOneChat');if(!d){return}var e=Utils.getCmp('desktopChat_input').down('#richEditor');var b=JSON.parse(f);var c='';for(var a=0;a<b.length;a++){var g=ParseUtil.getLocalFileURL(b[a].path);c+='<img _width="'+b[a].width+'" _height="'+b[a].height+'" class="ect-img" src="'+g+'" data-url="'+b[a].path+'">'+'&#8203;'}e.inputElement.dom.focus();if(document.queryCommandSupported('insertHTML')){document.execCommand('insertHTML',!1,c)}else {document.execCommand('paste',!1,c)}}},cefMin:function(){window.cefChat.min()},cefMax:function(){window.cefChat.max()},cefClose:function(){window.cefChat.close()},onDestroyChat:function(){window.onDestroyChat=function(){var a=LocalDataMgr.getDB();if(a){if(a.abortAllPendingTransactions){a.abortAllPendingTransactions()}}}},onDeskChatResize:function(g,f,e,d,c){var a=Ext.Viewport.down('desktopChat_list');if(a.effectObj&&a.getScrollable()){var b=a.effectObj.scrollTop;if(a.effectObj.isBottom){b+=a.effectObj.clientHeight}a.getScrollable().scrollTo(0,b)}}});Ext.define('IMCef.cefOneChat.CefOneChat',{extend:'Ext.Container',xtype:'cefOneChat',controller:'cefOneChatController',requires:['IMCef.cefOneChat.cefOneChatController','IMCommon.plugin.DraggableHandler','IMCommon.view.desktop.DesktopChatView'],layout:'vbox',items:[{layout:'hbox',height:25,userCls:'top-box',items:[{xtype:'component',plugins:'draggablehandler',flex:1},{xtype:'button',ui:'cefOut',iconCls:'im-common-minimize',handler:'cefMin'},{xtype:'button',ui:'cefOut',itemId:'cefMainMax',iconCls:'im-common-maximize',handler:'cefMax'},{xtype:'button',ui:'cefClose',userCls:'close-button',iconCls:'im-common-close',handler:'cefClose'}]},{xtype:'desktopChatView',flex:1,reference:'desktopMain'}],initialize:function(){var a=this;a.callParent(arguments);a.on({resize:'onDeskChatResize',scope:a.getController()})}});Ext.define('IMCef.cefSetting.CrowdSetController',{extend:'Ext.app.ViewController',alias:'controller.crowdsetcontroller',init:function(){var a=this;a.callParent(arguments);a.cefObj=window.cefCrowdSetting;a.initConParam();a.getcrowdinfo();a.setAva()},doTabByCef:function(){var b=this;var a=this.getView().down('#mainTab');var c=window.cefSetting.tab;if(c=='commonUse'){a.setActiveItem('basicSetup')}else {if(c=='personCard'){a.setActiveItem('personCard')}}window.showSettingTab=function(d,c){if(d=='personCard'){a.setActiveItem('personCard')}else {if(d=='commonUse'){a.setActiveItem('basicSetup')}}b.reloadAva();if(!c){return}b.showNowPersonalData(c);b.showNowSettingData(c)}},initConParam:function(){var a=this.cefObj;User.ownerID=a.getUserID();User.token=a.getToken();User.accountID=a.getAccountID();User.cid=a.chatId;User.createat=a.createAt;User.crowdID=a.crowdId},getcrowdinfo:function(){var a=this;Utils.custAjax('get','chatcs/'+User.cid,{success:function(b){User.CrowdNotice=b.notice;User.CrowdRemark=b.remark;Ext.ComponentQuery.query('#crowd_Name')[0].setValue(b.header);Ext.ComponentQuery.query('#crowd_dec')[0].setValue(b.remark);Ext.ComponentQuery.query('#crowd_Notice')[0].setValue(b.notice);a.dobindLeader(b)},failure:function(){}})},setAva:function(){var a=ConfigMgr.getDataDirectory()+User.getUserAvaCrowd()+User.cid+'.png?'+User.cacheMil;if(Config.isPC){a='local'+a}var b='<img src="'+a+'" ></img>';Ext.ComponentQuery.query('#crowd_Ava')[0].setSrc(a)},dobindLeader:function(d){var c=Ext.getStore('rgList');var b=d.members;for(var a=0;a<b.length;a++){if(d.manager_id==b[a].user_id){c.add({isManager:!0,isadmin:b[a].is_admin,user_id:b[a].user_id,user_name:b[a].user_name})}else {c.add({isManager:!1,isadmin:b[a].is_admin,user_id:b[a].user_id,user_name:b[a].user_name})}}},close:function(){this.cefObj.close()}});Ext.define('IMCef.cefSetting.tab.PersonCardController',{extend:'Ext.app.ViewController',alias:'controller.personcardcontroller',uses:['IMCef.cefSetting.widget.ChgAvaPanel'],init:function(){},onTapAva:function(b,c){var a=this.avaPanel;if(!a){a=Ext.create('IMCef.cefSetting.widget.ChgAvaPanel');this.avaPanel=a}a.showBy(b.element,'tl-bl?')},onImgAvaErr:function(b){var a=Ext.getResourcePath('images/imdefault.png');b.setSrc(a)},onSexCheckM:function(b,a){this.doChgUserInfo('sex','M')},onSexCheckF:function(b,a){this.doChgUserInfo('sex','F')},onChgMobile:function(a){var b=a.getValue();this.doChgUserInfo('mobile',b)},onChgEmail:function(a){var b=a.getValue();this.doChgUserInfo('email',b)},onChgNotes:function(a){var b=a.getValue();this.doChgUserInfo('notes',b)},doChgUserInfo:function(a,c){var d=this.getViewModel();var b=d.get('uInfo');var e=b[a];if(e!=c){b[a]=c;Utils.custAjax('put','users/me/info',{params:JSON.stringify(b),success:function(f){cefSetting.updateUser(a,c);d.set('uInfo',b);var e={key:a,value:c};cefSetting.exec('settingChgUserInfo',JSON.stringify(e))},failure:function(){Utils.toastShort('请求更新失败');d.set(a,e);b[a]=e}})}},onLogout:function(){Ext.Msg.show({title:'系统提示',message:'确定要退出登录吗?',buttons:Ext.MessageBox.OKCANCEL,defaultFoucs:'#ok',prompt:!1,cls:'centered-dialog',fn:function(a){if(a=='ok'){cefSetting.exec('settingLogout','');cefSetting.close()}}})},destory:function(){var a=this;Ext.destroy(a.avaPanel);a.callParent(arguments)}});Ext.define('IMCef.cefSetting.tab.PersonCard',{extend:'Ext.Panel',xtype:'personCard',controller:'personcardcontroller',requires:['IMCef.cefSetting.tab.PersonCardController'],style:'padding: 10px;',layout:{type:'vbox',align:'stretch'},items:[{xtype:'panel',layout:'vbox',autosize:!0,shadow:!0,style:'margin: 10px auto; box-shadow: 1px 1px 4px 0 rgba(0, 0, 0, 0.2);',padding:'27px 20px 20px 20px',width:400,items:[{xtype:'container',layout:'vbox',items:[{xtype:'container',layout:'hbox',userCls:'card-top',items:[{xtype:'img',id:'settingUserAva',src:Ext.getResourcePath('images/imdefault.png'),width:60,height:60,listeners:{error:'onImgAvaErr'}},{xtype:'container',flex:1,layout:'vbox',padding:'0 0 0 20px',items:[{xtype:'component',flex:1,bind:{html:'<div class="user-name">{user_name}</div>'}},{xtype:'container',layout:'hbox',items:[{xtype:'component',flex:1,bind:{html:'<div class="role-name">{role_names}</div>'}},{xtype:'component',html:'<a class="edit" style="text-decoration: none;">编辑个人信息</a>',listeners:{tap:{element:'element',delegate:'a',fn:function(){cefSetting.openUserEdit()}}}}]}]}]},{xtype:'container',layout:'vbox',flex:1,padding:'18px 0 0 0',items:[{xtype:'component',bind:{html:'<div class="mobile"><span class="key">电话</span><span class="value">{mobile}</span></div>'}},{xtype:'component',bind:{html:'<div class="email"><span class="key">邮箱</span><span class="value">{email}<span></div>'}}]}]}]},{xtype:'panel',style:'margin: 20px auto;',width:320,items:[{xtype:'container',width:320,style:'margin: 0px auto;',layout:'center',items:[{xtype:'button',text:'注销',userCls:'logout-button',width:100,handler:'onLogout'}]}]}]});Ext.define('IMCef.cefSetting.crowdtab.CrowdFristSetController',{extend:'Ext.app.ViewController',alias:'controller.crowdfristsetcontroller',onTextNotice:function(b){var a=b.getInputValue();if(a==User.CrowdNotice){}else {Utils.custAjax('put','chatcs/'+User.crowdID+'/notice',{params:JSON.stringify({chat_id:User.cid,id:User.crowdID,notice:a}),success:function(d){User.CrowdNotice=a;var c='UPDATE IMChatC SET Notice=? WHERE ChatID=?';LocalDataMgr.cExecSqlWithP(c,[a,User.cid])},failure:function(){Utils.toastShort('请求更新失败');b.setValue(User.CrowdNotice)}})}},onTextRemark:function(b){var a=b.getInputValue();if(a==User.CrowdRemark){}else {Utils.custAjax('put','chatcs/'+User.crowdID,{params:JSON.stringify({chat_id:User.cid,id:User.crowdID,remark:a}),success:function(d){User.CrowdRemark=a;var c='UPDATE IMChatC SET ReMark=? WHERE ChatID=?';LocalDataMgr.cExecSqlWithP(c,[a,User.cid])},failure:function(){Utils.toastShort('请求更新失败');b.setValue(User.CrowdNotice)}})}},onTapAva:function(){var a=this;ImgMgr.chooseImages().then(function(b){a.onUpload(b.images[0].path)})['catch'](function(){})},onUpload:function(f){var d=this;var b=f;b=b.replace(/localfile:[\/]+/g,'file:///');var a=new FileUploadOptions();a.fileKey='files';a.fileName=FileUtil.getFileName(b);a.mimeType='image/png';a.httpMethod='PUT';a.headers={};a.params={};var i=new FileTransfer();var c=d.getView();Utils.mask(c,'正在上传图片');var g=b.replace(/file:[\/]+/g,'');var h=(new Date()).getTime();var e=Config.httpUrlForGo+'chatcs/'+User.cid+'/avatar?token='+User.token+'&create_at='+User.createat+'&'+h;i.upload(g,encodeURI(e),function(b){Utils.unMask(c);var a=JSON.parse(b.response);if(a.status=='OK'){User.needUpdateCrowdAva(User.cid,User.createat,a.hash,function(e){var g=c.down('#crowd_Ava');g.setSrc(e);var h='UPDATE IMChatC SET Avahash=? WHERE ChatID=?;';LocalDataMgr.cExecSqlWithP(h,[a.hash,User.cid]);var d=[];d=JSON.stringify({Path:e,chat_id:User.cid});Utils.getApp().getCefObj().exec('settingCrowdAva',d)})}else {Utils.unMask(d.getView());Utils.toastShort('上传头像失败')}},function(a){Utils.unMask(d.getView())},a)}});Ext.define('IMCef.cefSetting.crowdtab.CrowdFristSet',{extend:'Ext.Panel',xtype:'crowdfristset',controller:'crowdfristsetcontroller',requires:['Ext.dataview.DataView','IMCef.cefSetting.crowdtab.CrowdFristSetController'],style:'padding: 10px;',layout:{type:'vbox',align:'stretch'},cls:'crowd_tset',items:[{xtype:'panel',items:[{xtype:'container',layout:'hbox',style:'margin-top: 20px;',items:[{xtype:'image',width:80,height:80,style:'margin-left: 50px;background-color: #eee;',listeners:{tap:'onTapAva'},itemId:'crowd_Ava',src:''},{xtype:'container',layout:'vbox',width:200,style:'margin-left: 30px;',items:[{xtype:'container',html:'<a>变更群头像</a>',style:'margin-top: 8px;',listeners:{element:'element',tap:'onTapAva'}},{xtype:'container',html:'(建议使用300*300,500k以内的jpg,png图片)',style:'margin-top: 8px;'}]}]},{xtype:'container',layout:'vbox',cls:'setcontainer',style:'height:350px;margin-top:20px',items:[{xtype:'container',width:420,flex:1,items:[{xtype:'textfield',cls:'crowdname',height:45,itemId:'crowd_Name',label:'群名称',readOnly:!0,style:'margin-top: 0px;padding-bottom: 0px;'},{xtype:'textareafield',cls:'crowddsc',itemId:'crowd_dec',style:'height: 70px;margin-top: 0px;padding-bottom: 0px;',label:'群描述',listeners:{blur:'onTextRemark'}},{xtype:'textareafield',cls:'crowddsc',itemId:'crowd_Notice',style:'height: 70px;margin-top: 0px;padding-bottom: 0px;',label:'群公告',listeners:{blur:'onTextNotice'}},{xtype:'container',layout:'hbox',height:100,items:[{xtype:'container',html:'群主/管理员',cls:'mems_together'},{xtype:'dataview',cls:'mems_container',inline:!0,store:{storeId:'rgList',model:'IMCommon.model.desktop.DesktopGrpMems',sorters:[{property:'isManager',direction:'Desc'},{property:'isadmin',direction:'Desc'}]},itemTpl:'<tpl if="values.isManager">'+'<div>'+'<img src="{[AvatarMgr.getNavUserAvaUrlWOCache(values.user_id,"")]}" onerror="AvatarMgr.doUserAvaErr(this)" ava-id="{user_id}" hash="" style="width:25px;height:25px;border-radius: 5%;position: absolute;top: 0px;">'+'</div>'+'<div style="color:red;position: absolute;left: 38px;top: 3px;font-size: 16px;">{user_name}</div>'+'<tpl elseif="values.isadmin==\'Y\'">'+'<div>'+'<img src="{[AvatarMgr.getNavUserAvaUrlWOCache(values.user_id,"")]}" onerror="AvatarMgr.doUserAvaErr(this)" ava-id="{user_id}" hash="" style="width:25px;height:25px;border-radius: 5%;position: absolute;top: 0px;">'+'</div>'+'<div style="position: absolute;left: 38px;top: 3px;font-size: 16px;">{user_name}</div>'+'</tpl>'}]}]}]}]}]});Ext.define('IMCef.cefSetting.CrowdSet',{extend:'IMCef.src.MainView',xtype:'crowdset',controller:'crowdsetcontroller',requires:['IMCef.cefSetting.CrowdSetController','IMCef.cefSetting.tab.PersonCard','IMCef.cefSetting.crowdtab.CrowdFristSet'],viewModel:{data:{uInfo:{},settings:{},org_names:'',user_name:'',role_names:'',mobile:'',sex:'',email:'',notes:'',send_hot_key:'Ctrl+Enter',autoStart:!0,capture_hot_key:'无',open_main_hot_key:'无',fileFolder:'默认',extras:{nap_type:'0',nap_end:'0'},badge:'',updateText:'检查更新'}},title:'设置',layout:'vbox',cls:'settingMain',items:[{xtype:'tabpanel',itemId:'mainTab',flex:1,ui:'set',tabBarPosition:'left',defaults:{tab:{textAlign:'right',ui:'setTab'}},items:[{itemId:'crowdfristset',title:'首页',xtype:'crowdfristset'}]}]});Ext.define('IMCef.cefSetting.MainViewController',{extend:'Ext.app.ViewController',alias:'controller.mainviewcontroller',init:function(){var a=this;a.callParent(arguments);a.setMaxIcon();a.cefObj=window.cefSetting;a.initConParam();a.initPersonalData();a.initSettingData();a.checkVersion();a.doTabByCef();window.resetPersonData=function(b,c,d){a.resetPersonData(b,c,d)};window.reloadAva=function(){a.reloadAva()}},doTabByCef:function(){var b=this;var a=this.getView().down('#mainTab');var c=window.cefSetting.tab;if(c=='commonUse'){a.setActiveItem('basicSetup')}else {if(c=='personCard'){a.setActiveItem('personCard')}}window.showSettingTab=function(d,c){if(d=='personCard'){a.setActiveItem('personCard')}else {if(d=='commonUse'){a.setActiveItem('basicSetup')}}b.reloadAva();if(!c){return}b.showNowPersonalData(c);b.showNowSettingData(c)}},initConParam:function(){var a=this.cefObj;User.ownerID=a.getUserID();User.token=a.getToken();User.accountID=a.getAccountID()},resetPersonData:function(b,c,d){var f=this.cefObj;var a=JSON.parse(f.getSettingData());a.user.mobile=b;a.user.email=c;a.user.notes=d;var e=this.getViewModel();e.set({uInfo:a.user,mobile:b,email:c,notes:d})},reloadAva:function(){var a=this.getView().down('#personCard').down('#settingUserAva');var b=ParseUtil.getLocalFileURL(ConfigMgr.getDataDirectory())+User.getUserAvaDir()+User.ownerID+'.png?'+(new Date()).getTime();a.setSrc(b)},initPersonalData:function(){var c=this.cefObj;var b=c.getSettingData();b=JSON.parse(b);if(!b){return}var a=b.user;if(!a){return}var d=this.getViewModel();d.set({uInfo:a,org_names:a.org_names||'',user_name:a.user_name,role_names:a.role_names,sex:a.sex,mobile:a.mobile,email:a.email,notes:a.notes});Ext.getCmp('settingUserAva').setSrc(AvatarMgr.getNavUserAvaUrl(c.getUserID()))},initSettingData:function(){var f=this.cefObj,c=f.getSettingData();c=JSON.parse(c);if(!c){return}var a=c.settings;if(!a){return}var g=f.getAutoStart();var e=Ext.getCmp('autoStartToggle');if(e){var i=g=='Y';if(i){e.addCls('x-checked')}else {e.removeCls('x-checked')}}var b=f.getFileFolder();if(!b){b=ParseUtil.clearFileOfURL(ConfigMgr.getDataDirectory()).toString()}if(!a.extras){a.extras={nap_type:'0'}}else {if(!a.extras.nap_type){a.extras.nap_type='0'}}var h=this.getViewModel();console.log(b);console.log(a);h.set({settings:a,send_hot_key:a.send_hot_key,capture_hot_key:a.capture_hot_key?a.capture_hot_key:'无',open_main_hot_key:a.open_main_hot_key?a.open_main_hot_key:'无',fileFolder:b,work_folder:a.work_folder,extras:a.extras});var d=Ext.ComponentQuery.query('#onshowcheck');if(d&&d.length>0){if(a.work_folder_show=='Y'){d[0].setChecked(!0)}else {d[0].setChecked(!1)}}},checkVersion:function(){var b=cefSetting.checkVersion();var a=b.split('|');var e=a[0],d=a[1];var c=this.getViewModel();if(e=='true'){c.set({badge:'!',updateText:'升级到'+d})}},showNowPersonalData:function(c){var b=c;if(!b){return}var a=b.user;if(!a){return}var d=this.getViewModel();d.set({uInfo:a,org_names:a.org_names||a.user_posts||'',user_name:a.user_name,role_names:a.role_names||(a.roles||[]).filter(function(a){return a.corp_id==cef.getCurrentCorpID()}).map(function(a){return a.role_name}).join(','),sex:a.sex,mobile:a.mobile,email:a.email,notes:a.notes});User.cacheMil=(new Date()).getTime();Ext.getCmp('settingUserAva').setSrc(AvatarMgr.getNavUserAvaUrl(cefSetting.getUserID()))},showNowSettingData:function(f){var e=f;if(!e){return}var a=e.settings;if(!a){return}var g=cefSetting.getAutoStart();var d=Ext.getCmp('autoStartToggle');if(d){var i=g=='Y';if(i){d.addCls('x-checked')}else {d.removeCls('x-checked')}}var c=cefSetting.getFileFolder();if(!c){c=ParseUtil.clearFileOfURL(ConfigMgr.getDataDirectory()).toString()}if(!a.extras){a.extras={nap_type:'0'}}else {if(!a.extras.nap_type){a.extras.nap_type='0'}}var h=this.getViewModel();h.set({settings:a,send_hot_key:a.send_hot_key,capture_hot_key:a.capture_hot_key?a.capture_hot_key:'无',open_main_hot_key:a.open_main_hot_key?a.open_main_hot_key:'无',fileFolder:c,work_folder:a.work_folder,extras:a.extras});var b=Ext.ComponentQuery.query('#onshowcheck');if(b&&b.length>0){if(a.work_folder_show=='Y'){b[0].setChecked(!0)}else {b[0].setChecked(!1)}}},setMaxIcon:function(){window.setMaxIcon=function(a){}},close:function(){this.cefObj.close()}});Ext.define('IMCef.cefSetting.tab.CommonUseController',{extend:'Ext.app.ViewController',alias:'controller.commonusecontroller',init:function(){},onAutoStartCheck:function(a){},onAutoStartChange:function(a){var c=a.hasCls('x-checked');if(c){cefSetting.registerBootupToStart();var b=cefSetting.getAutoStart();if(b!='Y'){a.removeCls('x-checked')}}else {cefSetting.unregisterBootupToStart();var b=cefSetting.getAutoStart();if(b=='Y'){a.addCls('x-checked')}}},onAutoStart:function(c,a,b){if(a){cefSetting.registerBootupToStart()}else {cefSetting.unregisterBootupToStart()}},onChgFileSaveP:function(b){var a=this.getViewModel();cefSetting.selectFileFolder(function(c){c=c.replace(/\\/g,'/');var d='file:///'+c;a.set({fileFolder:c});var e={key:'fileFolder',value:d};cefSetting.exec('settingChgSettingInfo',JSON.stringify(e))})},openImporter:function(){cefSetting.exec('openImporter','')}});Ext.define('IMCef.cefSetting.tab.CommonUse',{extend:'Ext.Container',xtype:'commonUse',controller:'commonusecontroller',requires:['IMCef.cefSetting.tab.CommonUseController'],style:'padding: 10px;',cls:'commonUseContainer',items:[{style:'margin: 20px;',layout:'hbox',items:[{xtype:'container',width:100,layout:'vbox',defaults:{xtype:'component',height:37,style:'margin: 0 0 20px;'},items:[{html:'<div class="settingCommonLeft">登录</div>'},{html:'<div class="settingCommonLeft">文件存储</div>'},{html:'<div class="settingCommonLeft">消息导入</div>'}]},{xtype:'container',flex:1,defaults:{style:'margin: 0 0 20px;'},items:[{xtype:'checkbox',id:'autoStartToggle',userCls:'toggle',label:'开机自动启动',labelWidth:'auto',labelAlign:'left',labelTextAlign:'left',listeners:{change:'onAutoStartChange',check:'onAutoStartCheck'}},{layout:'hbox',items:[{xtype:'textfield',width:233,bind:{value:'{fileFolder}'},readOnly:!0},{xtype:'button',text:'更改',handler:'onChgFileSaveP',disabled:!0}]},{xtype:'button',text:'打开工具',handler:'openImporter'}]}]}]});Ext.define('IMCef.cefSetting.tab.ShortcutKeyController',{extend:'Ext.app.ViewController',alias:'controller.shortcutkeycontroller',init:function(){var a=this;a.callParent(arguments);a.cefObj=window.cefSetting;a.initKeyDown()},initKeyDown:function(){var a=this,b=a.getView(),c=b.down('#shortcutField'),d=b.down('#openAppField');a.doKeydownEvent(c,function(b){cefSetting.registerCapture(b,function(c){if(c){a.doChgSetting('capture_hot_key',b,function(){})}else {Utils.toastShort('设置快捷键有误或者有冲突')}})});a.doKeydownEvent(d,function(b){cefSetting.registerOpenMain(b,function(c){if(c){a.doChgSetting('open_main_hot_key',b)}else {Utils.toastShort('设置快捷键有误或者有冲突')}})})},doKeydownEvent:function(a,b){var c=a.inputElement.dom;var d=this;$(c).keydown(function(c){var i=c.shiftKey,h=c.ctrlKey,g=c.altKey;if(c.keyCode===8){return !1}var f=d.doExKey(i,h,g,'');c.preventDefault();if(f==''){a.setValue('无')}else {var e=c.keyCode;if(e==16||e==17||e==18){a.setValue('无')}else {this.value=f+c.key.toUpperCase();if(b){b(f+c.key.toUpperCase())}}}})},doExKey:function(d,c,b,a){if(d){if(c){if(b){a='Ctrl + Shift + Alt + '}else {a='Ctrl + Shift + '}}else {if(b){a='Shift + Alt + '}else {a='Shift + '}}}else {if(c){if(b){a='Ctrl + Alt + '}else {a='Ctrl + '}}else {if(b){a='Alt + '}}}return a},onSendKeyCheckCE:function(){this.doChgSetting('send_hot_key','Ctrl+Enter',function(a){a.set({send_hot_key:'Ctrl+Enter'})})},onSendKeyCheckE:function(){this.doChgSetting('send_hot_key','Enter',function(a){a.set({send_hot_key:'Enter'})})},onChgShortcut:function(b){var a=b.getValue();if(a&&a!='无'){this.doChgSetting('capture_hot_key',a)}},onChgOpenApp:function(b){var a=b.getValue();if(a&&a!='无'){this.doChgSetting('open_main_hot_key',a)}},doChgSetting:function(a,d,e){var b=this.getViewModel();var c=b.get('settings');var f=c[a];if(f!=d){c[a]=d;Utils.custAjax('POST','users/me/setting',{params:JSON.stringify(c),success:function(g){cefSetting.updateSetting(a,d);b.set('settings',c);var f={key:a,value:d};cefSetting.exec('settingChgSettingInfo',JSON.stringify(f));if(e){e(b)}},failure:function(){Utils.toastShort('请求更新失败');b.set(a,f)}})}},destory:function(){}});Ext.define('IMCef.cefSetting.tab.ShortcutKey',{extend:'Ext.Container',xtype:'shortcutKey',controller:'shortcutkeycontroller',requires:['IMCef.cefSetting.tab.ShortcutKeyController'],cls:'shortcutKey',style:'padding: 10px;',items:[{style:'margin: 20px;',layout:'hbox',items:[{xtype:'container',width:100,layout:'vbox',defaults:{xtype:'component',height:37,style:'margin: 0 0 20px;'},items:[{html:'<div class="settingCommonLeft">发送消息</div>'},{html:'<div class="settingCommonLeft">截屏</div>'},{html:'<div class="settingCommonLeft">打开主面板</div>'}]},{xtype:'container',flex:1,defaults:{style:'margin: 0 0 20px;'},layout:'vbox',items:[{xtype:'container',layout:'hbox',items:[{xtype:'radiofield',name:'sendKey',labelWidth:'auto',labelAlign:'right',style:'margin-right:15px;',label:'Ctrl+Enter',bind:{checked:'{send_hot_key == "Ctrl+Enter"}'},listeners:{check:'onSendKeyCheckCE'}},{xtype:'radiofield',name:'sendKey',value:'m',labelWidth:'auto',labelAlign:'right',style:'margin-right:15px;',label:'Enter',bind:{checked:'{send_hot_key == "Enter"}'},listeners:{check:'onSendKeyCheckE'}}]},{xtype:'textfield',width:200,itemId:'shortcutField',clearable:!1,bind:{value:'{capture_hot_key}'},readOnly:!0},{xtype:'textfield',width:200,itemId:'openAppField',clearable:!1,bind:{value:'{open_main_hot_key}'},readOnly:!0}]}]}]});Ext.define('IMCef.cefSetting.tab.AboutController',{extend:'Ext.app.ViewController',alias:'controller.aboutcontroller',init:function(){},onShowAbout:function(a){cefSetting.checkUpdate(function(b){})},onShowUpdateLogs:function(){var b=this,a=b.getView();a.up().push({xtype:'updateloglist'})},onBack:function(){var c=this,b=c.getView(),a=b.up('aboutcontain');a.pop()}});Ext.define('IMCef.cefSetting.tab.About',{extend:'Ext.Container',xtype:'about',controller:'aboutcontroller',requires:['IMCef.cefSetting.tab.AboutController'],style:'padding: 10px;',bodyStyle:'background:red;',layout:{type:'vbox',align:'stretch'},items:[{xtype:'img',src:Ext.getResourcePath('images/logo.png',null,'IMCef'),width:123,height:59,style:'margin: 100px auto 0;'},{xtype:'component',html:'<div style="font-size: 12px;font-weight: 300;color: #b1b0b0;text-align:center;margin-top: 15px;">版本号&nbsp;&nbsp;v'+Utils.getApp().versionName+'</div>'},{xtype:'button',bind:{text:'{updateText}'},style:'margin:10px auto;',width:150,handler:'onShowAbout'},{xtype:'button',text:'更新日志',style:'margin:10px auto;',width:150,handler:'onShowUpdateLogs',hidden:!0},{xtype:'component',html:'<div style="text-align:center;font-size: 12px;">Copyright © '+(new Date()).getFullYear()+' Pushsoft</div>'}]});Ext.define('IMCef.cefSetting.tab.AboutContain',{extend:'Ext.NavigationView',xtype:'aboutcontain',navigationBar:!1,items:[{xtype:'about'}]});Ext.define('IMCef.cefSetting.mainView',{extend:'IMCef.src.MainView',xtype:'settingMainView',controller:'mainviewcontroller',requires:['IMCef.cefSetting.MainViewController','IMCef.cefSetting.tab.PersonCard','IMCef.cefSetting.tab.CommonUse','IMCef.cefSetting.tab.ShortcutKey','IMCef.cefSetting.tab.About'],viewModel:{data:{uInfo:{},settings:{},org_names:'',user_name:'',role_names:'',mobile:'',sex:'',email:'',notes:'',send_hot_key:'Ctrl+Enter',autoStart:!0,capture_hot_key:'无',open_main_hot_key:'无',fileFolder:'默认',extras:{nap_type:'0',nap_end:'0'},badge:'',updateText:'检查更新'}},title:'设置',layout:'vbox',cls:'settingMain',items:[{xtype:'tabpanel',itemId:'mainTab',flex:1,ui:'set',tabBarPosition:'left',defaults:{tab:{textAlign:'right',ui:'setTab'}},items:[{itemId:'personCard',title:'个人名片',xtype:'personCard'},{title:'基本设置',xtype:'basicSetup'},{title:'账套信息',xtype:'qrcodeinfo'},{title:'关于',itemId:'aboutView',xtype:'aboutcontain',tab:{bind:{badgeText:'{badge}'}}}]}]});Ext.define('IMCef.cefSetting.tab.BasicSetupController',{extend:'Ext.app.ViewController',alias:'controller.basicsetupcontroller',init:function(){var a=this;a.callParent(arguments);a.cefObj=window.cefSetting;a.initKeyDown();window.chgSettingNap=function(b){a.lookup('restSF').setValue(b)}},onAutoStartChange:function(a){var c=a.hasCls('x-checked');if(c){cefSetting.registerBootupToStart();var b=cefSetting.getAutoStart();if(b!='Y'){a.removeCls('x-checked')}}else {cefSetting.unregisterBootupToStart();var b=cefSetting.getAutoStart();if(b=='Y'){a.addCls('x-checked')}}},onChgFileSaveP:function(b){var a=this.getViewModel();cefSetting.selectFileFolder(function(c){c=c.replace(/\\/g,'/');var d='file:///'+c;a.set({fileFolder:c});var e={key:'fileFolder',value:d};cefSetting.exec('settingChgSettingInfo',JSON.stringify(e))})},onChgWorkSaveP:function(){var a=this.getViewModel();cefSetting.selectWorkFolder(function(b){b=b.replace(/\\/g,'/');var c='file:///'+b;a.set({work_folder:b})})},onChangeStu:function(){var a;if(Ext.ComponentQuery.query('#onshowcheck')[0].isChecked()){a='Y'}else {a='N'}cefSetting.selectWorkFolderShow(a,function(){})},onSendKeyCheckCE:function(){this.doChgSetting('send_hot_key','Ctrl+Enter',function(a){a.set({send_hot_key:'Ctrl+Enter'})})},onSendKeyCheckE:function(){this.doChgSetting('send_hot_key','Enter',function(a){a.set({send_hot_key:'Enter'})})},initKeyDown:function(){var a=this,b=a.getView(),c=b.down('#shortcutField'),d=b.down('#openAppField');a.doKeydownEvent(c,function(b){cefSetting.registerCapture(b,function(c){if(c){a.doChgSetting('capture_hot_key',b,function(){})}else {Utils.toastShort('设置快捷键有误或者有冲突')}})});a.doKeydownEvent(d,function(b){cefSetting.registerOpenMain(b,function(c){if(c){a.doChgSetting('open_main_hot_key',b)}else {Utils.toastShort('设置快捷键有误或者有冲突')}})})},doKeydownEvent:function(b,a){var c=b.inputElement.dom;var d=this;$(c).keydown(function(c){var i=c.shiftKey,h=c.ctrlKey,g=c.altKey;if(c.keyCode===8){return !1}var f=d.doExKey(i,h,g,'');c.preventDefault();if(f==''){this.value='无';if(a){a('')}}else {var e=c.keyCode;if(e==16||e==17||e==18){this.value='无';if(a){a('')}}else {this.value=f+c.key.toUpperCase();if(a){a(f+c.key.toUpperCase())}}}})},doExKey:function(d,c,b,a){if(d){if(c){if(b){a='Ctrl + Shift + Alt + '}else {a='Ctrl + Shift + '}}else {if(b){a='Shift + Alt + '}else {a='Shift + '}}}else {if(c){if(b){a='Ctrl + Alt + '}else {a='Ctrl + '}}else {if(b){a='Alt + '}}}return a},doChgSetting:function(a,d,f){var c=this.getViewModel();var b=c.get('settings');var g=b[a];var e=!1;if(a=='extras'){e=!0}else {if(g!=d){e=!0}}if(e){b[a]=d;Utils.custAjax('POST','users/me/setting',{params:JSON.stringify(b),success:function(h){if(a=='extras'){var e=JSON.parse(cefSetting.getSettingData());e.settings=b;cefSetting.setSettingData(JSON.stringify(e))}else {cefSetting.updateSetting(a,d)}c.set('settings',b);var g={key:a,value:d};cefSetting.exec('settingChgSettingInfo',JSON.stringify(g));if(f){f(c)}},failure:function(){Utils.toastShort('请求更新失败');c.set(a,g)}})}},onChgExtra:function(f,a){var e=this.getViewModel(),b=e.get('extras');if(!b){b={nap_type:a}}else {b.nap_type=a}var c=0,d=ParseUtil.getLocalTime(!0);switch(a){case '3':c=d+1000*60*60;break;case '2':c=ParseUtil.get24TimeOfDay(d)+ConfigMgr.morningWorkTime;break;default:break;}this.setNap('extras',{nap_type:a,nap_end:c+''})},setNap:function(b,a){Utils.custAjax('PUT','users/me/nap',{params:JSON.stringify(a),success:function(e){var c=JSON.parse(cefSetting.getSettingData());c.settings.extras=a;cefSetting.setSettingData(JSON.stringify(c));var d={key:b,value:a};cefSetting.exec('settingChgSettingInfo',JSON.stringify(d))},failure:function(){Utils.toastShort('请求更新失败')}})}});Ext.define('IMCef.cefSetting.tab.BasicSetup',{extend:'Ext.Container',xtype:'basicSetup',controller:'basicsetupcontroller',requires:['IMCef.cefSetting.tab.BasicSetupController'],style:'padding: 10px;',cls:'basicSetupContainer',items:[{xtype:'container',flex:1,layout:'vbox',items:[{xtype:'container',layout:'hbox',padding:'8 18',items:[{xtype:'displayfield',value:'登录',width:100},{xtype:'checkbox',style:'margin-top: 0px;',id:'autoStartToggle',userCls:'cef-icon',label:'开机启动',labelAlign:'right',labelTextAlign:'left',listeners:{change:'onAutoStartChange'}}]},{xtype:'container',layout:'hbox',padding:'8 18',items:[{xtype:'displayfield',value:'文件存储',width:100},{xtype:'container',flex:1,layout:'hbox',items:[{xtype:'textfield',clearable:!1,readOnly:!0,bind:{value:'{fileFolder}'}}]}]},{xtype:'container',layout:'hbox',padding:'8 18',items:[{xtype:'displayfield',value:'发送消息',width:100},{xtype:'container',layout:'hbox',items:[{xtype:'radiofield',name:'sendKey',label:'Ctrl+Enter',labelAlign:'right',labelTextAlign:'left',userCls:'cef-icon',bind:{checked:'{send_hot_key == "Ctrl+Enter"}'},listeners:{check:'onSendKeyCheckCE'}},{xtype:'radiofield',name:'sendKey',label:'Enter',labelAlign:'right',labelTextAlign:'left',userCls:'cef-icon',bind:{checked:'{send_hot_key == "Enter"}'},listeners:{check:'onSendKeyCheckE'}}]}]},{xtype:'container',layout:'hbox',padding:'8 18',items:[{xtype:'displayfield',value:'截屏',width:100},{xtype:'textfield',itemId:'shortcutField',clearable:!1,bind:{value:'{capture_hot_key}'},readOnly:!0}]},{xtype:'container',layout:'hbox',padding:'8 18',items:[{xtype:'displayfield',value:'打开主面板',width:100},{xtype:'textfield',itemId:'openAppField',clearable:!1,bind:{value:'{open_main_hot_key}'},readOnly:!0}]}]}],items1:[{style:'margin: 20px;',layout:'hbox',items:[{xtype:'container',width:100,layout:'vbox',defaults:{xtype:'component',height:37,style:'margin: 0 0 14px;'},items:[{style:'margin: 0 0 5px;',html:'<div class="settingCommonLeft">登录</div>'},{style:'margin: 0 0 5px;',html:'<div class="settingCommonLeft">文件存储</div>'},{style:'margin: 0 0 15px;',html:'<div class="settingCommonLeft">询问下载路径</div>'},{style:'margin: 0 0 11px;',html:'<div class="settingCommonLeft">发送消息</div>'},{style:'margin: 0 0 14px;',html:'<div class="settingCommonLeft">截屏</div>'},{html:'<div class="settingCommonLeft">打开主面板</div>'}]},{xtype:'container',flex:1,defaults:{style:'margin-top: 15px;'},items:[{xtype:'checkbox',style:'margin-top: 0px;',id:'autoStartToggle',userCls:'toggle',label:'开机自动启动',labelWidth:'auto',labelAlign:'left',labelTextAlign:'left',listeners:{change:'onAutoStartChange'}},{layout:'hbox',style:'margin-top: 5px;',items:[{xtype:'textfield',width:233,bind:{value:'{fileFolder}'},readOnly:!0},{xtype:'button',text:'更改',handler:'onChgFileSaveP',disabled:!0}]},{xtype:'checkbox',itemId:'onshowcheck',reference:'onshowcheck',style:'margin-top: 16px;',listeners:{change:'onChangeStu'}},{xtype:'container',layout:'hbox',margin:'20 0 0',items:[{xtype:'radiofield',name:'sendKey',labelWidth:'auto',labelAlign:'right',style:'margin-right:15px;',label:'Ctrl+Enter',bind:{checked:'{send_hot_key == "Ctrl+Enter"}'},listeners:{check:'onSendKeyCheckCE'}},{xtype:'radiofield',name:'sendKey',value:'m',labelWidth:'auto',labelAlign:'right',style:'margin-right:15px;',label:'Enter',bind:{checked:'{send_hot_key == "Enter"}'},listeners:{check:'onSendKeyCheckE'}}]},{xtype:'textfield',width:200,itemId:'shortcutField',clearable:!1,bind:{value:'{capture_hot_key}'},readOnly:!0},{xtype:'textfield',width:200,itemId:'openAppField',clearable:!1,bind:{value:'{open_main_hot_key}'},readOnly:!0}]}]}]});Ext.define('IMCef.cefSetting.tab.PersonEditController',{extend:'Ext.app.ViewController',alias:'controller.usereditcontroller',onClose:function(){cefUserEdit.close()},onSave:function(){var g=this,f=g.getView(),h=f.getViewModel(),a=h.getData();var b=document.createElement('div');b.innerHTML=a.mobile;var c=b.innerText;b.innerHTML=a.email;var d=b.innerText;b.innerHTML=a.notes;var e=b.innerText;a.mobile=c;a.email=d;a.notes=e;a.mobile=a.mobile+'';Utils.custAjax('put','users/me/info',{params:JSON.stringify(a),success:function(b){cefUserEdit.updateUser(c,d,e);var a=[{key:'mobile',value:c},{key:'email',value:d},{key:'notes',value:e}];cefUserEdit.exec('settingChgUserInfo',JSON.stringify(a));cefUserEdit.close()},failure:function(){Utils.toastShort('请求更新失败')}})},onSelectAvt:function(){var a=this;ImgMgr.chooseImages().then(function(b){a.onUpload(b.images[0].path)})['catch'](function(a){console.log(a)})},onUpload:function(e){var d=this;var b=e;b=b.replace(/localfile:[\/]+/g,'file:///');var a=new FileUploadOptions();a.fileKey='files';a.fileName=FileUtil.getFileName(b);a.mimeType='image/png';a.httpMethod='PUT';a.headers={};a.params={};var g=new FileTransfer();var c=d.getView();Utils.mask(c,'正在上传图片');var f=b.replace(/file:[\/]+/g,'');g.upload(f,encodeURI(Config.httpUrlForGo+'users/'+User.ownerID+'/avatar?token='+User.token),function(b){Utils.unMask(c);var a=JSON.parse(b.response);if(a.status=='OK'){User.needUpdateUserAva(User.ownerID,a.hash,function(f){var d=c.down('#userAva');d.setSrc(f);cefUserEdit.reLoadAva(a.hash)})}else {Utils.unMask(d.getView());Utils.toastShort('上传头像失败')}},function(a){Utils.unMask(d.getView())},a)}});Ext.define('IMCef.cefSetting.tab.PersonInfoEdit',{extend:'IMCef.src.MainView',xtype:'useredit',title:'个人信息',controller:'usereditcontroller',cls:'settingMain',userCls:'useredit',viewModel:{},buttonAlign:'right',items:[{xtype:'fieldpanel',padding:'10 50 0 10',items:[{xtype:'container',layout:'hbox',items:[{xtype:'container',width:400,style:'padding-right:50px',items:[{xtype:'component',bind:{html:'<div class="divInfoRow"><span class="spanLbe">姓名</span><span class="spanValue">{user_name}</span></span>({user_id})</span></div><div class="divInfoRow"><span class="spanLbe">职务</span><span class="spanValue">{def_role_name}<span></div><div class="divInfoRow"><span class="spanLbe">性别</span><span class="spanValue">{sex=="F"?"女":"男"}</span></div>'}},{xtype:'numberfield',label:'电话',bind:'{mobile}'},{xtype:'textfield',label:'邮箱',bind:'{email}'},{xtype:'textareafield',label:'签名',bind:'{notes}'}]},{xtype:'img',id:'userAva',src:Ext.getResourcePath('images/imdefault.png'),width:100,height:100,style:'cursor: pointer;border: solid 1px #ccc;',listeners:{tap:'onSelectAvt'}}]}]}],buttons:{btn1:{text:'保存',userCls:'btnEnter',handler:'onSave'},btn2:{text:'关闭',userCls:'btnCancel',handler:'onClose'}},initialize:function(){var b=this;b.callParent(arguments);var a=JSON.parse(cefUserEdit.getSettingData());User.fileFolder=a.settings.fileFolder;User.work_folder=a.settings.work_folder;User.work_folder_show=a.settings.work_folder_show;User.accountID=cefUserEdit.getAccountID();User.ownerID=cefUserEdit.getUserID();User.token=cefUserEdit.getToken();Config.IsPC=!0;var d=a.user;var f=b.getViewModel();f.setData(d);var c=b.down('#userAva');var e=ParseUtil.getLocalFileURL(ConfigMgr.getDataDirectory())+User.getUserAvaDir()+User.ownerID+'.png';c.setSrc(e)}});Ext.define('IMCef.cefSetting.tab.QrCodeInfo',{extend:'Ext.Container',xtype:'qrcodeinfo',data:{appName:'AIO8专业版'},tpl:'<div">\n    <div id="qrcode" style="float:left;padding: 5px;border: 1px solid #c1c0c0;border-radius: 3px;margin: 90px 0 auto 40px;"></div>\n    <div><img src="'+Ext.getResourcePath('images/qrcode.png',null,'IMCef')+'" style="width:300px"></div>\n    <div style="text-align:center;margin-top:15px">通过<span style="color:#5fa2dd">{appName}</span>扫描二维码，</div>\n    <div style="text-align:center;">进行账套设置</div>\n    </div>',initialize:function(){var a=this;a.callParent(arguments);a.on({scope:a,activate:'initQrCode'})},initQrCode:function(){var f=this;var c=f.el.query('#qrcode'),d='Host|AIO|'+Config.httpUrlForGo.replace('api/v1/','');var a='qrcodeloaded',b=Ext.getResourcePath('script/','shared','IMCef'),e=Ext.manifest.version;if(!RM.isDefined(a)){RM.load([b+'qrcode.min.js?v='+e],a);RM.ready(a,{success:function(){var a=new QRCode(c[0],{width:120,height:120});a.makeCode(d)}})}}});Ext.define('IMCef.cefSetting.tab.UpdateLogs',{extend:'Ext.List',xtype:'updateloglist',controller:'aboutcontroller',requires:['IMCef.cefSetting.tab.AboutController'],classCls:'updateloglist',itemsFocusable:!1,selectable:!1,scrollable:!0,disableSelection:!0,store:{fields:[{name:'updateAt',convert:function(a){a=Ext.Date.format(new Date(a),'Y年m月d日');return a}}]},itemTpl:'<tpl if="values.visiable">'+'<div class="itemRight">'+'<div class="displayInfo">'+'<div class="displayName">{version} 版本介绍</div>'+'<div class="displayMsg">{updateAt}</div>'+'</div>'+'</div>'+'</tpl>',items:[{xtype:'button',docked:'bottom',text:'返回',handler:'onBack'}],initialize:function(){var a=this;a.callParent(arguments);a.updateInfo();a.on({scope:a,childtap:'onTap'})},updateInfo:function(){this.getStore().add(LaunchPicture.PCJson())},onTap:function(b,a){b.up('aboutcontain').push({xtype:'updatelogdetail',content:a.record.data.content2})}});Ext.define('IMCef.cefSetting.tab.UpdateLogDetail',{extend:'Ext.Container',xtype:'updatelogdetail',controller:'aboutcontroller',requires:['IMCef.cefSetting.tab.AboutController'],classCls:'updatelogdetail',items:[{xtype:'button',docked:'bottom',text:'返回',handler:'onBack'},{xtype:'container',itemId:'itemContain'}],initialize:function(){var a=this;a.callParent(arguments);a.initItems()},initItems:function(){var d=this,e=d.down('#itemContain'),b=d.content,f,a=[],c=1;if(!b||b.length<1){return}b.forEach(function(b){var d='';switch(b.label){case 'h1':case 'h2':d='<div class="'+b.label+'">'+b.text+'</div>';c=1;break;case 'h3':d='<div class="h3">'+c+'.'+b.text+'</div>';c++;break;case 'dsc':d='<div class="dsc">-'+b.text+'</div>';break;default:break;}a.push(d)},this);a=a.join('');e.add({html:a})}});Ext.define('IMCef.cefSetting.widget.ChgAvaPanel',{extend:'Ext.Panel',xtype:'chgAvaPanel',closable:!0,closeAction:'hide',floated:!0,title:'头像设置',bodyPadding:20,layout:{type:'vbox',align:'stretch'},defaultListenerScope:!0,width:280,height:335,buttonAlign:'right',buttons:[{text:'本地上传',flex:1},{text:'保存',handler:'onSave'},{text:'取消',handler:'onCancle'}],onChooseFold:function(){var a=this;if(cefSetting){cefSetting.selectFileFolder(function(b){var d=a.down('#avaPanelImg');var c=b.replace(/\\/g,'/');c='localfile:///'+c;d.setSrc(b)})}},onSave:function(){var a=this.down('#avaPanelImg');var b=a.getSrc()},onCancle:function(){this.hide()},items:[{xtype:'img',itemId:'avaPanelImg',src:Ext.getResourcePath('images/imdefault.png'),width:200,height:200,style:'margin:auto;'}],initialize:function(){var a=this;a.callParent(arguments);a.on({show:'onShowPanel',hide:'onHidePanel',scope:a})},onShowPanel:function(b){var a=this;a.touchListeners=Ext.getDoc().on({touchstart:a.collapseIf,scope:a,delegated:!1,destroyable:!0})},collapseIf:function(b){var a=this;if(!a.destroyed&&!a.owns(b.target)){a.hide()}},onHidePanel:function(a){Ext.destroy(this.touchListeners)},doDestroy:function(){Ext.destroy(this.touchListeners);this.callParent()}});Ext.define('IMCef.view.fileMgr.CefFileMgrController',{extend:'Ext.app.ViewController',alias:'controller.ceffilemgrcontroller',init:function(){var a=this;var b=a.getView();a.callParent(arguments);a.handleCEF();a.initConParam();console.log(b)},initConParam:function(){var a=this;var b=a.getView();User.ownerID=cefFileMgr.getUserID();User.token=cefFileMgr.getToken();User.accountID=cefFileMgr.getAccountID();Config.isPC=!0;User.fileAll=!1;User.fileDoc=!1;User.filePic=!1;User.workAll=!1;User.workDoc=!1;User.workPic=!1;User.totalInfo=[];window.reInit=function(){console.log('这是重加载');Ext.Viewport.down('ceffilemgr').down('#all_check_box').el.dom.querySelector('.mgr_allchoice').children[0].checked=!1;Ext.Viewport.down('ceffilemgr').down('#cefworkfilelist').hide();Ext.Viewport.down('ceffilemgr').down('#ceffilelist').show();Ext.Viewport.down('ceffilemgr').down('#asp_time').setValue('all');Ext.Viewport.down('ceffilemgr').down('#set_line').setValue('timedown');Ext.Viewport.down('ceffilemgr').down('#midpanel_searchfield').clearValue();Ext.Viewport.down('ceffilemgr').down('#msgfile_all').setUserCls('left_active');Ext.Viewport.down('ceffilemgr').down('#msgfile_doc').setUserCls('msgfile_doc');Ext.Viewport.down('ceffilemgr').down('#msgfile_pic').setUserCls('msgfile_pic');var b='文件大小： '+'0'+'MB';var c='时间： '+'不限';var d='已选文件： '+'0'+'个';Ext.Viewport.down('ceffilemgr').down('#allfilenum').setHtml(d);Ext.Viewport.down('ceffilemgr').down('#allfilesize').setHtml(b);Ext.Viewport.down('ceffilemgr').down('#allfiletime').setHtml(c);User.totalInfo=[];var e=0;var a='ORDER BY F.CreateAt DESC limit 50;';User.fileAll=!0;User.fileDoc=!1;User.filePic=!1;User.workAll=!1;User.workDoc=!1;User.workPic=!1;LocalSearchMgr.searchLastFileByFileMgr(e,a,function(e,d){var a=d.rows;if(a.length>0){Ext.Viewport.down('ceffilemgr').down('#ceffilelist').show();Ext.Viewport.down('ceffilemgr').down('#thereisNone').hide();var c=Ext.getStore('file_mgrlist');c.removeAll();for(var b=0;b<a.length;b++){c.add({fileName:a.item(b).FileName,updateTime:a.item(b).CreateAt,senderName:a.item(b).SenderName,fileSize:a.item(b).FileSize,fileStatus:a.item(b).FileStatus,filePath:a.item(b).FilePath,msgID:a.item(b).MsgID,baseID:a.item(b).BaseID,chatType:a.item(b).ChatType,displayName:a.item(b).DisplayName,showPart:'allFile'})}}else {Ext.Viewport.down('ceffilemgr').down('#ceffilelist').hide();Ext.Viewport.down('ceffilemgr').down('#thereisNone').show()}})}},handleCEF:function(){var a=this;a.addListeners()},addListeners:function(){this.changeFilestatus();this.changeWorkFilestatus()},changeFilestatus:function(){window.changeFilestatus=function(d){var a=JSON.parse(d);if(a[0].isTable=='fileList'){var b=Ext.getStore('file_mgrlist').getById(a[0].fileId);b.set({fileStatus:1});var c='UPDATE IMFile SET FileStatus = ? WHERE BaseID = ?;';LocalDataMgr.cExecSqlWithP(c,[1,a[0].fileId])}else {if(a[0].isTable=='workList'){var b=Ext.getStore('workfile_mgrlist').getById(a[0].fileId);b.set({fileStatus:1});var c='UPDATE IMWFile SET FileStatus = ? WHERE ID = ?;';LocalDataMgr.cExecSqlWithP(c,[1,a[0].fileId])}}}},changeWorkFilestatus:function(){window.changeWorkFilestatus=function(a){var b='SELECT * FROM IMWFile WHERE FileID=?;';LocalDataMgr.cExecSqlWithP(b,[a],function(e,c){if(c.rows.length>0){var b=c.rows.item(0);var d=Ext.getStore('workfile_mgrlist').getById(b.ID);d.set({fileStatus:0,filePath:b.FilePath})}})}},open_msgfileAll:function(){var a=this;if(!User.fileAll){this.getView().el.dom.querySelector('.mgr_allchoice').children[0].checked=!1;this.getView().lookup('cefworkfilelist').hide();this.getView().lookup('ceffilelist').show();this.getView().lookup('asp_time').setValue('all');this.getView().lookup('set_line').setValue('timedown');this.getView().lookup('midpanel_searchfield').clearValue();this.getView().lookup('msgfile_all').setUserCls('left_active');this.getView().lookup('msgfile_doc').setUserCls('msgfile_doc');this.getView().lookup('msgfile_pic').setUserCls('msgfile_pic');var c='文件大小： '+'0'+'MB';var d='时间： '+'不限';var e='已选文件： '+'0'+'个';this.getView().lookup('allfilenum').setHtml(e);this.getView().lookup('allfilesize').setHtml(c);this.getView().lookup('allfiletime').setHtml(d);User.totalInfo=[];var f=0;var b='ORDER BY F.CreateAt DESC limit 50;';User.fileAll=!0;User.fileDoc=!1;User.filePic=!1;User.workAll=!1;User.workDoc=!1;User.workPic=!1;LocalSearchMgr.searchLastFileByFileMgr(f,b,function(f,e){var b=e.rows;if(b.length>0){a.getView().lookup('ceffilelist').show();a.getView().lookup('thereisNone').hide();var d=Ext.getStore('file_mgrlist');d.removeAll();for(var c=0;c<b.length;c++){d.add({fileName:b.item(c).FileName,updateTime:b.item(c).CreateAt,senderName:b.item(c).SenderName,fileSize:b.item(c).FileSize,fileStatus:b.item(c).FileStatus,filePath:b.item(c).FilePath,msgID:b.item(c).MsgID,baseID:b.item(c).BaseID,chatType:b.item(c).ChatType,displayName:b.item(c).DisplayName,showPart:'allFile'})}}else {a.getView().lookup('ceffilelist').hide();a.getView().lookup('thereisNone').show()}})}},open_msgfilePic:function(){var a=this;if(!User.filePic){this.getView().el.dom.querySelector('.mgr_allchoice').children[0].checked=!1;this.getView().lookup('cefworkfilelist').hide();this.getView().lookup('ceffilelist').show();this.getView().lookup('asp_time').setValue('all');this.getView().lookup('set_line').setValue('timedown');this.getView().lookup('midpanel_searchfield').clearValue();this.getView().lookup('msgfile_all').setUserCls('msgfile_all');this.getView().lookup('msgfile_doc').setUserCls('msgfile_doc');this.getView().lookup('msgfile_pic').setUserCls('left_active');var c='文件大小： '+'0'+'MB';var d='时间： '+'不限';var e='已选文件： '+'0'+'个';this.getView().lookup('allfilenum').setHtml(e);this.getView().lookup('allfilesize').setHtml(c);this.getView().lookup('allfiletime').setHtml(d);User.totalInfo=[];var f=0;var b='ORDER BY F.CreateAt DESC limit 50;';User.fileAll=!1;User.fileDoc=!1;User.filePic=!0;User.workAll=!1;User.workDoc=!1;User.workPic=!1;LocalSearchMgr.searchLastFileByFileMgrIsPic(f,b,function(f,e){var b=e.rows;if(b.length>0){a.getView().lookup('ceffilelist').show();a.getView().lookup('thereisNone').hide();var d=Ext.getStore('file_mgrlist');d.removeAll();for(var c=0;c<b.length;c++){d.add({fileName:b.item(c).FileName,updateTime:b.item(c).CreateAt,senderName:b.item(c).SenderName,fileSize:b.item(c).FileSize,fileStatus:b.item(c).FileStatus,filePath:b.item(c).FilePath,msgID:b.item(c).MsgID,baseID:b.item(c).BaseID,chatType:b.item(c).ChatType,displayName:b.item(c).DisplayName,showPart:'isPicFile'})}}else {a.getView().lookup('ceffilelist').hide();a.getView().lookup('thereisNone').show()}})}},open_msgfileDoc:function(){var a=this;if(!User.fileDoc){this.getView().el.dom.querySelector('.mgr_allchoice').children[0].checked=!1;this.getView().lookup('cefworkfilelist').hide();this.getView().lookup('ceffilelist').show();this.getView().lookup('asp_time').setValue('all');this.getView().lookup('set_line').setValue('timedown');this.getView().lookup('midpanel_searchfield').clearValue();this.getView().lookup('msgfile_all').setUserCls('msgfile_all');this.getView().lookup('msgfile_doc').setUserCls('left_active');this.getView().lookup('msgfile_pic').setUserCls('msgfile_pic');var c='文件大小： '+'0'+'MB';var d='时间： '+'不限';var e='已选文件： '+'0'+'个';this.getView().lookup('allfilenum').setHtml(e);this.getView().lookup('allfilesize').setHtml(c);this.getView().lookup('allfiletime').setHtml(d);User.totalInfo=[];var f=0;var b='ORDER BY F.CreateAt DESC limit 50;';User.fileAll=!1;User.fileDoc=!0;User.filePic=!1;User.workAll=!1;User.workDoc=!1;User.workPic=!1;LocalSearchMgr.searchLastFileByFileMgrIsNoPic(f,b,function(f,e){var b=e.rows;if(b.length>0){a.getView().lookup('ceffilelist').show();a.getView().lookup('thereisNone').hide();var d=Ext.getStore('file_mgrlist');d.removeAll();for(var c=0;c<b.length;c++){d.add({fileName:b.item(c).FileName,updateTime:b.item(c).CreateAt,senderName:b.item(c).SenderName,fileSize:b.item(c).FileSize,fileStatus:b.item(c).FileStatus,filePath:b.item(c).FilePath,msgID:b.item(c).MsgID,baseID:b.item(c).BaseID,chatType:b.item(c).ChatType,displayName:b.item(c).DisplayName,showPart:'isNoPicFile'})}}else {a.getView().lookup('ceffilelist').hide();a.getView().lookup('thereisNone').show()}})}},open_workfileAll:function(){var a=this;if(!User.workAll){this.getView().el.dom.querySelector('.mgr_allchoice').children[0].checked=!1;this.getView().lookup('ceffilelist').hide();this.getView().lookup('cefworkfilelist').show();this.getView().lookup('asp_time').setValue('all');this.getView().lookup('set_line').setValue('timedown');this.getView().lookup('midpanel_searchfield').clearValue();this.getView().lookup('msgfile_all').setUserCls('msgfile_all');this.getView().lookup('msgfile_doc').setUserCls('msgfile_doc');this.getView().lookup('msgfile_pic').setUserCls('msgfile_pic');var c='文件大小： '+'0'+'MB';var d='时间： '+'不限';var e='已选文件： '+'0'+'个';this.getView().lookup('allfilenum').setHtml(e);this.getView().lookup('allfilesize').setHtml(c);this.getView().lookup('allfiletime').setHtml(d);User.totalInfo=[];var f=0;var b='ORDER BY W.CreateAt DESC limit 50;';User.workAll=!0;User.workDoc=!1;User.workPic=!1;User.fileAll=!1;User.fileDoc=!1;User.filePic=!1;LocalSearchMgr.searchLastFileByWorkDeskFileMgr(f,b,function(f,e){var b=e.rows;if(b.length>0){a.getView().lookup('cefworkfilelist').show();a.getView().lookup('thereisNone').hide();var d=Ext.getStore('workfile_mgrlist');d.removeAll();for(var c=0;c<b.length;c++){d.add({fileName:b.item(c).FileName,updateTime:b.item(c).CreateAt,remoteUrl:b.item(c).RemoteUrl,fileSize:b.item(c).FileSize,fileStatus:b.item(c).FileStatus,filePath:b.item(c).FilePath,baseID:b.item(c).ID,showPart:'allFile'})}}else {a.getView().lookup('cefworkfilelist').hide();a.getView().lookup('thereisNone').show()}})}},open_workfileDoc:function(){var a=this;if(!User.workDoc){this.getView().el.dom.querySelector('.mgr_allchoice').children[0].checked=!1;this.getView().lookup('ceffilelist').hide();this.getView().lookup('cefworkfilelist').show();this.getView().lookup('asp_time').setValue('all');this.getView().lookup('set_line').setValue('timedown');this.getView().lookup('midpanel_searchfield').clearValue();this.getView().lookup('msgfile_all').setUserCls('msgfile_all');this.getView().lookup('msgfile_doc').setUserCls('msgfile_doc');this.getView().lookup('msgfile_pic').setUserCls('msgfile_pic');var c='文件大小： '+'0'+'MB';var d='时间： '+'不限';var e='已选文件： '+'0'+'个';this.getView().lookup('allfilenum').setHtml(e);this.getView().lookup('allfilesize').setHtml(c);this.getView().lookup('allfiletime').setHtml(d);User.totalInfo=[];var f=0;var b='ORDER BY W.CreateAt DESC limit 50;';User.workAll=!1;User.workDoc=!0;User.workPic=!1;User.fileAll=!1;User.fileDoc=!1;User.filePic=!1;LocalSearchMgr.searchLastFileByWorkDeskFileMgrIsNoPic(f,b,function(f,e){var b=e.rows;if(b.length>0){a.getView().lookup('cefworkfilelist').show();a.getView().lookup('thereisNone').hide();var d=Ext.getStore('workfile_mgrlist');d.removeAll();for(var c=0;c<b.length;c++){d.add({fileName:b.item(c).FileName,updateTime:b.item(c).CreateAt,remoteUrl:b.item(c).RemoteUrl,fileSize:b.item(c).FileSize,fileStatus:b.item(c).FileStatus,filePath:b.item(c).FilePath,baseID:b.item(c).ID,showPart:'isNoPicFile'})}}else {a.getView().lookup('cefworkfilelist').hide();a.getView().lookup('thereisNone').show()}})}},open_workfilePic:function(){var a=this;if(!User.workPic){this.getView().el.dom.querySelector('.mgr_allchoice').children[0].checked=!1;this.getView().lookup('ceffilelist').hide();this.getView().lookup('cefworkfilelist').show();this.getView().lookup('asp_time').setValue('all');this.getView().lookup('set_line').setValue('timedown');this.getView().lookup('midpanel_searchfield').clearValue();this.getView().lookup('msgfile_all').setUserCls('msgfile_all');this.getView().lookup('msgfile_doc').setUserCls('msgfile_doc');this.getView().lookup('msgfile_pic').setUserCls('msgfile_pic');var c='文件大小： '+'0'+'MB';var d='时间： '+'不限';var e='已选文件： '+'0'+'个';this.getView().lookup('allfilenum').setHtml(e);this.getView().lookup('allfilesize').setHtml(c);this.getView().lookup('allfiletime').setHtml(d);User.totalInfo=[];var f=0;var b='ORDER BY W.CreateAt DESC limit 50;';User.workAll=!1;User.workDoc=!1;User.workPic=!0;User.fileAll=!1;User.fileDoc=!1;User.filePic=!1;LocalSearchMgr.searchLastFileByWorkDeskFileMgrIsPic(f,b,function(f,e){var b=e.rows;if(b.length>0){a.getView().lookup('cefworkfilelist').show();a.getView().lookup('thereisNone').hide();var d=Ext.getStore('workfile_mgrlist');d.removeAll();for(var c=0;c<b.length;c++){d.add({fileName:b.item(c).FileName,updateTime:b.item(c).CreateAt,remoteUrl:b.item(c).RemoteUrl,fileSize:b.item(c).FileSize,fileStatus:b.item(c).FileStatus,filePath:b.item(c).FilePath,baseID:b.item(c).ID,showPart:'isPicFile'})}}else {a.getView().lookup('cefworkfilelist').hide();a.getView().lookup('thereisNone').show()}})}},ontapList:function(o,a){var m=this;if(Ext.fly(a.event.target).dom.innerHTML=='打开'){var k=[];var c=a.record.data.filePath;var b=a.record.data.baseID;if(!c.startsWith('file://')){c=ConfigMgr.getDefaultDir()+c}k.push({path:c,fileId:b,isTable:'fileList'});cefFileMgr.exec('doCefOpenFileMgr',JSON.stringify(k))}else {if(Ext.fly(a.event.target).dom.innerHTML=='下载'){var b=a.record.data.baseID;var n='SELECT F.ChatID, F.FileID, F.FileName, F.FileSize, M.MsgID, M.CreateAt FROM IMFile F\n                        LEFT JOIN IMMsg M ON F.BaseID=M.ID  \n                        WHERE F.BaseID=?;';LocalDataMgr.cExecSqlWithP(n,[b],function(e,d){if(d.rows.length>0){var c=d.rows.item(0);m.downloadFile(c.ChatID,c.FileID,c.FileName,c.FileSize,c.MsgID,c.CreateAt,b)}})}else {if(Ext.fly(a.event.target).el.dom.getAttribute('type')=='checkbox'){Ext.Viewport.down('ceffilemgr').down('#allfiletotal').show();if(!Ext.fly(a.event.target).el.dom.checked){var l=function(b){return function(e,f){var c=e[b];var d=f[b];if(!isNaN(Number(c))&&!isNaN(Number(d))){c=Number(c);d=Number(d)}if(c<d){return -1}else {if(c>d){return 1}else {return 0}}}};User.totalInfo.push(a.record.data);User.totalInfo.sort(l('updateTime'))}else {for(var d=0;d<User.totalInfo.length;d++){if(User.totalInfo[d].baseID==a.record.data.baseID){User.totalInfo.splice(d,1)}}}var e=0;for(var j=0;j<User.totalInfo.length;j++){e+=User.totalInfo[j].fileSize}if(User.totalInfo.length>0){var f='文件大小： '+(e/1048576>0.1?(e/1048576).toFixed(1):0.1).toString()+'MB';var g='已选文件： '+User.totalInfo.length.toString()+'个';Ext.Viewport.down('ceffilemgr').down('#allfilenum').setHtml(g);Ext.Viewport.down('ceffilemgr').down('#allfilesize').setHtml(f)}else {var f='文件大小： '+'0'+'MB';var g='已选文件： '+'0'+'个';Ext.Viewport.down('ceffilemgr').down('#allfilenum').setHtml(g);Ext.Viewport.down('ceffilemgr').down('#allfilesize').setHtml(f)}}else {if(Ext.fly(a.event.target).dom.className=='toChat'){var h=a.record.data.baseID;var i='SELECT * FROM IMMsg WHERE ID=?;';LocalDataMgr.cExecSqlWithP(i,[h],function(e,b){if(b.rows.length>0){var c=b.rows.item(0);var d=c.ChatID;cefFileMgr.exec('cefOpenChat',d)}})}else {if(Ext.fly(a.event.target).dom.className=='toChatByOne'){var h=a.record.data.baseID;var i='SELECT * FROM IMMsg WHERE ID=?;';LocalDataMgr.cExecSqlWithP(i,[h],function(g,e){if(e.rows.length>0){var c=e.rows.item(0);var d=c.SenderID;var f=c.SenderName;if(User.ownerID!=d){var b=[];b.push({uid:d,uName:f});cefFileMgr.exec('cefOpenDicChat',JSON.stringify(b))}}})}}}}}},ontapworkList:function(l,a){if(Ext.fly(a.event.target).dom.innerHTML=='打开'){var h=[];var j=a.record.data.filePath;var f=a.record.data.baseID;h.push({path:j,fileId:f,isTable:'workList'});cefFileMgr.exec('doCefOpenFileMgr',JSON.stringify(h))}else {if(Ext.fly(a.event.target).dom.innerHTML=='下载'){var f=a.record.data.baseID;var k='SELECT * FROM IMWFile WHERE ID=?;';LocalDataMgr.cExecSqlWithP(k,[f],function(d,c){if(c.rows.length>0){var b=c.rows.item(0);cefFileMgr.downloadFile(b.RemoteUrl,b.FileID)}})}else {if(Ext.fly(a.event.target).el.dom.getAttribute('type')=='checkbox'){Ext.Viewport.down('ceffilemgr').down('#allfiletotal').show();if(!Ext.fly(a.event.target).el.dom.checked){var i=function(b){return function(e,f){var c=e[b];var d=f[b];if(!isNaN(Number(c))&&!isNaN(Number(d))){c=Number(c);d=Number(d)}if(c<d){return -1}else {if(c>d){return 1}else {return 0}}}};User.totalInfo.push(a.record.data);User.totalInfo.sort(i('updateTime'))}else {for(var b=0;b<User.totalInfo.length;b++){if(User.totalInfo[b].baseID==a.record.data.baseID){User.totalInfo.splice(b,1)}}}var c=0;for(var g=0;g<User.totalInfo.length;g++){c+=User.totalInfo[g].fileSize}if(User.totalInfo.length>0){var d='文件大小： '+(c/1048576>0.1?(c/1048576).toFixed(1):0.1).toString()+'MB';var e='已选文件： '+User.totalInfo.length.toString()+'个';Ext.Viewport.down('ceffilemgr').down('#allfilenum').setHtml(e);Ext.Viewport.down('ceffilemgr').down('#allfilesize').setHtml(d)}else {var d='文件大小： '+'0'+'MB';var e='已选文件： '+'0'+'个';Ext.Viewport.down('ceffilemgr').down('#allfilenum').setHtml(e);Ext.Viewport.down('ceffilemgr').down('#allfilesize').setHtml(d)}}}}},downloadFile:function(c,a,h,j,d,e,g){if(!c){return}if(!a){return}if(!d){return}var k=this;var i=DownFileMgr.getFullFileUrl(a),b=ParseUtil.getCFileDir(e),f=h;if(Ext.browser.is.Cordova||Config.isPC){FileMgr.solveDup(null,b,f).then(function(k){var f=(b+k).replace(/%/g,'%25');FileMgr.downFile(i,1,f,{downloading:function(b){},slove:!0}).then(function(f){var b=f.path;if(Config.isPhone){b=decodeURIComponent(b)}var i=Ext.getStore('file_mgrlist').getById(g);i.set({fileStatus:0,filePath:b});Utils.custAjax('get','files/'+a+'/info',{success:function(i){i.chat_id=c;i.msg_id=d;LocalDataMgr.afterDownFileSuc(i,b)},failure:function(b){Utils.toastShort(b);console.error('DownFileMgr','getFileInfo failed',b);var i='UPDATE IMFile SET FileStatus=? WHERE FileID=?;';LocalDataMgr.cExecSqlWithP(i,[0,a])}})})['catch'](function(b){console.error('DownFileMgr','downFile failed',b)})})['catch'](function(b){console.error('DownFileMgr','solveDup failed',b)})}},oncheckAll:function(l,i){var e=this;if(i.checked==!0){if(!e.getView().lookup('ceffilelist').isHidden()){var a=e.getView().lookup('ceffilelist').innerItems;if(a!=null){if(a.length>0){for(var b=0;b<a.length;b++){a[b].el.dom.querySelector('.mgr_fileList_box').children[0].checked=!0}}var c=Ext.getStore('file_mgrlist');User.totalInfo=[];if(c.data.length>0){var k=function(a){return function(d,e){var b=d[a];var c=e[a];if(!isNaN(Number(b))&&!isNaN(Number(c))){b=Number(b);c=Number(c)}if(b<c){return -1}else {if(b>c){return 1}else {return 0}}}};var f=0;for(var d=0;d<c.data.length;d++){f+=c.data.items[d].data.fileSize;User.totalInfo.push(c.data.items[d].data)}var g='文件大小： '+(f/1048576>0.1?(f/1048576).toFixed(1):0.1).toString()+'MB';var h='已选文件： '+c.data.length.toString()+'个';Ext.Viewport.down('ceffilemgr').down('#allfilenum').setHtml(h);Ext.Viewport.down('ceffilemgr').down('#allfilesize').setHtml(g);User.totalInfo.sort(k('updateTime'))}}}if(!e.getView().lookup('cefworkfilelist').isHidden()){var a=e.getView().lookup('cefworkfilelist').innerItems;if(a!=null){if(a.length>0){for(var b=0;b<a.length;b++){a[b].el.dom.querySelector('.mgr_workfileList_box').children[0].checked=!0}}var c=Ext.getStore('workfile_mgrlist');User.totalInfo=[];if(c.data.length>0){var j=function(a){return function(d,e){var b=d[a];var c=e[a];if(!isNaN(Number(b))&&!isNaN(Number(c))){b=Number(b);c=Number(c)}if(b<c){return -1}else {if(b>c){return 1}else {return 0}}}};var f=0;for(var d=0;d<c.data.length;d++){f+=c.data.items[d].data.fileSize;User.totalInfo.push(c.data.items[d].data)}var g='文件大小： '+(f/1048576>0.1?(f/1048576).toFixed(1):0.1).toString()+'MB';var h='已选文件： '+c.data.length.toString()+'个';Ext.Viewport.down('ceffilemgr').down('#allfilenum').setHtml(h);Ext.Viewport.down('ceffilemgr').down('#allfilesize').setHtml(g);User.totalInfo.sort(j('updateTime'))}}}}else {if(i.checked==!1){if(!e.getView().lookup('ceffilelist').isHidden()){var a=e.getView().lookup('ceffilelist').innerItems;if(a!=null){if(a.length>0){for(var b=0;b<a.length;b++){a[b].el.dom.querySelector('.mgr_fileList_box').children[0].checked=!1}}}User.totalInfo=[];var g='文件大小： '+'0'+'MB';var h='已选文件： '+'0'+'个';Ext.Viewport.down('ceffilemgr').down('#allfilenum').setHtml(h);Ext.Viewport.down('ceffilemgr').down('#allfilesize').setHtml(g)}if(!e.getView().lookup('cefworkfilelist').isHidden()){var a=e.getView().lookup('cefworkfilelist').innerItems;if(a!=null){if(a.length>0){for(var b=0;b<a.length;b++){a[b].el.dom.querySelector('.mgr_workfileList_box').children[0].checked=!1}}}User.totalInfo=[];var g='文件大小： '+'0'+'MB';var h='已选文件： '+'0'+'个';Ext.Viewport.down('ceffilemgr').down('#allfilenum').setHtml(h);Ext.Viewport.down('ceffilemgr').down('#allfilesize').setHtml(g)}}}},allCpoy:function(h,i){var d=this;if(h.getText()=='批量复制'){if(!d.getView().lookup('ceffilelist').isHidden()){var e=[];var a=d.getView().lookup('ceffilelist').innerItems;if(a!=null){if(a.length>0){for(var c=0;c<a.length;c++){if(a[c].el.dom.querySelector('.mgr_fileList_box').children[0].checked==!0){var f=a[c].getRecord().data;var b=f.filePath;if(!b.startsWith('file://')){b=ConfigMgr.getDefaultDir()+b}e.push({path:b})}}d.doAllCopy(e)}}}if(!d.getView().lookup('cefworkfilelist').isHidden()){var e=[];var a=d.getView().lookup('cefworkfilelist').innerItems;if(a!=null){if(a.length>0){for(var c=0;c<a.length;c++){if(a[c].el.dom.querySelector('.mgr_workfileList_box').children[0].checked==!0){var f=a[c].getRecord().data;var b=f.filePath;var g=/file:[\/]+/g;if(!g.test(b)){b=b}e.push({path:b})}}d.doAllCopy(e)}}}}},allDel:function(e,f){var c=this;if(e.getText()=='批量删除'){if(!c.getView().lookup('ceffilelist').isHidden()){var b=c.getView().lookup('ceffilelist').innerItems;var d=Ext.getStore('file_mgrlist');var a=[];if(b!=null){if(b.length>0){Ext.Msg.confirm('温馨提示','确定要删除吗',function(r){if(r=='yes'){for(var h=0;h<b.length;h++){if(b[h].el.dom.querySelector('.mgr_fileList_box').children[0].checked==!0){var p=b[h].getRecord().data;var q=p.baseID;a.push(q)}}var o=[];for(var i=0;i<a.length;i++){var c=Ext.getStore('file_mgrlist').getById(a[i]);var n=c.data.filePath;if(!c.data.filePath.startsWith('file://')){n=ConfigMgr.getDefaultDir()+c.data.filePath}o.push({path:n});d.remove(c);if(User.totalInfo.length>0){for(var g=0;g<User.totalInfo.length;g++){if(User.totalInfo[g].baseID==a[i]){User.totalInfo.splice(g,1)}}var j=0;for(var m=0;m<User.totalInfo.length;m++){j+=User.totalInfo[m].fileSize}if(User.totalInfo.length>0){var k='文件大小： '+(j/1048576>0.1?(j/1048576).toFixed(1):0.1).toString()+'MB';var l='已选文件： '+User.totalInfo.length.toString()+'个';Ext.Viewport.down('ceffilemgr').down('#allfilenum').setHtml(l);Ext.Viewport.down('ceffilemgr').down('#allfilesize').setHtml(k)}else {var k='文件大小： '+'0'+'MB';var l='已选文件： '+'0'+'个';Ext.Viewport.down('ceffilemgr').down('#allfilenum').setHtml(l);Ext.Viewport.down('ceffilemgr').down('#allfilesize').setHtml(k)}}}cefFileMgr.exec('doCefDelFile',JSON.stringify(o));LocalDataMgr.delFilelist(a)}})}}}if(!c.getView().lookup('cefworkfilelist').isHidden()){var b=c.getView().lookup('cefworkfilelist').innerItems;var d=Ext.getStore('workfile_mgrlist');var a=[];if(b!=null){if(b.length>0){Ext.Msg.confirm('温馨提示','确定要删除吗',function(q){if(q=='yes'){for(var g=0;g<b.length;g++){if(b[g].el.dom.querySelector('.mgr_workfileList_box').children[0].checked==!0){var o=b[g].getRecord().data;var p=o.baseID;a.push(p)}}var m=[];for(var h=0;h<a.length;h++){var n=Ext.getStore('workfile_mgrlist').getById(a[h]);m.push({path:'file:///'+n.data.filePath});d.remove(n);if(User.totalInfo.length>0){for(var c=0;c<User.totalInfo.length;c++){if(User.totalInfo[c].baseID==a[h]){User.totalInfo.splice(c,1)}}var i=0;for(var l=0;l<User.totalInfo.length;l++){i+=User.totalInfo[l].fileSize}if(User.totalInfo.length>0){var j='文件大小： '+(i/1048576>0.1?(i/1048576).toFixed(1):0.1).toString()+'MB';var k='已选文件： '+User.totalInfo.length.toString()+'个';Ext.Viewport.down('ceffilemgr').down('#allfilenum').setHtml(k);Ext.Viewport.down('ceffilemgr').down('#allfilesize').setHtml(j)}else {var j='文件大小： '+'0'+'MB';var k='已选文件： '+'0'+'个';Ext.Viewport.down('ceffilemgr').down('#allfilenum').setHtml(k);Ext.Viewport.down('ceffilemgr').down('#allfilesize').setHtml(j)}}}cefFileMgr.exec('doCefDelFile',JSON.stringify(m));LocalDataMgr.delWorkFilelist(a)}})}}}}},doAllCopy:function(a){if(window.cefFileMgr){cefFileMgr.exec('doCefFileCopy',JSON.stringify(a))}},onchangeTime:function(k,e){var a=this;var h=this;var c;var d=h.getView().lookup('midpanel_searchfield').getValue();var g=h.getView().lookup('set_line').getValue();var b;var f;User.totalInfo=[];var i='文件大小： '+'0'+'MB';var j='已选文件： '+'0'+'个';h.getView().lookup('allfilenum').setHtml(j);h.getView().lookup('allfilesize').setHtml(i);if(e=='all'){f='时间：'+'不限';if(Ext.Viewport.down('ceffilemgr')){Ext.Viewport.down('ceffilemgr').down('#allfiletime').setHtml(f)}c=0}else {if(e=='oneMonth'){f='时间：'+Utils.date2Str(Ext.Date.add(new Date(),Ext.Date.DAY,-30).getTime()).toString()+'到'+Utils.date2Str((new Date()).getTime()).toString();Ext.Viewport.down('ceffilemgr').down('#allfiletime').setHtml(f);c=Ext.Date.add(new Date(),Ext.Date.DAY,-30).getTime()}else {if(e=='threeMonth'){f='时间：'+Utils.date2Str(Ext.Date.add(new Date(),Ext.Date.DAY,-90).getTime()).toString()+'到'+Utils.date2Str((new Date()).getTime()).toString();Ext.Viewport.down('ceffilemgr').down('#allfiletime').setHtml(f);c=Ext.Date.add(new Date(),Ext.Date.DAY,-90).getTime()}else {if(e=='oneYear'){f='时间：'+Utils.date2Str(Ext.Date.add(new Date(),Ext.Date.DAY,-365).getTime()).toString()+'到'+Utils.date2Str((new Date()).getTime()).toString();Ext.Viewport.down('ceffilemgr').down('#allfiletime').setHtml(f);c=Ext.Date.add(new Date(),Ext.Date.DAY,-365).getTime()}}}}if(!h.getView().lookup('ceffilelist').isHidden()||!this.getView().lookup('thereisNone').isHidden()){if(g=='timedown'){b='ORDER BY F.CreateAt DESC limit 50;'}else {if(g=='timeup'){b='ORDER BY F.CreateAt ASC limit 50;'}else {if(g=='sizedown'){b='ORDER BY F.FileSize DESC limit 50;'}else {if(g=='sizeup'){b='ORDER BY F.FileSize ASC limit 50;'}else {if(g=='namedown'){b='ORDER BY F.FileName DESC limit 50;'}else {if(g=='nameup'){b='ORDER BY F.FileName ASC limit 50;'}}}}}}if(d==''||d==null){if(User.fileAll){LocalSearchMgr.searchLastFileByFileMgr(c,b,function(g,f){var b=f.rows;if(b.length>0){a.getView().lookup('ceffilelist').show();a.getView().lookup('thereisNone').hide();var d=Ext.getStore('file_mgrlist');d.removeAll();for(var c=0;c<b.length;c++){d.add({fileName:b.item(c).FileName,updateTime:b.item(c).CreateAt,senderName:b.item(c).SenderName,fileSize:b.item(c).FileSize,fileStatus:b.item(c).FileStatus,filePath:b.item(c).FilePath,msgID:b.item(c).MsgID,baseID:b.item(c).BaseID,chatType:b.item(c).ChatType,displayName:b.item(c).DisplayName,showPart:'allFile'})}}else {a.getView().lookup('ceffilelist').hide();a.getView().lookup('thereisNone').show()}})}else {if(User.fileDoc){LocalSearchMgr.searchLastFileByFileMgrIsNoPic(c,b,function(g,f){var b=f.rows;if(b.length>0){a.getView().lookup('ceffilelist').show();a.getView().lookup('thereisNone').hide();var d=Ext.getStore('file_mgrlist');d.removeAll();for(var c=0;c<b.length;c++){d.add({fileName:b.item(c).FileName,updateTime:b.item(c).CreateAt,senderName:b.item(c).SenderName,fileSize:b.item(c).FileSize,fileStatus:b.item(c).FileStatus,filePath:b.item(c).FilePath,msgID:b.item(c).MsgID,baseID:b.item(c).BaseID,chatType:b.item(c).ChatType,displayName:b.item(c).DisplayName,showPart:'isPicFile'})}}else {a.getView().lookup('ceffilelist').hide();a.getView().lookup('thereisNone').show()}})}else {if(User.filePic){LocalSearchMgr.searchLastFileByFileMgrIsPic(c,b,function(g,f){var b=f.rows;if(b.length>0){a.getView().lookup('ceffilelist').show();a.getView().lookup('thereisNone').hide();var d=Ext.getStore('file_mgrlist');d.removeAll();for(var c=0;c<b.length;c++){d.add({fileName:b.item(c).FileName,updateTime:b.item(c).CreateAt,senderName:b.item(c).SenderName,fileSize:b.item(c).FileSize,fileStatus:b.item(c).FileStatus,filePath:b.item(c).FilePath,msgID:b.item(c).MsgID,baseID:b.item(c).BaseID,chatType:b.item(c).ChatType,displayName:b.item(c).DisplayName,showPart:'isPicFile'})}}else {a.getView().lookup('ceffilelist').hide();a.getView().lookup('thereisNone').show()}})}}}}else {if(User.fileAll){LocalSearchMgr.searchPCByFileList(c,b,d,function(g,f){var b=f.rows;if(b.length>0){a.getView().lookup('ceffilelist').show();a.getView().lookup('thereisNone').hide();var d=Ext.getStore('file_mgrlist');d.removeAll();for(var c=0;c<b.length;c++){d.add({fileName:b.item(c).FileName,updateTime:b.item(c).CreateAt,senderName:b.item(c).SenderName,fileSize:b.item(c).FileSize,fileStatus:b.item(c).FileStatus,filePath:b.item(c).FilePath,msgID:b.item(c).MsgID,baseID:b.item(c).BaseID,chatType:b.item(c).ChatType,displayName:b.item(c).DisplayName,showPart:'allFile'})}}else {a.getView().lookup('ceffilelist').hide();a.getView().lookup('thereisNone').show()}})}else {if(User.fileDoc){LocalSearchMgr.searchPCByFileListIsNoPic(c,b,d,function(g,f){var b=f.rows;if(b.length>0){a.getView().lookup('ceffilelist').show();a.getView().lookup('thereisNone').hide();var d=Ext.getStore('file_mgrlist');d.removeAll();for(var c=0;c<b.length;c++){d.add({fileName:b.item(c).FileName,updateTime:b.item(c).CreateAt,senderName:b.item(c).SenderName,fileSize:b.item(c).FileSize,fileStatus:b.item(c).FileStatus,filePath:b.item(c).FilePath,msgID:b.item(c).MsgID,baseID:b.item(c).BaseID,chatType:b.item(c).ChatType,displayName:b.item(c).DisplayName,showPart:'allFile'})}}else {a.getView().lookup('ceffilelist').hide();a.getView().lookup('thereisNone').show()}})}else {if(User.filePic){LocalSearchMgr.searchPCByFileListIsPic(c,b,d,function(g,f){var b=f.rows;if(b.length>0){a.getView().lookup('ceffilelist').show();a.getView().lookup('thereisNone').hide();var d=Ext.getStore('file_mgrlist');d.removeAll();for(var c=0;c<b.length;c++){d.add({fileName:b.item(c).FileName,updateTime:b.item(c).CreateAt,senderName:b.item(c).SenderName,fileSize:b.item(c).FileSize,fileStatus:b.item(c).FileStatus,filePath:b.item(c).FilePath,msgID:b.item(c).MsgID,baseID:b.item(c).BaseID,chatType:b.item(c).ChatType,displayName:b.item(c).DisplayName,showPart:'allFile'})}}else {a.getView().lookup('ceffilelist').hide();a.getView().lookup('thereisNone').show()}})}}}}}if(!h.getView().lookup('cefworkfilelist').isHidden()||!this.getView().lookup('thereisNone').isHidden()){if(e=='timedown'){b='ORDER BY W.CreateAt DESC limit 50;'}else {if(e=='timeup'){b='ORDER BY W.CreateAt ASC limit 50;'}else {if(e=='sizedown'){b='ORDER BY W.FileSize DESC limit 50;'}else {if(e=='sizeup'){b='ORDER BY W.FileSize ASC limit 50;'}else {if(e=='namedown'){b='ORDER BY W.FileName DESC limit 50;'}else {if(e=='nameup'){b='ORDER BY W.FileName ASC limit 50;'}}}}}}if(d==''||d==null){if(User.workAll){LocalSearchMgr.searchLastFileByWorkDeskFileMgr(c,b,function(g,f){var b=f.rows;if(b.length>0){a.getView().lookup('cefworkfilelist').show();a.getView().lookup('thereisNone').hide();var d=Ext.getStore('workfile_mgrlist');d.removeAll();for(var c=0;c<b.length;c++){d.add({fileName:b.item(c).FileName,updateTime:b.item(c).CreateAt,remoteUrl:b.item(c).RemoteUrl,fileSize:b.item(c).FileSize,fileStatus:b.item(c).FileStatus,filePath:b.item(c).FilePath,baseID:b.item(c).ID,showPart:'allFile'})}}else {a.getView().lookup('cefworkfilelist').hide();a.getView().lookup('thereisNone').show()}})}else {if(User.workDoc){LocalSearchMgr.searchLastFileByWorkDeskFileMgrIsNoPic(c,b,function(g,f){var b=f.rows;if(b.length>0){a.getView().lookup('cefworkfilelist').show();a.getView().lookup('thereisNone').hide();var d=Ext.getStore('workfile_mgrlist');d.removeAll();for(var c=0;c<b.length;c++){d.add({fileName:b.item(c).FileName,updateTime:b.item(c).CreateAt,remoteUrl:b.item(c).RemoteUrl,fileSize:b.item(c).FileSize,fileStatus:b.item(c).FileStatus,filePath:b.item(c).FilePath,baseID:b.item(c).ID,showPart:'isNoPicFile'})}}else {a.getView().lookup('cefworkfilelist').hide();a.getView().lookup('thereisNone').show()}})}else {if(User.workPic){LocalSearchMgr.searchLastFileByWorkDeskFileMgrIsPic(c,b,function(g,f){var b=f.rows;if(b.length>0){a.getView().lookup('cefworkfilelist').show();a.getView().lookup('thereisNone').hide();var d=Ext.getStore('workfile_mgrlist');d.removeAll();for(var c=0;c<b.length;c++){d.add({fileName:b.item(c).FileName,updateTime:b.item(c).CreateAt,remoteUrl:b.item(c).RemoteUrl,fileSize:b.item(c).FileSize,fileStatus:b.item(c).FileStatus,filePath:b.item(c).FilePath,baseID:b.item(c).ID,showPart:'isPicFile'})}}else {a.getView().lookup('cefworkfilelist').hide();a.getView().lookup('thereisNone').show()}})}}}}else {if(User.workAll){LocalSearchMgr.searchPCByWorkList(c,b,d,function(g,f){var b=f.rows;if(b.length>0){a.getView().lookup('cefworkfilelist').show();a.getView().lookup('thereisNone').hide();var d=Ext.getStore('workfile_mgrlist');d.removeAll();for(var c=0;c<b.length;c++){d.add({fileName:b.item(c).FileName,updateTime:b.item(c).CreateAt,remoteUrl:b.item(c).RemoteUrl,fileSize:b.item(c).FileSize,fileStatus:b.item(c).FileStatus,filePath:b.item(c).FilePath,baseID:b.item(c).ID,showPart:'allFile'})}}else {a.getView().lookup('cefworkfilelist').hide();a.getView().lookup('thereisNone').show()}})}else {if(User.workDoc){LocalSearchMgr.searchPCByWorkListISNotPic(c,b,d,function(g,f){var b=f.rows;if(b.length>0){a.getView().lookup('cefworkfilelist').show();a.getView().lookup('thereisNone').hide();var d=Ext.getStore('workfile_mgrlist');d.removeAll();for(var c=0;c<b.length;c++){d.add({fileName:b.item(c).FileName,updateTime:b.item(c).CreateAt,remoteUrl:b.item(c).RemoteUrl,fileSize:b.item(c).FileSize,fileStatus:b.item(c).FileStatus,filePath:b.item(c).FilePath,baseID:b.item(c).ID,showPart:'isNoPicFile'})}}else {a.getView().lookup('cefworkfilelist').hide();a.getView().lookup('thereisNone').show()}})}else {if(User.workPic){LocalSearchMgr.searchPCByWorkListISPic(c,b,d,function(g,f){var b=f.rows;if(b.length>0){a.getView().lookup('cefworkfilelist').show();a.getView().lookup('thereisNone').hide();var d=Ext.getStore('workfile_mgrlist');d.removeAll();for(var c=0;c<b.length;c++){d.add({fileName:b.item(c).FileName,updateTime:b.item(c).CreateAt,remoteUrl:b.item(c).RemoteUrl,fileSize:b.item(c).FileSize,fileStatus:b.item(c).FileStatus,filePath:b.item(c).FilePath,baseID:b.item(c).ID,showPart:'isPicFile'})}}else {a.getView().lookup('cefworkfilelist').hide();a.getView().lookup('thereisNone').show()}})}}}}}},onMiddleSearchFieldChg:function(d,b,c){var a=this;var e=setTimeout(function(){if(a.lockMidSF){return}if(a.unlockValue!=b){a.doMiddleSearchChg(d,b,c)}window.clearTimeout(e)},1)},doMiddleSearchChg:function(c,a,b){var d=this;User.searchText=a;var e=window.setTimeout(function(){if(User.searchText==a){d.doMiddleSearch(c,a,b)}window.clearTimeout(e)},500)},doMiddleSearch:function(k,g,j){var a=this;var f=this;var c=f.getView().lookup('set_line').getValue();var b;User.totalInfo=[];var h='文件大小： '+'0'+'MB';var i='已选文件： '+'0'+'个';f.getView().lookup('allfilenum').setHtml(i);f.getView().lookup('allfilesize').setHtml(h);if(g&&g!='undefined'){var e=f.getView().lookup('asp_time').getValue();var d;if(e=='all'){d=0}else {if(e=='oneMonth'){d=Ext.Date.add(new Date(),Ext.Date.DAY,-30).getTime()}else {if(e=='threeMonth'){d=Ext.Date.add(new Date(),Ext.Date.DAY,-90).getTime()}else {if(e=='oneYear'){d=Ext.Date.add(new Date(),Ext.Date.DAY,-365).getTime()}}}}if(!f.getView().lookup('ceffilelist').isHidden()||!this.getView().lookup('thereisNone').isHidden()){if(c=='timedown'){b='ORDER BY F.CreateAt DESC limit 50;'}else {if(c=='timeup'){b='ORDER BY F.CreateAt ASC limit 50;'}else {if(c=='sizedown'){b='ORDER BY F.FileSize DESC limit 50;'}else {if(c=='sizeup'){b='ORDER BY F.FileSize ASC limit 50;'}else {if(c=='namedown'){b='ORDER BY F.FileName DESC limit 50;'}else {if(c=='nameup'){b='ORDER BY F.FileName ASC limit 50;'}}}}}}if(User.fileAll){LocalSearchMgr.searchPCByFileList(d,b,g,function(f,e){var b=e.rows;if(b.length>0){a.getView().lookup('ceffilelist').show();a.getView().lookup('thereisNone').hide();var d=Ext.getStore('file_mgrlist');d.removeAll();for(var c=0;c<b.length;c++){d.add({fileName:b.item(c).FileName,updateTime:b.item(c).CreateAt,senderName:b.item(c).SenderName,fileSize:b.item(c).FileSize,fileStatus:b.item(c).FileStatus,filePath:b.item(c).FilePath,msgID:b.item(c).MsgID,baseID:b.item(c).BaseID,chatType:b.item(c).ChatType,displayName:b.item(c).DisplayName,showPart:'allFile'})}}else {a.getView().lookup('ceffilelist').hide();a.getView().lookup('thereisNone').show()}})}else {if(User.fileDoc){LocalSearchMgr.searchPCByFileListIsNoPic(d,b,g,function(f,e){var b=e.rows;if(b.length>0){a.getView().lookup('ceffilelist').show();a.getView().lookup('thereisNone').hide();var d=Ext.getStore('file_mgrlist');d.removeAll();for(var c=0;c<b.length;c++){d.add({fileName:b.item(c).FileName,updateTime:b.item(c).CreateAt,senderName:b.item(c).SenderName,fileSize:b.item(c).FileSize,fileStatus:b.item(c).FileStatus,filePath:b.item(c).FilePath,msgID:b.item(c).MsgID,baseID:b.item(c).BaseID,chatType:b.item(c).ChatType,displayName:b.item(c).DisplayName,showPart:'allFile'})}}else {a.getView().lookup('ceffilelist').hide();a.getView().lookup('thereisNone').show()}})}else {if(User.filePic){LocalSearchMgr.searchPCByFileListIsPic(d,b,g,function(f,e){var b=e.rows;if(b.length>0){a.getView().lookup('ceffilelist').show();a.getView().lookup('thereisNone').hide();var d=Ext.getStore('file_mgrlist');d.removeAll();for(var c=0;c<b.length;c++){d.add({fileName:b.item(c).FileName,updateTime:b.item(c).CreateAt,senderName:b.item(c).SenderName,fileSize:b.item(c).FileSize,fileStatus:b.item(c).FileStatus,filePath:b.item(c).FilePath,msgID:b.item(c).MsgID,baseID:b.item(c).BaseID,chatType:b.item(c).ChatType,displayName:b.item(c).DisplayName,showPart:'allFile'})}}else {a.getView().lookup('ceffilelist').hide();a.getView().lookup('thereisNone').show()}})}}}}if(!f.getView().lookup('cefworkfilelist').isHidden()||!this.getView().lookup('thereisNone').isHidden()){if(c=='timedown'){b='ORDER BY W.CreateAt DESC limit 50;'}else {if(c=='timeup'){b='ORDER BY W.CreateAt ASC limit 50;'}else {if(c=='sizedown'){b='ORDER BY W.FileSize DESC limit 50;'}else {if(c=='sizeup'){b='ORDER BY W.FileSize ASC limit 50;'}else {if(c=='namedown'){b='ORDER BY W.FileName DESC limit 50;'}else {if(c=='nameup'){b='ORDER BY W.FileName ASC limit 50;'}}}}}}if(User.workAll){LocalSearchMgr.searchPCByWorkList(d,b,g,function(f,e){var b=e.rows;if(b.length>0){a.getView().lookup('cefworkfilelist').show();a.getView().lookup('thereisNone').hide();var d=Ext.getStore('workfile_mgrlist');d.removeAll();for(var c=0;c<b.length;c++){d.add({fileName:b.item(c).FileName,updateTime:b.item(c).CreateAt,remoteUrl:b.item(c).RemoteUrl,fileSize:b.item(c).FileSize,fileStatus:b.item(c).FileStatus,filePath:b.item(c).FilePath,baseID:b.item(c).ID,showPart:'allFile'})}}else {a.getView().lookup('cefworkfilelist').hide();a.getView().lookup('thereisNone').show()}})}else {if(User.workDoc){LocalSearchMgr.searchPCByWorkListISNotPic(d,b,g,function(f,e){var b=e.rows;if(b.length>0){a.getView().lookup('cefworkfilelist').show();a.getView().lookup('thereisNone').hide();var d=Ext.getStore('workfile_mgrlist');d.removeAll();for(var c=0;c<b.length;c++){d.add({fileName:b.item(c).FileName,updateTime:b.item(c).CreateAt,remoteUrl:b.item(c).RemoteUrl,fileSize:b.item(c).FileSize,fileStatus:b.item(c).FileStatus,filePath:b.item(c).FilePath,baseID:b.item(c).ID,showPart:'isNoPicFile'})}}else {a.getView().lookup('cefworkfilelist').hide();a.getView().lookup('thereisNone').show()}})}else {if(User.workPic){LocalSearchMgr.searchPCByWorkListISPic(d,b,g,function(f,e){var b=e.rows;if(b.length>0){a.getView().lookup('cefworkfilelist').show();a.getView().lookup('thereisNone').hide();var d=Ext.getStore('workfile_mgrlist');d.removeAll();for(var c=0;c<b.length;c++){d.add({fileName:b.item(c).FileName,updateTime:b.item(c).CreateAt,remoteUrl:b.item(c).RemoteUrl,fileSize:b.item(c).FileSize,fileStatus:b.item(c).FileStatus,filePath:b.item(c).FilePath,baseID:b.item(c).ID,showPart:'isPicFile'})}}else {a.getView().lookup('cefworkfilelist').hide();a.getView().lookup('thereisNone').show()}})}}}}}else {var e=f.getView().lookup('asp_time').getValue();var d;if(e=='all'){d=0}else {if(e=='oneMonth'){d=Ext.Date.add(new Date(),Ext.Date.DAY,-30).getTime()}else {if(e=='threeMonth'){d=Ext.Date.add(new Date(),Ext.Date.DAY,-90).getTime()}else {if(e=='oneYear'){d=Ext.Date.add(new Date(),Ext.Date.DAY,-365).getTime()}}}}if(!f.getView().lookup('ceffilelist').isHidden()||!this.getView().lookup('thereisNone').isHidden()){if(c=='timedown'){b='ORDER BY F.CreateAt DESC limit 50;'}else {if(c=='timeup'){b='ORDER BY F.CreateAt ASC limit 50;'}else {if(c=='sizedown'){b='ORDER BY F.FileSize DESC limit 50;'}else {if(c=='sizeup'){b='ORDER BY F.FileSize ASC limit 50;'}else {if(c=='namedown'){b='ORDER BY F.FileName DESC limit 50;'}else {if(c=='nameup'){b='ORDER BY F.FileName ASC limit 50;'}}}}}}if(User.fileAll){LocalSearchMgr.searchLastFileByFileMgr(d,b,function(f,e){var b=e.rows;if(b.length>0){a.getView().lookup('ceffilelist').show();a.getView().lookup('thereisNone').hide();var d=Ext.getStore('file_mgrlist');d.removeAll();for(var c=0;c<b.length;c++){d.add({fileName:b.item(c).FileName,updateTime:b.item(c).CreateAt,senderName:b.item(c).SenderName,fileSize:b.item(c).FileSize,fileStatus:b.item(c).FileStatus,filePath:b.item(c).FilePath,msgID:b.item(c).MsgID,baseID:b.item(c).BaseID,chatType:b.item(c).ChatType,displayName:b.item(c).DisplayName,showPart:'allFile'})}}else {a.getView().lookup('ceffilelist').hide();a.getView().lookup('thereisNone').show()}})}else {if(User.fileDoc){LocalSearchMgr.searchLastFileByFileMgrIsNoPic(d,b,function(f,e){var b=e.rows;if(b.length>0){a.getView().lookup('ceffilelist').show();a.getView().lookup('thereisNone').hide();var d=Ext.getStore('file_mgrlist');d.removeAll();for(var c=0;c<b.length;c++){d.add({fileName:b.item(c).FileName,updateTime:b.item(c).CreateAt,senderName:b.item(c).SenderName,fileSize:b.item(c).FileSize,fileStatus:b.item(c).FileStatus,filePath:b.item(c).FilePath,msgID:b.item(c).MsgID,baseID:b.item(c).BaseID,chatType:b.item(c).ChatType,displayName:b.item(c).DisplayName,showPart:'isPicFile'})}}else {a.getView().lookup('ceffilelist').hide();a.getView().lookup('thereisNone').show()}})}else {if(User.filePic){LocalSearchMgr.searchLastFileByFileMgrIsPic(d,b,function(f,e){var b=e.rows;if(b.length>0){a.getView().lookup('ceffilelist').show();a.getView().lookup('thereisNone').hide();var d=Ext.getStore('file_mgrlist');d.removeAll();for(var c=0;c<b.length;c++){d.add({fileName:b.item(c).FileName,updateTime:b.item(c).CreateAt,senderName:b.item(c).SenderName,fileSize:b.item(c).FileSize,fileStatus:b.item(c).FileStatus,filePath:b.item(c).FilePath,msgID:b.item(c).MsgID,baseID:b.item(c).BaseID,chatType:b.item(c).ChatType,displayName:b.item(c).DisplayName,showPart:'isPicFile'})}}else {a.getView().lookup('ceffilelist').hide();a.getView().lookup('thereisNone').show()}})}}}}if(!f.getView().lookup('cefworkfilelist').isHidden()||!this.getView().lookup('thereisNone').isHidden()){if(c=='timedown'){b='ORDER BY W.CreateAt DESC limit 50;'}else {if(c=='timeup'){b='ORDER BY W.CreateAt ASC limit 50;'}else {if(c=='sizedown'){b='ORDER BY W.FileSize DESC limit 50;'}else {if(c=='sizeup'){b='ORDER BY W.FileSize ASC limit 50;'}else {if(c=='namedown'){b='ORDER BY W.FileName DESC limit 50;'}else {if(c=='nameup'){b='ORDER BY W.FileName ASC limit 50;'}}}}}}if(User.workAll){LocalSearchMgr.searchLastFileByWorkDeskFileMgr(d,b,function(f,e){var b=e.rows;if(b.length>0){a.getView().lookup('cefworkfilelist').show();a.getView().lookup('thereisNone').hide();var d=Ext.getStore('workfile_mgrlist');d.removeAll();for(var c=0;c<b.length;c++){d.add({fileName:b.item(c).FileName,updateTime:b.item(c).CreateAt,remoteUrl:b.item(c).RemoteUrl,fileSize:b.item(c).FileSize,fileStatus:b.item(c).FileStatus,filePath:b.item(c).FilePath,baseID:b.item(c).ID,showPart:'allFile'})}}else {a.getView().lookup('cefworkfilelist').hide();a.getView().lookup('thereisNone').show()}})}else {if(User.workDoc){LocalSearchMgr.searchLastFileByWorkDeskFileMgrIsNoPic(d,b,function(f,e){var b=e.rows;if(b.length>0){a.getView().lookup('cefworkfilelist').show();a.getView().lookup('thereisNone').hide();var d=Ext.getStore('workfile_mgrlist');d.removeAll();for(var c=0;c<b.length;c++){d.add({fileName:b.item(c).FileName,updateTime:b.item(c).CreateAt,remoteUrl:b.item(c).RemoteUrl,fileSize:b.item(c).FileSize,fileStatus:b.item(c).FileStatus,filePath:b.item(c).FilePath,baseID:b.item(c).ID,showPart:'isNoPicFile'})}}else {a.getView().lookup('cefworkfilelist').hide();a.getView().lookup('thereisNone').show()}})}else {if(User.workPic){LocalSearchMgr.searchLastFileByWorkDeskFileMgrIsPic(d,b,function(f,e){var b=e.rows;if(b.length>0){a.getView().lookup('cefworkfilelist').show();a.getView().lookup('thereisNone').hide();var d=Ext.getStore('workfile_mgrlist');d.removeAll();for(var c=0;c<b.length;c++){d.add({fileName:b.item(c).FileName,updateTime:b.item(c).CreateAt,remoteUrl:b.item(c).RemoteUrl,fileSize:b.item(c).FileSize,fileStatus:b.item(c).FileStatus,filePath:b.item(c).FilePath,baseID:b.item(c).ID,showPart:'isPicFile'})}}else {a.getView().lookup('cefworkfilelist').hide();a.getView().lookup('thereisNone').show()}})}}}}}},onchangeLine:function(j,d){var a=this;var f=this;var g=f.getView().lookup('asp_time').getValue();var e=f.getView().lookup('midpanel_searchfield').getValue();var c;var b;User.totalInfo=[];var h='文件大小： '+'0'+'MB';var i='已选文件： '+'0'+'个';f.getView().lookup('allfilenum').setHtml(i);f.getView().lookup('allfilesize').setHtml(h);if(g=='all'){c=0}else {if(g=='oneMonth'){c=Ext.Date.add(new Date(),Ext.Date.DAY,-30).getTime()}else {if(g=='threeMonth'){c=Ext.Date.add(new Date(),Ext.Date.DAY,-90).getTime()}else {if(g=='oneYear'){c=Ext.Date.add(new Date(),Ext.Date.DAY,-365).getTime()}}}}if(!f.getView().lookup('ceffilelist').isHidden()||!this.getView().lookup('thereisNone').isHidden()){if(d=='timedown'){b='ORDER BY F.CreateAt DESC limit 50;'}else {if(d=='timeup'){b='ORDER BY F.CreateAt ASC limit 50;'}else {if(d=='sizedown'){b='ORDER BY F.FileSize DESC limit 50;'}else {if(d=='sizeup'){b='ORDER BY F.FileSize ASC limit 50;'}else {if(d=='namedown'){b='ORDER BY F.FileName DESC limit 50;'}else {if(d=='nameup'){b='ORDER BY F.FileName ASC limit 50;'}}}}}}if(e==''||e==null){if(User.fileAll){LocalSearchMgr.searchLastFileByFileMgr(c,b,function(g,f){var b=f.rows;if(b.length>0){a.getView().lookup('ceffilelist').show();a.getView().lookup('thereisNone').hide();var e=Ext.getStore('file_mgrlist');e.removeAll();for(var c=0;c<b.length;c++){e.add({fileName:b.item(c).FileName,updateTime:b.item(c).CreateAt,senderName:b.item(c).SenderName,fileSize:b.item(c).FileSize,fileStatus:b.item(c).FileStatus,filePath:b.item(c).FilePath,msgID:b.item(c).MsgID,baseID:b.item(c).BaseID,chatType:b.item(c).ChatType,displayName:b.item(c).DisplayName,showPart:'allFile'})}}else {a.getView().lookup('ceffilelist').hide();a.getView().lookup('thereisNone').show()}})}else {if(User.fileDoc){LocalSearchMgr.searchLastFileByFileMgrIsNoPic(c,b,function(g,f){var b=f.rows;if(b.length>0){a.getView().lookup('ceffilelist').show();a.getView().lookup('thereisNone').hide();var e=Ext.getStore('file_mgrlist');e.removeAll();for(var c=0;c<b.length;c++){e.add({fileName:b.item(c).FileName,updateTime:b.item(c).CreateAt,senderName:b.item(c).SenderName,fileSize:b.item(c).FileSize,fileStatus:b.item(c).FileStatus,filePath:b.item(c).FilePath,msgID:b.item(c).MsgID,baseID:b.item(c).BaseID,chatType:b.item(c).ChatType,displayName:b.item(c).DisplayName,showPart:'isPicFile'})}}else {a.getView().lookup('ceffilelist').hide();a.getView().lookup('thereisNone').show()}})}else {if(User.filePic){LocalSearchMgr.searchLastFileByFileMgrIsPic(c,b,function(g,f){var b=f.rows;if(b.length>0){a.getView().lookup('ceffilelist').show();a.getView().lookup('thereisNone').hide();var e=Ext.getStore('file_mgrlist');e.removeAll();for(var c=0;c<b.length;c++){e.add({fileName:b.item(c).FileName,updateTime:b.item(c).CreateAt,senderName:b.item(c).SenderName,fileSize:b.item(c).FileSize,fileStatus:b.item(c).FileStatus,filePath:b.item(c).FilePath,msgID:b.item(c).MsgID,baseID:b.item(c).BaseID,chatType:b.item(c).ChatType,displayName:b.item(c).DisplayName,showPart:'isPicFile'})}}else {a.getView().lookup('ceffilelist').hide();a.getView().lookup('thereisNone').show()}})}}}}else {if(User.fileAll){LocalSearchMgr.searchPCByFileList(c,b,e,function(g,f){var b=f.rows;if(b.length>0){a.getView().lookup('ceffilelist').show();a.getView().lookup('thereisNone').hide();var e=Ext.getStore('file_mgrlist');e.removeAll();for(var c=0;c<b.length;c++){e.add({fileName:b.item(c).FileName,updateTime:b.item(c).CreateAt,senderName:b.item(c).SenderName,fileSize:b.item(c).FileSize,fileStatus:b.item(c).FileStatus,filePath:b.item(c).FilePath,msgID:b.item(c).MsgID,baseID:b.item(c).BaseID,chatType:b.item(c).ChatType,displayName:b.item(c).DisplayName,showPart:'allFile'})}}else {a.getView().lookup('ceffilelist').hide();a.getView().lookup('thereisNone').show()}})}else {if(User.fileDoc){LocalSearchMgr.searchPCByFileListIsNoPic(c,b,e,function(g,f){var b=f.rows;if(b.length>0){a.getView().lookup('ceffilelist').show();a.getView().lookup('thereisNone').hide();var e=Ext.getStore('file_mgrlist');e.removeAll();for(var c=0;c<b.length;c++){e.add({fileName:b.item(c).FileName,updateTime:b.item(c).CreateAt,senderName:b.item(c).SenderName,fileSize:b.item(c).FileSize,fileStatus:b.item(c).FileStatus,filePath:b.item(c).FilePath,msgID:b.item(c).MsgID,baseID:b.item(c).BaseID,chatType:b.item(c).ChatType,displayName:b.item(c).DisplayName,showPart:'allFile'})}}else {a.getView().lookup('ceffilelist').hide();a.getView().lookup('thereisNone').show()}})}else {if(User.filePic){LocalSearchMgr.searchPCByFileListIsPic(c,b,e,function(g,f){var b=f.rows;if(b.length>0){a.getView().lookup('ceffilelist').show();a.getView().lookup('thereisNone').hide();var e=Ext.getStore('file_mgrlist');e.removeAll();for(var c=0;c<b.length;c++){e.add({fileName:b.item(c).FileName,updateTime:b.item(c).CreateAt,senderName:b.item(c).SenderName,fileSize:b.item(c).FileSize,fileStatus:b.item(c).FileStatus,filePath:b.item(c).FilePath,msgID:b.item(c).MsgID,baseID:b.item(c).BaseID,chatType:b.item(c).ChatType,displayName:b.item(c).DisplayName,showPart:'allFile'})}}else {a.getView().lookup('ceffilelist').hide();a.getView().lookup('thereisNone').show()}})}}}}}if(!f.getView().lookup('cefworkfilelist').isHidden()||!this.getView().lookup('thereisNone').isHidden()){if(d=='timedown'){b='ORDER BY W.CreateAt DESC limit 50;'}else {if(d=='timeup'){b='ORDER BY W.CreateAt ASC limit 50;'}else {if(d=='sizedown'){b='ORDER BY W.FileSize DESC limit 50;'}else {if(d=='sizeup'){b='ORDER BY W.FileSize ASC limit 50;'}else {if(d=='namedown'){b='ORDER BY W.FileName DESC limit 50;'}else {if(d=='nameup'){b='ORDER BY W.FileName ASC limit 50;'}}}}}}if(e==''||e==null){if(User.workAll){LocalSearchMgr.searchLastFileByWorkDeskFileMgr(c,b,function(g,f){var b=f.rows;if(b.length>0){a.getView().lookup('cefworkfilelist').show();a.getView().lookup('thereisNone').hide();var e=Ext.getStore('workfile_mgrlist');e.removeAll();for(var c=0;c<b.length;c++){e.add({fileName:b.item(c).FileName,updateTime:b.item(c).CreateAt,remoteUrl:b.item(c).RemoteUrl,fileSize:b.item(c).FileSize,fileStatus:b.item(c).FileStatus,filePath:b.item(c).FilePath,baseID:b.item(c).ID,showPart:'allFile'})}}else {a.getView().lookup('cefworkfilelist').hide();a.getView().lookup('thereisNone').show()}})}else {if(User.workDoc){LocalSearchMgr.searchLastFileByWorkDeskFileMgrIsNoPic(c,b,function(g,f){var b=f.rows;if(b.length>0){a.getView().lookup('cefworkfilelist').show();a.getView().lookup('thereisNone').hide();var e=Ext.getStore('workfile_mgrlist');e.removeAll();for(var c=0;c<b.length;c++){e.add({fileName:b.item(c).FileName,updateTime:b.item(c).CreateAt,remoteUrl:b.item(c).RemoteUrl,fileSize:b.item(c).FileSize,fileStatus:b.item(c).FileStatus,filePath:b.item(c).FilePath,baseID:b.item(c).ID,showPart:'isNoPicFile'})}}else {a.getView().lookup('cefworkfilelist').hide();a.getView().lookup('thereisNone').show()}})}else {if(User.workPic){LocalSearchMgr.searchLastFileByWorkDeskFileMgrIsPic(c,b,function(g,f){var b=f.rows;if(b.length>0){a.getView().lookup('cefworkfilelist').show();a.getView().lookup('thereisNone').hide();var e=Ext.getStore('workfile_mgrlist');e.removeAll();for(var c=0;c<b.length;c++){e.add({fileName:b.item(c).FileName,updateTime:b.item(c).CreateAt,remoteUrl:b.item(c).RemoteUrl,fileSize:b.item(c).FileSize,fileStatus:b.item(c).FileStatus,filePath:b.item(c).FilePath,baseID:b.item(c).ID,showPart:'isPicFile'})}}else {a.getView().lookup('cefworkfilelist').hide();a.getView().lookup('thereisNone').show()}})}}}}else {if(User.workAll){LocalSearchMgr.searchPCByWorkList(c,b,e,function(g,f){var b=f.rows;if(b.length>0){a.getView().lookup('cefworkfilelist').show();a.getView().lookup('thereisNone').hide();var e=Ext.getStore('workfile_mgrlist');e.removeAll();for(var c=0;c<b.length;c++){e.add({fileName:b.item(c).FileName,updateTime:b.item(c).CreateAt,remoteUrl:b.item(c).RemoteUrl,fileSize:b.item(c).FileSize,fileStatus:b.item(c).FileStatus,filePath:b.item(c).FilePath,baseID:b.item(c).ID,showPart:'allFile'})}}else {a.getView().lookup('cefworkfilelist').hide();a.getView().lookup('thereisNone').show()}})}else {if(User.workDoc){LocalSearchMgr.searchPCByWorkListISNotPic(c,b,e,function(g,f){var b=f.rows;if(b.length>0){a.getView().lookup('cefworkfilelist').show();a.getView().lookup('thereisNone').hide();var e=Ext.getStore('workfile_mgrlist');e.removeAll();for(var c=0;c<b.length;c++){e.add({fileName:b.item(c).FileName,updateTime:b.item(c).CreateAt,remoteUrl:b.item(c).RemoteUrl,fileSize:b.item(c).FileSize,fileStatus:b.item(c).FileStatus,filePath:b.item(c).FilePath,baseID:b.item(c).ID,showPart:'isNoPicFile'})}}else {a.getView().lookup('cefworkfilelist').hide();a.getView().lookup('thereisNone').show()}})}else {if(User.workPic){LocalSearchMgr.searchPCByWorkListISPic(c,b,e,function(g,f){var b=f.rows;if(b.length>0){a.getView().lookup('cefworkfilelist').show();a.getView().lookup('thereisNone').hide();var e=Ext.getStore('workfile_mgrlist');e.removeAll();for(var c=0;c<b.length;c++){e.add({fileName:b.item(c).FileName,updateTime:b.item(c).CreateAt,remoteUrl:b.item(c).RemoteUrl,fileSize:b.item(c).FileSize,fileStatus:b.item(c).FileStatus,filePath:b.item(c).FilePath,baseID:b.item(c).ID,showPart:'isPicFile'})}}else {a.getView().lookup('cefworkfilelist').hide();a.getView().lookup('thereisNone').show()}})}}}}}},onRefresh:function(k,j){var a=this;var f=this;var d=f.getView().lookup('set_line').getValue();var e=f.getView().lookup('midpanel_searchfield').getValue();var b;var g=f.getView().lookup('asp_time').getValue();var c;User.totalInfo=[];var h='文件大小： '+'0'+'MB';var i='已选文件： '+'0'+'个';f.getView().lookup('allfilenum').setHtml(i);f.getView().lookup('allfilesize').setHtml(h);if(g=='all'){c=0}else {if(g=='oneMonth'){c=Ext.Date.add(new Date(),Ext.Date.DAY,-30).getTime()}else {if(g=='threeMonth'){c=Ext.Date.add(new Date(),Ext.Date.DAY,-90).getTime()}else {if(g=='oneYear'){c=Ext.Date.add(new Date(),Ext.Date.DAY,-365).getTime()}}}}if(!f.getView().lookup('ceffilelist').isHidden()||!this.getView().lookup('thereisNone').isHidden()){if(d=='timedown'){b='ORDER BY F.CreateAt DESC limit 50;'}else {if(d=='timeup'){b='ORDER BY F.CreateAt ASC limit 50;'}else {if(d=='sizedown'){b='ORDER BY F.FileSize DESC limit 50;'}else {if(d=='sizeup'){b='ORDER BY F.FileSize ASC limit 50;'}else {if(d=='namedown'){b='ORDER BY F.FileName DESC limit 50;'}else {if(d=='nameup'){b='ORDER BY F.FileName ASC limit 50;'}}}}}}if(e==''||e==null){if(User.fileAll){LocalSearchMgr.searchLastFileByFileMgr(c,b,function(f,e){var b=e.rows;if(b.length>0){a.getView().lookup('ceffilelist').show();a.getView().lookup('thereisNone').hide();var d=Ext.getStore('file_mgrlist');d.removeAll();for(var c=0;c<b.length;c++){d.add({fileName:b.item(c).FileName,updateTime:b.item(c).CreateAt,senderName:b.item(c).SenderName,fileSize:b.item(c).FileSize,fileStatus:b.item(c).FileStatus,filePath:b.item(c).FilePath,msgID:b.item(c).MsgID,baseID:b.item(c).BaseID,chatType:b.item(c).ChatType,displayName:b.item(c).DisplayName,showPart:'allFile'})}}else {a.getView().lookup('ceffilelist').hide();a.getView().lookup('thereisNone').show()}})}else {if(User.fileDoc){LocalSearchMgr.searchLastFileByFileMgrIsNoPic(c,b,function(f,e){var b=e.rows;if(b.length>0){a.getView().lookup('ceffilelist').show();a.getView().lookup('thereisNone').hide();var d=Ext.getStore('file_mgrlist');d.removeAll();for(var c=0;c<b.length;c++){d.add({fileName:b.item(c).FileName,updateTime:b.item(c).CreateAt,senderName:b.item(c).SenderName,fileSize:b.item(c).FileSize,fileStatus:b.item(c).FileStatus,filePath:b.item(c).FilePath,msgID:b.item(c).MsgID,baseID:b.item(c).BaseID,chatType:b.item(c).ChatType,displayName:b.item(c).DisplayName,showPart:'isPicFile'})}}else {a.getView().lookup('ceffilelist').hide();a.getView().lookup('thereisNone').show()}})}else {if(User.filePic){LocalSearchMgr.searchLastFileByFileMgrIsPic(c,b,function(f,e){var b=e.rows;if(b.length>0){a.getView().lookup('ceffilelist').show();a.getView().lookup('thereisNone').hide();var d=Ext.getStore('file_mgrlist');d.removeAll();for(var c=0;c<b.length;c++){d.add({fileName:b.item(c).FileName,updateTime:b.item(c).CreateAt,senderName:b.item(c).SenderName,fileSize:b.item(c).FileSize,fileStatus:b.item(c).FileStatus,filePath:b.item(c).FilePath,msgID:b.item(c).MsgID,baseID:b.item(c).BaseID,chatType:b.item(c).ChatType,displayName:b.item(c).DisplayName,showPart:'isPicFile'})}}else {a.getView().lookup('ceffilelist').hide();a.getView().lookup('thereisNone').show()}})}}}}else {if(User.fileAll){LocalSearchMgr.searchPCByFileList(c,b,e,function(f,e){var b=e.rows;if(b.length>0){a.getView().lookup('ceffilelist').show();a.getView().lookup('thereisNone').hide();var d=Ext.getStore('file_mgrlist');d.removeAll();for(var c=0;c<b.length;c++){d.add({fileName:b.item(c).FileName,updateTime:b.item(c).CreateAt,senderName:b.item(c).SenderName,fileSize:b.item(c).FileSize,fileStatus:b.item(c).FileStatus,filePath:b.item(c).FilePath,msgID:b.item(c).MsgID,baseID:b.item(c).BaseID,chatType:b.item(c).ChatType,displayName:b.item(c).DisplayName,showPart:'allFile'})}}else {a.getView().lookup('ceffilelist').hide();a.getView().lookup('thereisNone').show()}})}else {if(User.fileDoc){LocalSearchMgr.searchPCByFileListIsNoPic(c,b,e,function(f,e){var b=e.rows;if(b.length>0){a.getView().lookup('ceffilelist').show();a.getView().lookup('thereisNone').hide();var d=Ext.getStore('file_mgrlist');d.removeAll();for(var c=0;c<b.length;c++){d.add({fileName:b.item(c).FileName,updateTime:b.item(c).CreateAt,senderName:b.item(c).SenderName,fileSize:b.item(c).FileSize,fileStatus:b.item(c).FileStatus,filePath:b.item(c).FilePath,msgID:b.item(c).MsgID,baseID:b.item(c).BaseID,chatType:b.item(c).ChatType,displayName:b.item(c).DisplayName,showPart:'allFile'})}}else {a.getView().lookup('ceffilelist').hide();a.getView().lookup('thereisNone').show()}})}else {if(User.filePic){LocalSearchMgr.searchPCByFileListIsPic(c,b,e,function(f,e){var b=e.rows;if(b.length>0){a.getView().lookup('ceffilelist').show();a.getView().lookup('thereisNone').hide();var d=Ext.getStore('file_mgrlist');d.removeAll();for(var c=0;c<b.length;c++){d.add({fileName:b.item(c).FileName,updateTime:b.item(c).CreateAt,senderName:b.item(c).SenderName,fileSize:b.item(c).FileSize,fileStatus:b.item(c).FileStatus,filePath:b.item(c).FilePath,msgID:b.item(c).MsgID,baseID:b.item(c).BaseID,chatType:b.item(c).ChatType,displayName:b.item(c).DisplayName,showPart:'allFile'})}}else {a.getView().lookup('ceffilelist').hide();a.getView().lookup('thereisNone').show()}})}}}}}if(!f.getView().lookup('cefworkfilelist').isHidden()||!this.getView().lookup('thereisNone').isHidden()){if(d=='timedown'){b='ORDER BY W.CreateAt DESC limit 50;'}else {if(d=='timeup'){b='ORDER BY W.CreateAt ASC limit 50;'}else {if(d=='sizedown'){b='ORDER BY W.FileSize DESC limit 50;'}else {if(d=='sizeup'){b='ORDER BY W.FileSize ASC limit 50;'}else {if(d=='namedown'){b='ORDER BY W.FileName DESC limit 50;'}else {if(d=='nameup'){b='ORDER BY W.FileName ASC limit 50;'}}}}}}if(e==''||e==null){if(User.workAll){LocalSearchMgr.searchLastFileByWorkDeskFileMgr(c,b,function(f,e){var b=e.rows;if(b.length>0){a.getView().lookup('cefworkfilelist').show();a.getView().lookup('thereisNone').hide();var d=Ext.getStore('workfile_mgrlist');d.removeAll();for(var c=0;c<b.length;c++){d.add({fileName:b.item(c).FileName,updateTime:b.item(c).CreateAt,remoteUrl:b.item(c).RemoteUrl,fileSize:b.item(c).FileSize,fileStatus:b.item(c).FileStatus,filePath:b.item(c).FilePath,baseID:b.item(c).ID,showPart:'allFile'})}}else {a.getView().lookup('cefworkfilelist').hide();a.getView().lookup('thereisNone').show()}})}else {if(User.workDoc){LocalSearchMgr.searchLastFileByWorkDeskFileMgrIsNoPic(c,b,function(f,e){var b=e.rows;if(b.length>0){a.getView().lookup('cefworkfilelist').show();a.getView().lookup('thereisNone').hide();var d=Ext.getStore('workfile_mgrlist');d.removeAll();for(var c=0;c<b.length;c++){d.add({fileName:b.item(c).FileName,updateTime:b.item(c).CreateAt,remoteUrl:b.item(c).RemoteUrl,fileSize:b.item(c).FileSize,fileStatus:b.item(c).FileStatus,filePath:b.item(c).FilePath,baseID:b.item(c).ID,showPart:'isNoPicFile'})}}else {a.getView().lookup('cefworkfilelist').hide();a.getView().lookup('thereisNone').show()}})}else {if(User.workPic){LocalSearchMgr.searchLastFileByWorkDeskFileMgrIsPic(c,b,function(f,e){var b=e.rows;if(b.length>0){a.getView().lookup('cefworkfilelist').show();a.getView().lookup('thereisNone').hide();var d=Ext.getStore('workfile_mgrlist');d.removeAll();for(var c=0;c<b.length;c++){d.add({fileName:b.item(c).FileName,updateTime:b.item(c).CreateAt,remoteUrl:b.item(c).RemoteUrl,fileSize:b.item(c).FileSize,fileStatus:b.item(c).FileStatus,filePath:b.item(c).FilePath,baseID:b.item(c).ID,showPart:'isPicFile'})}}else {a.getView().lookup('cefworkfilelist').hide();a.getView().lookup('thereisNone').show()}})}}}}else {if(User.workAll){LocalSearchMgr.searchPCByWorkList(c,b,e,function(f,e){var b=e.rows;if(b.length>0){a.getView().lookup('cefworkfilelist').show();a.getView().lookup('thereisNone').hide();var d=Ext.getStore('workfile_mgrlist');d.removeAll();for(var c=0;c<b.length;c++){d.add({fileName:b.item(c).FileName,updateTime:b.item(c).CreateAt,remoteUrl:b.item(c).RemoteUrl,fileSize:b.item(c).FileSize,fileStatus:b.item(c).FileStatus,filePath:b.item(c).FilePath,baseID:b.item(c).ID,showPart:'allFile'})}}else {a.getView().lookup('cefworkfilelist').hide();a.getView().lookup('thereisNone').show()}})}else {if(User.workDoc){LocalSearchMgr.searchPCByWorkListISNotPic(c,b,e,function(f,e){var b=e.rows;if(b.length>0){a.getView().lookup('cefworkfilelist').show();a.getView().lookup('thereisNone').hide();var d=Ext.getStore('workfile_mgrlist');d.removeAll();for(var c=0;c<b.length;c++){d.add({fileName:b.item(c).FileName,updateTime:b.item(c).CreateAt,remoteUrl:b.item(c).RemoteUrl,fileSize:b.item(c).FileSize,fileStatus:b.item(c).FileStatus,filePath:b.item(c).FilePath,baseID:b.item(c).ID,showPart:'isNoPicFile'})}}else {a.getView().lookup('cefworkfilelist').hide();a.getView().lookup('thereisNone').show()}})}else {if(User.workPic){LocalSearchMgr.searchPCByWorkListISPic(c,b,e,function(f,e){var b=e.rows;if(b.length>0){a.getView().lookup('cefworkfilelist').show();a.getView().lookup('thereisNone').hide();var d=Ext.getStore('workfile_mgrlist');d.removeAll();for(var c=0;c<b.length;c++){d.add({fileName:b.item(c).FileName,updateTime:b.item(c).CreateAt,remoteUrl:b.item(c).RemoteUrl,fileSize:b.item(c).FileSize,fileStatus:b.item(c).FileStatus,filePath:b.item(c).FilePath,baseID:b.item(c).ID,showPart:'isPicFile'})}}else {a.getView().lookup('cefworkfilelist').hide();a.getView().lookup('thereisNone').show()}})}}}}}}});Ext.define('IMCef.view.fileMgr.CefFileList',{extend:'Ext.List',xtype:'ceffilelist',controller:'ceffilemgrcontroller',requires:['IMCef.view.fileMgr.CefFileMgrController'],store:{storeId:'file_mgrlist',model:'IMCommon.model.desktop.DeskFileMgr'},itemTpl:['<div class="mgr_fileList_fileIcon mgr_fileList_box"><input type="checkbox"></div>','<div class="mgr_fileList_fileIcon {[ParseUtil.getFileIcon(values.fileName)]}"></div>','<div class="mgr_fileName">','<div class="{[values.baseID]}" style="overflow: hidden;text-overflow: ellipsis;white-space: nowrap;width: 150px; font-size: 14px;">{[ParseUtil.parseName(values.fileName)]}</div>','<div style="color:#BCBCBC;font-size: 13px;margin-top: 8px;">{fileSize:fileSize}</div>','</div>','<div class="mgr_file_font" style="height: 36px;">','<tpl if="fileStatus==0 ||fileStatus==null">','<span> <a>打开</a></span>','<tpl else>','<span> <a>下载</a></span>','</tpl>','</div>','<div class="mgr_file_date" style="height: 22px;">{[Utils.date2Str(values.updateTime)]}</div>','<tpl if="values.chatType==\'D\'">','<div class="mgr_file_where">来自于<a class="toChat">  {displayName}</a></div>','<tpl else>','<div class="mgr_file_wherebygroup"><a class="toChatByOne">{senderName}  </a>发送在<a style="overflow: hidden;text-overflow: ellipsis;white-space: nowrap;width: 140px;" class="toChat">  {displayName}</a></div>','</tpl>'].join(''),listeners:{childtap:'ontapList'},initialize:function(){var a=this;a.callParent(arguments);a.element.on({delegate:'.x-listitem',contextmenu:'onFileContextmenu',scope:a});a.getScrollable().on({scroll:'onScrolList',scope:a})},onFileContextmenu:function(c){var d=c.currentTarget;if(!d){return}var l=this;var j=l.getStore();var i=d.getAttribute('data-recordindex');var a=j.getAt(i);if(!a){return}var b=a.get('filePath');var h=a.get('msgID');var g=a.get('baseID');var f=a.get('fileSize');var e='groupms';if(!b.startsWith('file://')){b=ConfigMgr.getDefaultDir()+b}var k=Ext.create('IMCommon.view.menu.FileMgrContextmenu',{value:b,path:b,msg_id:h,base_id:g,file_size:f,chose_where:e,fileName:a.get('fileName')});ParseUtil.menuShowAtVisible(k,c.getPoint());c.preventDefault()},onScrolList:function(a){var j=a.getScrollElement().dom,l=j.scrollHeight,m=j.scrollTop,k=j.offsetHeight;if(l<=m+k){if(!a.autoEnd){a.autoEnd=!0;var n=this;var e=n.getStore(),d=e.last();if(!d){return}var f=d.get('updateTime');if(!f){return}var i=Ext.Viewport.down('ceffilemgr').lookup('asp_time').getValue();var c;var h=Ext.Viewport.down('ceffilemgr').lookup('midpanel_searchfield').getValue();var g=Ext.Viewport.down('ceffilemgr').lookup('set_line').getValue();var b;if(i=='all'){c=0}else {if(i=='oneMonth'){c=Ext.Date.add(new Date(),Ext.Date.DAY,-30).getTime()}else {if(i=='threeMonth'){c=Ext.Date.add(new Date(),Ext.Date.DAY,-90).getTime()}else {if(i=='oneYear'){c=Ext.Date.add(new Date(),Ext.Date.DAY,-365).getTime()}}}}if(g=='timedown'){b='ORDER BY F.CreateAt DESC limit 50;'}else {if(g=='timeup'){b='ORDER BY F.CreateAt ASC limit 50;'}else {if(g=='sizedown'){b='ORDER BY F.FileSize DESC limit 50;'}else {if(g=='sizeup'){b='ORDER BY F.FileSize ASC limit 50;'}else {if(g=='namedown'){b='ORDER BY F.FileName DESC limit 50;'}else {if(g=='nameup'){b='ORDER BY F.FileName ASC limit 50;'}}}}}}if(h==''||h==null){if(d.data.showPart=='allFile'){LocalSearchMgr.searchLastFileByFileMgrIsPicFromTime(c,f,b,function(h,g){var c=g.rows;if(c.length<=0){a.autoEnd=!1;return}var f=[];for(var d=0;d<c.length;d++){var b=c.item(d);f.push({fileName:b.FileName,updateTime:b.CreateAt,senderName:b.SenderName,fileSize:b.FileSize,fileStatus:b.FileStatus,filePath:b.FilePath,msgID:b.MsgID,baseID:b.BaseID,chatType:b.ChatType,displayName:b.DisplayName,showPart:'allFile'})}e.add(f);a.autoEnd=!1},function(b){console.error('向下滚动时，查询数据出错',b.message);a.autoEnd=!1})}else {if(d.data.showPart=='isPicFile'){LocalSearchMgr.searchLastFileByFileMgrHasPicFromTime(c,f,b,function(h,g){var c=g.rows;if(c.length<=0){a.autoEnd=!1;return}var f=[];for(var d=0;d<c.length;d++){var b=c.item(d);f.push({fileName:b.FileName,updateTime:b.CreateAt,senderName:b.SenderName,fileSize:b.FileSize,fileStatus:b.FileStatus,filePath:b.FilePath,msgID:b.MsgID,baseID:b.BaseID,chatType:b.ChatType,displayName:b.DisplayName,showPart:'isPicFile'})}e.add(f);a.autoEnd=!1},function(b){console.error('向下滚动时，查询数据出错',b.message);a.autoEnd=!1})}else {if(d.data.showPart=='isNoPicFile'){LocalSearchMgr.searchLastFileByFileMgrHasNoPicFromTime(c,f,b,function(h,g){var c=g.rows;if(c.length<=0){a.autoEnd=!1;return}var f=[];for(var d=0;d<c.length;d++){var b=c.item(d);f.push({fileName:b.FileName,updateTime:b.CreateAt,senderName:b.SenderName,fileSize:b.FileSize,fileStatus:b.FileStatus,filePath:b.FilePath,msgID:b.MsgID,baseID:b.BaseID,chatType:b.ChatType,displayName:b.DisplayName,showPart:'isNoPicFile'})}e.add(f);a.autoEnd=!1},function(b){console.error('向下滚动时，查询数据出错',b.message);a.autoEnd=!1})}}}}else {if(d.data.showPart=='allFile'){LocalSearchMgr.searchPCByFileListmore(c,f,b,h,function(h,g){var c=g.rows;if(c.length<=0){a.autoEnd=!1;return}var f=[];for(var d=0;d<c.length;d++){var b=c.item(d);f.push({fileName:b.FileName,updateTime:b.CreateAt,senderName:b.SenderName,fileSize:b.FileSize,fileStatus:b.FileStatus,filePath:b.FilePath,msgID:b.MsgID,baseID:b.BaseID,chatType:b.ChatType,displayName:b.DisplayName,showPart:'allFile'})}e.add(f);a.autoEnd=!1},function(b){console.error('向下滚动时，查询数据出错',b.message);a.autoEnd=!1})}else {if(d.data.showPart=='isPicFile'){LocalSearchMgr.searchPCByFileListIsPicmore(c,f,b,h,function(h,g){var c=g.rows;if(c.length<=0){a.autoEnd=!1;return}var f=[];for(var d=0;d<c.length;d++){var b=c.item(d);f.push({fileName:b.FileName,updateTime:b.CreateAt,senderName:b.SenderName,fileSize:b.FileSize,fileStatus:b.FileStatus,filePath:b.FilePath,msgID:b.MsgID,baseID:b.BaseID,chatType:b.ChatType,displayName:b.DisplayName,showPart:'isPicFile'})}e.add(f);a.autoEnd=!1},function(b){console.error('向下滚动时，查询数据出错',b.message);a.autoEnd=!1})}else {if(d.data.showPart=='isNoPicFile'){LocalSearchMgr.searchPCByFileListIsNoPicmore(c,f,b,h,function(h,g){var c=g.rows;if(c.length<=0){a.autoEnd=!1;return}var f=[];for(var d=0;d<c.length;d++){var b=c.item(d);f.push({fileName:b.FileName,updateTime:b.CreateAt,senderName:b.SenderName,fileSize:b.FileSize,fileStatus:b.FileStatus,filePath:b.FilePath,msgID:b.MsgID,baseID:b.BaseID,chatType:b.ChatType,displayName:b.DisplayName,showPart:'isNoPicFile'})}e.add(f);a.autoEnd=!1},function(b){console.error('向下滚动时，查询数据出错',b.message);a.autoEnd=!1})}}}}}}}});Ext.define('IMCef.view.fileMgr.CefWorkFileList',{extend:'Ext.List',xtype:'cefworkfilelist',controller:'ceffilemgrcontroller',requires:['IMCef.view.fileMgr.CefFileMgrController'],store:{storeId:'workfile_mgrlist',model:'IMCommon.model.desktop.DeskWorkFileMgr'},itemTpl:['<div class="mgr_fileList_fileIcon mgr_workfileList_box"><input type="checkbox"></div>','<div class="mgr_fileList_fileIcon {[ParseUtil.getFileIcon(values.fileName)]}"></div>','<div class="mgr_workfileName" style="height: 50px;">','<div><div class="{[values.baseID]}" style="overflow: hidden;text-overflow: ellipsis;white-space: nowrap;width: 440px; font-size: 14px;margin-top: 10px;">{[ParseUtil.parseName(values.fileName)]}</div></div>','<div style="overflow: hidden;text-overflow: ellipsis;white-space: nowrap;width: 250px; color:#BCBCBC; margin-top: 8px; ">{fileSize:fileSize}</div>','</div>','<div class="mgr_file_workfont">','<tpl if="fileStatus==0 ||fileStatus==null">','<span> <a>打开</a></span>','<tpl else>','<span> <a>下载</a></span>','</tpl>','</div>','<div class="mgr_workfile_date">{[Utils.date2Str(values.updateTime)]}</div>'].join(''),listeners:{childtap:'ontapworkList'},initialize:function(){var a=this;a.callParent(arguments);a.element.on({delegate:'.x-listitem',contextmenu:'onFileContextmenu',scope:a});a.getScrollable().on({scroll:'onScrolList',scope:a})},onFileContextmenu:function(b){var d=b.currentTarget;if(!d){return}var l=this;var j=l.getStore();var i=d.getAttribute('data-recordindex');var a=j.getAt(i);if(!a){return}var c='file:///'+a.get('filePath');var h=a.get('msgID');var g=a.get('baseID');var e='workfile';var f=a.get('fileSize');var k=Ext.create('IMCommon.view.menu.FileMgrContextmenu',{value:c,path:c,msg_id:h,base_id:g,file_size:f,chose_where:e,fileName:a.get('fileName')});ParseUtil.menuShowAtVisible(k,b.getPoint());b.preventDefault()},onScrolList:function(a){var j=a.getScrollElement().dom,l=j.scrollHeight,m=j.scrollTop,k=j.offsetHeight;if(l<=m+k){if(!a.autoEnd){a.autoEnd=!0;var n=this;var e=n.getStore(),d=e.last();if(!d){return}var f=d.get('updateTime');if(!f){return}var i=Ext.Viewport.down('ceffilemgr').lookup('asp_time').getValue();var c;var h=Ext.Viewport.down('ceffilemgr').lookup('midpanel_searchfield').getValue();var g=Ext.Viewport.down('ceffilemgr').lookup('set_line').getValue();var b;if(i=='all'){c=0}else {if(i=='oneMonth'){c=Ext.Date.add(new Date(),Ext.Date.DAY,-30).getTime()}else {if(i=='threeMonth'){c=Ext.Date.add(new Date(),Ext.Date.DAY,-90).getTime()}else {if(i=='oneYear'){c=Ext.Date.add(new Date(),Ext.Date.DAY,-365).getTime()}}}}if(g=='timedown'){b='ORDER BY W.CreateAt DESC limit 50;'}else {if(g=='timeup'){b='ORDER BY W.CreateAt ASC limit 50;'}else {if(g=='sizedown'){b='ORDER BY W.FileSize DESC limit 50;'}else {if(g=='sizeup'){b='ORDER BY W.FileSize ASC limit 50;'}else {if(g=='namedown'){b='ORDER BY W.FileName DESC limit 50;'}else {if(g=='nameup'){b='ORDER BY W.FileName ASC limit 50;'}}}}}}if(h==''||h==null){if(d.data.showPart=='allFile'){LocalSearchMgr.searchLastFileByWorkDeskFileMgrFromTime(c,f,b,function(h,g){var c=g.rows;if(c.length<=0){a.autoEnd=!1;return}var f=[];for(var d=0;d<c.length;d++){var b=c.item(d);f.push({fileName:b.FileName,updateTime:b.CreateAt,remoteUrl:b.RemoteUrl,fileSize:b.FileSize,fileStatus:b.FileStatus,filePath:b.FilePath,baseID:b.ID,showPart:'allFile'})}e.add(f);a.autoEnd=!1},function(b){console.error('向下滚动时，查询数据出错',b.message);a.autoEnd=!1})}else {if(d.data.showPart=='isPicFile'){LocalSearchMgr.searchLastFileByWorkDeskFileMgrIsPicFromTime(c,f,b,function(h,g){var c=g.rows;if(c.length<=0){a.autoEnd=!1;return}var f=[];for(var d=0;d<c.length;d++){var b=c.item(d);f.push({fileName:b.FileName,updateTime:b.CreateAt,remoteUrl:b.RemoteUrl,fileSize:b.FileSize,fileStatus:b.FileStatus,filePath:b.FilePath,baseID:b.ID,showPart:'isPicFile'})}e.add(f);a.autoEnd=!1},function(b){console.error('向下滚动时，查询数据出错',b.message);a.autoEnd=!1})}else {if(d.data.showPart=='isNoPicFile'){LocalSearchMgr.searchLastFileByWorkDeskFileMgrIsNoPicFromTime(c,f,b,function(h,g){var c=g.rows;if(c.length<=0){a.autoEnd=!1;return}var f=[];for(var d=0;d<c.length;d++){var b=c.item(d);f.push({fileName:b.FileName,updateTime:b.CreateAt,remoteUrl:b.RemoteUrl,fileSize:b.FileSize,fileStatus:b.FileStatus,filePath:b.FilePath,baseID:b.ID,showPart:'isNoPicFile'})}e.add(f);a.autoEnd=!1},function(b){console.error('向下滚动时，查询数据出错',b.message);a.autoEnd=!1})}}}}else {if(d.data.showPart=='allFile'){LocalSearchMgr.searchPCByWorkListmore(c,f,b,h,function(h,g){var c=g.rows;if(c.length<=0){a.autoEnd=!1;return}var f=[];for(var d=0;d<c.length;d++){var b=c.item(d);f.push({fileName:b.FileName,updateTime:b.CreateAt,remoteUrl:b.RemoteUrl,fileSize:b.FileSize,fileStatus:b.FileStatus,filePath:b.FilePath,baseID:b.ID,showPart:'allFile'})}e.add(f);a.autoEnd=!1},function(b){console.error('向下滚动时，查询数据出错',b.message);a.autoEnd=!1})}else {if(d.data.showPart=='isPicFile'){LocalSearchMgr.searchPCByWorkListISPicmore(c,f,b,h,function(h,g){var c=g.rows;if(c.length<=0){a.autoEnd=!1;return}var f=[];for(var d=0;d<c.length;d++){var b=c.item(d);f.push({fileName:b.FileName,updateTime:b.CreateAt,remoteUrl:b.RemoteUrl,fileSize:b.FileSize,fileStatus:b.FileStatus,filePath:b.FilePath,baseID:b.ID,showPart:'isPicFile'})}e.add(f);a.autoEnd=!1},function(b){console.error('向下滚动时，查询数据出错',b.message);a.autoEnd=!1})}else {if(d.data.showPart=='isNoPicFile'){LocalSearchMgr.searchPCByWorkListISNotPicmore(c,f,b,h,function(h,g){var c=g.rows;if(c.length<=0){a.autoEnd=!1;return}var f=[];for(var d=0;d<c.length;d++){var b=c.item(d);f.push({fileName:b.FileName,updateTime:b.CreateAt,remoteUrl:b.RemoteUrl,fileSize:b.FileSize,fileStatus:b.FileStatus,filePath:b.FilePath,baseID:b.ID,showPart:'isNoPicFile'})}e.add(f);a.autoEnd=!1},function(b){console.error('向下滚动时，查询数据出错',b.message);a.autoEnd=!1})}}}}}}}});Ext.define('IMCef.view.fileMgr.CefFileMgr',{extend:'IMCef.src.MainView',xtype:'ceffilemgr',controller:'ceffilemgrcontroller',requires:['IMCef.view.fileMgr.CefFileMgrController','IMCommon.model.desktop.DeskFileMgr','IMCommon.model.desktop.DeskWorkFileMgr'],viewModel:{data:{uInfo:{},settings:{},org_names:'',user_name:'',role_names:'',mobile:'',sex:'',email:'',notes:'',send_hot_key:'Ctrl+Enter',autoStart:!0,capture_hot_key:'无',open_main_hot_key:'无',fileFolder:'默认',extras:{nap_type:'0',nap_end:'0'}}},title:'文件管理',layout:'vbox',cls:'settingMain',items:[{flex:1,layout:'hbox',items:[{layout:'vbox',width:96,userCls:'left_fileMgr',style:'border-right: 1px solid #DCDCDC;',reference:'cefmsgmgr_rct',items:[{xtype:'component',html:'会话文件',style:'text-align: center;margin-top: 10px;'},{xtype:'button',text:'全部',itemId:'msgfile_all',handler:'open_msgfileAll',reference:'msgfile_all',userCls:'msgfile_all',style:'margin-top: 5px;'},{xtype:'button',text:'文档',itemId:'msgfile_doc',handler:'open_msgfileDoc',reference:'msgfile_doc',userCls:'msgfile_doc',style:'margin-top: 5px;'},{xtype:'button',text:'图片',itemId:'msgfile_pic',handler:'open_msgfilePic',reference:'msgfile_pic',userCls:'msgfile_pic',style:'margin-top: 5px;'}]},{layout:'vbox',userCls:'right_fileMgr',style:'width:100%;',items:[{layout:'hbox',hieght:50,items:[{xtype:'container',itemId:'all_check_box',reference:'all_check_box',html:'<div class="mgr_allchoice"><input type="checkbox"></div>',style:'margin-left: 10px;border-bottom: 0px solid;margin-top: -5px;',listeners:{click:{element:'element',fn:'oncheckAll'}}},{xtype:'button',text:'批量操作',itemId:'allTodo',style:'height: 35px;margin-top: 10px;margin-left: 10px',menu:{items:[{text:'批量复制',value:'allCopy',handler:'allCpoy'},{text:'批量删除',value:'allDelete',handler:'allDel'}]}},{xtype:'selectfield',itemId:'asp_time',reference:'asp_time',cls:'fileMgrTime',style:'height: 35px;margin-top: 10px;margin-left: 25px;',clearable:!1,editable:!1,options:[{text:'不限',value:'all'},{text:'最近一个月',value:'oneMonth'},{text:'最近三个月',value:'threeMonth'},{text:'最近一年',value:'oneYear'}],listeners:{change:'onchangeTime'}},{xtype:'formpanel',reference:'searchForm',userCls:'midSearch',items:[{xtype:'fieldset',items:[{xtype:'searchfield',reference:'midpanel_searchfield',itemId:'midpanel_searchfield',placeholder:'名称、发送人',name:'query',listeners:{change:'onMiddleSearchFieldChg'}}]}]},{xtype:'selectfield',cls:'fileMgrOrder',itemId:'set_line',reference:'set_line',style:'height: 35px;margin-top: 10px;margin-left: 25px;',clearable:!1,editable:!1,options:[{text:'按发送时间降序',value:'timedown'},{text:'按发送时间升序',value:'timeup'},{text:'按文件大小降序',value:'sizedown'},{text:'按文件大小升序',value:'sizeup'},{text:'按文件名称降序',value:'namedown'},{text:'按文件名称升序',value:'nameup'}],listeners:{change:'onchangeLine'}},{xtype:'button',reference:'refreshBtn',itemId:'refreshBtn',iconCls:'x-fa fa-refresh',cls:'refresh-btn',handler:'onRefresh'}]},{xtype:'ceffilelist',reference:'ceffilelist',itemId:'ceffilelist',flex:1,width:785,scrollable:!0},{xtype:'cefworkfilelist',reference:'cefworkfilelist',itemId:'cefworkfilelist',flex:1,width:785,scrollable:!0,hidden:!0},{xtype:'container',cls:'thereis_None',itemId:'thereisNone',reference:'thereisNone',flex:1,width:'90%',layout:'vbox',hidden:!0,style:'    align-items: center;margin-top: 90px;',items:[{xtype:'container',hieght:30,html:'找不到满足条件的文件',style:'border-bottom: 0px solid;font-size: 22px;color: #888;'},{xtype:'container',height:165,width:140,cls:'thereis_NonePic',itemId:'thereis_NonePic',reference:'thereis_NonePic',style:'border-bottom: 0px solid;margin-top: 35px;margin-left: 30px;position: absolute;'}]},{xtype:'container',itemId:'allfiletotal',reference:'allfiletotal',height:30,layout:'hbox',items:[{xtype:'container',itemId:'allfilenum',reference:'allfilenum',style:'border:0px solid;margin-top: 5px;color: #BCBCBC;margin-left: 10px;font-size: 13px;',html:'111111'},{xtype:'container',itemId:'allfilesize',reference:'allfilesize',style:'border:0px solid;margin-top: 5px;color: #BCBCBC;margin-left: 110px;font-size: 13px;',html:'111111'},{xtype:'component',reference:'checkresult',style:'border:0px solid',html:''},{xtype:'container',itemId:'allfiletime',reference:'allfiletime',style:'border:0px solid;position: absolute;right: 115px;margin-top: 5px;color: #BCBCBC;font-size:13px;',html:'22222'}]}]}]}],initialize:function(){var a=this;a.callParent(arguments);Ext.ComponentQuery.query('#asp_time')[0].setValue('all');Ext.ComponentQuery.query('#set_line')[0].setValue('timedown');var b=Ext.ComponentQuery.query('#midpanel_searchfield')[0],c=b.inputElement.dom,j=function(){a.getController().lockMidSF=!0;a.getController().lockValue=b.getValue()},i=function(){a.getController().lockMidSF=!1;var c=b.getValue();a.getController().unlockValue=c;if(c!=a.getController().lockValue){a.getController().doMiddleSearchChg(b,c,a.lockValue)}};c.addEventListener('compositionstart',j);c.addEventListener('compositionend',i);Ext.ComponentQuery.query('#msgfile_all')[0].setUserCls('left_active');var h=0;var d='ORDER BY F.CreateAt DESC limit 50;';User.fileAll=!0;User.fileDoc=!1;User.filePic=!1;User.workAll=!1;User.workDoc=!1;User.workPic=!1;var e='文件大小： '+'0'+'MB';var f='时间： '+'不限';var g='已选文件： '+'0'+'个';Ext.ComponentQuery.query('#allfilenum')[0].setHtml(g);Ext.ComponentQuery.query('#allfilesize')[0].setHtml(e);Ext.ComponentQuery.query('#allfiletime')[0].setHtml(f);LocalSearchMgr.searchLastFileByFileMgr(h,d,function(e,d){var a=d.rows;if(a.length>0){Ext.ComponentQuery.query('#ceffilelist')[0].show();Ext.ComponentQuery.query('#thereisNone')[0].hide();var c=Ext.getStore('file_mgrlist');c.removeAll();for(var b=0;b<a.length;b++){c.add({fileName:a.item(b).FileName,updateTime:a.item(b).CreateAt,senderName:a.item(b).SenderName,fileSize:a.item(b).FileSize,fileStatus:a.item(b).FileStatus,filePath:a.item(b).FilePath,msgID:a.item(b).MsgID,baseID:a.item(b).BaseID,chatType:a.item(b).ChatType,displayName:a.item(b).DisplayName,showPart:'allFile'})}}else {Ext.ComponentQuery.query('#ceffilelist')[0].hide();Ext.ComponentQuery.query('#thereisNone')[0].show()}})}});Ext.define('IMCef.view.msgMgr.CefMsgMgrController',{extend:'Ext.app.ViewController',alias:'controller.cefMsgManager',listen:{controller:{'msgMgr_textfield':{advSearch:'onAdvancedSearch',searchP:'onSearchP',searchGN:'onSearchGN',searchCR:'onSearchCR',searchFile:'onSearchFile',bindDefault:'onBindRctDt',clearRctList:'onClearRctList',remHighlightWord:'onRemHighlightWord',showAdvSearch:'onShowAdvSearch'},'advspcontroller':{doAdvSearch:'onAdvSearch',doShowAdvP:'onShowAdvP'}}},init:function(){this.setMaxIcon();var a=this;var b=a.getView();a.callParent(arguments);b.element.on({tap:'onTapMM',scope:a});a.initConParam();a.doRichSearchField()},initConParam:function(){User.ownerID=cefMsgMgr.getUserID();User.token=cefMsgMgr.getToken();User.accountID=cefMsgMgr.getAccountID();var a=this;a.showNoMsgRct('default');a.getMsgUserInfo();window.reInit=function(){var b=a.getRctListStore();b.removeAll();var c=a.getRctListView();c.crtChatID='';a.showNoMsgRct('default');a.getMsgListStore().removeAll();a.getPicListStore().removeAll();a.getFileListStore().removeAll()}},bindRct:function(){var b=this;var a=window.setInterval(function(){if(window.sqlitePlugin){LocalSearchMgr.getChat(function(i,g){var d=g.rows;var c=[],f=b.getView().down('#msgRecentChat');if(d.length>0){var h=f.getStore();for(var e=0;e<d.length;e++){var a=d.item(e);c.push({chatID:a.ChatID,chatType:a.ChatType,chatName:a.DisplayName,chat_create_at:a.CreateAt,members:a.UserIDs,status:a.Status})}h.add(c)}f.defaultDatas=c});clearInterval(a)}},100)},onBindRctDt:function(){var b=this.getView().down('#msgRecentChat'),a=b.getStore();this.changeBG(!0);a.removeAll();a.add(b.defaultDatas)},onClearRctList:function(){this.getRctListStore().removeAll()},onTapMM:function(){var a=this.getView().down('#msgSearchTxt').searchPanel;if(a&&!a.isHidden()){a.hide()}},onAdvancedSearch:function(b){var a=this.getQuickAddPanel();if(!a.isHidden()){a.hide()}else {if(a.getParent()!==Ext.Viewport){Ext.Viewport.add(a)}a._hidden=!0;a.setHidden(!1);a.showBy(b.element,'tl-bl?')}},getQuickAddPanel:function(){var a=this.getView().down('#msgSearchTxt');if(!a.quickAddPanel){a.quickAddPanel=Ext.widget('AdvSPanel',{ownerCmp:a,listeners:{show:function(b){a.setRequired(!0)},hide:function(b){b.reset();if(b.getParent()===Ext.Viewport){Ext.Viewport.remove(b,!1)}a.setRequired(!1);a.blur()},ok:'onSearchOk',scope:a}})}return a.quickAddPanel},msgBeforeHide:function(){var a=this.getView().down('#msgSearchTxt').quickAddPanel;if(a){a.hide()}},onRemHighlightWord:function(a){this.highlightWord=a},onSearchP:function(b){var a=this;a.changeBG(!0);var c=a.getRctListStore();LocalSearchMgr.searchPtcp(b,function(k,h){var g=h.rows,i=g.length;var f=[];for(var e=0;e<i;e++){var d=g.item(e);if(!d.ChatID){continue}if(Ext.isEmpty(d.DisplayName)){continue}var j=ParseUtil.doHighLight(d.DisplayName,b);f.push({chatID:d.ChatID,chatType:d.ChatType,chatName:j,chat_create_at:d.CreateAt,members:d.UserIDs})}c.add(f);a.doEmptyText(a.getRctListView())})},onSearchGN:function(b){var a=this;a.changeBG(!0);var c=a.getRctListStore();LocalSearchMgr.searchGN(b,function(k,h){var g=h.rows,i=g.length;var f=[];for(var e=0;e<i;e++){var d=g.item(e);if(Ext.isEmpty(d.DisplayName)){continue}var j=ParseUtil.doHighLight(d.DisplayName,b);f.push({chatID:d.ChatID,chatType:d.ChatType,chatName:j,chat_create_at:d.CreateAt,members:d.UserIDs})}c.add(f);a.doEmptyText(a.getRctListView())})},onSearchCR:function(b){var a=this;a.changeBG(!1);var c=a.getRctListStore();LocalSearchMgr.searchChatName(b,function(j,h){var f=h.rows,i=f.length,e=[],g;for(var d=0;d<i;d++){g=f.item(d);e.push(a.addMsgRct(g,b))}c.add(e);a.doEmptyText(a.getRctListView())})},addMsgRct:function(a,c,b){if(!b){b=!1}return {showMsg:!0,showContent:!1,chatType:a.ChatType,members:a.UserIDs,chatID:a.ChatID,chat_create_at:a.CreateAt,chatName:a.DisplayName,msgCount:a.Counts,highlightWord:c,isFile:b}},addMsgToData:function(a,e,f,d,c){var b=ParseUtil.doHighLight(a.Content,d,!0);if(c){b='['+b+']'}return {showMsg:!0,chatID:a.ChatID,chatType:a.ChatType,chatName:a.DisplayName,chat_create_at:a.ChatCreateAt,members:a.UserIDs,msgCount:1,content:[{msg:b,senderName:a.SenderName,msgID:a.MsgID,msgSeq:a.MsgSeq,createAt:a.CreateAt}]}},addMsgToContent:function(a,f,e,d){var c=a.Content;if(d){c=FileUtil.getFileName(c)}var b=ParseUtil.doHighLight(c,e,!0);if(d){b='['+b+']'}return {msg:b,senderName:a.SenderName,SenderID:a.SenderID,msgID:a.MsgID,msgSeq:a.MsgSeq,createAt:a.CreateAt}},onSearchFile:function(b){var a=this;a.changeBG(!1);var c=a.getRctListStore();LocalSearchMgr.searchFile(b,function(j,h){var f=h.rows,i=f.length,e=[],g;for(var d=0;d<i;d++){g=f.item(d);e.push(a.addMsgRct(g,b,!0))}c.add(e);a.doEmptyText(a.getRctListView())})},doEmptyText:function(b){var a=b.emptyTextCmp||b.getEmptyTextCmp();if(a){var c=b.getStore();if(c.getCount()){a.hide()}else {a.show()}}},changeBG:function(a){if(a){this.getView().down('#msgRecentChat').setUserCls('search_msgList')}else {this.getView().down('#msgRecentChat').setUserCls('search_msgList_no_hov')}},msgOnChildTap:function(g,f){var b=this;var a=f.record;if(!a){return}var r=a.data.showMsg,e=a.data.chatID;if(r){var w=f.event,c=Ext.fly(w.target);if(c.hasCls('arrow')){if(c.hasCls('down')){if(a.get('showContent')){a.set({arrowUp:!0})}else {if(a.get('isFile')){LocalSearchMgr.searchFileContent(e,a.get('highlightWord'),function(m,j){var c=j.rows,k=c.length>50?50:c.length,e=c.length>50,l=a.get('highlightWord'),h=[],i;a.rowsArray=b.getRowsArray(c,e);for(var d=0;d<k;d++){if(Ext.isEmpty(c.item(d).Content)){continue}i=b.addMsgToContent(c.item(d),b,l,!0);h.push(i)}a.set({showContent:!0,content:h,arrowUp:!0,showMore:e})})}else {if(a.get('condition')){LocalSearchMgr.doAdvSearchContent(e,a.get('condition'),function(m,j){var c=j.rows,k=c.length>50?50:c.length,e=c.length>50,l=a.get('highlightWord'),h=[],i;a.rowsArray=b.getRowsArray(c,e);for(var d=0;d<k;d++){if(Ext.isEmpty(c.item(d).Content)){continue}i=b.addMsgToContent(c.item(d),b,l);h.push(i)}a.set({showContent:!0,content:h,arrowUp:!0,showMore:e})})}else {LocalSearchMgr.searchChatContent(e,a.get('highlightWord'),function(m,j){var c=j.rows,k=c.length>50?50:c.length,e=c.length>50,l=a.get('highlightWord'),h=[],i;a.rowsArray=b.getRowsArray(c,e);for(var d=0;d<k;d++){if(Ext.isEmpty(c.item(d).Content)){continue}i=b.addMsgToContent(c.item(d),b,l);h.push(i)}a.set({showContent:!0,content:h,arrowUp:!0,showMore:e})})}}}}else {a.set({arrowUp:!1})}}else {if(c.hasCls('wrsMsg')){var l=c.getAttribute('msg_id'),k=c.getAttribute('msg_seq'),i=c.getAttribute('create_at'),j=f.record.data.chatID;b.doLeftTapSRec(j,l,i,k);b.addActClass(c)}else {if(c.parent().hasCls('wrsMsg')){var m=c.parent(),l=m.getAttribute('msg_id'),k=c.getAttribute('msg_seq'),i=m.getAttribute('create_at'),j=f.record.data.chatID;b.doLeftTapSRec(j,l,i,k);b.addActClass(m)}else {if(c.hasCls('wrsMsg_loadmore')){var d=a.rowsArray.concat();if(d.length==0){return}var n=d.length>50?50:d.length,q=d.length>50,o=a.get('content'),v=a.get('highlightWord'),s=a.get('isFile');a.rowsArray=d.splice(n);for(var h=0;h<n;h++){if(Ext.isEmpty(d[h].Content)){continue}o.push(b.addMsgToContent(d[h],b,v,s))}a.set({content:o,showMore:q});var p=g.getScrollable(),t=p.getScrollElement().dom,u=t.scrollTop;g.refresh();p.scrollTo(0,u)}}}}return !1}if(g.crtChatID==e){return !1}b.doLeftTapSGN(e);g.crtChatID=e},getRowsArray:function(c,d){if(d){var b=[];for(var a=50;a<c.length;a++){b.push(c.item(a))}return b}return []},addActClass:function(b){if(!b.hasCls('act')){var c=Ext.query('.wrsMsg.act');for(var a=0;a<c.length;a++){Ext.fly(c[a]).removeCls('act')}b.addCls('act')}},doLeftTapSRec:function(a,d,b,c){this.doSRec(a,d,b,c);this.doSearchPic(a);this.doSearchFile(a)},doSRec:function(c,g,b,d){var a=this;a.beforeLeftTap();var f=a.highlightWord;var e=this.getMsgListStore();LocalSearchMgr.searchMsgContext(c,b,d,f,function(f,i){e.add(f);var h=i.MsgID;a.scrolToDMsg(a,h)})},doLeftTapSGN:function(a){this.doSGN(a);this.doSearchPic(a);this.doSearchFile(a)},doSGN:function(d){var a=this;var b=a.getMsgListView();a.beforeLeftTap();var c=this.getMsgListStore(),e=a.highlightWord;LocalSearchMgr.searchLastMsg(d,function(k,j){var i=j.rows;var h=[];for(var g=i.length-1;g>=0;g--){var f=i.item(g);h.push({chatID:f.ChatID,msgID:f.MsgID,updateTime:f.CreateAt,SenderID:f.SenderID,senderName:f.SenderName,content:f.Content,msgType:f.MsgType,width:f.Width,height:f.Height,fileName:f.FileName,fileSize:f.FileSize,filePath:f.FilePath,highlightWord:e,linkObjType:f.LinkObjType,linkTitle:f.LinkTitle,linkType:f.LinkType,linkStgGuid:f.LinkStgGuid,linkKeyString:f.LinkKeyString,status:f.Status,BFileSize:f.BFileSize,BFileName:f.BFileName,BFilePath:f.BFilePath})}c.add(h);a.doEmptyText(b);a.scrolMsgList(a)})},doSearchPic:function(a){var b=this;var c=b.getPicListStore();b.beforeLeftPic();MsgSearch.searchLastPic(a,function(h,g){var f=g.rows;var d={chatID:a};d.content=[];for(var e=0;e<f.length;e++){var b=f.item(e);d.content.push({fileID:b.FileID,baseID:b.BaseID,updateTime:b.CreateAt,SenderID:b.SenderID,senderName:b.SenderName,width:b.Width,height:b.Height,filePath:b.FilePath,fileName:b.FileName})}c.add(d)})},doSearchFile:function(a){var b=this;var c=b.getFileListStore();b.beforeLeftFile();MsgSearch.searchLastFile(a,function(h,g){var f=g.rows;var e=[];for(var d=0;d<f.length;d++){var b=f.item(d);e.push({chatID:a,baseID:b.BaseID,fileID:b.FileID,updateTime:b.CreateAt,SenderID:b.SenderID,senderName:b.SenderName,fileName:b.FileName,fileSize:b.FileSize,filePath:b.FilePath})}c.add(e)})},clearAllRightList:function(){this.beforeLeftTap();this.beforeLeftPic();this.beforeLeftFile()},beforeLeftTap:function(){this.getMsgListStore().removeAll()},beforeLeftPic:function(){this.getPicListStore().removeAll()},beforeLeftFile:function(){this.getFileListStore().removeAll()},getRctListView:function(){return this.getView().down('#msgRecentChat')},getRctListStore:function(){return this.getView().down('#msgRecentChat').getStore()},getMsgListView:function(){return this.getView().lookup('mgrMsgList')},getMsgListStore:function(){return this.getView().lookup('mgrMsgList').getStore()},getPicListStore:function(){return this.getView().lookup('mgrPicList').getStore()},getFileListStore:function(){return this.getView().lookup('mgrFileList').getStore()},scrolMsgList:function(a){AddDataUtil.onScroll(a.getView().lookup('mgrMsgList'))},scrolToDMsg:function(d,c){var a=d.getView().lookup('mgrMsgList'),b=a.getStore().findRecord('msgID',c);a.scrollToRecord(b)},onDblTapList:function(e,b){var a=b.record;if(!a){return}var c=a.get('chatID'),d=a.get('showMsg');if(d){if(Ext.fly(b.sourceElement).hasCls('wrsCName')){cefMsgMgr.exec('cefOpenChat',c)}}else {cefMsgMgr.exec('cefOpenChat',c)}},onShowMore:function(){this.onShowAdvSearch()},onShowAdvSearch:function(){var a=this.getView().down('#msgMgr_advP');if(a.getHidden()){a.show()}else {a.hide()}},onAdvSearch1:function(a){var b=this;var c=a.length;switch(c){case 1:b.doOneTypeSearch1(a);break;case 2:case 3:case 4:b.doMoreTypeSearch1(a);break;default:break;}this.onShowAdvSearch()},doOneTypeSearch1:function(c){var a=this;var b=c[0];a.onClearRctList();a.onRemHighlightWord(b.val);switch(b.type){case 'sn':a.onSearchP(b.val);break;case 'gn':a.onSearchGN(b.val);break;case 'mr':a.onSearchCR(b.val);break;case 'time':a.onSearchTime(b.val);break;default:break;}},doMoreTypeSearch1:function(b){var e=this;var c={sql:[],val:[]},f='',g='',d=!1;for(var a=0;a<b.length;a++){f=LocalSearchMgr.getConditions(b[a].type,b[a].val);if(f.sql){c.sql.push(f.sql);c.val.push(f.val)}if(!d){d=this.isShowMsg(b[a].type);if(d){g=b[a].val}}}LocalSearchMgr.doAdvSearch(c,function(f,a){e.onClearRctList();if(d){e.onRemHighlightWord(g);e.doShowMsgRct(a,g,c)}else {e.doNotShowMsgRct(a)}})},isShowMsg:function(a){if(a=='mr'){return !0}return !1},doShowMsgRct:function(g,j,d){var a=this;a.changeBG(!1);var h=a.getRctListStore();var e=g.rows,i=e.length,c=[],f;for(var b=0;b<i;b++){f=e.item(b);c.push(a.addMsgRct(f,j));if(d){c[b].condition=d}}h.add(c);a.doEmptyText(a.getRctListView())},doNotShowMsgRct:function(g,j){var c=this;c.changeBG(!0);var h=c.getRctListStore();var e=g.rows,i=e.length;var b=[],a,f;for(var d=0;d<i;d++){a=e.item(d);f=ParseUtil.doHighLight(a.DisplayName,j);b.push({chatID:a.ChatID,chatType:a.ChatType,chatName:f,chat_create_at:a.CreateAt,members:a.UserIDs})}b=ParseUtil.objArrReduce(b,'chatID');h.add(b);c.doEmptyText(c.getRctListView())},onSearchTime:function(a){var b=0;if(a){b=LocalSearchMgr.getSearchTime(a)}var c=this;LocalSearchMgr.searchChatByTime(b,function(d,b){c.doNotShowMsgRct(b)})},doThreeTypeSearch:function(a){},doFourTypeSearch:function(a){},onTabChanges:function(a,c,b){},min:function(){cefMsgMgr.min()},max:function(){cefMsgMgr.max()},close:function(){var c=this;var b=c.getView();var a=b.lookup('msgmgr_rich_searchfield');if(a){a.clear()}cefMsgMgr.close()},setMaxIcon:function(){window.setMaxIcon=function(b){var a=Ext.Viewport.lookup('cefMsgMgr').down('#cefMax');if(b=='max'){a.setIconCls('im-common-maximize')}else {a.setIconCls('im-common-restore')}}},doRichSearchField:function(){var a=this;var b=a.getView();var c=b.lookup('msgmgr_rich_searchfield');c.doUIRenderBySearch=function(b){a.bindConditionsToAdvP(b);a.onBindRctByConditions(b)}},bindConditionsToAdvP:function(a){this.clearAdvP();var c=this.getView().down('#msgMgr_advP'),h=c.down('#asp_pt'),f=c.down('#asp_gn'),g=c.down('#asp_mr'),e=c.down('#asp_fn'),d=c.down('#asp_time');for(var b in a){switch(b){case SearchType.SendName:h.setValue(a[b]);break;case SearchType.GroupName:f.setValue(a[b]);break;case SearchType.MsgRecord:g.setValue(a[b]);break;case SearchType.FileName:e.setValue(a[b]);break;case SearchType.Time:d.setValue(a[b]);break;default:break;}}},clearAdvP:function(){var a=this.getView().down('#msgMgr_advP'),f=a.down('#asp_pt'),d=a.down('#asp_gn'),e=a.down('#asp_mr'),c=a.down('#asp_fn'),b=a.down('#asp_time');if(f){f.clearValue()}if(d){d.clearValue()}if(e){e.clearValue()}if(c){c.clearValue()}if(b){b.setValue('all')}},onShowAdvP:function(){var b=this.getView().lookup('msgmgr_rich_searchfield'),a=b.getSearchConditions();this.bindConditionsToAdvP(a)},onAdvSearch:function(e){var c=this,g=c.getView().lookup('msgmgr_rich_searchfield'),a,b='';g.clear();var f=e.length;if(f>0){for(var d=0;d<f;d++){a=e[d];if(a.type==SearchType.Time){b=LocalSearchMgr.getTimeStr(a.val)}else {b=a.val}g.doInsertSearchObj(a.type,b,a.val)}}else {c.showNoMsgRct('default')}c.onShowAdvSearch()},onBindRctByConditions:function(a){if(!a||Object.keys(a).length==0){this.showNoMsgRct('default');return}else {if(Object.keys(a).length==1){this.analysisOneType(a)}else {this.analysisMoreType(a)}}},doOneTypeSearch:function(c){var b=this,a;for(var d in c){a={type:d,val:c[d]};break}b.onClearRctList();b.onRemHighlightWord(a.val);switch(a.type){case 'sn':b.onSearchP(a.val);break;case 'gn':b.onSearchGN(a.val);break;case 'mr':b.onSearchCR(a.val);break;case 'time':b.onSearchTime(a.val);break;default:break;}},doMoreTypeSearch:function(f){var c=this;var a={sql:[],val:[]},d='',g='',b=!1;for(var e in f){d=LocalSearchMgr.getConditions(e,f[e]);if(d.sql){a.sql.push(d.sql);a.val.push(d.val)}if(!b){b=this.isShowMsg(e);if(b){g=f[e]}}}LocalSearchMgr.doAdvSearch(a,function(e,d){c.onClearRctList();if(b){c.onRemHighlightWord(g);c.doShowMsgRct(d,g,a)}else {c.doNotShowMsgRct(d)}})},analysisOneType:function(a){if(a.mr||a.fn){this.showHasMsgRct('oneType',a)}else {this.showNoMsgRct('oneType',a)}},analysisMoreType:function(a){if(a.mr||a.fn){this.showHasMsgRct('moreType',a)}else {this.showNoMsgRct('moreType',a)}},onRememberParams:function(a){this.searchParams=a},getRememberParams:function(){var a=this.searchParams;if(!Ext.isObject(a)){return {}}return a},getStoreHighlightObj:function(a){if(Ext.isEmpty(a)){a={}}if(Ext.isArray(a)){for(var b=0,c=a.length;b<c;b++){a[b]=this.doGetStorehlObj(a[b])}}else {if(Ext.isObject(a)){a=this.doGetStorehlObj(a)}}return a},doGetStorehlObj:function(a){var b=this.getRememberParams();var d=!1;for(var c in b){switch(c){case SearchType.MsgRecord:a.content=ParseUtil.doHighLight(a.content,b[c]);break;case SearchType.SendName:a.senderName=ParseUtil.doHighLight(a.senderName,b[c]);break;case SearchType.FileName:a.fileName=ParseUtil.doHighLight(a.fileName,b[c]);a.BFileName=ParseUtil.doHighLight(a.BFileName,b[c]);break;default:break;}d=!0}a.needHighlight=d;return a},getMsgUserInfo:function(){Utils.custAjax('get','users/all',{success:function(b,c){var a=b.users;User.pushUserInfo(a)},failure:function(){},callback:function(){}})},showNoMsgRct:function(f,e){var a=this,b=a.getNoMsgRct();a.onRememberParams(e);var c=b.events.ilpsearch;if(c){for(var d=0,g=c.listeners.length;d<g;d++){c.removeListener(c.listeners[d].fn,c.listeners[d].scope)}}switch(f){case 'default':b.on({ilpSearch:'doILPDefaultSearch',scope:a});break;case 'oneType':b.on({ilpSearch:'doILPOneTypeSearchNoMsg',scope:a});break;case 'moreType':b.on({ilpSearch:'doILPMoreTypeSearchNoMsg',scope:a});break;default:break;}a.showRctList(b,a.currentList);a.currentList=b;b.setSearchParams(e);b.doDataAddFunc();a.clearAllRightList()},getNoMsgRct:function(){var b=this,a=b.noMsgList;if(!a){a=b.noMsgList=Ext.create('IMCommon.view.list.imitateListPaging',{imitateListPagingType:'noMsg',userCls:'search_msgList',flex:1,store:{autoDestroy:!0,fields:['chatID','chat_create_at','members','status','chatType','chatName']},emptyText:'未查询到相关结果',itemTpl:['<div class="chatName">','{[MsgHelper.getAvaHtml(values)]}','{[ParseUtil.doHighLight(values.chatName, values.highlightWord, true)]}','</div>'].join('')});a.on({childsingletap:'noMsgSingleTapRct',childdoubletap:'noMsgDoubleTapRct',scope:b})}return a},noMsgSingleTapRct:function(d,b){var a=b.record;if(!a){return}var c=a.get('chatID');this.doLeftTapSGN1(c)},doLeftTapSGN1:function(a){this.doSGN1(a);this.doSearchPic(a);this.doSearchFile(a)},doSGN1:function(d){var a=this;var b=a.getMsgListView();a.beforeLeftTap();var c=this.getMsgListStore();LocalSearchMgr.searchLastMsg(d,function(k,j){var i=j.rows;var h=[],f;for(var g=i.length-1;g>=0;g--){var e=i.item(g);f={chatID:e.ChatID,msgID:e.MsgID,updateTime:e.CreateAt,SenderID:e.SenderID,senderName:e.SenderName,content:e.Content,msgType:e.MsgType,width:e.Width,height:e.Height,fileID:e.FileID,fileName:e.FileName,fileSize:e.FileSize,filePath:e.FilePath,linkObjType:e.LinkObjType,linkTitle:e.LinkTitle,linkType:e.LinkType,linkStgGuid:e.LinkStgGuid,linkKeyString:e.LinkKeyString,status:e.Status,BFileSize:e.BFileSize,BFileName:e.BFileName,BFilePath:e.BFilePath};f=a.getStoreHighlightObj(f);h.push(f)}c.add(h);a.doEmptyText(b);a.scrolMsgList(a)})},noMsgDoubleTapRct:function(d,c){var a=c.record;if(!a){return}var b=a.get('chatID');if(!b){return}cefMsgMgr.exec('cefOpenChat',b)},doILPDefaultSearch:function(b,c,a,d){LocalSearchMgr.getChat1(c,a,function(l,i){var h=i.rows,k=h.length;var g=[],j=b.getStore(),e;for(var f=0;f<k;f++){e=h.item(f);g.push({chatID:e.ChatID,chatType:e.ChatType,chatName:e.DisplayName,chat_create_at:e.CreateAt,members:e.UserIDs,status:e.Status})}j.add(g)})},doILPOneTypeSearchNoMsg:function(h,d,b,e){var f=Object.keys(e)[0],a=Object.values(e)[0];var c=function(n,k){var j=k.rows,m=j.length;var i=[],l=h.getStore(),c;for(var g=0;g<m;g++){c=j.item(g);i.push({chatID:c.ChatID,chatType:c.ChatType,chatName:c.DisplayName,chat_create_at:c.CreateAt,members:c.UserIDs,status:c.Status,highlightWord:f==SearchType.Time?'':a})}l.add(i)};switch(f){case SearchType.SendName:LocalSearchMgr.searchPtcp1(d,b,a,c);break;case SearchType.GroupName:LocalSearchMgr.searchGN1(d,b,a,c);break;case SearchType.Time:var g=0;if(a){g=LocalSearchMgr.getSearchTime(a)};LocalSearchMgr.searchChatByTime1(d,b,g,c);break;default:break;}},doILPMoreTypeSearchNoMsg:function(f,g,e,c){var b={sql:[],val:[]},a='',h='';for(var d in c){a=LocalSearchMgr.getConditions(d,c[d]);if(a.sql){b.sql.push(a.sql);b.val.push(a.val)}}LocalSearchMgr.doAdvSearch1(g,e,b,function(m,j){var k=f.getStore();var i=j.rows,l=i.length;var b=[],a;for(var d=0;d<l;d++){a=i.item(d);b.push({chatID:a.ChatID,chatType:a.ChatType,chatName:a.DisplayName,chat_create_at:a.CreateAt,highlightWord:h,members:a.UserIDs})}b=ParseUtil.objArrReduce(b,'chatID');k.add(b)})},showHasMsgRct:function(f,e){var a=this,b=a.getHasMsgRct();a.onRememberParams(e);var c=b.events.ilpsearch;if(c){for(var d=0,g=c.listeners.length;d<g;d++){c.removeListener(c.listeners[d].fn,c.listeners[d].scope)}}switch(f){case 'oneType':b.on({ilpSearch:'doILPOneTypeSearchHasMsg',scope:a});break;case 'moreType':b.on({ilpSearch:'doILPMoreTypeSearchHasMsg',scope:a});break;default:break;}a.showRctList(b,a.currentList);a.currentList=b;b.setSearchParams(e);b.doDataAddFunc();a.clearAllRightList()},getHasMsgRct:function(){var b=this,a=b.hasMsgList;if(!a){a=b.hasMsgList=Ext.create('IMCommon.view.list.imitateListPaging',{imitateListPagingType:'hasMsg',userCls:'search_msgList_no_hov',flex:1,store:{autoDestroy:!0,fields:['chatID','chat_create_at','members','status','chatType','chatName','msgCount','content']},emptyText:'未查询到相关结果',itemTpl:['<div class="wrapSearch">','<div class="wrsCName">','{[MsgHelper.getAvaHtml(values)]}',"<div class=\"arrow {[values.arrowUp ? '':'down']}\"></div>",'<div class="wrsMCount">{msgCount}</div>','{chatName}','</div>','<tpl if="values.showContent">','<div class="wrsMsg_content" style="display:{[values.arrowUp ? \'inline-block\':\'none\']}">','<tpl for="content">','<div class="wrsMsg" msg_id="{msgID}" msg_seq="{msgSeq}" create_at="{createAt}">','<div style="overflow:hidden;word-wrap:break-word;white-space:nowrap;text-overflow:ellipsis;">{msg}</div>','</div>','</tpl>','</div>','<div class="{[values.showMore?"wrsMsg_loadmore":"wrsMsg_hasnomore"]} {[values.arrowUp ? \'block\':\'none\']}">{[values.showMore?"加载更多...":"已无更多"]}</div>','</tpl>','</div>'].join('')});a.on({childsingletap:'hasMsgSingleTapRct',childdoubletap:'hasMsgDoubleTapRct',scope:b})}return a},hasMsgSingleTapRct:function(o,k){var a=k.record;if(!a){return}var e=a.get('chatID');if(!e){return}var b=this,u=k.event,c=Ext.fly(u.target);if(c.hasCls('arrow')){if(c.hasCls('down')){if(a.get('showContent')){a.set({arrowUp:!0})}else {if(a.get('isFile')){LocalSearchMgr.searchFileContent(e,a.get('highlightWord'),function(l,h){var c=h.rows,i=c.length>50?50:c.length,e=c.length>50,j=a.get('highlightWord'),f=[],g;a.rowsArray=b.getRowsArray(c,e);for(var d=0;d<i;d++){if(Ext.isEmpty(c.item(d).Content)){continue}g=b.addMsgToContent(c.item(d),b,j,!0);f.push(g)}a.set({showContent:!0,content:f,arrowUp:!0,showMore:e})})}else {if(a.get('condition')){LocalSearchMgr.doAdvSearchContent(e,a.get('condition'),function(l,h){var c=h.rows,i=c.length>50?50:c.length,e=c.length>50,j=a.get('highlightWord'),f=[],g;a.rowsArray=b.getRowsArray(c,e);for(var d=0;d<i;d++){if(Ext.isEmpty(c.item(d).Content)){continue}g=b.addMsgToContent(c.item(d),b,j);f.push(g)}a.set({showContent:!0,content:f,arrowUp:!0,showMore:e})})}else {LocalSearchMgr.searchChatContent(e,a.get('highlightWord'),function(l,h){var c=h.rows,i=c.length>50?50:c.length,e=c.length>50,j=a.get('highlightWord'),f=[],g;a.rowsArray=b.getRowsArray(c,e);for(var d=0;d<i;d++){if(Ext.isEmpty(c.item(d).Content)){continue}g=b.addMsgToContent(c.item(d),b,j);f.push(g)}a.set({showContent:!0,content:f,arrowUp:!0,showMore:e})})}}}}else {a.set({arrowUp:!1})}}else {if(c.hasCls('wrsMsg')){var i=c.getAttribute('msg_id'),h=c.getAttribute('msg_seq'),g=c.getAttribute('create_at');b.doLeftTapSRec1(e,i,g,h);b.addActClass(c)}else {if(c.parent().hasCls('wrsMsg')){var j=c.parent(),i=j.getAttribute('msg_id'),h=c.getAttribute('msg_seq'),g=j.getAttribute('create_at');b.doLeftTapSRec1(e,i,g,h);b.addActClass(j)}else {if(c.hasCls('wrsMsg_loadmore')){var d=a.rowsArray.concat();if(d.length==0){return}var l=d.length>50?50:d.length,p=d.length>50,m=a.get('content'),t=a.get('highlightWord'),q=a.get('isFile');a.rowsArray=d.splice(l);for(var f=0;f<l;f++){if(Ext.isEmpty(d[f].Content)){continue}m.push(b.addMsgToContent(d[f],b,t,q))}a.set({content:m,showMore:p});var n=o.getScrollable(),r=n.getScrollElement().dom,s=r.scrollTop;o.refresh();n.scrollTo(0,s)}}}}},doLeftTapSRec1:function(a,d,b,c){this.doSRec1(a,d,b,c);this.doSearchPic(a);this.doSearchFile(a)},doSRec1:function(c,f,b,d){var a=this;a.beforeLeftTap();var e=this.getMsgListStore();LocalSearchMgr.searchMsgContext(c,b,d,'',function(g,i){g=a.getStoreHighlightObj(g,!0);e.add(g);var h=i.MsgID;a.scrolToDMsg(a,h)})},hasMsgDoubleTapRct:function(d,c){var a=c.record;if(!a){return}var b=a.get('chatID');if(!b){return}cefMsgMgr.exec('cefOpenChat',b)},doILPOneTypeSearchHasMsg:function(g,h,e,b){var i=this,c,a;for(var d in b){c=d;a=b[d];break}var f=function(n,l){var k=l.rows,m=k.length,f=[],j=g.getStore(),c;for(var d=0;d<m;d++){c=k.item(d);f.push({showContent:!1,chatType:c.ChatType,chatID:c.ChatID,chat_create_at:c.CreateAt,chatName:c.DisplayName,msgCount:c.Counts,highlightWord:a,isFile:!1,members:c.UserIDs})}j.add(f);i.autoShowFirstHasMsgRecord(j.getAt(0))};switch(c){case SearchType.MsgRecord:LocalSearchMgr.searchChatName1(h,e,a,f);break;default:break;}},doILPMoreTypeSearchHasMsg:function(g,h,f,b){var d=this;var a={sql:[],val:[]},c='',i=b[Object.keys(b)[0]];for(var e in b){c=LocalSearchMgr.getConditions(e,b[e]);if(c.sql){a.sql.push(c.sql);a.val.push(c.val)}}LocalSearchMgr.doAdvSearch1(h,f,a,function(o,m){var j=g.getStore();var k=m.rows,n=k.length,e=[],l;for(var c=0;c<n;c++){l=k.item(c);e.push(d.addMsgRct(l,i));if(a){e[c].condition=a}}j.add(e);d.autoShowFirstHasMsgRecord(j.getAt(0))})},autoShowFirstHasMsgRecord:function(a){var b=this;var c=a.get('chatID');if(!c){return}if(a.get('isFile')){LocalSearchMgr.searchFileContent(c,a.get('highlightWord'),function(k,h){var c=h.rows,i=c.length>50?50:c.length,e=c.length>50,j=a.get('highlightWord'),f=[],g;a.rowsArray=b.getRowsArray(c,e);for(var d=0;d<i;d++){if(Ext.isEmpty(c.item(d).Content)){continue}g=b.addMsgToContent(c.item(d),b,j,!0);f.push(g)}a.set({showContent:!0,content:f,arrowUp:!0,showMore:e})})}else {if(a.get('condition')){LocalSearchMgr.doAdvSearchContent(c,a.get('condition'),function(k,h){var c=h.rows,i=c.length>50?50:c.length,e=c.length>50,j=a.get('highlightWord'),f=[],g;a.rowsArray=b.getRowsArray(c,e);for(var d=0;d<i;d++){if(Ext.isEmpty(c.item(d).Content)){continue}g=b.addMsgToContent(c.item(d),b,j);f.push(g)}a.set({showContent:!0,content:f,arrowUp:!0,showMore:e})})}else {LocalSearchMgr.searchChatContent(c,a.get('highlightWord'),function(k,h){var c=h.rows,i=c.length>50?50:c.length,e=c.length>50,j=a.get('highlightWord'),f=[],g;a.rowsArray=b.getRowsArray(c,e);for(var d=0;d<i;d++){if(Ext.isEmpty(c.item(d).Content)){continue}g=b.addMsgToContent(c.item(d),b,j);f.push(g)}a.set({showContent:!0,content:f,arrowUp:!0,showMore:e})})}}},showRctList:function(b,a){if(a){if(a.imitateListPagingType==b.imitateListPagingType){var e=b.getStore();e.removeAll();return}if(a.imitateListPagingType=='noMsg'){this.noMsgList=null}else {if(a.imitateListPagingType=='hasMsg'){this.hasMsgList=null}}Ext.destroy(a)}var c=this.lookup('cefmsgmgr_rct'),d=c.down('#msgMgr_advP');c.insertAfter(b,d)}});Ext.define('IMCef.view.msgMgr.widget.MsgSearchFieldController',{extend:'Ext.app.ViewController',alias:'controller.msgMgr_textfield',onShowMore:function(){this.fireEvent('showAdvSearch')},onSearchOk:function(){alert('开始搜索')},onAdvSearch:function(a){this.fireEvent('advSearch',a)},realignPanel:function(){this.h()},onHide:function(){this.h()},h:function(){var d=this;var c=d.getView();var a=c.quickAddPanel;var b=c.searchPanel;if(a&&!a.getHidden()){a.hide()}if(b&&!b.getHidden()){b.realign()}},onChangeText:function(d,c,g,h){var b=this;var e=b.getView();var a=e.searchPanel;if(c){if(!a){a=b.getSearchP(c);if(a.getParent()!==Ext.Viewport){Ext.Viewport.add(a)}}else {var f=b.getSearchHTML(c);a.setHtml(f)}a._hidden=!0;a.setHidden(!1);a.showBy(d.element,'tl-bl?');a.focus()}else {if(a){a.hide()}b.fireEvent('bindDefault')}},getSearchP:function(d){var b=this;var a=b.getView();if(!a.searchPanel){var c=b.getSearchHTML(d);a.searchPanel=Ext.create('Ext.Panel',{floated:!0,scrollable:!0,focusable:!0,bodyPadding:10,width:279,html:c});a.searchPanel.element.on({tap:'onTapAP',scope:b})}return a.searchPanel},getSearchHTML:function(a){return ['<div class="searchP" search_value="'+a+'">','<div class="search_p_nor search_participate searchP_active" search_value="'+a+'"><p class="search_participate">发送人：</p>'+a+'</div>','<div class="search_p_nor search_group_name" search_value="'+a+'"><p class="search_group_name">会话：</p>'+a+'</div>','<div class="search_p_nor search_chat_record" search_value="'+a+'"><p class="search_chat_record">聊天记录：</p>'+a+'</div>','<div class="search_p_nor search_file" search_value="'+a+'"><p class="search_file">文件：</p>'+a+'</div>','</div>'].join('')},onTapAP:function(c){var b=this,a=Ext.fly(c.target);if(a.hasCls('search_participate')){b.doPSearch(a)}if(a.hasCls('search_group_name')){b.doGNSearch(a)}if(a.hasCls('search_chat_record')){b.doCRSearch(a)}if(a.hasCls('search_file')){b.doFSearch(a)}},doSearch:function(a){var b=this;if(a.hasCls('search_participate')){b.doPSearch(a)}if(a.hasCls('search_group_name')){b.doGNSearch(a)}if(a.hasCls('search_chat_record')){b.doCRSearch(a)}if(a.hasCls('search_file')){b.doFSearch(a)}},doPSearch:function(a){var b=this.beforeSearch(a);this.fireEvent('searchP',b)},doGNSearch:function(a){var b=this.beforeSearch(a);this.fireEvent('searchGN',b)},doCRSearch:function(a){var b=this.beforeSearch(a);this.fireEvent('searchCR',b)},doFSearch:function(a){var b=this.beforeSearch(a);this.fireEvent('searchFile',b)},beforeSearch:function(b){var a=b.getParent().getAttribute('search_value');this.getView().searchPanel.hide();this.fireEvent('clearRctList');this.fireEvent('remHighlightWord',a);return a},doEnterKey:function(){var a=this;var b=a.beforeDoKey();if(!b){return}a.doSearch(b)},doUpKey:function(){var b=this;var a=b.beforeDoKey();if(!a){return}if(a.prev()){a.removeCls('searchP_active');a.prev().addCls('searchP_active')}},doDownKey:function(){var b=this;var a=b.beforeDoKey();if(!a){return}if(a.next()){a.removeCls('searchP_active');a.next().addCls('searchP_active')}},beforeDoKey:function(){var a=this.getView().searchPanel;if(!a){return}if(a.getHidden()){return}var b=a.el.query('.searchP_active')[0];if(!b){return}var c=Ext.fly(b);return c}});Ext.define('IMCef.view.msgMgr.widget.MsgSearchField',{extend:'Ext.field.Text',xtype:'msgSearchTF',controller:'msgMgr_textfield',requires:['IMCef.view.msgMgr.widget.MsgSearchFieldController'],ui:'big',placeholder:'搜索',triggers:{add:{cls:'',handler:'onShowMore'}},initialize:function(){var a=this;a.callParent(arguments);a.on({change:'onChangeText',hide:'onHide',scope:a.getController()});var b=new Ext.util.KeyMap({target:a.element,binding:[{key:13,handler:function(){a.getController().doEnterKey()},scope:a},{key:37,handler:function(a,b){},scope:a},{key:38,handler:function(c,b){a.getController().doUpKey();b.preventDefault()},scope:a},{key:39,handler:function(){},scope:a},{key:40,handler:function(c,b){a.getController().doDownKey();b.preventDefault()},scope:a}]})},destroy:function(){var a=this;Ext.destroy(a.quickAddPanel);Ext.destroy(a.searchPanel);a.callParent(arguments)}});Ext.define('IMCef.view.msgMgr.tabPanel.MgrMsgList',{extend:'Ext.List',xtype:'mgr_msgList',uses:['IMCommon.view.menu.TextContextmenu','IMCommon.view.menu.ImgContextmenu','IMCommon.view.menu.FileContextmenu','IMCommon.view.menu.ErpLinkContextmenu'],cls:'mgr_msgList',emptyText:'暂无会话',store:{fields:['chatID','msgID',{name:'updateTime',type:'int'},'senderName','content','msgType','width','height','fileName','fileSize','filePath','fileStatus','highlightWord']},itemTpl:['<tpl if="values.msgType!=\'R\'">','<tpl if="values.msgType!=\'S\'">','<div class="mgr_msgList_imitate">','<div class="mgr_msgList_name" style="color:{[values.SenderID == User.ownerID ? \'rgb(36, 118, 224)\' : \'\']}">{senderName} {[Utils.datetime2Ago(values.updateTime,true)]}</div>','<div class="mgr_msgList_context" {[MsgHelper.pushInfoToDom(values)]}>','<tpl if="values.msgType == \'I\'">','{[MsgHelper.parseLoadedPic(values.height,values.width,values.filePath,values.updateTime,values.fileID,values.fileName)]}','<tpl elseif="values.msgType == \'F\'">','{[MsgHelper.parseLoadedFile1(values.fileName,values.fileSize)]}','<tpl elseif="values.msgType == \'T\'">','<tpl if="values.needHighlight">','<div class="mgr_msgList_text">{content}</div>','<tpl else>','<div class="mgr_msgList_text">{[ParseUtil.parseTextToHtml(values.content)]}</div>','</tpl>','<tpl elseif="values.msgType == \'G\'">','<div class="mgr_msgList_text">{[ParseUtil.milGrpChgMsg(values.content)]}</div>','<tpl elseif="values.msgType==\'L\'">','{[MsgHelper.parseERPLink(values)]}','<tpl elseif="values.msgType == \'B\'">','{[GroupNotice.getRevokeNotice(values.SenderID,values.content)]}','<tpl elseif="values.msgType == \'N\'">','{[ParseUtil.getSureName(values.SenderID)]}修改了群公告&nbsp;','<tpl elseif="values.msgType == \'E\'">','{[MsgHelper.parseLoadedBFile1(values.BFileName,values.BFileSize)]}','<tpl else>','<div class="mgr_msgList_text">消息类型未适配：{msgType}</div>','</tpl>','</div>','</div>','</tpl>','</tpl>'].join(''),initialize:function(){var a=this;a.callParent(arguments);a.getScrollable().on({scroll:'onScrolList',scope:a});a.on({childtap:'onTapList',scope:a});a.element.on({delegate:'.mgr_msgList_context',contextmenu:'onShowContextmenu',scope:a})},onShowContextmenu:function(f){var a=f.currentTarget;if(!a){return}var c,b,d;var g=a.getAttribute('type');switch(g){case MsgType.TextMsg:var e=ParseUtil.getSelectedContents();if(!e){ParseUtil.selectText(a);e=a.innerHTML};b=ParseUtil.htmlToText(e);c=Ext.create('IMCommon.view.menu.TextContextmenu',{value:b});break;case MsgType.ImgMsg:b=a.getAttribute('origin_path');d=a.getAttribute('fileName');var i=this,h=Ext.fly(a).query('img')[0];c=Ext.create('IMCommon.view.menu.ImgContextmenu',{createAt:a.getAttribute('create_at'),value:b,path:b,fileName:d,openMore:!0,img:h,selectPlace:i,clsSelector:'img.mgr_msgList_viewPic'});break;case MsgType.FileMsg:b=a.getAttribute('origin_path');d=a.getAttribute('fileName');c=Ext.create('IMCommon.view.menu.FileContextmenu',{value:b,path:b,fileName:d});break;case MsgType.LinkErp:b=a.getAttribute('content');c=Ext.create('IMCommon.view.menu.ErpLinkContextmenu',{value:b,linkObjType:a.getAttribute('linkObjType'),linkStgGuid:a.getAttribute('linkStgGuid'),linkKeyString:a.getAttribute('linkKeyString'),linkType:a.getAttribute('linkType')});break;case MsgType.BigFileMsg:b=a.getAttribute('origin_path');d=a.getAttribute('fileName');c=Ext.create('IMCommon.view.menu.FileContextmenu',{value:b,path:b,fileName:d});break;default:break;}if(c){ParseUtil.menuShowAtVisible(c,f.getPoint())}f.preventDefault()},onTapList:function(h,d){var f=d.record;if(!f){return}var i=d.event;var e=Ext.fly(i.target);var c='img.mgr_msgList_viewPic';if(e.is(c)){var g=h.innerElement.dom.querySelectorAll(c),a=[],b=-1;g.forEach(function(c,f){a.push({url:c.src,original:ImgMgr.getFullPicUrl(c.getAttribute('fileID')),name:c.getAttribute('fileName'),createAt:c.getAttribute('create_at')});if(e.dom===c){b=f}});if(window.cefMsgMgr){a=JSON.stringify(a);cefMsgMgr.viewImages(a,b)}}},onScrolList:function(a,o,l,m,n){if(l==0){if(!a.autoTop){var g=this;var c=g.getStore(),b=c.getAt(0);if(!b){return}a.autoTop=!0;var f=b.get('chatID'),d=b.get('updateTime');MsgSearch.searchMsgAgo(f,d,function(h,f){var d=f.rows;if(d.length<=0){a.autoTop=!1;return}var e=g.pushRowsReverse1(d);c.insert(0,e);g.scrollToRecord(b);a.autoTop=!1},function(b){console.log('向上滚动时，查询数据出错',b.message);a.autoTop=!1})}}var e=a.getScrollElement().dom,j=e.scrollHeight,k=e.scrollTop,i=e.offsetHeight;if(j<=k+i){var h=this;var c=h.getStore(),b=c.last();if(!b){return}var f=b.get('chatID'),d=b.get('updateTime');if(!d){return}if(!a.autoEnd){a.autoEnd=!0;MsgSearch.searchMsgEnd(f,d,function(f,e){var b=e.rows;if(b.length<=0){a.autoEnd=!1;return}var d=h.pushRowsOrdered1(b);c.add(d);a.autoEnd=!1},function(b){console.log('向下滚动时，查询数据出错',b.message);a.autoEnd=!1})}}},pushRowsReverse1:function(e){var f=Ext.Viewport.lookup('cefMsgMgr').getController(),d=[],g=e.length,b,a;for(var c=g-1;c>=0;c--){a=e.item(c);b={chatID:a.ChatID,msgID:a.MsgID,updateTime:a.CreateAt,SenderID:a.SenderID,senderName:a.SenderName,content:a.Content,msgType:a.MsgType,width:a.Width,height:a.Height,fileID:a.FileID,fileName:a.FileName,fileSize:a.FileSize,filePath:a.FilePath,linkObjType:a.LinkObjType,linkTitle:a.LinkTitle,linkType:a.LinkType,linkStgGuid:a.LinkStgGuid,linkKeyString:a.LinkKeyString,status:a.Status,BFileSize:a.BFileSize,BFileName:a.BFileName,BFilePath:a.BFilePath};b=f.getStoreHighlightObj(b);d.push(b)}return d},pushRowsOrdered1:function(e){var f=Ext.Viewport.lookup('cefMsgMgr').getController(),d=[],g=e.length,b,a;for(var c=0;c<g;c++){a=e.item(c);b={chatID:a.ChatID,msgID:a.MsgID,updateTime:a.CreateAt,SenderID:a.SenderID,senderName:a.SenderName,content:a.Content,msgType:a.MsgType,width:a.Width,height:a.Height,fileID:a.FileID,fileName:a.FileName,fileSize:a.FileSize,filePath:a.FilePath,linkObjType:a.LinkObjType,linkTitle:a.LinkTitle,linkType:a.LinkType,linkStgGuid:a.LinkStgGuid,linkKeyString:a.LinkKeyString,status:a.Status,BFileSize:a.BFileSize,BFileName:a.BFileName,BFilePath:a.BFilePath};b=f.getStoreHighlightObj(b);d.push(b)}return d},pushRowsReverse:function(d){var c=[];var e=Ext.Viewport.lookup('cefMsgMgr').getController().highlightWord;for(var b=d.length-1;b>=0;b--){var a=d.item(b);c.push({chatID:a.ChatID,msgID:a.MsgID,updateTime:a.CreateAt,senderName:a.SenderName,SenderID:a.SenderID,content:a.Content,msgType:a.MsgType,width:a.Width,height:a.Height,fileName:a.FileName,fileSize:a.FileSize,filePath:a.FilePath,highlightWord:e,linkObjType:a.LinkObjType,linkTitle:a.LinkTitle,linkType:a.LinkType,linkStgGuid:a.LinkStgGuid,linkKeyString:a.LinkKeyString,status:a.Status})}return c},pushRowsOrdered:function(d){var c=[];var e=Ext.Viewport.lookup('cefMsgMgr').getController().highlightWord;for(var b=0;b<d.length;b++){var a=d.item(b);c.push({chatID:a.ChatID,msgID:a.MsgID,updateTime:a.CreateAt,SenderID:a.SenderID,senderName:a.SenderName,content:a.Content,msgType:a.MsgType,width:a.Width,height:a.Height,fileName:a.FileName,fileSize:a.FileSize,filePath:a.FilePath,highlightWord:e,linkObjType:a.LinkObjType,linkTitle:a.LinkTitle,linkType:a.LinkType,linkStgGuid:a.LinkStgGuid,linkKeyString:a.LinkKeyString,status:a.Status})}return c}});Ext.define('IMCef.view.msgMgr.tabPanel.MgrPicList',{extend:'Ext.List',xtype:'mgr_picList',cls:'mgr_picList',store:{fields:['content','fileID','msgID','updateTime','width','height','filePath']},itemTpl:['<tpl for="content">','<div class="mgr_pic_frame" {[MsgHelper.getImgDomAttr(values.filePath,values.updateTime,values.fileName)]}>','<div class="mgr_pic_block">','<img class="mgr_pic_loaded" src="{[MsgHelper.getLoadedPicSrc(values.filePath, values.updateTime)]}" fileName="{fileName}" create_at="{updateTime}" fileID="{fileID}">','</div>','<div style="text-align: center;">{[Utils.date2Str(values.updateTime)]}</div>','</div>','</tpl>'].join(''),initialize:function(){var a=this;a.callParent(arguments);a.on({childtap:'onTapChild',scope:a});a.getScrollable().on({scroll:'onScrolList',scope:a});a.element.on({delegate:'.mgr_pic_frame',contextmenu:'onContextmenu',scope:a})},onContextmenu:function(b){var c=b.currentTarget;if(!c){return}var a=Ext.fly(c).query('img')[0];if(!a){return}var e=this;var d=Ext.create('IMCommon.view.menu.ImgContextmenu',{createAt:a.getAttribute('create_at'),value:a.src,path:a.src,fileName:a.getAttribute('fileName'),openMore:!0,img:a,selectPlace:e,clsSelector:'img.mgr_pic_loaded'});ParseUtil.menuShowAtVisible(d,b.getPoint());b.preventDefault()},onTapChild:function(b,d){var e=d.event;var a=Ext.fly(e.target);var c='div.mgr_pic_block';if(a.is(c)){b.showPicForm(a.query('img')[0])}else {if(a.is('img')){b.showPicForm(a.dom)}}},showPicForm:function(d){var e=this;var c=e.innerElement.dom.querySelectorAll('img'),a=[],b=-1;c.forEach(function(c,e){a.push({url:c.src,original:c.getAttribute('fileID'),name:c.getAttribute('fileName'),createAt:c.getAttribute('create_at')});if(d===c){b=e}});if(window.cefMsgMgr){a=JSON.stringify(a);cefMsgMgr.viewImages(a,b)}},onScrolList:function(a,n,o,l,m){var c=a.getScrollElement().dom,i=c.scrollHeight,j=c.scrollTop,h=c.offsetHeight;if(i<=j+h){if(!a.autoEnd){var k=this;var f=k.getStore(),b=f.last();if(!b){return}var d=b.get('chatID'),e=b.get('content');var g=e[e.length-1].updateTime;if(!g){return}a.autoEnd=!0;MsgSearch.searchPicFromTime(d,g,function(g,e){var b=e.rows;if(b.length<=0){a[d].autoEndA=!0;a.autoEnd=!1;return}var c=MsgHelper.pushPicRows(b,d);f.add(c);a.autoEnd=!1},function(b){console.error('向下滚动时，查询数据出错',b.message);a.autoEnd=!1})}}}});Ext.define('IMCef.view.msgMgr.tabPanel.MgrFileList',{extend:'Ext.List',xtype:'mgr_fileList',cls:'mgr_fileList',store:{fields:['updateTime','senderName','fileName','fileSize','filePath']},itemTpl:['<div class="mgr_fileList_fileIcon {[ParseUtil.getFileIcon(values.fileName)]}"></div>','<div class="mgr_fileName">{[ParseUtil.parseName(values.fileName)]}</div>','<div class="mgr_file_font">{[Utils.date2Str(values.updateTime)]}</div>','<div class="mgr_file_font">{senderName}</div>','<div class="mgr_file_font">{fileSize:fileSize}</div>'].join(''),initialize:function(){var a=this;a.callParent(arguments);a.element.on({delegate:'.x-listitem',contextmenu:'onFileContextmenu',scope:a});a.getScrollable().on({scroll:'onScrolList',scope:a})},onFileContextmenu:function(c){var d=c.currentTarget;if(!d){return}var i=this;var f=i.getStore();var e=d.getAttribute('data-recordindex');var b=f.getAt(e);if(!b){return}var a=b.get('filePath');var h=/file:[\/]+/g;if(!h.test(a)){a=ConfigMgr.getDefaultDir()+a}var g=Ext.create('IMCommon.view.menu.FileContextmenu',{value:a,path:a,fileName:b.get('fileName')});ParseUtil.menuShowAtVisible(g,c.getPoint());c.preventDefault()},onScrolList:function(a){var c=a.getScrollElement().dom,h=c.scrollHeight,i=c.scrollTop,g=c.offsetHeight;if(h<=i+g){if(!a.autoEnd){a.autoEnd=!0;var j=this;var e=j.getStore(),b=e.last();if(!b){return}var d=b.get('chatID'),f=b.get('updateTime');if(!f){return}MsgSearch.searchFileFromTime(d,f,function(g,f){var b=f.rows;if(b.length<=0){a[d].autoEndA=!0;a.autoEnd=!1;return}var c=MsgHelper.pushFileRows(b,d);e.add(c);a.autoEnd=!1},function(b){console.error('向下滚动时，查询数据出错',b.message);a.autoEnd=!1})}}}});Ext.define('IMCef.msgMgr.widget.AdvSPController',{extend:'Ext.app.ViewController',alias:'controller.advspcontroller',init:function(){var a=this;var b=a.getView().down('#asp_pt');var c=a.getView().down('#asp_time');c.setValue('all');var d=new Ext.util.KeyMap({target:b.element,binding:[{key:13,handler:function(){a.doEnterKey()},scope:a},{key:38,handler:function(c,b){a.doUpKey();b.preventDefault()},scope:a},{key:40,handler:function(c,b){a.doDownKey();b.preventDefault()},scope:a}]})},doEnterKey:function(){var a=this;var b=a.beforeDoKey();if(!b){return}a.doPField(b)},doUpKey:function(){var b=this;var a=b.beforeDoKey();if(!a){return}if(a.prev()){a.removeCls('searchP_active');a.prev().addCls('searchP_active')}},doDownKey:function(){var b=this;var a=b.beforeDoKey();if(!a){return}if(a.next()){a.removeCls('searchP_active');a.next().addCls('searchP_active')}},beforeDoKey:function(){var a=this.getView().searchPanel;if(!a){return}if(a.getHidden()){return}var b=a.el.query('.searchP_active')[0];if(!b){return}var c=Ext.fly(b);return c},onChgParticipant:function(b,a,e){if(!User.partiSet){var c=this;User.partiCondition=a;var d=window.setTimeout(function(){if(User.partiCondition==a){c.doSearchPar(b,a)}window.clearTimeout(d)},300)}},doSearchPar:function(c,a){var b=this;if(a&&a!='undefined'){MsgSearch.doSearchUser(a,function(j,i){var g=i.rows;if(g.length>0){var h,e=[];for(var d=0;d<g.length;d++){h=g.item(d);e.push({user_id:h.UserID,user_name:h.UserName,defCls:d==0?'searchP_active':''})}var f=b.getPPanel(e);f.showBy(c.element,'tl-bl?')}else {var f=b.getPPanel(e);f.hide()}})}else {var d=b.getPPanel();d.hide()}},getPPanel:function(b){var c=this;var a=c.getView();if(!a.searchPanel){a.searchPanel=Ext.create('IMCommon.view.panel.hidePanel',{floated:!0,scrollable:'y',focusable:!0,bodyPadding:10,width:193,maxHeight:200,tpl:['<div class="searchP">','<tpl for=".">','<div class="search_p_nor search_participate {defCls}" search_value="{user_id}">{user_name}</div>','</tpl>','</div>'].join(''),data:b});a.searchPanel.element.on({tap:'onTapP',scope:c})}a.searchPanel.setData(b);return a.searchPanel},onTapP:function(c){var b=this;var a=Ext.fly(c.target);if(a.hasCls('search_participate')){b.doPField(a)}},doPField:function(c){var b=this;var d=c.getHtml();var a=b.getView().down('#asp_pt');User.partiSet=!0;a.setValue(d);a.uid=c.getAttribute('search_value');User.partiSet=!1;b.getView().searchPanel.hide()},onOk:function(){var g=this;var b=g.getView();var k=b.down('#asp_pt');var i=b.down('#asp_gn');var j=b.down('#asp_mr');var h=b.down('#asp_time');var f=k.getValue(),d=i.getValue(),e=j.getValue(),c=h.getValue();var a=[];if(f){a.push({type:SearchType.SendName,val:f})}if(d){a.push({type:SearchType.GroupName,val:d})}if(e){a.push({type:SearchType.MsgRecord,val:e})}if(c&&c!='all'){a.push({type:SearchType.Time,val:c})}g.fireEvent('doAdvSearch',a)},onCancle:function(){this.getView().hide()},onShowMe:function(){this.fireEvent('doShowAdvP')}});Ext.define('IMCef.view.msgMgr.widget.AdvSearchPanel',{extend:'Ext.form.Panel',xtype:'AdvSPanel',controller:'advspcontroller',requires:['IMCef.msgMgr.widget.AdvSPController'],uses:['IMCommon.view.panel.hidePanel'],scrollable:'y',bodyPadding:10,buttonAlign:'right',defaults:{labelWidth:65},userCls:'adv-search',listeners:{show:'onShowMe'},items:[{xtype:'textfield',itemId:'asp_pt',label:'发送人',listeners:{}},{xtype:'textfield',itemId:'asp_gn',label:'会话'},{xtype:'textfield',itemId:'asp_mr',label:'聊天记录'},{xtype:'selectfield',itemId:'asp_time',label:'时间',clearable:!1,editable:!1,options:[{text:'不限',value:'all'},{text:'最近一个月',value:'oneMonth'},{text:'最近三个月',value:'threeMonth'},{text:'最近一年',value:'oneYear'}]}],buttons:[{text:'搜索',userCls:'btnEnter',height:25,width:65,handler:'onOk'},{text:'关闭',userCls:'btnCancel',height:25,width:65,handler:'onCancle'}],destory:function(){var a=this;Ext.destroy(a.searchPanel);a.callParent(arguments)}});Ext.define('IMCef.view.msgMgr.CefMsgMgr',{extend:'Ext.Container',xtype:'cefMsgMgr',controller:'cefMsgManager',requires:['IMCef.view.msgMgr.CefMsgMgrController','IMCef.view.msgMgr.widget.MsgSearchField','IMCef.view.msgMgr.tabPanel.MgrMsgList','IMCef.view.msgMgr.tabPanel.MgrPicList','IMCef.view.msgMgr.tabPanel.MgrFileList','IMCommon.utils.ParseUtil','IMCef.view.msgMgr.widget.AdvSearchPanel','IMCommon.view.search.SearchField','IMCommon.view.list.imitateListPaging'],layout:{type:'vbox'},cls:'msgMgr',items:[{userCls:'title',layout:'hbox',height:42,xtype:'container',items:[{xtype:'displayfield',value:'消息管理器',cls:'titleDrag'},{xtype:'component',flex:1,cls:'titleDrag'},{xtype:'button',ui:'cefOut',iconCls:'im-common-minimize',handler:'min'},{xtype:'button',ui:'cefOut',iconCls:'im-common-maximize',itemId:'cefMax',handler:'max'},{xtype:'button',ui:'cefCloseOut',iconCls:'im-common-close',handler:'close'}]},{flex:1,layout:'hbox',items:[{layout:'vbox',width:280,userCls:'left_msgMgr',reference:'cefmsgmgr_rct',items:[{xtype:'richSearchfield',reference:'msgmgr_rich_searchfield',ui:'big',placeholder:'搜索',height:35,style:'margin-top: 10px;\n                        margin-left: 10px;\n                        margin-right: 10px;',triggers:{add:{cls:'',handler:'onShowMore'}},defaultSearchType:'mr',searchView:{width:260,store:{data:[{type:'sn'},{type:'gn'},{type:'mr'}]}}},{xtype:'msgSearchTF',hidden:!0,itemId:'msgSearchTxt'},{xtype:'AdvSPanel',itemId:'msgMgr_advP',hidden:!0},{hidden:!0,xtype:'list',userSelectable:!1,scrollToTopOnRefresh:!1,userCls:'search_msgList',itemId:'msgRecentChat',flex:1,store:{fields:['chatID','chat_create_at','members','status','chatType','chatName','avaHash',{name:'showMsg',type:'bool',defaultValue:!1},'msgCount','content']},emptyText:'未查询到相关结果',itemTpl:['<tpl if="showMsg">','<div class="wrapSearch">','<div class="wrsCName">','{[MsgHelper.getAvaHtml(values)]}',"<div class=\"arrow {[values.arrowUp ? '':'down']}\"></div>",'<div class="wrsMCount">{msgCount}</div>','{chatName}','</div>','<tpl if="values.showContent">','<div class="wrsMsg_content" style="display:{[values.arrowUp ? \'inline-block\':\'none\']}">','<tpl for="content">','<div class="wrsMsg" msg_id="{msgID}" msg_seq="{msgSeq}" create_at="{createAt}">','<div style="overflow:hidden;word-wrap:break-word;white-space:nowrap;text-overflow:ellipsis;">{msg}</div>','</div>','</tpl>','</div>','<div style="display:{[values.arrowUp ? \'block\':\'none\']}" class="{[values.showMore?"wrsMsg_loadmore":"wrsMsg_hasnomore"]}">{[values.showMore?"加载更多":"已无更多"]}</div>','</tpl>','</div>','<tpl else>','<div class="chatName">','{[MsgHelper.getAvaHtml(values)]}','{chatName}','</div>','</tpl>'].join(''),listeners:{childsingletap:'msgOnChildTap',childdoubletap:'onDblTapList'}}]},{xtype:'tabpanel',flex:1,defaults:{tab:{iconAlign:'top'}},tabBar:{padding:0,layout:{pack:'left'}},listeners:{activeItemchange:'onTabChanges'},items:[{title:'消息',xtype:'mgr_msgList',reference:'mgrMsgList'},{title:'图片',xtype:'mgr_picList',reference:'mgrPicList'},{title:'文件',xtype:'mgr_fileList',reference:'mgrFileList'}]}]}]});Ext.define('IMCef.msgMgr.MsgHelper',{alternateClassName:'MsgHelper',singleton:!0,getAvaHtml:function(a){var c=a.chatType;var b='';if(c==ChatType.Direct){var d=ParseUtil.getUserIDByDitChat(a.members);b=AvatarMgr.getUserAvaHtml(d,'',!0)}else {if(c=='C'){b=AvatarMgr.getCrowdAvaHtml(a.chatID,a.chat_create_at,'',!0)}else {b=AvatarMgr.getChatAvaHtml(a.chatID,a.chat_create_at,'',!0)}}return '<div style="float:left;">'+b+'</div>'},parseLoadedPic:function(f,g,e,b,d,c){var a=this.getImgUrlByTN(e,b);a=ParseUtil.getLocalFileURL(a);return ['<div class="mgr_msgList_img">','<img class="mgr_msgList_viewPic" src="'+a+'" fileName="'+c+'" create_at="'+b+'" fileID="'+d+'">','</div>'].join('')},getImgUrlByTN:function(b,c){var e=Utils.regex.url;if(e.test(b)){return b}var a=FileUtil.getFileName(b);var d=FileUtil.getExtension(a);if(!d){a=a+'.png'}var g=ParseUtil.getTimeYMStr(c);var f=ConfigMgr.getDefaultDir()+'images/'+g+a;return f},parseLoadedFile:function(a,b,g,f){var c=ParseUtil.getFileIcon(a),e=this.bytesToSize(b);var d=ParseUtil.doHighLight(a,f);return ['<div class="mgr_msgList_file">','<div class="mgr_msgList_fileIcon '+c+'"></div>','<div class="mgr_msgList_fileName">'+d+'</div>','<div class="mgr_msgList_fileSize">'+e+'</div>','</div>'].join('')},parseLoadedFile1:function(a,b){var c=ParseUtil.getFileIcon(a),d=this.bytesToSize(b),a=ParseUtil.parseName(a);return ['<div class="mgr_msgList_file">','<div class="mgr_msgList_fileIcon '+c+'"></div>','<div class="mgr_msgList_fileName">'+a+'</div>','<div class="mgr_msgList_fileSize">'+d+'</div>','</div>'].join('')},parseLoadedBFile:function(a,b,g,f){var c=ParseUtil.getFileIcon(a),e=this.bytesToSize(b);var d=ParseUtil.doHighLight(a,f);return ['<div class="mgr_msgList_file" style="position:relative">','<div class="mgr_msgList_fileIcon '+c+'"></div>','<div class="mgr_msgList_fileName">'+d+'</div>','<div class="mgr_msgList_fileSize">'+e+'</div>','<div class="bigfile-special"></div>','</div>'].join('')},parseLoadedBFile1:function(a,b){var c=ParseUtil.getFileIcon(a),d=this.bytesToSize(b);return ['<div class="mgr_msgList_file" style="position:relative">','<div class="mgr_msgList_fileIcon '+c+'"></div>','<div class="mgr_msgList_fileName">'+a+'</div>','<div class="mgr_msgList_fileSize">'+d+'</div>','<div class="bigfile-special"></div>','</div>'].join('')},bytesToSize:function(a){if(a===0){return '0 B'}if(a<=1024){return '1 KB'}var e=1024,d=['B','KB','MB','GB','TB','PB','EB','ZB','YB'],c=Math.floor(Math.log(a)/Math.log(e));var b=a/Math.pow(e,c);if(b>=999){return b.toPrecision(4)+' '+d[c]}return b.toPrecision(3)+' '+d[c]},getMI:function(a){var b=FileUtil.getExtension(a),c=FileUtil.getMIMEIcon(b);return c},getLoadedPicSrc:function(c,b){var a=this.getImgUrlByTN(c,b);a=ParseUtil.getLocalFileURL(a);return a},hlSenderName:function(a,b){if(a&&a!='undefined'){if(b&&b!='undefined'){var c=a.split(b);return c.join('<span style="background:#c3dbf3;">'+b+'</span>')}}return a},getHighlightWord:function(){return Ext.Viewport.lookup('cefMsgMgr').getController().highlightWord},parseERPLink:function(a){return '<div class="linkMsg">\n            <div class="linkIcon" letter="'+a.linkType+'"></div>\n            <div class="linkName">'+a.linkTitle+'</div>\n        </div>'},pushInfoToDom:function(a){var d=a.msgType;var c='type="'+d+'" ',b='';switch(d){case MsgType.TextMsg:break;case MsgType.ImgMsg:b=this.getImgUrlByTN(a.filePath,a.updateTime);c+='origin_path="'+b+'" fileName="'+a.fileName+'" create_at="'+a.updateTime+'"';break;case MsgType.FileMsg:b=ParseUtil.getAbsolutePath(a.filePath);c+='origin_path="'+b+'" fileName="'+a.fileName+'"';break;case MsgType.LinkErp:c+='linkObjType="'+a.linkObjType+'" linkStgGuid="'+a.linkStgGuid+'" linkKeyString="'+a.linkKeyString+'" linkType="'+a.linkType+'"';break;case MsgType.BigFileMsg:b=ParseUtil.getAbsolutePath(a.BFilePath);c+='origin_path="'+b+'" fileName="'+a.BFileName+'"';break;default:break;}return c},getImgDomAttr:function(c,a,b){var d=this.getImgUrlByTN(c,a);return 'origin_path="'+d+'" fileName="'+b+'" create_at="'+a+'"'},pushPicRows:function(d,e){var c={chatID:e,content:[]};for(var b=0;b<d.length;b++){var a=d.item(b);c.content.push({fileID:a.FileID,baseID:a.BaseID,updateTime:a.CreateAt,width:a.Width,height:a.Height,filePath:a.FilePath,fileName:a.FileName})}return c},pushFileRows:function(d,e){var c=[];for(var b=0;b<d.length;b++){var a=d.item(b);c.push({chatID:e,baseID:a.BaseID,fileID:a.FileID,updateTime:a.CreateAt,SenderID:a.SenderID,senderName:a.SenderName,fileName:a.FileName,fileSize:a.FileSize,filePath:a.FilePath})}return c},parseMyName:function(b,a){if(b==User.ownerID){return '你'}return a}});Ext.define('IMCommon.local.MsgSearch',{alternateClassName:'MsgSearch',singleton:!0,requires:['IMCommon.local.LocalDataMgr'],getChat:function(a){var b='Select T1.* \n        From (Select Distinct ChatID From IMMsg Order By CreateAt Desc limit 0, 50) T \n        Left Join IMChat T1 On T.ChatID = T1.ChatID WHERE T1.Status<>?';LocalDataMgr.cExecSqlWithP(b,['1'],function(c,b){if(a){a(c,b)}})},searchPtcp:function(b,a){var c='SELECT distinct C.* FROM IMChat C JOIN IMMsg M ON C.ChatID=M.ChatID'+' WHERE M.SenderID LIKE ? OR M.SenderName LIKE ? ORDER BY C.UpdateAt DESC LIMIT 50;';LocalDataMgr.cExecSqlWithP(c,['%'+b+'%','%'+b+'%'],function(d,c){if(a){a(d,c)}})},searchGN:function(b,a){LocalDataMgr.getDB().transaction(function(c){var d='select * from IMChat where DisplayName like ? AND Status<>? ORDER BY UpdateAt DESC';c.executeSql(d,['%'+b+'%','1'],function(e,d){if(a){a(e,d)}})})},searchCR:function(c,a){var b='SELECT C.DisplayName,C.CreateAt ChatCreateAt,C.UserIDs,C.ChatType,M.* FROM IMMsg M JOIN IMChat C ON M.ChatID=C.ChatID '+'WHERE C.Status<>? AND M.Status!=? AND M.MsgType=? AND M.Content LIKE ? ORDER BY M.CreateAt DESC;';LocalDataMgr.cExecSqlWithP(b,['1','1','T','%'+c+'%'],a)},searchFile:function(b,a){LocalDataMgr.getDB().transaction(function(c){var d='select F.FileName,M.MsgID,M.MsgSeq,M.CreateAt,M.SenderName,R.DisplayName,R.ChatID,R.ChatType,R.UserIDs,R.CreateAt ChatCreateAt from IMFile F join IMMsg M on F.BaseID=M.ID join IMChat R ON R.ChatID=M.ChatID where M.MsgType=? AND M.Status!=? AND F.FileName like ? ORDER BY M.CreateAt DESC limit 0,20';c.executeSql(d,['F','1','%'+b+'%'],function(e,d){if(a){a(e,d)}})})},searchMsgContext:function(c,a,f,e,b){var d=this;LocalDataMgr.getDB().transaction(function(g){var h='SELECT M.*,F.*,L.*,B.* FROM IMMsg M '+'LEFT JOIN IMFile F ON M.ID=F.BaseID '+'LEFT JOIN IMLink L ON M.ID=L.BaseID '+'LEFT JOIN IMBFile B ON M.ID=B.BaseID '+'WHERE M.ChatID=? AND M.CreateAt<=? AND M.Status!=? ORDER BY M.CreateAt DESC limit 0,10;';g.executeSql(h,[c,parseInt(a,10),'1'],function(n,k){var i=k.rows,h=[];var l=i.item(0);for(var j=i.length-1;j>=0;j--){var o=i.item(j);h.push(d.getStoreMsgData(o,e))}var m='SELECT M.ChatID,M.MsgID,M.MsgSeq,M.CreateAt,M.Content,M.SenderName,M.MsgType,F.Width,F.Height,F.FileName,F.FileSize,F.FilePath,L.*,B.* FROM IMMsg M '+'LEFT JOIN IMFile F ON M.ID=F.BaseID '+'LEFT JOIN IMLink L ON M.ID=L.BaseID '+'LEFT JOIN IMBFile B ON M.ID=B.BaseID '+'WHERE M.ChatID=? AND M.CreateAt>? AND M.Status!=? ORDER BY M.CreateAt limit 0,10;';n.executeSql(m,[c,parseInt(a,10),'1'],function(p,o){var j=o.rows;for(var i=0;i<j.length;i++){var m=j.item(i);h.push(d.getStoreMsgData(m,e))}if(b){b(h,l)}})})})},getStoreMsgData:function(a,b){return {chatID:a.ChatID,msgID:a.MsgID,updateTime:a.CreateAt,senderName:a.SenderName,content:a.Content,msgType:a.MsgType,width:a.Width,height:a.Height,fileName:a.FileName,fileSize:a.FileSize,filePath:a.FilePath,highlightWord:b,linkObjType:a.LinkObjType,linkTitle:a.LinkTitle,linkType:a.LinkType,linkStgGuid:a.LinkStgGuid,linkKeyString:a.LinkKeyString,status:a.Status}},searchLastMsg:function(b,a){LocalDataMgr.getDB().transaction(function(c){var d='SELECT M.*,F.FilePath,F.Width,F.Height,F.FileSize,F.FileName,F.FileType,F.Extension,L.*,B.* FROM IMMsg M \n            LEFT JOIN IMFile F ON M.ID=F.BaseID \n            LEFT JOIN IMLink L ON M.ID=L.BaseID \n            LEFT JOIN IMBFile B ON M.ID=B.BaseID \n            WHERE M.ChatID=? \n            ORDER BY M.CreateAt DESC limit 0,20;';c.executeSql(d,[b],function(e,d){if(a){a(e,d)}})})},searchLastPic:function(b,a){var c='SELECT * FROM IMFile WHERE FileType=? AND ChatID=? AND FileStatus<>? ORDER BY CreateAt DESC limit 48;';LocalDataMgr.cExecSqlWithP(c,['I',b,'1'],function(d,c){if(a){a(d,c)}})},searchLastFile:function(b,a){var c='SELECT * FROM IMFile WHERE FileType=? AND ChatID=? AND FileStatus<>? ORDER BY CreateAt DESC limit 50;';LocalDataMgr.cExecSqlWithP(c,['F',b,'1'],function(d,c){if(a){a(d,c)}})},searchMsgAgo:function(c,b,a){var d='SELECT M.*,F.FileID,F.FilePath,F.Width,F.Height,F.FileSize,F.FileName,F.FileType,F.Extension,\n        L.*,\n        B.* \n        FROM IMMsg M \n        LEFT JOIN IMFile F ON M.ID=F.BaseID \n        LEFT JOIN IMLink L ON M.ID=L.BaseID \n        LEFT JOIN IMBFile B ON M.ID=B.BaseID \n        WHERE M.CreateAt<? AND M.ChatID=? AND M.Status!=?\n        ORDER BY M.CreateAt DESC limit 0,20;';LocalDataMgr.cExecSqlWithP(d,[b,c,'1'],function(e,d){if(a){a(e,d)}})},searchMsgEnd:function(c,b,a){var d='SELECT M.ChatID,M.MsgID,M.CreateAt,M.Content,M.SenderName,M.MsgType,F.FileID,F.Width,F.Height,F.FileName,F.FileSize,F.FilePath,L.*,B.* '+'FROM IMMsg M LEFT JOIN IMFile F ON M.ID=F.BaseID '+'LEFT JOIN IMLink L ON M.ID=L.BaseID '+'LEFT JOIN IMBFile B ON M.ID=B.BaseID '+'WHERE M.CreateAt>? AND M.ChatID=? AND M.Status!=? ORDER BY M.CreateAt ASC limit 0,20;';LocalDataMgr.cExecSqlWithP(d,[b,c,'1'],function(e,d){if(a){a(e,d)}})},searchPicFromTime:function(c,b,a){var d='SELECT * FROM IMFile WHERE CreateAt<? AND FileType=? AND ChatID=? ORDER BY CreateAt DESC limit 48;';LocalDataMgr.cExecSqlWithP(d,[b,MsgType.ImgMsg,c],function(e,d){if(a){a(e,d)}})},searchFileFromTime:function(c,b,a){var d='SELECT * FROM IMFile WHERE CreateAt<? AND FileType=? AND ChatID=? ORDER BY CreateAt DESC limit 50;';LocalDataMgr.cExecSqlWithP(d,[b,MsgType.FileMsg,c],function(e,d){if(a){a(e,d)}})},doSearchUser:function(b,a){var c='SELECT * FROM IMUsr WHERE UserID LIKE ? OR UserName LIKE ?;';LocalDataMgr.cExecSqlWithP(c,['%'+b+'%','%'+b+'%'],function(d,c){if(a){a(d,c)}})},doAdvSearch:function(c,h,g){if(c.sql){var l='SELECT M.*,C.*,C.CreateAt ChatCreateAt,C.Status ChatStatus FROM IMMsg M JOIN IMChat C \n                ON M.ChatID=C.ChatID ';var j=' ORDER BY M.CreateAt DESC';var i=c.sql,b=c.val;var k='WHERE '+i.join(' AND ');var m=l+k+j;var d=[];for(var a=0;a<b.length;a++){if(Ext.isNumber(b[a])){d.push(b[a])}else {var f=b[a].split(',');for(var e=0;e<f.length;e++){d.push(f[e])}}}LocalDataMgr.cExecSqlWithP(m,d,h,g)}},searchChatByTime:function(c,b,a){var d='Select T1.* \n        From (Select Distinct ChatID From IMMsg WHERE CreateAt>? Order By CreateAt Desc limit 0, 50) T \n        Left Join IMChat T1 On T.ChatID = T1.ChatID';LocalDataMgr.cExecSqlWithP(d,[c],b,a)}});Ext.define('IMCef.userSel.Org',{extend:'Ext.data.TreeStore',alias:'store.Org',root:{name:'loading'},rootVisible:!1,fields:['user_id','user_name','avaHash',{name:'iconCls',defaultValue:'hide-icon'},{name:'isSel',type:'bool',defaultValue:!1}],sorters:[{property:'leaf',direction:'DESC'},{property:'user_id',direction:'ASC'}]});Ext.define('IMCef.userSel.UserSelController',{extend:'Ext.app.ViewController',alias:'controller.userselcontroller',init:function(){this.initConParam()},initConParam:function(){User.accountID=window.cefUserSelector.getAccountID();User.ownerID=window.cefUserSelector.getUserID();User.token=window.cefUserSelector.getToken();var a=this;window.onShowSelForm=function(e){if(!window.cefUserSelector){return}var b=e;User.addChatID=b.chatID;User.showHisMsgID='';User.defSelUsers=[];ConfigMgr.orgShowRoot=b.showOrgRoot?'Y':'N';User.lastCorpID=User.crtCorpID;User.crtCorpID=b.corpId;ConfigMgr.useAio8=b.useAio8;if(b.defSelUsers){User.defSelUsers=b.defSelUsers}User.fromAdd=b.fromAdd=='add';User.transmitMsgID=b.msgID;User.transFileSize=b.fileSize;User.transFilePath=b.filePath;var d=b.hideACheckbox;a.chgPageToOrigin();var c=a.getView().getViewModel();if(b.fromAdd=='add'){if(!window.cefUserSelector.getOrgData()){return}c.set({mainTitle:'添加多人会话成员',openType:'add',hideACheckbox:d});a.doUserTree(b)}else {if(b.fromAdd=='open'){if(!window.cefUserSelector.getOrgData()){return}c.set({mainTitle:'发起多人会话',openType:'open',hideACheckbox:!0});a.doUserTree(b)}else {if(b.fromAdd=='transmit'){c.set({mainTitle:'选择会话',openType:'transmit',hideACheckbox:!0});User.transmitRct=b.rctData;a.doRctTree(b)}}}};window.onbfileother=function(a){User.bfileinfm=a}},chgPageToOrigin:function(){Ext.getStore('userSel_list').removeAll();var c=Ext.getStore('userSel_rctTreeStore');if(c){Ext.destroy(c)}var a=this.getView().down('#showAllCheckbox');if(a){a.setChecked(!1)}User.showAllHis='N';this.getViewModel().set({showHistoryDesc:'仅显示加入会话后的消息'});var b=Ext.getStore('userSelDialog_list');if(b){b.removeAll()}var d=this.dialog;if(d){d.hide()}User.firstIn=!0},needReStore:function(){var a=!1;a=User.lastCorpID!==User.crtCorpID;return a},doUserTree:function(d){var c=this.getView().down('#grpSel-org'),b=Ext.getStore('userSel_treeStore');if(!b||this.needReStore()){b=this.getUserStore()}c.setStore(b);for(var a=0;a<b.getData().length;a++){var e=b.getAt(a);e.set('isSel',!1)}for(var a=0;a<d.defSelUsers.length;a++){c.doTreeSetSel(b,d.defSelUsers[a],!0)}c.expandAll();c.getScrollable().scrollTo(0,0)},getUserStore:function(){var e=JSON.parse(cefUserSelector.getOrgData());var d=this.getView().down('#grpSel-org');if(e){var k=e.orgs,j=e.users;var g=d.orgAddUsers(k,j,User.defSelUsers);var h=d.createRoot(g);var b=[];for(var f=0;f<h.length;f++){var a=d.addOrg(h[f],g);if(!User.crtCorpID||User.crtCorpID&&User.crtCorpID===a.corp_id){if(!User.crtCorpID){User.crtCorpID=a.corp_id}if(ConfigMgr.showOrgRoot()){b.push(a)}else {for(var c=0;c<a.children.length;c++){if(!a.children[c].leaf){b.push(a.children[c])}}}break}}var i=Ext.create('Ext.data.TreeStore',{storeId:'userSel_treeStore',root:{user_name:'loading',children:ConfigMgr.showOrgRoot()?b[0].children:b},rootVisible:!1,sorters:[{property:'leaf',direction:'DESC'},{property:'uid',direction:'ASC'},{property:'defRoleID',direction:'ASC'},{property:'user_id',direction:'ASC'}]});return i}},doRctTree:function(e){var b=this.getView().down('#grpSel-org'),a=Ext.getStore('userSel_rctTreeStore');if(!a){a=this.getRctStore(e)}b.setStore(a);for(var c=0;c<a.getData().length;c++){var d=a.getAt(c);d.set('isSel',!1)}b.expandAll();b.getScrollable().scrollTo(0,0)},getRctStore:function(c){var a=c.rctData;var b=Ext.create('Ext.data.TreeStore',{storeId:'userSel_rctTreeStore',rootVisible:!1,root:{user_name:'loading',children:a}});return b},onSearch:function(d,a,c){User.searchText=a;var b=this;var e=window.setTimeout(function(){if(User.searchText==a){var f=b.getView().getViewModel(),g=f.get('openType');if(g=='transmit'){b.doRctSearch(d,a,c)}else {b.doSearch(d,a,c)}}window.clearTimeout(e)},500)},doRctSearch:function(d,b,e){if(b&&b!='undefined'){var c=this;var a=c.SearchP;if(!a){var a=c.SearchP=Ext.create('IMCef.userSel.panel.UserSelSearchRct',{id:'editP_searchRct'})}c.doSearchRct(b,a,d)}},doSearchRct:function(d,b,e){var c=this;var a=[];LocalSearchMgr.localRctSearch(d,function(h,g){if(h.length>0){var i={hasUser:!0};if(h.length>ConfigMgr.recentSearchNum){i.hasMoreUser=!0}a.push(i);var l=[{hasBack:!0,hasUserBack:!0}];for(var f=0;f<h.length;f++){if(f<ConfigMgr.recentSearchNum){a.push(h[f])}l.push(h[f])}var o=c.getUserRctStore();o.add(l)}if(g.length>0){var i={hasChat:!0};if(g.length>ConfigMgr.recentSearchNum){i.hasMoreChat=!0}a.push(i);var k=[{hasBack:!0}];for(var f=0;f<g.length;f++){if(f<ConfigMgr.recentSearchNum){a.push(g[f])}k.push(g[f])}var n=c.getChatStore();n.add(k)}if(a.length==0){a.push({hasNoData:!0})}var m=b.down('#editP_fsp_list');m.setItemTpl(b.itemTpl1);var j=c.getMultiStore();m.setStore(j);j.removeAll();j.add(a);b.showBy(e,'t1-b1')})},getUserRctStore:function(){var a=Ext.getStore('editP_fsp_user');if(!a){a=Ext.create('Ext.data.Store',{id:'editP_fsp_user'})}a.removeAll();return a},getChatStore:function(){var a=Ext.getStore('editP_fsp_chat');if(!a){a=Ext.create('Ext.data.Store',{id:'editP_fsp_chat'})}a.removeAll();return a},getMultiStore:function(){var a=Ext.getStore('editP_fsp_multi');if(!a){a=Ext.create('Ext.data.Store',{id:'editP_fsp_multi'})}a.removeAll();return a},doSearch:function(d,b,e){if(b&&b!='undefined'){var c=this;var a=c.Search1P;if(!a){a=c.Search1P=Ext.create('IMCef.userSel.panel.UserSelSearchP',{id:'editP_search'})}c.doSearchUser(b,a,d)}else {if(this.Search1P&&!this.Search1P.getHidden()){this.Search1P.hide()}}},doSearchUser:function(c,f,g){var e=[];if(User.allUsers.length==0){User.allUsers=JSON.parse(window.cefUserSelector.getOrgData()).users||[]}var a=Ext.clone(User.allUsers);if(ConfigMgr.isAio8()){a=a.filter(function(a){return a.roles.map(function(b){return b.corp_id}).indexOf(User.crtCorpID)>-1})}for(var b=0;b<a.length;b++){if(a[b].user_id.toUpperCase().indexOf(c)>-1||a[b].user_id.toLowerCase().indexOf(c)>-1||a[b].user_name.indexOf(c)>-1||a[b].mobile.indexOf(c)>-1){e.push(a[b])}}var d=Ext.getStore('editP_search_s');d.removeAll();d.add(e);f.showBy(g,'t1-b1')},onOk:function(){var b=this.getView().getViewModel(),a=b.get('openType');if(a=='add'||a=='open'){this.doUserOrgOK()}else {if(a=='transmit'){this.doTransmitOK()}else {if(a=='transmitNew'){this.doTransmitNewOK()}}}},getListIDs:function(f){var e=Ext.getStore('userSel_list');var b=e.getData().items;var c=[];for(var a=0;a<b.length;a++){var d=b[a].get(f);if(d){c.push(d)}}return c},doUserOrgOK:function(){var c=this.getListIDs('user_id');if(c.length<=0){Utils.toastShort('至少选择一个人');return}if(User.fromAdd){this.doAddMemOK(c)}else {var a=User.defSelUsers;for(var b=0;b<a.length;b++){if(User.ownerID==a[b]){a.splice(b,1)}}var d=c.concat(a);cefUserSelector.exec('creategroup',JSON.stringify(d))}this.onCancel()},doAddMemOK:function(c){var a='N';var b=this.getView().down('#showAllCheckbox');if(b.getChecked()){a='Y'}cefUserSelector.exec('addgroupusers',JSON.stringify({userIDs:c,chatID:User.addChatID,showAll:a,showHisMsgID:User.showHisMsgID}))},doTransmitOK:function(){var a=this.getListIDs('chat_id');var b=this.getListIDs('chat_type');if(a.length<=0){Utils.toastShort('至少选中一个会话');return}if(User.bfileinfm.msg_type=='E'){cefUserSelector.exec('transbfile',JSON.stringify({msg_id:User.transmitMsgID,msg_type:'E',chat_ids:a,type:b}))}else {if(!User.transmitMsgID){cefUserSelector.exec('transmitforwork',JSON.stringify({file_size:User.transFileSize,file_path:User.transFilePath,msg_type:'W',chat_ids:a,type:b}))}else {cefUserSelector.exec('transmit',JSON.stringify({msg_id:User.transmitMsgID,msg_type:'M',chat_ids:a,type:b}))}}this.ontransCancel(User.transmitMsgID,a)},doTransmitNewOK:function(){var d=this.getListIDs('user_id');if(d.length<=0){Utils.toastShort('至少选择一个人');return}var a=User.defSelUsers;for(var b=0;b<a.length;b++){if(User.ownerID==a[b]){a.splice(b,1)}}var c=d.concat(a);if(User.bfileinfm.msg_type=='E'){cefUserSelector.exec('creategrouptrans',JSON.stringify({msg_id:User.transmitMsgID,msg_type:'E',user_ids:c}))}else {if(!User.transmitMsgID){cefUserSelector.exec('creategrouptrans',JSON.stringify({file_size:User.transFileSize,file_path:User.transFilePath,msg_type:'W',user_ids:c}))}else {cefUserSelector.exec('creategrouptrans',JSON.stringify({msg_id:User.transmitMsgID,msg_type:'M',user_ids:c}))}}this.onCancel()},onCancel:function(){var b=this,a=b.getView();a.down('#grpSTF').clearValue();window.cefUserSelector.close()},ontransCancel:function(c,d){var b=this,a=b.getView();a.down('#grpSTF').clearValue();window.cefUserSelector.close()},destory:function(){Ext.destory(this.SearchP);Ext.destory(this.dialog)},createToTransmit:function(){var c=this;var b=this.getViewModel();b.set({mainTitle:'创建新会话',openType:'transmitNew'});User.defSelUsers.push(User.ownerID);c.doCreateUserTree();var a=Ext.getStore('userSel_list');a.removeAll()},doCreateUserTree:function(){var c=this.getView().down('#grpSel-org'),b=Ext.getStore('userSel_treeStore');if(!b||this.needReStore()){b=this.getUserStore()}c.setStore(b);for(var a=0;a<b.getData().length;a++){var d=b.getAt(a);d.set('isSel',!1)}for(var a=0;a<User.defSelUsers.length;a++){c.doTreeSetSel(b,User.defSelUsers[a],!0)}c.expandAll();c.getScrollable().scrollTo(0,0)},showHistoryatDialog:function(){var e=this;var b=this.getView(),a=this.dialog;if(!a){a=Ext.apply({ownerCmp:b},b.dialog);this.dialog=a=Ext.create(a);a.down('#userSelDialog_list').getScrollable().on({scroll:'onChgScrol',scope:e})}a.show();var c=User.showAllHis;switch(c){case 'N':a.down('#userSelDialog_radio_now').setChecked(!0);break;case 'Y':a.down('#userSelDialog_radio_all').setChecked(!0);break;case 'O':a.down('#userSelDialog_radio_one').setChecked(!0);break;default:break;}if(User.firstIn){var d='SELECT M.*,F.FilePath,F.Width,F.Height,F.FileSize,F.FileName,F.FileType,F.Extension,F.BaseID FileBaseID,L.*,L.BaseID LinkBaseID FROM \n            (SELECT * FROM IMMsg WHERE ChatID=? AND MsgType<>? AND Status<>?\n                ORDER BY CreateAt DESC limit 0,20) M \n                    LEFT JOIN IMFile F ON M.ID=F.BaseID \n                    LEFT JOIN IMLink L ON M.ID=L.BaseID;';LocalDataMgr.cExecSqlWithP(d,[User.addChatID,MsgType.NotShow,'1'],function(f,e){User.firstIn=!1;var d=e.rows;var c=[];for(var b=0;b<d.length;b++){c.push(d.item(b))}var a=Ext.getStore('userSelDialog_list');if(a){a.removeAll();a.add(c)}})}},onChgScrol:function(h,j,k){var a=h.getScrollElement().dom,e=a.scrollHeight,g=a.scrollTop,c=a.offsetHeight;if(e<=Math.ceil(g+c)){var b=Ext.getStore('userSelDialog_list');if(!b){return}var f=b.last(),d=f.get('CreateAt');var i='SELECT M.*,F.FilePath,F.Width,F.Height,F.FileSize,F.FileName,F.FileType,F.Extension,F.BaseID FileBaseID,L.*,L.BaseID LinkBaseID FROM \n            (SELECT * FROM IMMsg WHERE ChatID=? AND MsgType<>? AND Status<>? AND CreateAt<?\n                ORDER BY CreateAt DESC limit 0,20) M \n                    LEFT JOIN IMFile F ON M.ID=F.BaseID \n                    LEFT JOIN IMLink L ON M.ID=L.BaseID;';LocalDataMgr.cExecSqlWithP(i,[User.addChatID,MsgType.NotShow,'1',d],function(f,e){var d=e.rows;var c=[];for(var a=0;a<d.length;a++){c.push(d.item(a))}b.add(c)})}},onDialogOK:function(){var e=this.getViewModel(),b=this.dialog;if(b.down('#userSelDialog_radio_now').getChecked()){User.showAllHis='N'}else {if(b.down('#userSelDialog_radio_all').getChecked()){User.showAllHis='Y'}else {if(b.down('#userSelDialog_radio_one').getChecked()){var d=b.down('#userSelDialog_list');var c=d.getSelection();if(c){User.showAllHis='O';User.showHisMsgID=c.get('MsgID')}else {Utils.toastShort('请选择消息');return}}}}var a='';if(User.showAllHis=='N'){a='仅显示加入会话后的信息'}else {if(User.showAllHis=='Y'){a='显示全部消息'}else {if(User.showAllHis=='O'){a='选择消息进行展示'}}}e.set({showHistoryDesc:a});this.onDialogCancel()},onDialogCancel:function(){this.dialog.hide()},checkHisByNow:function(){this.dialog.down('#userSelDialog_list').hide();this.dialog.down('#userSelDialog_search').hide()},checkHisByAll:function(){this.dialog.down('#userSelDialog_list').hide();this.dialog.down('#userSelDialog_search').hide()},checkHisByOne:function(){this.dialog.down('#userSelDialog_list').show()}});Ext.define('IMCef.userSel.organization.OrgTree',{extend:'Ext.grid.Tree',xtype:'orgTree',id:'userSel_tree',defaultListenerScope:!0,selectable:{mode:'single'},hideHeaders:!0,userCls:'userSel_tree',listeners:{childTap:'onTapTree'},columns:[{xtype:'treecolumn',renderer:function(c,a){if(a.data.leaf){var b='';if(a.data.transmit){if(a.data.chat_type==ChatType.Multi){b=AvatarMgr.parseChatAva(a.data.ava_id,a.data.create_at,!0)}else {if(a.data.chat_type==ChatType.Direct){b=AvatarMgr.parseUserAva(a.data.ava_id,!0)}else {if(a.data.chat_type=='C'){b=AvatarMgr.parseCrowdAva(a.data.ava_id,a.data.create_at,!0)}}}}else {b=AvatarMgr.parseUserAva(a.data.user_id,!0)}return ['<div class="leaf_box">','<div class="leaf_ava">',b,'</div>',c,'</div>'].join('')}return '<div style="cursor: default;">'+c+'</div>'},dataIndex:'user_name',flex:1},{xtype:'checkcolumn',headerCheckbox:!0,dataIndex:'isSel',width:15,listeners:{checkchange:'onCheckchange',beforecheckchange:'onBeforecheckchange'}}],initConParam:function(){User.accountID=cefUserSelector.getAccountID();User.ownerID=cefUserSelector.getUserID();User.token=cefUserSelector.getToken()},orgAddUsers:function(b,a,c){if(ConfigMgr.isAio8()){return this.orgAddUsersForAio8(b,a)}return this.orgAddUsersForAio75(b,a)},orgAddUsersForAio8:function(c,b){var i=this;for(var d=0;d<c.length;d++){c[d].children=[];for(var a=0;a<b.length;a++){var g=b[a].roles;for(var e=0;e<g.length;e++){var h=g[e];if(h.org_id==c[d].org_id&&h.corp_id==c[d].corp_id){var f={user_id:b[a].user_id,user_name:b[a].user_name,defRoleName:b[a].def_role_name,leaf:!0,defRoleID:b[a].def_role_id,sex:b[a].sex,email:b[a].email,mobile:b[a].mobile,notes:b[a].notes,avaHash:b[a].avatar_hash,age:b[a].age,iconCls:'hide-icon',user_posts:b[a].user_posts};f=i.doDefSel(f,b[a].user_id);c[d].children.push(f);break}}}}return c},orgAddUsersForAio75:function(c,b){var i=this;for(var d=0;d<c.length;d++){c[d].children=[];for(var a=0;a<b.length;a++){var g=b[a].org_ids.split(',');for(var e=0;e<g.length;e++){var h=g[e];if(h==c[d].org_id){var f={user_id:b[a].user_id,user_name:b[a].user_name,defRoleName:b[a].def_role_name,leaf:!0,defRoleID:b[a].def_role_id,sex:b[a].sex,email:b[a].email,mobile:b[a].mobile,notes:b[a].notes,avaHash:b[a].avatar_hash,age:b[a].age,iconCls:'hide-icon',user_posts:b[a].user_posts};f=i.doDefSel(f,b[a].user_id);c[d].children.push(f);break}}}}return c},doDefSel:function(b,c){for(var a=0;a<User.defSelUsers.length;a++){if(User.defSelUsers[a]==c){b.isSel=!0;break}}return b},createRoot:function(b){var c=[];for(var a=0;a<b.length;a++){if(b[a].parent_id.toLowerCase()==='root'||b[a].parent_id===''){var d={uid:b[a].org_id,user_name:b[a].org_name,leaf:!1,iconCls:'x-fa fa-folder',parent_id:b[a].parent_id,org_id:b[a].org_id,corp_id:b[a].corp_id,children:b[a].children};c.push(d)}}return c},addOrg:function(c,a){for(var b=0;b<a.length;b++){if(a[b].parent_id==c.org_id&&a[b].corp_id==c.corp_id){c.children.push({uid:a[b].org_id,user_name:a[b].org_name,leaf:!1,iconCls:'x-fa fa-folder',parent_id:a[b].parent_id,org_id:a[b].org_id,corp_id:a[b].corp_id,children:a[b].children});this.addOrg(a[b],a)}}return c},isDefaultSel:function(b){for(var a=0;a<User.defSelUsers.length;a++){if(b==User.defSelUsers[a]){return !0}}return !1},onBeforecheckchange:function(d,b,c,a){if(a.data.leaf){if(this.isDefaultSel(a.data.user_id)){return !1}}},onCheckchange:function(f,e,b,c){var d=this,a=Ext.getStore('userSel_list');d.fireMemToList(a,b,c);return !1},fireMemToList:function(b,h,c){var a=this,g=a.getStore(),e=c.data;if(e.leaf){var d=e.user_id;if(!a.isDefaultSel(d)){if(h){a.doTreeSetSel(g,d,!0);b.add(e)}else {a.doTreeSetSel(g,d,!1);var i=b.getById(d);if(i){b.remove(i)}}}}else {if(c.childNodes.length>0){for(var f=0;f<c.childNodes.length;f++){a.fireMemToList(b,h,c.childNodes[f])}}}},doTreeSetSel:function(c,e,d){var b=c.query('user_id',e,!1,!1,!0);for(var a=0;a<b.items.length;a++){b.items[a].set('isSel',d)}},onTapTree:function(c,b){var a=b.record;if(!a){return}var d=Ext.fly(b.sourceElement);if(d.hasCls('x-checkbox-el')){return}if(!a.isLeaf()){if(a.isExpanded()){c.collapseNode(a)}else {c.expandNode(a)}}}});Ext.define('IMCef.userSel.UserSelHelper',{alternateClassName:'UserSelHelper',singleton:!0,parseAva:function(a){var b='';if(a.transmit){if(a.chat_type==ChatType.Multi){b=AvatarMgr.parseChatAva(a.ava_id,a.create_at,!0)}else {if(a.chat_type==ChatType.Direct){b=AvatarMgr.parseUserAva(a.ava_id,!0)}else {if(a.chat_type=='C'){b=AvatarMgr.parseCrowdAva(a.ava_id,a.create_at,!0)}else {b=AvatarMgr.parseUserAva(a.ava_id,!0)}}}}else {b=AvatarMgr.parseUserAva(a.user_id,!0)}return b}});Ext.define('IMCef.userSel.list.SelectedMems',{extend:'Ext.List',xtype:'selectedMems',requires:['IMCef.userSel.list.SelectedMemModel','IMCef.userSel.UserSelHelper'],store:{storeId:'userSel_list',model:'IMCef.userSel.list.SelectedMemModel',data:{user_name:'这样'}},itemTpl:['<div style="float:left;">','{[UserSelHelper.parseAva(values)]}','</div>','<div class="x-fa fa-close userSel_list_close"></div>','<span style="line-height:1.7;">{user_name}</span>'].join(''),initialize:function(){var a=this;a.callParent(arguments);a.on({childtap:'onTapM',scope:a});a.getStore().on({add:'onAddMem',remove:'onRemoveMem',clear:'onClearMem',scope:a})},onTapM:function(g,c){var a=c.record;if(!a){return}var h=c.event;var i=Ext.fly(h.target);if(i.hasCls('userSel_list_close')){var e=g.getStore();e.remove(a);var f=Ext.Viewport.lookup('userSel').down('#grpSel-org').getStore();var d=f.query('user_id',a.get('user_id'),!1,!1,!0);for(var b=0;b<d.items.length;b++){d.items[b].set('isSel',!1)}}},onAddMem:function(d,c){var b=Ext.Viewport.lookup('userSel').getViewModel(),a=b.get('selNum');a+=c.length;b.set({selNum:a})},onRemoveMem:function(d,c){var b=Ext.Viewport.lookup('userSel').getViewModel(),a=b.get('selNum');a-=c.length;b.set({selNum:a})},onClearMem:function(){var a=Ext.Viewport.lookup('userSel').getViewModel();a.set({selNum:0})}});Ext.define('IMCef.userSel.list.SelectedMemModel',{extend:'Ext.data.Model',idProperty:'user_id',fields:[{name:'user_id',type:'string'},{name:'user_name',type:'string'}]});Ext.define('IMCef.userSel.UserSel',{extend:'IMCef.src.MainView',xtype:'userSel',bind:{title:'{mainTitle}'},requires:['IMCef.userSel.UserSelController','IMCef.userSel.organization.OrgTree','IMCef.userSel.list.SelectedMems','IMCommon.utils.AvatarMgr'],controller:'userselcontroller',viewModel:{data:{selNum:0,mainTitle:'发起多人会话',openType:'open',hideACheckbox:!0,showHistoryDesc:'仅显示加入会话后的信息'}},cls:'userSel',layout:'vbox',items:[{layout:'hbox',flex:1,padding:10,items:[{flex:1,height:'100%',xtype:'panel',layout:'vbox',style:'padding-right:10px;width:294px',items:[{xtype:'button',iconCls:'im-common-add',text:'创建新的会话',bind:{hidden:'{openType != "transmit"}'},handler:'createToTransmit'},{xtype:'textfield',itemId:'grpSTF',name:'Subject',role:'filter',placeholder:'搜索',minHeight:30,triggers:{search:{type:'search'}},listeners:{change:'onSearch'}},{xtype:'orgTree',itemId:'grpSel-org',flex:1}]},{xtype:'component',style:'border-left: solid 1px #e9e9e9;'},{flex:1,xtype:'panel',height:'100%',layout:'vbox',style:'padding-left:10px;width:294px',items:[{xtype:'component',bind:{html:'<div class="userSel_selNum">{openType=="transmit"?selNum>0?"已选择了"+selNum+"个会话":"请选择需要添加的会话":selNum>0?"已选择了"+selNum+"人":"请选择需要添加的成员"}</div>'}},{xtype:'selectedMems',flex:1},{xtype:'component',hidden:!0,bind:{html:'{showHistoryDesc}'}},{xtype:'container',layout:'hbox',items:[{xtype:'checkboxfield',itemId:'showAllCheckbox',label:'允许查看全部历史消息',labelAlign:'right',labelWidth:'auto',bind:{hidden:'{hideACheckbox}'}},{xtype:'button',itemId:'showHistroyat',text:'消息显示范围',handler:'showHistoryatDialog',hidden:!0},{xtype:'component',flex:1},{xtype:'button',text:'确定',userCls:'btnEnter',height:25,width:65,handler:'onOk'},{xtype:'button',text:'取消',userCls:'btnCancel',height:25,width:65,handler:'onCancel'}]}]}]}],dialog:{xtype:'dialog',title:'选择消息展示范围',height:'90%',width:'90%',closable:!0,defaultFocus:'#ok',cls:'userSelDialog',bodyPadding:20,layout:'vbox',items:[{xtype:'container',layout:'hbox',items:[{xtype:'radiofield',itemId:'userSelDialog_radio_now',name:'showHistoryat',labelWidth:'auto',labelAlign:'right',style:'margin-right:15px;',label:'仅显示加入会话后的信息',listeners:{check:'checkHisByNow'}},{xtype:'radiofield',itemId:'userSelDialog_radio_all',name:'showHistoryat',labelWidth:'auto',labelAlign:'right',style:'margin-right:15px;',label:'显示全部消息',listeners:{check:'checkHisByAll'}},{xtype:'radiofield',itemId:'userSelDialog_radio_one',name:'showHistoryat',labelWidth:'auto',labelAlign:'right',label:'选择消息进行展示',listeners:{check:'checkHisByOne'}}]},{xtype:'combobox',itemId:'userSelDialog_search',placeholder:'搜索消息内容',hidden:!0},{xtype:'list',itemId:'userSelDialog_list',flex:1,itemTpl:'\n                <div style="float:left">\n                    <div class="select"></div>\n                </div>\n                <div class="content">\n                    <div><tpl if="values.MsgType==\'T\'||\'I\'||\'F\'||\'L\'">{SenderName} </tpl>{[Utils.datetime2Ago(values.CreateAt,true)]}</div>\n                    <div>\n                        <tpl if="values.MsgType==\'T\'">\n                            {[ParseUtil.parseTextToHtml(values.Content)]}\n                        <tpl elseif="values.MsgType==\'I\'">\n                            [图片]\n                        <tpl elseif="values.MsgType==\'F\'">\n                            [文件]\n                        <tpl elseif="values.MsgType==\'L\'">\n                            [链接]\n                        <tpl elseif="values.MsgType==\'G\'">\n                            {Content}\n                        <tpl elseif="values.MsgType==\'B\'">\n                            撤回了一条消息\n                        </tpl>\n                    </div>\n                </div>',deselectable:!1,store:{storeId:'userSelDialog_list',fields:['MsgID','MsgType','Content']},hidden:!0}],buttons:{ok:{handler:'onDialogOK'},cancel:{ui:'flat',handler:'onDialogCancel'}}}});Ext.define('IMCef.userSel.panel.UserSelSearchPController',{extend:'Ext.app.ViewController',alias:'controller.userselsearchpcontroller',init:function(){},onSel:function(d,a){var b=Ext.Viewport.lookup('userSel').getViewModel(),c=b.get('openType');if(c=='transmit'){this.doRctSel(a)}else {this.doUserSel(a)}},doRctSel:function(d){var e=d.get('chat_id');var b=Ext.getCmp('userSel_tree'),c=Ext.getStore('userSel_rctTreeStore');var a=c.findRecord('chat_id',e);if(a){b.setSelection(a);b.scrollToRecord(a)}this.getView().hide()},doUserSel:function(d){var e=d.get('user_id');var c=Ext.getCmp('userSel_tree'),b=Ext.getStore('userSel_treeStore');for(var a=0;a<b.data.length;a++){if(b.data.items[a].data.user_id==e){c.setSelection(b.data.items[a]);c.scrollToRecord(b.data.items[a])}}this.getView().hide()}});Ext.define('IMCef.userSel.panel.UserSelSearchP',{extend:'IMCommon.view.panel.hidePanel',xtype:'userSelSearchP',controller:'userselsearchpcontroller',requires:['IMCef.userSel.panel.UserSelSearchPController'],floated:!0,width:185,maxHeight:200,scrollable:'y',bodypadding:5,layout:'fit',items:[{xtype:'list',store:{storeId:'editP_search_s'},listeners:{select:'onSel'},itemTpl:'\n            <div style="float:left">\n            {[UserSelHelper.parseAva(values)]} \n            </div>\n            <div>{user_name}</div>\n        '}]});Ext.define('IMCef.userSel.panel.UserSelSearchRctController',{extend:'Ext.app.ViewController',alias:'controller.userselsearchrctcontroller',init:function(){},onfspListSel:function(h,l,o){var m=this.getView();var a=l.data;if(a.hasNoData){return}if(a.hasUser||a.hasChat){if(a.hasMoreUser){var k=Ext.getStore('editP_fsp_user');h.setStore(k)}else {if(a.hasMoreChat){var j=Ext.getStore('editP_fsp_chat');h.setStore(j)}else {return}}}else {if(a.hasBack){var i=Ext.getStore('editP_fsp_multi');h.setStore(i)}else {if(a.UserName){var d=a.UserID;var g=a.UserName;if(a.UserID!=User.ownerID){var e=Ext.getStore('userSel_list');var c=Ext.getStore('userSel_rctTreeStore');var f=!1;for(var b=0;b<c.data.length;b++){if(c.data.items[b].data.ava_id==d){f=!0;if(!c.data.items[b].data.isSel){c.data.items[b].set('isSel',!0);e.add(c.data.items[b].data)}}}if(!f){if(!f){LocalDataMgr.hasDitChat(d,function(c,b){if(c){var a=[];a.push({ava_id:d,chat_id:b.ChatID,chat_type:'D',iconCls:'hide-icon',user_id:b.ChatID,user_name:g,transmit:!0});e.add(a)}else {Utils.custAjax('post','chats/direct',{params:JSON.stringify([User.ownerID,d]),success:function(a){var f=[];a.last_post_at=a.create_at;a.display_name=g;a.unread_count=0;a.last_sender_id=User.ownerID;a.last_sender_name=User.crtUser.user_name;a.last_message='';LocalDataMgr.createtransDitChat(a);f.push({ava_id:d,chat_id:a.chat_id,chat_type:'D',iconCls:'hide-icon',user_id:a.chat_id,user_name:g,transmit:!0});e.add(f)},failure:function(a){console.log('创建出错',a)}})}})}}}}else {if(a.ChatType=='G'||a.ChatType=='E'||a.ChatType=='C'){var d=a.ChatID;var e=Ext.getStore('userSel_list');var c=Ext.getStore('userSel_rctTreeStore');var f=!1;for(var b=0;b<c.data.length;b++){if(c.data.items[b].data.chat_id==d){f=!0;if(!c.data.items[b].data.isSel){c.data.items[b].set('isSel',!0);e.add(c.data.items[b].data)}}}if(!f){var n='SELECT * FROM IMChat WHERE ChatID=? ;';LocalDataMgr.cExecSqlWithP(n,[d],function(c,a){if(a.rows.length>0){var b=[];b.push({ava_id:a.rows.item(0).ChatID,chat_id:a.rows.item(0).ChatID,chat_type:a.rows.item(0).ChatType,iconCls:'hide-icon',user_id:a.rows.item(0).ChatID,user_name:a.rows.item(0).DisplayName,transmit:!0,create_at:a.rows.item(0).CreateAt});e.add(b)}})}}}m.hide();if(Ext.Viewport.down('#grpSTF')){Ext.Viewport.down('#grpSTF').setValue('')}}}}});Ext.define('IMCef.userSel.panel.UserSelSearchRct',{extend:'IMCommon.view.panel.hidePanel',xtype:'userSelSearchRct',controller:'userselsearchrctcontroller',requires:['IMCef.userSel.panel.UserSelSearchRctController'],floated:!0,width:290,maxHeight:370,scrollable:'y',bodypadding:5,layout:'fit',cls:'editP_fsp',items:[{xtype:'list',itemId:'editP_fsp_list',userSelectable:!1,emptyText:'无相关搜索内容',listeners:{select:'onfspListSel'}}],itemTpl1:'\n        <tpl if="values.hasNoData">\n            <div class="editP_fsp_nodata">无相关搜索内容</div>\n        <tpl else>\n            <tpl if="values.hasUser||values.hasChat">\n                <tpl if="values.hasUser">\n                    <div class="editP_fsp_user_title">\n                        <tpl if="values.hasMoreUser">\n                            <div class="editP_fsp_more">显示更多</div>\n                        </tpl>\n                        <div>用户</div>\n                    </div>\n                </tpl>\n                <tpl if="values.hasChat">\n                    <div class="editP_fsp_title">\n                        <tpl if="values.hasMoreChat">\n                            <div class="editP_fsp_more">显示更多</div>\n                        </tpl>\n                        <div>会话</div>\n                    </div>\n                </tpl>\n            <tpl elseif="values.hasBack">\n            <div class="editP_fsp_more">收起</div>\n                <div>{[values.hasUserBack?\'用户\':\'会话\']}</div>\n            <tpl else>\n                <tpl if="values.UserName">\n                    <div style="float: left;">\n                    {[AvatarMgr.getUserAvaHtml(values.UserID, values.AvatarHash)]}\n                    </div>\n                    <div class="inOneline">{UserName}({UserID})</div>\n                    <div class="inOneline" style="margin-top:4px;font-size: 12px;color:#b4b4b4;">\n                        <tpl if="values.Mobile">手机：{Mobile}</tpl>\n                    </div>\n                <tpl else>\n                    <div style="float: left;">\n                    <tpl if="values.ChatType == \'G\'">\n                    {[AvatarMgr.getChatAvaHtml(values.ChatID, values.CreateAt, values.AvatarHash)]}\n                    <tpl elseif="values.ChatType == \'C\'">\n                    {[AvatarMgr.getCrowdAvaHtml(values.ChatID, values.CreateAt, values.AvatarHash)]}\n                    </tpl>\n                    </div>\n                    <div>\n                    <div class="inOneline">{DisplayName}</div>\n                    <tpl if="values.SenderName">\n                    <div class="editP_fsp_content inOneline">包含：{SenderName}</div>\n                    </tpl>\n                    </div>\n                </tpl>\n            </tpl>\n        </tpl>\n        ',itemTpl2:'\n            <tpl if="values.hasBack">\n            <div>用户</div>\n            <div class="editP_fsp_more">收起</div>\n            <tpl else>\n            <div style="float: left;">\n                    {[AvatarMgr.getUserAvaHtml(values.UserID, values.AvatarHash)]}\n                    </div>\n                    <div class="inOneline">{UserName}({UserID})</div>\n                    <div class="inOneline" style="margin-top:4px;font-size: 12px;color:#b4b4b4;">\n                        <tpl if="values.Mobile">手机：{Mobile}</tpl>\n                    </div>\n            </tpl>\n        ',itemTpl3:'\n            <tpl if="values.hasBack">\n                <div>会话</div>\n                <div class="editP_fsp_more">收起</div>\n            <tpl else>\n            <div style="float: left;">\n            <tpl if="values.ChatType == \'G\'">\n            {[AvatarMgr.getChatAvaHtml(values.ChatID, values.CreateAt, values.AvatarHash)]}\n            <tpl elseif="values.ChatType == \'C\'">\n            {[AvatarMgr.getCrowdAvaHtml(values.ChatID, values.CreateAt, values.AvatarHash)]}\n            </tpl>\n            </div>\n            <div>\n            <div class="inOneline">{DisplayName}</div>\n            <tpl if="values.SenderName">\n            <div class="inOneline">包含：{SenderName}</div>\n            </tpl>\n            </tpl>\n        '});